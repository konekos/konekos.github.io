I"•><h2 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯</h2>

<h2 id="ä»€ä¹ˆæ˜¯-zero-copy">ä»€ä¹ˆæ˜¯ Zero-Copy</h2>

<p>WIKIå®šä¹‰ï¼š</p>

<blockquote>
  <p>â€œ<strong>Zero-copy</strong>â€ describes computer operations in which the <a href="https://en.wikipedia.org/wiki/Central_processing_unit">CPU</a> does not perform the task of copying data from one <a href="https://en.wikipedia.org/wiki/RAM">memory</a> area to another. This is frequently used to save CPU cycles and memory bandwidth when transmitting a file over a network.</p>
</blockquote>

<p>â€œé›¶æ‹·è´â€æ˜¯æŒ‡è®¡ç®—æœºæ“ä½œçš„è¿‡ç¨‹ä¸­ï¼ŒCPUä¸éœ€è¦ä¸ºæ•°æ®åœ¨å†…å­˜ä¹‹é—´çš„æ‹·è´æ¶ˆè€—èµ„æºã€‚é€šå¸¸æ˜¯æŒ‡è®¡ç®—æœºåœ¨ç½‘ç»œä¸Šå‘é€æ–‡ä»¶æ—¶ï¼Œä¸éœ€è¦å°†æ–‡ä»¶å†…å®¹æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ˆUser Spaceï¼‰è€Œç›´æ¥åœ¨å†…æ ¸ç©ºé—´ï¼ˆKernel Spaceï¼‰ä¸­ä¼ è¾“åˆ°ç½‘ç»œçš„æ–¹å¼ã€‚</p>

<hr />

<p>Zero-Copy å¸¸ç”¨äºé™æ€èµ„æºä»ç£ç›˜åˆ°ç½‘ç»œçš„å‘é€ï¼ˆä¸­é—´ä¸å¯¹èµ„æºè¿›è¡Œæ”¹å˜ï¼‰ï¼Œè¿™åœ¨web serveræä¾›çš„åŠŸèƒ½ä¸­å¾ˆå¸¸è§ï¼Œä¸€ä¸ªä¾‹å­æ˜¯ï¼šä¿å­˜åœ¨ç£ç›˜ä¸Šçš„ä¸€å¼ å›¾ç‰‡åº”æŸä¸ªç½‘ç»œè¯·æ±‚è¢«ä»ç£ç›˜ä¸­å–å‡ºå¹¶é€šè¿‡socketå‘é€è‡³è¯·æ±‚æ–¹ã€‚</p>

<h2 id="-zero-copy-ä¸ä¼ ç»Ÿioæ–¹å¼å¯¹æ¯”">## Zero-Copy ä¸ä¼ ç»ŸIOæ–¹å¼å¯¹æ¯”</h2>

<p><img src="/assets/img/3449017dcf54c710ae50bed55007ef5ddfc.jpg" alt="img" /></p>

<p>Zero-Copy æ˜¯æ¶ˆé™¤äº†å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„å¤åˆ¶ï¼Œå¹¶ä¸æ˜¯å®Œå…¨æ²¡æœ‰å‘ç”Ÿcopyã€‚å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒè¿™ä¸€ç‰¹æ€§ï¼Œå¹¶ä¸”ï¼Œå¦‚æœè¦å¯¹æ–‡ä»¶è¿›è¡Œæ›´æ”¹ï¼Œå¦‚åŠ å¯†ç­‰ï¼ŒZero-Copyæ–¹å¼ä¹Ÿæ˜¯åšä¸åˆ°çš„ã€‚</p>

<h2 id="java-zero-copy">Java Zero-Copy</h2>

<h3 id="filechanneltransferto">FileChannel.transferTo()</h3>

<p>ç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œç›´æ¥å†™åˆ°ä¸€ä¸ªå¯å†™çš„<code class="language-plaintext highlighter-rouge">SocketChannel</code>ï¼Œé™¤äº†å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„å¤åˆ¶ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SocketAddress</span> <span class="n">socketAddress</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="no">HOST</span><span class="o">,</span> <span class="no">PORT</span><span class="o">);</span>
<span class="nc">SocketChannel</span> <span class="n">socketChannel</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
<span class="n">socketChannel</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">socketAddress</span><span class="o">);</span>
 
<span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="no">FILE_PATH</span><span class="o">);</span>
<span class="nc">FileChannel</span> <span class="n">fileChannel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
<span class="n">fileChannel</span><span class="o">.</span><span class="na">transferTo</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span> <span class="n">socketChannel</span><span class="o">);</span>
 <span class="c1">//channel write/read....</span>
<span class="n">fileChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="n">socketChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div>

<p>ä¸‹é¢ä½¿ç”¨Java nioå†™ä¸€ä¸ªä¾‹å­ï¼ŒServerç›´æ¥å°†ç£ç›˜ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶é€šè¿‡Zero-Copyæ–¹å¼å‘å¾€å®¢æˆ·ç«¯ï¼š</p>

<p>Serverï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SelectorServer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">DEFAULT_PORT</span> <span class="o">=</span> <span class="mi">9999</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="no">DEFAULT_PORT</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">port</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server starting ... listening on port "</span> <span class="o">+</span> <span class="n">port</span><span class="o">);</span>
        <span class="nc">ServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="n">port</span><span class="o">));</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="nc">Selector</span> <span class="n">s</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(;;){</span>
            <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">SocketChannel</span> <span class="n">sc</span><span class="o">;</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ServerSocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">()).</span><span class="na">accept</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">sc</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Receiving connection"</span><span class="o">);</span>
                    <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"./file/1.txt"</span><span class="o">);</span>
                    <span class="nc">FileChannel</span> <span class="n">fileChannel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
                    <span class="n">fileChannel</span><span class="o">.</span><span class="na">transferTo</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span> <span class="n">sc</span><span class="o">);</span>
                    <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">iterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Clientï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SelectorClient</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">DEFAULT_PORT</span> <span class="o">=</span> <span class="mi">9999</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ByteBuffer</span> <span class="n">bb</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="no">DEFAULT_PORT</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">port</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="nc">InetSocketAddress</span> <span class="n">addr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="n">sc</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">addr</span><span class="o">);</span>

            <span class="k">while</span> <span class="o">(</span><span class="n">sc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bb</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">bb</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">Charset</span> <span class="n">charset</span> <span class="o">=</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">charset</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">bb</span><span class="o">).</span><span class="na">toString</span><span class="o">());</span>
            <span class="n">bb</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="directbuffer">DirectBuffer</h2>

<p><code class="language-plaintext highlighter-rouge">DirectBuffer</code>ï¼Œå †å¤–å†…å­˜ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­å·²ç»ç”¨åˆ°äº†ï¼Œæˆ‘ä»¬æŠŠchannelçš„æ¥å—è¯»åˆ°äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">DirectBuffer</code>ä¸­ï¼Œä½¿ç”¨æ–¹å¼ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ByteBuffer</span> <span class="n">directByteBuffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
</code></pre></div></div>

<p>è¿™ç§æ–¹å¼æ˜¯ç›´æ¥åœ¨å †å¤–åˆ†é…ä¸€ä¸ªå†…å­˜ï¼Œä¸éœ€è¦å †å†…å†…å­˜å’Œå †å¤–å†…å­˜æ•°æ®æ‹·è´çš„æ“ä½œã€‚</p>

:ET