I"3E<h1 id="java-io-nio-and-nio2">Java I/O, NIO and NIO.2</h1>

<h2 id="part-â…°-getting-started-with-io">PART â…  Getting Started with I/O</h2>

<h3 id="chapter-1-io-basics-and-apis">Chapter 1 I/O Basics and APIs</h3>

<p>NIOä½œä¸ºJDK 1.4çš„ä¸€éƒ¨åˆ†è¢«å¼•å…¥æ¥æ”¯æŒæ“ä½œç³»ç»Ÿçš„æ–°çš„I/Oè§„èŒƒã€‚ç”±äºæ—¶é—´ä¸å¤Ÿï¼Œæ²¡èƒ½æŠŠä¸€äº›è®¡åˆ’çš„ç‰¹æ€§åŠ åˆ°è¿™ä¸ªreleaseï¼Œè¢«æ¨è¿Ÿåˆ°äº†JDK 5 and JDK 7ã€‚</p>

<p>è¿™ç« ä»‹ç»classic I/O, NIO, and more NIO (NIO.2)ã€‚æ¥ä¸‹æ¥çš„ç« èŠ‚æ·±å…¥ç ”ç©¶å®ƒä»¬çš„apiã€‚</p>

<h4 id="classic-io">Classic I/O</h4>

<p>JDK1.0å¼•è¿›åˆæ­¥çš„I/Oè®¾æ–½ï¼Œç”¨äºè®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼ˆåˆ›å»ºæ–‡ä»¶å¤¹ï¼Œåˆ é™¤æ–‡ä»¶ç­‰æ“ä½œï¼‰ï¼Œéšæœºè®¿é—®æ–‡ä»¶ç›®å½•ï¼ˆè€Œä¸æ˜¯æŒ‰é¡ºåºï¼‰ï¼Œå’Œæºå’Œç›®æ ‡ä¹‹é—´ä»¥é¡ºåºæ–¹å¼çš„é¢å‘å­—èŠ‚æ•°æ®æµã€‚</p>

<h4 id="file-system-access-and-the-file-class">File System Access and the File Class</h4>

<p><em>file system</em>æ˜¯æ“ä½œç³»ç»Ÿç»„ä»¶ç®¡ç†æ•°æ®å‚¨å­˜å’Œåç»­æ£€ç´¢ã€‚è¿è¡ŒJVMçš„æ“ä½œç³»ç»Ÿæ”¯æŒè‡³å°‘ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼ŒUnixæˆ–Linuxç»“åˆæ‰€æœ‰å®‰è£…ï¼ˆattached and prepared)ï¼‰çš„disksåˆ°ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿã€‚ä¸æ­¤ç›¸åï¼ŒWindowsæŠŠä¸€ä¸ªåˆ†å‰²çš„æ–‡ä»¶ç³»ç»Ÿå’Œæ¯ä¸ªæ´»åŠ¨çš„ç£ç›˜é©±åŠ¨å™¨è”ç³»èµ·æ¥ã€‚</p>

<p>Windowså’Œç±»ä¼¼çš„æ“ä½œç³»ç»Ÿå¯ä»¥ç®¡ç†å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚ æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½ç”¨ä¸€ä¸ªé©±åŠ¨å™¨è¯´æ˜ç¬¦æ¥æ ‡è¯†ï¼Œæ¯”å¦‚<code class="language-plaintext highlighter-rouge">C:</code>ã€‚ æŒ‡å®šä¸€æ¡æ²¡æœ‰é©±åŠ¨å™¨è¯´æ˜ç¬¦çš„è·¯å¾„ï¼Œè·¯å¾„æ˜¯ç›¸å¯¹äºå½“å‰æ–‡ä»¶ç³»ç»Ÿã€‚</p>

<p>ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">java.io.File  </code>ç±»å®ä¾‹æŠ½è±¡ä¸€ä¸ªæ–‡ä»¶æˆ–è€…æ–‡ä»¶è·¯å¾„ã€‚è¿™ä¸ªå®ä¾‹æä¾›æ–‡ä»¶ç³»ç»Ÿè®¿é—®æ¥åœ¨è¿™ä¸ªpathä¸Šæ‰§è¡Œä»»åŠ¡æ¯”å¦‚ç§»é™¤ä¸‹é¢çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚æ¯”å¦‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>new File("temp").mkdir();
</code></pre></div></div>

<h4 id="accessing-file-content-via-randomaccessfile">Accessing File Content via RandomAccessFile</h4>

<p>æ–‡ä»¶å†…å®¹å¯ä»¥æŒ‰é¡ºåºæˆ–éšæœºè®¿é—®ã€‚éšæœºè®¿é—®å¯ä»¥åŠ å¿«æœç´¢å’Œæ’åºåŠŸèƒ½ã€‚åœ¨ <code class="language-plaintext highlighter-rouge">java. io.RandomAccessFile </code>ç±»æä¾›éšæœºè®¿é—®æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RandomAccessFile</span> <span class="n">raf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="s">"employees.dat"</span><span class="o">,</span> <span class="s">"r"</span><span class="o">);</span>
<span class="kt">int</span> <span class="n">empIndex</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
<span class="n">raf</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">empIndex</span> <span class="o">*</span> <span class="no">EMP_REC_LEN</span><span class="o">);</span>
<span class="c1">// Read contents of employee record.</span>

</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge"> employees.dat</code>æ–‡ä»¶è¢«åˆ†å‰²æˆå›ºå®šé•¿åº¦çš„employeesè®°å½•ï¼Œæ¯ä¸ªè®°å½• EMP_REC_LEN bytesé•¿ï¼Œè¢«è®¿é—®ã€‚ç¬¬10ä¸ªç´¢å¼•çš„employeeè¢«æŸ¥æ‰¾ï¼ˆç¬¬ä¸€ä¸ªindex 0ï¼‰ã€‚è¿™ä¸ªä»»åŠ¡é€šè¿‡seekingï¼ˆè®¾ç½®file pointerï¼‰è¿™ä¸ªè®°å½•çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„å­—èŠ‚ä½ç½®ï¼Œå®ƒå¤„äºè®°å½•é•¿åº¦ä¹˜ç´¢å¼•ã€‚è®°å½•ç„¶åè¢«è®¿é—®ã€‚</p>

<h4 id="streaming-data-via-stream-classes">Streaming Data via Stream Classes</h4>

<p>Classic I/O åŒ…å«streamsç”¨äºæ‰§è¡ŒI/Oæ“ä½œã€‚æµæ˜¯ä»»æ„é•¿åº¦çš„æœ‰é¡ºåºçš„bytes sequenceã€‚bytesä»åº”ç”¨çš„<em>output stream</em>æµå‡ºåˆ°ç›®çš„åœ°ï¼Œå’Œä»ä¸€ä¸ªsourceçš„input streamæµå‡ºåˆ°åº”ç”¨ã€‚</p>

<p><img src="/assets/img/1532340528079.png" alt="1532340528079" /></p>

<p>Javaåœ¨ <code class="language-plaintext highlighter-rouge">java.io </code>åŒ…æä¾›ç±»ç”¨äºè¯†åˆ«ç”¨äºwritingçš„stream destinationsï¼›ä¾‹å¦‚byte arrayså’Œfilesã€‚ä¹Ÿæä¾›ç±»è¯†åˆ«å„ç§stream sourcesç”¨äºreadingã€‚ä¾‹å­åŒ…æ‹¬fileså’Œ thread pipesã€‚</p>

<p>ä¾‹å¦‚ï¼Œä½ ä¼šç”¨ <code class="language-plaintext highlighter-rouge">FileInputStream</code>æ‰“å¼€ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶ï¼Œå¹¶ä¸”ç”¨ä¸€ä¸ª input streamè¿æ¥å®ƒã€‚ä½ ä¼šç”¨å„ç§<code class="language-plaintext highlighter-rouge"> read() </code>æ–¹æ³•é€šè¿‡input streamä»fileè¯»å–å­—èŠ‚ã€‚æœ€åï¼Œè°ƒç”¨<code class="language-plaintext highlighter-rouge">close() </code>å…³é—­streamå’Œæ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">try</span>
<span class="o">{</span>
 <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"image.jpg"</span><span class="o">);</span>
 <span class="c1">// Read bytes from file.</span>
 <span class="kt">int</span> <span class="n">_byte</span><span class="o">;</span>
 <span class="k">while</span> <span class="o">((</span><span class="n">_byte</span> <span class="o">=</span> <span class="n">fis</span><span class="o">.</span><span class="na">read</span><span class="o">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="c1">// -1 signifies EOF</span>
 <span class="o">;</span> <span class="c1">// Process _byte in some way.</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span>
<span class="o">{</span>
 <span class="c1">// Handle exception.</span>
<span class="o">}</span>
<span class="k">finally</span>
<span class="o">{</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">fis</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
 <span class="k">try</span>
 <span class="o">{</span>
 <span class="n">fis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>è¿™ä¸ªä¾‹å­å±•ç¤ºäº†æ‰“å¼€æ–‡ä»¶ä¸€ä¸ªæ–‡ä»¶çš„ä¼ ç»Ÿæ–¹æ³•ä¸”åˆ›å»ºä¸€ä¸ªè¾“å…¥æµä»æ–‡ä»¶ä¸­è¯»å–å­—èŠ‚ã€‚ç„¶åå®ƒç»§ç»­è¯»å–æ–‡ä»¶çš„å†…å®¹ã€‚å¼‚å¸¸å¤„ç†ç¨‹åºè´Ÿè´£å¤„ç†æŠ›å‡ºçš„å¼‚å¸¸ï¼Œç”±<code class="language-plaintext highlighter-rouge">java.io.IOException</code>è¡¨ç¤ºã€‚</p>

<p>ä¸ç®¡æœ‰æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œè¾“å…¥æµå’Œä¹‹ä¸‹çš„æ–‡ä»¶å¿…é¡»å…³é—­ã€‚è¿™ä¸ªåŠ¨ä½œå‘ç”Ÿåœ¨tryå£°æ˜çš„finallyå—ã€‚å› ä¸ºå…³é—­æ–‡ä»¶çš„å†—é•¿ï¼Œä½ å¯ä»¥é€‰æ‹©ç”¨JDK 7çš„try-with-resourcesé™ˆè¿°æ¥è‡ªåŠ¨å…³é—­ï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>try (FileInputStream fis = new FileInputStream("image.jpg"))
{
 // Read bytes from file.
 int _byte;
 while ((_byte = fis.read()) != -1) // -1 signifies EOF
 ; // Process _byte in some way.
}
catch (IOException ioe)
{
 // Handle exception.
}

</code></pre></div></div>

<p>ä¸€äº›streamç±»ç”¨äºè¿‡æ»¤å…¶ä»–streamã€‚ä¾‹å¦‚ï¼Œä¸ºäº†æå‡æ€§èƒ½ï¼Œ<code class="language-plaintext highlighter-rouge"> BufferedInputStream </code>ä»å…¶ä»–streamè¯»å–ä¸€å—bytesï¼Œä»å®ƒçš„bufferè¿”å›å­—èŠ‚ç›´åˆ°bufferç©ºä¸ºæ­¢ï¼Œç„¶åè¯»å–å¦ä¸€å—ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="o">(</span><span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"image.jpg"</span><span class="o">);</span>
 <span class="nc">BufferedInputStream</span> <span class="n">bis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">fis</span><span class="o">))</span>
<span class="o">{</span>
 <span class="c1">// Read bytes from file.</span>
 <span class="kt">int</span> <span class="n">_byte</span><span class="o">;</span>
 <span class="k">while</span> <span class="o">((</span><span class="n">_byte</span> <span class="o">=</span> <span class="n">bis</span><span class="o">.</span><span class="na">read</span><span class="o">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="c1">// -1 signifies EOF</span>
 <span class="o">;</span> <span class="c1">// Process _byte in some way.</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span>
<span class="o">{</span>
 <span class="c1">// Handle exception.</span>
<span class="o">}</span>

</code></pre></div></div>

<p>ä»<code class="language-plaintext highlighter-rouge">image.jpg </code>è¯»å–çš„ file input streamè¢«åˆ›å»ºã€‚è¿™ä¸ªstreamè¢«è½¬æ¢æˆbufferedè¾“å…¥æµæ„é€ å™¨ã€‚éšåçš„è¯»åœ¨buffered input streamä¸Šæ‰§è¡Œï¼Œå®ƒåœ¨åˆé€‚æ—¶å€™è°ƒç”¨file input streamçš„<code class="language-plaintext highlighter-rouge">read()</code>ã€‚</p>

<h4 id="stream-classes-and-standard-io">Stream Classes and Standard I/O</h4>

<p>å¾ˆå¤šæ“ä½œç³»ç»Ÿæ”¯æŒæ ‡å‡†I/Oï¼Œ preconnected streamsè¢«ç§°ä¸º standard input, standard output, and standard errorã€‚</p>

<p>æ ‡å‡†è¾“å…¥é»˜è®¤ä»é”®ç›˜è¾“å…¥ã€‚ç„¶è€Œï¼Œä¹Ÿå¯ä»¥é‡å®šå‘ä»ä¸åŒçš„æºè¯»è¾“å‡ºåˆ°ä¸åŒçš„ç›®çš„åœ°ï¼Œæ¯”å¦‚æ–‡ä»¶ã€‚</p>

<p>JDK 1.0å¼•å…¥æ ‡å‡†I/Oæ”¯æŒé€šè¿‡æ·»åŠ InputStream and PrintStreamç±»å‹çš„in, out, and err oå¯¹è±¡åˆ°<code class="language-plaintext highlighter-rouge">java.lang.System </code>ç±»ã€‚ä½ æŒ‡å®šè°ƒç”¨è¿™äº›å¯¹è±¡çš„æ–¹æ³•æ¥è¿æ¥æ ‡å‡†è¾“å…¥è¾“å‡ºå’Œerrorï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int ch = System.in.read(); // Read single character from standard input.
System.out.println("Hello"); // Write string to standard output.
System.err.println("I/O error: " +
 ioe.getMessage()); // Write string to standard error.
</code></pre></div></div>

<h4 id="jdk-11-and-the-writerreader-classes">JDK 1.1 and the Writer/Reader Classes</h4>

<p>JDK 1.0çš„I/Oé€‚åˆå­—èŠ‚æµï¼Œä½†ä¸é€‚åˆå­—ç¬¦æµå› ä¸ºä¸è€ƒè™‘å­—ç¬¦ç¼–ç ã€‚JDK 1.1å¼•å…¥äº† writer/readerç±»å…‹æœè¿™ä¸ªé—®é¢˜ï¼ŒæŠŠå­—ç¬¦ç¼–ç è€ƒè™‘äº†åœ¨å†…ã€‚ä¾‹å¦‚<code class="language-plaintext highlighter-rouge">java.io </code>åŒ…å«æœ‰<code class="language-plaintext highlighter-rouge">s FileWriter and FileReader </code>ç±»ç”¨äºè¯»å†™å­—ç¬¦æµã€‚</p>

<h4 id="nio">NIO</h4>

<p>ç°ä»£æ“ä½œç³»ç»Ÿæä¾›ç²¾è‡´çš„I/OæœåŠ¡ï¼ˆæ¯”å¦‚readiness selectionï¼‰ç”¨äºæå‡I/Oæ€§èƒ½ä¸ç®€åŒ–I/Oã€‚ Java Specification Request (JSR) 51  (www.jcp.org/en/jsr/detail?id=51) è¢«åˆ›å»ºç”¨äºè½åœ°è¿™ä¸ªç‰¹æ€§ã€‚</p>

<p>JSR 51çš„æè¿°è¡¨æ˜æä¾›äº†APIsç”¨äºå¯ä¼¸ç¼©I/Oï¼Œ fast buffered binary and character I/O ï¼Œæ­£åˆ™è¡¨è¾¾å¼å’Œå­—ç¬¦é›†è½¬æ¢ã€‚è¿™äº›APIså°±æ˜¯NIOã€‚JDK1.4åœ¨ä»¥ä¸‹APIsæ–¹é¢å®ç°NIOï¼š</p>

<ul>
  <li>Buffers</li>
  <li>Channels</li>
  <li>Selectors</li>
  <li>Regular expression</li>
  <li>Charsets</li>
</ul>

<p>regular expression and charset APIsè¢«æä¾›ç»™ç®€åŒ–å¸¸è§„ä¸I/Oæœ‰è”ç³»çš„tasksã€‚</p>

<h4 id="buffers">Buffers</h4>

<p>Buffersï¼ˆç¼“å†²åŒºï¼‰æ˜¯NIOæ“ä½œçš„åŸºç¡€ã€‚æœ¬è´¨ä¸Šï¼ŒNIOå…¨éƒ¨éƒ½æ˜¯å…³äºæŠŠæ•°æ®ä»Buffersç§»å…¥æˆ–ç§»å‡ºã€‚</p>

<p>ä¸€ä¸ªè¿‡ç¨‹æ¯”å¦‚JVMæ‰§è¡ŒI/Oé€šè¿‡è¯·æ±‚æ“ä½œç³»ç»Ÿå»æ’å¹²bufferçš„å†…å®¹æ¥é€šè¿‡å†™æ“ä½œå­˜å‚¨ã€‚ç±»ä¼¼åœ°ï¼Œå®ƒè¯·æ±‚æ“ä½œç³»ç»Ÿç”¨ä»å­˜å‚¨è®¾å¤‡è¯»å–çš„æ•°æ®å¡«å……bufferã€‚</p>

<p>è€ƒè™‘ä¸€ä¸ªæ¶‰åŠç£ç›˜é©±åŠ¨çš„è¯»æ“ä½œã€‚æ“ä½œç³»ç»Ÿå‘å‡ºä¸€ä¸ªæŒ‡ä»¤åˆ°ç£ç›˜controlleræ¥è¯»å–ç£ç›˜çš„ä¸€å—å­—èŠ‚åˆ°ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„bufferã€‚ä¸€æ—¦æ“ä½œå®Œæˆï¼Œæ“ä½œç³»ç»Ÿå¤åˆ¶è¿™ä¸ªbuffer contentsåˆ°å‘ç”Ÿ<code class="language-plaintext highlighter-rouge">read()</code>æ“ä½œçš„æŒ‡å®šçš„bufferã€‚</p>

<p><img src="/assets/img/1532487035762.png" alt="1532487035762" /></p>

<p>å›¾1-2ä¸­ä¸€ä¸ªç¨‹åºå‘æ“ä½œç³»ç»Ÿå‘èµ·ä¸€ä¸ª read() è°ƒç”¨ã€‚ä¾æ¬¡åœ°ï¼Œæ“ä½œç³»ç»Ÿè¯·æ±‚ç£ç›˜controllerä»ç£ç›˜è¯»å–ä¸€å—bytesã€‚ç£ç›˜controllerï¼ˆä¹Ÿå«DMA controllerï¼‰é€šè¿‡<em>Direct Memory Access (DMA)</em>ç›´æ¥æŠŠè¿™äº›å­—èŠ‚è¯»åˆ°æ“ä½œç³»ç»Ÿbufferï¼ŒDMAæ˜¯è®¡ç®—æœºç³»ç»Ÿçš„ä¸€ä¸ªç‰¹æ€§ï¼Œå…è®¸æŸä¸ªç¡¬ä»¶å­ç³»ç»Ÿä¸ä¾èµ– <a href="https://en.wikipedia.org/wiki/Central_processing_unit#Central%20processing%20unit">central processing unit</a> (CPU) ç›´æ¥è®¿é—® ç³»ç»Ÿ<a href="https://en.wikipedia.org/wiki/Computer_storage#Computer%20storage">å†…å­˜</a>  (RAM) ã€‚</p>

<p>ä»æ“ä½œç³»ç»Ÿbufferå¤åˆ¶ bytesåˆ°ç¨‹åºbufferæ˜¯ä¸é‚£ä¹ˆé«˜æ•ˆçš„ã€‚è®©DMA controllerç›´æ¥å¤åˆ¶åˆ°ç¨‹åºbufferä¼šæ›´æœ‰æ•ˆï¼Œè¿™ä¸ªæ–¹æ³•æœ‰2ä¸ªé—®é¢˜ï¼š</p>

<ul>
  <li>DMA controllerç‰¹åˆ«æ˜¯ä¸èƒ½å’ŒJVMè¿è¡Œå…¶ä¸Šçš„user spaceï¼ˆç”¨æˆ·ç©ºé—´ï¼‰è¿æ¥ï¼Œè€Œæ˜¯å’Œ operating systemâ€™s kernel spaceï¼ˆæ“ä½œç³»ç»Ÿå†…æ ¸ç©ºé—´ï¼‰è¿æ¥ã€‚</li>
  <li>Block-orientedè®¾å¤‡æ¯”å¦‚DMA controllerä½¿ç”¨å›ºå®šå¤§å°çš„æ•°æ®å—å·¥ä½œã€‚ä¸åŒçš„æ˜¯ï¼ŒJVMç¨‹åºå¯èƒ½ä¼šè¯·æ±‚ä¸€ä¸ªä¸æ˜¯block sizeå€æ•°å¤§å°çš„æ•°æ®ã€‚</li>
</ul>

<p>å› ä¸ºè¿™äº›é—®é¢˜ï¼Œæ“ä½œç³»ç»Ÿä½œä¸ºä¸€ä¸ªä¸­ä»‹è§’è‰²ï¼Œå½“å®ƒåœ¨JVMç¨‹åºå’ŒDMA controlleråˆ‡æ¢æ—¶æ‰¯ç¢å’Œé‡ç»„æ•°æ®ã€‚</p>

<p>è£…é…/æ‹†å¸æ•°æ®çš„ä»»åŠ¡å¯ä»¥æ›´æœ‰æ•ˆï¼Œé€šè¿‡è®©JVMç¨‹åºåœ¨ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä¼ é€’ä¸€ä¸ªbuffer addressesç»™æ“ä½œç³»ç»Ÿã€‚æ“ä½œç³»ç»ŸæŒ‰é¡ºåºå¡«å……æˆ–è€…æ’å¹²è¿™äº›bufferï¼Œåœ¨ä¸€ä¸ªè¯»æ“ä½œåˆ†æ•£æ•°æ®åˆ°å¤šä¸ªbufferæˆ–è€…åœ¨å†™æ“ä½œæ—¶ä»å¤šä¸ªbufferèšé›†æ•°æ®ã€‚è¿™ä¸ªèšé›†/åˆ†æ•£çš„æ´»åŠ¨å‡å°‘äº†JVMç¨‹åºå¿…é¡»è¦åšçš„ç³»ç»Ÿè°ƒç”¨ï¼ˆæ½œåœ¨åœ°å¾ˆæ˜‚è´µï¼‰å¹¶ä¸”ä½¿æ“ä½œç³»ç»Ÿä¼˜åŒ–æ•°æ®å¤„ç†å› ä¸ºç³»ç»ŸçŸ¥é“bufferç©ºé—´çš„æ€»æ•°ã€‚æ­¤å¤–ï¼Œå½“å¤šä¸ªå¤„ç†å™¨æˆ–å†…æ ¸å¯ç”¨ï¼Œæ“ä½œç³»ç»Ÿå¯èƒ½å…è®¸buffersåŒæ—¶å¡«å……æˆ–è€…æ’å¹²ã€‚</p>

<p>JDK 1.4çš„ java.nio.Bufferç±»æŠ½è±¡äº†JVMç¨‹åºbufferçš„æ¦‚å¿µã€‚ä½œä¸º<code class="language-plaintext highlighter-rouge">java.nio.ByteBuffer</code>å’Œå…¶ä»–ç±»çš„çˆ¶ç±»ã€‚å› ä¸ºI/Oæ ¹æœ¬ä¸Šæ˜¯é¢å‘å­—èŠ‚çš„ï¼Œåªæœ‰<code class="language-plaintext highlighter-rouge"> ByteBuffer </code>å®ä¾‹å¯ä»¥ç”¨channelsã€‚å¤§å¤šæ•°å…¶ä»–Bufferçš„å­ç±»æ–¹ä¾¿äºå¤„ç†multibyteæ•°æ®ï¼ˆä¾‹å¦‚characters or integersï¼‰ã€‚</p>

<h4 id="channels">Channels</h4>

<p>å¼ºåˆ¶CPUæ‰§è¡ŒI/Oä»»åŠ¡å¹¶ç­‰å¾…I/Oå®Œæˆï¼ˆè¿™æ ·çš„CPUè¢«å«åš I/O boundï¼‰æ˜¯èµ„æºçš„æµªè´¹ã€‚å°†è¿™äº›ä»»åŠ¡å¸è½½åˆ°DMA controllerå¯ä»¥æ”¹å–„æ€§èƒ½ï¼Œå¤„ç†å™¨å¯ä»¥åšå…¶ä»–å·¥ä½œã€‚</p>

<p>ä¸€ä¸ªchannelå……å½“ä¸€ä¸ªç®¡é“ç”¨äºè¿æ¥DMA controlleræ¥ä»ç¡¬ç›˜æœ‰æ•ˆæ’å¹²æˆ–å¡«å……å­—èŠ‚æ•°æ®ã€‚JDK 1.4çš„<code class="language-plaintext highlighter-rouge">java.nio.channels.Channel </code>æ¥å£ï¼Œå®ƒçš„å­æ¥å£å’Œä¼—å¤šç±»å®ç°äº†channelæ¶æ„ã€‚</p>

<p>å…¶ä¸­ä¸€ä¸ªç±»æ˜¯<code class="language-plaintext highlighter-rouge"> java.nio.channels.FileChannel</code>ï¼ŒæŠ½è±¡äº†ä¸€ä¸ªchannelç”¨äºè¯»å†™æ˜ å°„æ“ä½œæ–‡ä»¶ã€‚ <code class="language-plaintext highlighter-rouge">FileChannel </code>çš„ä¸€ä¸ªæœ‰è¶£çš„ç‰¹æ€§æ˜¯æ”¯æŒfile lockingï¼Œåœ¨è¿™äº›å¤æ‚çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå¦‚æ•°æ®åº“ç®¡ç†ç³»ç»Ÿã€‚</p>

<p><em>File locking</em>è®©ç¨‹åºåœ¨è®¿é—®æ–‡ä»¶çš„æ—¶å€™é˜»æ­¢æˆ–é™åˆ¶å¯¹æ–‡ä»¶çš„è®¿é—®ã€‚å°½ç®¡æ–‡ä»¶é”å®šå¯ä»¥åº”ç”¨åˆ°æ•´ä¸ªæ–‡ä»¶ä¸­ï¼Œä½†å®ƒé€šå¸¸ä¼šç¼©å°åˆ°ä¸€ä¸ªæ›´å°çš„åŒºåŸŸã€‚ä¸€ä¸ªé”çš„èŒƒå›´ä»ä¸€ä¸ªèµ·å§‹å­—èŠ‚åç§»é‡å¼€å§‹åˆ°æŒç»­æŒ‡å®šæ•°é‡çš„å­—èŠ‚ã€‚</p>

<p><code class="language-plaintext highlighter-rouge"> FileChannel</code>å¦ä¸€ä¸ªæœ‰è¶£çš„ç‰¹æ€§æ˜¯ <em>memory-mapped file I/O</em>ï¼Œé€šè¿‡<code class="language-plaintext highlighter-rouge">map() </code>æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ª<code class="language-plaintext highlighter-rouge"> java.nio.MappedByteBuffer </code>å®ƒçš„å†…å®¹æ˜¯æ–‡ä»¶çš„memory-mapped regionã€‚æ–‡ä»¶å†…å®¹é€šè¿‡å†…å­˜è®¿é—®è¢«è®¿é—®ã€‚ç¼“å†²åŒºå¤åˆ¶å’Œè¯»-å†™ç³»ç»Ÿè°ƒç”¨è¢«æ¶ˆé™¤ã€‚</p>

<p>ä½ å¯ä»¥è°ƒç”¨<code class="language-plaintext highlighter-rouge">java.nio.channels.Channels</code>ç±»æˆ–è€…ç»å…¸I/Oç±»æ¯”å¦‚<code class="language-plaintext highlighter-rouge"> RandomAccessFile </code>çš„æ–¹æ³•æ¥è·å¾—ä¸€ä¸ªchannelã€‚</p>

<h4 id="selectors">Selectors</h4>

<p>I/Oè¢«åˆ†ç±»ä¸ºblock-oriented æˆ– stream-orientedã€‚ä»ä¸€ä¸ªæ–‡ä»¶è¯»æˆ–å†™å…¥ä¸€ä¸ªæ–‡ä»¶æ˜¯block-oriented I/Oçš„ä¾‹å­ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œä»é”®ç›˜è¯»æˆ–å†™å…¥åˆ°ç½‘ç»œè¿æ¥æ˜¯stream-oriented I/Oçš„ä¾‹å­ã€‚</p>

<p>Stream I/O é€šå¸¸æ¯”block I/Oæ…¢ã€‚å¦å¤–ï¼Œè¾“å…¥å¾€å¾€æ˜¯é—´æ­‡çš„ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å¯èƒ½ä¼šè¾“å…¥å­—ç¬¦æµç„¶åæš‚åœï¼Œæˆ–è€…ç½‘ç»œè¿æ¥çš„çŸ­æš‚å»¶è¿Ÿå¯¼è‡´è§†é¢‘æ–­ç»­æ’­æ”¾ã€‚</p>

<p>å¾ˆå¤šæ“ä½œç³»ç»Ÿå…è®¸ streams è¢«é…ç½®æˆ<code class="language-plaintext highlighter-rouge">nonblocking </code> modeï¼Œä¸€ä¸ªçº¿ç¨‹ä¸æ–­åœ°æ£€æŸ¥å¯ç”¨çš„è¾“å…¥ï¼Œå¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œå°±ä¸é˜»å¡ã€‚çº¿ç¨‹å¯ä»¥å¤„ç†ä¼ å…¥çš„æ•°æ®æˆ–åœ¨æ•°æ®æ¥ä¹‹å‰å¤„ç†å…¶ä»–å·¥ä½œã€‚</p>

<p>â€œpolling for available inputâ€ï¼ˆè½®è¯¢å¯ç”¨è¾“å…¥ï¼‰æ´»åŠ¨æ˜¯æµªè´¹çš„ï¼Œç‰¹åˆ«æ˜¯çº¿ç¨‹éœ€è¦ç›‘æ§è®¸å¤šè¾“å…¥æµï¼ˆæ¯”å¦‚åœ¨ web server contextï¼‰ã€‚ç°ä»£æ“ä½œç³»ç»Ÿå¯ä»¥é«˜æ•ˆåœ°åšè¿™ä¸ªæ£€æŸ¥ï¼Œè¢«ç§°ä¸º <em>readiness selection</em> ï¼Œé€šå¸¸å»ºç«‹åœ¨éé˜»å¡æ¨¡å¼ä¸Šã€‚æ“ä½œç³»ç»Ÿç›‘æ§ä¸€ä¸ªstreamsçš„é›†åˆå¹¶ä¸”è¿”å›ç»™çº¿ç¨‹æŒ‡ç¤ºå“ªä¸ªstreamså‡†å¤‡å¥½äº†åšI/Oæ“ä½œã€‚å› æ­¤ï¼Œä¸€ä¸ªå•çº¿ç¨‹å¯ä»¥ multiplexï¼ˆå¤šè·¯å¤ç”¨ï¼‰è®¸å¤šæ´»è·ƒçš„streamsï¼Œä½¿é€šè¿‡æ™®é€šä»£ç åœ¨web server contextç®¡ç†å·¨é‡ç½‘ç»œè¿æ¥æˆä¸ºå¯èƒ½ã€‚</p>

<p>JDK 1.4é€šè¿‡æä¾›<em>selectors</em>æä¾›readiness selectionï¼Œæ˜¯<code class="language-plaintext highlighter-rouge">java.nio.channels.Selector</code>ç±»çš„å®ä¾‹ï¼Œå¯ä»¥æ£€æŸ¥ä¸€ä¸ªæˆ–è€…å¤šä¸ªchannelså¹¶å†³å®šå“ªä¸ªchannelså‡†å¤‡å¥½è¯»å†™ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå•ä¸ªçº¿ç¨‹å¯ä»¥æœ‰æ•ˆç®¡ç†å¤šä¸ªchannelsï¼ˆå› æ­¤ï¼Œå¤šä¸ªç½‘ç»œè¿æ¥ï¼‰ã€‚èƒ½ä½¿ç”¨æ›´å°‘çš„çº¿ç¨‹æ˜¯æœ‰åˆ©çš„ï¼Œå› ä¸ºçº¿ç¨‹çš„åˆ›å»ºå’Œçº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢å¯¹æ€§èƒ½æˆ–å†…å­˜ä½¿ç”¨æ¥è¯´éƒ½å¾ˆæ˜‚è´µã€‚</p>

<p><img src="/assets/img/1532501340607.png" alt="1532501340607" /></p>

<h4 id="regular-expressions">Regular Expressions</h4>

<p>æ­£åˆ™è¡¨è¾¾å¼ä½œä¸ºNIOä¸€éƒ¨åˆ†å¼•å…¥ã€‚è™½ç„¶ä½ æƒ³çŸ¥é“åšè¿™ä¸ªçš„åŸç†ï¼ˆæ­£åˆ™è¡¨è¾¾å¼å¯¹I/Oåšäº†ä»€ä¹ˆï¼‰ï¼Œæ­£åˆ™è¡¨è¾¾å¼é€šå¸¸ç”¨äºæ‰«æä»æ–‡ä»¶æˆ–å…¶ä»–æ¥æºè¯»å–çš„æ–‡æœ¬æ•°æ®ã€‚éœ€è¦å°½å¯èƒ½å¿«åœ°æ‰§è¡Œè¿™äº›æ‰«æï¼Œè¦æ±‚å°†å…¶åŒ…å«åœ¨å†…ã€‚JDK 1.4æä¾›äº†æ­£åˆ™è¡¨è¾¾å¼é€šè¿‡<code class="language-plaintext highlighter-rouge"> java.util.regex  </code>åŒ…å’Œå®ƒçš„<code class="language-plaintext highlighter-rouge">Pattern</code> and <code class="language-plaintext highlighter-rouge">Matcher  </code>ã€‚</p>

<h4 id="charsets">Charsets</h4>

<p>ä¹‹å‰æåˆ°JDK 1.1å¼•å…¥writer/readerç±»æŠŠå­—ç¬¦ç¼–ç è€ƒè™‘åœ¨å†…ã€‚æœ€åˆï¼Œæ¯”å¦‚<code class="language-plaintext highlighter-rouge">java.io.InputStreamReader  </code>çš„ç±»ååŒ<code class="language-plaintext highlighter-rouge"> java.io.ByteToCharConverter</code>ç±»å·¥ä½œæ¥æ‰§è¡ŒåŸºäºç¼–ç çš„è½¬æ¢ã€‚<code class="language-plaintext highlighter-rouge"> ByteToCharConverter </code>ä»JDK 6å¼€å§‹æœ€ç»ˆå¼ƒç”¨äº†ã€‚åœ¨è¿™ä¸ªä½ç½®ï¼Œæ›´èƒ½å¹²çš„åŒ…<code class="language-plaintext highlighter-rouge"> java.nio.charset  </code>å’Œå®ƒçš„<code class="language-plaintext highlighter-rouge">Charset</code>, <code class="language-plaintext highlighter-rouge">CharsetEncoder</code>, <code class="language-plaintext highlighter-rouge">CharsetDecoder</code>, and related typesè¢«å¼•å…¥ã€‚</p>

<h4 id="formatter">Formatter</h4>

<p>JSR 51æåˆ°ä¸€ä¸ªç®€å•çš„ printf-styleæ ¼å¼åŒ–å·¥å…·ã€‚è¿™æ ·ä¸€ä¸ªè®¾æ–½åœ¨å‡†å¤‡æ•°æ®å»å‘ˆç°çš„æ—¶å€™æä¾›æœ‰æ•ˆå€¼ã€‚ç„¶è€Œï¼ŒJDK 1.4æ²¡æœ‰åŒ…å«è¿™ä¸ªèƒ½åŠ›ï¼Œå› ä¸ºå®ƒä¾èµ–è®¸å¤šå‚æ•°åˆ—è¡¨ï¼Œä¸€ä¸ªJDK 5å‰è¿˜æ²¡å¼•å…¥çš„è¯­è¨€ç‰¹æ€§ã€‚å¹¸è¿çš„æ˜¯ï¼ŒJDK 5 åŒ…å«äº†<code class="language-plaintext highlighter-rouge">java.util.Formatter </code>ï¼Œä»–æœ‰ä¸°å¯Œçš„æ ¼å¼åŒ–èƒ½åŠ›ï¼Œå’Œæ”¯æŒè‡ªå®šä¹‰æ ¼å¼åŒ–çš„ç›¸å…³ç±»å‹ï¼Œä»¥åŠæ·»åŠ  <code class="language-plaintext highlighter-rouge">printf()</code> (and related <code class="language-plaintext highlighter-rouge">format()</code>) æ–¹æ³•åˆ° <code class="language-plaintext highlighter-rouge">PrintStream</code> ç±»ã€‚</p>

<h4 id="nio2">NIO.2</h4>

<p>JSR 51æŒ‡å‡ºNIOå°†ä¼šå¼•å…¥æ”¹å–„çš„æ–‡ä»¶ç³»ç»Ÿæ¥å£å…‹æœé—ç•™<code class="language-plaintext highlighter-rouge">File</code>ç±»çš„ä¼—å¤šé—®é¢˜ã€‚ç„¶è€Œï¼Œç¼ºä¹æ—¶é—´å¯¼è‡´è¿™ä¸ªç‰¹æ€§æ²¡åŒ…å«ã€‚åŒæ—¶ï¼Œä¹Ÿä¸å¯èƒ½æ”¯æŒ asynchronous I/Oå’Œå®Œæˆ socket channelåŠŸèƒ½ã€‚JSR 203 (www.jcp.org/en/jsr/detail?id=203)  éšåè½å®äº†è¿™äº›é—æ¼ï¼Œåœ¨JDK 7ç™»åœºã€‚</p>

<p>æ³¨æ„ï¼šè¢«å®˜æ–¹JDK 7ä¹‹å‰ï¼Œ big buffers (buffers with 64-bit addressability) è¢«è®¤ä¸ºç”¨äº NIO.2ã€‚æ¯”å¦‚ <code class="language-plaintext highlighter-rouge">BigByteBuffer</code> and <code class="language-plaintext highlighter-rouge">MappedBigByteBuffer</code>ç±»è®¡åˆ’è¢«åŒ…å«åœ¨<code class="language-plaintext highlighter-rouge"> java.nio </code>æˆ–å…¶ä»–çš„åŒ…ã€‚ç„¶è€Œï¼Œå¦‚åŒåœ¨e â€œBigByteBuffer/Mapped BigByteBufferâ€ OpenJDK è®¨è®ºè¯é¢˜ä¸­è§£é‡Šçš„ï¼Œè¿™ä¸ªèƒ½åŠ›è¢«é—å¼ƒäº†å–è€Œä»£ä¹‹çš„æ˜¯è¿½æ±‚â€œ64-bit arrays or collectionsâ€ã€‚</p>

<h4 id="improved-file-system-interface">Improved File System Interface</h4>

<p>é—ç•™çš„<code class="language-plaintext highlighter-rouge"> Fileç±»</code>æœ‰å¾ˆå¤šé—®é¢˜ã€‚ä¾‹å¦‚<code class="language-plaintext highlighter-rouge">renameTo() </code>æ–¹æ³•è·¨æ“ä½œç³»ç»Ÿä¸ä¸€è‡´ã€‚åŒæ—¶ï¼Œè®¸å¤š<code class="language-plaintext highlighter-rouge"> File </code>çš„æ–¹æ³•æ²¡æœ‰æ‰©å±•ï¼›ä»æœåŠ¡å™¨è¯·æ±‚å¤§ç›®å½•åˆ—è¡¨å¯¼è‡´ hangä½ã€‚JSR 203çš„æ–°æ“ä½œç³»ç»Ÿæ¥å£ä¿®è¡¥äº†è¿™äº›å’Œå…¶ä»–çš„ä¸€äº›é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå®ƒæ”¯æŒå¯¹æ–‡ä»¶å±æ€§çš„æ‰¹é‡è®¿é—®ï¼Œæä¾›å˜æ›´é€šçŸ¥åŠŸèƒ½ï¼Œæä¾›äº†é€ƒç¦»åˆ° file system-specific APIsçš„èƒ½åŠ›ï¼Œå’Œä¸€ä¸ªservice provideræ¥å£ç”¨äºå¯æ’æ‹”æ–‡ä»¶ç³»ç»Ÿå®ç°ã€‚</p>

<h4 id="asynchronous-io">Asynchronous I/O</h4>

<p>Nonblocking modeé€šè¿‡é˜»æ­¢æ‰§è¡Œè¯»å†™æ“ä½œçš„çº¿ç¨‹åœ¨è¾“å…¥å¯ç”¨æˆ–è¾“å‡ºè¢«å…¨éƒ¨å†™å…¥ä¹‹å‰é˜»å¡ä½ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚ç„¶è€Œï¼Œå®ƒä¸è®©åº”ç”¨å†³å®šå®ƒæ˜¯å¦å¯ä»¥åœ¨ä¸å®é™…æ‰§è¡Œæ“ä½œçš„æƒ…å†µä¸‹æ‰§è¡Œæ“ä½œã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªéé˜»å¡è¯»æ“ä½œæˆåŠŸäº†ï¼Œåº”ç”¨ç¨‹åºä¸ä»…äº†è§£è¯»å–æ“ä½œæ˜¯å¯èƒ½çš„è¿˜å·²ç»é˜…è¯»äº†ä¸€äº›å¿…é¡»ç®¡ç†çš„æ•°æ®ã€‚è¿™ä¸ª duality æ˜¯ä½ ä¸ç”¨æŠŠæ£€æŸ¥ stream readiness çš„ä»£ç ä»æ•°æ®æ‰§è¡Œä»£ç åˆ†ç¦»ï¼Œä¸ç”¨è®©ä½ çš„ä»£ç æ˜æ˜¾å¤æ‚ã€‚</p>

<p><em>Asynchronous I/O</em>  æ”¹å–„äº†è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡è®©çº¿ç¨‹å¼€å§‹æ“ä½œå¹¶é©¬ä¸Šæ‰§è¡Œå…¶ä»–å·¥ä½œã€‚çº¿ç¨‹æŒ‡å®šä¸€äº› callbackå‡½æ•°åœ¨æ“ä½œå®Œæˆäº†è¢«è°ƒç”¨ã€‚</p>

<h4 id="completion-of-socket-channel-functionality">Completion of Socket Channel Functionality</h4>

<p>JDK 1.4æ·»åŠ äº† <code class="language-plaintext highlighter-rouge">DatagramChannel</code>, <code class="language-plaintext highlighter-rouge">ServerSocketChannel</code>, and <code class="language-plaintext highlighter-rouge">SocketChannel</code>ç±»åˆ° <code class="language-plaintext highlighter-rouge">java.nio.channels </code>åŒ…ã€‚ç„¶è€Œï¼Œç¼ºä¹æ—¶é—´è¿™äº›ç±»ä¸èƒ½æ”¯æŒç»‘å®šå’Œé€‰é¡¹é…ç½®ã€‚åŒæ—¶ï¼Œä¹Ÿä¸æ”¯æŒo, channel-based multicast datagramsã€‚JDK 7æ·»åŠ äº†ç»‘å®šæ”¯æŒå’Œé€‰é¡¹é…åˆ¶åˆ°æåˆ°çš„ç±»ã€‚åŒæ—¶ï¼Œå¼•å…¥æ–°çš„<code class="language-plaintext highlighter-rouge">java.nio.channels .MulticastChannel</code>æ¥å£ã€‚</p>

<h4 id="summary">Summary</h4>

<p>I/O is fundamental to operating systems, computer languages, and language libraries. Java supports I/O through its classic I/O, NIO, and NIO.2 API categories.</p>

<p>Classic I/O provides APIs to access the file system, access file content randomly (as opposed to sequentially), stream byte-oriented data between sources and destinations, and support character streams.</p>

<p>NIO provides APIs to manage buffers, communicate buffered data over channels, leverage readiness selection via selectors, scan textual data quickly via regular expressions, specify character encodings via charsets, and support printf-style formatting.</p>

<p>NIO.2 provides APIs to improve the file system interface; support asynchronous I/O; and complete socket channel functionality by upgrading DatagramChannel, ServerSocketChannel, and SocketChannel, and by introducing a new MulticastChannel interface.</p>

<h2 id="part-â…±-classic-io-apis">PART â…¡ Classic I/O APIs</h2>

<h3 id="chapter-2-file">Chapter 2 File</h3>

<p>Javaä½¿ç”¨<code class="language-plaintext highlighter-rouge"> java.io.File  </code>è®¿é—®æ–‡ä»¶ç³»ç»Ÿã€‚</p>

<h4 id="constructing-file-instances">Constructing File Instances</h4>

<p>ä¸€ä¸ª File ç±»å®ä¾‹åŒ…å«ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•è·¯å¾„çš„æŠ½è±¡è¡¨å¾ã€‚åˆ›å»ºFileå®ä¾‹ï¼Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">File</span> <span class="n">file1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"/x/y"</span><span class="o">);</span>
<span class="nc">File</span> <span class="n">file2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"C:\\temp\\x.dat"</span><span class="o">);</span>
</code></pre></div></div>

<p>ç¬¬ä¸€è¡Œå‡è®¾æ˜¯ Unix/Linux æ“ä½œç³»ç»Ÿã€‚windowä¹Ÿå¯ä»¥ï¼Œå‡è®¾æ˜¯å½“å‰é©±åŠ¨å™¨ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šä¸€ä¸ªæ“ä½œç³»ç»Ÿç›¸å…³çš„åˆ†éš”ç¬¦ï¼ˆæ¯”å¦‚windowsçš„<code class="language-plaintext highlighter-rouge">\</code>å‡ºç°åœ¨è·¯å¾„çš„è¿ç»­nameä¹‹é—´ ï¼‰</p>

<p>ç¬¬äºŒè¡Œå‡è®¾æ˜¯Windowsç³»ç»Ÿï¼Œä½ ä¹Ÿå¯ä»¥åœ¨windowsç”¨<code class="language-plaintext highlighter-rouge">/</code>ã€‚</p>

<p>éƒ½æ˜¯ç»å¯¹è·¯å¾„ï¼Œä»rootå¼€å§‹ï¼›ä¸éœ€è¦å…¶ä»–ä¿¡æ¯å®šä½æ–‡ä»¶ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œç›¸å¯¹è·¯å¾„ä¸ä»rootå¼€å§‹ï¼›éœ€è¦å¦ä¸€ä¸ªpathçš„ä¿¡æ¯ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š<code class="language-plaintext highlighter-rouge">java.io</code>åŒ…çš„ç±»é»˜è®¤è§£æç›¸å¯¹è·¯å¾„åœ¨å½“å‰ç”¨æˆ·ç›®å½•ï¼ˆworking directoryï¼‰ï¼Œç”±ç³»ç»Ÿå±æ€§<code class="language-plaintext highlighter-rouge">user.dir </code>æŒ‡å®šï¼Œç‰¹åˆ«å®ƒæ˜¯JVMè¢«å¯åŠ¨çš„è·¯å¾„ã€‚ï¼ˆè°ƒç”¨<code class="language-plaintext highlighter-rouge">java.lang.System</code>ç±»çš„<code class="language-plaintext highlighter-rouge"> getProperty()</code>æ–¹æ³•è·å–ç³»ç»Ÿå±æ€§ï¼‰ã€‚</p>

<p>è·¯å¾„å­—ç¬¦ä¸²åˆ°/ä»ç»å¯¹è·¯å¾„çš„è½¬æ¢å†…éƒ¨æ˜¯ä¾èµ–æ“ä½œç³»ç»Ÿçš„ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šdefault name-separator characterç”±ç³»ç»Ÿå±æ€§ <code class="language-plaintext highlighter-rouge">file.separator </code>å®šä¹‰ï¼Œåœ¨Fileçš„public static separator and separatorChar fields å¯ç”¨â€”â€”ç¬¬ä¸€ä¸ªæ˜¯<code class="language-plaintext highlighter-rouge"> java.lang.String</code> ç¬¬äºŒä¸ªæ˜¯<code class="language-plaintext highlighter-rouge">char</code>ã€‚</p>

<p>Fileæä¾›é¢å¤–æ„é€ å™¨ã€‚ä¾‹å¦‚ï¼š</p>

<ul>
  <li>File(String parent, String child) creates a new</li>
</ul>

<p>File instance from a parent path string and a child
path string.</p>

<ul>
  <li>File(File parent, String child) creates a new File</li>
</ul>

<p>instance from a parent path File instance and a child
path string</p>

<p>parentå‚æ•°éƒ½è¢«è½¬åŒ–ä¸ºparent pathï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>File file3 = new File("prj/books/", "io");
</code></pre></div></div>

<p>è·¯å¾„è¢«åˆå¹¶ä¸º<code class="language-plaintext highlighter-rouge">prj/books/io</code>ï¼Œå¦‚æœparentæ˜¯<code class="language-plaintext highlighter-rouge">prj/books</code>ï¼Œä¼šè‡ªåŠ¨åœ¨æœ€ååŠ ä¸Š<code class="language-plaintext highlighter-rouge">/</code>ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šå› ä¸ºFile(String path), File(String parent, String child), and File(File parent, String child) ä¸æ£€æŸ¥æ— æ•ˆè·¯å¾„å‚æ•°ï¼ˆé™¤äº†pathæˆ–è€…childæ˜¯nullæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.lang.NullPointerException </code>ï¼‰ï¼Œä½ å¿…é¡»å°å¿ƒæŒ‡å®špathã€‚è¦åŠ›æ±‚æ‰€æœ‰æ“ä½œç³»ç»Ÿéƒ½æœ‰æ•ˆã€‚ä¾‹å¦‚ï¼Œä¸ä½¿ç”¨ç¡¬ç¼–ç ï¼ˆä¾‹å¦‚ C:ï¼‰ï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">listRoots()</code>è¿”å›çš„rootã€‚æœ€å¥½ï¼Œè®©ä½ çš„pathå’Œuser/working directory ç›¸å…³ï¼ˆä»<code class="language-plaintext highlighter-rouge"> user.dir </code>è¿”å›çš„ï¼‰ã€‚</p>

<h4 id="learning-about-stored-abstract-paths">Learning About Stored Abstract Paths</h4>

<p>å¾—åˆ°Fileå¯¹è±¡åï¼Œä½ æƒ³è¯¢é—®ä»–è·å–æŠ½è±¡å­˜å‚¨è·¯å¾„ï¼Œå¯ä»¥é€šè¿‡è¡¨2-1æ–¹æ³•ï¼š</p>

<p><strong><em>Table 2-1. File Methods for Learning About a Stored Abstract Path</em></strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">File getAbsoluteFile()</td>
      <td>è¿”å›æ–‡ä»¶å¯¹è±¡ abstract pathçš„ absolute formã€‚è¿™ä¸ªæ–¹æ³•ç­‰åŒäº <code class="language-plaintext highlighter-rouge">new File(this.getAbsolutePath())</code></td>
    </tr>
    <tr>
      <td style="text-align: left">String getAbsolutePath()</td>
      <td>è¿”å›ç»å¯¹è·¯å¾„ã€‚å½“å·²ç»æ˜¯ç»å¯¹è·¯å¾„ï¼Œè¿”å›å’Œ<code class="language-plaintext highlighter-rouge">getPath()</code>ä¸€æ ·ï¼Œå½“æ˜¯ç©ºçš„ abstract pathï¼Œè¿”å›å½“å‰ç”¨æˆ·ç›®å½•å­—ç¬¦ä¸²ï¼ˆ<code class="language-plaintext highlighter-rouge"> user.dir </code>ï¼‰ã€‚å¦åˆ™ï¼Œç”¨æ“ä½œç³»ç»Ÿæ–¹å¼è§£å†³ã€‚åœ¨  Unix/ Linux æ“ä½œç³»ç»Ÿï¼Œç›¸å¯¹è·¯å¾„æ˜¯åœ¨ç”¨æˆ·ç›®å½•ï¼Œwindowæ˜¯åœ¨å½“å‰pathå‘½åçš„driveï¼Œå¦‚æœæ²¡æœ‰driveæ˜¯åœ¨ç”¨æˆ·ç›®å½•ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">File getCanonicalFile()</td>
      <td>è¿”å›  canonical ï¼ˆ (simplest possible, absolute and uniqueï¼‰formã€‚I/Oé”™è¯¯å‘ç”Ÿæ—¶æŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException </code>ï¼ˆåˆ›å»º canonical pathéœ€è¦æ–‡ä»¶ç³»ç»ŸæŸ¥è¯¢ï¼‰ï¼›ç­‰åŒäº<code class="language-plaintext highlighter-rouge"> File(this.getCanonicalPath()). </code>ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">String getCanonicalPath()</td>
      <td>è¿”å› canonical path string ã€‚é¦–å…ˆå¿…è¦æ—¶è½¬æ¢ä¸ºç»å¯¹è·¯å¾„ï¼Œå°±åƒè°ƒç”¨<code class="language-plaintext highlighter-rouge"> getAbsolutePath() </code>ï¼Œç„¶åä½¿ç”¨å–å†³äºæ“ä½œç³»ç»Ÿçš„æ–¹å¼æŠŠå®ƒæ˜ å°„åˆ° å®ƒçš„ unique form ã€‚å®ƒç‰¹åˆ«åœ°ç§»é™¤å†—ä½™ ï¼Œæ¯”å¦‚<code class="language-plaintext highlighter-rouge">..</code> <code class="language-plaintext highlighter-rouge">.</code>ç¬¦å·ï¼Œè§£ææ–‡ä»¶é“¾æ¥ï¼ˆ Unix/Linux ï¼‰ï¼Œè½¬æ¢  drive letters ä¸ºæ ‡å‡†å½¢å¼ï¼ˆwindowsï¼‰ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">String getName()</td>
      <td>è¿”å›æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åã€‚æ˜¯path name sequenceæœ€åçš„nameã€‚path name sequenceä¸ºç©ºè¿”å›ç©ºã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">String getParent()</td>
      <td>è¿”å›  parent path string ï¼Œå¦‚æœæ²¡æœ‰parentï¼Œè¿”å›â€œnullâ€ï¼ˆå¯ä»¥æ‰“å°ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">File getParentFile()</td>
      <td>è¿”å›parentæ–‡ä»¶å¤¹ï¼›ä¸æ˜¯æ–‡ä»¶å¤¹è¿”å›â€nullâ€ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">String getPath()</td>
      <td>è¿”å›  Fileâ€™s separator field åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">boolean isAbsolute()</td>
      <td>ç»å¯¹è·¯å¾„è¿”å›trueï¼›ç›¸å¯¹è¿”å›falseã€‚æ ¹æ®ç³»ç»Ÿçš„ã€‚windowså¸¦æœ‰driverï¼Œåé¢æœ‰<code class="language-plaintext highlighter-rouge">\</code>ï¼Œæˆ–è€…<code class="language-plaintext highlighter-rouge">\\</code>å¼€å¤´ã€‚Linux/Unixæ˜¯<code class="language-plaintext highlighter-rouge">/</code>ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">String toString()</td>
      <td>åŒ getPath()</td>
    </tr>
  </tbody>
</table>

<p>Table 2-1 å¼•ç”¨ IOException ã€‚</p>

<p>Listing 2-1å®ä¾‹åŒ–Fileã€‚</p>

<p><strong><em>Listing 2-1. Obtaining Abstract Path Information</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PathInfo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span>
 <span class="o">{</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"usage: java PathInfo path"</span><span class="o">);</span>
 <span class="k">return</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Absolute path = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Canonical path = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getCanonicalPath</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Name = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Parent = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getParent</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Path = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getPath</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Is absolute = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">isAbsolute</span><span class="o">());</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>ç¼–è¯‘<code class="language-plaintext highlighter-rouge">javac PathInfo.java</code>ï¼Œrun <code class="language-plaintext highlighter-rouge">java PathInfo . </code>ï¼Œè¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Absolute path = C:\prj\books\io\ch02\code\PathInfo\.
Canonical path = C:\prj\books\io\ch02\code\PathInfo
Name = .
Parent = null
Path = .
Is absolute = false
</code></pre></div></div>

<p>Canonical pathæ²¡æœ‰<code class="language-plaintext highlighter-rouge">.</code>ï¼Œæ²¡æœ‰parentã€‚</p>

<p>ç»§ç»­<code class="language-plaintext highlighter-rouge"> java PathInfo C:\reports\2015\..\2014\February </code>ï¼Œè¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Absolute path = C:\reports\2015\..\2014\February
Canonical path = C:\reports\2014\February
Name = February
Parent = C:\reports\2015\..\2014
Path = C:\reports\2015\..\2014\February
Is absolute = true

</code></pre></div></div>

<p>æœ€å<code class="language-plaintext highlighter-rouge">java PathInfo "" </code>ï¼Œè¾“å‡º:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Absolute path = C:\prj\books\io\ch02\code\PathInfo
Canonical path = C:\prj\books\io\ch02\code\PathInfo
Name =
Parent = null
Path =
Is absolute = false
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">getName()</code> and <code class="language-plaintext highlighter-rouge">getPath() </code>è¿”å›ç©ºâ€œâ€ï¼Œå› ä¸ºempty path is empty ã€‚</p>

<h4 id="learning-about-a-paths-file-or-directory">Learning About a Pathâ€™s File or Directory</h4>

<p>ä½ å¯ä»¥è¯¢é—®æ–‡ä»¶ç³»ç»Ÿäº†è§£æ–‡ä»¶ã€‚</p>

<p><strong><em>Table 2-2. File Methods for Learning About a File or Directory</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>boolean exists()</td>
      <td>å­˜åœ¨ä¸ºtrueã€‚</td>
    </tr>
    <tr>
      <td>boolean isDirectory()</td>
      <td>æ˜¯å­˜åœ¨çš„æ–‡ä»¶å¤¹è¿”å›trueã€‚</td>
    </tr>
    <tr>
      <td>boolean isFile()</td>
      <td>ä¸€ä¸ªnormalçš„å­˜åœ¨çš„æ–‡ä»¶è¿”å›trueã€‚normalæŒ‡çš„æ˜¯ä¸æ˜¯æ–‡ä»¶å¤¹ï¼Œæ»¡è¶³å…¶ä»–æ“ä½œç³»ç»Ÿçš„çº¦æŸã€‚ä¾‹å¦‚ä¸èƒ½æ˜¯ symbolic link ï¼ˆç¬¦å·é“¾æ¥ï¼‰æˆ– named pipe ï¼ˆå‘½åç®¡é“ï¼‰ã€‚Javaåˆ›å»ºçš„éæ–‡ä»¶å¤¹æ–‡ä»¶éƒ½ä¿è¯æ˜¯ä¸€ä¸ªnormalæ–‡ä»¶ã€‚</td>
    </tr>
    <tr>
      <td>boolean isHidden()</td>
      <td>è¢«éšè—è¿”å›trueã€‚éšè—çš„ç¡®åˆ‡å®šä¹‰æ˜¯ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ã€‚  Unix/Linuxæ˜¯ä»¥<code class="language-plaintext highlighter-rouge">.</code>å¼€å¤´ã€‚windowsæ˜¯åœ¨æ–‡ä»¶ç³»ç»Ÿè¢«æ ‡è®°ã€‚</td>
    </tr>
    <tr>
      <td>long lastModified()</td>
      <td>ä¸Šæ¬¡æ›´æ”¹çš„æ—¶é—´ï¼Œæ–‡ä»¶ä¸å­˜åœ¨æˆ–è€…I/Oé”™è¯¯æ˜¯0ã€‚ è¿”å›çš„å€¼æ˜¯ä»¥æ¯«ç§’ä¸ºå•ä½çš„ï¼Œè‡ªä»  Unix epoch (00:00:00 GMT, January 1, 1970)ã€‚</td>
    </tr>
    <tr>
      <td>long length()</td>
      <td>fileçš„lengthã€‚æ˜¯æ–‡ä»¶å¤¹çš„è¿”å›å€¼æ˜¯ unspecified ï¼Œä¸å­˜åœ¨æ˜¯0ã€‚</td>
    </tr>
  </tbody>
</table>

<p>ç¤ºä¾‹å¦‚ä¸‹ã€‚</p>

<p><strong><em>Listing 2-2. Obtaining File/Directory Information</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileDirectoryInfo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span>
 <span class="o">{</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"usage: java FileDirectoryInfo pathname"</span><span class="o">);</span>
 <span class="k">return</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"About "</span> <span class="o">+</span> <span class="n">file</span> <span class="o">+</span> <span class="s">":"</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Exists = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Is directory = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Is file = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">isFile</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Is hidden = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">isHidden</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Last modified = "</span> <span class="o">+</span>
 <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">()));</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Length = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>ç¼–è¯‘<code class="language-plaintext highlighter-rouge">javac FileDirectoryInfo.java </code></p>

<p>run <code class="language-plaintext highlighter-rouge">java FileDirectoryInfo x.dat </code></p>

<p>å‡è®¾<code class="language-plaintext highlighter-rouge"> x.dat </code> 3ä¸ªå­—èŠ‚å¤§ã€‚</p>

<p>è¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>About x.dat:
Exists = true
Is directory = false
Is file = true
Is hidden = false
Last modified = Sat Jul 25 15:49:41 CDT 2015
Length = 3
</code></pre></div></div>

<h4 id="listing-file-system-root-directories">Listing File System Root Directories</h4>

<p>Fileçš„æ–¹æ³•<code class="language-plaintext highlighter-rouge">File[] listRoots()  </code>è¿”å›rootæ–‡ä»¶å¤¹ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š available file system rootsçš„é›†åˆå—ç³»ç»Ÿçº§åˆ«æ“ä½œå½±å“ï¼Œæ¯”å¦‚æ’å…¥æˆ–æ‹”å‡ºåª’ä½“ï¼Œæ–­å¼€æˆ–å¸è½½ç‰©ç†æˆ–è™šæ‹Ÿç£ç›˜é©±åŠ¨å™¨ã€‚</p>

<p><strong><em>Listing 2-3. Dumping Available File System Roots to Standard Output</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DumpRoots</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">File</span><span class="o">[]</span> <span class="n">roots</span> <span class="o">=</span> <span class="nc">File</span><span class="o">.</span><span class="na">listRoots</span><span class="o">();</span>
 <span class="k">for</span> <span class="o">(</span><span class="nc">File</span> <span class="nl">root:</span> <span class="n">roots</span><span class="o">)</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>ç¼–è¯‘&amp;è¿è¡Œï¼Œè¾“å‡ºï¼š</p>

<p>Win 7</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\
D:\
E:\
F:\
</code></pre></div></div>

<p>Linux</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/
</code></pre></div></div>

<h4 id="obtaining-disk-space-information">Obtaining Disk Space Information</h4>

<p>ä¸€ä¸ª <em>partition</em> (åˆ†åŒº)å¯¹äºæ–‡ä»¶ç³»ç»Ÿæ˜¯ç³»ç»Ÿç‰¹å®šçš„å‚¨å­˜çš„ä¸€éƒ¨åˆ†ã€‚è·å¾—åˆ†åŒºç©ºé—²çš„ç©ºé—´å¤§å°å¾ˆé‡è¦ã€‚åœ¨Java 6ä¹‹å‰ï¼Œå”¯ä¸€ç®€ä¾¿çš„æ–¹å¼æ¥å®Œæˆè¿™ä¸ªäº‹æƒ…æ˜¯é€šè¿‡åˆ›å»ºä¸åŒå¤§å°çš„æ–‡ä»¶æ¥çŒœã€‚</p>

<p>Java 6æ·»åŠ äº†Fileç±»çš„<code class="language-plaintext highlighter-rouge"> long getFreeSpace(), long getTotalSpace()</code>å’Œ <code class="language-plaintext highlighter-rouge">long getUsableSpace()  </code>æ–¹æ³•ï¼Œè¿”å›Fileåˆ†åŒºç©ºé—´ä¿¡æ¯ï¼Œç”±Fileå®ä¾‹çš„abstract pathæè¿°ï¼š</p>

<ul>
  <li>long getFreeSpace()  è¿”å›Fileå¯¹è±¡abstract pathé‰´å®šçš„åˆ†åŒºçš„æœªåˆ†é…å­—èŠ‚æ•°ã€‚</li>
  <li>long getTotalSpace() è¿”å›Fileå¯¹è±¡abstract pathé‰´å®šçš„åˆ†åŒºçš„sizeï¼›å½“abstract pathæ²¡æœ‰å‘½ååˆ†åŒºè¿”å›0ã€‚</li>
  <li>long getUsableSpace() è¿”å›Fileå¯¹è±¡abstract pathé‰´å®šçš„åˆ†åŒºå¯¹å½“å‰JVMå¯ç”¨çš„å­—èŠ‚æ•°ï¼›å½“abstract pathæ²¡æœ‰å‘½ååˆ†åŒºè¿”å›0ã€‚</li>
</ul>

<p>è™½ç„¶ <code class="language-plaintext highlighter-rouge">getFreeSpace() </code>å’Œ<code class="language-plaintext highlighter-rouge"> getUsableSpace() </code>ä¼¼ä¹ç›¸ç­‰ï¼Œä»–ä»¬åœ¨ä»¥ä¸‹æ–¹é¢ä¸åŒï¼šä¸åƒ<code class="language-plaintext highlighter-rouge">getFreeSpace()</code>ï¼Œ <code class="language-plaintext highlighter-rouge">getUsableSpace() </code>æ£€æŸ¥å†™æƒé™å’Œå…¶ä»–çš„æ“ä½œç³»ç»Ÿé™åˆ¶ï¼Œå¾—å‡ºä¸€ä¸ªæ›´å‡†ç¡®çš„ä¼°è®¡ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š <code class="language-plaintext highlighter-rouge">getFreeSpace()</code> and<code class="language-plaintext highlighter-rouge"> getUsableSpace()</code> æ–¹æ³•è¿”å›ä¸€ä¸ªJavaåº”ç”¨å¯ä»¥ä½¿ç”¨å¯ç”¨æˆ–æœªåˆ†é…ç©ºé—´çš„æç¤ºï¼ˆä¸æ˜¯ä¿è¯ï¼‰ã€‚å› ä¸ºJVMå¤–é¢çš„ç¨‹åºä¹Ÿèƒ½ç”¨åˆ†åŒºç©ºé—´ï¼Œå¯¼è‡´å®é™…æœªåˆ†é…æˆ–å¯ç”¨ç©ºé—´æ¯”è¿”å›å€¼è¦å°ã€‚</p>

<p><strong><em>Listing 2-4. Outputting the Free, Usable, and Total Space on All Partitions</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PartitionSpace</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">File</span><span class="o">[]</span> <span class="n">roots</span> <span class="o">=</span> <span class="nc">File</span><span class="o">.</span><span class="na">listRoots</span><span class="o">();</span>
 <span class="k">for</span> <span class="o">(</span><span class="nc">File</span> <span class="nl">root:</span> <span class="n">roots</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Partition: "</span> <span class="o">+</span> <span class="n">root</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Free space on this partition = "</span> <span class="o">+</span>
 <span class="n">root</span><span class="o">.</span><span class="na">getFreeSpace</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Usable space on this partition = "</span> <span class="o">+</span>
 <span class="n">root</span><span class="o">.</span><span class="na">getUsableSpace</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Total space on this partition = "</span> <span class="o">+</span>
 <span class="n">root</span><span class="o">.</span><span class="na">getTotalSpace</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"***"</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>ç¼–è¯‘è¿è¡Œï¼Œè¾“å‡ºï¼ˆWin 7ï¼‰ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Partition: C:\
Free space on this partition = 143271129088
Usable space on this partition = 143271129088
Total space on this partition = 499808989184
***
Partition: D:\
Free space on this partition = 0
Usable space on this partition = 0
Total space on this partition = 0
***
Partition: E:\
Free space on this partition = 733418569728
Usable space on this partition = 733418569728
Total space on this partition = 1000169533440
***
Partition: F:\
Free space on this partition = 33728192512
Usable space on this partition = 33728192512
Total space on this partition = 64021835776
***
</code></pre></div></div>

<h4 id="listing-directories">Listing Directories</h4>

<p>Fileå£°æ˜äº†5ä¸ªæ–¹æ³•è¿”å›ä½äºæ–‡ä»¶å¤¹é‡Œçš„fileå’Œæ–‡ä»¶å¤¹ã€‚</p>

<p><strong><em>Table 2-3. File Methods for Obtaining Directory Content</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>String[] list()</td>
      <td>è·¯å¾„ä¸è¡¨ç¤ºç›®å½•æˆ–è€…å‘ç”ŸI/Oé”™è¯¯ï¼Œè¿”å›nullã€‚å¦åˆ™è¿”å›stringsæ•°ç»„</td>
    </tr>
    <tr>
      <td>String[]list(FilenameFilter   filter)</td>
      <td>åªè¿”å›ç¬¦åˆfilterçš„Strings</td>
    </tr>
    <tr>
      <td>File[] listFiles()</td>
      <td>æŠŠStringsæ•°ç»„è½¬æ¢ä¸ºFilesæ•°ç»„è¿”å›</td>
    </tr>
    <tr>
      <td>File[] listFiles(FileFilter filter)</td>
      <td>è¿”å›ç¬¦åˆfilterçš„Fileæ•°ç»„</td>
    </tr>
    <tr>
      <td>File[] listFiles(FilenameFilter filter)</td>
      <td>è¿”å›ç¬¦åˆfilterçš„Fileæ•°ç»„</td>
    </tr>
  </tbody>
</table>

<p><code class="language-plaintext highlighter-rouge">FilenameFilter</code>æ¥å£å£°æ˜ä¸€ä¸ª<code class="language-plaintext highlighter-rouge"> boolean accept(File dir, String name) </code>æ–¹æ³•ã€‚<code class="language-plaintext highlighter-rouge">dir</code>æ˜¯pathçš„parentéƒ¨åˆ†ï¼ˆæ–‡ä»¶å¤¹pathï¼‰ï¼Œ<code class="language-plaintext highlighter-rouge">name</code>æ˜¯æœ€åçš„æ–‡ä»¶å¤¹çš„nameæˆ–è€…è¿™ä¸ªpathæœ€åçš„æ–‡ä»¶åã€‚</p>

<p><code class="language-plaintext highlighter-rouge">accept()</code>ä½¿ç”¨å‚æ•°å†³å®šæ˜¯å¦ç¬¦åˆè§„åˆ™ï¼Œè¿”å›trueå°±ä¼šåœ¨æ•°ç»„é‡ŒåŒ…å«ã€‚</p>

<p><strong><em>Listing 2-5. Listing Specific Names</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FilenameFilter</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dir</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"usage: java Dir dirpath ext"</span><span class="o">);</span>
 <span class="k">return</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
 <span class="nc">FilenameFilter</span> <span class="n">fnf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FilenameFilter</span><span class="o">()</span>
 <span class="o">{</span>
 <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="nc">File</span> <span class="n">dir</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
 <span class="o">}</span>
 <span class="o">};</span>
 <span class="nc">String</span><span class="o">[]</span> <span class="n">names</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">fnf</span><span class="o">);</span>
 <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="nl">name:</span> <span class="n">names</span><span class="o">)</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>ç¼–è¯‘è¿è¡Œï¼š<code class="language-plaintext highlighter-rouge">java Dir C:\windows exe </code>è¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bfsvc.exe
explorer.exe
fveupdate.exe
HelpPane.exe
hh.exe
IsUninst.exe
kindlegen.exe
notepad.exe
regedit.exe
splwow64.exe
twunk_16.exe
twunk_32.exe
winhlp32.exe
write.exe

</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">listFiles(FileFilter) </code>å¼•å…¥ä¸å¯¹ç§°ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">java.io.FileFilter </code>å£°æ˜ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">accept(String path)</code>æ–¹æ³•ï¼Œå‚æ•°æ˜¯å®Œæ•´çš„pathã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šå¦‚æœæƒ³æœ‰ç›®å½•å’Œæ–‡ä»¶å¤¹åˆ†éš”çš„pathï¼Œç”¨<code class="language-plaintext highlighter-rouge"> FilenameFilter </code>ï¼›è¦ä½¿ç”¨å®Œæ•´çš„è·¯å¾„ï¼Œç”¨<code class="language-plaintext highlighter-rouge">getParent() </code>and <code class="language-plaintext highlighter-rouge">getName() </code>ã€‚</p>

<h4 id="creatingmodifying-files-and-directories">Creating/Modifying Files and Directories</h4>

<p>Fileä¹Ÿæä¾›äº†åˆ›å»ºæ–‡ä»¶ï¼Œæ–‡ä»¶å¤¹ï¼Œå’Œä¿®æ”¹å­˜åœ¨çš„æ–‡ä»¶æ–‡ä»¶å¤¹ã€‚</p>

<p><strong><em>Table 2-4. File Methods for Creating New and Manipulating Existing Files and Directories</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>boolean mkdir()</td>
      <td>åˆ›å»ºæ–‡ä»¶å¤¹ï¼›æˆåŠŸè¿”å›trueã€‚</td>
    </tr>
    <tr>
      <td>boolean mkdirs()</td>
      <td>å±‚çº§åˆ›å»ºã€‚æˆåŠŸè¿”å›trueã€‚</td>
    </tr>
    <tr>
      <td>boolean renameTo(File dest)</td>
      <td>destæ˜¯nullæŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚æˆåŠŸä¸ºtrueã€‚æ–¹æ³•è¡Œä¸ºå¾ˆå¤šå–å†³äºæ“ä½œç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œ rename æ–¹æ³•å¯èƒ½ä¸èƒ½å¤ŸæŠŠæ–‡ä»¶ä»ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿç§»åˆ°å¦ä¸€ä¸ªï¼Œå¯èƒ½ä¸æ˜¯åŸå­æ“ä½œï¼Œç›®æ ‡å­˜åœ¨æ—¶ï¼Œå¯èƒ½ä¸æˆåŠŸã€‚è¿”å›å€¼ä¸€å®šè¦æ£€æŸ¥ï¼Œçœ‹æ˜¯å¦æˆåŠŸã€‚</td>
    </tr>
    <tr>
      <td>boolean setLastModified(long time)</td>
      <td>è®¾ç½®ä¸Šæ¬¡ä¿®æ”¹çš„æ—¶é—´ã€‚æˆåŠŸä¸ºtrueã€‚timeæ˜¯è´Ÿæ•°æŠ›å‡º<code class="language-plaintext highlighter-rouge">  IllegalArgumentException </code>ã€‚æ—¶é—´å¯èƒ½ä¼šè¢« truncatedã€‚</td>
    </tr>
  </tbody>
</table>

<p>å‡è®¾ä½ æƒ³å†™ä¸€ä¸ªï¼Œå¯ä»¥æœ‰ä¸´æ—¶æ–‡ä»¶å»ä¿å­˜å¿«ç…§çš„ç¨‹åºã€‚ä½¿ç”¨<code class="language-plaintext highlighter-rouge">createTempFile()</code>åˆ›å»ºä¸´æ—¶æ–‡ä»¶ã€‚å¦‚æœä½ æ²¡æœ‰æŒ‡å®šå‚¨å­˜è·¯å¾„ï¼Œä¼šä¿å­˜åˆ°ç³»ç»Ÿå±æ€§<code class="language-plaintext highlighter-rouge"> java.io.tmpdir  </code>ã€‚ä½ å¯èƒ½æƒ³ç§»é™¤ä¸´æ—¶æ–‡ä»¶ï¼Œ<code class="language-plaintext highlighter-rouge">deleteOnExit() </code>æ–¹æ³•ï¼Œåœ¨JVMæ²¡æœ‰å´©æºƒæˆ–æ–­ç”µé€€å‡ºæ—¶åˆ é™¤ä¸´æ—¶æ–‡ä»¶ã€‚</p>

<p><strong><em>Listing 2-6. Experimenting with Temporary Files</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TempFileDemo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"java.io.tmpdir"</span><span class="o">));</span>
 <span class="nc">File</span> <span class="n">temp</span> <span class="o">=</span> <span class="nc">File</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="s">"text"</span><span class="o">,</span> <span class="s">".txt"</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">temp</span><span class="o">);</span>
 <span class="n">temp</span><span class="o">.</span><span class="na">deleteOnExit</span><span class="o">();</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="setting-and-getting-permissions">Setting and Getting Permissions</h4>

<p>Java 1.2æ·»åŠ <code class="language-plaintext highlighter-rouge"> boolean setReadOnly()  </code>æ–¹æ³•åˆ°Fileï¼Œæ ‡è®°ä¸€ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ä¸ºåªè¯»ã€‚ç„¶è€Œæ¢å¤å¯å†™çŠ¶æ€çš„æ–¹æ³•æ²¡æœ‰ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œåœ¨Java 6ä¹‹å‰ï¼Œ Fileæ²¡æœ‰åŠæ³•ç®¡ç†æŠ½è±¡è·¯å¾„çš„è¯»ã€å†™å’Œæ‰§è¡Œæƒé™ã€‚</p>

<p>Java 6æ·»åŠ ä¹‹ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>boolean setExecutable(boolean executable, boolean ownerOnly)  falseä¸ºå…¨éƒ¨ç”¨æˆ·</li>
  <li>boolean setExecutable(boolean executable)  è®¾ç½®æ‹¥æœ‰è€…çš„æ‰§è¡Œæƒé™</li>
  <li>boolean setReadable(boolean readable, boolean ownerOnly)</li>
  <li>boolean setReadable(boolean readable)</li>
  <li>boolean setWritable(boolean writable, boolean ownerOnly)</li>
  <li>boolean setWritable(boolean writable)</li>
</ul>

<p>é™¤äº†è¿™äº›æ–¹æ³•ï¼ŒJava 6æ”¹é€ äº†<code class="language-plaintext highlighter-rouge"> boolean canRead()  </code>å’Œ<code class="language-plaintext highlighter-rouge">boolean canWrite() </code>æ–¹æ³•ï¼Œå¼•å…¥<code class="language-plaintext highlighter-rouge"> boolean canExecute() </code>æ–¹æ³•è¿”å›xxxæƒé™ã€‚</p>

<p><strong><em>Listing 2-7. Checking a Fileâ€™s or Directoryâ€™s Permissions</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Permissions</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"usage: java Permissions filespec"</span><span class="o">);</span>
 <span class="k">return</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Checking permissions for "</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" Execute = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">canExecute</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" Read = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">canRead</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" Write = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">canWrite</span><span class="o">());</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="exploring-miscellaneous-capabilities">Exploring Miscellaneous Capabilities</h4>

<p>æœ€åï¼ŒFileå®ç°<code class="language-plaintext highlighter-rouge">java.lang.Comparable </code>æ¥å£çš„<code class="language-plaintext highlighter-rouge"> compareTo()</code>æ–¹æ³•ï¼Œé‡å†™äº†<code class="language-plaintext highlighter-rouge"> equals()  </code>å’Œ<code class="language-plaintext highlighter-rouge"> hashCode() </code>ã€‚</p>

<p><strong><em>Table 2-5. Fileâ€™s Miscellaneous Methods</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>int compareTo(File path)</td>
      <td>å­—å…¸æ¯”è¾ƒä¸¤ä¸ªpathã€‚æ–¹æ³•çš„æ’åºå®šä¹‰å–å†³äºæ“ä½œç³»ç»Ÿã€‚å¯¹  Unix/Linuxï¼Œå­—æ¯æ’åºæ˜¯æœ‰æ„ä¹‰çš„ã€‚windowsæ— æ„ä¹‰ã€‚æŠ½è±¡è·¯å¾„ç›¸åŒè¿”å›0ã€‚è°ƒç”¨ getCanonicalFile() å†æ¯”è¾ƒã€‚</td>
    </tr>
    <tr>
      <td>boolean equals(Object obj))</td>
      <td>å–å†³äºæ“ä½œç³»ç»Ÿã€‚pathä¸€æ ·ã€‚</td>
    </tr>
    <tr>
      <td>int hashCode()</td>
      <td>è¿”å›path çš„å“ˆå¸Œã€‚è®¡ç®—å–å†³äºåº•å±‚æ“ä½œç³»ç»Ÿã€‚åœ¨  Unix/Linux ç­‰äºpath å­—ç¬¦ä¸²çš„å“ˆå¸Œå€¼å¼‚æˆ– 1234321ã€‚windowsï¼Œæ˜¯å°å†™çš„pathå­—ç¬¦ä¸²ã€‚å°å†™pathä¸è€ƒè™‘  current locale ã€‚</td>
    </tr>
  </tbody>
</table>

<p><strong><em>Listing 2-8. Comparing Files</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Compare</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span>
 <span class="o">{</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"usage: java Compare filespec1 filespec2"</span><span class="o">);</span>
 <span class="k">return</span><span class="o">;</span>
 <span class="o">}</span>

 <span class="nc">File</span> <span class="n">file1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
 <span class="nc">File</span> <span class="n">file2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file1</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">file2</span><span class="o">));</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file1</span><span class="o">.</span><span class="na">getCanonicalFile</span><span class="o">()</span>
 <span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">file2</span><span class="o">.</span><span class="na">getCanonicalFile</span><span class="o">()));</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="exercise">exercise</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. What is the purpose of the File class?
2. What do instances of the File class contain?
3. What is a path?
4. What is the difference between an absolute path and a relative path?
5. How do you obtain the current user (also known as working) directory?
6. Define parent path.
7. Fileâ€™s constructors normalize their path arguments. What does
normalize mean?
8. How do you obtain the default name-separator character?
9. What is a canonical path?
10. What is the difference between Fileâ€™s getParent() and
getName() methods?
11. True or false: Fileâ€™s exists() method only determines whether or
not a file exists.
12. What is a normal file?
13. What does Fileâ€™s lastModified() method return?
14. What does Fileâ€™s listRoots() method accomplish?
15. True or false: Fileâ€™s list() method returns an array of Strings
where each entry is a file name rather than a complete path.
16. What is the difference between the FilenameFilter and
FileFilter interfaces?
17. True or false: Fileâ€™s createNewFile() method doesnâ€™t check for
file existence and create the file when it doesnâ€™t exist in a single
operation thatâ€™s atomic with respect to all other file system activities
that might affect the file.
18. Fileâ€™s createTempFile(String, String) method creates a
temporary file in the default temporary directory. How can you locate
this directory?
19. Temporary files should be removed when no longer needed after an
application exits (to avoid cluttering the file system). How do you
ensure that a temporary file is removed when the JVM ends normally
(it doesnâ€™t crash and the power isnâ€™t lost)?
20. Which one of the boolean canRead(), boolean canWrite(), and
boolean canExecute() methods was introduced by Java 6?
21. How would you accurately compare two File objects?
22. Create a Java application named Touch for setting a fileâ€™s or
directoryâ€™s timestamp to the current time. This application has the
following usage syntax: java Touch pathname.
</code></pre></div></div>

<h4 id="summary-1">Summary</h4>

<h3 id="chapter-3-randomaccessfile">Chapter 3 RandomAccessFile</h3>

<p>Fileå¯ä»¥è¢«åˆ›å»ºå’Œ/æˆ–æ‰“å¼€ç”¨äº<em>random access</em> ï¼Œåœ¨æ–‡ä»¶å…³é—­å‰ï¼Œåœ¨å¤šä¸ªä½ç½®å¯ä»¥å‘ç”Ÿæ··åˆè¯»å†™æ“ä½œã€‚Javaæä¾›<code class="language-plaintext highlighter-rouge"> java.io.RandomAccessFile </code>ç±»æ”¯æŒè¿™ç§éšæœºè®¿é—®ã€‚</p>

<h4 id="exploring-randomaccessfile">Exploring RandomAccessFile</h4>

<p>æ„é€ å™¨ï¼š</p>

<ul>
  <li>RandomAccessFile(File file, String mode) ï¼šåˆ›å»ºå’Œæ‰“å¼€ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶æˆ–æ‰“å¼€å­˜åœ¨çš„æ–‡ä»¶ã€‚ç”±abstract pathç¡®å®šï¼Œæ ¹æ®modeåˆ›å»ºå’Œ/æˆ–æ‰“å¼€æ–‡ä»¶ã€‚</li>
  <li>RandomAccessFile(String path, String mode)ï¼šåˆ›å»ºå’Œæ‰“å¼€ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶æˆ–æ‰“å¼€å­˜åœ¨çš„æ–‡ä»¶ã€‚ç”±pathç¡®å®šï¼Œæ ¹æ®modeåˆ›å»ºå’Œ/æˆ–æ‰“å¼€æ–‡ä»¶ã€‚</li>
</ul>

<p>constructorâ€™s modeå‚æ•°å¿…é¡»æ˜¯ <code class="language-plaintext highlighter-rouge">r</code>,<code class="language-plaintext highlighter-rouge">rw</code>,<code class="language-plaintext highlighter-rouge">rws</code>,<code class="language-plaintext highlighter-rouge">rwd</code>å…¶ä¸­ä¹‹ä¸€ï¼Œå¦åˆ™æŠ›å‡º<code class="language-plaintext highlighter-rouge">java.lang. IllegalArgumentException </code>ï¼Œå‚æ•°æ„ä¹‰å¦‚ä¸‹ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">r</code>ï¼Œé€šçŸ¥æ„é€ å™¨æ‰“å¼€ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶åªç”¨äºè¯»ã€‚ä»»ä½•å†™çš„å°è¯•æŠ›å‡º<code class="language-plaintext highlighter-rouge">java.io.IOException</code>ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">rw</code>ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œé€šçŸ¥æ„é€ å™¨åˆ›å»ºå¹¶æ‰“å¼€ä¸€ä¸ªæ–°çš„fileçš„æ—¶å€™ç”¨äºè¯»å†™æˆ–è€…æ‰“å¼€ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶ç”¨äºè¯»å†™ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">rwd</code>ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œé€šçŸ¥æ„é€ å™¨åˆ›å»ºå¹¶æ‰“å¼€ä¸€ä¸ªæ–°çš„fileçš„æ—¶å€™ç”¨äºè¯»å†™æˆ–è€…æ‰“å¼€ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶ç”¨äºè¯»å†™ã€‚å¦å¤–ï¼Œæ¯ä¸ªå¯¹äºæ–‡ä»¶å†…å®¹çš„æ›´æ–°å¿…é¡»åŒæ­¥å†™å…¥åº•å±‚å‚¨å­˜è®¾å¤‡ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">rws</code>å¦‚æœä¸å­˜åœ¨ï¼Œé€šçŸ¥æ„é€ å™¨åˆ›å»ºå¹¶æ‰“å¼€ä¸€ä¸ªæ–°çš„fileçš„æ—¶å€™ç”¨äºè¯»å†™æˆ–è€…æ‰“å¼€ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶ç”¨äºè¯»å†™ã€‚å¦å¤–ï¼Œæ¯ä¸ªå¯¹äºæ–‡ä»¶å†…å®¹æˆ–è€… metadataçš„æ›´æ–°å¿…é¡»åŒæ­¥å†™å…¥åº•å±‚å‚¨å­˜è®¾å¤‡ã€‚</li>
</ul>

<p><strong>æ³¨æ„</strong>ï¼šæ–‡ä»¶çš„metadataæ˜¯å…³äºæ–‡ä»¶çš„ä½†ä¸æ˜¯å®é™…æ–‡ä»¶å†…å®¹ã€‚metadataä¾‹å¦‚æœ‰ï¼šfileçš„lengthï¼Œä¸Šæ¬¡æ›´æ”¹çš„æ—¶é—´ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">rws</code>å’Œ<code class="language-plaintext highlighter-rouge">rwd</code>åŒæ­¥å†™å…¥ï¼Œä¿è¯äº†å…³é”®æ•°æ®åœ¨æ“ä½œç³»ç»Ÿå´©æºƒä¸ä¼šä¸¢å¤±ã€‚å½“æ–‡ä»¶ä¸åœ¨æœ¬åœ°è®¾å¤‡ä¸Šæ—¶æ˜¯ä¸èƒ½ä¿è¯çš„ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š<code class="language-plaintext highlighter-rouge">rws</code>å’Œ<code class="language-plaintext highlighter-rouge">rwd</code>æ‰“å¼€çš„æ–‡ä»¶è¦æ¯”<code class="language-plaintext highlighter-rouge">rw</code>æ¨¡å¼æ‰“å¼€çš„æ–‡ä»¶æ…¢ã€‚</p>

<p>å½“<code class="language-plaintext highlighter-rouge">r</code>æ¨¡å¼pathæ‰“ä¸å¼€çš„æ—¶å€™ï¼ˆä¸å­˜åœ¨æˆ–æ˜¯æ–‡ä»¶å¤¹ï¼‰ï¼Œ<code class="language-plaintext highlighter-rouge">rw</code>æ¨¡å¼çš„pathæ˜¯åªè¯»æƒé™çš„æ—¶å€™æˆ–è€…æ˜¯æ–‡ä»¶å¤¹ï¼ŒæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.FileNotFoundException </code>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RandomAccessFile</span> <span class="n">raf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="s">"employee.dat"</span><span class="o">,</span> <span class="s">"r"</span><span class="o">);</span>
</code></pre></div></div>

<p>ä¸€ä¸ª random access fileå’Œä¸€ä¸ªfileæŒ‡é’ˆå…³è”ï¼Œä¸€ä¸ªæ¸¸æ ‡æŒ‡ç¤ºä¸‹ä¸ªè¦è¯»/å†™çš„å­—èŠ‚çš„ä½ç½®ã€‚å½“ä¸€ä¸ªå­˜åœ¨æ–‡ä»¶è¢«æ‰“å¼€ï¼ŒfileæŒ‡é’ˆè¢«è®¾ç½®ä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œåœ¨offset 0 ã€‚å½“æ–‡ä»¶è¢«åˆ›å»ºæ—¶ï¼ŒfileæŒ‡é’ˆä¹Ÿè¢«è®¾ä¸º0ã€‚</p>

<p>è¯»å†™æ“ä½œåœ¨æ–‡ä»¶pointerå¼€å§‹ï¼Œå¹¶æŠŠä»–æ¨è¿›å·²ç»è¯»æˆ–å†™è¿‡çš„å­—èŠ‚æ•°ã€‚å†™è¶…å‡ºäº†æ–‡ä»¶å½“å‰æœ«å°¾çš„æ“ä½œä¼šå¯¼è‡´æ–‡ä»¶è¢«æ‰©å±•ã€‚æ“ä½œä¼šç»§ç»­ç›´åˆ°Fileå…³é—­ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">RandomAccessFile</code>çš„ä»£è¡¨æ–¹æ³•ï¼š</p>

<p><strong><em>Table 3-1. RandomAccessFile Methods</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>int readInt()</td>
      <td>ä»æ–‡ä»¶è¯»è¿”å›  32-bit integerã€‚ä»å½“å‰fileæŒ‡é’ˆå¼€å§‹è¯»å–4ä¸ªå­—èŠ‚ã€‚ å¦‚æœå­—èŠ‚è¯»å–ä¾æ¬¡æ˜¯b1 b2 b3å’Œb4 ï¼Œ<code class="language-plaintext highlighter-rouge">0 &lt;= b1, b2, b3, b4 &lt;= 255</code> ï¼Œç»“æœç­‰äº <code class="language-plaintext highlighter-rouge">(b1 &lt;&lt; 24) | (b2 &lt;&lt; 16) | (b3 &lt;&lt; 8) | b4</code>. è¿™ä¸ªæ–¹æ³•åœ¨4ä¸ªå­—èŠ‚è¯»å®Œã€æ£€æµ‹åˆ°æ–‡ä»¶æœ«å°¾ã€æˆ–æŠ›å‡ºå¼‚å¸¸ä¹‹å‰ä¼šé˜»å¡ã€‚åœ¨è¯»4ä¸ªå­—èŠ‚å‰åˆ°è¾¾æ–‡ä»¶æœ«å°¾æŠ›å‡º  <code class="language-plaintext highlighter-rouge">EOFException </code>ï¼ŒI/Oé”™è¯¯æŠ›å‡º  <code class="language-plaintext highlighter-rouge">IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>void seek(long pos)</td>
      <td>è®¾ç½®æ–‡ä»¶æŒ‡é’ˆçš„å½“å‰offsetï¼ˆä»æ–‡ä»¶å¼€å¤´å¼€å§‹ç”¨å­—èŠ‚æµ‹é‡ï¼‰ã€‚å¦‚æœ offset è®¾ç½®è¶…å‡ºäº†æ–‡ä»¶å°¾ï¼Œfileçš„lengthä¸ä¼šå˜ã€‚åªæœ‰é€šè¿‡å†™æ‰è¡Œã€‚posæ˜¯è´Ÿå€¼æˆ–è€…I/Oé”™è¯¯æŠ›å‡º<code class="language-plaintext highlighter-rouge">  IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>void setLength(long newLength)</td>
      <td>è®¾ç½®æ–‡ä»¶lengthã€‚å¦‚æœ<code class="language-plaintext highlighter-rouge"> length() </code>è¿”å›çš„æ¯”newLengthå¤§ï¼Œfileè¢« truncatedã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœ<code class="language-plaintext highlighter-rouge"> getFilePointer() </code>è¿”å›çš„offsetæ¯”newLengthå¤§ï¼Œåœ¨<code class="language-plaintext highlighter-rouge"> setLength()  </code>è¿”å›åï¼Œoffsetä¼šç­‰äº newLengthã€‚å¦‚æœå½“å‰é•¿åº¦æ¯”newLengthå°ï¼Œæ–‡ä»¶è¢«æ‰©å±•ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰©å±•éƒ¨åˆ†çš„æ–‡ä»¶å†…å®¹æ²¡æœ‰è¢«å®šä¹‰ã€‚I/Oé”™è¯¯æŠ›å‡º<code class="language-plaintext highlighter-rouge"> IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>int skipBytes(int n)</td>
      <td>å°è¯•è·³è¿‡nä¸ªå­—èŠ‚ã€‚ This method skips over a smaller number of bytes (possibly zero) when the end of file is reached before n bytes have been skippedã€‚åœ¨è¿™ç§æƒ…å†µä¸æŠ›å‡º<code class="language-plaintext highlighter-rouge"> EOFException </code>ã€‚næ˜¯è´Ÿæ•°ï¼Œä¸è·³ã€‚è¿”å›å®é™…çš„è·³è·ƒæ•°ã€‚I/Oé”™è¯¯æŠ›å‡º<code class="language-plaintext highlighter-rouge"> IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>void write(byte[] b)</td>
      <td>ä»å½“å‰æ–‡ä»¶æŒ‡é’ˆå¼€å§‹å†™   byte array b  çš„  b.length bytesã€‚I/Oé”™è¯¯æŠ›å‡º<code class="language-plaintext highlighter-rouge"> IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>void write(int b)</td>
      <td>å†™ä¸€ä¸ªæ›´ä½çš„8 bitsçš„ bä½œä¸ºä¸€ä¸ª32 bitsçš„integeråˆ°æ–‡ä»¶ä»å½“å‰æ–‡ä»¶æŒ‡é’ˆå¼€å§‹ã€‚I/Oé”™è¯¯æŠ›å‡º<code class="language-plaintext highlighter-rouge"> IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>void writeChars(String s)</td>
      <td>å†™ s ä½œä¸º characters çš„åºåˆ—åˆ°æ–‡ä»¶ä»å½“å‰æ–‡ä»¶æŒ‡é’ˆå¼€å§‹ã€‚I/Oé”™è¯¯æŠ›å‡º<code class="language-plaintext highlighter-rouge"> IOException </code></td>
    </tr>
    <tr>
      <td>void writeInt(int i)</td>
      <td>å†™32 bitsçš„integeråˆ°fileä»å½“å‰æ–‡ä»¶æŒ‡é’ˆå¼€å§‹ã€‚ è¿™å››ä¸ªå­—èŠ‚æ˜¯å…ˆç”¨é«˜å­—èŠ‚å†™çš„ã€‚I/Oé”™è¯¯æŠ›å‡º<code class="language-plaintext highlighter-rouge"> IOException </code></td>
    </tr>
  </tbody>
</table>

<p>ä¸Šé¢æ–¹æ³•æ˜¯ä¸è¨€è€Œå–»çš„ã€‚ç„¶è€Œï¼Œ<code class="language-plaintext highlighter-rouge">getFD() </code> æ–¹æ³•éœ€è¦è¿›ä¸€æ­¥å¯ç¤ºã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š<code class="language-plaintext highlighter-rouge">RandomAccessFile </code>çš„readå¼€å¤´çš„æ–¹æ³•å’Œ<code class="language-plaintext highlighter-rouge">skipBytes() </code>èµ·æºäº<code class="language-plaintext highlighter-rouge"> java.io.DataInput </code>æ¥å£ï¼Œ<code class="language-plaintext highlighter-rouge">RandomAccessFile</code>å®ç°äº†å®ƒã€‚å¦å¤–ï¼Œwriterå¼€å¤´çš„æ–¹æ³•æºäº<code class="language-plaintext highlighter-rouge">java.io.DataOutput </code>æ¥å£ï¼Œä¹Ÿå®ç°äº†è¿™ä¸ªæ¥å£ã€‚</p>

<p>å½“æ–‡ä»¶è¢«æ‰“å¼€ï¼Œåº•å±‚æ“ä½œç³»ç»Ÿåˆ›å»ºä¸€ä¸ªåŸºäºæ“ä½œç³»ç»Ÿçš„ç»“æ„æ¥ä»£è¡¨æ–‡ä»¶ã€‚å¯¹è¿™ä¸ªç»“æ„çš„handleä¿å­˜åœ¨<code class="language-plaintext highlighter-rouge">java.io.FileDescriptor </code>ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œ<code class="language-plaintext highlighter-rouge"> getFD()</code>è¿”å›è¿™ä¸ªå®ä¾‹ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šä¸€ä¸ªhandleæ˜¯ä¸€ä¸ªJavaä¼ é€’ç»™åº•å±‚æ“ä½œç³»ç»Ÿæ¥è¯†åˆ«çš„æ ‡è¯†ç¬¦ï¼Œåœ¨è¿™ç§æƒ…å†µï¼Œæ˜¯ä¸€ä¸ªç‰¹å®šçš„æ‰“å¼€çš„æ–‡ä»¶ï¼Œå½“éœ€è¦åº•å±‚æ“ä½œç³»ç»Ÿæ‰§è¡Œæ–‡ä»¶æ“ä½œæ—¶å€™ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">FileDescriptor </code>æ˜¯ä¸€ä¸ªå°çš„ç±»ï¼Œå£°æ˜äº†3ä¸ª<code class="language-plaintext highlighter-rouge">FileDescriptor </code>å¸¸é‡å«åš<code class="language-plaintext highlighter-rouge">in</code>,<code class="language-plaintext highlighter-rouge">out</code>,<code class="language-plaintext highlighter-rouge">error</code>ã€‚è¿™ä¸‰ä¸ªå¸¸é‡ä½¿<code class="language-plaintext highlighter-rouge">System.in</code>, <code class="language-plaintext highlighter-rouge">System. out</code>, and <code class="language-plaintext highlighter-rouge">System.err </code>æä¾›åˆ°æ ‡å‡†è¾“å…¥è¾“å‡ºé”™è¯¯æµçš„è®¿é—®ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">FileDescriptor</code> ä¹Ÿå£°æ˜ä»¥ä¸‹2ä¸ªæ–¹æ³•ï¼š</p>

<ul>
  <li>void sync() å‘Šè¯‰åº•å±‚æ“ä½œç³»ç»Ÿå»flush(empty)æ‰“å¼€æ–‡ä»¶è¾“å‡ºbuffersçš„å†…å®¹åˆ°å…³è”çš„æœ¬åœ°ç£ç›˜è®¾å¤‡ã€‚ <code class="language-plaintext highlighter-rouge">sync() </code>è¿”å›æ‰€æœ‰ä¿®æ”¹äº†çš„æ•°æ®å’Œå±æ€§ã€‚å½“buffersä¸èƒ½è¢«flushedæˆ–è€…å› ä¸ºæ“ä½œç³»ç»Ÿä¸èƒ½ä¿è¯æ‰€æœ‰bufferså’Œç‰©ç†åª’ä»‹åŒæ­¥æ—¶ï¼Œ æŠ›å‡º<code class="language-plaintext highlighter-rouge">java. io.SyncFailedException </code>ã€‚</li>
  <li>boolean valid() å†³å®šfile descriptor objectæ˜¯ä¸æ˜¯æœ‰æ•ˆçš„ã€‚å½“ file descriptor objectå¯¹è±¡è¡¨ç¤ºæ‰“å¼€çš„æ–‡ä»¶æˆ–æ´»åŠ¨çš„I/Oè¿æ¥è¿”å›trueï¼›å¦åˆ™è¿”å›falseã€‚</li>
</ul>

<p>å†™å…¥åˆ°æ‰“å¼€æ–‡ä»¶çš„æ•°æ®è¢«ä¿å­˜åœ¨åº•å±‚æ“ä½œç³»ç»Ÿçš„è¾“å‡ºbuffersã€‚å½“bufferså……æ»¡åˆ°äº†capacityï¼ˆå®¹é‡ï¼‰ï¼Œæ“ä½œç³»ç»Ÿæ¸…ç©ºå®ƒä»¬åˆ°ç£ç›˜ã€‚buffersæ”¹å–„äº†æ€§èƒ½å› ä¸ºç£ç›˜è®¿é—®æ¯”å†…å­˜æ…¢ã€‚</p>

<p>ç„¶è€Œï¼Œå½“ä½ å†™æ•°æ®åˆ°<code class="language-plaintext highlighter-rouge">rwd</code>æˆ–<code class="language-plaintext highlighter-rouge">rws</code>æ¨¡å¼æ‰“å¼€çš„ random access fileï¼Œæ¯ä¸ªå†™æ“ä½œçš„æ•°æ®éƒ½æ˜¯ç›´æ¥å†™åˆ°ç£ç›˜ã€‚ç»“æœæ˜¯ï¼Œå†™æ“ä½œæ¯”<code class="language-plaintext highlighter-rouge">rw</code>æ¨¡å¼è¦æ…¢ã€‚</p>

<p>å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼Œè¦ç»“åˆé€šè¿‡output bufferså†™æ•°æ®å’Œç›´æ¥å†™æ•°æ®åˆ°ç£ç›˜ã€‚ä¸‹é¢çš„ä¾‹å­è½åœ°äº†è¿™ä¸ªæ··åˆåœºæ™¯ï¼Œç”¨<code class="language-plaintext highlighter-rouge">rw</code>æ¨¡å¼æ‰“å¼€ï¼Œé€‰æ‹©æ€§è°ƒç”¨ <code class="language-plaintext highlighter-rouge">FileDescriptor</code>çš„<code class="language-plaintext highlighter-rouge">sync()  </code>æ–¹æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RandomAccessFile</span> <span class="n">raf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="s">"employee.dat"</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">);</span>
<span class="nc">FileDescriptor</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">raf</span><span class="o">.</span><span class="na">getFD</span><span class="o">();</span>
<span class="c1">// Perform a critical write operation.</span>
<span class="n">raf</span><span class="o">.</span><span class="na">write</span><span class="o">(...);</span>
<span class="c1">// Synchronize with the underlying disk by flushing the operating system</span>
<span class="c1">// output buffers to the disk.</span>
<span class="n">fd</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
<span class="c1">// Perform a non-critical write operation where synchronization isn't</span>
<span class="c1">// necessary.</span>
<span class="n">raf</span><span class="o">.</span><span class="na">write</span><span class="o">(...);</span>
<span class="c1">// Do other work.</span>
<span class="c1">// Close the file, emptying output buffers to the disk.</span>
<span class="n">raf</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div>

<h4 id="using-randomaccessfile">Using RandomAccessFile</h4>

<p><code class="language-plaintext highlighter-rouge">RandomAccessFile </code>å¯¹å»ºä¸€ä¸ª<em>flat file database</em> å¾ˆæœ‰ç”¨ï¼Œä¸€ä¸ªå•ä¸ªæ–‡ä»¶è¢«ç»„ç»‡æˆrecords and fieldsã€‚ä¸€ä¸ªrecordä¿å­˜å•ä¸ªentryï¼ˆå°±åƒä¸€ä¸ªparts databaseçš„partï¼‰ï¼Œä¸€ä¸ªfieldä¿å­˜entryçš„å•ä¸ªå±æ€§ï¼ˆå°±åƒa part numberï¼‰ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šterm fieldä¹Ÿç”¨äºå¼•ç”¨ç±»ä¸­å£°æ˜çš„å˜é‡ ã€‚ä¸ºäº†é¿å…å’Œé‡è½½æœ¯è¯­æ··æ·†ï¼ŒæŠŠä¸€ä¸ªfieldå˜é‡æƒ³è±¡æˆç±»ä¼¼äºä¸€ä¸ªrecord fieldå±æ€§ã€‚</p>

<p>flat file database å…¸å‹åœ°ç»„ç»‡å†…å®¹ä¸ºå›ºå®šé•¿åº¦çš„recordsåºåˆ—ã€‚æ¯ä¸ªrecordè¢«è¿›ä¸€æ­¥ç»„ç»‡æˆä¸€ä¸ªæˆ–å¤šä¸ªå›ºå®šé•¿åº¦çš„recordsã€‚</p>

<p><img src="/assets/img/1532677457611.png" alt="1532677457611" /></p>

<p>æ¼”ç¤ºç”¨<code class="language-plaintext highlighter-rouge">RandomAccessFile </code>å®ç°ä¸€ä¸ª flat file databaseï¼š</p>

<p><strong><em>Listing 3-1. Implementing the Parts Flat File Database</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.RandomAccessFile</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PartsDB</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">PNUMLEN</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">DESCLEN</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">QUANLEN</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">COSTLEN</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">RECLEN</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="no">PNUMLEN</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="no">DESCLEN</span> <span class="o">+</span> <span class="no">QUANLEN</span> <span class="o">+</span>
            <span class="no">COSTLEN</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">RandomAccessFile</span> <span class="n">raf</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PartsDB</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">raf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">append</span><span class="o">(</span><span class="nc">String</span> <span class="n">partnum</span><span class="o">,</span> <span class="nc">String</span> <span class="n">partdesc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">qty</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ucost</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">raf</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">raf</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="n">write</span><span class="o">(</span><span class="n">partnum</span><span class="o">,</span> <span class="n">partdesc</span><span class="o">,</span> <span class="n">qty</span><span class="o">,</span> <span class="n">ucost</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">raf</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ioe</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">numRecs</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">raf</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">/</span> <span class="no">RECLEN</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Part</span> <span class="nf">select</span><span class="o">(</span><span class="kt">int</span> <span class="n">recno</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">recno</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">recno</span> <span class="o">&gt;=</span> <span class="n">numRecs</span><span class="o">())</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">recno</span> <span class="o">+</span> <span class="s">" out of range"</span><span class="o">);</span>
        <span class="n">raf</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">recno</span> <span class="o">*</span> <span class="no">RECLEN</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">read</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="kt">int</span> <span class="n">recno</span><span class="o">,</span> <span class="nc">String</span> <span class="n">partnum</span><span class="o">,</span> <span class="nc">String</span> <span class="n">partdesc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">qty</span><span class="o">,</span>
                       <span class="kt">int</span> <span class="n">ucost</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">recno</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">recno</span> <span class="o">&gt;=</span> <span class="n">numRecs</span><span class="o">())</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">recno</span> <span class="o">+</span> <span class="s">" out of range"</span><span class="o">);</span>
        <span class="n">raf</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">recno</span> <span class="o">*</span> <span class="no">RECLEN</span><span class="o">);</span>
        <span class="n">write</span><span class="o">(</span><span class="n">partnum</span><span class="o">,</span> <span class="n">partdesc</span><span class="o">,</span> <span class="n">qty</span><span class="o">,</span> <span class="n">ucost</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Part</span> <span class="nf">read</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">PNUMLEN</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">raf</span><span class="o">.</span><span class="na">readChar</span><span class="o">());</span>
        <span class="nc">String</span> <span class="n">partnum</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">trim</span><span class="o">();</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">DESCLEN</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">raf</span><span class="o">.</span><span class="na">readChar</span><span class="o">());</span>
        <span class="nc">String</span> <span class="n">partdesc</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">trim</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">qty</span> <span class="o">=</span> <span class="n">raf</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">ucost</span> <span class="o">=</span> <span class="n">raf</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Part</span><span class="o">(</span><span class="n">partnum</span><span class="o">,</span> <span class="n">partdesc</span><span class="o">,</span> <span class="n">qty</span><span class="o">,</span> <span class="n">ucost</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">String</span> <span class="n">partnum</span><span class="o">,</span> <span class="nc">String</span> <span class="n">partdesc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">qty</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ucost</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">(</span><span class="n">partnum</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="no">PNUMLEN</span><span class="o">)</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="no">PNUMLEN</span><span class="o">);</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="no">PNUMLEN</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="no">PNUMLEN</span> <span class="o">-</span> <span class="n">sb</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">raf</span><span class="o">.</span><span class="na">writeChars</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">(</span><span class="n">partdesc</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="no">DESCLEN</span><span class="o">)</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="no">DESCLEN</span><span class="o">);</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="no">DESCLEN</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="no">DESCLEN</span> <span class="o">-</span> <span class="n">sb</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">raf</span><span class="o">.</span><span class="na">writeChars</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">raf</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">qty</span><span class="o">);</span>
        <span class="n">raf</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">ucost</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Part</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">partnum</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">desc</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">qty</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">ucost</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Part</span><span class="o">(</span><span class="nc">String</span> <span class="n">partnum</span><span class="o">,</span> <span class="nc">String</span> <span class="n">desc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">qty</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ucost</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">partnum</span> <span class="o">=</span> <span class="n">partnum</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">qty</span> <span class="o">=</span> <span class="n">qty</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">ucost</span> <span class="o">=</span> <span class="n">ucost</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">String</span> <span class="nf">getDesc</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">desc</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">String</span> <span class="nf">getPartnum</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">partnum</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="nf">getQty</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">qty</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="nf">getUnitCost</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">ucost</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">PartsDB</code> å…ˆå£°æ˜äº†å¸¸é‡ç¡®å®šstringå’Œ32-bits integer fieldçš„lengthã€‚ç„¶åå£°æ˜å¸¸é‡ç”¨å­—èŠ‚è®¡ç®—çš„record lengthã€‚è®¡ç®—è€ƒè™‘åˆ°äº†å­—ç¬¦åœ¨æ–‡ä»¶ä¸­å ä¸¤ä¸ªå­—èŠ‚ã€‚</p>

<p>ç„¶åæ˜¯field <code class="language-plaintext highlighter-rouge">raf </code>ï¼Œæ˜¯<code class="language-plaintext highlighter-rouge">RandomAccessFile </code>ç±»å‹ã€‚è¿™ä¸ªfieldåœ¨éšåçš„æ„é€ å‡½æ•°è¢«åˆ†é…ä¸ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">RandomAccessFile </code>ç±»å®ä¾‹ï¼Œä»–ä¼šåˆ›å»º/æ‰“å¼€ä¸€ä¸ªæ–°çš„æ–‡ä»¶æˆ–è€…æ‰“å¼€ä¸€ä¸ªå­˜åœ¨æ–‡ä»¶ï¼Œå› ä¸ºæ˜¯<code class="language-plaintext highlighter-rouge">rw</code>modeã€‚</p>

<p><code class="language-plaintext highlighter-rouge">PartsDB </code>ç„¶åå£°æ˜<code class="language-plaintext highlighter-rouge">append(), close(), numRecs(), select(), and update() </code>ã€‚è¿™ä¸ªæ–¹æ³•æ·»åŠ ä¸€ä¸ªrecordåˆ°fileï¼Œå…³é—­fileï¼Œè¿”å›fileçš„recordæ•°ï¼Œé€‰æ‹©å’Œè¿”å›ä¸€ä¸ªç‰¹å®šçš„recordï¼Œæ›´æ–°ä¸€ä¸ªç‰¹å®šçš„recordï¼š</p>

<ul>
  <li>append() æ–¹æ³•å…ˆè°ƒç”¨<code class="language-plaintext highlighter-rouge">length() and seek() </code>ã€‚ç¡®ä¿åœ¨è°ƒç”¨private <code class="language-plaintext highlighter-rouge">write()</code>æ–¹æ³•æŠŠrecordå†™å…¥å‰ï¼Œæ–‡ä»¶æŒ‡é’ˆåœ¨æ–‡ä»¶æœ«å°¾ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">RandomAccessFileâ€™s close()</code>æ–¹æ³•å¯ä»¥æŠ›å‡º<code class="language-plaintext highlighter-rouge">IOException</code> ã€‚å› ä¸ºå¼‚å¸¸å¾ˆå°‘è§ï¼Œé€‰æ‹©åœ¨<code class="language-plaintext highlighter-rouge">close()</code>æ–¹æ³•é‡Œå¤„ç†æ‰å¼‚å¸¸ï¼Œè®©æ–¹æ³•ç­¾åç®€å•ã€‚ç„¶è€Œï¼Œé”™è¯¯å‘ç”Ÿä¼šæ‰“å°å¼‚å¸¸ä¿¡æ¯ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">numRecs()</code>æ–¹æ³•è¿”å›recordsæ•°ã€‚è¿™äº›è®°å½•ä»0ç¼–å·åˆ°<code class="language-plaintext highlighter-rouge">numRecs() -1</code>ã€‚<code class="language-plaintext highlighter-rouge">select() </code>å’Œ<code class="language-plaintext highlighter-rouge">update()</code>æ–¹æ³•çš„<code class="language-plaintext highlighter-rouge">recno</code>å‚æ•°éƒ½åœ¨è¿™ä¸ªèŒƒå›´ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">select() </code>æ–¹æ³•è°ƒç”¨private <code class="language-plaintext highlighter-rouge">read()</code>è¿”å›<code class="language-plaintext highlighter-rouge"> recno</code>å†³å®šçš„recordå®ä¾‹ï¼ˆ<code class="language-plaintext highlighter-rouge">Part</code>ï¼‰ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">update() </code>æ–¹æ³•åŒæ ·ç®€å•ã€‚å’Œ<code class="language-plaintext highlighter-rouge">select()</code>ä¸€æ ·ï¼ŒæŠŠfileæŒ‡é’ˆå®šä½åˆ°<code class="language-plaintext highlighter-rouge">recno</code>å†³å®šçš„recordã€‚å’Œ<code class="language-plaintext highlighter-rouge">append()</code>ä¸€æ ·ï¼Œè°ƒç”¨<code class="language-plaintext highlighter-rouge">write()</code>å†™å…¥å‚æ•°æ›¿æ¢recordè€Œä¸æ˜¯æ·»åŠ ã€‚</li>
</ul>

<p>ä½¿ç”¨ private <code class="language-plaintext highlighter-rouge">write() </code>å†™å…¥recordsã€‚å› ä¸ºfieldså¿…é¡»æœ‰ç²¾ç¡®çš„sizeï¼Œ<code class="language-plaintext highlighter-rouge">write()</code>æ‹‰é•¿æ¯”ä¸€ä¸ªfield sizeçŸ­çš„åŸºäºStringçš„å€¼ï¼Œåœ¨å³è¾¹åŠ ç©ºæ ¼ã€‚å¿…è¦æ—¶å°†è¿™äº›å€¼è£å‰ªæˆfieldå¤§å° ã€‚</p>

<p>ä½¿ç”¨private<code class="language-plaintext highlighter-rouge"> read() </code>è¯»recordã€‚<code class="language-plaintext highlighter-rouge"> read()  </code>åœ¨ç»™Partèµ‹å€¼æ—¶ç§»é™¤åŸºäºStringå€¼å¡«å……ã€‚</p>

<p>å°±å…¶æœ¬èº«è€Œè¨€ï¼Œ<code class="language-plaintext highlighter-rouge">PartsDB</code>æ˜¯æ— ç”¨çš„ã€‚åšä¸ªå®éªŒä½“éªŒä¸€ä¸‹ï¼š</p>

<p><strong><em>Listing 3-2. Experimenting with the Parts Flat File Database</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsePartsDB</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">PartsDB</span> <span class="n">pdb</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">pdb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PartsDB</span><span class="o">(</span><span class="s">"parts.db"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pdb</span><span class="o">.</span><span class="na">numRecs</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Populate the database with records.</span>
                <span class="n">pdb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"1-9009-3323-4x"</span><span class="o">,</span> <span class="s">"Wiper Blade Micro Edge"</span><span class="o">,</span> <span class="mi">30</span><span class="o">,</span>
                        <span class="mi">2468</span><span class="o">);</span>
                <span class="n">pdb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"1-3233-44923-7j"</span><span class="o">,</span> <span class="s">"Parking Brake Cable"</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">1439</span><span class="o">);</span>
                <span class="n">pdb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"2-3399-6693-2m"</span><span class="o">,</span> <span class="s">"Halogen Bulb H4 55/60W"</span><span class="o">,</span> <span class="mi">22</span><span class="o">,</span> <span class="mi">813</span><span class="o">);</span>
                <span class="n">pdb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"2-599-2029-6k"</span><span class="o">,</span> <span class="s">"Turbo Oil Line O-Ring "</span><span class="o">,</span> <span class="mi">26</span><span class="o">,</span> <span class="mi">155</span><span class="o">);</span>
                <span class="n">pdb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"3-1299-3299-9u"</span><span class="o">,</span> <span class="s">"Air Pump Electric"</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="mi">20200</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">dumpRecords</span><span class="o">(</span><span class="n">pdb</span><span class="o">);</span>
            <span class="n">pdb</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"1-3233-44923-7j"</span><span class="o">,</span> <span class="s">"Parking Brake Cable"</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">1995</span><span class="o">);</span>
            <span class="n">dumpRecords</span><span class="o">(</span><span class="n">pdb</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ioe</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pdb</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">pdb</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">dumpRecords</span><span class="o">(</span><span class="nc">PartsDB</span> <span class="n">pdb</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdb</span><span class="o">.</span><span class="na">numRecs</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">PartsDB</span><span class="o">.</span><span class="na">Part</span> <span class="n">part</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">format</span><span class="o">(</span><span class="n">part</span><span class="o">.</span><span class="na">getPartnum</span><span class="o">(),</span> <span class="nc">PartsDB</span><span class="o">.</span><span class="na">PNUMLEN</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">" | "</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">format</span><span class="o">(</span><span class="n">part</span><span class="o">.</span><span class="na">getDesc</span><span class="o">(),</span> <span class="nc">PartsDB</span><span class="o">.</span><span class="na">DESCLEN</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">" | "</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">format</span><span class="o">(</span><span class="s">""</span> <span class="o">+</span> <span class="n">part</span><span class="o">.</span><span class="na">getQty</span><span class="o">(),</span> <span class="mi">10</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">" | "</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="na">getUnitCost</span><span class="o">()</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">part</span><span class="o">.</span><span class="na">getUnitCost</span><span class="o">()</span> <span class="o">%</span>
                    <span class="mi">100</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span> <span class="o">==</span> <span class="sc">'.'</span><span class="o">)</span> <span class="n">s</span> <span class="o">+=</span> <span class="s">"0"</span><span class="o">;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">format</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Number of records = "</span> <span class="o">+</span> <span class="n">pdb</span><span class="o">.</span><span class="na">numRecs</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="nc">String</span> <span class="nf">format</span><span class="o">(</span><span class="nc">String</span> <span class="n">value</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxWidth</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">leftAlign</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">maxWidth</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">len</span> <span class="o">=</span> <span class="n">maxWidth</span><span class="o">;</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">leftAlign</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxWidth</span> <span class="o">-</span> <span class="n">len</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxWidth</span> <span class="o">-</span> <span class="n">len</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">main()</code>æ–¹æ³•å…ˆå®ä¾‹åŒ–<code class="language-plaintext highlighter-rouge">PartsDB</code>ï¼Œä½¿ç”¨<code class="language-plaintext highlighter-rouge"> parts.db </code>ä½œä¸ºdatabase fileçš„nameã€‚å½“æ²¡è®°å½•,<code class="language-plaintext highlighter-rouge"> numRecs()  </code>è¿”å›0ã€‚ç„¶åé€šè¿‡<code class="language-plaintext highlighter-rouge">append()  </code>æ·»åŠ äº†å‡ ä¸ªrecordã€‚</p>

<p><code class="language-plaintext highlighter-rouge">main() </code>æ–¹æ³•ç„¶ådumpè¿™5ä¸ªè®°å½•åˆ°æ ‡å‡†è¾“å‡ºæµï¼Œæ›´æ–° numberæ˜¯1çš„recordçš„unit costï¼Œå†æ¬¡å°†è¿™äº›è®°å½•dumpåˆ°æ ‡å‡†è¾“å‡ºæµä¸­ä»¥æ˜¾ç¤ºï¼Œç„¶åå…³é—­ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šä½¿ç”¨åŸºäºintegerçš„ç¾åˆ†æ•°é‡å­˜å‚¨costå€¼ã€‚å¦‚æœè¦ç”¨<code class="language-plaintext highlighter-rouge">java.math.BigDecimal </code>å¯¹è±¡æ¥ä¿å­˜è´§å¸å€¼ï¼Œå¿…é¡»é‡æ„<code class="language-plaintext highlighter-rouge">PartsDB</code>ä»¥åˆ©ç”¨å¯¹è±¡åºåˆ—åŒ–çš„ä¼˜åŠ¿ï¼Œè¿˜æ²¡åšè¿™ä¸ªï¼ˆdiscuss object serialization in Chapter 4 ï¼‰ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">main()</code>ä¾èµ–<code class="language-plaintext highlighter-rouge">dumpRecords() </code> helperæ–¹æ³•æ¥dump recordsï¼Œ<code class="language-plaintext highlighter-rouge">dumpRecords()</code>ä¾èµ–<code class="language-plaintext highlighter-rouge">format()</code>helperæ–¹æ³•format fieldçš„å€¼ï¼Œå› æ­¤èƒ½åœ¨æ­£ç¡®å¯¹é½çš„åˆ—ä¸­æ˜¾ç¤ºã€‚æˆ‘å¯ä»¥ç”¨<code class="language-plaintext highlighter-rouge">java.util.Formatter </code>ä»£æ›¿ (see Chapter 11 )ã€‚</p>

<p>ç¼–è¯‘è¿è¡Œï¼Œè¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1-9009-3323-4x | Wiper Blade Micro Edge | 30 | 24.68
1-3233-44923-7j | Parking Brake Cable | 5 | 19.95
2-3399-6693-2m | Halogen Bulb H4 55/60W | 22 | 8.13
2-599-2029-6k | Turbo Oil Line O-Ring | 26 | 1.55
3-1299-3299-9u | Air Pump Electric | 9 | 202.00
Number of records = 5
1-9009-3323-4x | Wiper Blade Micro Edge | 30 | 24.68
1-3233-44923-7j | Parking Brake Cable | 5 | 19.95
2-3399-6693-2m | Halogen Bulb H4 55/60W | 22 | 8.13
2-599-2029-6k | Turbo Oil Line O-Ring | 26 | 1.55
3-1299-3299-9u | Air Pump Electric | 9 | 202.00
Number of records = 5
</code></pre></div></div>

<p><strong>Note</strong> ï¼šCheck out Wikipediaâ€™s â€œFlat file databaseâ€ entry (https://en.wikipedia.org/wiki/Flat_file_database) to learn more about flat file databases.</p>

<h4 id="exercise-1">exercise</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The following exercises are designed to test your understanding of Chapter 3â€™s content:
1. What is the purpose of the RandomAccessFile class?
2. What is a fileâ€™s metadata?
3. What is the purpose of the "rwd" and "rws" mode arguments?
4. What is a file pointer?
5. What happens when you write past the end of the file?
6. True or false: When you call RandomAccessFileâ€™s seek(long)
method to set the file pointerâ€™s value, and when this value is greater
than the length of the file, the fileâ€™s length changes.
7. What does method void write(int b) accomplish?
8. What does FileDescriptorâ€™s sync() method accomplish?
9. Define flat file database.
10. Write a small Java application named RAFDemo that opens file data in
read/write mode, uses void write(int b) to write byte value 127
followed by void writeChars(String s) to write string "Test"
(minus the quotes) to this file, resets the file pointer to the start of the
file, and read/outputs these values.
</code></pre></div></div>

<h4 id="summary-2">Summary</h4>

<h3 id="chapter-4-streams">Chapter 4 Streams</h3>

<p>è¿åŒ<code class="language-plaintext highlighter-rouge">java.io.File and java.io.RandomAccessFile</code>ï¼ŒJavaâ€™s classic I/Oä¹Ÿæä¾›äº† streamsç”¨äºæ–‡ä»¶æ“ä½œã€‚streamæ˜¯ä¸€ä¸ªæœ‰é¡ºåºçš„ä»»æ„é•¿åº¦çš„å­—èŠ‚çš„åºåˆ—ã€‚ å­—èŠ‚ä»åº”ç”¨åˆ°ç›®çš„åœ°æµè¿‡è¾“å‡ºæµï¼Œä»æºåˆ°åº”ç”¨æµè¿‡è¾“å…¥æµã€‚</p>

<h4 id="stream-classes-overview">Stream Classes Overview</h4>

<p>output streamç±»ç»“æ„å±‚æ¬¡å›¾ï¼š</p>

<p><img src="/assets/img/1532685952107.png" alt="1532685952107" /></p>

<p>input streamç±»ç»“æ„å±‚æ¬¡å›¾ï¼š</p>

<p><img src="/assets/img/1532686025994.png" alt="1532686025994" /></p>

<p><code class="language-plaintext highlighter-rouge">LineNumberInputStream and StringBufferInputStream </code>å·²è¢«å¼ƒç”¨ï¼Œå› ä¸ºä¸æ”¯æŒä¸åŒçš„å­—ç¬¦ç¼–ç ï¼Œ åœ¨Chapter 5 è®¨è®ºä»£æ›¿å®ƒä»¬çš„<code class="language-plaintext highlighter-rouge">java.io.LineNumberReader and java.io.StringReader </code>ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š<code class="language-plaintext highlighter-rouge">PrintStream</code>æ˜¯å¦ä¸€ä¸ªå› ä¸ºä¸æ”¯æŒä¸åŒç¼–ç è€Œåº”è¯¥è¢«å¼ƒç”¨çš„ç±»ï¼›<code class="language-plaintext highlighter-rouge">java.io.PrintWriter </code>æ˜¯æ›¿ä»£ã€‚ç„¶è€Œï¼ŒOracleå¼ƒç”¨è¿™ä¸ªç±»æ˜¯å­˜ç–‘çš„ï¼Œå› ä¸º<code class="language-plaintext highlighter-rouge">PrintStream </code>æ˜¯<code class="language-plaintext highlighter-rouge">java.lang.System classâ€™s out and err class fields </code>ç±»å‹ï¼Œè€Œä¸”å¤ªå¤šçš„é—ç•™ä»£ç ä¾èµ–äºå®ƒã€‚</p>

<p>å…¶ä»–JavaåŒ…æä¾›å¦å¤–çš„ output stream and input streamç±»ã€‚ä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge"> java.util.zip </code>æä¾›4ä¸ªè¾“å‡ºæµç±»å°†æœªå‹ç¼©çš„æ•°æ®å‹ç¼©æˆå„ç§æ ¼å¼ï¼Œä»¥åŠ4ä¸ªå¯¹åº”çš„è¾“å…¥æµä»ç›¸åŒçš„æ•°æ®æ ¼å¼ä¸­è§£å‹å‹ç¼©æ•°æ®ã€‚</p>

<ul>
  <li>CheckedOutputStream</li>
  <li>CheckedInputStream</li>
  <li>DeflaterOutputStream</li>
  <li>GZIPOutputStream</li>
  <li>GZIPInputStream</li>
  <li>InflaterInputStream</li>
  <li>ZipOutputStream</li>
  <li>ZipInputStream</li>
</ul>

<p>åŒæ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">java.util.jar </code>æä¾›ä¸€å¯¹æµç±»ç”¨äºå†™å†…å®¹åˆ°JARæ–‡ä»¶å’Œè¯»å–JARæ–‡ä»¶çš„å†…å®¹ï¼š</p>

<ul>
  <li>JarOutputStream</li>
  <li>JarInputStream</li>
</ul>

<h4 id="touring-the-stream-classes">Touring the Stream Classes</h4>

<p>ä¸‹é¢å¼€å§‹ java.ioâ€™s output stream and input stream classes çš„tourï¼Œä»OutputStream and InputStream å¼€å§‹ã€‚</p>

<h5 id="outputstream-and-inputstream">OutputStream and InputStream</h5>

<p>Javaæä¾›æŠ½è±¡çš„<code class="language-plaintext highlighter-rouge"> OutputStream and InputStream </code>ç±»æè¿°I/Oæµã€‚<code class="language-plaintext highlighter-rouge">OutputStream </code>æ˜¯æ‰€æœ‰output streamçš„è¶…ç±»ã€‚</p>

<p><strong><em>Table 4-1. OutputStream Methods</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>void close()</td>
      <td>å…³æµå’Œé‡Šæ”¾ä»»ä½•å’Œæµæœ‰å…³çš„æ“ä½œç³»ç»Ÿèµ„æºã€‚I/Oé”™è¯¯å‘ç”ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>void flush()</td>
      <td>æŠŠä»»ä½•ç¼“å†²çš„è¾“å‡ºå­—èŠ‚å†™åˆ°ç›®çš„åœ°æ¥åˆ·æ–°è¾“å‡ºæµã€‚å¦‚æœè¾“å‡ºæµçš„ç›®çš„åœ°æ˜¯åº•å±‚æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ä¸ªæŠ½è±¡ï¼ˆä¾‹å¦‚fileï¼‰ï¼Œåˆ·æ–°è¿™ä¸ªæµåªä¿è¯å…ˆå‰å†™å…¥æµçš„å­—èŠ‚è¢«ä¼ é€’ç»™åº•å±‚æ“ä½œç³»ç»Ÿç”¨äºwriteï¼›ä¸ä¿è¯ç¡®å®è¢«å†™å…¥ç‰©ç†è®¾å¤‡æ¯”å¦‚ä¸€ä¸ªç£ç›˜é©±åŠ¨å™¨ã€‚I/Oé”™è¯¯å‘ç”ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>void write(byte[] b)</td>
      <td>ä»å­—èŠ‚æ•°ç»„bå†™bä¸ªlengthå­—èŠ‚åˆ°è¾“å…¥æµã€‚é€šå¸¸  write(b) è¡¨ç°å¾—åƒä½ æŒ‡å®šäº† write(b, 0, b.length)ã€‚bæ˜¯nullæŠ›å‡º<code class="language-plaintext highlighter-rouge">  java.lang .NullPointerException </code>ï¼ŒI/Oé”™è¯¯å‘ç”ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException </code></td>
    </tr>
    <tr>
      <td>void write(byte[] b, int off, int len)</td>
      <td>ä»byteæ•°ç»„bçš„off offsetå¼€å§‹ï¼Œå†™lenä¸ªå­—èŠ‚åˆ°è¾“å…¥æµã€‚bæ˜¯nullæŠ›å‡º<code class="language-plaintext highlighter-rouge">  java.lang .NullPointerException </code>ï¼Œ<code class="language-plaintext highlighter-rouge"> IndexOutOfBoundsException  </code>å½“offæ˜¯è´Ÿï¼Œlenæ˜¯è´Ÿï¼Œæˆ–è€…off + bean&gt;b.lengthï¼›I/Oé”™è¯¯å‘ç”ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException </code></td>
    </tr>
    <tr>
      <td>void write(int b)</td>
      <td>å†™å­—èŠ‚båˆ°è¾“å…¥æµã€‚åªæœ‰8ä¸ª ow-order bitsè¢«å†™ï¼›24ä¸ª high-order bits è¢«å¿½ç•¥ã€‚I/Oé”™è¯¯å‘ç”ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException </code></td>
    </tr>
  </tbody>
</table>

<p>flush()  åœ¨é•¿æœŸè¿è¡Œçš„åº”ç”¨éœ€è¦ç»å¸¸ä¿æŒæ›´æ”¹çš„æ—¶å€™å¾ˆæœ‰ç”¨ã€‚è®°ä½flush() åªåˆ·æ–°å­—èŠ‚åˆ°æ“ä½œç³»ç»Ÿï¼›ä¸ä¸€å®šå¯¼è‡´æ“ä½œç³»ç»Ÿåˆ·æ–°å­—èŠ‚åˆ°ç£ç›˜ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š close() è‡ªåŠ¨åˆ·æ–°è¾“å‡ºæµï¼Œå¦‚æœåº”ç”¨åœ¨closeè¢«è°ƒç”¨å‰ç»“æŸï¼Œè¾“å…¥æµè‡ªåŠ¨å…³ç³»ï¼Œæ•°æ®è¢«åˆ·æ–°ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">InputStream </code>æ˜¯æ‰€æœ‰è¾“å…¥æµçš„è¶…ç±»ã€‚</p>

<p><strong><em>Table 4-2. InputStream Methods</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>int available()</td>
      <td>è¿”å›ä»è¾“å…¥æµè¯»å–çš„å­—èŠ‚æ•°é‡çš„ä¼°è®¡ï¼Œé€šè¿‡  read() æ–¹æ³•ï¼ˆæˆ– skipped over via skip() ï¼‰è°ƒç”¨è€Œä¸é˜»å¡è°ƒç”¨çº¿ç¨‹ã€‚I/Oé”™è¯¯å‘ç”ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException </code>ã€‚ç”¨å®ƒçš„è¿”å›å€¼æ¥åˆ†é…ä¸€ä¸ªç¼“å†²åŒºæ¥å­˜æ”¾æ‰€æœ‰æµçš„æ•°æ®æ˜¯ä¸æ­£ç¡®çš„ï¼Œå› ä¸ºå­ç±»çš„å®ç°å¯èƒ½ä¸ä¼šè¿”å›æµçš„æ€»å¤§å°ã€‚</td>
    </tr>
    <tr>
      <td>void close()</td>
      <td>å…³é—­è¾“å…¥æµå¹¶é‡Šæ”¾ä»»ä½•å’Œæµæœ‰å…³çš„æ“ä½œç³»ç»Ÿèµ„æºã€‚I/Oé”™è¯¯å‘ç”ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>void mark(int readlimit)</td>
      <td>åœ¨è¾“å…¥æµä¸­æ ‡è®°å½“å‰ä½ç½®ã€‚éšåè°ƒç”¨  reset()  ï¼Œå®šä½æµåˆ°æœ€åä¸€æ¬¡æ ‡è®°çš„ä½ç½®ï¼Œç„¶åéšåçš„è¯»æ“ä½œè¯»å–ç›¸åŒçš„å­—èŠ‚ã€‚ <code class="language-plaintext highlighter-rouge">readlimit </code>å‚æ•°å‘Šè¯‰è¾“å…¥æµåœ¨å¤±æ•ˆæ ‡è®°å‰ï¼Œå…è®¸è¯»å–å¤šå°‘å­—èŠ‚ï¼ˆå› æ­¤è¿™ä¸ªæµä¸èƒ½è¢«é‡ç½®åˆ°æ ‡è®°çš„ä½ç½® ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td>boolean markSupported()</td>
      <td>å½“è¿™ä¸ªè¾“å…¥æµæ”¯æŒ  mark() and reset() è¿”å›trueï¼›å¦åˆ™ï¼Œè¿”å›falseã€‚</td>
    </tr>
    <tr>
      <td>int read()</td>
      <td>è¯»å–è¿”å›ï¼ˆä½œä¸º0-255çš„ä¸€ä¸ªintå€¼ï¼‰è¾“å…¥æµçš„ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œåˆ°è¾¾æµç»ˆç‚¹è¿”å›-1ï¼›è¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°inputå¯ç”¨ï¼Œæµendè¢«æ£€æµ‹ï¼Œæˆ–æŠ›å‡ºå¼‚å¸¸ã€‚I/Oé”™è¯¯å‘ç”ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>int read(byte[] b)</td>
      <td>ä»è¿™ä¸ªè¾“å…¥æµè¯»ä¸€å®šæ•°ç›®çš„å­—èŠ‚ï¼ŒæŠŠä»–ä»¬å­˜åˆ°å­—èŠ‚æ•°ç»„bã€‚è¿”å›å®é™…è¯»å–çš„å­—èŠ‚æ•°ï¼ˆå¯èƒ½æ¯”bçš„lengthå°ä½†æ˜¯æ°¸è¿œä¸ä¼šè¶…è¿‡ï¼‰ï¼Œæˆ–è€…è¿”å›-1å½“åˆ°è¾¾æµendï¼ˆæ— å­—èŠ‚å¯è¯»ï¼‰ã€‚è¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°inputå¯ç”¨ï¼Œæµendè¢«æ£€æµ‹ï¼Œæˆ–æŠ›å‡ºå¼‚å¸¸ã€‚bæ˜¯nullæŠ›å‡ºç©ºæŒ‡é’ˆï¼ŒI/Oé”™è¯¯å‘ç”ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>int read(byte[] b, int off, int len)</td>
      <td>ä»è¾“å…¥æµè¯»ä¸è¶…è¿‡lenä¸ªå­—èŠ‚ï¼Œå­˜åœ¨array bï¼Œä»offå¼€å§‹ã€‚è¿”å›å®é™…è¯»å–çš„å­—èŠ‚æ•°ï¼ˆå¯èƒ½æ¯”bçš„lengthå°ä½†æ˜¯æ°¸è¿œä¸ä¼šè¶…è¿‡ï¼‰ï¼Œæˆ–è€…è¿”å›-1å½“åˆ°è¾¾æµendï¼ˆæ— å­—èŠ‚å¯è¯»ï¼‰ã€‚è¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°inputå¯ç”¨ï¼Œæµendè¢«æ£€æµ‹ï¼Œæˆ–æŠ›å‡ºå¼‚å¸¸ã€‚ã€‚bæ˜¯nullæŠ›å‡ºç©ºæŒ‡é’ˆï¼›offæ˜¯è´Ÿï¼Œlenæ˜¯è´Ÿï¼Œlenæ¯”b.length-offå¤§æŠ›å‡º<code class="language-plaintext highlighter-rouge"> IndexOutOfBoundsException </code>I/Oé”™è¯¯å‘ç”ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException </code>ã€‚</td>
    </tr>
    <tr>
      <td>void reset()</td>
      <td>é‡å®šä½è¾“å…¥æµåˆ°æœ€åä¸€æ¬¡ mark()çš„ä½ç½®ã€‚è¾“å…¥æµæ²¡è¢«æ ‡è®°æˆ–æ ‡è®°å¤±æ•ˆæŠ›å‡º<code class="language-plaintext highlighter-rouge">IOException</code>  ã€‚</td>
    </tr>
    <tr>
      <td>long skip(long n)</td>
      <td>è·³è¿‡å¹¶ä¸¢å¼ƒnå­—èŠ‚çš„æ•°æ®ã€‚è¿™ä¸ªæ–¹æ³•å¯èƒ½è·³è¿‡çš„æ•°é‡ä¼šå°ä¸€ç‚¹ï¼ˆå¯0ï¼‰ï¼Œä¾‹å¦‚ï¼Œfile endã€‚è¿”å›å®é™…çš„è·³è¿‡æ•°ã€‚næ˜¯è´Ÿï¼Œä¸è·³è¿‡ã€‚è¾“å…¥æµä¸æ”¯æŒskipæˆ–è€…I/Oé”™è¯¯æŠ›å‡º<code class="language-plaintext highlighter-rouge"> IOException </code></td>
    </tr>
  </tbody>
</table>

<p>å­ç±»ä¾‹å¦‚<code class="language-plaintext highlighter-rouge">ByteArrayInputStream</code>æ”¯æŒmark()æ ‡è®°å½“å‰ä½ç½®ï¼Œç„¶åresetè¿”å›ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šä¸è¦å¿˜äº†è°ƒç”¨<code class="language-plaintext highlighter-rouge">markSupported() </code>æ¥çœ‹æ˜¯ä¸æ˜¯æ”¯æŒmark() and reset()ã€‚</p>

<h5 id="bytearrayoutputstream-and-bytearrayinputstream">ByteArrayOutputStream and ByteArrayInputStream</h5>

<p>å­—èŠ‚æ•°ç»„åœ¨ä½œä¸ºæµç›®çš„åœ°å’Œæºæ—¶å¾ˆæœ‰ç”¨ã€‚<code class="language-plaintext highlighter-rouge">ByteArrayOutputStream </code>ç±»è®©ä½ å†™ä¸€ä¸ªå­—èŠ‚æµåˆ°å­—èŠ‚æ•°ç»„ï¼›<code class="language-plaintext highlighter-rouge">ByteArrayInputStream </code>è®©ä½ ä»å­—èŠ‚æ•°ç»„è¯»å–å­—èŠ‚æµã€‚</p>

<p><code class="language-plaintext highlighter-rouge">ByteArrayOutputStream </code>å£°æ˜2ä¸ªæ„é€ å™¨ã€‚æ¯ä¸ªæ„é€ å™¨ä½¿ç”¨å†…éƒ¨çš„å­—èŠ‚æ•°ç»„åˆ›å»º byte array output streamï¼›è¿™ä¸ªarrayçš„copyå¯ä»¥é€šè¿‡è°ƒç”¨<code class="language-plaintext highlighter-rouge"> byte[] toByteArray() </code>è¿”å›ï¼š</p>

<ul>
  <li>ByteArrayOutputStream() ä½¿ç”¨å†…éƒ¨çš„å­—èŠ‚æ•°ç»„åˆå§‹å®¹é‡æ˜¯32å­—èŠ‚ åˆ›å»ºä¸€ä¸ªbyte array output streamã€‚è¿™ä¸ªæ•°ç»„å¿…è¦æ—¶å¢é•¿ã€‚</li>
  <li>ByteArrayOutputStream(int size) ä½¿ç”¨æŒ‡å®šçš„é•¿åº¦åˆ›å»ºbyte array output streamã€‚ &lt;0æŠ›å‡º<code class="language-plaintext highlighter-rouge">java.lang.IllegalArgumentException </code>ã€‚</li>
</ul>

<p>ä¸‹é¢çš„ä¾‹å­ç”¨<code class="language-plaintext highlighter-rouge">ByteArrayOutputStream()  </code>åˆ›å»ºä¸€ä¸ªbyte array output streamï¼Œä½¿ç”¨é»˜è®¤sizeã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ByteArrayInputStream </code>ä¹Ÿæœ‰ä¸¤ä¸ªæ„é€ å™¨ã€‚æ¯ä¸ªæ„é€ å™¨åŸºäºæŒ‡å®šå­—èŠ‚æ•°ç»„åˆ›å»ºa byte array input stream</p>

<ul>
  <li>ByteArrayInputStream(byte[] ba) ä½¿ç”¨baæ•°ç»„åˆ›å»ºï¼ˆç›´æ¥ä½¿ç”¨ï¼›ä¸åˆ›å»ºcopyï¼‰ã€‚positionä¸º0ï¼Œè¦è¯»çš„å­—èŠ‚æ•°ä¸ºba.lengthã€‚</li>
  <li>ByteArrayInputStream(byte[] ba, int offset, int count)  positionæ˜¯offsetï¼Œè¯»å–countä¸ªå­—èŠ‚ã€‚</li>
</ul>

<p>ä¾‹å­ï¼Œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());
</code></pre></div></div>

<p>è¿™ä¸¤ä¸ªæµåœ¨ä½ éœ€è¦è½¬æ¢å›¾ç‰‡ä¸ºå­—èŠ‚æ•°ç»„ï¼Œç”¨æŸç§æ–¹æ³•å¤„ç†å­—èŠ‚ï¼Œç„¶åè½¬æ¢å­—èŠ‚æˆå›¾ç‰‡ã€‚</p>

<p>ä¸€ä¸ªä¾‹å­ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="o">...</span> <span class="o">;</span> <span class="c1">// Assume a legitimate path to an image.</span>
<span class="nc">Bitmap</span> <span class="n">bm</span> <span class="o">=</span> <span class="nc">BitmapFactory</span><span class="o">.</span><span class="na">decodeFile</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
<span class="nc">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">bm</span><span class="o">.</span><span class="na">compress</span><span class="o">(</span><span class="nc">Bitmap</span><span class="o">.</span><span class="na">CompressFormat</span><span class="o">.</span><span class="na">PNG</span><span class="o">,</span> <span class="mi">100</span><span class="o">,</span> <span class="n">baos</span><span class="o">))</span>
<span class="o">{</span>
 <span class="kt">byte</span><span class="o">[]</span> <span class="n">imageBytes</span> <span class="o">=</span> <span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
 <span class="c1">// Do something with imageBytes.</span>
 <span class="n">bm</span> <span class="o">=</span> <span class="nc">BitMapFactory</span><span class="o">.</span><span class="na">decodeStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">imageBytes</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="fileoutputstream-and-fileinputstream">FileOutputStream and FileInputStream</h5>

<p>æ–‡ä»¶æ˜¯å¸¸è§çš„æµç›®çš„åœ°å’Œæºã€‚</p>

<p>ä¸‹é¢ç”¨<code class="language-plaintext highlighter-rouge">FileOutputStream(String path)</code>åˆ›å»ºæ–‡ä»¶è¾“å‡ºæµã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="s">"employee.dat"</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>Tip</strong>ï¼šFileOutputStream(String name) é‡æ–°å­˜åœ¨çš„æ–‡ä»¶ã€‚è¦æ·»åŠ æ•°æ®è€Œä¸æ˜¯è¦†ç›–å­˜åœ¨çš„å†…å®¹ï¼Œè°ƒç”¨å¸¦æœ‰ boolean append çš„æ„é€ å™¨ï¼Œè®¾ç½®å‚æ•°ä¸ºtrueã€‚</p>

<p>ä¸‹é¢åˆ›å»ºä¸€ä¸ª FileInputStream(String name) çš„æ–‡ä»¶è¾“å…¥æµï¼Œemployee.datä¸ºsourceã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"employee.dat"</span><span class="o">);</span>
</code></pre></div></div>

<p>FileOutputStream and FileInputStream åœ¨æ–‡ä»¶å¤åˆ¶æœ‰ç”¨ã€‚</p>

<p><strong><em>Listing 4-1. Copying a Source File to a Destination File</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Copy</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"usage: java Copy srcfile dstfile"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
            <span class="kt">int</span> <span class="n">b</span><span class="o">;</span> <span class="c1">// I chose b instead of byte because byte is a reserved</span>
            <span class="c1">// word.</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">fis</span><span class="o">.</span><span class="na">read</span><span class="o">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>
                <span class="n">fos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FileNotFoundException</span> <span class="n">fnfe</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="s">" could not be opened for input, or "</span>
                    <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="s">" could not be created for output"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"I/O error: "</span> <span class="o">+</span> <span class="n">ioe</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fis</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">fis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// shouldn't happen in this context</span>
                <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fos</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">fos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// shouldn't happen in this context</span>
                <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä½¿ç”¨try-resource</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Copy1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"usage: java Copy srcfile dstfile"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
             <span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]))</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">b</span><span class="o">;</span> <span class="c1">// I chose b instead of byte because byte is a reserved</span>
            <span class="c1">// word.</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">fis</span><span class="o">.</span><span class="na">read</span><span class="o">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>
                <span class="n">fos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FileNotFoundException</span> <span class="n">fnfe</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="s">" could not be opened for input, or "</span>
                    <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="s">" could not be created for output"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"I/O error: "</span> <span class="o">+</span> <span class="n">ioe</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="pipedoutputstream-and-pipedinputstream">PipedOutputStream and PipedInputStream</h5>

<p>çº¿ç¨‹å¿…é¡»ç»å¸¸äº¤æµã€‚ä¸€ç§æ–¹æ³•æ˜¯å¼•å…¥å…±äº«å˜é‡ã€‚å¦ä¸€ç§æ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">PipedOutputStream and PipedInputStream </code>ç±»ä½¿ç”¨piped streamsï¼ˆç®¡é“æµï¼‰ã€‚<code class="language-plaintext highlighter-rouge">PipedOutputStream </code>ç±»è®©ä¸€ä¸ªsendingçº¿ç¨‹å†™ä¸€ä¸ªå­—èŠ‚æµåˆ°ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">PipedInputStream </code>ç±»çš„å®ä¾‹ï¼Œç„¶åä¸€ä¸ªreceivingçº¿ç¨‹è¯»å–è¿™äº›å­—èŠ‚ã€‚</p>

<p><strong>è­¦å‘Š</strong>:å°è¯•ä½¿ç”¨æ¥è‡ªä¸€ä¸ªsingle threadçš„ a<code class="language-plaintext highlighter-rouge">PipedOutputStream</code> object and a <code class="language-plaintext highlighter-rouge">PipedInputStream</code> object æ˜¯ä¸æ¨èçš„ï¼Œå¯èƒ½ä¼šæ­»é”ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">PipedOutputStream </code>å£°æ˜2ä¸ªæ„é€ å™¨ï¼š</p>

<ul>
  <li>PipedOutputStream() åˆ›å»ºä¸€ä¸ª piped output stream ï¼Œè¿˜æ²¡æœ‰è¿æ¥åˆ° a piped input stream ã€‚åœ¨ä½¿ç”¨å‰ï¼Œå®ƒå¿…é¡»è¢«è¿æ¥åˆ°ä¸€ä¸ª piped input stream ï¼Œæ— è®ºä½¿ç”¨receiver or the sender ã€‚</li>
  <li>PipedOutputStream(PipedInputStream dest) åˆ›å»ºpiped output stream è¿æ¥åˆ°piped input stream dest ã€‚å†™åˆ°piped output streamçš„å­—èŠ‚å¯ä»¥ä»destè¯»å‡ºæ¥ã€‚I/Oé”™è¯¯æŠ›å‡º<code class="language-plaintext highlighter-rouge">IOException</code>ã€‚</li>
</ul>

<p>connect(PipedInputStream dest)æ–¹æ³•ï¼Œç”¨äºè¿æ¥ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">PipedInputStream </code>2ä¸ªæ„é€ å™¨ï¼š</p>

<ul>
  <li>PipedInputStream()  ç”¨å‰å¿…é¡»è¿æ¥ã€‚</li>
  <li>PipedInputStream(int pipeSize) ä½¿ç”¨pipeSizeæŒ‡å®šç®¡é“å¤§å°ã€‚ç”¨å‰å¿…é¡»è¿æ¥ã€‚</li>
  <li>PipedInputStream(PipedOutputStream src)</li>
  <li>PipedInputStream(PipedOutputStream src, int pipeSize)</li>
</ul>

<p>connect(PipedOutputStream src) æ–¹æ³•ç”¨äºè¿æ¥ã€‚</p>

<p>åˆ›å»ºä¸€å¯¹ç®¡é“æµçš„æœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ä»»æ„é¡ºåºã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">PipedOutputStream</span> <span class="n">pos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PipedOutputStream</span><span class="o">();</span>
<span class="nc">PipedInputStream</span> <span class="n">pis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PipedInputStream</span><span class="o">(</span><span class="n">pos</span><span class="o">);</span>
</code></pre></div></div>

<p>æˆ–è€…ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">PipedInputStream</span> <span class="n">pis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PipedInputStream</span><span class="o">();</span>
<span class="nc">PipedOutputStream</span> <span class="n">pos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PipedOutputStream</span><span class="o">(</span><span class="n">pis</span><span class="o">);</span>
</code></pre></div></div>

<p>ä¹Ÿå¯ä»¥:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">PipedOutputStream</span> <span class="n">pos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PipedOutputStream</span><span class="o">();</span>
<span class="nc">PipedInputStream</span> <span class="n">pis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PipedInputStream</span><span class="o">();</span>
<span class="c1">// ...</span>
<span class="n">pos</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">pis</span><span class="o">);</span>
</code></pre></div></div>

<p>å®ä¾‹ï¼š</p>

<p><strong><em>Listing 4-3. Piping Randomly Generated Bytes from a Sender Thread to a Receiver Thread</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.PipedInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.PipedOutputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PipedStreamsDemo</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">LIMIT</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">PipedOutputStream</span> <span class="n">pos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PipedOutputStream</span><span class="o">();</span>
        <span class="kd">final</span> <span class="nc">PipedInputStream</span> <span class="n">pis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PipedInputStream</span><span class="o">(</span><span class="n">pos</span><span class="o">);</span>
        <span class="nc">Runnable</span> <span class="n">senderTask</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">LIMIT</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                    <span class="n">pos</span><span class="o">.</span><span class="na">write</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span>
                            <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">*</span> <span class="mi">256</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">pos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="nc">Runnable</span> <span class="n">receiverTask</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">b</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">pis</span><span class="o">.</span><span class="na">read</span><span class="o">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">pis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="nc">Thread</span> <span class="n">sender</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">senderTask</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">receiver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">receiverTask</span><span class="o">);</span>
        <span class="n">sender</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">receiver</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="filteroutputstream-and-filterinputstream">FilterOutputStream and FilterInputStream</h5>

<p>Byte array, file, and piped streamsä¼ é€’æ²¡æœ‰å˜åŠ¨è¿‡çš„å­—èŠ‚ç»™ç›®æ ‡ã€‚ä¹Ÿæ”¯æŒ filter streamsæ¥buffer, compress/ uncompress, encrypt/decrypt, or otherwise manipulate a streamâ€™s byte sequence (that is input to the filter) ã€‚</p>

<p>ä¸€ä¸ªfilter output streamæ‹¿åˆ°ä¼ é€’ç»™ write()æ–¹æ³•çš„æ•°æ®ï¼ˆ(the input stream ï¼‰ï¼Œè¿‡æ»¤ï¼Œå†™è¿‡æ»¤è¿‡çš„æ•°æ®åˆ°ä¸‹é¢çš„output streamï¼Œå¯èƒ½æ˜¯ another filter output stream or a destination output stream such as a file output streamã€‚</p>

<p>Filter output streamsç”¨<code class="language-plaintext highlighter-rouge">OutputStream </code>å­ç±»<code class="language-plaintext highlighter-rouge">FilterOutputStream </code>åˆ›å»ºï¼Œå•ä¸ªæ„é€ å™¨<code class="language-plaintext highlighter-rouge">FilterOutputStream(OutputStream out) </code>ã€‚ç¤ºä¾‹ï¼š</p>

<p><strong><em>Listing 4-4. Scrambling a Stream of Bytes</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.FilterOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ScrambledOutputStream</span> <span class="kd">extends</span> <span class="nc">FilterOutputStream</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">map</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ScrambledOutputStream</span><span class="o">(</span><span class="nc">OutputStream</span> <span class="n">out</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">"map is null"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">256</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"map.length != 256"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">map</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">map</span><span class="o">[</span><span class="n">b</span><span class="o">]);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>4-5æ‰“ä¹±æ–‡ä»¶å­—èŠ‚ï¼š</p>

<p><strong><em>Listing 4-5. Scrambling a Fileâ€™s Bytes</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Scramble</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"usage: java Scramble srcpath destpath"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">ScrambledOutputStream</span> <span class="n">sos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
            <span class="n">sos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ScrambledOutputStream</span><span class="o">(</span><span class="n">fos</span><span class="o">,</span> <span class="n">makeMap</span><span class="o">());</span>
            <span class="kt">int</span> <span class="n">b</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">fis</span><span class="o">.</span><span class="na">read</span><span class="o">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>
                <span class="n">sos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fis</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">fis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sos</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">sos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kt">int</span><span class="o">[]</span> <span class="nf">makeMap</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">256</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="n">map</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
        <span class="c1">// Shuffle map.</span>
        <span class="nc">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">map</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="n">map</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">map</span><span class="o">[</span><span class="n">n</span><span class="o">];</span>
            <span class="n">map</span><span class="o">[</span><span class="n">n</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Filter input streamsï¼Œç¤ºä¾‹ï¼š</p>

<p><strong><em>Listing 4-6. Unscrambling a Stream of Bytes</em></strong></p>

<p>ä½¿ç”¨ScrambledInputStream è§£å¯†ï¼š</p>

<p><strong><em>Listing 4-7. Unscrambling a Fileâ€™s Bytes</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Unscramble</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"usage: java Unscramble srcpath destpath"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">ScrambledInputStream</span> <span class="n">sis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="n">sis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ScrambledInputStream</span><span class="o">(</span><span class="n">fis</span><span class="o">,</span> <span class="n">makeMap</span><span class="o">());</span>
            <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
            <span class="kt">int</span> <span class="n">b</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">sis</span><span class="o">.</span><span class="na">read</span><span class="o">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>
                <span class="n">fos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sis</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">sis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fos</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">fos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kt">int</span><span class="o">[]</span> <span class="nf">makeMap</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">256</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="n">map</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
        <span class="c1">// Shuffle map.</span>
        <span class="nc">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">map</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="n">map</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">map</span><span class="o">[</span><span class="n">n</span><span class="o">];</span>
            <span class="n">map</span><span class="o">[</span><span class="n">n</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">temp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">256</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">temp</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="n">temp</span><span class="o">[</span><span class="n">map</span><span class="o">[</span><span class="n">i</span><span class="o">]]</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">temp</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="bufferedoutputstream-and-bufferedinputstream">BufferedOutputStream and BufferedInputStream</h5>

<p>FileOutputStreamå’ŒFileInputStreamæœ‰ä¸€ä¸ªæ€§èƒ½é—®é¢˜ã€‚ æ¯ä¸ª file output stream write() æ–¹æ³•è°ƒç”¨å’Œ file input stream read() æ–¹æ³•è°ƒç”¨å¯¼è‡´ a native methodè°ƒç”¨æ“ä½œç³»ç»Ÿç¨‹å¼ï¼Œè¿™äº›native methodså‡ç¼“äº†I/Oã€‚</p>

<p><code class="language-plaintext highlighter-rouge">BufferedOutputStream</code> and <code class="language-plaintext highlighter-rouge">BufferedInputStream</code> filter streamç±»æé«˜äº†æ€§èƒ½ï¼Œé€šè¿‡æœ€å°åŒ–åº•å±‚çš„output stream write() è°ƒç”¨å’Œ input stream read() æ–¹æ³•è°ƒç”¨ã€‚ä½¿ç”¨<code class="language-plaintext highlighter-rouge">BufferedOutputStream</code>â€™s write() and <code class="language-plaintext highlighter-rouge">BufferedInputStream</code>â€™s read() ä»£æ›¿ï¼Œå°†Javaç¼“å†²åŒºè€ƒè™‘è¿›å»ï¼š</p>

<ul>
  <li>å½“write bufferæ»¡äº†ï¼Œwrite() è°ƒç”¨åº•å±‚çš„output stream write()æ–¹æ³•æ¥æ’ç©ºbufferã€‚éšåè°ƒç”¨<code class="language-plaintext highlighter-rouge">BufferedOutputStream</code>çš„write()æ–¹æ³•å°†å­—èŠ‚ä¿å­˜åœ¨è¿™ä¸ªç¼“å†²åŒºä¸­ï¼Œç›´åˆ°å®ƒå†æ¬¡æ»¡ä¸ºæ­¢ã€‚</li>
  <li>å½“ read bufferæ˜¯ç©ºçš„ï¼Œ read() è°ƒç”¨åº•å±‚çš„ input stream read() æ–¹æ³•æ¥å……æ»¡bufferã€‚éšåè°ƒç”¨ <code class="language-plaintext highlighter-rouge">BufferedInputStream</code>â€™s read() ä»è¯¥bufferè¿”å›å­—èŠ‚ç›´åˆ°å®ƒå†æ¬¡ä¸ºç©ºã€‚</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">BufferedOutputStream</code>ä»¥ä¸‹æ„é€ å™¨</p>

<ul>
  <li>BufferedOutputStream(OutputStream out) åˆ›å»ºä¸€ä¸ªbuffered output streamæŠŠè¾“å‡ºæµåˆ°outã€‚ä¸€ä¸ªå†…éƒ¨çš„bufferè¢«åˆ›å»ºç”¨æ¥ä¿å­˜å†™å‡ºçš„å­—èŠ‚ã€‚</li>
  <li>BufferedOutputStream(OutputStream out, int size) æŒ‡å®šäº†é•¿åº¦ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="s">"employee.dat"</span><span class="o">);</span>
<span class="nc">BufferedOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedOutputStream</span><span class="o">(</span><span class="n">fos</span><span class="o">);</span> <span class="c1">// Chain bos</span>
<span class="c1">// to fos.</span>
<span class="n">bos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">// Write to employee.dat through the buffer.</span>
<span class="c1">// Additional write() method calls.</span>
<span class="n">bos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="c1">// This method call internally calls fos's close() method.</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">BufferedInputStream </code>æœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼š</p>

<ul>
  <li>BufferedInputStream(InputStream in)</li>
  <li>BufferedInputStream(InputStream in, int size)</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"employee.dat"</span><span class="o">);</span>
<span class="nc">BufferedInputStream</span> <span class="n">bis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">fis</span><span class="o">);</span> <span class="c1">// Chain bis to fis.</span>
<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">bis</span><span class="o">.</span><span class="na">read</span><span class="o">();</span> <span class="c1">// Read employee.dat through the buffer.</span>
<span class="c1">// Additional read() method calls.</span>
<span class="n">bis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="c1">// This method call internally calls fis's close() method.</span>
</code></pre></div></div>

<h5 id="dataoutputstream-and-datainputstream">DataOutputStream and DataInputStream</h5>

<p><code class="language-plaintext highlighter-rouge">FileOutputStream and FileInputStream </code>å¯¹è¯»å–å­—èŠ‚å’Œå­—èŠ‚æ•°ç»„å¾ˆæœ‰ç”¨ã€‚ç„¶è€Œï¼Œä¸æ”¯æŒè¯»å†™primitive-typeçš„å€¼ï¼ˆæ¯”å¦‚integerï¼‰å’Œstringsã€‚</p>

<p>äºæ˜¯Javaæä¾›äº† DataOutputStream and DataInputStream filter stream ç±»ã€‚å…‹æœäº†è¿™ä¸ªé™åˆ¶ï¼Œæä¾›æ–¹æ³•è¯»å†™primitive-typeå’Œstringsï¼Œç”¨ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„æ–¹å¼ï¼š</p>

<ul>
  <li>Integer valuesæ˜¯ç”¨ big-endian å½¢å¼è¯»å†™ã€‚</li>
  <li>Floating-point and double precision floating-point  æ ¹æ® IEEE 754 æ ‡å‡†è¯»å†™ï¼Œæ¯ä¸ªfloatingpoint value 4 å­—èŠ‚ï¼Œæ¯ä¸ªdouble precision floating-point value8å­—èŠ‚ã€‚</li>
  <li>Stringsæ ¹æ®ä¿®æ”¹çš„UTF-8 ç‰ˆæœ¬è¯»å†™ï¼Œä¸€ä¸ªå¯å˜é•¿åº¦ç¼–ç æ ‡å‡†æœ‰æ•ˆä¿å­˜2å­—èŠ‚ Unicode characters ã€‚</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">DataOutputStream </code>æœ‰ä¸€ä¸ªæ„é€ å™¨ï¼ŒDataOutputStream(OutputStream out) ã€‚å› ä¸ºå®ç°äº†<code class="language-plaintext highlighter-rouge">java.io.DataOutput </code>ï¼Œ<code class="language-plaintext highlighter-rouge">DataOutputStream </code>ä¹Ÿæä¾›äº†åˆ°<code class="language-plaintext highlighter-rouge"> java.io.RandomAccessFile </code>æä¾›çš„ç›¸åŒå‘½åçš„å†™æ–¹æ³•çš„è®¿é—®ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">DataInputStream </code>ä¸€ä¸ªæ„é€ å™¨ï¼ŒDataInputStream(InputStream in) ã€‚å› ä¸ºå®ç°äº†<code class="language-plaintext highlighter-rouge"> java.io.DataInput </code>ï¼Œ<code class="language-plaintext highlighter-rouge">DataInputStream </code>ä¹Ÿæä¾›<code class="language-plaintext highlighter-rouge"> java.io.RandomAccessFile </code>çš„ç›¸åŒå‘½åçš„è¯»æ–¹æ³•çš„è®¿é—®ã€‚</p>

<p>ä¾‹å­ï¼š</p>

<p><strong><em>Listing 4-8. Outputting and then Inputting a Stream of Multibyte Values</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.DataInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.DataOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataStreamsDemo</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">FILENAME</span> <span class="o">=</span> <span class="s">"values.dat"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="no">FILENAME</span><span class="o">);</span>
             <span class="nc">DataOutputStream</span> <span class="n">dos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataOutputStream</span><span class="o">(</span><span class="n">fos</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">dos</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">1995</span><span class="o">);</span>
            <span class="n">dos</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="s">"Saving this String in modified UTF-8 format!"</span><span class="o">);</span>
            <span class="n">dos</span><span class="o">.</span><span class="na">writeFloat</span><span class="o">(</span><span class="mf">1.0</span><span class="no">F</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"I/O error: "</span> <span class="o">+</span> <span class="n">ioe</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="no">FILENAME</span><span class="o">);</span>
             <span class="nc">DataInputStream</span> <span class="n">dis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataInputStream</span><span class="o">(</span><span class="n">fis</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dis</span><span class="o">.</span><span class="na">readInt</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dis</span><span class="o">.</span><span class="na">readUTF</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dis</span><span class="o">.</span><span class="na">readFloat</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"I/O error: "</span> <span class="o">+</span> <span class="n">ioe</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>è­¦å‘Š</strong>ï¼šå½“è¯»ä¸€ä¸ªåºåˆ—<code class="language-plaintext highlighter-rouge">DataOutputStream</code>çš„æ–¹æ³•å†™å…¥çš„å€¼ï¼Œç¡®ä¿ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•è°ƒç”¨åºåˆ—ã€‚å¦åˆ™å¾—åˆ°é”™è¯¯çš„æ•°æ®ã€‚</p>

<h4 id="object-serialization-and-deserialization">Object Serialization and Deserialization</h4>

<p>Javaæä¾›<code class="language-plaintext highlighter-rouge">DataOutputStream and DataInputStream classes </code>æ¥æµåŒ– primitive-type values and String objectsã€‚ä½†ä½ ä¸èƒ½streaméstringå¯¹è±¡ã€‚ä½ å¿…é¡»ç”¨<code class="language-plaintext highlighter-rouge">object serialization and deserialization </code>æ¥streamä»»æ„ç±»å‹å¯¹è±¡ã€‚</p>

<p>å¯¹è±¡<em>serialization</em>æ˜¯ä¸€ä¸ªJVMæœºåˆ¶ï¼Œåºåˆ—åŒ–å¯¹è±¡çŠ¶æ€å˜æˆä¸€ä¸ªå­—èŠ‚æµã€‚å¯¹åº”çš„ <em>deserialization</em> æ˜¯ç›¸åçš„ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šå¯¹è±¡stateç”±å®ä¾‹fieldsç»„æˆï¼Œä¿å­˜äº†åŸå§‹ç±»å‹å€¼å’Œå…¶ä»–å¯¹è±¡çš„å¼•ç”¨ã€‚å½“ä¸€ä¸ªå¯¹è±¡åºåˆ—åŒ–ï¼Œæ˜¯è¿™ä¸ªstateä¸€éƒ¨åˆ†çš„å¯¹è±¡ä¹Ÿä¼šå®ä¾‹åŒ–ï¼ˆé™¤éä½ é˜»æ­¢ï¼‰ã€‚å¦å¤–ï¼Œè¿™äº›å¯¹è±¡çš„éƒ¨åˆ†æ˜¯å¯¹è±¡çš„è¯ä¹Ÿä¸€æ ·å®ä¾‹åŒ–ã€‚</p>

<p>Javaæ”¯æŒé»˜è®¤ serialization and deserializationï¼Œè‡ªå®šä¹‰ serialization and deserialization å’Œexternalization ã€‚</p>

<h5 id="default-serialization-and-deserialization">Default Serialization and Deserialization</h5>

<p>é»˜è®¤çš„æ˜¯æœ€ç®€å•çš„æ–¹å¼ä½†æ˜¯æä¾›å¾ˆå°‘çš„controlã€‚è™½ç„¶Javaä»£ä½ åšäº†å¤§éƒ¨åˆ†äº‹æƒ…ï¼Œä½†æ˜¯ä½ ä¹Ÿè¦2ä¸ªä»»åŠ¡å¿…é¡»åšã€‚</p>

<p>ç¬¬ä¸€ä¸ªä»»åŠ¡è¦è¢«åºåˆ—åŒ–çš„ç±»è¦å®ç°<code class="language-plaintext highlighter-rouge">java.io.Serializable </code>æ¥å£ï¼Œå®ç°çš„åŸå› æ˜¯é¿å…æ— é™åºåˆ—åŒ–ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š<code class="language-plaintext highlighter-rouge">Serializable </code>æ˜¯ä¸€ä¸ªç©ºçš„æ ‡è®°æ¥å£ï¼ˆæ²¡æœ‰æ–¹æ³•æ¥å®ç°ï¼‰ï¼Œå‘Šè¯‰JVMåºåˆ—åŒ–æ˜¯okayçš„ã€‚å½“åºåˆ—åŒ–æœºåˆ¶é­é‡æ²¡æœ‰å®ç°è¿™ä¸ªæ¥å£çš„å¯¹è±¡ï¼ŒæŠ›å‡º<code class="language-plaintext highlighter-rouge">java.io.NotSerializableException </code>ï¼ˆä¸€ä¸ª<code class="language-plaintext highlighter-rouge">IOException</code>çš„éç›´æ¥å­ç±»ï¼‰ã€‚</p>

<p><em>Unlimited serialization</em>æ˜¯åºåˆ—åŒ–æ•´ä¸ªobject graphçš„è¿‡ç¨‹ã€‚ä¸æ”¯æŒå®ƒçš„åŸå› ï¼š</p>

<ul>
  <li>Security:</li>
  <li>Performance: åºåˆ—åŒ–åˆ©ç”¨äº†åå°„APIï¼Œä¼šé™ä½åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚æ— é™åºåˆ—åŒ–å¯èƒ½ä¼šæŸå®³åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚</li>
  <li>Objects not amenable to serialization:</li>
</ul>

<p>ä¸‹é¢ä¸€ä¸ªä¾‹å­ï¼š</p>

<p><strong><em>Listing 4-9. Implementing Serializable</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="kd">implements</span> <span class="nc">Serializable</span>
<span class="o">{</span>
 <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
 <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
 <span class="kd">public</span> <span class="nf">Employee</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
 <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
 <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">age</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">java.lang.String</code>ä¹Ÿå®ç°äº†Serializableã€‚</p>

<p>ç¬¬äºŒä¸ªä»»åŠ¡æ˜¯ç”¨<code class="language-plaintext highlighter-rouge">ObjectOutputStream </code>ç±»ï¼Œå’Œå®ƒçš„<code class="language-plaintext highlighter-rouge">writeObject() </code>æ–¹æ³•æ¥åºåˆ—åŒ–ï¼Œ<code class="language-plaintext highlighter-rouge">ObjectInputStream </code>çš„<code class="language-plaintext highlighter-rouge">readObject() </code>æ–¹æ³•ååºåˆ—åŒ–ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šè™½ç„¶æ²¡ç»§æ‰¿ FilterOutputStream å’Œ FilterInputStream ï¼Œä¸Šé¢é‚£2ä¸ªåºåˆ—åŒ–çš„ç±»ä¹Ÿè¡¨ç°å¦‚åŒfilter streams ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">ObjectOutputStream</code>åºåˆ—åŒ–å¯¹è±¡stateï¼Œæ„é€ å™¨<code class="language-plaintext highlighter-rouge"> ObjectOutputStream(OutputStream out)ï¼Œ </code>å½“ä¼ é€’output stream referenceåˆ°outï¼Œæ„é€ å™¨å°è¯•å†™ä¸€ä¸ª serialization header åˆ°è¾“å‡ºæµã€‚outæ˜¯nullæŠ›å¼‚å¸¸é˜»æ­¢å†™å…¥headerã€‚</p>

<p><code class="language-plaintext highlighter-rouge">writeObject(Object obj) </code>æ–¹æ³•å°è¯•å†™å…³äºå¯¹è±¡ç±»çš„ä¿¡æ¯ï¼Œç´§æ¥ç€å†™å¯¹è±¡å®ä¾‹fieldçš„å€¼ã€‚ä¸ä¼šåºåˆ—åŒ–static fieldï¼Œå’Œ transient æ ‡æ³¨çš„fieldï¼ˆå¿½ç•¥ï¼‰ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š<code class="language-plaintext highlighter-rouge">ObjectOutputStream</code> implements <code class="language-plaintext highlighter-rouge">DataOutput </code>ï¼Œæä¾›äº†å†™primitive-type values and stringsåˆ°å¯¹è±¡è¾“å‡ºæµçš„æ–¹æ³•ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">ObjectInputStream  </code>ç±»ååºåˆ—åŒ–ã€‚<code class="language-plaintext highlighter-rouge">ObjectInputStream(InputStream in) </code>æ„é€ å™¨ã€‚å½“ä¼ é€’ input stream reference åˆ°inï¼Œå°è¯•ä»è¾“å…¥æµè¯»å–serialization header ï¼ŒæŠ›å‡ºç©ºæŒ‡é’ˆ IOå¼‚å¸¸ï¼Œå¦‚æœheaderä¸å¯¹å°±æŠ›å‡º<code class="language-plaintext highlighter-rouge">java.io.StreamCorruptedException </code>ã€‚</p>

<p><code class="language-plaintext highlighter-rouge"> readObject() </code>æ–¹æ³•ååºåˆ—åŒ–å¯¹è±¡ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šç±»ä¼¼ä¸Šä¸€ä¸ªã€‚</p>

<p>ä¾‹å­ï¼š</p>

<p><strong><em>Listing 4-10. Serializing and Deserializing an Employee Object</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SerializationDemo</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">FILENAME</span> <span class="o">=</span> <span class="s">"employee.dat"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="no">FILENAME</span><span class="o">);</span>
            <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="n">fos</span><span class="o">);</span>
            <span class="nc">Employee</span> <span class="n">emp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Employee</span><span class="o">(</span><span class="s">"John Doe"</span><span class="o">,</span> <span class="mi">36</span><span class="o">);</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">emp</span><span class="o">);</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">oos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="no">FILENAME</span><span class="o">);</span>
            <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="n">fis</span><span class="o">);</span>
            <span class="n">emp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Employee</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span> <span class="c1">// (Employee) cast is necessary.</span>
            <span class="n">ois</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">cnfe</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">cnfe</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ioe</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">oos</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// shouldn't happen in this context</span>
                <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ois</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">ois</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// shouldn't happen in this context</span>
                <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>ååºåˆ—åŒ–åä¸èƒ½ä¸ä¿è¯æ˜¯åŒä¸€ä¸ªç±»ï¼ˆå¯èƒ½ä¸€ä¸ªå®ä¾‹fieldè¢«åˆ é™¤äº†ï¼‰ã€‚å½“ç±»ä¸åŒæŠ›å‡º<code class="language-plaintext highlighter-rouge">java.io.InvalidClassException </code>ã€‚</p>

<p>æ¯ä¸ªåºåˆ—åŒ–çš„å¯¹è±¡æœ‰ä¸€ä¸ªæ ‡è¯†ç¬¦ã€‚æ ‡è¯†ç¬¦ä¸åŒ¹é…æŠ›å‡º<code class="language-plaintext highlighter-rouge">InvalidClassException </code>ã€‚</p>

<p>ä¹Ÿè®¸æ‚¨å·²ç»åœ¨ç±»ä¸­æ·»åŠ äº†ä¸€ä¸ªå®ä¾‹å­—æ®µï¼Œä½ æƒ³è®©è¿™ä¸ªfieldæœ‰é»˜è®¤å€¼è€Œä¸æ˜¯æŠ›å‡º<code class="language-plaintext highlighter-rouge"> InvalidClassException </code>ï¼Œé€šè¿‡æ·»åŠ static final long serialVersionUID = long integer valueåˆ°classã€‚long integer value å¿…é¡»æ˜¯å”¯ä¸€çš„ä½œä¸ºä¸€ä¸ªstream unique identifier (SUID)ã€‚</p>

<p>ååºåˆ—åŒ–æ—¶ï¼Œä¼šæ¯”è¾ƒSUIDï¼Œå¦‚æœåŒ¹é…ï¼Œå½“é­é‡å…¼å®¹çš„class  changeä¸ä¼šæŠ›å‡º<code class="language-plaintext highlighter-rouge">InvalidClassException </code>ï¼ˆæ¯”å¦‚æ·»åŠ å®ä¾‹fieldï¼‰ã€‚ä½†æ˜¯ä¸å…¼å®¹çš„classå˜æ›´è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼ˆæ¯”å¦‚ä¿®æ”¹field nameï¼‰ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šå½“ä½ ä»¥æŸç§æ–¹å¼æ”¹å˜ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¿…é¡»é‡æ–°è®¡ç®—SUIDã€‚</p>

<p>JDKæä¾›serialver tool æ¥ç”Ÿæˆ SUIDã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">serialver</span> <span class="nc">Employee</span>
</code></pre></div></div>

<p>ç”Ÿæˆï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">Employee:</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1517331364702470316L</span><span class="o">;</span>
</code></pre></div></div>

<p>windowså¯è§†åŒ–ç•Œé¢ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">serialver</span> <span class="o">-</span><span class="n">show</span>
</code></pre></div></div>

<h5 id="custom-serialization-and-deserialization">Custom Serialization and Deserialization</h5>

<p>å¦‚æœä½ è¦åºåˆ—åŒ–æ²¡å®ç°<code class="language-plaintext highlighter-rouge">Serializable </code>çš„ç±»ï¼Œä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œç»§æ‰¿è¿™ä¸ªç±»ï¼Œè®©å­ç±»å®ç°<code class="language-plaintext highlighter-rouge"> Serializable </code>ï¼Œå­ç±»æ„é€ å™¨å‘¼å«çˆ¶ç±»ã€‚</p>

<p>å½“çˆ¶ç±»æ²¡å£°æ˜æ— å‚æ„é€ æ˜¯ä¸è¡Œçš„ã€‚ä¾‹å­ï¼š</p>

<p><strong><em>Listing 4-11. Problematic Deserialization</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee1</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nc">Employee1</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SerEmployee</span> <span class="kd">extends</span> <span class="nc">Employee1</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
    <span class="nc">SerEmployee</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SerializationDemo</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">PATH</span> <span class="o">=</span> <span class="s">"E:\\SpringSourceCode\\src\\main\\resources\\image.txt"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="no">PATH</span><span class="o">));</span>
            <span class="nc">SerEmployee</span> <span class="n">se</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SerEmployee</span><span class="o">(</span><span class="s">"John Doe"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">se</span><span class="o">);</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">se</span><span class="o">);</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">oos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"se object written to file"</span><span class="o">);</span>
            <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="no">PATH</span><span class="o">));</span>
            <span class="n">se</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SerEmployee</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"se object read from file"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">se</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">cnfe</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">cnfe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">oos</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// shouldn't happen in this context</span>
                <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ois</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">ois</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// shouldn't happen in this context</span>
                <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">John</span> <span class="nc">Doe</span>
<span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InvalidClassException</span><span class="o">:</span> <span class="n">com</span><span class="o">.</span><span class="na">jasu</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">_04_Streams</span><span class="o">.</span><span class="na">SerEmployee</span><span class="o">;</span> <span class="n">no</span> <span class="n">valid</span> <span class="n">constructor</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectStreamClass</span><span class="n">$ExceptionInfo</span><span class="o">.</span><span class="na">newInvalidClassException</span><span class="o">(</span><span class="nc">ObjectStreamClass</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">157</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectStreamClass</span><span class="o">.</span><span class="na">checkDeserialize</span><span class="o">(</span><span class="nc">ObjectStreamClass</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">862</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span><span class="o">.</span><span class="na">readOrdinaryObject</span><span class="o">(</span><span class="nc">ObjectInputStream</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">2034</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span><span class="o">.</span><span class="na">readObject0</span><span class="o">(</span><span class="nc">ObjectInputStream</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1567</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">(</span><span class="nc">ObjectInputStream</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">427</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">jasu</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">_04_Streams</span><span class="o">.</span><span class="na">SerializationDemo</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="nc">SerializationDemo</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">31</span><span class="o">)</span>
</code></pre></div></div>

<p>å› ä¸ºEmployee1 æ²¡æœ‰å£°æ˜æ— å‚æ„é€ å™¨ã€‚ä½ å¯ä»¥ç”¨adapter patternè§£å†³è¿™ä¸ªé—®é¢˜ï¼ˆ(https://en.wikipedia.org/wiki/Adapter_pattern ï¼‰ã€‚</p>

<p>æ­¤å¤–çš„ä¾‹å­ï¼š</p>

<p><strong><em>Listing 4-12. Solving Problematic Deserialization</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kd">class</span> <span class="nc">Employee</span>
<span class="o">{</span>
 <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
 <span class="nc">Employee</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span>
 <span class="o">{</span>
 <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
 <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">SerEmployee</span> <span class="kd">implements</span> <span class="nc">Serializable</span>
<span class="o">{</span>
 <span class="kd">private</span> <span class="nc">Employee</span> <span class="n">emp</span><span class="o">;</span>
 <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
 <span class="nc">SerEmployee</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
 <span class="n">emp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Employee</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeObject</span><span class="o">(</span><span class="nc">ObjectOutputStream</span> <span class="n">oos</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span>
 <span class="o">{</span>
 <span class="n">oos</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="nc">ObjectInputStream</span> <span class="n">ois</span><span class="o">)</span>
 <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span><span class="o">,</span> <span class="nc">IOException</span>
 <span class="o">{</span>
 <span class="n">name</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
 <span class="n">emp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Employee</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span>
 <span class="o">{</span>
 <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
 <span class="o">}</span>
<span class="o">}</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SerializationDemo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
 <span class="nc">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
 <span class="k">try</span>
 <span class="o">{</span>
 <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="s">"employee.dat"</span><span class="o">));</span>
 <span class="nc">SerEmployee</span> <span class="n">se</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SerEmployee</span><span class="o">(</span><span class="s">"John Doe"</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">se</span><span class="o">);</span>
 <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">se</span><span class="o">);</span>
 <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
 <span class="n">oos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"se object written to file"</span><span class="o">);</span>
 <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"employee.dat"</span><span class="o">));</span>
 <span class="n">se</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SerEmployee</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"se object read from file"</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">se</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">cnfe</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="n">cnfe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
 <span class="o">}</span>
 <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
 <span class="o">}</span>
 <span class="k">finally</span>
 <span class="o">{</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">oos</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
 <span class="k">try</span>
 <span class="o">{</span>
 <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
 <span class="o">}</span>
 <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// shouldn't happen in this context</span>
 <span class="o">}</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">ois</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
 <span class="k">try</span>
 <span class="o">{</span>
 <span class="n">ois</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
 <span class="o">}</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SerializationDemo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
 <span class="nc">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
 <span class="k">try</span>
 <span class="o">{</span>
 <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="s">"employee.dat"</span><span class="o">));</span>
 <span class="nc">SerEmployee</span> <span class="n">se</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SerEmployee</span><span class="o">(</span><span class="s">"John Doe"</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">se</span><span class="o">);</span>
 <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">se</span><span class="o">);</span>
 <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
 <span class="n">oos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"se object written to file"</span><span class="o">);</span>
 <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"employee.dat"</span><span class="o">));</span>
 <span class="n">se</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SerEmployee</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"se object read from file"</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">se</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">cnfe</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="n">cnfe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
 <span class="o">}</span>
 <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
 <span class="o">}</span>
 <span class="k">finally</span>
 <span class="o">{</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">oos</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
 <span class="k">try</span>
 <span class="o">{</span>
 <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
 <span class="o">}</span>
 <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// shouldn't happen in this context</span>
 <span class="o">}</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">ois</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
 <span class="k">try</span>
 <span class="o">{</span>
 <span class="n">ois</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
 <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// shouldn't happen in this context</span>
 <span class="o">}</span>
 <span class="o">}</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>è¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>John Doe
se object written to file
se object read from file
John Doe
</code></pre></div></div>

<h5 id="externalization">Externalization</h5>

<p>Javaæ”¯æŒ externalization ã€‚ä¸åƒé»˜è®¤/è‡ªå®šä¹‰serialization/deserialization , externalizationæä¾›åºåˆ—åŒ–ååºåˆ—åŒ–çš„å®Œæ•´æ§åˆ¶ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šExternalization å¸®ä½ æ”¹å–„åŸºäºåå°„çš„åºåˆ—åŒ–ååºåˆ—åŒ–æ€§èƒ½ï¼Œç»™ä½ å®Œå…¨æ§åˆ¶é‚£äº›fieldå‚ä¸åºåˆ—åŒ–ã€‚</p>

<p>é€šè¿‡<code class="language-plaintext highlighter-rouge">java.io.Externalizable</code>æ”¯æŒExternalizationã€‚æ¥å£æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>void writeExternal(ObjectOutput out)</li>
  <li>void readExternal(ObjectInput in)</li>
</ul>

<p>å¦‚æœç±»å®ç°<code class="language-plaintext highlighter-rouge"> Externalizable </code>ï¼Œä¾‹å­ï¼š</p>

<p><strong><em>Listing 4-13. Refactoring Listing 4-9â€™s Employee Class to Support Externalization</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.Externalizable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInput</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutput</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="kd">implements</span> <span class="nc">Externalizable</span>
<span class="o">{</span>
 <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
 <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
 <span class="kd">public</span> <span class="nf">Employee</span><span class="o">()</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Employee() called"</span><span class="o">);</span>
 <span class="o">}</span> <span class="kd">public</span> <span class="nf">Employee</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
 <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
 <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">age</span><span class="o">;</span> <span class="o">}</span>
 <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeExternal</span><span class="o">(</span><span class="nc">ObjectOutput</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"writeExternal() called"</span><span class="o">);</span>
 <span class="n">out</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
 <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">age</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">readExternal</span><span class="o">(</span><span class="nc">ObjectInput</span> <span class="n">in</span><span class="o">)</span>
 <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"readExternal() called"</span><span class="o">);</span>
 <span class="n">name</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
 <span class="n">age</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
 <span class="o">}</span>
<span class="o">}</span>


</code></pre></div></div>

<p>è¾“å‡ºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">writeExternal</span><span class="o">()</span> <span class="n">called</span>
<span class="nf">Employee</span><span class="o">()</span> <span class="n">called</span>
<span class="nf">readExternal</span><span class="o">()</span> <span class="n">called</span>
<span class="nc">John</span> <span class="nc">Doe</span>
<span class="mi">36</span>
</code></pre></div></div>

<h4 id="printstream">PrintStream</h4>

<p>åœ¨å…¨éƒ¨çš„streamç±»é‡Œï¼Œ<code class="language-plaintext highlighter-rouge">PrintStream </code>æ˜¯å¤æ€ªçš„ï¼šæŒ‰å‘½åçº¦å®šåº”è¯¥å«<code class="language-plaintext highlighter-rouge"> PrintOutputStream </code>ã€‚è¿™ä¸ªfilter output stream ç±»å†™è¾“å…¥æ•°æ®é¡¹çš„å­—ç¬¦ä¸²å½¢å¼åˆ°åº•å±‚è¾“å‡ºæµã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š<code class="language-plaintext highlighter-rouge">PrintStream </code>ä¼šä½¿ç”¨é»˜è®¤å­—ç¬¦ç¼–ç è½¬åŒ–stringä¸ºå­—èŠ‚ï¼ˆ5ç« è®¨è®ºï¼‰ã€‚<code class="language-plaintext highlighter-rouge">PrintStream </code>ä¸æ”¯æŒä¸åŒçš„ç¼–ç ï¼Œä½ è¯¥ç”¨ç­‰ä»·çš„<code class="language-plaintext highlighter-rouge"> PrintWriter </code>ä»£æ›¿ã€‚ç„¶è€Œå› ä¸ºstandard I/Oï¼Œä½ éœ€è¦äº†è§£<code class="language-plaintext highlighter-rouge">PrintStream </code>ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">PrintStream </code>å®ä¾‹æ˜¯print streams ï¼Œå®ƒçš„æ–¹æ³•print() and println() ï¼Œæ‰“å°integers, floating-point values, and other data items çš„å­—ç¬¦ä¸²å½¢å¼åˆ°ä¸‹é¢çš„è¾“å‡ºæµã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š line terminator ï¼ˆä¹Ÿå« line separator ï¼‰ï¼Œä¸ä¸€å®šnewlineï¼ˆä¹Ÿé€šå¸¸è¢«ç§°ä¸ºæ¢è¡Œ ï¼‰ï¼Œline separator æ˜¯ç³»ç»Ÿå±æ€§<code class="language-plaintext highlighter-rouge">line.separator. </code>windowsæ˜¯å›è½¦ç ï¼ˆ13ï¼‰ä¹Ÿå°±æ˜¯<code class="language-plaintext highlighter-rouge"> \r </code>ï¼Œç´§æ¥ç€å®é™…çš„newline/line feed code(10)ï¼Œ<code class="language-plaintext highlighter-rouge">\n</code>ï¼Œlinuxåªè¿”å›newline/line feed code ã€‚</p>

<p><strong>è­¦å‘Š</strong>ï¼šä¸è¦åœ¨ä½ ç”¨ print() or println() æ–¹æ³•è¾“å‡ºçš„å­—ç¬¦ä¸²ä¸Šç¡¬ç¼–ç <code class="language-plaintext highlighter-rouge"> \n escape sequence </code>ã€‚è¿™æ ·æ˜¯ä¸ç¨³å®šçš„ã€‚</p>

<p>æœ‰3ä¸ªæœ‰ç”¨çš„ç‰¹ç‚¹ï¼š</p>

<ul>
  <li>ä¸åƒå…¶ä»–streamï¼Œä¸ä¼šä»åº•å±‚æŠ›å‡º<code class="language-plaintext highlighter-rouge">IOException</code>ã€‚è€Œæ˜¯æœ‰checkError() æ–¹æ³•</li>
  <li>å¯ä»¥è¢«åˆ›å»ºæ¥è‡ªåŠ¨åˆ·æ–°è¾“å‡ºåˆ°åº•å±‚è¾“å‡ºæµã€‚å­—èŠ‚å†™å…¥è‡ªåŠ¨flush()  ï¼Œprintln()è¢«è°ƒç”¨ï¼Œæˆ–è€…ä¸€ä¸ªnewlineè¢«å†™ã€‚</li>
  <li>å£°æ˜äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">format(String format, Object... args)</code> å½¢å¼ç”¨äºå¾—åˆ°æ ¼å¼åŒ–è¾“å‡ºã€‚æ˜¯ç”¨çš„Formatterç±»ï¼Œ11ç« ä»‹ç»ã€‚ä¹Ÿæœ‰ä¾¿åˆ©çš„<code class="language-plaintext highlighter-rouge">printf(String format, Object... args) </code>æ–¹æ³•ã€‚</li>
</ul>

<h4 id="revisiting-standard-io">Revisiting Standard I/O</h4>

<p>System.in, System.out, and System.err are formally described by the following class fields in the System class:</p>

<ul>
  <li>public static final InputStream in</li>
  <li>public static final PrintStream out</li>
  <li>public static final PrintStream err</li>
</ul>

<p>å¯¹åº”standard input, standard output, and standard error streams ã€‚</p>

<p>å½“ä½ è°ƒç”¨ System.in.read(), æ¥è‡ªäºç»‘å®šåˆ°inçš„sourceã€‚å½“æ ‡å‡†è¾“å…¥æ—¶ï¼ŒJavaåˆå§‹åŒ–ä»¥å¼•ç”¨é”®ç›˜æˆ–æ–‡ä»¶æµè¢«é‡å®šå‘åˆ°æ–‡ä»¶ã€‚<code class="language-plaintext highlighter-rouge"> out/err </code>è®¾è®¡å±å¹•æˆ–æ–‡ä»¶ã€‚ä½ å¯ä»¥ç¼–ç¨‹å¼æŒ‡å®šinput source, output destination, and error destination é€šè¿‡<code class="language-plaintext highlighter-rouge">System</code>çš„æ–¹æ³•ï¼š</p>

<ul>
  <li>void setIn(InputStream in)</li>
  <li>void setOut(PrintStream out)</li>
  <li>void setErr(PrintStream err)</li>
</ul>

<p>RedirectIO applicationä¾‹å­ï¼š</p>

<p><strong><em>Listing 4-14. Programmatically Specifying the Standard Input Source and Standard Output/Error Destinations</em></strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import java.io.FileInputStream;
import java.io.IOException;
import java.io.PrintStream;
public class RedirectIO
{
 public static void main(String[] args) throws IOException
 {
 if (args.length != 3)
 {
 System.err.println("usage: java RedirectIO stdinfile " +
 "stdoutfile stderrfile");
 return;
 }
 System.setIn(new FileInputStream(args[0]));
 System.setOut(new PrintStream(args[1]));
 System.setErr(new PrintStream(args[2]));
 int ch;
 while ((ch = System.in.read()) != -1)
 System.out.print((char) ch);
 System.err.println("Redirected error output");
 }
}

</code></pre></div></div>

<p>run <code class="language-plaintext highlighter-rouge">java RedirectIO RedirectIO.java out.txt err.txt </code>ã€‚</p>

<h4 id="exercise-2">Exercise</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The following exercises are designed to test your understanding of Chapter 4â€™s content:
1. What is a stream?
2. What is the purpose of OutputStreamâ€™s flush() method?
3. True or false: OutputStreamâ€™s close() method automatically
flushes the output stream.
4. What is the purpose of InputStreamâ€™s mark(int) and reset()
methods?
5. How would you access a copy of a ByteArrayOutputStream
instanceâ€™s internal byte array?
6. True or false: FileOutputStream and FileInputStream provide
internal buffers to improve the performance of write and read
operations.
7. Why would you use PipedOutputStream and PipedInputStream?
8. Define filter stream.
9. What does it mean for two streams to be chained together?
10. How do you improve the performance of a file output stream or a file
input stream?
11. How do DataOutputStream and DataInputStream support
FileOutputStream and FileInputStream?
12. What is object serialization and deserialization?
13. What three forms of serialization and deserialization does Java
support?
14. What is the purpose of the Serializable interface?
15. What does the serialization mechanism do when it encounters an
object whose class doesnâ€™t implement Serializable?
16. Identify the three stated reasons for Java not supporting unlimited
serialization.
17. How do you initiate serialization? How do you initiate deserialization?
18. True or false: Class fields are automatically serialized.
19. What is the purpose of the transient reserved word?
20. What does the deserialization mechanism do when it attempts to
deserialize an object whose class has changed?
21. How does the deserialization mechanism detect that a serialized
objectâ€™s class has changed?
22. How can you add an instance field to a class and avoid trouble when
deserializing an object that was serialized before the instance field
was added? What JDK tool can you use to help with this task?
23. How do you customize the default serialization and deserialization
mechanisms without using externalization?
24. How do you tell the serialization and deserialization mechanisms to
serialize or deserialize the objectâ€™s normal state before serializing or
deserializing additional data items?
25. How does externalization differ from default and custom serialization
and deserialization?
26. How does a class indicate that it supports externalization?
27. True or false: During externalization, the deserialization mechanism
throws InvalidClassException with a â€œno valid constructorâ€
message when it doesnâ€™t detect a public noargument constructor.
28. What is the difference between PrintStreamâ€™s print() and
println() methods?
29. What does PrintStreamâ€™s noargument void println() method
accomplish?
30. How do you redirect the standard input, standard output, and standard
error streams?
31. Improve Listing 4-1â€™s Copy application (performance wise) by using
BufferedInputStream and BufferedOutputStream. Copy
should read the bytes to be copied from the buffered input stream and
write these bytes to the buffered output stream.
32. Create a Java application named Split for splitting a large file into
a number of smaller partx files (where x starts at 0 and increments;
for example, part0, part1, part2, and so on). Each partx file
(except possibly the last partx file, which holds the remaining bytes)
will have the same size. This application has the following usage
syntax: java Split path. Furthermore, your implementation must
use the BufferedInputStream, BufferedOutputStream, File,
FileInputStream, and FileOutputStream classes.
</code></pre></div></div>

<h4 id="summary-3">Summary</h4>

<p>Java uses streams to perform I/O operations. A stream is an ordered sequence of bytes of an arbitrary length. Bytes flow over an output stream from an application to a destination and flow over an input stream from a source to an application.</p>

<p>The java.io package provides several classes that identify various stream destinations and sources. These classes are descendants of the abstract OutputStream and InputStream classes. FileOutputStream and BufferedInputStream are examples.</p>

<p>This chapter explored OutputStream and InputStream, followed by the byte array, file, piped, filter, buffered, data, object, and print streams. While covering object streams, it introduced the topics of serialization and externalization. The chapter concluded by revisiting standard I/O.</p>

<h3 id="chapter-5-writers-and-readers">Chapter 5 Writers and Readers</h3>

<p>Javaçš„streamså¯¹å­—èŠ‚åºåˆ—æµå¾ˆæœ‰ç”¨ï¼Œä½†æ˜¯å¯¹å­—ç¬¦æµä¸å¥½ï¼Œå› ä¸ºå­—èŠ‚æµå’Œå­—ç¬¦æµæ˜¯ä¸¤ç§ä¸œè¥¿ï¼šä¸€ä¸ªå­—èŠ‚æ˜¯8-bit data item ï¼Œä¸€ä¸ªå­—ç¬¦æ˜¯16-bit data item ã€‚<code class="language-plaintext highlighter-rouge">char and java.lang. String </code>å¤©ç”Ÿçš„å¤„ç†å­—ç¬¦è€Œä¸æ˜¯å­—èŠ‚ã€‚</p>

<p>æ›´é‡è¦çš„æ˜¯byte streams ä¸äº†è§£character sets ï¼ˆå­—ç¬¦é›†ï¼Œæ•´å‹å€¼ä¹‹é—´çš„æ˜ å°„ï¼Œç§°ä¸ºä»£ç ç‚¹ï¼Œå’Œç¬¦å·ï¼Œå¦‚Unicode ï¼‰å’Œ character encodings ï¼ˆå­—ç¬¦é›†åˆçš„æˆå‘˜ä¹‹é—´çš„æ˜ å°„ï¼Œä»¥åŠä¸ºæ•ˆç‡ç¼–ç è¿™äº›å­—ç¬¦çš„å­—èŠ‚åºåˆ—ï¼Œæ¯”å¦‚UTF-8 ï¼‰</p>

<h4 id="a-brief-history-of-character-sets-and-character-encodings">A BRIEF HISTORY OF CHARACTER SETS AND CHARACTER ENCODINGS</h4>

<p>å¦‚æœä½ éœ€è¦ stream characters ï¼Œä½ éœ€è¦ç”¨Javaâ€™s writer and reader ç±»ï¼Œå®ƒä»¬æ”¯æŒcharacter I/O ï¼ˆç”¨chartå·¥ä½œè€Œä¸æ˜¯byteï¼‰ã€‚æ­¤å¤–ï¼Œ writer and reader ä¹Ÿè€ƒè™‘äº†å­—ç¬¦ç¼–ç ã€‚</p>

<h4 id="writer-and-reader-classes-overview">Writer and Reader Classes Overview</h4>

<p>å±‚æ¬¡ç»“æ„ï¼š</p>

<p><img src="/assets/img/1533093724082.png" alt="1533093724082" /></p>

<p><img src="/assets/img/1533093741720.png" alt="1533093741720" /></p>

<p>FilterWriter and FilterReaderæ˜¯æŠ½è±¡çš„ã€‚BufferedWriter and BufferedReader ä¸ç»§æ‰¿ FilterWriter and FilterReader ï¼Œè¿™æ˜¯å’Œstreamå±‚æ¬¡ä¸ä¸€æ ·çš„åœ°æ–¹ã€‚</p>

<p>output stream and input stream æ˜¯1.0å¼•å…¥çš„ï¼ŒFilterOutputStream and FilterInputStream æœ¬è¯¥æ˜¯æŠ½è±¡çš„ï¼Œä½†æ˜¯å·²ç»ä¸èƒ½å˜äº†å·²ç»è¢«ä½¿ç”¨äº†ã€‚1.1â€™s writer and reader å°±æœ‰æ—¶é—´æ”¹å˜è¿™äº›é”™è¯¯ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šå…³äº BufferedWriter and BufferedReader ç›´æ¥ç»§æ‰¿Writer and Reader è€Œä¸æ˜¯ FilterWriter and FilterReader ï¼Œè¿™ç§å˜åŒ–ä¸æ€§èƒ½æœ‰å…³ ã€‚è°ƒç”¨BufferedOutputStreamâ€™s write() methods and BufferedInputStreamâ€™s read() æ–¹æ³•å¯¼è‡´è°ƒç”¨FilterOutputStreamâ€™s write() methods and FilterInputStreamâ€™s read() æ–¹æ³•ã€‚BufferedWriter and BufferedReader ä¸ç»§æ‰¿Filexxxxerä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚</p>

<h4 id="writer-and-reader">Writer and Reader</h4>

<p>Writer and java.io.OutputStream çš„ä¸åŒç‚¹ï¼š</p>

<ul>
  <li>Writerå£°æ˜äº†å‡ ä¸ªappend() æ–¹æ³•æ·»åŠ å­—ç¬¦åˆ°writerã€‚å› ä¸ºWriter implements the java.lang.Appendableæ¥å£ï¼Œå’Œ<code class="language-plaintext highlighter-rouge">java.util.Formatter </code>ç±»åä½œï¼Œæ¥è¾“å‡ºæ ¼å¼åŒ–çš„stringã€‚</li>
  <li>writerå£°æ˜é¢å¤–çš„ write() æ–¹æ³•ï¼Œå’Œä¾¿åˆ©çš„<code class="language-plaintext highlighter-rouge">write(String str) </code>æ–¹æ³•</li>
</ul>

<p>Reader and java.io.InputStream çš„ä¸åŒç‚¹ï¼š</p>

<ul>
  <li>Reader å£°æ˜read(char[]) and read(char[], int, int)</li>
  <li>Reader æ²¡æœ‰å£°æ˜available() æ–¹æ³•</li>
  <li>å£°æ˜äº†ä¸€ä¸ª boolean ready() æ–¹æ³•ï¼Œå½“ä¸‹ä¸€ä¸ªread() è°ƒç”¨è¢«ä¿è¯ä¸è¢«é˜»å¡è¾“å‡ºå°±è¿”å›trueã€‚</li>
  <li>å£°æ˜äº†ä¸€ä¸ªint read(CharBuffer target) æ–¹æ³•ï¼Œä»ä¸€ä¸ª character buffer è¯»å–å­—ç¬¦ï¼ˆ CharBuffer in Chapter 6 ï¼‰ã€‚</li>
</ul>

<h5 id="outputstreamwriter-and-inputstreamreader">OutputStreamWriter and InputStreamReader</h5>

<p><code class="language-plaintext highlighter-rouge">OutputStreamWriter </code>æ˜¯ä¸€ä¸ªè¾“å…¥çš„å­—ç¬¦åºåˆ—å’Œè¦æµå‡ºçš„å­—èŠ‚æµçš„æ¡¥æ¢ã€‚è¢«å†™åˆ°è¿™ä¸ªwriterçš„å­—ç¬¦æ ¹æ®é»˜è®¤æˆ–æŒ‡å®šç¼–ç è¢«ç¼–ç æˆå­—èŠ‚ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š default character encoding å¯ä»¥ä»<code class="language-plaintext highlighter-rouge">file.encoding </code>ç³»ç»Ÿå±æ€§æ‹¿åˆ°ã€‚</p>

<p>æ¯ä¸€ä¸ª OutputStreamWriterâ€™s write() æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šå¯¼è‡´ä¸€ä¸ªencoder åœ¨ç»™å‡ºçš„å­—ç¬¦ä¸Šè¢«è°ƒç”¨ã€‚ç”Ÿæˆçš„å­—èŠ‚åœ¨bufferç´¯ç§¯ï¼Œåœ¨è¢«å†™å…¥ä¸‹é¢çš„è¾“å‡ºæµä¹‹å‰ã€‚ä¼ é€’ç»™writeçš„æ–¹æ³•æ²¡æœ‰è¢«bufferedã€‚</p>

<p>OutputStreamWriteræœ‰4ä¸ªæ„é€ å™¨ï¼ŒåŒ…æ‹¬ä¸‹é¢2ä¸ªï¼š</p>

<ul>
  <li>OutputStreamWriter(OutputStream out)</li>
  <li>OutputStreamWriter(OutputStream out, String charsetName) æŒ‡å®šç¼–ç </li>
</ul>

<p><strong>æ³¨æ„</strong>ï¼šOutputStreamWriter ä¾èµ–<code class="language-plaintext highlighter-rouge"> java.nio.charset. Charset and java.nio.charset.CharsetEncoder </code>æŠ½è±¡ç±»æ‰§è¡Œå­—ç¬¦ç¼–ç ã€‚</p>

<p>ä¾‹å­ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="s">"polish.txt"</span><span class="o">);</span>
<span class="nc">OutputStreamWriter</span> <span class="n">osw</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">fos</span><span class="o">,</span> <span class="s">"8859_2"</span><span class="o">);</span>
<span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="sc">'\u0323'</span><span class="o">;</span> <span class="c1">// Accented N.</span>
<span class="n">osw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</code></pre></div></div>

<p>InputStreamReaderç±»æ˜¯ä¸€ä¸ªè¿›æ¥çš„å­—èŠ‚æµå’Œå‡ºå»çš„å­—ç¬¦åºåˆ—çš„æ¡¥æ¢ã€‚æ¯ä¸ªInputStreamReaderâ€™s read() çš„è°ƒç”¨å¯¼è‡´ä¸€ä¸ªæˆ–å¤šä¸ªå­—èŠ‚ä»åº•å±‚è¾“å…¥æµè¢«è¯»ã€‚ä¸ºäº†æ•ˆç‡å¯èƒ½ä¼šè¯»æ›´å¤šçš„å­—èŠ‚ã€‚</p>

<p>4ä¸ªæ„é€ å™¨ï¼Œå…¶ä¸­2ä¸ªï¼š</p>

<ul>
  <li>InputStreamReader(InputStream in)</li>
  <li>InputStreamReader(InputStream in, String charsetName)</li>
</ul>

<p><strong>æ³¨æ„</strong>ï¼šOutputStreamWriter and InputStreamReader å£°æ˜äº†getEncoding() æ–¹æ³•ï¼Œè¿”å›ä½¿ç”¨çš„ç¼–ç </p>

<h5 id="filewriter-and-filereader">FileWriter and FileReader</h5>

<p>FileWriter æ˜¯ä¸€ä¸ªæ–¹ä¾¿ç±»ï¼Œå†™å­—ç¬¦åˆ°æ–‡ä»¶ã€‚å®ƒç»§æ‰¿OutputStreamWriter ï¼Œä¸€ä¸ªè¿™ä¸ªç±»çš„å®ä¾‹ç­‰åŒäºä¸‹é¢</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
<span class="nc">OutputStreamWriter</span> <span class="n">osw</span><span class="o">;</span>
<span class="n">osw</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">fos</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"file.encoding"</span><span class="o">));</span>
</code></pre></div></div>

<p>FileReaderæ˜¯ä¸€ä¸ªæ–¹ä¾¿ç±»ï¼Œä»æ–‡ä»¶è¯»å–å­—ç¬¦ã€‚ç»§æ‰¿InputStreamReader ï¼Œä¸€ä¸ªè¿™ä¸ªç±»çš„å®ä¾‹ç­‰åŒäºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
<span class="nc">InputStreamReader</span> <span class="n">isr</span><span class="o">;</span>
<span class="n">isr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">fis</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"file.encoding"</span><span class="o">));</span>
</code></pre></div></div>

<p>FileWriter nor FileReader éƒ½æ²¡æä¾›å®ƒä»¬è‡ªå·±çš„æ–¹æ³•ï¼Œä½ å¯ä»¥è°ƒç”¨ç»§æ‰¿æ–¹æ³•ã€‚</p>

<p>ä¾‹å­ï¼š</p>

<p><strong><em>Listing 5-1. Demonstrating the FileWriter and FileReader Classes</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.FileReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FWFRDemo</span>
<span class="o">{</span>
 <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">MSG</span> <span class="o">=</span> <span class="s">"Test message"</span><span class="o">;</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span>
 <span class="o">{</span>
 <span class="k">try</span> <span class="o">(</span><span class="nc">FileWriter</span> <span class="n">fw</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="s">"temp"</span><span class="o">))</span>
 <span class="o">{</span>
 <span class="n">fw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="no">MSG</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="no">MSG</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
 <span class="o">}</span>
 <span class="kt">char</span><span class="o">[]</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="no">MSG</span><span class="o">.</span><span class="na">length</span><span class="o">()];</span>
 <span class="k">try</span> <span class="o">(</span><span class="nc">FileReader</span> <span class="n">fr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="s">"temp"</span><span class="o">))</span>
 <span class="o">{</span>
 <span class="n">fr</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="no">MSG</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="bufferedwriter-and-bufferedreader">BufferedWriter and BufferedReader</h5>

<p>BufferedWriter å†™æ–‡æœ¬åˆ°å­—ç¬¦è¾“å‡ºæµï¼ˆ Writer å®ä¾‹ï¼‰ï¼Œç¼“å†²å­—ç¬¦ï¼Œä»¥æä¾›é«˜æ•ˆçš„å†™å•ä¸ªå­—ç¬¦ã€æ•°ç»„å’Œå­—ç¬¦ä¸²ã€‚æ„é€ å‡½æ•°ï¼š</p>

<ul>
  <li>BufferedWriter(Writer out)</li>
  <li>BufferedWriter(Writer out, int size)</li>
</ul>

<p>sizeå¯ä»¥æŒ‡å®šï¼Œæˆ–è€…é»˜è®¤çš„8,192 bytes ã€‚</p>

<p>BufferedWriteråŒ…å«ä¸€ä¸ªä¾¿åˆ©çš„void newLine() æ–¹æ³•ï¼Œå†™ä¸€ä¸ªè¡Œåˆ†éš”ç¬¦å­—ç¬¦ä¸²ï¼Œæ¥æ‰“æ–­è¿™ä¸€è¡Œã€‚</p>

<p>BufferedReader ä»å­—ç¬¦è¾“å…¥æµï¼ˆReader å®ä¾‹ï¼‰è¯»å–æ–‡æœ¬ï¼Œç¼“å†²å­—ç¬¦ä»¥ä¾¿æœ‰æ•ˆè¯»å–å­—ç¬¦ã€æ•°ç»„å’Œè¡Œã€‚æ„é€ å‡½æ•°ï¼š</p>

<ul>
  <li>BufferedReader(Reader in)</li>
  <li>BufferedReader(Reader in, int size)</li>
</ul>

<p>sizeå¯ä»¥æŒ‡å®šï¼Œæˆ–è€…é»˜è®¤8,192 bytes ã€‚</p>

<p>æœ‰ä¸ªæ–¹ä¾¿çš„ String readLine() æ–¹æ³•ï¼Œè¯»å–è¡Œæ–‡æœ¬ï¼Œä¸åŒ…æ‹¬ä»»ä½•æ¢è¡Œç¬¦ã€‚</p>

<p>ä¾‹å­ï¼š</p>

<p><strong><em>Listing 5-2. Demonstrating the BufferedWriter and BufferedReader Classes</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BWBRDemo</span>
<span class="o">{</span>
 <span class="kd">static</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">lines</span> <span class="o">=</span>
 <span class="o">{</span>
 <span class="s">"It was the best of times, it was the worst of times,"</span><span class="o">,</span>
 <span class="s">"it was the age of wisdom, it was the age of foolishness,"</span><span class="o">,</span>
 <span class="s">"it was the epoch of belief, it was the epoch of incredulity,"</span><span class="o">,</span>
 <span class="s">"it was the season of Light, it was the season of Darkness,"</span><span class="o">,</span>
 <span class="s">"it was the spring of hope, it was the winter of despair."</span>
 <span class="o">};</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span>
 <span class="o">{</span>
 <span class="k">try</span> <span class="o">(</span><span class="nc">BufferedWriter</span> <span class="n">bw</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="s">"temp"</span><span class="o">)))</span>
 <span class="o">{</span>
 <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="nl">line:</span> <span class="n">lines</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="n">bw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">line</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">line</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
 <span class="n">bw</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
 <span class="o">}</span>
 <span class="o">}</span>
 <span class="k">try</span> <span class="o">(</span><span class="nc">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="s">"temp"</span><span class="o">)))</span>
 <span class="o">{</span>
 <span class="nc">String</span> <span class="n">line</span><span class="o">;</span>
 <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="exercise-3">Exercise</h4>

<p>The following exercises are designed to test your understanding of Chapter 5â€™s content:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span><span class="o">.</span> <span class="nc">Why</span> <span class="n">are</span> <span class="nc">Java</span><span class="err">â€™</span><span class="n">s</span> <span class="n">stream</span> <span class="n">classes</span> <span class="n">not</span> <span class="n">good</span> <span class="n">at</span> <span class="n">streaming</span> <span class="n">characters</span><span class="o">?</span>
<span class="mi">2</span><span class="o">.</span> <span class="nc">What</span> <span class="n">does</span> <span class="nc">Java</span> <span class="n">provide</span> <span class="n">as</span> <span class="n">the</span> <span class="n">preferred</span> <span class="n">alternative</span> <span class="n">to</span> <span class="n">stream</span> <span class="n">classes</span>
<span class="n">when</span> <span class="n">it</span> <span class="n">comes</span> <span class="n">to</span> <span class="n">character</span> <span class="no">I</span><span class="o">/</span><span class="no">O</span><span class="o">?</span>
<span class="mi">3</span><span class="o">.</span> <span class="nc">True</span> <span class="n">or</span> <span class="kc">false</span><span class="o">:</span> <span class="nc">Reader</span> <span class="n">declares</span> <span class="n">an</span> <span class="nf">available</span><span class="o">()</span> <span class="n">method</span><span class="o">.</span>
<span class="mi">4</span><span class="o">.</span> <span class="nc">What</span> <span class="n">is</span> <span class="n">the</span> <span class="n">purpose</span> <span class="n">of</span> <span class="n">the</span> <span class="nc">OutputStreamWriter</span> <span class="kd">class</span><span class="err">?</span> <span class="nc">What</span> <span class="n">is</span> <span class="n">the</span>
<span class="n">purpose</span> <span class="n">of</span> <span class="n">the</span> <span class="nc">InputStreamReader</span> <span class="kd">class</span><span class="err">?</span>
<span class="err">5.</span> <span class="nc">How</span> <span class="k">do</span> <span class="n">you</span> <span class="n">identify</span> <span class="n">the</span> <span class="k">default</span> <span class="n">character</span> <span class="n">encoding</span><span class="o">?</span>
<span class="mi">6</span><span class="o">.</span> <span class="nc">What</span> <span class="n">is</span> <span class="n">the</span> <span class="n">purpose</span> <span class="n">of</span> <span class="n">the</span> <span class="nc">FileWriter</span> <span class="kd">class</span><span class="err">?</span> <span class="nc">What</span> <span class="n">is</span> <span class="n">the</span> <span class="n">purpose</span> <span class="n">of</span>
<span class="n">the</span> <span class="nc">FileReader</span> <span class="kd">class</span><span class="err">?</span>
<span class="err">7.</span> <span class="nc">What</span> <span class="n">method</span> <span class="n">does</span> <span class="nc">BufferedWriter</span> <span class="n">provide</span> <span class="k">for</span> <span class="n">writing</span> <span class="n">a</span> <span class="n">line</span>
<span class="n">separator</span><span class="o">?</span>
<span class="mi">8</span><span class="o">.</span> <span class="nc">It</span><span class="err">â€™</span><span class="n">s</span> <span class="n">often</span> <span class="n">convenient</span> <span class="n">to</span> <span class="n">read</span> <span class="n">lines</span> <span class="n">of</span> <span class="n">text</span> <span class="n">from</span> <span class="n">standard</span> <span class="n">input</span><span class="o">,</span> <span class="n">and</span> <span class="n">the</span>
<span class="nc">InputStreamReader</span> <span class="n">and</span> <span class="nc">BufferedReader</span> <span class="n">classes</span> <span class="n">make</span> <span class="k">this</span> <span class="n">task</span>
<span class="n">possible</span><span class="o">.</span> <span class="nc">Create</span> <span class="n">a</span> <span class="nc">Java</span> <span class="n">application</span> <span class="n">named</span> <span class="nc">CircleInfo</span> <span class="n">that</span><span class="o">,</span> <span class="n">after</span>
<span class="n">obtaining</span> <span class="n">a</span> <span class="nc">BufferedReader</span> <span class="n">instance</span> <span class="n">that</span> <span class="n">is</span> <span class="n">chained</span> <span class="n">to</span> <span class="n">standard</span>
<span class="n">input</span><span class="o">,</span> <span class="n">presents</span> <span class="n">a</span> <span class="n">loop</span> <span class="n">that</span> <span class="n">prompts</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">enter</span> <span class="n">a</span> <span class="n">radius</span><span class="o">,</span> <span class="n">parses</span>
<span class="n">the</span> <span class="n">entered</span> <span class="n">radius</span> <span class="n">into</span> <span class="n">a</span> <span class="kt">double</span> <span class="n">value</span><span class="o">,</span> <span class="n">and</span> <span class="n">outputs</span> <span class="n">a</span> <span class="n">pair</span> <span class="n">of</span> <span class="n">messages</span>
<span class="n">that</span> <span class="n">report</span> <span class="n">the</span> <span class="n">circle</span><span class="err">â€™</span><span class="n">s</span> <span class="n">circumference</span> <span class="n">and</span> <span class="n">area</span> <span class="n">based</span> <span class="n">on</span> <span class="k">this</span> <span class="n">radius</span><span class="o">.</span>
</code></pre></div></div>

<h4 id="summary-4">Summary</h4>

<p>Javaâ€™s stream classes are good for streaming sequences of bytes, but theyâ€™re not good for streaming sequences of characters because bytes and characters are two different things. A byte represents an 8-bit data item and a character represents a 16-bit data item. Also, Javaâ€™s char and String types naturally handle characters instead of bytes. More importantly, byte streams have no knowledge of character sets and their encodings.</p>

<p>Java provides writer and reader classes to stream characters. They support character I/O (they work with char instead of byte) and take character encodings into account. The abstract Writer and Reader classes describe what it means to be a writer and a reader.</p>

<p>Writer and Reader are subclassed by OutputStreamWriter and InputStreamReader, which bridge the gap between character and byte streams. These classes are subclassed by the FileWriter and FileReader convenience classes, which facilitate writing/reading characters to/from files. Writer and Reader are also subclassed by BufferedWriter and BufferedReader, which buffer characters for efficiency.</p>

<h2 id="part-â…²-new-io-apis">PART â…¢ New I/O APIs</h2>

<h3 id="chapter-6-buffers">Chapter 6 Buffers</h3>

<p>NIOæ˜¯åŸºäºbufferçš„ï¼Œå®ƒçš„å†…å®¹é€šè¿‡channelsè¢«å‘é€åˆ° I/O services æˆ–è€…ä» I/O services æ¥æ”¶ã€‚</p>

<h4 id="introducing-buffers">Introducing Buffers</h4>

<p>ä¸€ä¸ªbufferæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå­˜å‚¨å›ºå®šæ•°é‡çš„å‘é€åˆ°æˆ–ä» I/O serviceï¼ˆæ“ä½œç³»ç»Ÿæ‰§è¡Œè¾“å…¥è¾“å‡ºçš„ç»„ä»¶ï¼‰æ¥æ”¶çš„æ•°æ®ã€‚å®ƒå¤„äºåº”ç”¨å’Œchannelä¹‹é—´ï¼Œchannelå†™ç¼“å†²æ•°æ®åˆ°serviceï¼Œæˆ–è€…ä»serviceè¯»å–æ•°æ®å­˜åˆ°bufferã€‚</p>

<p>ç¼“å†²åŒºå…·æœ‰å››ä¸ªå±æ€§ï¼š</p>

<ul>
  <li>Capacity: å¯ä»¥å­˜åœ¨bufferçš„data itemçš„æ€»æ•°ã€‚åˆ›å»ºæ—¶æŒ‡å®šï¼Œå¹¶ä¸”ä¹‹åä¸èƒ½æ›´æ”¹ã€‚</li>
  <li>Limit: ç¬¬ä¸€ä¸ªä¸èƒ½è¢«è¯»å†™çš„å…ƒç´ çš„ä»¥0ä¸ºåŸºå‡†çš„ç´¢å¼•ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒè¡¨æ˜äº†bufferé‡Œçš„ â€œliveâ€ data items ã€‚</li>
  <li>Position:  ä¸‹ä¸€ä¸ªå¯ä»¥è¢«è¯»çš„data itemæˆ–è€…data item å¯ä»¥è¢«å†™ä½ç½®çš„ä»¥0ä¸ºåŸºå‡†çš„ç´¢å¼•ã€‚</li>
  <li>Mark:  å½“bufferçš„ reset() æ–¹æ³•è¢«è°ƒç”¨æ—¶è®¾ç½®ä½ç½®çš„ä»¥0ä¸ºåŸºå‡†çš„ç´¢å¼•ã€‚Markå¼€å§‹æœªè¢«å®šä¹‰ã€‚</li>
</ul>

<p>è¿™4ä¸ªå±æ€§è”ç³»å¦‚ä¸‹ï¼š0 &lt;= mark &lt;= position &lt;= limit &lt;= capacity</p>

<p><img src="/assets/img/1533108252365.png" alt="1533108252365" /></p>

<p>bufferæœ€å¤šå¯ä»¥å­˜å‚¨7ä¸ªå…ƒç´ ã€‚Markåˆå§‹æœªè¢«å®šä¹‰ï¼Œpositionè¢«è®¾ç½®ä¸º0ï¼Œlimitè¢«è®¾ç½®ä¸ºå®¹é‡ï¼ˆ7ï¼‰ï¼Œä½ åªå¯ä»¥è®¿é—®0-6 positionsã€‚</p>

<h4 id="buffer-and-its-children">Buffer and its Children</h4>

<p>Bufferâ€™s çš„æ–¹æ³•ï¼š</p>

<p><strong><em>Table 6-1. Buffer Methods</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Object array()</td>
      <td>è¿”å›æ”¯æŒè¿™ä¸ªbufferçš„arrayã€‚è¿™ä¸ªæ–¹æ³•ç”¨äºå…è®¸  array-backed buffers æ›´æ•ˆç‡åœ°ä¼ é€’ç»™ native code ã€‚å…·ä½“çš„å­ç±»é‡å†™è¿™ä¸ªæ–¹æ³•æä¾›æ›´å¼ºå¤§çš„ç±»å‹è¿”å›å€¼ã€‚å½“bufferç”±ä¸€ä¸ªåªè¯»æ•°ç»„æ”¯æ’‘è¿”å›<code class="language-plaintext highlighter-rouge"> java.nio.ReadOnlyBufferException </code>ï¼Œä¸å¯è®¿é—®æ•°ç»„è¿”å›<code class="language-plaintext highlighter-rouge"> java.lang.UnsupportedOperationException </code>ã€‚</td>
    </tr>
    <tr>
      <td>int arrayOffset()</td>
      <td>è¿”å›bufferæ”¯æŒæ•°ç»„å†…ç¬¬ä¸€ä¸ªbufferå…ƒç´ çš„offsetã€‚å½“bufferç”±ä¸€ä¸ªæ•°ç»„æ”¯æ’‘ï¼Œ buffer position p å¯¹åº”array index p +  arrayOffset() ã€‚åœ¨è°ƒç”¨æ­¤æ–¹æ³•å‰è°ƒç”¨  hasArray() ç¡®ä¿bufferæœ‰å¯è®¿é—®çš„æ”¯æ’‘æ•°ç»„ã€‚åªè¯»æŠ›å‡º  ReadOnlyBufferException ï¼Œä¸å¯è®¿é—®æŠ›å‡º UnsupportedOperationException ã€‚</td>
    </tr>
    <tr>
      <td>int capacity()</td>
      <td>è¿”å›æ•°ç»„çš„å®¹é‡</td>
    </tr>
    <tr>
      <td>Buffer clear()</td>
      <td>æ¸…ç©ºbufferã€‚positionè®¾ç½®ä¸º0ï¼Œlimitè¢«è®¾ç½®ä¸ºå®¹é‡ï¼Œmarkè¢«ä¸¢å¼ƒã€‚è¿™ä¸ªæ–¹æ³•ä¸åˆ é™¤bufferçš„æ•°æ®ï¼Œä½†æ˜¯æ–¹æ³•åå°±åƒåˆ é™¤äº†ä¼¼å¾—ï¼Œå› ä¸ºå¤§éƒ¨åˆ†è¦ä½¿ç”¨è¿™ä¸ªæ–¹æ³•çš„æƒ…å†µéƒ½æ˜¯åˆ é™¤ã€‚</td>
    </tr>
    <tr>
      <td>Buffer flip()</td>
      <td>ç¿»è½¬è¿™ä¸ªbufferã€‚limitè¢«è®¾ç½®ä¸ºå½“å‰positionï¼Œç„¶åpositionè¢«è®¾ç½®ä¸º0ã€‚Markè¢«å®šä¹‰çš„è¯ä¼šè¢«ä¸¢å¼ƒã€‚</td>
    </tr>
    <tr>
      <td>boolean hasArray()</td>
      <td>å¦‚æœ  buffer ç”±arrayæ”¯æ’‘ä¸”ä¸æ˜¯åªè¯»è¿”å›trueï¼›å¦åˆ™falseã€‚è¿”å›trueæ—¶ï¼Œ array() and arrayOffset() éƒ½å¯ä»¥å®‰å…¨è°ƒç”¨ã€‚</td>
    </tr>
    <tr>
      <td>boolean hasRemaining()</td>
      <td>å¦‚æœè‡³å°‘ä¸€ä¸ªå…ƒç´ æ®‹ç•™åœ¨bufferè¿”å›trueï¼ˆå°±æ˜¯ï¼Œåœ¨å½“å‰positionå’Œlimitä¹‹é—´ï¼‰ã€‚å¦åˆ™ï¼Œè¿”å›falseã€‚</td>
    </tr>
    <tr>
      <td>boolean isDirect()</td>
      <td>å½“bufferæ˜¯  direct byte buffer è¿”å›trueã€‚å¦åˆ™false</td>
    </tr>
    <tr>
      <td>boolean isReadOnly()</td>
      <td>buffer read-onlyè¿”å›trueã€‚</td>
    </tr>
    <tr>
      <td>int limit()</td>
      <td>è¿”å›limit</td>
    </tr>
    <tr>
      <td>Buffer limit(int newLimit)</td>
      <td>è®¾ç½®limitä¸ºnewLimitã€‚å½“positionå¤§äºnewLimitï¼Œpositionè¢«è®¾ç½®ä¸ºnewLimitã€‚å½“markè¢«å®šä¹‰ä¸ºå¤§äºnewLimitï¼Œmarkè¢«ä¸¢å¼ƒã€‚newLimitæ˜¯è´Ÿçš„æˆ–è€…å¤§äºå®¹é‡æŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.lang.IllegalArgumentException </code>ï¼›å¦åˆ™è¿”å›è¿™ä¸ªbufferã€‚</td>
    </tr>
    <tr>
      <td>Buffer mark()</td>
      <td>è®¾ç½®Markåˆ°å®ƒçš„positionï¼Œè¿”å›bufferã€‚</td>
    </tr>
    <tr>
      <td>int position()</td>
      <td>è¿”å›position</td>
    </tr>
    <tr>
      <td>Buffer position (int newPosition)</td>
      <td>è®¾ç½®positionä¸ºnewPositionã€‚å½“Markè¢«å®šä¹‰å¤§äºnewPositionï¼ŒMarkè¢«ä¸¢å¼ƒã€‚ä¸ºè´Ÿæˆ–å¤§äºå½“å‰limitæŠ›å‡º<code class="language-plaintext highlighter-rouge">  IllegalArgumentException </code>ï¼›å¦åˆ™è¿”å›bufferã€‚</td>
    </tr>
    <tr>
      <td>int remaining()</td>
      <td>è¿”å›å½“å‰positionå’Œlimitä¹‹é—´å…ƒç´ çš„æ•°é‡</td>
    </tr>
    <tr>
      <td>Buffer reset()</td>
      <td>é‡ç½®bufferçš„positionåˆ°å…ˆå‰çš„Markä½ç½®ã€‚è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¸ä¼šæ”¹å˜å’Œä¸¢å¼ƒmarkçš„å€¼ã€‚markæ²¡è®¾ç½®æŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.nio.InvalidMarkException </code>ï¼›å¦åˆ™è¿”å›bufferã€‚</td>
    </tr>
    <tr>
      <td>Buffer rewind()</td>
      <td>å€’å›å»ï¼Œç„¶åè¿”å›è¿™ä¸ªbufferã€‚positionè¢«è®¾ä¸º0ï¼Œmarkè¢«ä¸¢å¼ƒã€‚</td>
    </tr>
  </tbody>
</table>

<p>ä¸Šé¢æ–¹æ³•å¾ˆå¤šéƒ½è¿”å›bufferå®ä¾‹ï¼Œæ‰€ä»¥å¯ä»¥é“¾å¼ç¼–ç¨‹ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buf</span><span class="o">.</span><span class="na">mark</span><span class="o">();</span>
<span class="n">buf</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="n">buf</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
</code></pre></div></div>

<p>å¯ä»¥ç”¨ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buf</span><span class="o">.</span><span class="na">mark</span><span class="o">().</span><span class="na">position</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="na">reset</span><span class="o">();</span>
</code></pre></div></div>

<p>6-1ä¹Ÿè¡¨æ˜æ‰€æœ‰bufferéƒ½å¯ä»¥è¯»ï¼Œä½†æ˜¯ä¸æ˜¯æ‰€æœ‰éƒ½èƒ½è¢«å†™â€”â€”ä¾‹å¦‚ï¼Œä¸€ä¸ªç”±memory-mapped fileæ”¯æ’‘çš„bufferæ˜¯åªè¯»çš„ã€‚ä¸€å®šä¸èƒ½å†™åªè¯»çš„bufferï¼›å¦åˆ™æŠ›å‡º<code class="language-plaintext highlighter-rouge">ReadOnlyBufferException </code>ã€‚è¯•å›¾å†™çš„æ—¶å€™è°ƒç”¨isReadOnly() çœ‹æ˜¯å¦å¯ä»¥å†™ã€‚</p>

<p><strong>è­¦å‘Š</strong>ï¼šBuffersä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä½ æƒ³ä»å¤šçº¿ç¨‹è®¿é—®bufferå¿…é¡»é‡‡å–åŒæ­¥ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">java.nio </code>åŒ…æœ‰å‡ ä¸ªæŠ½è±¡ç±»æ‹“å±•äº†Bufferï¼Œé™¤äº†Booleanä¹‹å¤–ï¼Œæ¯ä¸ªåŸºæœ¬ç±»å‹éƒ½æœ‰ä¸€ä¸ª ï¼š ByteBuffer, CharBuffer, DoubleBuffer, FloatBuffer, IntBuffer, LongBuffer, and ShortBufferã€‚æ­¤å¤–ï¼Œä¹Ÿæœ‰MappedByteBuffer ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šæ“ä½œç³»ç»Ÿæ‰§è¡Œé¢å‘å­—èŠ‚çš„I/Oï¼Œä½ ä½¿ç”¨ ByteBufferæ¥åˆ›å»ºbyte-oriented buffers ã€‚å…¶ä»–primitive-type buffer ç±»è®©ä½ åˆ›å»ºmultibyte view buffers ï¼ˆdiscussed later ï¼‰ï¼Œç„¶åä½ å¯ä»¥æ¦‚å¿µæ€§åœ°å¯¹å­—ç¬¦ï¼ŒåŒç²¾åº¦æµ®ç‚¹ï¼Œ32-bits integerç­‰ç­‰æ‰§è¡ŒI/Oã€‚ç„¶è€Œï¼ŒI/Oæ“ä½œæ˜¯å­—èŠ‚çš„æµè¿è¡Œçš„ã€‚</p>

<p>æ¼”ç¤ºä¾‹å­ï¼š</p>

<p><strong><em>Listing 6-1. Demonstrating a Byte-Oriented Buffer</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.Buffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BufferDemo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">Buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">7</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Capacity: "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Limit: "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Position: "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Remaining: "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Changing buffer limit to 5"</span><span class="o">);</span>
 <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Limit: "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Position: "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Remaining: "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Changing buffer position to 3"</span><span class="o">);</span>
 <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Position: "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Remaining: "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>ä¸èƒ½å®ä¾‹åŒ–bufferå› ä¸ºæ˜¯æŠ½è±¡çš„ï¼Œè€Œæ˜¯ç”¨ByteBuffer ç±»çš„ allocate() æ–¹æ³•åˆ†é…ä¸€ä¸ª7å­—èŠ‚çš„bufferã€‚</p>

<p>è¾“å‡ºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">Capacity:</span> <span class="mi">7</span>
<span class="nl">Limit:</span> <span class="mi">7</span>
<span class="nl">Position:</span> <span class="mi">0</span>
<span class="nl">Remaining:</span> <span class="mi">7</span>
<span class="nc">Changing</span> <span class="n">buffer</span> <span class="n">limit</span> <span class="n">to</span> <span class="mi">5</span>
<span class="nl">Limit:</span> <span class="mi">5</span>
<span class="nl">Position:</span> <span class="mi">0</span>
<span class="nl">Remaining:</span> <span class="mi">5</span>
<span class="nc">Changing</span> <span class="n">buffer</span> <span class="n">position</span> <span class="n">to</span> <span class="mi">3</span>
<span class="nl">Position:</span> <span class="mi">3</span>
<span class="nl">Remaining:</span> <span class="mi">2</span>
<span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">HeapByteBuffer</span><span class="o">[</span><span class="n">pos</span><span class="o">=</span><span class="mi">3</span> <span class="n">lim</span><span class="o">=</span><span class="mi">5</span> <span class="n">cap</span><span class="o">=</span><span class="mi">7</span><span class="o">]</span>
</code></pre></div></div>

<p>æœ€åçš„bufferæ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge"> java.nio.HeapByteBuffer </code>å®ä¾‹ã€‚</p>

<h4 id="buffers-in-depth">Buffers in Depth</h4>

<p>è¿™èŠ‚æ·±å…¥æ¢ç´¢bufferåˆ›å»ºï¼Œè¯»å†™ï¼Œflippingï¼Œmarkingï¼Œ Buffer subclass operations ï¼Œbyte orderingå’Œdirect buffers ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šè™½ç„¶ primitive-type bufferç±»æœ‰ç›¸ä¼¼çš„èƒ½åŠ›ï¼ŒByteBuffer æ˜¯æœ€å¤§æœ€å…¨èƒ½é€šç”¨çš„ã€‚æ¯•ç«Ÿï¼Œå­—èŠ‚æ˜¯æ“ä½œç³»ç»Ÿç”¨æ¥ä¼ é€’data itemsçš„æœ€å°å•å…ƒã€‚</p>

<h5 id="buffer-creation">Buffer Creation</h5>

<p>ByteBuffer and the other primitive-type bufferç±»å£°æ˜äº†å¾ˆå¤šæ–¹æ³•åˆ›å»ºä¸€ä¸ªè¯¥ç±»å‹çš„bufferã€‚ä¾‹å¦‚ByteBufferï¼š</p>

<ul>
  <li>
    <p>ByteBuffer allocate(int capacity): åˆ†é…ä¸€ä¸ªæ–°çš„æŒ‡å®šå®¹é‡çš„byte bufferã€‚positionæ˜¯0ï¼Œlimitæ˜¯å®¹é‡ï¼Œmarkæœªå®šä¹‰ï¼Œæ¯ä¸ªå…ƒç´ è¢«åˆå§‹åŒ–ä¸º0ã€‚æœ‰ä¸€ä¸ªæ”¯æ’‘æ•°ç»„ï¼Œoffsetæ˜¯0ã€‚å®¹é‡ä¸ºè´ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge">IllegalArgumentException </code>ã€‚</p>
  </li>
  <li>
    <p>ByteBuffer allocateDirect(int capacity):  åˆ†é…ä¸€ä¸ªæ–°çš„æŒ‡å®šå®¹é‡çš„direct byte buffer (discussed later) ã€‚positionæ˜¯0ï¼Œlimitæ˜¯å®¹é‡ï¼Œmarkæœªå®šä¹‰ï¼Œæ¯ä¸ªå…ƒç´ è¢«åˆå§‹åŒ–ä¸º0ã€‚å®ƒæ˜¯å¦æœ‰ä¸€ä¸ªæ”¯æ’‘æ•°ç»„æ˜¯æœªçŸ¥çš„ã€‚å®¹é‡ä¸ºè´ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge">IllegalArgumentException </code>ã€‚</p>

    <p>åœ¨JDK 7ä¹‹å‰ï¼Œè¿™ä¸ªæ–¹æ³•åˆ†é…çš„direct buffers å’Œpageè¾¹ç•Œå¯¹é½ã€‚åœ¨JDK 7ï¼Œå®ç°æ”¹å˜äº†ï¼Œä¸å†æ˜¯é¡µé¢å¯¹é½çš„ã€‚å‡å°‘äº†åˆ›å»ºå¤§é‡buffersåº”ç”¨çš„å†…å­˜éœ€æ±‚ã€‚ï¼ˆTo learn about an operating systemâ€™s paging memory-management mechanism, which is based on pages, check out Wikipediaâ€™s â€œPagingâ€ topic at https://en.wikipedia.org/wiki/Paging ï¼‰</p>
  </li>
  <li>
    <p>ByteBuffer wrap(byte[] array):  å°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„å°è£…åˆ°bufferã€‚æ–°bufferæ˜¯æ•°ç»„æ”¯æ’‘çš„ï¼›å°±æ˜¯ï¼Œæ”¹å˜bufferå°±ä¼šæ”¹å˜æ•°ç»„ï¼Œåä¹‹äº¦ç„¶ã€‚å®¹é‡å’Œlimitæ˜¯array.length ï¼Œpositionä¸º0ï¼ŒMarkæœªå®šä¹‰ã€‚arrayçš„offsetæ˜¯0ã€‚</p>
  </li>
  <li>
    <p>ByteBuffer wrap(byte[] array, int offset, int length)   å°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„å°è£…åˆ°bufferã€‚æ–°bufferæ˜¯æ•°ç»„æ”¯æ’‘çš„ã€‚æ–°bufferçš„å®¹é‡ä¸ºarray.lengthï¼Œpositionè¢«è®¾ç½®ä¸ºoffsetï¼Œlimitè¢«è®¾ç½®ä¸ºoffset+lengthï¼Œmarkæœªå®šä¹‰ã€‚æ•°ç»„offsetæ˜¯0ã€‚æ˜¯offsetæ˜¯è´Ÿï¼Œæˆ–å¤§äºarray.lengthæˆ–è€…å½“lengthæ˜¯è´Ÿæˆ–å¤§äºarray.length - offset æŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.lang. IndexOutOfBoundsException </code>ã€‚</p>
  </li>
</ul>

<p>ä¸‹é¢ä¸¤ç§æ–¹å¼åˆ›å»ºbufferï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">200</span><span class="o">];</span>
<span class="nc">ByteBuffer</span> <span class="n">buffer2</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">50</span><span class="o">);</span>
</code></pre></div></div>

<p>ä¸Šé¢è¿™ä¸ªåˆ›å»ºäº†ä¸€ä¸ªbufferï¼Œposition=10ï¼Œlimit=50ï¼Œcapacity=200ã€‚è™½ç„¶çœ‹èµ·æ¥bufferåªèƒ½è®¿é—®è¿™ä¸ªæ•°ç»„çš„å­ä¸²ï¼Œä½†ä½ å¯ä»¥é€šè¿‡ array()  æ–¹æ³•è®¿é—®è¿™äº›æ”¯æ’‘æ•°ç»„ï¼ˆå°±æ˜¯byte[] array()  ï¼‰ã€‚å¹¶ä¸”hasArray()  è¿”å›trueã€‚ï¼ˆå½“ hasArray() è¿”å›trueï¼Œä½ éœ€è¦è°ƒç”¨arrayOffset() å¾—åˆ°æ•°ç»„é‡Œç¬¬ä¸€ä¸ªdata itemçš„offsetï¼‰</p>

<p>ä¾‹å­ï¼š</p>

<p><strong><em>Listing 6-2. Creating Byte-Oriented Buffers via Allocation and Wrapping</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BufferDemo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">ByteBuffer</span> <span class="n">buffer1</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">buffer1</span><span class="o">.</span><span class="na">hasArray</span><span class="o">())</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"buffer1 array: "</span> <span class="o">+</span> <span class="n">buffer1</span><span class="o">.</span><span class="na">array</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Buffer1 array offset: "</span> <span class="o">+</span>
 <span class="n">buffer1</span><span class="o">.</span><span class="na">arrayOffset</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Capacity: "</span> <span class="o">+</span> <span class="n">buffer1</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Limit: "</span> <span class="o">+</span> <span class="n">buffer1</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Position: "</span> <span class="o">+</span> <span class="n">buffer1</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Remaining: "</span> <span class="o">+</span> <span class="n">buffer1</span><span class="o">.</span><span class="na">remaining</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
 <span class="o">}</span>
 <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">200</span><span class="o">];</span>
 <span class="nc">ByteBuffer</span> <span class="n">buffer2</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
 <span class="n">buffer2</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">50</span><span class="o">);</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">buffer2</span><span class="o">.</span><span class="na">hasArray</span><span class="o">())</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"buffer2 array: "</span> <span class="o">+</span> <span class="n">buffer2</span><span class="o">.</span><span class="na">array</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Buffer2 array offset: "</span> <span class="o">+</span>
 <span class="n">buffer2</span><span class="o">.</span><span class="na">arrayOffset</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Capacity: "</span> <span class="o">+</span> <span class="n">buffer2</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Limit: "</span> <span class="o">+</span> <span class="n">buffer2</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Position: "</span> <span class="o">+</span> <span class="n">buffer2</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Remaining: "</span> <span class="o">+</span> <span class="n">buffer2</span><span class="o">.</span><span class="na">remaining</span><span class="o">());</span>
 <span class="o">}</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>ç¼–è¯‘è¿è¡Œï¼Œè¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>buffer1 array: [B@659e0bfd
Buffer1 array offset: 0
Capacity: 10
Limit: 10
Position: 0
Remaining: 10
buffer2 array: [B@2a139a55
Buffer2 array offset: 0
Capacity: 200
Limit: 60
Position: 10
Remaining: 50
</code></pre></div></div>

<p>é™¤äº†ç®¡ç†ä¿å­˜åœ¨å¤–éƒ¨æ•°ç»„çš„æ•°æ®å…ƒç´ å¤–ï¼ˆvia the wrap() æ–¹æ³•ï¼‰ï¼Œbufferä¹Ÿèƒ½ç®¡ç†ä¿å­˜åœ¨å…¶ä»–buffersçš„æ•°æ®ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªbufferç®¡ç†å¦ä¸€ä¸ªbufferçš„dataï¼Œè¢«åˆ›å»ºçš„bufferè¢«è®¤ä¸ºæ˜¯<em>view buffer</em>ã€‚åœ¨ä¸¤ä¸ªbufferä¸­æ‰€åšçš„æ›´æ”¹éƒ½åæ˜ åœ¨å¦ä¸€ä¸ªbufferä¸­ã€‚</p>

<p>View buffers ç”¨Bufferå­ç±»çš„duplicate()æ–¹æ³•åˆ›å»ºã€‚äº§ç”Ÿçš„view bufferç›¸å½“äºåŸå§‹buffer; ä¸¤ä¸ªbufferå…±äº«ç›¸åŒçš„data itemsä¸”å®¹é‡ç›¸åŒã€‚ç„¶è€Œï¼Œæ¯ä¸ªbufferæœ‰å®ƒè‡ªå·±çš„ position, limit, and mark ã€‚å½“è¢«duplicated çš„bufferæ˜¯read-onlyæˆ–è€…directï¼Œview buffer ä¹Ÿæ˜¯read-onlyæˆ–è€…directã€‚</p>

<p>è€ƒè™‘ä»¥ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="nc">ByteBuffer</span> <span class="n">bufferView</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">duplicate</span><span class="o">();</span>
</code></pre></div></div>

<p>ä¸¤ä¸ªbufferå…±äº«arrayã€‚æ­¤æ—¶ï¼Œposition, limit, and (undefined) mark æ˜¯ä¸€æ ·çš„ã€‚ç„¶è€Œï¼Œè¿™äº›å±æ€§å¯ä»¥å½¼æ­¤ç‹¬ç«‹äºå¦ä¸€ä¸ªbufferã€‚</p>

<p>ä¹Ÿå¯ä»¥è°ƒç”¨ByteBufferâ€™s asxBuffer() åˆ›å»ºview buffersã€‚ä¾‹å¦‚ï¼ŒLongBuffer asLongBuffer() è¿”å›ä¸€ä¸ªview bufferå°†å­—èŠ‚bufferæ¦‚å¿µåŒ–ä¸ºé•¿æ•´å‹çš„bufferã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šRead-only view bufferså¯ä»¥è°ƒç”¨æ¯”å¦‚ByteBuffer asReadOnlyBuffer() çš„æ–¹æ³•åˆ›å»ºã€‚ä»»ä½•view bufferæ”¹å˜çš„å°è¯•å¯¼è‡´<code class="language-plaintext highlighter-rouge"> ReadOnlyBufferException </code>ã€‚ç„¶è€Œï¼ŒåŸå§‹bufferå†…å®¹ï¼ˆå‡è®¾ä¸æ˜¯åªè¯»ï¼‰å¯ä»¥å˜ï¼Œåªè¯»çš„view bufferå°†åæ˜ è¿™äº›å˜åŒ– ã€‚</p>

<h5 id="buffer-writing-and-reading">Buffer Writing and Reading</h5>

<p>ByteBuffer and the other primitive-type bufferç±»å£°æ˜äº†å‡ ä¸ªé‡è½½çš„ put() and get() æ–¹æ³•ç”¨äºå†™ data items å’Œä»bufferè¯» data items  ã€‚è¿™äº›æ–¹æ³•åœ¨éœ€è¦ç´¢å¼•å‚æ•°çš„æ—¶å€™æ˜¯ç»å¯¹çš„ä¸éœ€è¦ç´¢å¼•æ—¶æ˜¯ç›¸å¯¹çš„ã€‚</p>

<p>ä¾‹å¦‚ï¼ŒByteBufferå£°æ˜ç»å¯¹çš„ByteBuffer put(int index, byte b) æ–¹æ³•åœ¨ç´¢å¼•indexå­˜å‚¨byte bï¼Œä»¥åŠbyte get(int index) æ–¹æ³•è·å–indexä½ç½®çš„å­—èŠ‚ã€‚ä¹Ÿå£°æ˜äº†ç›¸å¯¹çš„ ByteBuffer put(byte b)  æ–¹æ³•åœ¨å½“å‰bufferçš„positionå­˜bç„¶åå¢åŠ positionï¼Œä»¥åŠç›¸å¯¹çš„byte get() è·å–bufferå½“å‰positionçš„å­—èŠ‚å¹¶ä¸”å¢åŠ å½“å‰positionã€‚</p>

<p>ç»å¯¹çš„put() and get()æ–¹æ³•å½“ç´¢å¼•æ˜¯è´Ÿæˆ–è¶…å‡ºæˆ–è€…ç­‰äºlimitæŠ›å‡ºIndexOutOfBoundsException ã€‚ç›¸å¯¹çš„ put()  åœ¨å½“å‰positionå¤§äºæˆ–ç­‰äºlimitæ—¶æŠ›å‡º<code class="language-plaintext highlighter-rouge">java.nio.BufferOverflowException </code>ï¼Œç›¸å¯¹çš„get() æ–¹æ³•åœ¨å½“å‰positionå¤§äºæˆ–ç­‰äºlimitæ—¶æŠ›å‡º<code class="language-plaintext highlighter-rouge">java.nio.BufferUnderflowException </code>ã€‚å¦å¤–ï¼Œä¸¤ç§put()æ–¹æ³•éƒ½åœ¨åªè¯»æ—¶æŠ›å‡º<code class="language-plaintext highlighter-rouge"> ReadOnlyBufferException </code>ã€‚</p>

<p>ä¾‹å­ï¼š</p>

<p><strong><em>Listing 6-3. Writing Bytes to and Reading Them from a Buffer</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BufferDemo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">7</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Capacity = "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Limit = "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Position = "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Remaining = "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">());</span>
 <span class="n">buffer</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">10</span><span class="o">).</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">20</span><span class="o">).</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">30</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Capacity = "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Limit = "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Position = "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Remaining = "</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">());</span>
 <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç¼–è¯‘è¿è¡Œè¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Capacity = 7
Limit = 7
Position = 0
Remaining = 7
Capacity = 7
Limit = 7
Position = 3
Remaining = 4
10
20
30

</code></pre></div></div>

<p>å¦‚å›¾ï¼š</p>

<p><img src="/assets/img/1533118585640.png" alt="1533118585640" /></p>

<p>éšåçš„è°ƒç”¨get() æ–¹æ³•æ²¡æœ‰æ”¹å˜positionï¼Œè¿˜æ˜¯3ã€‚</p>

<p><strong>æŠ€å·§</strong>ï¼šä¸ºè·å¾—æœ€é«˜æ•ˆç‡ï¼Œä½ å¯ä»¥æ‰§è¡Œæ‰¹é‡æ•°æ®ä¼ è¾“ï¼Œä½¿ç”¨ByteBuffer put(byte[] src), ByteBuffer put(byte[] src, int offset, int length), ByteBuffer get(byte[] dst), and ByteBuffer get(byte[] dst, int offset, int length)  æ¥è¯»å†™å­—èŠ‚æ•°ç»„ã€‚</p>

<h5 id="flipping-buffers">Flipping Buffers</h5>

<p>åœ¨å¡«å……bufferåï¼Œä½ å¿…é¡»å‡†å¤‡å®ƒç”¨äºé€šè¿‡channelæ’å¹²ã€‚æ‚¨é€šè¿‡ç¼“å†²åŒºæ—¶ï¼Œé€šé“å°†è®¿é—®æœªå®šä¹‰çš„æ•°æ®ï¼Œè¶…å‡ºå½“å‰ä½ç½®ã€‚</p>

<p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ å¯ä»¥reset positionä¸º0ï¼Œä½†æ˜¯channelæ€ä¹ˆçŸ¥é“ä»€ä¹ˆæ—¶å€™åˆ°è¾¾æ’å…¥çš„æ•°æ®çš„æœ«å°¾å‘¢ï¼Ÿè§£å†³åŠæ³•æ˜¯ä½¿ç”¨limitå±æ€§ï¼Œå®ƒè¡¨æ˜äº†bufferæ´»åŠ¨åŒºé—´çš„endã€‚åŸºæœ¬ä¸Šï¼Œè®¾ç½®limitåˆ°å½“å‰positionï¼Œç„¶åé‡ç½®current positionä¸º0ã€‚</p>

<p>ä½ å¯ä»¥æ‰§è¡Œä»¥ä¸‹ä»£ç å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œä¹Ÿä¼šæ¸…é™¤æ‰€æœ‰å®šä¹‰çš„markï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">()).</span><span class="na">position</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</code></pre></div></div>

<p>ç„¶è€Œï¼Œæœ‰ä¸€ä¸ªæ›´ç®€ä¾¿çš„åšæ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
</code></pre></div></div>

<p>ä¸¤ç§æƒ…å†µï¼Œbufferéƒ½å‡†å¤‡å¥½å»æ’å¹²äº†ã€‚</p>

<p>å‡è®¾<code class="language-plaintext highlighter-rouge">buffer.flip() </code>åœ¨listing 6-3æœ€åæ‰§è¡Œï¼Œfigure 6-3 è¡¨æ˜äº† flip() ä¹‹åçš„bufferçŠ¶æ€ï¼š</p>

<p><img src="/assets/img/1533175926471.png" alt="1533175926471" /></p>

<p>è°ƒç”¨ buffer.remaining() è¿”å›3ã€‚è¿™ä¸ªå€¼è¡¨æ˜äº†èƒ½ç”¨äºæ’å¹²çš„å­—èŠ‚æ•°ã€‚</p>

<p>Listing 6-4 ç»™å‡ºå¦ä¸€ä¸ªbuffer-flippingç¤ºèŒƒï¼Œä½¿ç”¨äº†character bufferã€‚</p>

<p><strong><em>Listing 6-4. Writing Characters to and Reading Them from a Character Buffer</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.CharBuffer</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BufferDemo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">String</span><span class="o">[]</span> <span class="n">poem</span> <span class="o">=</span>
 <span class="o">{</span>
 <span class="s">"Roses are red"</span><span class="o">,</span>
 <span class="s">"Violets are blue"</span><span class="o">,</span>
 <span class="s">"Sugar is sweet"</span><span class="o">,</span>
 <span class="s">"And so are you."</span>
 <span class="o">};</span>
 <span class="nc">CharBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">CharBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
 <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">poem</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
 <span class="o">{</span>
 <span class="c1">// Fill the buffer.</span>
 <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">poem</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span>
 <span class="n">buffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">poem</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">charAt</span><span class="o">(</span><span class="n">j</span><span class="o">));</span>
 <span class="c1">// Flip the buffer so that its contents can be read.</span>
 <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
 <span class="c1">// Drain the buffer.</span>
 <span class="k">while</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
 <span class="c1">// Empty the buffer to prevent BufferOverflowException.</span>
 <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
 <span class="o">}</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>è¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Roses are red
Violets are blue
Sugar is sweet
And so are you.
</code></pre></div></div>

<p><strong>æ³¨æ„</strong>ï¼šrewind()å’Œ flip() ç±»ä¼¼ä½†æ˜¯å¿½ç•¥limitã€‚å¹¶ä¸”ï¼Œè°ƒç”¨flip()2æ¬¡ä¹Ÿä¸ä¼šå¾—åˆ°bufferçš„åˆå§‹çŠ¶æ€ï¼Œè€Œæ˜¯sizeä¸º0ã€‚è°ƒç”¨put() æŠ›å‡º<code class="language-plaintext highlighter-rouge">BufferOverflowException </code>ï¼Œè°ƒç”¨get()æŠ›å‡º<code class="language-plaintext highlighter-rouge">BufferUnderflowException </code>ï¼Œget(int i)æŠ›å‡º<code class="language-plaintext highlighter-rouge"> IndexOutOfBoundsException </code>ã€‚</p>

<h5 id="marking-buffers">Marking Buffers</h5>

<p>ä½¿ç”¨mark() æ ‡è®°bufferï¼Œéšåè°ƒç”¨reset()è¿”å›æ ‡è®°ä½ç½®ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ æ‰§è¡Œäº†<code class="language-plaintext highlighter-rouge">ByteBuffer buffer = ByteBuffer.allocate(7);, </code>ç„¶å<code class="language-plaintext highlighter-rouge">buffer.put((byte) 10).put((byte) 20).put((byte) 30).put((byte) 40);, </code>ç„¶å<code class="language-plaintext highlighter-rouge">buffer.limit(4);. </code>ã€‚å½“å‰positionå’Œlimitéƒ½ä¸º4ã€‚</p>

<p>ç»§ç»­ï¼Œå‡è®¾ä½ æ‰§è¡Œäº†<code class="language-plaintext highlighter-rouge"> buffer.position(1).mark(). position(3) </code>ã€‚6-4æ˜¾ç¤ºäº†bufferçš„çŠ¶æ€ï¼š</p>

<p><img src="/assets/img/1533177587773.png" alt="1533177587773" /></p>

<p>å¦‚æœä½ æŠŠbufferå‘åˆ°ä¸€ä¸ªchannelï¼Œå­—èŠ‚40ä¼šè¢«å‘é€ï¼ˆå› ä¸ºposition(3) ç°åœ¨çš„positionæ˜¯3ï¼‰ï¼Œç„¶åpositionä¼šæåˆ°4ã€‚å¦‚æœä½ æ¥ç€æ‰§è¡Œbuffer.reset() ï¼›ç„¶åæŠŠbufferå‘é€ç»™channelï¼Œpositionä¼šè¢«è®¾ç½®åˆ°mark (1) ï¼Œbytes 20, 30, and 40  ï¼ˆæ‰€æœ‰ä»å½“å‰ä½ç½®åˆ°limitçš„å­—èŠ‚ï¼‰ï¼Œä¼šè¢«å‘åˆ°channelï¼ˆä»¥è¿™ä¸ªé¡ºåºï¼‰ã€‚</p>

<p>ä»£ç ï¼š</p>

<p><strong><em>Listing 6-5. Marking the Current Buffer Position and Resetting the Current Position to the Marked Position</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BufferDemo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">7</span><span class="o">);</span>
 <span class="n">buffer</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">10</span><span class="o">).</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">20</span><span class="o">).</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">30</span><span class="o">).</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">40</span><span class="o">);</span>
 <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
 <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">mark</span><span class="o">().</span><span class="na">position</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
 <span class="n">buffer</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
 <span class="k">while</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>è¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>40
20
30
40
</code></pre></div></div>

<p><strong>è­¦å‘Š</strong>ï¼šä¸è¦æ··æ·†reset() å’Œclear() ã€‚clear() æ–¹æ³•æ ‡è®°bufferä¸ºç©ºè€Œ reset() æ”¹å˜bufferçš„å½“å‰positionåˆ°å…ˆå‰markçš„ä½ç½®ï¼Œæˆ–è€…æ²¡æ ‡è®°å°±æŠ›å‡º<code class="language-plaintext highlighter-rouge"> InvalidMarkException </code>ã€‚</p>

<h5 id="buffer-subclass-operations">Buffer Subclass Operations</h5>

<p>ByteBuffer and the other primitive-type bufferç±»å£°æ˜äº†compact() æ–¹æ³•ï¼Œå¯¹å‹ç¼©bufferå¾ˆæœ‰ç”¨ï¼Œé€šè¿‡å¤åˆ¶å½“å‰positionåˆ°limitçš„æ‰€æœ‰bytesåˆ°bufferçš„å¼€å¤´ã€‚index p = position() çš„å­—èŠ‚è¢«å¤åˆ¶åˆ°index 0ï¼Œ index p + 1 çš„å­—èŠ‚å¤åˆ¶åˆ°index 1ï¼Œâ€¦ç›´åˆ° index limit() - 1 è¢«å¤åˆ¶åˆ°index n = limit() - 1 - p ã€‚bufferçš„å½“å‰positionè¢«è®¾ç½®ä¸ºn+1ï¼Œlimitè¢«è®¾ç½®ä¸ºå®¹é‡ã€‚markè¢«å®šä¹‰å°±ä¸¢å¼ƒã€‚</p>

<p>ä½ ä»ä¸€ä¸ªbufferå†™æ•°æ®åè°ƒç”¨compactï¼Œæ¥è§£å†³ä¸æ˜¯æ‰€æœ‰bufferå†…å®¹éƒ½è¢«å†™å…¥çš„åœºæ™¯ã€‚è€ƒè™‘ä¸‹é¢ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>buf.clear(); // Prepare buffer for use
while (in.read(buf) != -1)
{
 buf.flip(); // Prepare buffer for draining.
 out.write(buf); // Write the buffer.
 buf.compact(); // Do this in case of a partial write.
}

</code></pre></div></div>

<p>compact() æ–¹æ³•è°ƒç”¨ç§»åŠ¨æ²¡æœ‰è¢«å†™çš„bufferæ•°æ®åˆ°bufferå¼€å¤´ï¼Œç„¶åä¸‹æ¬¡read()å¯ä»¥æ·»åŠ è¯»æ•°æ®åˆ°bufferçš„æ•°æ®ï¼Œè€Œä¸æ˜¯é‡å†™ã€‚</p>

<p>ä½ å¶å°”å¯èƒ½éœ€è¦æ¯”è¾ƒbufferçš„ç­‰åŒæˆ–é¡ºåºã€‚æ‰€æœ‰çš„bufferé™¤äº†<code class="language-plaintext highlighter-rouge"> MappedByteBuffer </code>éƒ½é‡å†™äº†equals() and compareTo() æ¥æ‰§è¡Œæ¯”è¾ƒâ€”â€”â€”MappedByteBufferç»§æ‰¿ByteBufferæ²¡é‡å†™ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>System.out.println(bytBuf1.equals(bytBuf2));
System.out.println(bytBuf1.compareTo(bytBuf2));
</code></pre></div></div>

<p>equals()ï¼Œ same element type ï¼Œ same number of remaining elements ï¼Œtwo sequences of remaining elements ï¼Œä¸å–å†³äºstarting positionsã€‚</p>

<p>compareTo() ï¼Œæ¯”è¾ƒé¡ºåºï¼Œæ¯”è¾ƒsequences of remaining elements lexicographically ï¼Œä¸è€ƒè™‘starting position ã€‚</p>

<h5 id="byte-ordering">Byte Ordering</h5>

<p>Nonbyte primitive types except for Boolean ç”±å‡ ä¸ªå­—èŠ‚ç»„æˆï¼šä¸€ä¸ªå­—ç¬¦æˆ–short integerå 2ä¸ªå­—èŠ‚ï¼Œ32-bit integeræˆ–è€…ä¸€ä¸ªæµ®ç‚¹å€¼å 4å­—èŠ‚ï¼Œlong integeræˆ–åŒç²¾åº¦æµ®ç‚¹å€¼å 8å­—èŠ‚ã€‚è¿™äº›å¤šå­—èŠ‚ç±»å‹çš„å€¼è¢«å­˜åœ¨è¿ç»­çš„å†…å­˜ä½ç½®çš„åºåˆ—ã€‚ç„¶è€Œï¼Œè¿™äº›å­—èŠ‚çš„æ’åºå¯èƒ½å› æ“ä½œç³»ç»Ÿè€Œå¼‚ã€‚</p>

<p>ä¾‹å¦‚ï¼Œ32-bit long integer 0x10203040 ã€‚This valueâ€™s four bytes could be stored in memory (from low address to high address) as 10, 20, 30, 40 ï¼›è¿™ç§ç¼–æ’æ–¹å¼å« big endian order (the most-significant byte, the â€œbigâ€ end, is stored at the lowest address) ã€‚ä¹Ÿå¯ä»¥ç”¨40, 30, 20, 10 å­˜ï¼›å«little endian order (the least-significant byte, the â€œlittleâ€ end, is stored at the lowest address)ã€‚</p>

<p>Javaæä¾›<code class="language-plaintext highlighter-rouge"> java.nio.ByteOrder </code> ç±»å¸®ä½ å¤„ç†å­—èŠ‚æ’åºåœ¨å¤šå­—èŠ‚å€¼äº’å†™çš„æ—¶å€™ã€‚å£°æ˜äº†<code class="language-plaintext highlighter-rouge">ByteOrder nativeOrder() </code>è¿”å›æ“ä½œç³»ç»Ÿçš„ByteOrder å®ä¾‹ã€‚è¿™ä¸ªå®ä¾‹æ˜¯ ByteOrderâ€™s BIG_ENDIAN and LITTLE_ENDIAN constants çš„å…¶ä¸­ä¹‹ä¸€ï¼Œæ²¡æœ‰å…¶ä»–çš„ï¼Œä½ å¯ä»¥æ¯”è¾ƒ nativeOrder()çš„è¿”å›å€¼å’Œå¸¸æ•°ã€‚</p>

<p>å¤šå­—èŠ‚ç±»ä¹Ÿæœ‰æä¾›ã€‚</p>

<p>order() è¿”å›çš„ ByteOrder å¯èƒ½è€ƒè™‘bufferçš„åˆ›å»ºæ–¹å¼ã€‚view bufferçš„orderä¸èƒ½è¢«å˜ã€‚</p>

<p>ByteBuffer ä¸åŒä¸å¤šå­—èŠ‚ç±»åœ¨å­—èŠ‚æ’åºä¸Šã€‚é»˜è®¤å­—èŠ‚æ’åºæ€»æ˜¯ big endian ï¼Œå³ä½¿æ“ä½œç³»ç»Ÿæ˜¯little endian ã€‚å› ä¸ºJavaâ€™s default byte order æ˜¯ big endian ï¼Œè®©ç±»æ–‡ä»¶å’Œåºåˆ—åŒ–çš„å¯¹è±¡å­˜å‚¨æ•°æ®ä¸€è‡´ã€‚</p>

<p>å£°æ˜äº† ByteBuffer order(ByteOrder bo) æ¥æ”¹å˜å­—èŠ‚æ’åºã€‚</p>

<p>æ”¹å˜çš„å­—èŠ‚æ’åºå¯¹ä¾‹å¦‚ LongBuffer asLongBuffer() å½¢æˆçš„view bufferæ˜¯å¯è§çš„ã€‚</p>

<h5 id="direct-byte-buffers">Direct Byte Buffers</h5>

<p>ä¸åƒå¤šå­—èŠ‚buffersï¼Œ byte buffers å¯ä»¥ä½œä¸ºchannel-based I/O çš„sourceså’Œtargetsã€‚è¿™ä¸åº”è¯¥æ˜¯ä¸€ä¸ªæƒŠå–œå› ä¸ºæ“ä½œç³»ç»Ÿåœ¨å†…å­˜åŒºåŸŸæ‰§è¡ŒIOæ˜¯è¿ç»­çš„8å­—èŠ‚çš„åºåˆ—ï¼ˆä¸æ˜¯æµ®ç‚¹å’Œ32-bit integerï¼‰ã€‚</p>

<p>æ“ä½œç³»ç»Ÿå¯ä»¥ç›´æ¥è®¿é—®è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚ä¾‹å¦‚ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥ç›´æ¥è®¿é—®JVMè¿›ç¨‹åœ°å€ç©ºé—´æ¥æ‰§è¡ŒåŸºäºå­—èŠ‚æ•°ç»„çš„æ•°æ®ä¼ è¾“æ“ä½œã€‚ç„¶è€Œï¼ŒJVMå¯èƒ½ä¸ä¼šè¿ç»­åœ°å­˜å‚¨å­—èŠ‚æ•°ç»„æˆ–è€…å®ƒçš„åƒåœ¾æ”¶é›†å™¨æŠŠå­—èŠ‚æ•°ç»„ç§»åŠ¨åˆ°å¦ä¸€ä¸ªä½ç½®ã€‚ç”±äºè¿™äº›é™åˆ¶ï¼Œ direct byte buffers è¢«åˆ›å»ºã€‚</p>

<p><strong><em>direct byte buffer</em></strong>ï¼Œæ˜¯ä¸€ä¸ªbyte buffer ï¼Œä¸ channels å’Œnative code äº¤äº’æ¥æ‰§è¡ŒI/Oã€‚direct byte buffer å°è¯•åœ¨å†…å­˜åŒºåŸŸå‚¨å­˜å­—èŠ‚å…ƒç´ ï¼Œchannelé€šè¿‡native codeç”¨å­—èŠ‚å…ƒç´ æ¥æ‰§è¡Œ direct (raw) access ï¼Œå‘Šè¯‰æ“ä½œç³»ç»Ÿç›´æ¥æ’å¹²/å¡«å……å†…å­˜åŒºåŸŸã€‚</p>

<p>Direct byte buffersæ˜¯JVMä¸Šæœ€æœ‰æ•ˆçš„æ‰§è¡ŒI/Oçš„æ–¹æ³•ã€‚å°½ç®¡ä½ ä¹Ÿå¯ä»¥ä¼ é€’nondirect byte buffersç»™é€šé“ï¼Œå¯èƒ½äº§ç”Ÿæ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºnondirect byte buffersä¸æ€»æ˜¯èƒ½å¤Ÿå……å½“native I/O operationsçš„targetã€‚</p>

<p>å½“ä¼ é€’äº†ä¸€ä¸ª nondirect byte buffer ï¼Œchannelå¯èƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„direct byte buffer ï¼Œå¤åˆ¶nondirect byte bufferçš„å†…å®¹åˆ°direct byte bufferï¼Œåœ¨ä¸´æ—¶çš„direct byte bufferä¸Šæ‰§è¡ŒI/Oæ“ä½œï¼Œå¹¶ä¸”å¤åˆ¶ä¸´æ—¶ direct byte bufferçš„å†…å®¹åˆ°nondirect byte buffer ã€‚ä¸´æ—¶direct byte bufferä¼šè¢«åƒåœ¾æ”¶é›†ã€‚</p>

<p>è™½ç„¶ä¼˜åŒ–äº†I/Oï¼Œåˆ›å»º direct byte bufferå¯èƒ½å¾ˆæ˜‚è´µå› ä¸ºåœ¨JVMå †ä¹‹å¤–çš„å†…å­˜éœ€è¦ç”±æ“ä½œç³»ç»Ÿåˆ†é…ï¼Œå»ºç«‹/æ‹†é™¤è¿™ä¸ªå†…å­˜ä¼šæ¯”è¿™ä¸ªbufferåœ¨å †å†…çš„æ—¶é—´æ›´é•¿ã€‚</p>

<p>é€šè¿‡<code class="language-plaintext highlighter-rouge">ByteBufferâ€™s allocateDirect() </code>å¾—åˆ°direct byte bufferã€‚</p>

<h4 id="exercise-4">Exercise</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The following exercises are designed to test your understanding of Chapter 6â€™s content:
1. What is a buffer?
2. Identify a bufferâ€™s four properties.
3. What happens when you invoke Bufferâ€™s array() method on a
buffer backed by a read-only array?
4. What happens when you invoke Bufferâ€™s flip() method on a buffer?
5. What happens when you invoke Bufferâ€™s reset() method on a
buffer where a mark has not been set?
6. True or false: Buffers are thread-safe.
7. Identify the classes that extend the abstract Buffer class.
8. How do you create a byte buffer?
9. Define view buffer.
10. How is a view buffer created?
11. How do you create a read-only view buffer?
12. Identify ByteBufferâ€™s methods for storing a single byte in a byte
buffer and fetching a single byte from a byte buffer.
13. What causes BufferOverflowException or
BufferUnderflowException to occur?
14. What is the equivalent of executing buffer.flip();?
15. True or false: Calling flip() twice returns you to the original state.
16. What is the difference between Bufferâ€™s clear() and reset()
methods?
17. What does ByteBufferâ€™s compact() method accomplish?
18. What is the purpose of the ByteOrder class?
19. Define direct byte buffer.
20. How do you obtain a direct byte buffer?
21. Why could it be expensive to create a direct byte buffer?
22. Create a ViewBufferDemo application that populates a byte buffer
with the values 0, 0x6e, 0, 0x69, 0, 0x6f; creates a character view
buffer; and iterates over the view buffer, outputting each character.
</code></pre></div></div>

<h4 id="summary-5">Summary</h4>

<p>A buffer is an NIO object that stores a fixed amount of data to be sent to or received from an I/O service. It sits between an application and a channel that writes the buffered data to the service or reads the data from the service and deposits it into the buffer.</p>

<p>Buffers possess capacity, limit, position, and mark properties. These four properties are related as follows: 0 &lt;= mark &lt;= position &lt;= limit &lt;= capacity.</p>

<p>Buffers are implemented by abstract classes that derive from the abstract Buffer class. These classes include ByteBuffer, CharBuffer, DoubleBuffer, FloatBuffer, IntBuffer, LongBuffer, and ShortBuffer. Furthermore, ByteBuffer is subclassed by the abstract MappedByteBuffer class.</p>

<p>In this chapter, you learned how to create buffers (including view buffers), write and read buffer contents, flip buffers, mark buffers, and perform additional operations on buffers such as compaction. You also learned about byte ordering and direct byte buffers.</p>

<h3 id="chapter-7-channels">Chapter 7 Channels</h3>

<p>ChannelååŒbufferæ‰§è¡Œé«˜æ€§èƒ½I/Oã€‚è¿™ç« ä»‹ç»channelç±»å‹ã€‚</p>

<h4 id="introducing-channels">Introducing Channels</h4>

<p><em>channel</em>æ˜¯ä¸€ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªåˆ° hardware device, a file, a network socket, an application component, or another entity(èƒ½è¯»å†™å’Œæ‰§è¡Œå…¶ä»–I/Oæ“ä½œ)çš„ä¸€ä¸ª open connection ã€‚channelsæ•ˆç‡åœ°åœ¨byte  buffers å’Œæ“ä½œç³»ç»Ÿ I/O service sources or destinationsä¹‹é—´ä¼ é€’æ•°æ®ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šChannelsæ˜¯è®¿é—® I/O services çš„gateways ã€‚Channelsä½¿ç”¨byte buffersä½œä¸ºç«¯ç‚¹ä¼ é€’å’Œæ¥æ”¶æ•°æ®ã€‚</p>

<p>åœ¨æ“ä½œç³»ç»Ÿæ–‡ä»¶å¥æŸ„ï¼ˆ file handle ï¼ŒWindowsï¼‰/æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptor ï¼‰ ä¸ Channelä¹‹é—´æ€»å­˜åœ¨ä¸€ä¸€å¯¹åº”ã€‚å½“ä½ åœ¨file contextä½¿ç”¨channelï¼Œchannelæ€»æ˜¯è¢«è¿æ¥åˆ°ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å°½ç®¡channelæ¯” file descriptorsæ›´æŠ½è±¡ï¼Œä»–ä»¬ä»ç„¶èƒ½å¤Ÿå¯¹æ“ä½œç³»ç»Ÿçš„I/Oè®¾æ–½è¿›è¡Œå»ºæ¨¡ã€‚</p>

<h4 id="channel-and-its-children">Channel and Its Children</h4>

<p>é€šè¿‡<code class="language-plaintext highlighter-rouge">java.nio.channels</code> and <code class="language-plaintext highlighter-rouge">java.nio.channels.spi </code>æä¾›channelæ”¯æŒã€‚åº”ç”¨ç¨‹åºä¸ä½äºå‰åŒ…ä¸­çš„ç±»å‹è¿›è¡Œäº¤äº’ ï¼›å®šä¹‰æ–°çš„selector providersçš„å¼€å‘äººå‘˜ä½¿ç”¨ååŒ…ã€‚</p>

<p>æ‰€æœ‰çš„channelséƒ½æ˜¯æœ€ç»ˆå®ç°äº†<code class="language-plaintext highlighter-rouge">java.nio.channels.Channel </code>æ¥å£çš„ç±»çš„å®ä¾‹ã€‚Channelå£°æ˜ä¸‹é¢çš„æ–¹æ³•ï¼š</p>

<ul>
  <li>void close():  å…³é—­channelã€‚å½“channelå·²ç»å…³é—­ï¼Œè°ƒç”¨close()æ— æ•ˆã€‚å¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹å·²ç»è°ƒç”¨äº†close()ï¼Œä¸€ä¸ªæ–°çš„close()è°ƒç”¨ä¼šåœ¨ç¬¬ä¸€ä¸ªè°ƒç”¨ç»“æŸä¹‹å‰é˜»å¡ä½ï¼Œä¹‹å close() æ²¡æœ‰æ•ˆæœåœ°è¿”å›ã€‚I/Oé”™è¯¯æŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.io.IOException</code>ã€‚åœ¨channelå…³é—­åï¼Œä»»ä½•åœ¨å®ƒä¸Šé¢å°è¯•I/Oæ“ä½œéƒ½ä¼šæŠ›å‡º<code class="language-plaintext highlighter-rouge">java.nio. channels.ClosedChannelException</code>ã€‚</li>
  <li>boolean isOpen():  è¿”å›channelçš„å¼€é—­çŠ¶æ€ã€‚</li>
</ul>

<p>è¿™äº›æ–¹æ³•è¡¨æ˜åªæœ‰ä¸¤ä¸ªæ“ä½œæ˜¯å¯¹æ‰€æœ‰channelé€šç”¨ï¼šå…³é—­channelå’Œç¡®å®šæ‰“å¼€æˆ–å…³é—­çŠ¶æ€ã€‚ä¸ºäº†æ”¯æŒI/Oï¼Œchannelè¢«æ‰©å±•ä¸º<code class="language-plaintext highlighter-rouge">java.nio.channels. WritableByteChannel </code>å’Œ<code class="language-plaintext highlighter-rouge">java.nio.channels.ReadableByteChannel </code>æ¥å£ï¼š</p>

<ul>
  <li>WritableByteChannel å£°æ˜äº†ä¸€ä¸ªæŠ½è±¡çš„int write(ByteBuffer buffer) æ–¹æ³•ï¼Œä»bufferåˆ°ä¸€ä¸ªåºåˆ—çš„å­—èŠ‚åˆ°å½“å‰channelã€‚è¿”å›å®é™…è¢«å†™çš„å­—èŠ‚æ•°é‡ã€‚å½“channelæ²¡æœ‰å¼€æ”¾å†™æŠ›å‡º<code class="language-plaintext highlighter-rouge">java.nio.channels.NonWritableChannelException</code>ï¼Œchannelå…³é—­äº†æŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.nio. channels.ClosedChannelException</code>ï¼Œå†™çš„æ—¶å€™å¦ä¸€ä¸ªçº¿ç¨‹å…³é—­äº†channelæŠ›å‡º<code class="language-plaintext highlighter-rouge">java.nio.channels.AsynchronousCloseException</code>ï¼Œå½“å†™æ“ä½œæ‰§è¡Œçš„æ—¶å€™å½“å‰çº¿ç¨‹è¢«å¦ä¸€ä¸ªçº¿ç¨‹æ‰“æ–­äº†ï¼ˆä»è€Œå…³é—­é€šé“å¹¶è®¾ç½®å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼‰æŠ›å‡º<code class="language-plaintext highlighter-rouge">java.nio.channels.ClosedByInterruptException</code>ï¼ŒI/O error æŠ›å‡º<code class="language-plaintext highlighter-rouge">IOException</code>ã€‚</li>
  <li>ReadableByteChannel å£°æ˜äº†æŠ½è±¡read(ByteBuffer buffer) æ–¹æ³•ï¼Œä»å½“å‰channelè¯»å–å­—èŠ‚åˆ°bufferã€‚è¿”å›å®é™…è¯»å–çš„å­—èŠ‚æ•°ï¼ˆæ²¡æœ‰å­—èŠ‚å¯è¯»è¿”å›-1ï¼‰ã€‚å½“channelæ²¡å¼€æ”¾è¯»æŠ›å‡º<code class="language-plaintext highlighter-rouge">java.nio.channels. NonReadableChannelException</code>ï¼Œchannelå…³é—­äº†æŠ›å‡º<code class="language-plaintext highlighter-rouge">ClosedChannelException</code>ï¼Œè¯»çš„æ—¶å€™å¦ä¸€ä¸ªçº¿ç¨‹å…³é—­äº†channelæŠ›å‡º<code class="language-plaintext highlighter-rouge">java.nio.channels.AsynchronousCloseException</code>ï¼Œå½“è¯»æ“ä½œæ‰§è¡Œçš„æ—¶å€™å½“å‰çº¿ç¨‹è¢«å¦ä¸€ä¸ªçº¿ç¨‹æ‰“æ–­äº†æŠ›å‡º<code class="language-plaintext highlighter-rouge">java.nio.channels.ClosedByInterruptException</code>,ä»è€Œå…³é—­é€šé“å¹¶è®¾ç½®å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€;I/O error æŠ›å‡º<code class="language-plaintext highlighter-rouge">IOException</code>ã€‚</li>
</ul>

<p><strong>æ³¨æ„</strong>ï¼šä¸€ä¸ªåªå®ç°äº†WritableByteChannel or ReadableByteChannelçš„channelç±»æ˜¯å•å‘çš„ã€‚ä»å¯å†™çš„byte channelè¯»æˆ–è€…ä»å¯è¯»çš„byte channelå†™éƒ½å¯¼è‡´å¼‚å¸¸æŠ›å‡ºã€‚</p>

<p>ä½ å¯ä»¥ä½¿ç”¨ instanceof  æ“ä½œç¬¦ç¡®å®šä¸€ä¸ªchannelå®ä¾‹å®ç°äº†é‚£ä¸ªæ¥å£ã€‚å› ä¸ºæµ‹è¯•è¿™ä¸¤ä¸ªæ¥å£å¾ˆå°´å°¬ï¼ŒJavaæä¾›<code class="language-plaintext highlighter-rouge"> java.nio.channels.ByteChannel </code>æ¥å£ï¼Œæ˜¯ä¸€ä¸ªç©ºçš„æ ‡è®°æ¥å£ç»§æ‰¿äº†è¿™ä¸¤ä¸ªæ¥å£ã€‚å½“ä½ è¦äº†è§£ä¸€ä¸ªchannelæ˜¯ä¸æ˜¯åŒå‘çš„ï¼Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">channel instanceof ByteChannel </code>ä¼šå¾ˆæ–¹ä¾¿ã€‚</p>

<p>Channelä¹Ÿè¢«æ‰©å±•ä¸º<code class="language-plaintext highlighter-rouge">java.nio.channels.InterruptibleChannel </code>æ¥å£ã€‚ InterruptibleChannelæ¥å£æè¿°äº†ä¸€ä¸ªå¯ä»¥è¢«å¼‚æ­¥closed and interrupted çš„channelã€‚æ¥å£é‡å†™äº†çˆ¶æ¥å£close() æ–¹æ³•çš„headerï¼Œè¡¨ç¤ºäº†è¿™ä¸ªæ–¹æ³•çš„channelçº¦æŸçš„é™„åŠ è§„å®šï¼šä»»ä½•åœ¨è¿™ä¸ªchannelçº¿ç¨‹çš„I/Oæ“ä½œè¢«é˜»å¡éƒ½ä¼šæ”¶åˆ°<code class="language-plaintext highlighter-rouge">AsynchronousCloseException </code>ï¼ˆIOException çš„æ´¾ç”Ÿï¼‰ã€‚</p>

<p>å®ç°è¿™ä¸ªæ¥å£çš„channelå¯å¼‚æ­¥<em>closeable</em>ï¼šå½“ä¸€ä¸ªçº¿ç¨‹å¸¦ä¸€ä¸ªå¯ä¸­æ–­channelä¸Šåœ¨I/Oæ“ä½œé˜»å¡äº†ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è°ƒç”¨channelçš„close()æ–¹æ³•ã€‚è¿™å¯¼è‡´è¢«é˜»å¡çš„çº¿ç¨‹æ”¶åˆ°ä¸€ä¸ªè¢«æŠ›å‡ºçš„<code class="language-plaintext highlighter-rouge"> AsynchronousCloseException </code>å®ä¾‹ã€‚</p>

<p>å®ç°è¿™ä¸ªæ¥å£çš„channelä¹Ÿæ˜¯<em>interruptible</em>ï¼šå½“ä¸€ä¸ªçº¿ç¨‹å¸¦ä¸€ä¸ªå¯ä¸­æ–­channelä¸Šåœ¨I/Oæ“ä½œé˜»å¡äº†ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è°ƒç”¨channelçš„interrupt()æ–¹æ³•ã€‚è¿™æ ·ä¼šä½¿channelå…³é—­ï¼Œè¢«é˜»å¡çš„çº¿ç¨‹æ”¶åˆ°<code class="language-plaintext highlighter-rouge">ClosedByInterruptException </code>å®ä¾‹ï¼Œå¹¶æœ‰å®ƒçš„nterrupt status set ã€‚ï¼ˆå½“ä¸€ä¸ªçº¿ç¨‹çš„ interrupt status è¢«è®¾ç½®ï¼Œå¹¶ä¸”åœ¨channelä¸Šè°ƒç”¨é˜»å¡çš„I/Oæ“ä½œ ï¼Œchannelè¢«å…³é—­ï¼Œçº¿ç¨‹é©¬ä¸Šæ”¶åˆ°<code class="language-plaintext highlighter-rouge">ClosedByInterruptException </code>å®ä¾‹ï¼›å®ƒçš„ä¸­æ–­çŠ¶æ€å°†ä¿æŒè®¾ç½® ï¼‰</p>

<p>NIOçš„è®¾è®¡è€…å½“é˜»å¡çº¿ç¨‹è¢«æ‰“æ–­é€‰æ‹©å…³é—­channelï¼Œå› ä¸ºä»–ä»¬ä¸èƒ½æ‰¾åˆ°ä¸€ä¸ªæ–¹å¼å»å¯é å¤„ç†æ‰“æ–­çš„I/Oæ“ä½œï¼Œé€šè¿‡æ“ä½œç³»ç»Ÿç”¨ç›¸åŒçš„æ–¹å¼ã€‚ä¿è¯ç¡®å®šæ€§è¡Œä¸ºçš„å”¯ä¸€æ–¹å¼å°±æ˜¯å…³é—­channelã€‚</p>

<p><strong>æŠ€å·§</strong>ï¼šä½ å¯ä»¥ç”¨ç±»ä¼¼<code class="language-plaintext highlighter-rouge"> channel instanceof InterruptibleChannel </code>æ¥ç¡®å®š channel æ˜¯ä¸æ˜¯æ”¯æŒ<code class="language-plaintext highlighter-rouge">asynchronous closing and interruption</code>ã€‚</p>

<p>é™¤äº†channelsï¼Œæœ‰2ç§æ–¹å¼è·å–channelï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">java.nio.channels</code> åŒ…æä¾›äº†ä¸€ä¸ªChannels utilityç±»ï¼Œå®ƒæœ‰2ä¸ªæ–¹æ³•ä»streamså¾—åˆ°channelã€‚ä¸‹é¢æ¯ä¸ªæ–¹æ³•ï¼Œå½“channelæ˜¯å…³é—­çš„ï¼Œstreamä¹Ÿæ˜¯å…³é—­çš„ï¼Œå¹¶ä¸”channelæ²¡æœ‰è¢« bufferedã€‚
    <ul>
      <li>WritableByteChannel newChannel(OutputStream outputStream) å¯¹ç»™å®šè¾“å‡ºæµè¿”å›ä¸€ä¸ªwritable byte channel</li>
      <li>ReadableByteChannel newChannel(InputStream inputStream)  å¯¹ç»™å®šè¾“å…¥æµè¿”å›ä¸€ä¸ª readable byte channel</li>
    </ul>
  </li>
  <li>å¾ˆå¤š classic I/O ç±»è¢«æ”¹é€ æ”¯æŒchannelåˆ›å»ºã€‚ä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">java.io.RandomAccessFile </code>å£°æ˜äº†FileChannel getChannel()  æ–¹æ³•å¾—åˆ°ä¸€ä¸ª file channel ï¼Œ<code class="language-plaintext highlighter-rouge">java.net.Socket </code>å£°æ˜äº† SocketChannel getChannel() æ–¹æ³•è¿”å›ä¸€ä¸ªsocket channelã€‚</li>
</ul>

<p>ä¾‹å­ï¼š</p>

<p><strong><em>Listing 7-1. Copying Bytes from an Input Channel to an Output Channel</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testUseChannelCopyFile</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">ReadableByteChannel</span> <span class="n">src</span> <span class="o">=</span> <span class="nc">Channels</span><span class="o">.</span><span class="na">newChannel</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
             <span class="nc">WritableByteChannel</span> <span class="n">dest</span> <span class="o">=</span> <span class="nc">Channels</span><span class="o">.</span><span class="na">newChannel</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">copyAlt</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">dest</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">copy</span><span class="o">(</span><span class="nc">ReadableByteChannel</span> <span class="n">src</span><span class="o">,</span> <span class="nc">WritableByteChannel</span> <span class="n">dest</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="mi">2048</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">src</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="n">dest</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">compact</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">dest</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">copyAlt</span><span class="o">(</span><span class="nc">ReadableByteChannel</span> <span class="n">src</span><span class="o">,</span> <span class="nc">WritableByteChannel</span> <span class="n">dest</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="mi">2048</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">src</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">dest</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>7-1å±•ç¤ºäº†2ç§æ–¹æ³•ä»æ ‡å‡†è¾“å…¥æµå¤åˆ¶å­—èŠ‚åˆ°æ ‡å‡†è¾“å‡ºæµã€‚åœ¨copy() æ–¹æ³•ï¼Œç›®çš„æ˜¯æœ€å°åŒ–æ“ä½œç³»ç»ŸI/Oè°ƒç”¨ï¼ˆé€šè¿‡write() è°ƒç”¨ï¼‰ï¼Œå°½ç®¡æ›´å¤šçš„æ•°æ®æœ€ç»ˆä½œä¸ºcompact() æ–¹æ³•è°ƒç”¨çš„ç»“æœè¢«å¤åˆ¶ã€‚ç¬¬äºŒç§æ–¹æ³•ï¼ŒcopyAlt() ï¼Œç›®æ ‡æ˜¯æ¶ˆé™¤æ•°æ®å¤åˆ¶ï¼Œå°½ç®¡å¯èƒ½ä¼šå‡ºç°æ›´å¤šçš„æ“ä½œç³»ç»ŸI/Oè°ƒç”¨ã€‚</p>

<p>copy() and copyAlt() æ–¹æ³•é¦–å…ˆåˆ†é…direct byte buffer ï¼ˆä¸Šç« æœ€åä¸€èŠ‚ï¼‰ï¼Œç„¶åä¸€ä¸ªwhileå¾ªç¯æŒç»­ä»source channelè¯»å­—èŠ‚ï¼Œç›´åˆ°end-of-input ï¼ˆread() returns -1 ï¼‰ã€‚éšç€è¯»å–ï¼Œbufferè¢« flipped ç„¶åå¯ä»¥è¢«æ’å¹²ã€‚ä¸‹é¢æ˜¯æ–¹æ³•çš„åˆ†æ­§ç‚¹ï¼š</p>

<ul>
  <li>copy() æ–¹æ³•çš„whileå¾ªç¯åªè°ƒç”¨äº†write()ä¸€æ¬¡ã€‚å› ä¸º write() å¯èƒ½æ²¡å®Œå…¨æ’å¹²bufferï¼Œ compact()  è¢«è°ƒç”¨åœ¨ä¸‹æ¬¡è¯»ä¹‹å‰compact bufferã€‚Compaction ç¡®ä¿æ²¡è¢«å†™çš„bufferå†…å®¹åœ¨ä¸‹æ¬¡è¯»æ“ä½œä¸ä¼šè¢«è¦†ç›–ã€‚å¾ªç¯ä¹‹åï¼Œflip bufferï¼Œå‡†å¤‡æ’å¹²ä»»ä½•å‰©ä¸‹çš„å†…å®¹ï¼Œç„¶åç”¨ hasRemaining() and write() å®Œæˆbufferçš„æ’å¹²ã€‚</li>
  <li>copyAlt() æ–¹æ³•whileå¾ªç¯é‡Œè¿˜æœ‰ä¸ªwhileå¾ªç¯ï¼Œä½¿ç”¨hasRemaining() and write() æŒç»­æ’å¹²bufferï¼Œç›´åˆ°bufferæ¸…ç©ºã€‚ç„¶åclear()  ï¼Œæ¸…ç©ºbufferç„¶ååœ¨ä¸‹æ¬¡readè°ƒç”¨å¯ä»¥è¢«å……æ»¡ã€‚</li>
</ul>

<p><strong>æ³¨æ„</strong>ï¼šè®¤è¯†åˆ°å•ä¸ªwrite() æ–¹æ³•è°ƒç”¨ä¸èƒ½è¾“å‡ºbufferçš„å…¨éƒ¨å†…å®¹æ˜¯å¾ˆé‡è¦çš„ã€‚ç±»ä¼¼åœ°ï¼Œå•ä¸ªçš„ read()  ä¹Ÿå¯èƒ½ä¸ä¼šå®Œå…¨å……æ»¡bufferã€‚</p>

<h4 id="channels-in-depth">Channels in Depth</h4>

<p>æœ¬èŠ‚æ·±å…¥äº†è§£exploring scatter/gather I/O, file channels, socket channels, and pipes ã€‚</p>

<h5 id="scattergather-io">Scatter/Gather I/O</h5>

<p>Channelæä¾›äº†è·¨å¤šä¸ªbufferæ‰§è¡Œå•ä¸€I/Oæ“ä½œçš„åŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯<em>scatter/gather I/O</em>ï¼ˆä¹Ÿå«<em>vectored I/O</em>ï¼‰ã€‚</p>

<p>åœ¨å†™æ“ä½œçš„contextï¼Œå‡ ä¸ªbufferçš„å†…å®¹æŒ‰é¡ºåºè¢«é›†ä¸­ï¼ˆæ’å¹²ï¼‰ï¼Œç„¶åé€šè¿‡channelé€åˆ°ç›®çš„åœ°ã€‚è¿™äº›buffersä¸éœ€è¦æœ‰ç­‰åŒçš„å®¹é‡ã€‚åœ¨è¯»æ“ä½œçš„contextï¼Œchannelçš„å†…å®¹æŒ‰é¡ºåºè¢«åˆ†æ•£ï¼ˆå¡«å……ï¼‰åˆ°å¤šä¸ªbufferï¼›æ¯ä¸ªbufferè¢«å¡«å……åˆ°limitï¼Œç›´åˆ°channelç©ºäº†æˆ–bufferå…¨éƒ¨ç©ºé—´éƒ½ç”¨äº†ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šç°ä»£æ“ä½œç³»ç»Ÿæä¾›äº†APIæ”¯æŒvectored I/O æ¶ˆé™¤ç³»ç»Ÿè°ƒç”¨ï¼ˆæˆ–è‡³å°‘å‡å°‘ï¼‰ï¼Œå› æ­¤æé«˜æ€§èƒ½ã€‚ä¾‹å¦‚ï¼ŒWin32/Win64 APIs æä¾›äº†ReadFileScatter() and WriteFileGather() ã€‚</p>

<p>Javaæä¾›<code class="language-plaintext highlighter-rouge">java.nio.channels.ScatteringByteChannel </code>æ¥å£æ”¯æŒ scatteringï¼Œä»¥åŠ<code class="language-plaintext highlighter-rouge">java.nio.channels.GatheringByteChannel </code>æ¥å£æ¥æ”¯æŒgathering ã€‚</p>

<p>ScatteringByteChannel æä¾›ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>long read(ByteBuffer[] buffers, int offset, int length)</li>
  <li>long read(ByteBuffer[] buffers)</li>
</ul>

<p>GatheringByteChannel æ–¹æ³•ï¼š</p>

<ul>
  <li>long write(ByteBuffer[] buffers, int offset, int length)</li>
  <li>long write(ByteBuffer[] buffers)</li>
</ul>

<p>ä¾‹å­ï¼š</p>

<p><strong><em>Listing 7-2. Demonstrating Scatter/Gather</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.Channels</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.GatheringByteChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.ScatteringByteChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-03 10:47
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelDemo1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ScatteringByteChannel</span> <span class="n">src</span><span class="o">;</span>
        <span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\resources\\image.txt"</span><span class="o">);</span>
        <span class="n">src</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ScatteringByteChannel</span><span class="o">)</span> <span class="nc">Channels</span><span class="o">.</span><span class="na">newChannel</span><span class="o">(</span><span class="n">fis</span><span class="o">);</span>
        <span class="nc">ByteBuffer</span> <span class="n">buffer1</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="nc">ByteBuffer</span> <span class="n">buffer2</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
        <span class="nc">ByteBuffer</span><span class="o">[]</span> <span class="n">buffers</span> <span class="o">=</span> <span class="o">{</span><span class="n">buffer1</span><span class="o">,</span> <span class="n">buffer2</span><span class="o">};</span>
        <span class="n">src</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffers</span><span class="o">);</span>

        <span class="n">buffer1</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">buffer1</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer1</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>

        <span class="n">buffer2</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">buffer2</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer2</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="n">buffer1</span><span class="o">.</span><span class="na">rewind</span><span class="o">();</span>
        <span class="n">buffer2</span><span class="o">.</span><span class="na">rewind</span><span class="o">();</span>
        <span class="nc">GatheringByteChannel</span> <span class="n">dest</span><span class="o">;</span>
        <span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\resources\\imageCopy.txt"</span><span class="o">);</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="o">(</span><span class="nc">GatheringByteChannel</span><span class="o">)</span> <span class="nc">Channels</span><span class="o">.</span><span class="na">newChannel</span><span class="o">(</span><span class="n">fos</span><span class="o">);</span>
        <span class="n">buffers</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">buffer2</span><span class="o">;</span>
        <span class="n">buffers</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">buffer1</span><span class="o">;</span>
        <span class="n">dest</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffers</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>é€šè¿‡å®ä¾‹åŒ–<code class="language-plaintext highlighter-rouge">java.io.FileInputStream </code>å¹¶æŠŠè¿™ä¸ªå®ä¾‹ä¼ é€’ç»™<code class="language-plaintext highlighter-rouge"> ReadableByteChannel newChannel(InputStream inputStream) </code>è·å–äº†ä¸€ä¸ªscattering byte channel ã€‚è¿”å›çš„<code class="language-plaintext highlighter-rouge"> ReadableByteChannel </code>è¢«è½¬æ¢ä¸º<code class="language-plaintext highlighter-rouge">ScatteringByteChannel </code>å› ä¸ºè¿™ä¸ªå®ä¾‹ç¡®å®æ˜¯ a file channel ï¼ˆdiscussed later ï¼‰ï¼Œå®ƒå®ç°äº†<code class="language-plaintext highlighter-rouge">ScatteringByteChannel </code>ã€‚</p>

<p>ç„¶åï¼Œåˆ›å»ºäº†ä¸€å¯¹direct byte buffersï¼Œå®¹é‡ä¸åŒã€‚ç„¶åè¿™ä¸¤ä¸ªbufferè¢«å­˜åœ¨äº†æ•°ç»„ï¼Œæ•°ç»„è¢«ä¼ é€’åˆ°<code class="language-plaintext highlighter-rouge">read(ByteBuffer[]) </code>æ¥å¡«å……ã€‚</p>

<p>å¡«å……ä¹‹åï¼Œ flip bufferç„¶åè¾“å‡ºå†…å®¹åˆ°æ ‡å‡†è¾“å‡ºã€‚è¾“å‡ºåï¼Œrewound  bufferå‡†å¤‡é€šè¿‡ä¸€ä¸ªèšé›†æ“ä½œæ’å¹²bufferã€‚</p>

<p>å®ä¾‹åŒ–<code class="language-plaintext highlighter-rouge">java.io.FileOutputStream </code>ä¼ é€’ç»™Channelsçš„<code class="language-plaintext highlighter-rouge">WritableByteChannel newChannel(OutputStream outputStream) </code>æ–¹æ³•ã€‚è¿”å›çš„<code class="language-plaintext highlighter-rouge"> WritableByteChannel </code>è¢«å¼ºè½¬ä¸º<code class="language-plaintext highlighter-rouge">GatheringByteChannel </code>ã€‚</p>

<p>æœ€åï¼Œåˆ†é…è¿™äº›buffersåˆ°bufferæ•°ç»„ï¼Œå’Œå®ƒä»¬æœ€å¼€å§‹çš„åˆ†é…é¡ºåºç›¸åï¼Œä¼ é€’æ•°ç»„åˆ°<code class="language-plaintext highlighter-rouge">write(ByteBuffer[]) </code>æ¥æ’å¹²ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>åŸæ–‡ä»¶
12345abcdefg
è¾“å‡º
49
50
51
52
53

97
98
99
è¾“å‡ºæ–‡ä»¶
abc12345

</code></pre></div></div>

<h5 id="file-channels">File Channels</h5>

<p>ä¹‹å‰æåˆ°ï¼Œ<code class="language-plaintext highlighter-rouge"> RandomAccessFile </code>å£°æ˜äº†<code class="language-plaintext highlighter-rouge">FileChannel getChannel() </code>è¿”å›ä¸€ä¸ªfile channelå®ä¾‹ï¼Œæè¿°äº†ä¸€ä¸ªåˆ°æ–‡ä»¶çš„ open connectionã€‚å…¶å®FileInputStream and FileOutputStreamä¹Ÿæä¾›äº†ç›¸åŒçš„æ–¹æ³•ã€‚ä¸ä¹‹ä¸åŒï¼Œ<code class="language-plaintext highlighter-rouge">java.io.FileReader</code> and <code class="language-plaintext highlighter-rouge">java.io.FileWriter</code> æ²¡æœ‰æä¾›æ´»åŠ¨file channelçš„æ–¹å¼ã€‚</p>

<p><strong>è­¦å‘Š</strong>ï¼šä»FileInputStreamâ€™s getChannel() è¿”å›çš„file channelæ˜¯åªè¯»çš„ï¼ŒFileOutputStreamâ€™s getChannel() è¿”å›çš„æ˜¯åªå†™çš„ã€‚â€¦. ï¼Œå¦åˆ™å¼‚å¸¸ã€‚</p>

<p>æŠ½è±¡<code class="language-plaintext highlighter-rouge">java.nio.channels.FileChannel </code>ç±»æè¿°äº†ä¸€ä¸ªfile channelã€‚è¿™ä¸ªç±»å®ç°äº†<code class="language-plaintext highlighter-rouge"> InterruptibleChannel </code>æ¥å£ï¼Œfile channelsæ˜¯interruptible ã€‚è¿˜å®ç°äº†<code class="language-plaintext highlighter-rouge">ByteChannel, GatheringByteChannel, and ScatteringByteChannel </code>æ¥å£ï¼Œä½ å¯ä»¥å†™åˆ°å®ƒï¼Œä»å®ƒè¯»ï¼Œåœ¨ä¸‹é¢çš„æ–‡ä»¶æ‰§è¡Œscatter/gather I/Oã€‚ç„¶è€Œï¼Œè¿˜æœ‰æ›´å¤šã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šä¸åƒbuffersçº¿ç¨‹ä¸å®‰å…¨ï¼Œfile channelsæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>

<p>ä¸€ä¸ªfile channelç»´æŠ¤ä¸€ä¸ªå½“å‰positionåˆ°æ–‡ä»¶ï¼Œ<code class="language-plaintext highlighter-rouge">FileChannel </code>è®©ä½ å¾—åˆ°å’Œæ”¹å˜è¿™ä¸ªpositionã€‚å®ƒè¿˜å…è®¸æ‚¨è¯·æ±‚å°†ç¼“å­˜çš„æ•°æ®å¼ºåˆ¶å‘é€åˆ°ç£ç›˜ï¼Œè¯»å†™æ–‡ä»¶å†…å®¹ï¼Œå¾—åˆ°channelä¸‹çš„æ–‡ä»¶çš„å¤§å°ï¼Œ truncateæ–‡ä»¶ï¼Œå°è¯•é”ä½å…¨éƒ¨æ–‡ä»¶æˆ–è€…ä»…ä¸€ä¸ªæ–‡ä»¶åŒºåŸŸï¼Œæ‰§è¡Œmemory-mapped file I/O ï¼Œä½¿ç”¨æ“ä½œç³»ç»Ÿå¯èƒ½ä¼˜åŒ–çš„æ–¹å¼ç›´æ¥ä¼ è¾“æ•°æ®åˆ°å¦ä¸€ä¸ªchannelã€‚</p>

<p><strong><em>Table 7-1. FileChannel Methods</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>void force(boolean metadata)</td>
      <td>è¯·æ±‚æŠŠæ‰€æœ‰å¯¹è¿™ä¸ªfile channelçš„æ›´æ–°æäº¤åˆ°å­˜å‚¨è®¾å¤‡ã€‚å½“è¿™ä¸ªæ–¹æ³•è¿”å›ï¼Œå½“æ–‡ä»¶å¤„äºæœ¬åœ°å­˜å‚¨è®¾å¤‡çš„æ—¶å€™ï¼Œæ‰€æœ‰åŸºäºchannelå¯¹æ–‡ä»¶çš„ä¿®æ”¹éƒ½è¢«æäº¤ã€‚ç„¶è€Œï¼Œå½“æ–‡ä»¶ä¸åœ¨æœ¬åœ°ï¼ˆä¾‹å¦‚ ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ ï¼‰ï¼Œåº”ç”¨ä¸èƒ½ç¡®å®šä¿®æ”¹æ˜¯ä¸æ˜¯è¢«æäº¤äº†ã€‚ï¼ˆä¸ä¿è¯å…¶ä»–åœ°æ–¹å®šä¹‰çš„æ–¹æ³•åšå‡ºçš„æ›´æ”¹ä¼šè¢«æäº¤ã€‚æ¯”å¦‚ï¼Œé€šè¿‡  mapped byte buffer çš„æ”¹å˜å¯èƒ½ä¸ä¼šè¢«æäº¤ï¼‰                                                                                   metadataå€¼è¡¨æ˜æ˜¯å¦æ›´æ–°è¦åŒ…å«æ–‡ä»¶çš„metadataï¼ˆæ¯”å¦‚ modification time and last access timeï¼‰ã€‚trueå¯èƒ½ä¼šè°ƒç”¨åº•å±‚çš„writeåˆ°æ“ä½œç³»ç»Ÿï¼Œï¼ˆå¦‚æœæ“ä½œç³»ç»Ÿåœ¨ç»´æŠ¤metadataï¼Œæ¯”å¦‚  last access time ï¼‰,å³ä½¿channelæ˜¯ä»¥åªè¯»æ‰“å¼€çš„ã€‚       æŠ›å¼‚å¸¸  ClosedChannelException  IOException</td>
    </tr>
    <tr>
      <td>long position()</td>
      <td>è¿”å›file channelç»´æŠ¤çš„ä»¥0ä¸ºåŸºå‡†çš„å½“å‰file positionã€‚æŠ›å¼‚å¸¸  ClosedChannelException  IOException</td>
    </tr>
    <tr>
      <td>FileChannel position(long newPosition)</td>
      <td>è®¾ç½®è¿™ä¸ªfile channelçš„å½“å‰file positionåˆ°newPositionã€‚å‚æ•°æ˜¯ä»æ–‡ä»¶å¼€å¤´å¼€å§‹çš„å­—èŠ‚è®¡æ•°ã€‚ä¸èƒ½ä¸ºè´Ÿã€‚ä½†æ˜¯å¯ä»¥è¶…å‡ºå½“å‰æ–‡ä»¶sizeï¼Œå¦‚æœè¶…è¿‡äº†ï¼Œreadä¼šè¿”å›end of fileã€‚å†™æ“ä½œä¼šæˆåŠŸï¼Œä¼šåœ¨å½“å‰æ–‡ä»¶æœ«å°¾å’Œnew positionä¹‹é—´ä½¿ç”¨éœ€æ±‚æ•°é‡çš„ï¼ˆæœªå®šä¹‰ï¼‰å­—èŠ‚å€¼å¡«å……å­—èŠ‚ã€‚offsetä¸ºè´ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> java.lang.IllegalArgumentException </code>ã€‚  ClosedChannelException ï¼Œ IOException</td>
    </tr>
    <tr>
      <td>int read(ByteBuffer buffer)</td>
      <td>ä»file channelè¯»å–å­—èŠ‚åˆ°ç»™å®šbufferã€‚è¯»å–å­—èŠ‚çš„æœ€å¤§æ•°é‡æ˜¯è°ƒç”¨æ–¹æ³•æ—¶bufferå‰©ä½™çš„å­—èŠ‚æ•°é‡ã€‚å­—èŠ‚ä¼šä»bufferçš„å½“å‰positionå¼€å§‹å¤åˆ¶åˆ°bufferã€‚è°ƒç”¨ä¼šé˜»å¡å¦‚æœå…¶ä»–çº¿ç¨‹ä¹Ÿå°è¯•ä»è¿™ä¸ªchannelè¯»ã€‚è¯»å®Œåï¼Œbufferçš„positionä¼šæŒ‡åˆ°è¯»å–å­—èŠ‚çš„æœ«å°¾ã€‚bufferçš„limitæ²¡æœ‰å˜ã€‚è¿”å›å®é™…è¯»å–çš„å­—èŠ‚æ•°ï¼ŒæŠ›å‡ºå’Œ<code class="language-plaintext highlighter-rouge"> ReadableByteChannel </code>ä¸€æ ·çš„å¼‚å¸¸ã€‚</td>
    </tr>
    <tr>
      <td>int read(ByteBuffer dst, long position)</td>
      <td>å’Œä¸Šé¢ä¸€æ ·ï¼Œä½†æ˜¯ä»æ–‡ä»¶çš„positionä½ç½®è¯»ï¼Œpositionæ˜¯è´ŸæŠ›å‡º<code class="language-plaintext highlighter-rouge"> IllegalArgumentException </code>ã€‚</td>
    </tr>
    <tr>
      <td>long size()</td>
      <td>è¿”å›file channelä¸‹çš„æ–‡ä»¶çš„ï¼ˆin bytesï¼‰sizeã€‚ ClosedChannelException ï¼Œ  IOException</td>
    </tr>
    <tr>
      <td>FileChannel truncate(long size)</td>
      <td>Truncate è¿™ä¸ªfile channelä¸‹çš„æ–‡ä»¶åˆ°sizeã€‚ä»»ä½•è¶…å‡º  size çš„å­—èŠ‚éƒ½è¢«ä»æ–‡ä»¶ç§»é™¤ã€‚å½“æ²¡æœ‰å­—èŠ‚è¶…å‡ºç»™å®šsizeï¼Œæ–‡ä»¶å†…å®¹æ²¡è¢«æ”¹å˜ã€‚å½“ current file position è¶…è¿‡äº†sizeï¼Œå®ƒè¢«è®¾ç½®ä¸ºsizeã€‚</td>
    </tr>
    <tr>
      <td>int write(ByteBuffer buffer)</td>
      <td>ä»ç»™å®šbufferå†™ä¸€ä¸ªåºåˆ—çš„å­—èŠ‚åˆ°file channelã€‚å­—èŠ‚ä»channelçš„  current file position å¼€å§‹å†™ï¼Œé™¤éæ˜¯appendæ¨¡å¼ï¼Œè¿™ä¸ªæ¨¡å¼positionä¼šå…ˆæåˆ°æ–‡ä»¶æœ«å°¾ã€‚fileä¼šå¢é•¿ï¼ˆå¿…è¦æ—¶ï¼‰æ¥å®¹çº³å†™å…¥çš„å­—èŠ‚ï¼Œç„¶åæ–‡ä»¶positionéšç€è¢«å®é™…å†™å…¥çš„å­—èŠ‚æ›´æ–°ã€‚å¦å¤–çš„è¡¨ç°å¾—å’Œ<code class="language-plaintext highlighter-rouge"> WritableByteChannel </code>çš„æ–¹æ³•ä¸€æ ·ã€‚æ–¹æ³•è¿”å›å®é™…å†™çš„å­—èŠ‚æ•°ï¼ŒæŠ›å‡ºå’Œ<code class="language-plaintext highlighter-rouge"> WritableByteChannel </code>ä¸€æ ·çš„å¼‚å¸¸ã€‚</td>
    </tr>
    <tr>
      <td>int write(ByteBuffer src, long position)</td>
      <td>ç­‰åŒä¸Šä¸ªæ–¹æ³•ï¼Œä»positionå¼€å§‹å†™ã€‚</td>
    </tr>
  </tbody>
</table>

<p>force(boolean)  æ–¹æ³•ç¡®ä¿æ‰€æœ‰æ›´æ”¹å†™å…¥æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶ã€‚è¿™ä¸ªèƒ½åŠ›å¯¹ä¾‹å¦‚äº‹åŠ¡çš„criticalä»»åŠ¡å¾ˆå…³é”®ï¼Œä½ è¦ç»´æŠ¤æ•°æ®å®Œæ•´æ€§å’Œå¯é æ¢å¤ã€‚ç„¶è€Œï¼Œå¯¹è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿæ²¡æœ‰ä¿è¯ã€‚</p>

<p>ä¼ trueåˆ° force(boolean) å¯¼è‡´metadataä¹Ÿè¢«åŒæ­¥åˆ°ç£ç›˜ã€‚å› ä¸ºmetadataå¯¹æ–‡ä»¶æ¢å¤é€šå¸¸ä¸å…³é”®ï¼Œä½ å¯ä»¥ä¼ falseï¼Œå®ƒæ˜¯ä¸ªé¢å¤–çš„I/Oæ“ä½œã€‚</p>

<p><code class="language-plaintext highlighter-rouge">FileChannel </code>å¯¹è±¡æ”¯æŒcurrent file positionçš„æ¦‚å¿µï¼Œå†³å®šäº†ä¸‹ä¸ªè¦è¯»æˆ–å†™å…¥çš„data itemçš„ä½ç½®ã€‚ position() è¿”å›å½“å‰positionï¼Œposition(long newPosition) è®¾ç½®å½“å‰positionåˆ°newPositionã€‚</p>

<p>read() and write() æ–¹æ³•æœ‰ä¸¤ç§å½¢å¼ã€‚ç›¸å¯¹çš„å½¢å¼ï¼Œä¸å¸¦positionå‚æ•°ï¼Œç¡®ä¿åœ¨æ–¹æ³•è°ƒç”¨åå½“å‰æ–‡ä»¶çš„positionçš„æ›´æ–°ã€‚ç»å¯¹çš„å½¢å¼å¸¦æœ‰positionå‚æ•°ï¼Œä¸ä¼šæ›´æ–°positionã€‚ç»å¯¹å½¢å¼çš„è¯»å†™æ›´æ•ˆç‡å› ä¸ºä¸éœ€è¦æ›´æ–°channelçš„stateã€‚</p>

<p>å¦‚æœä½ å°è¯•æ‰§è¡Œä¸€ä¸ªç»å¯¹çš„è¯»æ–‡ä»¶æœ«å°¾ï¼Œå‚æ•°æ˜¯size()çš„è¿”å›å€¼ï¼Œä¼šè¿”å›-1è¡¨æ˜åˆ°è¾¾æ–‡ä»¶æœ«å°¾ã€‚å¦‚æœä½ å°è¯•æ‰§è¡Œä¸€ä¸ªç»å¯¹çš„è¯»æ–‡ä»¶æœ«å°¾ï¼Œå‚æ•°æ˜¯size()çš„è¿”å›å€¼å¯¼è‡´æ–‡ä»¶å¢é•¿æ¥å®¹çº³å†™å…¥çš„å­—èŠ‚ã€‚åœ¨å…ˆå‰æ–‡ä»¶æœ«å°¾å’Œç¬¬ä¸€ä¸ªæ–°å†™å…¥å­—èŠ‚ä¹‹é—´çš„å­—èŠ‚çš„å€¼æ˜¯ç³»ç»Ÿç‰¹å®šçš„ï¼Œå¯èƒ½å½¢æˆä¸€ä¸ªholeã€‚</p>

<p>ä¸€ä¸ª<em>hole</em>å‘ç”Ÿåœ¨æ–‡ä»¶ï¼Œå½“åˆ†é…ç»™æ–‡ä»¶çš„ç£ç›˜ç©ºé—´æ•°é‡æ¯”æ–‡ä»¶sizeè¦å°çš„æ—¶å€™ã€‚ç°ä»£æ“ä½œç³»ç»Ÿé€šå¸¸åªå¯¹å†™å…¥æ–‡ä»¶çš„æ•°æ®åˆ†é…ç©ºé—´ã€‚å½“æ•°æ®è¢«å†™å…¥ä¸è¿ç»­çš„åŒºåŸŸï¼Œholeså‡ºç°ã€‚å½“æ–‡ä»¶è¢«è¯»ï¼Œholesé€šå¸¸è¡¨ç°ä¸ºzero-filledï¼ˆè¡¥0ï¼‰ä½†æ˜¯ä¸å ç£ç›˜ç©ºé—´ã€‚</p>

<p>truncate(long size) æ–¹æ³•å¯¹å‡å°æ–‡ä»¶sizeå¾ˆæœ‰ç”¨ã€‚æˆªæ–­æ‰€æœ‰è¶…å‡ºsizeçš„æ•°æ®ã€‚å½“sizeæ¯”æ–‡ä»¶sizeå¤§æˆ–è€…ç›¸ç­‰ï¼Œæ–‡ä»¶ä¸å˜ã€‚</p>

<p><strong><em>Listing 7-3. Demonstrating a File Channel</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelDemo2</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">RandomAccessFile</span> <span class="n">raf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="s">"temp"</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">);</span>
        <span class="nc">FileChannel</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">raf</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">pos</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pos</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fc</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

        <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"er34 we3e 34awe"</span><span class="o">;</span>
        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">length</span><span class="o">()*</span><span class="mi">2</span><span class="o">);</span>
        <span class="n">buffer</span><span class="o">.</span><span class="na">asCharBuffer</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>

        <span class="n">fc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">force</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fc</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fc</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">pos</span><span class="o">);</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
        <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">getChar</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å…ˆåˆ›å»ºäº†randomly-accessible File tempï¼Œç„¶åä»fileå¾—åˆ°ä¸€ä¸ªfile channelï¼Œè¾“å‡ºpositionå’Œsizeï¼Œéƒ½æ˜¯0ã€‚</p>

<p>ç„¶ååˆ†é…ä¸€ä¸ªdirect bufferï¼Œå­˜æ”¾messgaeï¼ŒæŠŠbufferä½œä¸ºcharacter bufferï¼Œè°ƒç”¨put()ä¿å­˜bufferé‡Œçš„messageï¼Œéšåè¾“å‡ºåˆ°æ–‡ä»¶ã€‚</p>

<p>è°ƒç”¨force(true)ï¼Œæ‰˜ä»˜åº•å±‚æ“ä½œç³»ç»ŸæŠŠæ•°æ®å­˜åˆ°å­˜å‚¨è®¾å¤‡ã€‚</p>

<p>ç„¶åè¾“å‡ºå½“å‰positionå’Œsizeï¼Œç„¶åclear bufferï¼Œé‡ç½®file positionåˆ°messageè¢«å†™å…¥å‰çš„ä½ç½®ï¼ˆ0ï¼‰ï¼Œè¯»å–å…ˆå‰å†™çš„å†…å®¹åˆ°bufferã€‚ç„¶åflip bufferè¾“å‡ºå†…å®¹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>è¾“å‡º
Position = 0
size: 0
position: 46
size: 46
This is a test message.
å†æ¬¡è¿è¡Œ
Position = 0
size: 46
position: 46
size: 46
This is a test message.
</code></pre></div></div>

<h6 id="locking-files">Locking Files</h6>

<p>lockå…¨éƒ¨æˆ–éƒ¨åˆ†æ–‡ä»¶çš„èƒ½åŠ›æ˜¯é‡è¦çš„ï¼Œä½†è¿™ä¸ªç‰¹æ€§Java 1.4æ‰æœ‰ã€‚è¿™ä¸ªèƒ½åŠ›è®©JVMè¿›ç¨‹é˜»æ­¢å…¶ä»–è¿›ç¨‹è®¿é—®æ•´ä¸ªæˆ–è€…éƒ¨åˆ†æ–‡ä»¶ç›´åˆ°å®ƒç»“æŸäº†æ•´ä¸ªæˆ–è€…éƒ¨åˆ†æ–‡ä»¶çš„æ“ä½œã€‚</p>

<p>è™½ç„¶å¯ä»¥é”æ•´ä¸ªæ–‡ä»¶ï¼Œä½†é€šå¸¸å¸Œæœ›é”æ›´å°çš„ä¸€éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œæ•°æ®åº“ç®¡ç†ç³»ç»Ÿå¯ä»¥é”æ›´æ–°ä¸­çš„å•ä¸ªè¡Œè€Œä¸æ˜¯é”æ•´ä¸ªè¡¨ï¼Œå› æ­¤è¯»å–è¯·æ±‚å¯ä»¥è¢«æˆäºˆï¼Œä»è€Œæé«˜ååé‡ ã€‚</p>

<p>å’Œfilesæœ‰è”ç³»çš„locksä¹Ÿå« <em>file locks</em> ã€‚æ¯ä¸ªæ–‡ä»¶é”ä»æ–‡ä»¶ä¸­ä¸€ä¸ªç¡®åˆ‡çš„å­—èŠ‚ä½ç½®å¼€å§‹ï¼Œå’Œä¸€ä¸ªæŒ‡å®šçš„ä»è¿™ä¸ªä½ç½®å¼€å§‹çš„lengthï¼ˆbyteï¼‰ã€‚å®ƒä»¬ä¸€èµ·å®šä¹‰äº†ç”±é”æ§åˆ¶çš„åŒºåŸŸã€‚ æ–‡ä»¶é”è®©è¿›ç¨‹åè°ƒå¯¹æ–‡ä»¶ä¸­å„ä¸ªåŒºåŸŸçš„è®¿é—®ã€‚</p>

<p>æœ‰2ç§æ–‡ä»¶é”ï¼šexclusive ï¼ˆæ’å®ƒé”ï¼‰å’Œshared ï¼ˆå…±äº«é”ï¼‰ã€‚ä¸€ä¸ª<em>exclusive lock</em> ç»™å•ä¸ªwriterè¿›ç¨‹è®¿é—®ä¸€ä¸ªæ–‡ä»¶åŒºåŸŸï¼›å®ƒé˜»æ­¢å…¶ä»–æ–‡ä»¶é”åŒæ—¶é€‚ç”¨ä¸è¯¥åŒºåŸŸã€‚ä¸€ä¸ª<em>shared lock</em> ç»™å‡ºå¤šä¸ªreaderè¿›ç¨‹çš„å…¶ä¸­ä¹‹ä¸€è®¿é—®ç›¸åŒçš„æ–‡ä»¶åŒºåŸŸï¼›å®ƒä¸é˜»æ­¢å…¶ä»–å…±äº«é”ä½†æ˜¯é˜»æ­¢æ’å®ƒé”åŒæ—¶é€‚ç”¨æ­¤åŒºåŸŸã€‚</p>

<p>Exclusive and shared locks æ™®éä½¿ç”¨äºä¸€ä¸ªæ–‡ä»¶ä¸»è¦æ˜¯è¯»å¶å°”æ›´æ–°çš„åœºæ™¯ã€‚ä¸€ä¸ªéœ€è¦è¯»å–æ–‡ä»¶çš„è¿›ç¨‹ï¼Œéœ€è¦ä¸€æŠŠshared lockï¼Œé”åˆ°æ•´ä¸ªæ–‡ä»¶æˆ–è€…æœŸæœ›çš„å­åŒºåŸŸã€‚ç¬¬äºŒä¸ªéœ€è¦è¯»çš„è¿›ç¨‹ä¹Ÿéœ€è¦ä¸€æŠŠå…±äº«é”ï¼Œé”åˆ°æœŸæœ›åŒºåŸŸã€‚ä¸¤ä¸ªè¿›ç¨‹éƒ½èƒ½è¯»æ–‡ä»¶è€Œäº’ä¸å¹²æ‰°ã€‚</p>

<p>å‡è®¾ç¬¬ä¸‰ä¸ªè¿›ç¨‹æƒ³æ‰§è¡Œæ›´æ–°ã€‚è¦è¿™ä¹ˆåšï¼Œéœ€è¦ä¸€ä¸ªæ’å®ƒé”ã€‚è¿™ä¸ªè¿›ç¨‹ä¼šé˜»å¡ä½ï¼Œç›´åˆ°æ‰€æœ‰çš„å’Œå®ƒçš„åŒºåŸŸé‡å çš„æ’ä»–/å…±äº«é”è¢«é‡Šæ”¾ã€‚ä¸€æ—¦æ›´æ–°è¿›ç¨‹æŠ¢åˆ°æ’å®ƒé”ï¼ˆOnce the exclusive lock was granted to the updater process ï¼‰ï¼Œä»»ä½•è¯·æ±‚å…±äº«é”çš„readerè¿›ç¨‹éƒ½ä¼šé˜»å¡ä½ï¼Œç›´åˆ°æ’å®ƒé”è¢«é‡Šæ”¾ã€‚æ›´æ–°è¿›ç¨‹æ›´æ–°äº†æ–‡ä»¶ï¼Œè¯»è¿›ç¨‹ä¹Ÿä¸ä¼šè§‚æµ‹åˆ°ä¸ä¸€è‡´çš„æ•°æ®ã€‚</p>

<p>å¯¹ file locking è¿˜æœ‰å‡ ä»¶äº‹è¦æ³¨æ„ ï¼š</p>

<ul>
  <li>å½“æ“ä½œç³»ç»Ÿä¸æ”¯æŒå…±äº«é”ï¼Œä¸€ä¸ªå…±äº«é”çš„è¯·æ±‚é»˜é»˜åœ°æå‡åˆ°äº†æ’å®ƒé”ã€‚è™½ç„¶æ­£ç¡®æ€§å¯ä»¥è‚¯å®šï¼Œæ€§èƒ½å¯èƒ½ä¼šå—åˆ°å½±å“ã€‚</li>
  <li>Locksæ˜¯é€‚ç”¨äºper-fileçš„åŸºç¡€ä¸Šçš„ã€‚ä¸é€‚ç”¨äºåŸºäºper-threadæˆ–è€… per-channelã€‚JVMä¸Šçš„2ä¸ªçº¿ç¨‹ï¼Œé€šè¿‡ä¸åŒçš„channelï¼Œä¸€ä¸ªåˆ°ç›¸åŒåŒºåŸŸçš„æ’å®ƒé”éƒ½å¯ä»¥æˆæƒè®¿é—®ã€‚ç„¶è€Œï¼Œå¦‚æœæ˜¯ä¸åŒJVMçš„çº¿ç¨‹ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ä¼šé˜»å¡ã€‚Locksæœ€ç»ˆç”±æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œå…¬æ–­ï¼Œè€Œä¸”å‡ ä¹æ€»æ˜¯åœ¨è¿›ç¨‹å±‚é¢ã€‚ä¸åœ¨çº¿ç¨‹å±‚é¢å…¬æ–­ã€‚é”å’Œfileå…³è”çš„ï¼Œä¸å’Œæ–‡ä»¶å¥æŸ„æˆ–channelå…³è”ã€‚</li>
</ul>

<p>FileChannelå£°æ˜4ä¸ªæ–¹æ³•å¾—åˆ°å…±äº«/æ’å®ƒé”ï¼š</p>

<ul>
  <li>
    <p>FileLock lock(): å¾—åˆ°è¿™ä¸ªfile channelåº•ä¸‹æ–‡ä»¶çš„æ’å®ƒé”ã€‚è¿™ä¸ªæ–¹ä¾¿æ–¹æ³•ç­‰åŒäºæ‰§è¡Œ<code class="language-plaintext highlighter-rouge">fileChannel.lock(0L, Long. MAX_VALUE, false); </code>ï¼›</p>

    <p>è¿”å›ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">java.nio.channels.FileLock </code>å¯¹è±¡ä»£è¡¨è¢«é”åŒºåŸŸã€‚å¯æŠ›å‡ºClosedChannelExceptionï¼ŒNonWritableChannelException ï¼Œjava.nio.channels.OverlappingFileLockExceptionå½“ä»»æ„ä¸€ä¸ªå’Œè¯·æ±‚åŒºåŸŸé‡å é”å·²ç»è¢«JVMæŒæœ‰ï¼Œæˆ–å¦ä¸€ä¸ªåœ¨è¿™ä¸ªæ–¹æ³•è¢«é˜»å¡äº†å¹¶å°è¯•é”ä½åŒæ–‡ä»¶çš„é‡å åŒºåŸŸï¼›java.nio.channels.FileLockInterruptionException å½“ç­‰å¾…è·å–é”æ—¶è¢«æ‰“æ–­ï¼›AsynchronousCloseException  å½“ç­‰å¾…è·å–é”æ—¶channelè¢«å…³é—­ï¼›IOException ç­‰ã€‚</p>
  </li>
  <li>
    <p>FileLock lock(long position, long size, boolean shared): åœ¨è¿™ä¸ªchannelçš„æ–‡ä»¶çš„åŒºåŸŸåŠ é”ã€‚</p>
  </li>
  <li>
    <p>FileLock tryLock(): å°è¯•ä¸é˜»å¡åœ°è·å¾—æ’ä»–é”ã€‚ç­‰åŒäº <code class="language-plaintext highlighter-rouge">fileChannel.tryLock(0L, Long.MAX_VALUE, false)</code>; è¿”å›ä¸€ä¸ª FileLock ï¼Œä»£è¡¨è¢«é”çš„åŒºåŸŸæˆ–è€…nullï¼Œå½“é”å’Œå…¶ä»–æ“ä½œç³»ç»Ÿè¿›ç¨‹é‡å çš„æ—¶å€™ã€‚æŠ›å‡º ClosedChannelException ï¼ŒOverlappingFileLockException å½“é‡å åŒºåŸŸçš„é”è¢«JVMæŒæœ‰ï¼Œæˆ–å¦ä¸€ä¸ªåœ¨è¿™ä¸ªæ–¹æ³•è¢«é˜»å¡äº†å¹¶å°è¯•é”ä½åŒæ–‡ä»¶çš„é‡å åŒºåŸŸã€‚ IOException</p>
  </li>
  <li>
    <p>FileLock tryLock(long position, long size, boolean shared):</p>
  </li>
</ul>

<p>lock()å½“è¦é”çš„åŒºåŸŸå·²ç»è¢«é”ä¼šblockï¼ˆé™¤ééƒ½æ˜¯å…±äº«é”ï¼‰ã€‚å¯¹æ¯”ä¹‹ä¸‹ï¼ŒtryLock() ä¼šè¿…é€Ÿè¿”å›ä¸€ä¸ªnullå€¼ï¼ˆå½“è¦å’Œå…¶ä»–æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹çš„ç‹¬å é”é‡å ï¼‰</p>

<p>éƒ½è¿”å› FileLock å®ä¾‹ï¼Œå°è£…äº†ä¸€ä¸ªfileçš„è¢«é”çš„åŒºåŸŸã€‚ FileLockâ€™s methods ï¼š</p>

<ul>
  <li>FileChannel channel(): å½“å¾—åˆ°é”è¿”å›file channelï¼Œå½“file channelæ²¡å¾—åˆ°é”è¿”å›null</li>
  <li>void close(): è°ƒç”¨release() æ–¹æ³•é‡Šæ”¾é”</li>
  <li>boolean isShared():  æ˜¯ä¸æ˜¯å…±äº«é”</li>
  <li>boolean isValid(): æ˜¯valid lockè¿”å›trueï¼Œå¦åˆ™falseã€‚é”æ˜¯validçš„ç›´åˆ°å®ƒè¢«é‡Šæ”¾æˆ–è€…å…³è”çš„file channelè¢«å…³é—­ï¼Œæ— è®ºå“ªä¸ªåœ¨å‰</li>
  <li>boolean overlaps(long position, long size): è¿”å›æ˜¯ä¸æ˜¯å’Œè¢«é”åŒºåŸŸé‡å </li>
  <li>long position(): è¿”å›è¢«é”åŒºåŸŸçš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„ä½ç½®ã€‚è¿”å›å€¼å¯èƒ½æ¯”æ–‡ä»¶sizeè¦å¤§ã€‚</li>
  <li>void release():  é‡Šæ”¾é”ã€‚å¦‚æœé”æ˜¯validçš„ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•é‡Šæ”¾é”ï¼ŒæŠŠå¯¹è±¡å˜æˆinvalidã€‚å¦‚æœé”æ˜¯ï¼Œinvalid ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ— æ•ˆã€‚</li>
  <li>long size(): è¿”å›æ–‡ä»¶é”çš„çš„lengthï¼ˆå­—èŠ‚ï¼‰</li>
  <li>String toString(): è¿”å›stringæè¿°rangeï¼Œtypeå’Œvalidity ã€‚</li>
</ul>

<p>FileLockå®ä¾‹å’Œä¸€ä¸ªFileChannel å®ä¾‹å…³è”ï¼Œä½†æ˜¯FileLockå®ä¾‹ä»£è¡¨çš„file lockï¼Œå’Œunderlying file å…³è”è€Œä¸æ˜¯å’Œfile channelå…³è”ã€‚ä¸å°å¿ƒçš„è¯ï¼Œå½“ä½ ç”¨å®Œåæ²¡é‡Šæ”¾é”å¯èƒ½ä¼šé‡åˆ°å†²çªï¼ˆç”šè‡³å¯èƒ½æ­»é”ï¼‰ã€‚è¦é¿å…è¿™äº›é—®é¢˜ï¼Œä½ è¦é‡‡ç”¨ä¸€ç§æ¨¡å¼æ¯”å¦‚ä¸‹é¢çš„ï¼Œç¡®ä¿lockæ€»æ˜¯è¢«é‡Šæ”¾ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">fileChannel</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
<span class="k">try</span>
<span class="o">{</span>
 <span class="c1">// interact with the file channel</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span>
<span class="o">{</span>
 <span class="c1">// handle the exception</span>
<span class="o">}</span>
<span class="k">finally</span>
<span class="o">{</span>
 <span class="n">lock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
<span class="o">}</span>

</code></pre></div></div>

<p>ä¾‹å­ï¼š</p>

<p><strong><em>Listing 7-4. Demonstrating File Locking</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelDemo3</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">MAXQUERIES</span> <span class="o">=</span> <span class="mi">150000</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">MAXUPDATES</span> <span class="o">=</span> <span class="mi">150000</span><span class="o">;</span>

    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">RECLEN</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="no">RECLEN</span><span class="o">);</span>
    <span class="kd">static</span> <span class="nc">IntBuffer</span> <span class="n">intBuffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">asIntBuffer</span><span class="o">();</span>

    <span class="kd">static</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">writer</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

            <span class="nc">RandomAccessFile</span> <span class="n">raf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\resources\\image.txt"</span><span class="o">,</span> <span class="o">(</span><span class="n">writer</span><span class="o">)</span> <span class="o">?</span> <span class="s">"rw"</span> <span class="o">:</span> <span class="s">"r"</span><span class="o">);</span>
            <span class="nc">FileChannel</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">raf</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">writer</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">update</span><span class="o">(</span><span class="n">fc</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">query</span><span class="o">(</span><span class="n">fc</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">query</span><span class="o">(</span><span class="nc">FileChannel</span> <span class="n">fc</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">MAXQUERIES</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"acquiring shared lock"</span><span class="o">);</span>
            <span class="nc">FileLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="na">lock</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="no">RECLEN</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="n">fc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">intBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
                <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">intBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">intBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
                <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">intBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Reading"</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">d</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">b</span> <span class="o">||</span> <span class="n">a</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">!=</span> <span class="n">c</span> <span class="o">||</span> <span class="n">a</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">!=</span> <span class="n">d</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"error"</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="nc">FileChannel</span> <span class="n">fc</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">MAXUPDATES</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"acquiring exclusive lock"</span><span class="o">);</span>
            <span class="nc">FileLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="na">lock</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="no">RECLEN</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">intBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">counter</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">*</span> <span class="mi">3</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">*</span> <span class="mi">4</span><span class="o">;</span>

                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Writing"</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">d</span><span class="o">);</span>
                <span class="n">intBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
                <span class="n">intBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
                <span class="n">intBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
                <span class="n">intBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">d</span><span class="o">);</span>
                <span class="n">counter</span><span class="o">++;</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="n">fc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>7-4æè¿°äº†åº”ç”¨è¦ä¹ˆæ›´æ–°è¦ä¹ˆæŸ¥è¯¢æ–‡ä»¶ã€‚å› ä¸ºfile lockåº”ç”¨äºè¿›ç¨‹çº§åˆ«è€Œä¸æ˜¯çº¿ç¨‹çº§åˆ«ã€‚ä½ éœ€è¦å¯åŠ¨2ä¸ªapplicationã€‚ä¸€ä¸ªwriterï¼Œä¸€ä¸ªreaderã€‚</p>

<p>ChannelDemo3 ç±»å…ˆå®šä¹‰å¸¸æ•°å’Œå˜é‡ã€‚ç„¶ååˆ†é…äº†ä¸€ä¸ªbyte bufferï¼Œå¾—åˆ°int-based view buffer ã€‚</p>

<p>main() å†³å®šäº†æ˜¯writerè¿˜æ˜¯readerã€‚</p>

<p><strong>æ³¨æ„ï¼š</strong> ChannelDemo reader è¿›ç¨‹è¶Šå¤šï¼ŒChannelDemo writer è¿›ç¨‹è¿è¡Œè¶Šæ…¢ã€‚</p>

<h6 id="mapping-files-into-memory">Mapping Files into Memory</h6>

<p>FileChannelå£°æ˜äº†map() æ–¹æ³•å¯ä»¥åœ¨æ‰“å¼€çš„æ–‡ä»¶çš„ä¸€ä¸ªregionå’Œä¸€ä¸ªåŒ…è£…äº†è¿™ä¸ªregionçš„java.nio.MappedByteBufferå®ä¾‹ä¹‹é—´åˆ›å»ºä¸€ä¸ª virtual memory mapping ã€‚mappingæœºåˆ¶æä¾›äº†ä¸€ä¸ªæ•ˆç‡çš„è®¿é—®æ–‡ä»¶çš„æ–¹å¼ï¼Œå› ä¸ºæ²¡æœ‰æ‰§è¡ŒI/Oè°ƒç”¨çš„æ—¶é—´æ¶ˆè€—ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼š<em>Virtual memory</em> æ˜¯ä¸€ç§memoryï¼Œvirtual addressesï¼ˆä¹Ÿå«artificial addresses ï¼‰ä»£æ›¿ï¼ˆphysical (RAM memory) addresses ã€‚Check out Wikipediaâ€™s â€œVirtual Memoryâ€ topic (http://en.wikipedia.org/wiki/ Virtual_memory) to learn more about virtual memory.</p>

<p>map() æ–¹æ³•æœ‰å¦‚ä¸‹ç­¾åï¼š</p>

<p>MappedByteBuffer map(FileChannel.MapMode mode, long position, long size)</p>

<p>modeå‚æ•°å®šä¹‰æ˜ å°„ç±»å‹ï¼Œæ˜¯ FileChannel.MapMode çš„æšä¸¾ç±»å‹ï¼š</p>

<ul>
  <li>READ_ONLY:  ä»»ä½•æ›´æ”¹çš„å°è¯•æŠ›å‡ºjava.nio.ReadOnlyBufferException</li>
  <li>READ_WRITE:  å¯¹resulting buffer çš„æ›´æ”¹æœ€ç»ˆä¼ æ’­åˆ°æ–‡ä»¶ï¼›Changes å¯èƒ½ä¸å¯¹æ˜ å°„äº†åŒä¸€æ–‡ä»¶çš„ç¨‹åºå¯è§ã€‚</li>
  <li>PRIVATE:  å¯¹resulting buffer çš„æ›´æ”¹ä¸ä¼šä¼ æ’­åˆ°æ–‡ä»¶ï¼Œå¯¹å…¶ä»–æ˜ å°„åŒä¸€æ–‡ä»¶çš„ç¨‹åºä¸å¯è§ã€‚è€Œæ˜¯ï¼Œæ›´æ”¹ä¼šé€ æˆbufferä¿®æ”¹éƒ¨åˆ†çš„ private copies ä¼šè¢«åˆ›å»ºã€‚å½“bufferè¢«åƒåœ¾å›æ”¶ï¼Œæ›´æ”¹å°±ä¸¢å¤±ã€‚</li>
</ul>

<p>æŒ‡å®šçš„æ˜ å°„æ¨¡å¼å—åˆ°è°ƒç”¨ç€FileChannelå¯¹è±¡è®¿é—®æƒé™çš„é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ file channelæ˜¯åªè¯»æ‰“å¼€çš„ï¼Œè¯·æ±‚READ_WRITE modeï¼Œ map()æŠ›å‡ºNonWritableChannelException ã€‚ç±»ä¼¼åœ° NonReadableChannelException ã€‚</p>

<p><strong>æŠ€å·§</strong>ï¼šè°ƒç”¨MappedByteBufferâ€™s isReadOnly() æ–¹æ³•çœ‹ä½ èƒ½ä¸èƒ½æ›´æ”¹ mapped file ã€‚</p>

<p>position and size å‚æ•°å®šä¹‰å¼€å§‹ä½ç½®å’Œæ˜ å°„åŒºåŸŸèŒƒå›´ã€‚ä¸æ˜¯è´Ÿçš„ã€‚ä¸èƒ½è¶…è¿‡Integer.MAX_VALUE ã€‚</p>

<p>æŒ‡å®šçš„rangeä¸èƒ½è¶…è¿‡æ–‡ä»¶sizeï¼Œå› ä¸ºæ–‡ä»¶ä¼šè¢«å˜å¾—æ›´å¤§æ¥æ¥æ”¶rangeã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ sizeä¸ºInteger.MAX_VALUE ï¼Œæ–‡ä»¶ä¼šè¶…è¿‡2Gã€‚åŒæ—¶ï¼Œå¯¹äºåªè¯»æ˜ å°„ï¼Œ map() å¯èƒ½æŠ›å‡ºIOException ã€‚</p>

<p>è¿”å›çš„MappedByteBuffer å¯¹è±¡è¡¨ç°å¾—åƒä¸€ä¸ªmemory-mapped bufferã€‚ä½†æ˜¯å†…å®¹ä¿å­˜åœ¨æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªå¯¹è±¡è°ƒç”¨get() ï¼Œå¾—åˆ°å½“å‰æ–‡ä»¶å†…å®¹ï¼Œç”šè‡³è¿™äº›å†…å¦‚è¢«å¤–éƒ¨ç¨‹åºæ›´æ”¹çš„æ—¶å€™ã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœä½ æœ‰å†™æƒé™ï¼Œ è°ƒç”¨ put()  æ›´æ–°æ–‡ä»¶ï¼Œæ›´æ”¹å¯¹å¤–éƒ¨ç¨‹åºå¯ç”¨ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šå› ä¸ºmapped byte buffers æ˜¯direct byte buffers ï¼Œåˆ†é…ç»™å®ƒä»¬çš„å†…å­˜ç©ºé—´å­˜åœ¨äºJVMå †ä¹‹å¤–ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MappedByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">fileChannel</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nc">FileChannel</span><span class="o">.</span><span class="na">MapMode</span><span class="o">.</span><span class="na">READ_ONLY</span><span class="o">,</span> <span class="mi">50</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
</code></pre></div></div>

<p>è¿™ä¸ªä¾‹å­æ˜ å°„ä¸€ä¸ªå­èŒƒå›´ï¼Œä»50åˆ°149ã€‚ä¸‹é¢æ˜¯å…¨éƒ¨æ–‡ä»¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MappedByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span>
<span class="n">fileChannel</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nc">FileChannel</span><span class="o">.</span><span class="na">MapMode</span><span class="o">.</span><span class="na">READ_ONLY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">fileChannel</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</code></pre></div></div>

<p>æ²¡æœ‰unmap() æ–¹æ³•ã€‚ä¸€æ—¦æ˜ å°„å»ºç«‹äº†ï¼Œå®ƒä¼šåœ¨åƒåœ¾æ”¶é›†å‰ä¸€ç›´å­˜åœ¨ï¼ˆæˆ–è€…ç¨‹åºå…³é—­ï¼‰ã€‚å› ä¸ºa mapped byte buffer æ²¡æœ‰è¿æ¥åˆ°å»ºç«‹å®ƒçš„ file channel ï¼Œå½“file channelå…³é—­mapping ä¸ä¼šé”€æ¯ã€‚</p>

<p>MappedByteBuffer æ–¹æ³•ç»§æ‰¿äºjava.nio.ByteBuffer ã€‚æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>MappedByteBuffer load():  å°è¯•åŠ è½½å…¨éƒ¨æ˜ å°„æ–‡ä»¶åˆ°å†…å­˜ã€‚è¿™ä¼šä½¿å¤§æ–‡ä»¶è®¿é—®æ›´å¿«å› ä¸º virtual memory manager  ä¸éœ€è¦åœ¨æ–‡ä»¶çš„éƒ¨åˆ†è¢«é€šè¿‡mapped bufferè¯·æ±‚çš„æ—¶å€™åŠ è½½æ–‡ä»¶çš„éƒ¨åˆ†åˆ°å†…å­˜ï¼ˆby reading from/writing to their locations ï¼‰ã€‚load() åšäº†æœ€å¤§åŠªåŠ›ï¼Œå¯èƒ½ä¸æˆåŠŸå› ä¸ºé¢å¤–ç¨‹åºä¼šä½¿ virtual memory manager ç§»é™¤æ–‡ä»¶éƒ¨åˆ†çš„å†…å®¹æ¥ä¸ºåŠ è½½å†…å®¹åˆ°ç‰©ç†ç©ºé—´çš„è¯·æ±‚ç•™å‡ºç©ºé—´ã€‚å¦å¤–ï¼Œload() æ˜¯expensive time-wise ï¼Œä»–ä¼šä½¿virtual memory manager æ‰§è¡ŒI/Oï¼›å®Œæˆè¿™ä¸ªæ–¹æ³•è¦èŠ±è´¹æ—¶é—´</li>
  <li>boolean isLoaded(): å½“å…¨éƒ¨æ˜ å°„æ–‡ä»¶å†…å®¹è¢«åŠ è½½åˆ°å†…å­˜è¿”å›true ï¼›å¦åˆ™falseã€‚å¦‚æœè¿”å›trueï¼Œä½ å¯ä»¥ç”¨å¾ˆå°‘æˆ–æ²¡æœ‰çš„I/Oæ“ä½œæ¥è®¿é—®æ–‡ä»¶ã€‚å¦‚æœè¿”å›falseï¼Œbuffer access ä»ç„¶å¯èƒ½å¾ˆå¿«ï¼Œmapped contentå®Œå…¨å±…äºå†…å­˜ã€‚è€ƒè™‘isLoaded() ä¸ºæš—ç¤ºæ˜ å°„å­—èŠ‚ç¼“å†²åŒºçš„çŠ¶æ€ã€‚</li>
  <li>MappedByteBuffer force(): è®©å¯¹mapped byte buffer çš„æ›´æ”¹å†™å…¥å‚¨å­˜ã€‚å½“ä½¿ç”¨mapped byte buffers çš„æ—¶å€™ï¼Œä½ åº”è¯¥ç”¨è¿™ä¸ªæ–¹æ³•è€Œä¸æ˜¯file channelâ€™s force() æ–¹æ³•ï¼Œå› ä¸ºchannelå¯èƒ½æ²¡æ„è¯†åˆ°é€šè¿‡mapped byte buffer åšå‡ºçš„æ›´æ”¹ã€‚åœ¨ READ_ONLY and PRIVATE mappings è¿™ä¸ªæ–¹æ³•æ²¡ç”¨ã€‚</li>
</ul>

<p><strong><em>Listing 7-5. Demonstrating File Mapping</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelDemo4</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"arg is 1"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">RandomAccessFile</span> <span class="n">raf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="s">"rw"</span><span class="o">);</span>
        <span class="nc">FileChannel</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">raf</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Size: "</span> <span class="o">+</span> <span class="n">size</span><span class="o">);</span>
        <span class="nc">MappedByteBuffer</span> <span class="n">mbb</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nc">FileChannel</span><span class="o">.</span><span class="na">MapMode</span><span class="o">.</span><span class="na">READ_WRITE</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">mbb</span><span class="o">.</span><span class="na">remaining</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">mbb</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mbb</span><span class="o">.</span><span class="na">limit</span><span class="o">()</span> <span class="o">/</span> <span class="mi">2</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">byte</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">mbb</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="kt">byte</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">mbb</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">mbb</span><span class="o">.</span><span class="na">limit</span><span class="o">()</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
            <span class="n">mbb</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">b2</span><span class="o">);</span>
            <span class="n">mbb</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">mbb</span><span class="o">.</span><span class="na">limit</span><span class="o">()</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">b1</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">mbb</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">mbb</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">mbb</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Size: 67
Roses are red,
Violets are blue,
Sugar is sweet,
And so are you!
!uoy era os dnA
,teews si raguS
,eulb era steloiV
,der era sesoR

</code></pre></div></div>

<h6 id="transferring-bytes-among-channels">Transferring Bytes Among Channels</h6>

<p>ä¸ºäº†ä¼˜åŒ–æ‰§è¡Œæ‰¹é‡ä¼ è¾“çš„å¸¸è§„åšæ³•ï¼Œ FileChannel æ·»åŠ äº†2ä¸ªæ–¹æ³•é¿å…äº†å¯¹ä¸­é—´buffersçš„éœ€æ±‚ï¼š</p>

<ul>
  <li>long transferFrom(ReadableByteChannel src, long position, long count)</li>
  <li>long transferTo(long position, long count, WritableByteChannel target)</li>
</ul>

<p>transferFrom(ReadableByteChannel, long, long) ï¼Œä»ç»™å®šå¯è¯»å­—èŠ‚channelä¼ è¾“å­—èŠ‚åˆ°channels fileã€‚src source channelï¼Œ position æŒ‡å®šæ–‡ä»¶ä¼ è¾“åˆ°æ–‡ä»¶çš„å¼€å§‹ä½ç½®ï¼Œcount æŒ‡å®šäº†è¦ä¼ è¾“çš„éè´Ÿæœ€å¤§å€¼ã€‚</p>

<p>è¿”å›å®é™…è¢«ä¼ è¾“çš„å­—èŠ‚æ•°ã€‚</p>

<p>transferTo(long, long, WritableByteChannel) ä»channelçš„fileä¼ è¾“å­—èŠ‚åˆ°ç»™å®šå¯å†™channelã€‚</p>

<p>å½“ä½¿ç”¨transferTo() ï¼Œposition plus count å¤§äºfile sizeæ—¶ï¼Œä¼ è¾“åœ¨æ–‡ä»¶æœ«åœæ­¢ã€‚ transferFrom() ï¼Œå½“srcæ˜¯fileï¼Œåˆ°è¾¾æ–‡ä»¶åä¼šåœæ­¢ã€‚</p>

<p><strong><em>Listing 7-6. Demonstrating Channel Transfer</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.Channels</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.WritableByteChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-08 15:07
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelDemo5</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"usage: java ChannelDemo filespec"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]))</span> <span class="o">{</span>
            <span class="nc">FileChannel</span> <span class="n">inChannel</span> <span class="o">=</span> <span class="n">fis</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
            <span class="nc">WritableByteChannel</span> <span class="n">outChannel</span> <span class="o">=</span> <span class="nc">Channels</span><span class="o">.</span><span class="na">newChannel</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
            <span class="n">inChannel</span><span class="o">.</span><span class="na">transferTo</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">inChannel</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">outChannel</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="socket-channels">Socket Channels</h5>

<p>å…ˆå‰æåˆ°ï¼Œ Socket å£°æ˜äº† SocketChannel getChannel() æ–¹æ³•è¿”å›socket channel å®ä¾‹ï¼Œæè¿°äº†ä¸€ä¸ªåˆ°socketçš„ open connection ã€‚ä¸åƒsocketsï¼Œsocket channelsæ˜¯selectable çš„ï¼Œå¯ä»¥ function in nonblocking modeã€‚è¿™äº›èƒ½åŠ›æé«˜å¤§å‹åº”ç”¨ç¨‹åºçš„å¯ä¼¸ç¼©æ€§å’Œçµæ´»æ€§ ï¼ˆä¾‹å¦‚web serversï¼‰ã€‚</p>

<p>Socket channels ç”±<code class="language-plaintext highlighter-rouge">java.nio.channels </code>çš„æŠ½è±¡ ServerSocketChannel, SocketChannel, and DatagramChannel ç±»æè¿°ã€‚æ¯ä¸ªç±»æœ€ç»ˆç»§æ‰¿java.nio.channels. SelectableChannel å’Œå®ç° InterruptibleChannel ï¼Œè¿™ä½¿å¾—ServerSocketChannel, SocketChannel, and DatagramChannelçš„å®ä¾‹selectable and interruptible ã€‚SocketChannel and DatagramChannel å®ç°äº†ByteChannel, GatheringByteChannel, and ScatteringByteChannel æ¥å£ï¼Œä½ å¯ä»¥åœ¨åº•ä¸‹çš„socketsä¸Šè¯»å–ï¼Œå†™åˆ°ï¼Œæ‰§è¡Œscatter/gather I/O ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šä¸åƒbuffersæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œserver socket channels, socket channels, and datagram channels æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>

<p>æ¯ä¸ª ServerSocketChannel, SocketChannel, and DatagramChannel å®ä¾‹ä»java.net.ServerSocket , Socket, or java.net.DatagramSocket åˆ›å»ºä¸€ä¸ªå¯¹ç­‰çš„socketå¯¹è±¡ã€‚æ¯ä¸ªç±»éƒ½è¢«æ”¹é€ ä¸ºèƒ½ä½¿ç”¨channelã€‚ä½ å¯ä»¥è°ƒç”¨ServerSocketChannelâ€™s, SocketChannelâ€™s, or DatagramChannelâ€™s socket() æ–¹æ³•è·å–å¯¹ç­‰çš„socketå¯¹è±¡ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šå½“åœ¨ä»socket()è¿”å›çš„ socket instance ä¸Šè°ƒç”¨getChannel() æ–¹æ³•ï¼Œè¿”å›å…³è”çš„ socket channelã€‚ç„¶è€Œåœ¨ä»ServerSocket, Socket, or DatagramSocket å®ä¾‹åŒ–è¿”å›çš„socketä¸Šè°ƒç”¨getChannel() è¿”å›nullã€‚</p>

<h6 id="understanding-nonblocking-mode">Understanding Nonblocking Mode</h6>

<p>Javaâ€™s socketç±»åˆ›å»ºçš„socketsçš„é˜»å¡æ€§è´¨æ˜¯å¯¹Javaé¢å‘ç½‘ç»œåº”ç”¨æ‰©å±•æ€§çš„ä¸¥é‡é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œ ServerSocketç±»çš„Socket accept() æ–¹æ³•ï¼Œåœ¨ä¼ å…¥çš„è¿æ¥åˆ°æ¥ä¹‹å‰ä¼šé˜»å¡ä½ï¼Œåœ¨åˆ°æ¥æ—¶åˆ›å»ºå’Œè¿”å›Socketå®ä¾‹è®©serverå’Œå®¢æˆ·ç«¯äº¤æµã€‚å¦‚æœè¿™ä¸ªæ–¹æ³•ä¸é˜»å¡ï¼Œæ‰©å±•æ€§ä¼šæ”¹å–„å› ä¸ºserverå¯ä»¥å»å®Œæˆå…¶ä»–æœ‰ç”¨çš„å·¥ä½œè€Œä¸æ˜¯å¿…é¡»ç­‰ç€ã€‚</p>

<p>abstract SelectableChannelç±»æ˜¯ServerSocketChannel, SocketChannel, and DatagramChannelçš„å…±åŒç¥–å…ˆã€‚SelectableChannel ä¸ä»…è®©socket channelåœ¨ä¸€ä¸ªselector context å·¥ä½œï¼Œä¹Ÿè®©socket channels é€‰æ‹©ä»¥é˜»å¡/éé˜»å¡æ¨¡å¼å·¥ä½œï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥ä¸é˜»å¡åœ°åœ¨è¾“å…¥ä¸å¯ç”¨æ—¶æ£€æŸ¥è¾“å…¥æˆ–åœ¨output buffer ä¸ºç©ºæ—¶å‘é€è¾“å‡ºã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šSelectableChannel å°†ä¸selectorsç›¸å…³çš„åŠŸèƒ½ä¸éé˜»å¡æ¨¡å¼ç›¸å…³è”ï¼Œå› ä¸ºéé˜»å¡æ¨¡å¼æœ€å¸¸ç”¨äºç»“åˆselector-based multiplexing ã€‚</p>

<p>SelectableChannel æä¾›ä»¥ä¸‹æ–¹æ³• enable blocking or nonblocking ï¼Œå†³å®šchannelæ˜¯ä¸æ˜¯é˜»å¡çš„ï¼Œå’Œå¾—åˆ° blocking lockï¼š</p>

<ul>
  <li>SelectableChannel configureBlocking(boolean block):  æŒ‡å®šè°ƒç”¨ selectable channelçš„blocking statusã€‚trueä¸ºé˜»å¡ã€‚è¿”å› selectable channel æˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼šClosedChannelException ï¼›java.net.channels.IllegalBlockingModeException å½“blockæ˜¯trueï¼Œä½†channelå·²ç»è¢«æ³¨å†Œäº†ä¸€ä¸ªæˆ–å¤šä¸ªselectorsï¼Œ IOException ã€‚</li>
  <li>boolean isBlocking():  æ–°å»ºçš„channelé»˜è®¤æ˜¯é˜»å¡çš„ã€‚</li>
  <li>Object blockingLock():  è¿”å›configureBlocking() ä½¿ç”¨çš„åŠ é”å¯¹è±¡ã€‚è¿”å›å¯¹è±¡åœ¨adaptors çš„å®ç°å¾ˆæœ‰ç”¨ï¼Œéœ€è¦å½“å‰é˜»å¡æ¨¡å¼çš„å€¼åœ¨ä¸€ä¸ªçŸ­æš‚çš„æ—¶é—´ä¸æ”¹å˜ã€‚</li>
</ul>

<p>è®¾ç½®æˆ–é‡ç½®ä¸€ä¸ªselectable channelçš„é˜»å¡çŠ¶æ€æ˜¯çç¢çš„ã€‚ä½¿éé˜»å¡å¯ç”¨ï¼Œä¼ falseåˆ°configureBlocking() ï¼Œä¾‹å¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
<span class="n">ssc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span> <span class="c1">// enable nonblocking mode</span>
</code></pre></div></div>

<p>è™½ç„¶éé˜»å¡ socketsé€šå¸¸ç”¨äº server-oriented åº”ç”¨ï¼Œå®ƒä»¬åœ¨å®¢æˆ·ç«¯ä¹Ÿå¾ˆæœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªGUI-basedåº”ç”¨å¯ä»¥åˆ©ç”¨éé˜»å¡socketsä¿æŒç”¨æˆ·æ¥å£å“åº”ï¼Œå½“å’Œå¤šä¸ªæœåŠ¡å™¨åŒæ—¶äº¤æµçš„æ—¶å€™ã€‚</p>

<p>blockingLock() æ–¹æ³•è®©ä½ é˜»æ­¢å…¶ä»–çº¿ç¨‹æ”¹å˜socket channelçš„é˜»å¡/éé˜»å¡çŠ¶æ€ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›çš„å¯¹è±¡æ˜¯ channel implementationä½¿ç”¨åœ¨æ”¹å˜çŠ¶æ€æ—¶ç”¨äºåŠ é”çš„å¯¹è±¡ã€‚åªæœ‰æŒæœ‰è¿™ä¸ªå¯¹è±¡é”çš„çº¿ç¨‹å¯ä»¥æ”¹å˜statusï¼Œå¹¶ä¸”è¿™ä¸ªé”é€šå¸¸ç”±synchronized å…³é”®å­—è·å¾—ã€‚è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š</p>

<h6 id="exploring-server-socket-channels">Exploring Server Socket Channels</h6>

<p>ServerSocketChannelæ˜¯3ä¸ª socket channelç±»ä¸­æœ€ç®€å•çš„ã€‚æ–¹æ³•åŒ…å«ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>static ServerSocketChannel open():  å°è¯•æ‰“å¼€ä¸€ä¸ª server-socket channel ï¼Œæœ€åˆä¸ç»‘å®šï¼›å®ƒå¿…é¡»åœ¨è¿æ¥è¢«æ¥å—å‰é€šè¿‡å®ƒçš„å…¶ä¸­ä¸€ä¸ªpeer socketâ€™s bind() methods æ¥æŒ‡å®šåœ°å€ã€‚IOException ï¼Œchannelæ‰“ä¸å¼€</li>
  <li>ServerSocket socket(): è¿”å›å’Œè¿™ä¸ª server socket channel å…³è”çš„ peer ServerSocket å®ä¾‹</li>
  <li>SocketChannel accept(): æ¥æ”¶å¯¹è¿™ä¸ªchannelâ€™s socketçš„è¿æ¥ã€‚å¦‚æœè¿™ä¸ªchannelæ˜¯éé˜»å¡çš„ï¼Œå½“æ²¡æœ‰ç­‰å¾…çš„è¿æ¥ä¼šç«‹å³è¿”å›nullï¼Œæˆ–è€…è¿”å›ä»£è¡¨äº†è¿æ¥çš„ socket channelã€‚å¦‚æœé˜»å¡çš„ï¼Œaccept() åœ¨ç›´åˆ°ä¸€ä¸ªæ–°è¿æ¥å¯ç”¨æˆ–è€…å‘ç”ŸI/Oé”™è¯¯å‰æ˜¯å®Œå…¨é˜»å¡çš„ã€‚accept() è¿”å›çš„socket channelæ— è®º server socket channelæ˜¯é˜»å¡è¿˜æ˜¯éé˜»å¡éƒ½æ˜¯é˜»å¡çš„ã€‚æŠ›å‡ºClosedChannelException ï¼›AsynchronousCloseException ï¼›java.nio.channels. NotYetBoundException ã€‚</li>
</ul>

<p>ä¸€ä¸ªserver socket channel åœ¨ TCP/IP stream protocolè¡¨ç°ä¸ºä¸€ä¸ªserver ã€‚ä½ ä½¿ç”¨ server socket channels æ¥ç›‘å¬ä¼ å…¥çš„å®¢æˆ·ç«¯çš„è¿æ¥ã€‚</p>

<p>è°ƒç”¨static open() å·¥å‚æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„server socket channel ã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œ open() è¿”å›ä¸€ä¸ªServerSocketChannel å®ä¾‹ï¼Œå’Œä¸€ä¸ªæœªç»‘å®šçš„ peer ServerSocket  å¯¹è±¡å…³è”ã€‚ä½ å¯ä»¥è°ƒç”¨ socket()å¾—åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œç„¶åè°ƒç”¨ ServerSocketâ€™s bind()  æ–¹æ³•ç»‘å®šserver socket ï¼ˆæ ¹æœ¬ä¸Šæ˜¯ server socket channel ï¼‰åˆ°ä¸€ä¸ªæŒ‡å®šåœ°å€ã€‚</p>

<p>ç„¶åä½ è°ƒç”¨ServerSocketChannelâ€™s accept() æ–¹æ³•æ¥å—ä¼ å…¥çš„è¿æ¥ã€‚å–å†³äºä½ é…ç½®server socket channelä¸ºé˜»å¡/éé˜»å¡ï¼Œæ–¹æ³•è¦ä¹ˆæ˜¯ç«‹åˆ»è¿”å›nullæˆ–è€…ä¸€ä¸ªåˆ°ä¼ å…¥è¿æ¥çš„socket channelï¼Œè¦ä¹ˆåœ¨æœ‰ä¼ å…¥è¿æ¥ä¹‹å‰é˜»å¡ä½ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šä½ ä¹Ÿå¯ä»¥é€‰æ‹©åœ¨socket() è¿”å›çš„ peer ServerSocket å¯¹è±¡ä¸Šè°ƒç”¨ accept() ã€‚ç„¶è€Œï¼Œè¿™ä¸ª accept() æ€»æ˜¯é˜»å¡çš„ã€‚</p>

<p>ä¾‹å­ï¼š</p>

<p><strong><em>Listing 7-7. Demonstrating ServerSocketChannel</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.ServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-08 17:03
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"starting server"</span><span class="o">);</span>
        <span class="nc">ServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">9999</span><span class="o">));</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Local Address: "</span> <span class="o">+</span> <span class="n">ssc</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">getLocalSocketAddress</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>

        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"."</span><span class="o">);</span>
            <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">ssc</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sc</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Receive connection from "</span> <span class="o">+</span> <span class="n">sc</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">getRemoteSocketAddress</span><span class="o">());</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">rewind</span><span class="o">();</span>
                <span class="n">sc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">//shouldn't happen</span>
                    <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>buffer rewind ç„¶åå†…å®¹è¢«å†™åˆ° socket channel ã€‚</p>

<h6 id="exploring-socket-channels">Exploring Socket Channels</h6>

<p>SocketChannel æ˜¯è¿™3ä¸ª socket channel ç±»æœ€å¸¸ç”¨çš„ï¼Œå»ºæ¨¡ä¸€ä¸ªé¢å‘è¿æ¥çš„æµåè®® ï¼ˆå°±åƒTCP/IP ï¼‰ã€‚è¿™ä¸ªç±»æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>static SocketChannel open(): å°è¯•æ‰“å¼€ä¸€ä¸ªsocket channelã€‚æ‰“ä¸å¼€æŠ›å‡ºIOException ã€‚</li>
  <li>static SocketChannel open(InetSocketAddress remoteAddr): å°è¯•open a socket å¹¶æŠŠä»–è¿æ¥åˆ°remoteAddrã€‚è¿™ä¸ªæ–¹ä¾¿æ–¹æ³•æ˜¯è°ƒç”¨open()  ï¼Œåœ¨ resulting socket channel ä¸Šè°ƒç”¨ connect()  ï¼ˆä¼ å…¥åœ°å€ï¼‰ï¼Œç„¶åè¿”å›channel ã€‚AsynchronousCloseException ï¼›ClosedByInterruptException ï¼›java.nio.channels.UnresolvedAddressException ï¼›java.nio.channels.UnsupportedAddressTypeException ï¼›IOException</li>
  <li>Socket socket(): è¿”å›å…³è”è¿™ä¸ª socket channel çš„peer Socket ã€‚</li>
  <li>boolean connect(SocketAddress remoteAddr): å°è¯•æŠŠè¿™ä¸ª socket channelçš„socketå¯¹è±¡è¿æ¥åˆ°remote addressã€‚å¦‚æœè¿™ä¸ªchannelæ˜¯éé˜»å¡çš„ï¼Œè¿™ç§æ–¹æ³•çš„è°ƒç”¨å¯åŠ¨ä¸€ä¸ªéé˜»å¡è¿æ¥æ“ä½œã€‚å¦‚æœè¿æ¥é©¬ä¸Šå»ºç«‹ï¼Œå°±åƒåœ¨æœ¬åœ°è¿æ¥ä¸­å‘ç”Ÿçš„ä¸€æ · ï¼Œæ–¹æ³•è¿”å›trueã€‚å¦åˆ™ï¼Œæ–¹æ³•è¿”å›falseï¼Œå¹¶ä¸”è¿æ¥æ“ä½œå¿…é¡»éšåè¢«å®Œæˆï¼Œé€šè¿‡åå¤è°ƒç”¨ finishConnect() ç›´åˆ°è¿™ä¸ªè¿”å›è¿”å›trueã€‚java.nio.channels.AlreadyConnectedException ï¼›java.nio.channels. ConnectionPendingException ï¼›ClosedChannelException ï¼›AsynchronousCloseException ï¼›ClosedByInterruptException ï¼›UnresolvedAddressException  ï¼›UnsupportedAddressTypeException ï¼›IOException ã€‚</li>
  <li>boolean isConnectionPending(): å½“ä¸€ä¸ªè¿æ¥æ“ä½œæ­£åœ¨ç­‰å¾…å®Œæˆè¿”å›trueï¼›å¦åˆ™è¿”å›falseã€‚</li>
  <li>boolean finishConnect(): å®Œæˆä¸€ä¸ªè¿æ¥socket channelçš„è¿‡ç¨‹ã€‚å½“ socket channelè¢«å®Œå…¨è¿æ¥è¿”å›trueï¼›å¦åˆ™falseã€‚java.nio.channels. NoConnectionPendingException ï¼›ClosedChannelException ï¼› AsynchronousCloseException ï¼› ClosedByInterruptException ï¼›IOException</li>
  <li>boolean isConnected():  å½“channelâ€™s socket æ˜¯opençš„ä¸”è¿æ¥å¥½çš„è¿”å›trueï¼›å¦åˆ™falseã€‚</li>
</ul>

<p>A socket channel è¡¨ç°å¦‚åŒTCP/IP stream protocol çš„å®¢æˆ·ç«¯ã€‚ä½¿ç”¨socket channelså¯åŠ¨è¿æ¥ç›‘å¬æœåŠ¡å™¨ã€‚</p>

<p>è°ƒç”¨ä»»æ„open() æ–¹æ³•åˆ›å»ºä¸€ä¸ªnew socket channelã€‚åœ¨å¹•åï¼Œåˆ›å»ºäº†peer socketå¯¹è±¡ã€‚ è°ƒç”¨SocketChannelâ€™s socket() æ–¹æ³•è¿”å›è¿™ä¸ª peer object ã€‚ä½ ä¹Ÿå¯ä»¥è°ƒç”¨peer Socket object å¯¹è±¡ä¸Šçš„getChannel() è¿”å›original socket channel ã€‚</p>

<p>ä»æ— å‚ open() æ–¹æ³•å¾—åˆ°çš„socket channel æ²¡æœ‰è¢«è¿æ¥ã€‚å°è¯•ä»è¿™ä¸ªsocket channelè¯»å†™æŠ›å‡ºjava.nio.channels.NotYetConnectedException ã€‚åœ¨socket channelæˆ–è€…peer socketä¸Šè°ƒç”¨ connect()  æ¥è¿æ¥socketã€‚</p>

<p>åœ¨socket channelè¢«è¿æ¥åï¼Œç›´åˆ°å…³é—­éƒ½ä¿æŒè¿æ¥ã€‚è°ƒç”¨SocketChannelâ€™s boolean isConnected() çœ‹æ˜¯å¦è¿æ¥äº†ã€‚</p>

<p>å¸¦æœ‰ä¸€ä¸ª java.net.InetSocketAddress å‚æ•°çš„open()è®©ä½ è¿æ¥åˆ°è®©ä½ è¿æ¥åˆ°å¦ä¸€ä¸ªåœ¨æŒ‡å®šçš„è¿œç¨‹åœ°å€çš„ä¸»æœºï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">9999</span><span class="o">));</span> 
</code></pre></div></div>

<p>ç­‰åŒäº</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
<span class="n">sc</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">9999</span><span class="o">);</span>
</code></pre></div></div>

<p>å½“åœ¨ä¸€ä¸ªé˜»å¡çš„socket channelï¼Œé€šè¿‡peer Socket objectæˆ–è€…é€šè¿‡SocketChannelâ€™s connect()/second open() æ–¹æ³•ï¼Œè°ƒç”¨connect() çš„çº¿ç¨‹åœ¨ socket channelè¢«è¿æ¥ä¹‹å‰ä¼šé˜»å¡ã€‚ç„¶è€Œï¼Œå½“socket channel  ä¸æ˜¯é˜»å¡çš„ï¼Œconnect() é©¬ä¸Šè¿”å›ï¼Œé€šå¸¸æ˜¯falseä»£è¡¨è¿æ¥æ²¡å»ºç«‹ï¼ˆè™½ç„¶ä¹Ÿå¯èƒ½å¯¹ local loopback connectionè¿”å›trueï¼‰ï¼Œå› ä¸ºåœ¨ socket channel æ‰§è¡ŒI/Oä¹‹å‰ï¼Œå¿…é¡»å»ºç«‹è¿æ¥ï¼Œä½ éœ€è¦é‡å¤è°ƒç”¨finishConnect() ç›´åˆ°è¿”å›trueã€‚</p>

<p><strong><em>Listing 7-8. Demonstrating SocketChannel</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-09 11:47
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelClient</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">sc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="nc">InetSocketAddress</span> <span class="n">addr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">9999</span><span class="o">);</span>
        <span class="n">sc</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">addr</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">sc</span><span class="o">.</span><span class="na">finishConnect</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"waiting for connecting"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">sc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>server</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>starting server
Local Address: /0:0:0:0:0:0:0:0:9999
..................................................................................................
Receive connection from /127.0.0.1:52506
..................................
Receive connection from /127.0.0.1:52512
..........................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
Receive connection from /127.0.0.1:52523
.............................................................................
Receive connection from /127.0.0.1:52530
..........................................
Receive connection from /127.0.0.1:52537
...............................................................................................................................................
</code></pre></div></div>

<p>client</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Local Address: /0:0:0:0:0:0:0:0:9999
</code></pre></div></div>

<h6 id="exploring-datagram-channels">Exploring Datagram Channels</h6>

<p>DatagramChannel å»ºæ¨¡connectionless packet-oriented protocol ï¼ˆsuch as UDP/IP ï¼‰ã€‚è¿™ä¸ªç±»æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>static DatagramChannel open():  å°è¯•æ‰“å¼€ä¸€ä¸ªdatagram channel ï¼Œæ‰“ä¸å¼€æŠ›å‡ºIOException ã€‚</li>
  <li>DatagramSocket socket(): è¿”å›å’Œè¿™ä¸ª datagram channel å…³è”çš„peer DatagramSocket å®ä¾‹ã€‚</li>
  <li>DatagramChannel connect(SocketAddress remoteAddr): å°è¯•æŠŠè¿™ä¸ªdatagram channelçš„ socket object è¿æ¥åˆ°remoteAddrã€‚channelâ€™s socket è¢«é…ç½®åªä»remoteAddræ¥æ”¶datagramsæˆ–è€…å‘é€åˆ°remoteAddrã€‚ä¸€æ—¦è¿æ¥ï¼Œä¸èƒ½ä»ä»»ä½•å¦å¤–åœ°å€æ¥æ”¶æˆ–å‘é€åˆ°å¦å¤–åœ°å€ã€‚ä¸€ä¸ªdatagram socket ä¿å­˜è¿æ¥ç›´åˆ°æ˜¾ç¤ºåœ°æ–­å¼€æˆ–å…³é—­ã€‚æ–¹æ³•å¦‚æœæˆåŠŸè¿”å›datagram channelã€‚ClosedChannelException ï¼›AsynchronousCloseException ï¼›ClosedByInterruptException ï¼›IOException ï¼›</li>
  <li>boolean isConnected(): å½“è¿™ä¸ªchannelâ€™s socket æ˜¯æ‰“å¼€ä¸”è¿æ¥çŠ¶æ€è¿”å›trueï¼›å¦åˆ™falseã€‚</li>
  <li>DatagramChannel disconnect(): ä»è¿™ä¸ªchannelâ€™s socket æ–­å¼€ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»è°ƒç”¨å¹¶ä¸”ä¸ä¼šå½±å“æ­£åœ¨æ‰§è¡Œçš„è¯»å†™æ“ä½œã€‚å½“æ²¡ socketæ²¡è¿æ¥æˆ–è€…channelå…³é—­äº†ï¼Œæ–¹æ³•æ— æ•ˆã€‚</li>
  <li>SocketAddress receive(ByteBuffer buffer):  é€šè¿‡channelæ¥æ”¶datagramã€‚å¦‚æœdatagram é©¬ä¸Šå¯ç”¨ï¼Œæˆ–è€…channelæ˜¯é˜»å¡çš„datagramå°†å¯ç”¨ï¼Œdatagramè¢«å¤åˆ¶åˆ°ç»™å®šbyte buffer å¹¶ä¸”è¿”å›å®ƒçš„source addressã€‚å¦‚æœchannelæ˜¯éé˜»å¡çš„å¹¶ä¸”datagramä¸ç«‹å³å¯ç”¨ï¼Œæ–¹æ³•ç«‹åˆ»è¿”å›nullã€‚datagram è¢«ä¼ è¾“åˆ°ç»™å®šbyte buffer ï¼Œä»å½“å‰positionå¼€å§‹ï¼Œå°±åƒä¸€ä¸ªå¸¸è§„çš„è¯»æ“ä½œã€‚å¦‚æœbufferé‡Œå‰©ä¸‹çš„å­—èŠ‚æ¯”éœ€è¦ä¿æŒdatagramçš„å­—èŠ‚å°‘ï¼Œä½™ä¸‹çš„datagram é»˜é»˜è¢«ä¸¢å¼ƒã€‚å½“channelä¸é˜»å¡ä¸”æ²¡æœ‰datagramå¯ç”¨ï¼Œè¿”å› datagramâ€™s source address or null ã€‚ClosedChannelException ï¼›AsynchronousCloseException ï¼›ClosedByInterruptException ï¼›IOException</li>
  <li>int send(ByteBuffer buffer, SocketAddress destAddr): é€šè¿‡channelå‘é€datagram ã€‚å¦‚æœchannelæ˜¯éé˜»å¡çš„å¹¶ä¸”åœ¨underlying output buffer æœ‰è¶³å¤Ÿç©ºé—´ï¼Œæˆ–è€…channelæ˜¯é˜»å¡çš„è¶³å¤Ÿç©ºé—´å¯ç”¨ï¼Œåœ¨given bufferé‡Œå‰©ä½™çš„bytes ä½œä¸º  a single datagram è¢«ä¼ è¾“åˆ° given destination address ã€‚datagram ä» byte buffer è¢«ä¼ è¾“ï¼Œå°±åƒä¸€ä¸ªå¸¸è§„å†™æ“ä½œã€‚è¿”å›è¢«å‘é€çš„å­—èŠ‚æ•°é‡ï¼Œå®ƒæ˜¯source buffer é‡Œå‰©ä½™çš„å­—èŠ‚æ•°ï¼Œå½“channel æ˜¯éé˜»å¡çš„ï¼Œå¦‚æœå¯¹äºdatagramçš„underlying output buffer çš„ç©ºé—´ä¸è¶³ï¼Œä¼šè¿”å›0ã€‚ClosedChannelException ï¼›AsynchronousCloseException ï¼›ClosedByInterruptException ï¼›IOException ã€‚</li>
</ul>

<p>å¦å¤–ï¼Œæœ‰å‡ ä¸ªread() and write()  ä½ å¯èƒ½å–œæ¬¢ç”¨ã€‚ä¸åƒsend() and receive() æ˜¯ä¸éœ€è¦datagram channel è¢«è¿æ¥çš„ï¼Œ read() and write() éœ€è¦è¿æ¥ã€‚</p>

<p>è°ƒç”¨static open() è·å¾—DatagramChannel instance ã€‚new datagram channel å’Œ peer DatagramSocket object å…³è”ï¼Œä½ å¯ä»¥è°ƒç”¨DatagramChannelâ€™s socket() æ–¹æ³•è·å¾—è¿™ä¸ªå¯¹è±¡ã€‚</p>

<p>datagram channel  å¯ä»¥è¡¨ç°ä¸ºclient (the sender) ä¹Ÿå¯ä»¥æ˜¯server (the listener) ã€‚åšä¸ºlistener ï¼Œdatagram channel å¿…é¡»ç»‘å®šåˆ°ä¸€ä¸ªport å’Œä¸€ä¸ªoptional addressã€‚å¾—åˆ°DatagramSocket objectï¼Œè°ƒç”¨bind()  ï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DatagramChannel</span> <span class="n">dc</span> <span class="o">=</span> <span class="nc">DatagramChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
<span class="nc">DatagramSocket</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="na">socket</span><span class="o">();</span>
<span class="n">ds</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">9999</span><span class="o">));</span> <span class="c1">// bind to port 9999</span>
</code></pre></div></div>

<p>receive() æ–¹æ³•å¤åˆ¶è¿›æ¥çš„ datagramâ€™s data payload åˆ°å‚æ•°é‡Œçš„ byte buffer ï¼Œè¿”å›çš„socket address æ˜¯datagramâ€™s source address ã€‚å¦‚æœchannelæ˜¯é˜»å¡çš„ï¼Œreceive() åœ¨packetåˆ°æ¥æˆ–è€…ä¸€äº›äº‹ä»¶å¯¼è‡´å¼‚å¸¸ä¹‹å‰sleepã€‚å¦‚æœæ˜¯éé˜»å¡ï¼Œå½“datagramä¸å¯ç”¨è¿”å›nullã€‚å¦‚æœdatagram æ¯”bufferå¤§ï¼Œå¤šä½™çš„å­—èŠ‚è¢«é»˜é»˜ç§»é™¤ã€‚</p>

<p>send() æ–¹æ³•å‘é€ given byte bufferâ€™s content ï¼Œä»bufferçš„å½“å‰positionå¼€å§‹åˆ°bufferçš„limitï¼Œå‘é€åˆ°å‚æ•°æŒ‡å®šçš„destination address/ port number ã€‚å¦‚æœdatagram channelæ˜¯é˜»å¡çš„ï¼Œsend() ä¼šåœ¨datagram is queued for sending æˆ–è€…äº‹ä»¶å¯¼è‡´å¼‚å¸¸æŠ›å‡ºä¹‹å‰sleepã€‚å¦‚æœchannelä¸æ˜¯é˜»å¡çš„ï¼Œè¿”å›2ä¸ªå€¼çš„ä¸€ä¸ªï¼šè¢«å‘é€buffer contentçš„ entire length æˆ–è€…æ˜¯0è¡¨ç¤ºbuffer content æ²¡è¢«å‘é€ï¼ˆå½“ä¼ è¾“å‰æ²¡æœ‰ç©ºé—´ä¿å­˜æ•´ä¸ªdatagramï¼Œä»€ä¹ˆä¹Ÿä¸å‘é€ ï¼‰</p>

<p><strong>æ³¨æ„</strong>ï¼šDatagram protocols æ˜¯ä¸å¯é çš„ã€‚é¦–å…ˆï¼Œä¸ä¿è¯äº¤ä»˜ã€‚å› æ­¤ï¼Œsend() è¿”å›çš„éé›¶å€¼ä¸ä»£è¡¨datagramåˆ°è¾¾äº†ç›®çš„åœ°ã€‚åŒæ—¶ï¼Œunderlying network å¯èƒ½å°†æ•°æ®æŠ¥ç‰‡æ®µåˆ†å‰²æˆå¤šä¸ªå°æ•°æ®åŒ… ã€‚å½“datagramæ˜¯åˆ†å‰²çš„ï¼Œå¾ˆå¯èƒ½ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ•°æ®åŒ…æ²¡æœ‰åˆ°è¾¾ç›®çš„åœ°ã€‚å› ä¸ºreceiverä¸èƒ½ç»„è£…æ‰€æœ‰çš„åŒ…ï¼Œæ•´ä¸ªdatagram è¢«ä¸¢å¼ƒã€‚å› æ­¤ï¼Œ data payloads åº”è¯¥è¢«é™åˆ¶åœ¨æœ€é«˜å‡ ç™¾å­—èŠ‚ã€‚</p>

<p>stock ticker ä¾‹å­ï¼Œä½ éœ€è¦ç”¨datagram channelå¯¹åº”ç»™å®šå…¬å¸æä¾›æœ€è¿‘çš„ stock prices ã€‚å®¢æˆ·ç«¯ä¼šæäº¤companyâ€™s stock symbol ï¼ˆsuch as MSFT for Microsoft ï¼‰ä½œä¸ºdatagram payload ï¼Œæ¥æ”¶datagramå“åº”çš„payload æä¾›äº†requested stock pricesã€‚å› ä¸ºéœ€è¦latest information ï¼Œå½“response datagramæ²¡æ¥åˆ°ï¼Œä¼šé‡æ–°è¯·æ±‚ã€‚</p>

<p><strong><em>Listing 7-9. Using DatagramChannel to Implement a Stock Ticker Server</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.SocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.DatagramChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-09 16:14
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StockTickerServer</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">9999</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"server starting and listening on port "</span> <span class="o">+</span> <span class="no">PORT</span> <span class="o">+</span> <span class="s">" for incoming requests..."</span><span class="o">);</span>
        <span class="nc">DatagramChannel</span> <span class="n">dcServer</span> <span class="o">=</span> <span class="nc">DatagramChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">dcServer</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="no">PORT</span><span class="o">));</span>
        <span class="nc">ByteBuffer</span> <span class="n">symbol</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
        <span class="nc">ByteBuffer</span> <span class="n">payload</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">16</span><span class="o">);</span>

        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">payload</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="n">symbol</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="nc">SocketAddress</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">dcServer</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">symbol</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sa</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Received request from "</span> <span class="o">+</span> <span class="n">sa</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">stockSymbol</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">symbol</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Symbol: "</span> <span class="o">+</span> <span class="n">stockSymbol</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">stockSymbol</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"MSFT"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mf">37.40f</span><span class="o">);</span> <span class="c1">// open share price</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mf">37.22f</span><span class="o">);</span> <span class="c1">// low share price</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">8</span><span class="o">,</span> <span class="mf">37.48f</span><span class="o">);</span> <span class="c1">// high share price</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="mf">37.41f</span><span class="o">);</span> <span class="c1">// close share price</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mf">0.0f</span><span class="o">);</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mf">0.0f</span><span class="o">);</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">8</span><span class="o">,</span> <span class="mf">0.0f</span><span class="o">);</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="mf">0.0f</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">dcServer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">payload</span><span class="o">,</span> <span class="n">sa</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä½¿ç”¨four-byte floating-point valuesä»£è¡¨priceã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šä¸ºäº†æ–¹ä¾¿ï¼Œç”¨ floating-pointè¡¨ç¤ºï¼Œä¸æ˜¯ä¸ªå¥½åšæ³•ï¼Œåº”è¯¥ä½¿ç”¨java.math.BigDecimal ã€‚ä¹Ÿä¸è¦æŠŠpriceåµŒå…¥åˆ°æºç  ï¼Œè€Œæ˜¯ä»å¤–éƒ¨çš„ server or database è·å–ã€‚</p>

<p>tests sa for null çš„ifå¯¹åº”ç”¨æ˜¯ä¸å¿…è¦çš„ï¼Œä½†æ˜¯å¯ä»¥ç”¨äºé…ç½®éé˜»å¡æ¨¡å¼ã€‚</p>

<p>åœ¨è¾“å‡ºä¸€ä¸ªè¯†åˆ«è¯·æ±‚çš„æ¶ˆæ¯åï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯MSTFã€‚æœ€åå‘é€payload datagram payload ç»§ç»­å¾ªç¯ã€‚</p>

<p>Clientï¼š</p>

<p><strong><em>Listing 7-10. Using DatagramChannel to Implement a Stock Ticker Client</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.SocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.DatagramChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-09 16:14
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StockTickerServer</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">9999</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"server starting and listening on port "</span> <span class="o">+</span> <span class="no">PORT</span> <span class="o">+</span> <span class="s">" for incoming requests..."</span><span class="o">);</span>
        <span class="nc">DatagramChannel</span> <span class="n">dcServer</span> <span class="o">=</span> <span class="nc">DatagramChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">dcServer</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="no">PORT</span><span class="o">));</span>
        <span class="nc">ByteBuffer</span> <span class="n">symbol</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
        <span class="nc">ByteBuffer</span> <span class="n">payload</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">16</span><span class="o">);</span>

        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">payload</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="n">symbol</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="nc">SocketAddress</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">dcServer</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">symbol</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sa</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Received request from "</span> <span class="o">+</span> <span class="n">sa</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">stockSymbol</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">symbol</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Symbol: "</span> <span class="o">+</span> <span class="n">stockSymbol</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">stockSymbol</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"MSFT"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mf">37.40f</span><span class="o">);</span> <span class="c1">// open share price</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mf">37.22f</span><span class="o">);</span> <span class="c1">// low share price</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">8</span><span class="o">,</span> <span class="mf">37.48f</span><span class="o">);</span> <span class="c1">// high share price</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="mf">37.41f</span><span class="o">);</span> <span class="c1">// close share price</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mf">0.0f</span><span class="o">);</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mf">0.0f</span><span class="o">);</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">8</span><span class="o">,</span> <span class="mf">0.0f</span><span class="o">);</span>
                <span class="n">payload</span><span class="o">.</span><span class="na">putFloat</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="mf">0.0f</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">dcServer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">payload</span><span class="o">,</span> <span class="n">sa</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å®¢æˆ·ç«¯æ˜¯ç›´æ¥å‘é€çš„ã€‚</p>

<h5 id="pipes">Pipes</h5>

<p>java.nio.channels åŒ…æœ‰ä¸€ä¸ªPipe ç±»ã€‚Pipeæè¿°äº†ä¸€å¯¹channelsï¼Œå®ç°äº†unidirectional pipe ï¼ˆå•å‘ç®¡é“ï¼‰ï¼Œæ˜¯åœ¨ä¸¤ä¸ªå®ä½“é—´å•æ–¹å‘ä¼ é€’æ•°æ®çš„ç®¡é“ï¼Œæ¯”å¦‚ä¸¤ä¸ªfile channels æˆ–ä¸¤ä¸ªsocket channels ä¹‹é—´ã€‚Pipeç±»ä¼¼äºjava.io.PipedInputStream and java.io.PipedOutputStream ç±»â€”â€”â€”see Chapter 4 ã€‚</p>

<p>Pipeå†…åµŒå£°æ˜äº† SourceChannel and SinkChannel ç±»åˆ†åˆ«å……å½“readable and writable byte channels ã€‚ Pipe  ä¹Ÿå£°æ˜ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>static Pipe open(): openä¸€ä¸ªnew pipe</li>
  <li>SourceChannel source(): è¿”å›pipeçš„source channel ï¼ˆæ•°æ®æ¥æºï¼‰</li>
  <li>SinkChannel sink():  è¿”å›pipeçš„sink channelï¼ˆæ•°æ®è¢«å‘é€åˆ°çš„åœ°æ–¹ï¼‰</li>
</ul>

<p><strong><em>Listing 7-11. Producing and Consuming Bytes via a Pipe</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.Pipe</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.ReadableByteChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.WritableByteChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-09 17:36
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelDemo6</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">BUFSIZE</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">LIMIT</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Pipe</span> <span class="n">pipe</span> <span class="o">=</span> <span class="nc">Pipe</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">WritableByteChannel</span> <span class="n">src</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="na">sink</span><span class="o">();</span>
            <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="no">BUFSIZE</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">LIMIT</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="no">BUFSIZE</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">*</span> <span class="mi">256</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">src</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">;</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ioe</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">src</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">},</span> <span class="s">"sender"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">ReadableByteChannel</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="na">source</span><span class="o">();</span>
            <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="no">BUFSIZE</span><span class="o">);</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">dst</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span>

        <span class="o">},</span> <span class="s">"receiver"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>sender taskè°ƒç”¨Pipeâ€™s sink() å¾—åˆ°writable byte channel ã€‚ç„¶ååˆ†é…ç”¨äºå‚¨å­˜è¦è¢«å†™çš„å†…å®¹çš„byte bufferã€‚ç„¶åä¸€å¯¹forå¾ªç¯ç”¨äºå‘é€byte-oriented dataåˆ°writable byte channelã€‚æ¯ä¸€ä¸ªå¤–éƒ¨forå¾ªç¯è¿­ä»£å…ˆclear bufferï¼Œå‡†å¤‡ç”¨äºå†…å¾ªç¯å¡«å……bufferã€‚ç„¶åè¢«flippedå‡†å¤‡æ’å¹²ï¼Œé€šè¿‡ä¼ é€’bufferåˆ° writable byte channelâ€™s write() æ–¹æ³•ã€‚å› ä¸ºå•æ¬¡æ–¹æ³•è°ƒç”¨å¯èƒ½ä¸ä¼šæ’å¹²å…¨éƒ¨bufferï¼Œwrite() åœ¨å¾ªç¯é‡Œè°ƒç”¨ç›´åˆ°è¿”å›0ï¼Œ0æ„å‘³ç€æ²¡æœ‰æ›´å¤šçš„å†…å®¹å¯ä»¥å†™ã€‚ channelç„¶åè¢«å…³é—­ï¼Œæ‰€ä»¥receiver task ä»channel è¯»çš„æ—¶å€™ä¸ä¼šé˜»å¡ï¼Œå®ƒå¸Œæœ›è·å¾—æ›´å¤šçš„æ•°æ® ã€‚</p>

<p>receiver taskè°ƒç”¨ Pipeâ€™s source() å¾—åˆ°readable byte channel ï¼Œç„¶ååˆ†é…bufferå­˜å‚¨read contentã€‚</p>

<p>ç„¶åæ˜¯whileå¾ªç¯æŒç»­ä»channelè¯»ç›´åˆ°read() è¿”å›-1ï¼Œè¡¨æ˜channelåˆ°è¾¾äº†æµçš„endã€‚å¦‚æœsenderâ€™s run() æ–¹æ³•æ²¡æœ‰å…³é—­channelï¼Œè¿™ä¸ªæ–¹æ³•ä¸ä¼šåˆ°è¾¾æµçš„endã€‚æ­¤æ—¶ï¼Œbufferè¢«flippedç”¨äºæ’å¹²ã€‚ç„¶åé€šè¿‡æ‰“å° byte values åˆ°æ ‡å‡†è¾“å‡ºæµæ’å¹²äº†bufferã€‚æ¯ä¸ªå­—èŠ‚bitwise ANDed with 255 é˜²æ­¢è¾“å‡ºè´Ÿå€¼ã€‚æ ¹æœ¬ä¸Šï¼Œget() è¿”å›8-bit integer value ï¼Œåœ¨System.out.println()æ—¶è½¬æ¢ä¸º 32-bit integer ã€‚è¿™ä¸ªè½¬æ¢åº”ç”¨äº†ç¬¦å·æ‰©å±•ï¼ˆ sign extension ï¼‰ï¼Œè¿™æ„å‘³ç€ä¸€äº›å­—èŠ‚å€¼å˜æˆè´Ÿçš„32-bit integers ã€‚ä½†æ˜¯bitwise ANDing the byte value with 255 ï¼Œä¿è¯ä¸ä¼šè½¬åŒ–ä¸ºè´Ÿå€¼ã€‚æœ€åbufferè¢«clearç”¨äºå¡«å……ï¼Œå¾ªç¯ç»§ç»­ã€‚</p>

<p>è¾“å‡º</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">245</span>
<span class="mi">56</span>
<span class="mi">137</span>
<span class="mi">166</span>
<span class="mi">52</span>
<span class="mi">183</span>
<span class="mi">252</span>
<span class="mi">166</span>
<span class="mi">246</span>
<span class="mi">124</span>
<span class="mi">163</span>
<span class="mi">11</span>
<span class="mi">159</span>
<span class="mi">68</span>
<span class="mi">203</span>
<span class="mi">118</span>
<span class="mi">157</span>
<span class="mi">70</span>
<span class="mi">54</span>
<span class="mi">148</span>
<span class="mi">186</span>
<span class="mi">17</span>
<span class="mi">12</span>
<span class="mi">203</span>
<span class="mi">75</span>
<span class="mi">223</span>
<span class="mi">224</span>
<span class="mi">175</span>
<span class="mi">205</span>
<span class="mi">47</span>
</code></pre></div></div>

<h4 id="exercises">EXERCISES</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The following exercises are designed to test your understanding of Chapter 7â€™s content:
1. What is a channel?
2. What capabilities does the Channel interface provide?
3. Identify the three interfaces that directly extend Channel.
4. True or false: A channel that implements InterruptibleChannel is
asynchronously closeable.
5. Identify the two ways to obtain a channel.
6. Define scatter/gather I/O.
7. What interfaces are provided for achieving scatter/gather I/O?
8. Define file channel.
9. True or false: File channels donâ€™t support scatter/gather I/O.
10. Define exclusive lock and shared lock.
11. What is the fundamental difference between FileChannelâ€™s lock()
and tryLock() methods?
12. What does the FileLock lock() method do when either a lock
is already held that overlaps this lock request or another thread is
waiting to acquire a lock that will overlap with this request?
13. Specify the pattern that you should adopt to ensure that an acquired
file lock is always released.
14. What method does FileChannel provide for mapping a region of a
file into memory?
15. Identify the three file-mapping modes.
16. Which file-mapping mode corresponds to copy-on-write?
17. Identify the FileChannel methods that optimize the common
practice of performing bulk transfers.
18. True or false: Socket channels are selectable and can function in
nonblocking mode.
19. Identify the three classes that describe socket channels.
20. True or false: Datagram channels are not thread-safe.
21. Why do socket channels support nonblocking mode?
22. How would you obtain a socket channelâ€™s associated socket?
23. How do you obtain a server socket channel?
24. Create a Copy application that uses the ByteBuffer and
FileChannel classes in partnership with FileInputStream and
FileOutputStream to copy a source file to a destination file.

</code></pre></div></div>

<h4 id="summary-6">Summary</h4>

<p>Channels partner with buffers to achieve high-performance I/O. A channel is an object that represents an open connection to a hardware device, a file, a network socket, an application component, or another entity thatâ€™s capable of performing write, read, and other I/O operations. Channels efficiently transfer data between byte buffers and operating system-based I/O service sources or destinations.</p>

<p>Java supports channels by providing the Channel interface, its WritableByteChannel and ReadableByteChannel subinterfaces, the Channels class, and other types in the java.nio.channels package. While exploring this package, you learned about scatter/gather I/O, file channels (in terms of the FileChannel class with emphasis on its file locking, memory-mapped file I/O, and byte-transfer capabilities), socket channels, and pipes.</p>

<h3 id="chapter-8-selectors">Chapter 8 Selectors</h3>

<p>I/Oè¦ä¹ˆæ˜¯block-oriented (such as file I/O)è¦ä¹ˆæ˜¯stream-oriented (such as network I/O)ã€‚Streamsé€šå¸¸æ¯”block devices (such as fixed disks) æ…¢ï¼Œå¹¶ä¸”è¯»å†™æ“ä½œé€šå¸¸é€ æˆè°ƒç”¨çº¿ç¨‹åœ¨è¾“å…¥å¯ç”¨æˆ–è¾“å‡ºè¢«å®Œå…¨å†™å‡ºä¹‹å‰é˜»å¡ä½ã€‚ä¸ºäº†å¼¥è¡¥ï¼Œç°ä»£æ“ä½œç³»ç»Ÿè®©streamsä»¥éé˜»å¡æ¨¡å¼æ“ä½œï¼Œè¿™è®©ä¸€ä¸ªçº¿ç¨‹ä¸é˜»å¡åœ°è¯»å†™æ•°æ®æˆä¸ºå¯èƒ½ã€‚æ“ä½œå®Œå…¨æˆåŠŸæˆ–è¡¨æ˜éƒ¨åˆ†æˆåŠŸã€‚ä¸ç®¡æ€æ ·ï¼Œçº¿ç¨‹å¯ä»¥å»æ‰§è¡Œå…¶ä»–æœ‰ç”¨çš„å·¥ä½œè€Œä¸æ˜¯ç­‰å¾…ã€‚</p>

<p>Nonblocking mode doesnâ€™t let an application determine if it can perform an operation without actually performing the operationã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªéé˜»å¡readçº¿ç¨‹æˆåŠŸï¼Œåº”ç”¨çŸ¥é“è¯»æ“ä½œæ˜¯å¯èƒ½çš„ä¹ŸçŸ¥é“è¯»äº†ä¸€äº›å¿…é¡»ç®¡ç†çš„æ•°æ®ã€‚è¿™ä¸ªdualityé˜²æ­¢ä½ æŠŠæ£€æŸ¥è¯»æµä» data-processingä»£ç åˆ†ç¦»ï¼Œä¸ä¼šè®©ä½ çš„ä»£ç æ˜æ˜¾å¤æ‚ã€‚</p>

<p>éé˜»å¡æ¨¡å¼å……å½“æ‰§è¡Œ <em>readiness selection</em> çš„åŸºç¡€ï¼Œè¿™å°†æŠŠå·¥ä½œè½¬äº¤ç»™æ“ä½œç³»ç»Ÿï¼Œåœ¨ä¸å®é™…æ‰§è¡Œæ“ä½œçš„æƒ…å†µä¸‹checking for I/O stream readinessæ¥æ‰§è¡Œå†™ã€è¯»å’Œå…¶ä»–æ“ä½œã€‚ æ“ä½œç³»ç»Ÿè¢«æŒ‡ç¤ºè§‚æµ‹ä¸€ç»„streamsï¼Œå¹¶è¿”å›ä¸€äº›è¿¹è±¡è¡¨æ˜å“ªäº›æµå‡†å¤‡å¥½æ‰§è¡Œä¸€ä¸ªç‰¹å®šæ“ä½œï¼ˆsuch as read ï¼‰æˆ–ä¸€äº›ç‰¹å®šæ“ä½œï¼ˆsuch as accept and read  ï¼‰ã€‚è¿™ä¸ªèƒ½åŠ›è®©ä¸€ä¸ªçº¿ç¨‹<em>multiplex</em>(å¤šè·¯å¤ç”¨)ä¸€ä¸ªæ½œåœ¨çš„å·¨å¤§æ•°é‡çš„active streamsï¼Œé€šè¿‡ä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„ readiness informationã€‚ç”¨è¿™ç§æ–¹å¼ï¼Œnetwork servers å¯ä»¥å¤„ç†å¾ˆå¤§æ•°é‡çš„ç½‘ç»œè¿æ¥ï¼›ä»–ä»¬æå¤§åœ°æ‰©å±•äº†ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šç°ä»£æ“ä½œç³»ç»Ÿè®©readiness selectionå¯¹åº”ç”¨å¯ç”¨ï¼Œé€šè¿‡ä¾‹å¦‚ POSIX select() çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>

<p>Selectors è®©ä½ åœ¨Java contextå¾—åˆ°readiness selectionã€‚</p>

<h4 id="selector-fundamentals">Selector Fundamentals</h4>

<p>ä¸€ä¸ªselectorå¯¹è±¡æ˜¯abstract java.nio. channels.Selectorç±»çš„å­ç±»åˆ›å»ºçš„å¯¹è±¡ã€‚selectorç»´æŠ¤ä¸€ä¸ªchannelsçš„set ï¼Œæ£€æŸ¥æ¥ç¡®å®šé‚£ä¸ªchannelå‡†å¤‡å¥½äº†ç”¨äºreading, writing, completing a connection sequence, accepting another connection, or some combination of these tasksã€‚å®é™…çš„å·¥ä½œæ˜¯å§”æ‰˜ç»™æ“ä½œç³»ç»Ÿçš„ï¼Œé€šè¿‡POSIX select()æˆ–ç±»ä¼¼ç³»ç»Ÿè°ƒç”¨ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šæ£€æŸ¥ä¸€ä¸ªchannelçš„èƒ½åŠ›åœ¨ä¸€äº›ä¸œè¥¿è¿˜æ²¡å°±ç»ªçš„æ—¶å€™ï¼ˆsuch as bytes are not available for reading ï¼‰æ˜¯ä¸éœ€è¦ç­‰å¾…çš„ï¼ŒåŒæ—¶ä¹Ÿä¸ç”¨å¿…é¡»æ‰§è¡Œæ“ä½œè™½ç„¶æ£€æŸ¥æ˜¯å¯ä¼¸ç¼©æ€§çš„å…³é”®ã€‚ä¸€ä¸ªsingle threadå¯ä»¥ç®¡ç†å¾ˆå¤§æ•°ç›®çš„channelsï¼Œè¿™å‡å°‘äº†ä»£ç å¤æ‚æ€§å’Œæ½œåœ¨çš„çº¿ç¨‹issuesã€‚</p>

<p>Selectorsæ˜¯ä½¿ç”¨ <em>selectable channels</em> çš„ï¼Œæ˜¯æœ€ç»ˆç»§æ‰¿java.nio.channels.SelectableChannelçš„ç±»ï¼Œæè¿°äº†ä¸€ä¸ªchannelå¯ä»¥è¢«selector multiplexedã€‚Socket channels, server socket channels, datagram channels, and pipe source/sink channels æ˜¯ selectable channels ï¼Œå› ä¸ºjava.nio.channels. SocketChannel, java.nio.channels.ServerSocketChannel, java.nio. channels.DatagramChannel, java.nio.channels.Pipe.SinkChannel, and java.nio.channels.Pipe.SourceChannel ç”±SelectableChannelæ´¾ç”Ÿã€‚ä¸åŒçš„æ˜¯ï¼Œfile channelsä¸æ˜¯ selectable channels ï¼Œå› ä¸ºjava.nio. channels.FileChannel åœ¨ç¥–å…ˆä¸åŒ…å«SelectableChannel ã€‚</p>

<p>ä¸€ä¸ªæˆ–å¤šä¸ªä¹‹å‰åˆ›å»ºçš„selectable channelsæ˜¯ç”¨ä¸€ä¸ªselectoræ³¨å†Œçš„ã€‚æ¯ä¸ªæ³¨å†Œè¿”å›ä¸€ä¸ªabstract SelectionKeyç±»çš„å­ç±»çš„å®ä¾‹ï¼Œ å®ƒæ˜¯ä¸ªtokenä»£è¡¨äº†channelå’Œselectorä¹‹é—´çš„å…³ç³»ã€‚<em>key</em>è·Ÿè¸ªä¸¤ä¸ªæ“ä½œçš„setï¼šinterest set and ready set ã€‚ interest set è¯†åˆ« åœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨é€‰æ‹©å™¨çš„é€‰æ‹©æ–¹æ³•æ—¶ï¼Œè¦å¯¹å…¶è¿›è¡Œæµ‹è¯•çš„operation categoriesã€‚ ready set è¯†åˆ«  keyâ€™s channel è¢«å‘ç°ä¸”å‡†å¤‡å¥½çš„ operation categoriesã€‚å½“ selection method è¢«è°ƒç”¨ï¼Œ é€šè¿‡æ£€æŸ¥æ‰€æœ‰selectoræ³¨å†Œçš„channels æ¥æ›´æ–°selectorçš„ç›¸å…³keysã€‚åº”ç”¨ç„¶åå¯ä»¥è·å¾—ä¸€ä¸ªkeysçš„set ï¼Œå®ƒçš„channelså·²ç»è¢«æ‰¾åˆ°å¹¶ä¸”iterate over these keys to service each channel that has become ready ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šä¸€ä¸ªselectable channelå¯ä»¥ä¸æ­¢ä¸€ä¸ªselector æ³¨å†Œã€‚å®ƒä¸çŸ¥é“å®ƒå½“å‰æ³¨å†Œçš„selectorsã€‚</p>

<p>è¦ç”¨selectors ï¼Œè¦å…ˆå»ºä¸€ä¸ªã€‚è°ƒç”¨ Selectorâ€™s Selector open() æ–¹æ³•ï¼ŒæˆåŠŸè¿”å›Selector å®ä¾‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</code></pre></div></div>

<p>ä½ å¯ä»¥åœ¨åˆ›å»ºselector ä¹‹å‰æˆ–ä¹‹ååˆ›å»º selectable channels ã€‚ç„¶è€Œï¼Œåœ¨ç”¨selector æ³¨å†Œchannelå‰ï¼Œä½ éœ€è¦ä¿è¯æ¯ä¸ªchannelæ˜¯éé˜»å¡æ¨¡å¼ã€‚æ³¨å†Œæ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SelectionKey</span> <span class="nf">register</span><span class="o">(</span><span class="nc">Selector</span> <span class="n">sel</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ops</span><span class="o">)</span>
	<span class="nc">SelectionKey</span> <span class="nf">register</span><span class="o">(</span><span class="nc">Selector</span> <span class="n">sel</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ops</span><span class="o">,</span>
<span class="nc">Object</span> <span class="n">att</span><span class="o">)</span>
</code></pre></div></div>

<p>æ¯ä¸ªæ–¹æ³•éœ€è¦ä½ ä¼ å…¥ä¸€ä¸ªå…ˆå‰åˆ›å»ºçš„selectorï¼Œä¸€ä¸ªbitwise ORed combination of the following SelectionKey int-based constants ï¼Œå®ƒè¡¨ç¤ºinterest set ï¼š</p>

<ul>
  <li>OP_ACCEPT: Operation-set bit for socket-accept operations.</li>
  <li>OP_CONNECT: Operation-set bit for socket-connect operations</li>
  <li>OP_READ: Operation-set bit for read operations</li>
  <li>OP_WRITE: Operation-set bit for write operations.</li>
</ul>

<p>ç¬¬äºŒä¸ªæ–¹æ³•ä¹Ÿè®©ä½ ä¼ å…¥ä¸€ä¸ªä»»æ„çš„ java.lang.Object æˆ–è€…ä¸€ä¸ªå­ç±»å®ä¾‹ï¼ˆæˆ–è€…nullï¼‰åˆ°attã€‚ non-null object è¢«ç§°ä½œ<em>attachment</em> ï¼Œæ˜¯ä¸€ä¸ªæ„è¯†åˆ°given channel æˆ–é™„åŠ additional information åˆ°channelçš„æ–¹ä¾¿æ–¹å¼ã€‚å®ƒä¿å­˜åœ¨è¿™ä¸ªæ–¹æ³•è¿”å›çš„SelectionKeyå®ä¾‹ã€‚</p>

<p>ä¸€æ—¦æˆåŠŸï¼Œæ¯ä¸ªæ–¹æ³•è¿”å›SelectionKey å®ä¾‹ï¼ŒæŠŠselectable channel å’Œselectorè”ç³»èµ·æ¥ã€‚ä¸€æ—¦å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œ java.nio.channels.ClosedChannelException ï¼›java.nio.channels. IllegalBlockingModeException ã€‚</p>

<p>ä»¥ä¸‹ä»£ç æ‰©å……äº†ä¸Šé¢çš„ä»£ç ç‰‡æ®µï¼Œé€šè¿‡é…ç½®å…ˆå‰åˆ›å»ºçš„channelä¸ºéé˜»å¡æ¨¡å¼ï¼Œç”¨selectoræ³¨å†Œchannelã€‚selection methods  test the channel for accept, read, and write readiness ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">channel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span> <span class="o">|</span>
 <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span> <span class="o">|</span>
 <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">);</span>
</code></pre></div></div>

<p>æ­¤æ—¶ï¼Œåº”ç”¨å…¸å‹åœ°è¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œåœ¨è¿™é‡Œå®Œæˆä¸‹é¢å·¥ä½œï¼š</p>

<ol>
  <li>æ‰§è¡Œselection operation</li>
  <li>è·å¾—é€‰å®šçš„keysï¼Œç„¶ååœ¨é€‰å®šçš„keysä¸Šæ‰§è¡Œè¿­ä»£å™¨ã€‚</li>
  <li>éå†è¿™äº›é”®å¹¶æ‰§è¡Œchannel æ“ä½œ</li>
</ol>

<p>ä¸€ä¸ª selection operation æ˜¯è°ƒç”¨Selectorâ€™s selectionçš„ methods ä¹‹ä¸€å®Œæˆçš„ã€‚ä¾‹å¦‚ï¼Œ int select() æ‰§è¡Œä¸€ä¸ªé˜»å¡ selection operation ã€‚åœ¨ä¸€ä¸ªchannelè¢«é€‰æ‹©ä¹‹å‰ï¼Œæˆ–è€…è¿™ä¸ªchannelçš„wakeup() è¢«è°ƒç”¨å‰ï¼Œæˆ–è€…åœ¨å½“å‰çº¿ç¨‹è¢«æ‰“æ–­å‰ï¼ˆæ— è®ºå“ªä¸ªåœ¨å‰ï¼‰éƒ½ä¸ä¼šè¿”å›ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šSelector ä¹Ÿå£°æ˜äº†int select(long timeout) æ–¹æ³•ï¼Œåœ¨ä¸€ä¸ªchannelè¢«é€‰æ‹©ä¹‹å‰ï¼Œæˆ–è€…è¿™ä¸ªchannelçš„wakeup() è¢«è°ƒç”¨å‰ï¼Œæˆ–è€…åœ¨å½“å‰çº¿ç¨‹è¢«æ‰“æ–­å‰ï¼Œæˆ–è€…è¶…å‡ºtimeoutä¹‹å‰ï¼ˆæ— è®ºå“ªä¸ªåœ¨å‰ï¼‰éƒ½ä¸ä¼šè¿”å›ã€‚å¦å¤–ï¼ŒSelectorå£°æ˜äº†int selectNow() ï¼Œæ˜¯select()çš„éé˜»å¡æ¨¡å¼ã€‚</p>

<p>select() æ–¹æ³•è¿”å›è‡ªä»ä¸Šæ¬¡è°ƒç”¨å˜ä¸ºå°±ç»ªçš„channels ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ è°ƒç”¨ select() ï¼Œä»–è¿”å›1å› ä¸º1ä¸ªchannelå˜å¾—å°±ç»ªï¼Œå¦‚æœå†æ¬¡è°ƒç”¨select() å¹¶ä¸”ç¬¬äºŒä¸ªchannelä¹Ÿå˜å¾—å°±ç»ªäº†ï¼Œselect() ä¼šå†æ¬¡è¿”å›1ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰ä¸ºç¬¬ä¸€ä¸ªç°æˆçš„channelæä¾›æœåŠ¡ï¼Œ ä½ ç°åœ¨æœ‰2ä¸ªchannelè¦æœåŠ¡ã€‚ç„¶è€Œï¼Œåœ¨ä¸¤æ¬¡ select() è°ƒç”¨ä¹‹é—´ï¼Œåªæœ‰ä¸€ä¸ªchannel å˜å¾—å°±ç»ªã€‚</p>

<p>selected keys çš„set (the ready set)è°ƒç”¨Selectorâ€™s Set selectedKeys() æ–¹æ³•è·å–ã€‚è°ƒç”¨setçš„iterator() è·å–è¿­ä»£å™¨ã€‚</p>

<p>æœ€åï¼Œåº”ç”¨è¿­ä»£keysã€‚æ¯æ¬¡éå†è¿”å›ä¸€ä¸ªSelectionKey å®ä¾‹ã€‚ä¸€äº›SelectionKeyâ€™s boolean isAcceptable(), boolean isConnectable(), boolean isReadable(), and boolean isWritable() çš„ç»„åˆè¢«è°ƒç”¨æ¥å†³å®škey æ˜¯å¦è¡¨æ˜channelå‡†å¤‡å¥½accept a connection, is finished connecting, is readable, or is writable ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šå‰é¢æåˆ°çš„æ–¹æ³•æä¾›äº†ä¸€ä¸ªä¾¿åˆ©æ–¹æ³•æ¥æŒ‡å®šè¡¨è¾¾å¼ï¼Œæ¯”å¦‚key.readyOps() &amp; OP_READ != 0 ã€‚SelectionKeyâ€™s int readyOps() æ–¹æ³•è¿”å›keyçš„ ready set ã€‚è¿”å›çš„setåªåŒ…å«å¯¹keyçš„channelçš„ æœ‰æ•ˆoperation bits ã€‚ä¾‹å¦‚ï¼Œä¸ä¼šè¿”å›ä¸€ä¸ªoperation bit è¡¨æ˜åªè¯»çš„channelå‡†å¤‡å¥½å†™äº†ã€‚æ³¨æ„æ¯ä¸ªselectable channel ä¹Ÿå£°æ˜äº†int validOps() æ–¹æ³•ï¼Œè¿”å›å¯¹channelæœ‰æ•ˆçš„operations çš„bitwise ORed set ã€‚</p>

<p>ä¸€æ—¦åº”ç”¨å†³å®šchannelå‡†å¤‡å¥½æ‰§è¡Œä¸€ä¸ªç‰¹å®šæ“ä½œï¼Œå®ƒå¯ä»¥è°ƒç”¨SelectionKeyâ€™s SelectableChannel channel() æ–¹æ³•å¾—åˆ°channelï¼Œç„¶ååœ¨channelæ‰§è¡Œå·¥ä½œã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šSelectionKey ä¹Ÿå£°æ˜äº†Selector selector() æ–¹æ³•ï¼Œè¿”å›key ä¸ºä¹‹åˆ›å»ºçš„selector ã€‚</p>

<p>å½“ä½ å®Œæˆchannelçš„å¤„ç†ï¼Œä½ å¿…é¡»ä»keys çš„setç§»é™¤keyï¼›selector ä¸åšè¿™ä¸ªå·¥ä½œã€‚ä¸‹æ¬¡channelå‡†å¤‡å¥½çš„æ—¶å€™ï¼ŒSelector ä¼šæ·»åŠ keyåˆ°selected key set ã€‚</p>

<p>ä»¥ä¸‹ä»£ç ä¸ºä»¥ä¸Šä»»åŠ¡ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SelectionKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.Selector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.ServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-10 14:45
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SelectorDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="c1">//ServerSocketChannel scChannel = ServerSocketChannel.open();</span>
        <span class="c1">//scChannel.configureBlocking(false);</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">numReadyChannels</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">numReadyChannels</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">selectedKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>
            <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">keyIterator</span> <span class="o">=</span> <span class="n">selectedKeys</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">keyIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">keyIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
                    <span class="c1">// A connection was accepted by a ServerSocketChannel</span>
                    <span class="nc">ServerSocketChannel</span> <span class="n">server</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ServerSocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
                    <span class="nc">SocketChannel</span> <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">client</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// in case accept() returns null</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">client</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span><span class="c1">// must be nonblocking</span>
                    <span class="c1">// Register socket channel with selector for read operations.</span>
                    <span class="n">client</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
                    <span class="c1">// A socket channel is ready for reading.</span>
                    <span class="nc">SocketChannel</span> <span class="n">client</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
                    <span class="c1">// Perform work on the socket channel.</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isWritable</span><span class="o">())</span> <span class="o">{</span>
                    <span class="c1">// A socket channel is ready for writing.</span>
                    <span class="nc">SocketChannel</span> <span class="n">client</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">keyIterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å’Œç”¨selector æ³¨å†Œserver socket channel ä¸€æ ·ï¼Œæ¯ä¸ªè¿›æ¥çš„client socket channel ä¹Ÿæ˜¯ç”¨server socket channe æ³¨å†Œçš„ã€‚å½“ client socket channel å‡†å¤‡å¥½è¯»æˆ–å†™æ“ä½œï¼Œå¯¹äºå…³è”çš„socket channel çš„ key.isReadable() or key.isWritable() éƒ½è¿”å›trueï¼Œ socket channel  å¯è¢«è¯»å†™ã€‚</p>

<p>ä¸€ä¸ªkeyä»£è¡¨selectable channel å’Œselectable channel ä¹‹é—´çš„å…³ç³»ã€‚è¿™ä¸ªå…³ç³»å¯ä»¥è°ƒç”¨ SelectionKeyâ€™s void cancel() æ–¹æ³•æ¥ç»ˆæ­¢ã€‚ä¸€æ—¦è¿”å›ï¼Œkeyä¼šå¤±æ•ˆï¼Œä¼šè¢«å·²ç»æ·»åŠ åˆ° selectorâ€™s cancelled-key set ã€‚keyä¼šåœ¨ä¸‹ä¸€æ¬¡selection operation ä»selectorâ€™s key sets ç§»é™¤ã€‚</p>

<p>å½“ä½ å®Œæˆä¸€ä¸ªselectorï¼Œè°ƒç”¨Selectorâ€™s void close() ã€‚å¦‚æœè¿™æ—¶ä¸€ä¸ªçº¿ç¨‹åœ¨ selectorâ€™s selection æ–¹æ³•ä¹‹ä¸€ä¸­é˜»å¡äº†ï¼Œçº¿ç¨‹è¢«æ‰“æ–­ï¼Œå°±å¥½åƒè°ƒç”¨äº†selectorâ€™s wakeup() æ–¹æ³•ä¸€æ ·ã€‚è¿˜å’Œselectorå…³è”çš„uncancelled keysä¼šå¤±æ•ˆï¼Œå®ƒä»¬çš„channelsè¢«æ³¨é”€ï¼Œå’Œè¿™ä¸ªselector å…³è”çš„ä»»ä½•èµ„æºè¢«é‡Šæ”¾ã€‚å¦‚æœselectorå·²ç»å…³é—­ï¼Œè°ƒç”¨close() æ— æ•ˆã€‚</p>

<h4 id="selector-demonstration">Selector Demonstration</h4>

<p>Selectors é€šå¸¸ç”¨äº server applications ã€‚Listing 8-1 è¡¨ç¤ºäº†ä¸€ä¸ªåº”ç”¨å‘é€local timeåˆ°clientsã€‚</p>

<p><strong><em>Listing 8-1. Serving Time to Clients</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SelectionKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.Selector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.ServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-10 16:52
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SelectorServer</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">DEFAULT_PORT</span> <span class="o">=</span> <span class="mi">9999</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">ByteBuffer</span> <span class="n">bb</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="no">DEFAULT_PORT</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">port</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server starting ... listening on port "</span> <span class="o">+</span> <span class="n">port</span><span class="o">);</span>
        <span class="nc">ServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="n">port</span><span class="o">));</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="nc">Selector</span> <span class="n">s</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>

        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">SocketChannel</span> <span class="n">sc</span><span class="o">;</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ServerSocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">()).</span><span class="na">accept</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">sc</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Receiving connection"</span><span class="o">);</span>
                    <span class="n">bb</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                    <span class="n">bb</span><span class="o">.</span><span class="na">putLong</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
                    <span class="n">bb</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Writing current time"</span><span class="o">);</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">bb</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">sc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">bb</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">iterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>After outputting a startup message that identifies the listening port, main() obtains a server socket channel followed by the underlying socket, which is bound to the specified port. The server socket channel is then configured for nonblocking mode in preparation for registering this channel with a selector.</p>

<p>newä¸€ä¸ªselectorï¼Œserver socket channelä½¿ç”¨selectoræ³¨å†Œè‡ªå·±ï¼Œå› æ­¤selectorå¯ä»¥çŸ¥é“channelä»€ä¹ˆæ—¶å€™å‡†å¤‡å¥½æ‰§è¡Œacceptæ“ä½œã€‚è¿”å›çš„keyæ²¡æœ‰ä¿å­˜ï¼Œå› ä¸ºä»æ¥æ²¡è¢«cancelled ï¼ˆselector ä¹Ÿä»æ²¡è¢«å…³é—­ï¼‰ã€‚</p>

<p>ç„¶åè¿›å…¥æ— é™å¾ªç¯ï¼Œå…ˆè°ƒç”¨selectorâ€™s select() æ–¹æ³•ã€‚å¦‚æœ server socket channel è¿˜æ²¡å°±ç»ªï¼ˆselect() returns 0 ï¼‰ï¼Œå¾ªç¯ä½™ä¸‹çš„è¢«è·³è¿‡ã€‚</p>

<p>selected keys å’Œè¿­ä»£å™¨è¢«è·å¾—ã€‚ç„¶åå†…å¾ªç¯éå†ã€‚æ¯ä¸ªkeyçš„ isAcceptable() è¢«è°ƒç”¨ï¼Œæ‰¾åˆ°å‡†å¤‡å¥½æ‰§è¡Œaccept operationçš„server socket channelã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œchannel è¢«è·å¾—ï¼Œè¢«è½¬æ¢ä¸ºServerSocketChannel ï¼ŒServerSocketChannelâ€™s accept() æ–¹æ³•è¢«è°ƒç”¨æ¥æ¥æ”¶è¿æ¥ã€‚</p>

<p>ä¸ºäº†é˜²æ­¢è¿”å›çš„SocketChannelå®ä¾‹ä¸ºnullçš„å¯èƒ½æ€§ï¼ˆå½“server socket channel ä¸ºéé˜»å¡æ¨¡å¼å¹¶ä¸”æ²¡æœ‰è¿æ¥å¯ç”¨äºæ¥æ”¶ï¼‰ï¼Œæ£€æµ‹è¿™ç§æƒ…å†µå½“nullè¢«æ£€æµ‹continueå¾ªç¯ã€‚</p>

<p>A message about receiving a connection is output and the byte buffer is cleared in preparation for storing the local time. After this long integer has been stored in the buffer, the buffer is flipped in preparation for draining. A message about writing the current time is output and the buffer is drained. The socket channel is then closed and the key is removed from the set of keys.</p>

<p>clientæµ‹è¯•serverã€‚</p>

<p><strong><em>Listing 8-2. Receiving Time from the Server</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-10 17:34
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SelectorClient</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">DEFAULT_PORT</span> <span class="o">=</span> <span class="mi">9999</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">ByteBuffer</span> <span class="n">bb</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="no">DEFAULT_PORT</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">port</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="nc">InetSocketAddress</span> <span class="n">addr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="n">sc</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">addr</span><span class="o">);</span>
            <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">sc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bb</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">bb</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">bb</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">time</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="o">;</span>
                    <span class="n">time</span> <span class="o">|=</span> <span class="n">bb</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">bb</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="n">time</span><span class="o">));</span>
            <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ¯”serverä»£ç æ›´ç®€å•ï¼Œå› ä¸ºæ²¡æœ‰ç”¨selectors ã€‚åœ¨è¿™ä¸ªç®€å•çš„åº”ç”¨ä¸éœ€è¦selector ã€‚å½“ä½ çš„å®¢æˆ·ç«¯å’Œå¤šä¸ªæœåŠ¡å™¨åœ¨ client contextäº¤äº’çš„æ—¶å€™ï¼Œä¼šå…¸å‹åœ°ä½¿ç”¨selectorã€‚</p>

<p>ä»£ç é‡Œæœ‰è¶£çš„ä¸œè¥¿ï¼š</p>

<ul>
  <li>bb.get() è¿”å›32-bit integer ä»£è¡¨ä¸€ä¸ª8-bit byte ã€‚ç”¨äºbyte valuesçš„Sign extension å¤§äº127 ï¼Œè¢«è®¤ä¸ºæ˜¯è´Ÿå€¼ã€‚å› ä¸º leading one bits åœ¨ bitwise ORing them with time åå½±å“ç»“æœï¼Œå®ƒä»¬é€šè¿‡ bitwise ANDing the integer with 255 è¢«ç§»é™¤ã€‚</li>
  <li>timeä¼ å…¥Dateï¼Œç„¶åprintln() è°ƒç”¨toStringã€‚</li>
</ul>

<p>è¾“å‡ºï¼š</p>

<p>server</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Receiving connection
Writing current time
</code></pre></div></div>

<p>client</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Tue Jul 28 13:38:20 CDT 2015
</code></pre></div></div>

<h4 id="exercises-1">EXERCISES</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">The</span> <span class="n">following</span> <span class="n">exercises</span> <span class="n">are</span> <span class="n">designed</span> <span class="n">to</span> <span class="n">test</span> <span class="n">your</span> <span class="n">understanding</span> <span class="n">of</span> <span class="nc">Chapter</span> <span class="mi">8</span><span class="err">â€™</span><span class="n">s</span> <span class="nl">content:</span>
<span class="mi">1</span><span class="o">.</span> <span class="nc">Define</span> <span class="n">selector</span><span class="o">.</span>
<span class="mi">2</span><span class="o">.</span> <span class="nc">Identify</span> <span class="n">the</span> <span class="n">three</span> <span class="n">main</span> <span class="n">types</span> <span class="n">that</span> <span class="n">support</span> <span class="n">selectors</span><span class="o">.</span>
<span class="mi">3</span><span class="o">.</span> <span class="nc">True</span> <span class="n">or</span> <span class="kc">false</span><span class="o">:</span> <span class="nc">File</span> <span class="n">channels</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">with</span> <span class="n">selectors</span><span class="o">.</span>
<span class="mi">4</span><span class="o">.</span> <span class="nc">What</span> <span class="n">does</span> <span class="nc">SelectionKey</span> <span class="n">provide</span> <span class="n">as</span> <span class="n">a</span> <span class="n">convenient</span> <span class="n">alternative</span> <span class="n">to</span> <span class="n">the</span>
<span class="n">expression</span> <span class="n">key</span><span class="o">.</span><span class="na">readyOps</span><span class="o">()</span> <span class="o">&amp;</span> <span class="no">OP_READ</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">?</span>
</code></pre></div></div>

<h4 id="summary-7">Summary</h4>

<p>A selector is an object created from a subclass of the abstract Selector class. The selector maintains a set of channels that it examines to determine which channels are ready for reading, writing, completing a connection sequence, accepting another connection, or some combination of these tasks.</p>

<p>Selectors are used with selectable channels, which are objects whose classes ultimately inherit from the abstract SelectableChannel class, which describes a channel that can be multiplexed by a selector.</p>

<p>One or more previously created selectable channels are registered with a selector. Each registration returns an instance of a subclass of the abstract SelectionKey class, which is a token signifying the relationship between one channel and the selector. When a selection method is invoked, the selectorâ€™s associated keys are updated by checking all channels registered with that selector. The application can then obtain a set of keys whose channels were found ready and iterate over these keys to service each channel that has become ready since the previous select method call.</p>

<h3 id="chapter-9-regular-expressions">Chapter 9 Regular Expressions</h3>

<h4 id="pattern-patternsyntaxexception-and-matcher">Pattern, PatternSyntaxException, and Matcher</h4>

<p>java.util.regex.Pattern ã€‚Regexesé¢„ç¼–è¯‘æé«˜æ€§èƒ½ã€‚</p>

<p><strong><em>Table 9-1. Pattern Methods</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>static Pattern compile(String regex)</td>
      <td>ç¼–è¯‘ regex ã€‚can   throw java.util. regex.PatternSyntaxException</td>
    </tr>
    <tr>
      <td>static Pattern compile(String regex,int flags)</td>
      <td>æ ¹æ® given flags ç¼–è¯‘ï¼ˆä¸€ä¸ª bitset ï¼Œ Patternâ€™s CANON_EQ, CASE_INSENSITIVE, COMMENTS, DOTALL, LITERAL, MULTILINE, UNICODE_CASE, and UNIX_LINES çš„ç»„æˆï¼‰ã€‚</td>
    </tr>
    <tr>
      <td>int flags()</td>
      <td>Return this Pattern objectâ€™s match flags ã€‚  compile(String) è¿”å›0ï¼Œ compile(String, int)  è¿”å›int</td>
    </tr>
    <tr>
      <td>Matcher matcher(CharSequence input)</td>
      <td>è¿”å› java.util.regex.Matcher ã€‚ Matcherå°†ä¸è¿™ä¸ªæ¨¡å¼çš„ç¼–è¯‘åçš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… ã€‚</td>
    </tr>
    <tr>
      <td>static boolean matches(String regex, CharSequence input)</td>
      <td>Compile regex and attempt to match input against the compiled regexã€‚å½“æœ‰matchè¿”å›trueï¼›å¦åˆ™falseã€‚æ˜¯ Pattern.compile(regex). matcher(input).matches() çš„æ–¹ä¾¿æ–¹æ³•ã€‚</td>
    </tr>
    <tr>
      <td>String pattern()</td>
      <td>è¿”å›Patternæœªç¼–è¯‘çš„ regex</td>
    </tr>
    <tr>
      <td>static String quote(String s)</td>
      <td>Quote s using â€œ\Qâ€ and â€œ\Eâ€ so that all other metacharacters lose their special meaning.   When the returned java.lang.String object is later compiled into a Pattern instance, it only can be matched literally ã€‚</td>
    </tr>
    <tr>
      <td>String[] split(CharSequence input)</td>
      <td>Split input around matches of this Patternâ€™s compiled regex and return an array containing the matches</td>
    </tr>
    <tr>
      <td>String[] split(CharSequence input, int limit)</td>
      <td>Split input around matches of this Patternâ€™s compiled regex; limit controls the number of times the compiled regex is applied and thus affects the length of the resulting array.</td>
    </tr>
    <tr>
      <td>String toString()</td>
      <td>Return this Patternâ€™s uncompiled regex</td>
    </tr>
  </tbody>
</table>

<p>ä¸Šé¢å±•ç¤ºäº†java.lang.CharSequenceæ¥å£ï¼Œä»»ä½•å®ç°è¿™ä¸ªæ¥å£çš„ç±»ï¼ˆString, java.lang.StringBuffer, and java.lang. StringBuilder ï¼‰å¯ä»¥è¢«ä¼ å…¥åˆ°å¸¦æœ‰CharSequence å‚æ•°çš„Pattern æ–¹æ³•ï¼ˆsuch as split(CharSequence) ï¼‰ã€‚</p>

<p><strong><em>Table 9-2. PatternSyntaxException Methods</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>String getDescription()</td>
      <td>Return a description of the syntax error</td>
    </tr>
    <tr>
      <td>int getIndex()</td>
      <td>Return the approximate index of where the syntax error occurred in the pattern or -1 when the index isnâ€™t known.</td>
    </tr>
    <tr>
      <td>String getMessage()</td>
      <td>Return a multiline string containing the description of the syntax error and its index, the erroneous pattern, and a visual indication of the error index within the pattern</td>
    </tr>
    <tr>
      <td>String getPattern()</td>
      <td>Return the erroneous pattern.</td>
    </tr>
  </tbody>
</table>

<p>Matcherç±»ï¼š</p>

<ul>
  <li>boolean matches(): Attempt to match the entire region against the pattern. When the match succeeds, more information can be obtained by calling Matcherâ€™s start(), end(), and group() methods.  For example, int start() returns the start index of the previous match, int end() returns the offset of the first character following the previous match, and String group() returns the input subsequence matched by the previous match. Each method throws java.lang. IllegalStateException when a match has not yet been attempted or the previous match attempt failed.</li>
  <li>boolean lookingAt():  Attempt to match the input sequence, starting at the beginning of the region, against the pattern.  As with matches(), this method always starts at the beginning of the region.   Unlike matches(), lookingAt() doesnâ€™t require that the entire region be matched.  When the match succeeds, more information can be obtained by calling Matcherâ€™s start(), end(), and group() methods</li>
  <li>boolean find():  Attempt to find the next instance of the input sequence that matches the pattern. n. It can start at the beginning of this matcherâ€™s region. Or, if a previous call to this method was successful and the matcher hasnâ€™t since been reset (by calling Matcherâ€™s Matcher reset() or Matcher reset(CharSequence input) method), it will start at the first character not matched by the previous match.   When the match succeeds, more information can be obtained by calling Matcherâ€™s start(), end(), and group() methods.</li>
</ul>

<p><strong>Note</strong> ï¼š A matcher finds matches in a subset of its input called the region. By default, the region contains all of the matcherâ€™s input. The region can be modified by calling Matcherâ€™s Matcher region(int start, int end) method (set the limits of this matcherâ€™s region) and queried by calling Matcherâ€™s int regionStart() and int regionEnd() methods.</p>

<p><strong><em>Listing 9-1. Playing with Regular Expressions</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.regex.Matcher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.Pattern</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.PatternSyntaxException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RegExDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"usage: java RegExDemo regex input"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"regex = "</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"input = "</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
            <span class="nc">Pattern</span> <span class="n">p</span> <span class="o">=</span> <span class="nc">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="nc">Matcher</span> <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">find</span><span class="o">())</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Located ["</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="na">group</span><span class="o">()</span> <span class="o">+</span> <span class="s">"] starting at "</span>
                        <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="na">start</span><span class="o">()</span> <span class="o">+</span> <span class="s">" and ending at "</span> <span class="o">+</span>
                        <span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">end</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">PatternSyntaxException</span> <span class="n">pse</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Bad regex: "</span> <span class="o">+</span> <span class="n">pse</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Description: "</span> <span class="o">+</span> <span class="n">pse</span><span class="o">.</span><span class="na">getDescription</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Index: "</span> <span class="o">+</span> <span class="n">pse</span><span class="o">.</span><span class="na">getIndex</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Incorrect pattern: "</span> <span class="o">+</span> <span class="n">pse</span><span class="o">.</span><span class="na">getPattern</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä½¿ç”¨<code class="language-plaintext highlighter-rouge">\\</code>è½¬ä¹‰ã€‚</p>

<h4 id="character-classes">Character Classes</h4>

<ul>
  <li>[xyz]</li>
  <li>[^xyz]  é</li>
  <li>[a-z]  åŒºé—´</li>
  <li>[abc[u-z]]  ç»„åˆ</li>
  <li>[a-c&amp;&amp;[c-f]]    å’Œ  ç»“æœæ˜¯c</li>
  <li>[a-z&amp;&amp;[ ^x-z]]</li>
</ul>

<p><strong><em>Table 9-3. Predefined Character Classes</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Predefined Character Class</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>\d</td>
      <td>Match any digit character. \d is equivalent to [0-9].</td>
    </tr>
    <tr>
      <td>\D</td>
      <td>Match any nondigit character. \D is equivalent to [ ^\d].</td>
    </tr>
    <tr>
      <td>\s</td>
      <td>Match any whitespace character. \s is equivalent to [\t\n\x0B\f\r ].</td>
    </tr>
    <tr>
      <td>\S</td>
      <td>Match any nonwhitespace character. \S is equivalent to [ ^\s].</td>
    </tr>
    <tr>
      <td>\w</td>
      <td>Match any word character. \w is equivalent to [a-zA-Z0-9].</td>
    </tr>
    <tr>
      <td>\W</td>
      <td>Match any nonword character. \W is equivalent to [ ^\w].</td>
    </tr>
  </tbody>
</table>

<h4 id="capturing-groups">Capturing Groups</h4>

<h4 id="boundary-matchers-and-zero-length-matches">Boundary Matchers and Zero-Length Matches</h4>

<p><strong><em>Table 9-4. Boundary Matchers</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Boundary Matcher</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>^</td>
      <td>Match beginning of line.</td>
    </tr>
    <tr>
      <td>$</td>
      <td>Match end of line.</td>
    </tr>
    <tr>
      <td>\b</td>
      <td>Match word boundary.</td>
    </tr>
    <tr>
      <td>\B</td>
      <td>Match nonword boundary</td>
    </tr>
    <tr>
      <td>\A</td>
      <td>Match beginning of text.</td>
    </tr>
    <tr>
      <td>\G</td>
      <td>Match end of previous match.</td>
    </tr>
    <tr>
      <td>\Z</td>
      <td>Match end of text except for line terminator (when present)</td>
    </tr>
    <tr>
      <td>\z</td>
      <td>Match end of text.</td>
    </tr>
  </tbody>
</table>

<h4 id="quantifiers">Quantifiers</h4>

<p><code class="language-plaintext highlighter-rouge"> (.*) </code> åŒ¹é…æœ€é•¿ ` (.*?) `åŒ¹é…æœ€çŸ­ã€‚</p>

<h4 id="practical-regular-expressions">Practical Regular Expressions</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java RegExDemo "(\(\d{3}\))?\s*\d{3}-\d{4}" "(800) 555-1212"
regex = (\(\d{3}\))?\s*\d{3}-\d{4}
input = (800) 555-1212
Located [(800) 555-1212] starting at 0 and ending at 13
java RegExDemo "(\(\d{3}\))?\s*\d{3}-\d{4}" 555-1212
regex = (\(\d{3}\))?\s*\d{3}-\d{4}
input = 555-1212
Located [555-1212] starting at 0 and ending at 7
</code></pre></div></div>

<p><strong>Note</strong> : To learn more about regular expressions, check out â€œLesson: Regular Expressionsâ€ at http://download.oracle.com/javase/tutorial/ essential/regex/index.html in The Java Tutorials.</p>

<h4 id="exercises-2">EXERCISES</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The following exercises are designed to test your understanding of Chapter 9â€™s content:
1. Define regular expression.
2. What does the Pattern class accomplish?
3. What do Patternâ€™s compile() methods do when they discover
illegal syntax in their regular expression arguments?
4. What does the Matcher class accomplish?
5. What is the difference between Matcherâ€™s matches() and
lookingAt() methods?
6. Define character class.
7. Identify the various kinds of character classes.
8. True or false: An intersection character class consists of multiple
&amp;&amp;-separated nested character classes, where at least one nested
character class is a negation character class, and matches all
characters except for those indicated by the negation character
class/classes.
9. Define capturing group.
10. What is a zero-length match?
11. Define quantifier.
12. What is the difference between greedy and reluctant quantifiers?
13. How do possessive and greedy quantifiers differ?
14. Create a ReplaceText application that takes input text, a pattern
that specifies text to replace, and replacement text command-line
arguments, and uses Matcherâ€™s String replaceAll(String
replacement) method to replace all matches of the pattern with
the replacement text (passed to replacement). For example,
java ReplaceText "too many embedded spaces"
"\s+" " " should output too many embedded spaces with
only a single space character between successive words.
</code></pre></div></div>

<h4 id="summary-8">Summary</h4>

<p>Text-processing applications often need to match text against patterns. NIO includes regular expressions to help these applications perform pattern matching with high performance. Java supports regular expressions by providing the Pattern, PatternSyntaxException, and Matcher classes.</p>

<p>In this chapter, you explored Pattern, PatternSyntaxException, and Matcher. You then learned about character classes, capturing groups, boundary matchers and zero-length matches, and quantifiers. Finally, you observed a practical use case for regexes: phone number matching.</p>

<h3 id="chapter-10-charsets">Chapter 10 Charsets</h3>

<p>ä»‹ç»java.nio.charset åŒ…å’Œjava.lang.String ç±»æœ‰å…³çš„éƒ¨åˆ†ã€‚</p>

<h4 id="a-brief-review-of-the-fundamentals">A Brief Review of the Fundamentals</h4>

<p>Javaä½¿ç”¨Unicodeæ¥è¡¨ç¤ºå­—ç¬¦ã€‚Unicodeæ˜¯ä¸€ä¸ª16ä½å­—ç¬¦é›†æ ‡å‡† [å®é™…ä¸Šï¼Œæ›´å¤šçš„æ˜¯ç¼–ç æ ‡å‡†ï¼Œå› ä¸ºæœ‰äº›å­—ç¬¦æ˜¯ç”±å¤šä¸ªæ•°å€¼è¡¨ç¤ºçš„;æ¯ä¸ªå€¼éƒ½è¢«ç§°ä¸ºä»£ç ç‚¹ ]ï¼Œç›®æ ‡æ˜¯å°†ä¸–ç•Œä¸Šæ‰€æœ‰æœ‰æ„ä¹‰çš„å­—ç¬¦é›†åˆæ˜ å°„æˆä¸€ä¸ªå…¨éƒ¨åŒ…å«çš„mapã€‚è™½ç„¶è¿™è®©ä½¿ç”¨ä¸ç”¨è¯­è¨€çš„å­—ç¬¦å¾ˆå®¹æ˜“ï¼Œä½†ä¸èƒ½å…¨è‡ªåŠ¨ç»å¸¸éœ€è¦ä½¿ç”¨ç¼–ç ã€‚åœ¨æˆ‘æ·±å…¥æ¢è®¨è¿™ä¸ªä¸»é¢˜ä¹‹å‰ï¼Œæ‚¨åº”è¯¥ç†è§£ä»¥ä¸‹æœ¯è¯­ï¼š</p>

<ul>
  <li>Character: A meaningful symbol. For example, â€œ$â€ and â€œEâ€ are characters.  These symbols predate the computer era(æ—¶ä»£)ã€‚</li>
  <li>Character set: characters çš„setã€‚ä¾‹å¦‚ï¼Œå¤§å†™è‹±æ–‡å­—æ¯A-Zå¯ä»¥è¢«è®¤ä¸ºå½¢æˆä¸€ä¸ª character setã€‚æ²¡æœ‰åˆ†é…æ•°å­—å€¼ã€‚å’ŒUnicode, ASCII, EBCDIC æˆ–ä»»æ„å­—ç¬¦é›†æ ‡å‡†æ²¡å…³ç³»ã€‚</li>
  <li>Coded character set:  ä¸€ä¸ªcharacter set æ¯ä¸ªcharacter è¢«åˆ†é…ä¸ºç‹¬ç«‹çš„æ•°å­—å€¼ã€‚æ ‡å‡†ä½“æ¯”å¦‚US-ASCII or ISO-8859-1 å®šä¹‰ä»å­—ç¬¦åˆ°æ•°å­—å€¼çš„æ˜ å°„ã€‚</li>
  <li>Character-encoding scheme:  coded character setçš„ numeric valuesåˆ°è¿™äº›å€¼ä»£è¡¨çš„å­—èŠ‚åºåˆ—çš„encodingã€‚ä¸€äº›encodingæ˜¯ä¸€å¯¹ä¸€çš„ã€‚ä¾‹å¦‚ï¼Œ ASCII ï¼ŒAè¢«æ˜ å°„ä¸ºinteger 65 ï¼Œä½¿ç”¨integer 65 è¢«encodedã€‚ä¸€äº›å…¶ä»–çš„mappingsæ˜¯ä¸€å¯¹ä¸€æˆ–è€…ä¸€å¯¹å¤šçš„ã€‚ä¾‹å¦‚ï¼Œ UTF-8 ç¼–ç Unicode å­—ç¬¦ã€‚æ¯ä¸ªæ•°å­—å€¼å°äº128çš„å­—ç¬¦è¢«ç¼–ç ä¸ºå•å­—èŠ‚ï¼Œæ¥å’Œ ASCIIå…¼å®¹ã€‚å…¶ä»–Unicode charactersè¢«ç¼–ç ä¸ºwo-to-six-byte åºåˆ—ã€‚See www.ietf.org/rfc/rfc2279.txt for more information.</li>
  <li>Charset: ä¸€ä¸ª coded character set ç»“åˆcharacter-encoding scheme ã€‚è¢«æè¿°ä¸º java.nio.charset.Charset æŠ½è±¡ç±»ã€‚</li>
</ul>

<p>è™½ç„¶Unicodeè¢«å¤§èŒƒå›´ä½¿ç”¨ï¼Œå…¶ä»–character set standardsä¹Ÿè¢«ä½¿ç”¨ã€‚å› ä¸ºæ“ä½œç³»ç»Ÿåœ¨byteçº§åˆ«æ‰§è¡ŒI/Oï¼Œæ–‡ä»¶ç”¨å­—èŠ‚åºåˆ—å­˜å‚¨æ•°æ®ï¼Œæœ‰å¿…è¦åœ¨ byte sequences å’Œè¦è¢«ç¼–ç ä¸ºå­—èŠ‚åºåˆ—çš„characters ä¹‹é—´è½¬åŒ–ã€‚</p>

<h4 id="working-with-charsets">Working with Charsets</h4>

<p>ä»JDK 1.4ï¼ŒJVMs è¢«è¦æ±‚æ”¯æŒä¸€ä¸ªæ ‡å‡†çš„charseté›†åˆï¼Œå¯ä»¥æ”¯æŒé¢å¤–charsets ã€‚ä¹Ÿæ”¯æŒdefault charset ï¼Œä¸éœ€è¦æ˜¯æ ‡å‡†é›†çš„ä¸€ä¸ªï¼Œåœ¨JVMå¯åŠ¨æ—¶è·å¾—ã€‚Table 10-1 identifies and describes the standard charsets.</p>

<p><strong><em>Table 10-1. Standard Charsets</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Charset Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>US-ASCII</td>
      <td>Seven-bit ASCII, which forms the American-English character set. Also known as the basic Latin block in Unicode.</td>
    </tr>
    <tr>
      <td>ISO-8859-1</td>
      <td>The 8-bit character set used by most European languages. Itâ€™s a superset of ASCII and includes most non-English European characters.</td>
    </tr>
    <tr>
      <td>UTF-8</td>
      <td>An 8-bit byte-oriented character encoding for Unicode. Characters are encoded in one to six bytes.</td>
    </tr>
    <tr>
      <td>UTF-16BE</td>
      <td>A 16-bit encoding using big-endian order for Unicode. Characters are encoded in two bytes with the high-order eight bits written first.</td>
    </tr>
    <tr>
      <td>UTF-16LE</td>
      <td>A 16-bit encoding using little-endian order for Unicode. Characters are encoded in two bytes with the low-order eight bits written first.</td>
    </tr>
    <tr>
      <td>UTF-16</td>
      <td>A 16-bit encoding whose endian order is determined by an optional byte-order mark.</td>
    </tr>
  </tbody>
</table>

<p>Charset namesä¸åˆ†å¤§å°å†™ï¼Œç”± Internet Assigned Names Authority (IANA)ç»´æŠ¤ã€‚</p>

<p><strong><em>Listing 10-1. Using Charsets to Encode Characters into Byte Sequences</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-15 16:01
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CharsetDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"faÃ§ade touchÃ©"</span><span class="o">;</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">csNames</span> <span class="o">=</span>
                <span class="o">{</span>
                        <span class="s">"US-ASCII"</span><span class="o">,</span>
                        <span class="s">"ISO-8859-1"</span><span class="o">,</span>
                        <span class="s">"UTF-8"</span><span class="o">,</span>
                        <span class="s">"UTF-16BE"</span><span class="o">,</span>
                        <span class="s">"UTF-16LE"</span><span class="o">,</span>
                        <span class="s">"UTF-16"</span>
                <span class="o">};</span>
        <span class="n">encode</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="nl">csName:</span> <span class="n">csNames</span><span class="o">)</span>
            <span class="n">encode</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">csName</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">,</span> <span class="nc">Charset</span> <span class="n">cs</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Charset: "</span> <span class="o">+</span> <span class="n">cs</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Message: "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>

        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Encoded: "</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">_byte</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="o">;</span>
            <span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span> <span class="n">_byte</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Character</span><span class="o">.</span><span class="na">isWhitespace</span><span class="o">(</span><span class="n">ch</span><span class="o">)</span> <span class="o">||</span> <span class="nc">Character</span><span class="o">.</span><span class="na">isISOControl</span><span class="o">(</span><span class="n">ch</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="sc">'\u0000'</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%2d: %02x (%c)%n"</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">_byte</span><span class="o">,</span> <span class="n">ch</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>main() next iterates over the bytes in the byte buffer, converting each byte to a character. It uses java.lang.Characterâ€™s isWhitespace() and isISOControl() methods to determine if the character is whitespace or a control character (neither is regarded as printable) and converts such a character to Unicode 0 (an empty string). (A carriage return or newline would screw up the output, for example.)</p>

<p>Finally, the index of the character, its hexadecimal value, and the character itself are printed to the standard output stream. I chose to use System.out. printf() for this task. Youâ€™ll learn about this method in the next chapter.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"C:\Program Files\Java\jdk1.8.0_161\bin\java.exe" "-javaagent:C:\Program Files\JetBrains\IntelliJ IDEA 2018.1.6\lib\idea_rt.jar=57257:C:\Program Files\JetBrains\IntelliJ IDEA 2018.1.6\bin" -Dfile.encoding=UTF-8 -classpath "C:\Program Files\Java\jdk1.8.0_161\jre\lib\charsets.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\deploy.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\access-bridge-64.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\cldrdata.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\dnsns.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\jaccess.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\jfxrt.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\localedata.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\nashorn.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\sunec.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\sunjce_provider.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\sunmscapi.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\sunpkcs11.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\ext\zipfs.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\javaws.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\jce.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\jfr.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\jfxswt.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\jsse.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\management-agent.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\plugin.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\resources.jar;C:\Program Files\Java\jdk1.8.0_161\jre\lib\rt.jar;E:\SpringSourceCode\target\classes;D:\Maven\repository\junit\junit\4.11\junit-4.11.jar;D:\Maven\repository\org\hamcrest\hamcrest-core\1.3\hamcrest-core-1.3.jar;D:\Maven\repository\org\springframework\spring-core\5.0.7.RELEASE\spring-core-5.0.7.RELEASE.jar;D:\Maven\repository\org\springframework\spring-jcl\5.0.7.RELEASE\spring-jcl-5.0.7.RELEASE.jar;D:\Maven\repository\org\springframework\spring-beans\5.0.7.RELEASE\spring-beans-5.0.7.RELEASE.jar;D:\Maven\repository\org\springframework\spring-context\5.0.7.RELEASE\spring-context-5.0.7.RELEASE.jar;D:\Maven\repository\org\springframework\spring-expression\5.0.7.RELEASE\spring-expression-5.0.7.RELEASE.jar;D:\Maven\repository\org\springframework\spring-aop\5.0.7.RELEASE\spring-aop-5.0.7.RELEASE.jar;D:\Maven\repository\org\springframework\spring-tx\5.0.7.RELEASE\spring-tx-5.0.7.RELEASE.jar;D:\Maven\repository\org\springframework\spring-aspects\5.0.7.RELEASE\spring-aspects-5.0.7.RELEASE.jar;D:\Maven\repository\org\aspectj\aspectjweaver\1.8.13\aspectjweaver-1.8.13.jar;D:\Maven\repository\org\springframework\spring-webmvc\5.0.7.RELEASE\spring-webmvc-5.0.7.RELEASE.jar;D:\Maven\repository\org\springframework\spring-web\5.0.7.RELEASE\spring-web-5.0.7.RELEASE.jar;D:\Maven\repository\org\springframework\spring-test\5.0.7.RELEASE\spring-test-5.0.7.RELEASE.jar;D:\Maven\repository\com\google\guava\guava\25.1-jre\guava-25.1-jre.jar;D:\Maven\repository\com\google\code\findbugs\jsr305\3.0.2\jsr305-3.0.2.jar;D:\Maven\repository\org\checkerframework\checker-qual\2.0.0\checker-qual-2.0.0.jar;D:\Maven\repository\com\google\errorprone\error_prone_annotations\2.1.3\error_prone_annotations-2.1.3.jar;D:\Maven\repository\com\google\j2objc\j2objc-annotations\1.1\j2objc-annotations-1.1.jar;D:\Maven\repository\org\codehaus\mojo\animal-sniffer-annotations\1.14\animal-sniffer-annotations-1.14.jar;D:\Maven\repository\javax\servlet\servlet-api\2.5\servlet-api-2.5.jar" com.jasu.nio._10_Charsets.CharsetDemo
Charset: UTF-8
Message: faÃ§ade touchÃ©
Encoded: 
 0: 66 (f)
 1: 61 (a)
 2: c3 (Ãƒ)
 3: a7 (Â§)
 4: 61 (a)
 5: 64 (d)
 6: 65 (e)
 7: 20 ( )
 8: 74 (t)
 9: 6f (o)
10: 75 (u)
11: 63 (c)
12: 68 (h)
13: c3 (Ãƒ)
14: a9 (Â©)

Charset: US-ASCII
Message: faÃ§ade touchÃ©
Encoded: 
 0: 66 (f)
 1: 61 (a)
 2: 3f (?)
 3: 61 (a)
 4: 64 (d)
 5: 65 (e)
 6: 20 ( )
 7: 74 (t)
 8: 6f (o)
 9: 75 (u)
10: 63 (c)
11: 68 (h)
12: 3f (?)

Charset: ISO-8859-1
Message: faÃ§ade touchÃ©
Encoded: 
 0: 66 (f)
 1: 61 (a)
 2: e7 (Ã§)
 3: 61 (a)
 4: 64 (d)
 5: 65 (e)
 6: 20 ( )
 7: 74 (t)
 8: 6f (o)
 9: 75 (u)
10: 63 (c)
11: 68 (h)
12: e9 (Ã©)

Charset: UTF-8
Message: faÃ§ade touchÃ©
Encoded: 
 0: 66 (f)
 1: 61 (a)
 2: c3 (Ãƒ)
 3: a7 (Â§)
 4: 61 (a)
 5: 64 (d)
 6: 65 (e)
 7: 20 ( )
 8: 74 (t)
 9: 6f (o)
10: 75 (u)
11: 63 (c)
12: 68 (h)
13: c3 (Ãƒ)
14: a9 (Â©)

Charset: UTF-16BE
Message: faÃ§ade touchÃ©
Encoded: 
 0: 00 ( )
 1: 66 (f)
 2: 00 ( )
 3: 61 (a)
 4: 00 ( )
 5: e7 (Ã§)
 6: 00 ( )
 7: 61 (a)
 8: 00 ( )
 9: 64 (d)
10: 00 ( )
11: 65 (e)
12: 00 ( )
13: 20 ( )
14: 00 ( )
15: 74 (t)
16: 00 ( )
17: 6f (o)
18: 00 ( )
19: 75 (u)
20: 00 ( )
21: 63 (c)
22: 00 ( )
23: 68 (h)
24: 00 ( )
25: e9 (Ã©)

Charset: UTF-16LE
Message: faÃ§ade touchÃ©
Encoded: 
 0: 66 (f)
 1: 00 ( )
 2: 61 (a)
 3: 00 ( )
 4: e7 (Ã§)
 5: 00 ( )
 6: 61 (a)
 7: 00 ( )
 8: 64 (d)
 9: 00 ( )
10: 65 (e)
11: 00 ( )
12: 20 ( )
13: 00 ( )
14: 74 (t)
15: 00 ( )
16: 6f (o)
17: 00 ( )
18: 75 (u)
19: 00 ( )
20: 63 (c)
21: 00 ( )
22: 68 (h)
23: 00 ( )
24: e9 (Ã©)
25: 00 ( )

Charset: UTF-16
Message: faÃ§ade touchÃ©
Encoded: 
 0: fe (Ã¾)
 1: ff (Ã¿)
 2: 00 ( )
 3: 66 (f)
 4: 00 ( )
 5: 61 (a)
 6: 00 ( )
 7: e7 (Ã§)
 8: 00 ( )
 9: 61 (a)
10: 00 ( )
11: 64 (d)
12: 00 ( )
13: 65 (e)
14: 00 ( )
15: 20 ( )
16: 00 ( )
17: 74 (t)
18: 00 ( )
19: 6f (o)
20: 00 ( )
21: 75 (u)
22: 00 ( )
23: 63 (c)
24: 00 ( )
25: 68 (h)
26: 00 ( )
27: e9 (Ã©)


Process finished with exit code 0

</code></pre></div></div>

<p>As well as providing encoding methods such as the aforementioned ByteBuffer encode(String s) method, Charset provides a complementary CharBuffer decode(ByteBuffer buffer) decoding method. The return type is java.nio.CharBuffer because byte sequences are decoded into characters.</p>

<p><strong>Note</strong> ByteBuffer encode(String s) is a convenience method for specifying CharBuffer.wrap(s) and passing the result to the ByteBuffer encode(CharBuffer buffer) method.</p>

<p>If you dig deeper into Charset, youâ€™ll encounter the following pair of methods:</p>

<ul>
  <li>CharsetEncoder newEncoder()</li>
  <li>CharsetDecoder newDecoder()</li>
</ul>

<p>These methods perform the actual work of encoding and decoding. Charsetâ€™s encode() and decode() methods delegate to the java.nio. charset.CharsetEncoder and java.nio.charset.CharsetDecoder objects returned from newEncoder() and newDecoder(), and invoke their encode() and decode() (along with additional) methods. (For brevity, I donâ€™t discuss CharsetEncoder and CharsetDecoder.)</p>

<h4 id="charsets-and-the-string-class">Charsets and the String Class</h4>

<p>The String class describes a string as a sequence of characters. It declares constructors that can be passed byte arrays. Because a byte array contains an encoded character sequence, a charset is required to decode them.  Here is a partial list of String constructors that work with charsets:</p>

<ul>
  <li>String(byte[] data): Constructs a new String instance by decoding the specified array of bytes using the platformâ€™s default charset.</li>
  <li>String(byte[] data, int offset, int byteCount): Constructs a new String instance by decoding the specified subsequence of the byte array using the platformâ€™s default charset.</li>
  <li>String(byte[] data, String charsetName): Constructs a new String instance by decoding the specified array of bytes using the named charset.</li>
</ul>

<p>Furthermore, String declares methods that encode its sequence of characters into a byte array with help from the default charset or a named charset. Two of these methods are described here:</p>

<ul>
  <li>byte[] getBytes(): Returns a new byte array containing the characters of this string encoded using the platformâ€™s default charset.</li>
  <li>byte[] getBytes(String charsetName): Returns a new byte array containing the characters of this string encoded using the named charset.</li>
</ul>

<p>Note that String(byte[] data, String charsetName) and byte[] getBytes(String charsetName) throw java.io.UnsupportedEncodingException when the charset isnâ€™t supported</p>

<p>Iâ€™ve created a small application that demonstrates String and charsets. Listing 10-2 presents the source code .</p>

<p><strong><em>Listing 10-2. Using Charsets with String</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.UnsupportedEncodingException</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CharsetDemo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="kd">throws</span> <span class="nc">UnsupportedEncodingException</span>
 <span class="o">{</span>
 <span class="kt">byte</span><span class="o">[]</span> <span class="n">encodedMsg</span> <span class="o">=</span>
 <span class="o">{</span>
 <span class="mh">0x66</span><span class="o">,</span> <span class="mh">0x61</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xc3</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xa7</span><span class="o">,</span> <span class="mh">0x61</span><span class="o">,</span> <span class="mh">0x64</span><span class="o">,</span> <span class="mh">0x65</span><span class="o">,</span> <span class="mh">0x20</span><span class="o">,</span> <span class="mh">0x74</span><span class="o">,</span>
 <span class="mh">0x6f</span><span class="o">,</span> <span class="mh">0x75</span><span class="o">,</span> <span class="mh">0x63</span><span class="o">,</span> <span class="mh">0x68</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xc3</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xa9</span>
 <span class="o">};</span>
 <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">encodedMsg</span><span class="o">,</span> <span class="s">"UTF-8"</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
 <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
 <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span> <span class="nl">_byte:</span> <span class="n">bytes</span><span class="o">)</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">_byte</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="o">)</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>Listing 10-2â€™s main() method first creates a byte array containing a UTF-8 encoded message. It then converts this array to a String object via the UTF-8 charset.  After outputting the resulting String object, it extracts this objectâ€™s bytes into a new byte array and proceeds to output these bytes in hexadecimal format. As demonstrated earlier in this chapter, I bitwise AND each byte value with 255 to remove the 0xFF sign extension bytes for negative integers when the 8-bit byte integer value is converted to a 32-bit integer value. These sign extension bytes would otherwise be output.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>faÃ§ade touchÃ©
66 61 e7 61 64 65 20 74 6f 75 63 68 e9
</code></pre></div></div>

<p>You might be wondering why you observe e7 instead of c3 a7 (Latin small letter c with a cedilla [a hook or tail]) and e9 instead of c3 a9 (Latin small letter e with an acute accent). The answer is that I invoked the noargument getBytes() method to encode the string. This method uses the default charset, which is windows-1252 on my platform. According to this charset, e7 is equivalent to c3 a7 and e9 is equivalent to c3 a9. The result is a shorter encoded sequence.</p>

<h4 id="exercises-3">EXERCISES</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The following exercises are designed to test your understanding of Chapter 10â€™s content:
 1. Define charset.
 2. What is the purpose of the Charset class?
 3. Identify the standard charsets supported by the JVM.
 4. What is the purpose of the byte order mark?
 5. How do you obtain the default charset?
6. What does Charsetâ€™s Charset forName(String charsetName)
factory method do when the desired charset isnâ€™t supported by the JVM?
 7. How would you typically encode a string via a Charset instance?
 8. Identify the Charset methods that perform the actual encoding and
decoding tasks.
 9. What does Stringâ€™s byte[] getBytes() method accomplish?
10. Write an AvailCharsets application that obtains and outputs a
map of all charsets that the current JVM supports. (Hint: Youâ€™ll find the
method that returns this map in the Charset class.)

</code></pre></div></div>

<h4 id="summary-9">Summary</h4>

<p>Charsets combine coded character sets with character-encoding schemes. Theyâ€™re used to translate between byte sequences and the characters that are encoded into these sequences. Java supports charsets by providing Charset and related classes. It also uses charsets with the String class. Chapter 11 presents NIOâ€™s java.util.Formatter class and related types.</p>

<h3 id="chapter-11-formatter">Chapter 11 Formatter</h3>

<p>JSR 51 (http://jcp.org/en/jsr/detail?id=51) çš„æè¿°äº†ä¸€ä¸ªç®€å•çš„printfé£æ ¼çš„æ ¼å¼åŒ–å·¥å…·è¢«æè®®çº³NIOã€‚ä½¿printfï¼ˆï¼‰å‡½æ•°æœ‰ç”¨çš„ä¸€ä¸ªç‰¹æ€§æ˜¯<em>varargs</em> ï¼Œä¼ é€’å¯å˜æ•°é‡çš„å‚æ•°ã€‚å› ä¸ºJDK 5å‰ä¸æ”¯æŒvarargs ï¼ŒJDK5æ·»åŠ äº†prinf()</p>

<h4 id="exploring-formatter">Exploring Formatter</h4>

<p>JDK5å¼•å…¥java.util.Formatter ä½œä¸ºinterpreter ç”¨äºprintf()-style format strings ã€‚è¿™ä¸ªç±»æ”¯æŒlayout justification and alignmentï¼ˆå¸ƒå±€è°ƒæ•´å’Œå¯¹é½ ï¼‰ï¼› numeric, string, and date/time data çš„é€šç”¨formatï¼›å’Œæ›´å¤šã€‚ç”¨çš„Javaç±»å‹è¢«æ”¯æŒï¼ˆsuch as byte and java.math.BigDecimal ï¼‰ã€‚</p>

<p>æ³¨æ„ï¼šjava.lang.Appendable æ¥å£æè¿°äº†char values and character sequences å¯ä»¥è¢«æ·»åŠ çš„å¯¹è±¡ã€‚formatè¾“å‡ºçš„ç±»ï¼ˆä¾‹å¦‚StringBuilder ï¼‰å®ç°Appendable ã€‚</p>

<p>Itâ€™s cumbersome to have to create and manage a Formatter object when all you want to do is achieve something equivalent to the C languageâ€™s printf() function. Java addresses this situation by adding format() and the equivalent printf() methods to the java.io.PrintStream class.</p>

<p>Of the various formatter-oriented methods added to PrintStream, youâ€™ll often invoke PrintStream printf(String format, Objectâ€¦ args). After sending its formatted content to the print stream, this method returns a reference to this stream so that you can chain method calls together.</p>

<p><strong><em>Listing 11-2. Formatting via printf()</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FormatterDemo</span>
<span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
 <span class="o">{</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%04X%n"</span><span class="o">,</span> <span class="mi">478</span><span class="o">);</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Current date: %1$tb %1$te, %1$tY%n"</span><span class="o">,</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>01DE
Current date: Jul 28, 2015
</code></pre></div></div>

<h4 id="exploring-formattable-and-formattableflags">Exploring Formattable and FormattableFlags</h4>

<h4 id="exercises-4">EXERCISES</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The following exercises are designed to test your understanding of Chapter 11â€™s content:
1. Identify the three nonexception types that contribute to NIOâ€™s
printf-style formatting facility.
2. How do you reference an argument from within a format specifier
string?
3. What does the %n format specifier accomplish?
4. Modify Listing 11-1 so that FormatterDemoâ€™s output isnâ€™t
concatenated into one long string.
</code></pre></div></div>

<h4 id="summary-10">Summary</h4>

<p>JDK 5 introduced the Formatter class as an interpreter for printf()-style format strings. This class provides support for layout justification and alignment; common formats for numeric, string, and date/time data; and more. Commonly used Java types (such as byte and BigDecimal) are supported.</p>

<p>Formatter declares several constructors for creating Formatter objects. These constructors let you specify where you want formatted output to be sent. For example, Formatter() writes formatted output to an internal StringBuilder instance. You can access the destination by calling Formatterâ€™s Appendable out() method.</p>

<p>After creating a Formatter object, call a format() method to format a varying number of values. For example, Formatter format(String format, Objectâ€¦ args) formats the args array according to the string of format specifiers passed to the format parameter, and returns a reference to the invoking Formatter so that you can chain the format() calls together.</p>

<p>Itâ€™s cumbersome to have to create and manage a Formatter object when all you want to do is achieve something equivalent to the C languageâ€™s printf() function. Java addresses this situation by adding format() and equivalent printf() methods (such as PrintStream printf(String format, Objectâ€¦ args)) to the PrintStream class.</p>

<p>Formatter is accompanied by a Formattable interface and a FormattableFlags class that collectively support limited formatting customization for arbitrary user-defined types. Formattable is implemented by any class that needs to perform custom formatting using Formatterâ€™s â€œsâ€ (format argument as string) conversion character.</p>

<h2 id="part-iv-more-new-io-apis">Part IV More New I/O APIs</h2>

<h3 id="chapter-12-improved-file-system-interface">Chapter 12 Improved File System Interface</h3>

<p>NIO.2 æ”¹è¿›äº†file system interfaceã€‚</p>

<p><strong>Note</strong> A file system manages files, which are classified as regular files, directories, symbolic links (https://en.wikipedia.org/wiki/Symbolic_ link), and hard links (https://en.wikipedia.org/wiki/Hard_link).</p>

<h4 id="architecting-a-better-file-class">Architecting a Better File Class</h4>

<p>File-based file systemæ˜¯æœ‰é—®é¢˜çš„ã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªé—®é¢˜ï¼š</p>

<ul>
  <li>å¾ˆå¤šæ–¹æ³•è¿”å›booleanè€Œä¸æŠ›å¼‚å¸¸ã€‚ç»“æœæ˜¯ä½ ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ“ä½œå¤±è´¥äº†ã€‚æ¯”å¦‚ï¼Œ delete()  è¿”å›falseï¼Œä½ ä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆ ä¸äº†</li>
  <li>File ä¸æ”¯æŒæ–‡ä»¶ç³»ç»Ÿç‰¹å®šçš„symbolic links and hard links ã€‚</li>
  <li>Fileåªæä¾›æœ‰é™file attributes setçš„è®¿é—®ã€‚ä¾‹å¦‚ï¼Œä¸æ”¯æŒè®¿é—®access control lists (ACLs) (https://en.wikipedia.org/wiki/Access_ control_list)ã€‚</li>
  <li>File ä¸æ”¯æŒé«˜æ•ˆçš„æ–‡ä»¶å±æ€§è®¿é—®ã€‚æ¯ä¸ªquery å¯¼è‡´è°ƒç”¨åº•å±‚æ“ä½œç³»ç»Ÿã€‚</li>
  <li>File ä¸èƒ½æ‰©å±•åˆ°å¤§æ–‡ä»¶å¤¹ã€‚è¯·æ±‚æ–‡ä»¶å¤§ç›®å½•å¯¼è‡´åº”ç”¨hangä½ã€‚å¤§æ–‡ä»¶å¤¹ä¹Ÿå¯¼è‡´å†…å­˜èµ„æºé—®é¢˜ï¼Œå¯¼è‡´æ‹’ç»æœåŠ¡ã€‚</li>
  <li>File è¢«é™åˆ¶åœ¨default file system ï¼ˆJVM å¯ä»¥è®¿é—®çš„file system ï¼‰ã€‚ä¸æ”¯æŒæ›¿ä»£æ–¹æ¡ˆï¼Œæ¯”å¦‚åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿã€‚</li>
  <li>Fileæ²¡æä¾›file-copy or a file-moveèƒ½åŠ›ã€‚renameTo() æ–¹æ³•ï¼Œåœ¨æ–‡ä»¶ç§»åŠ¨ä¸Šä¸‹æ–‡ç»å¸¸ä½¿ç”¨ï¼Œåœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸‹ç»“æœä¸ä¸€è‡´ã€‚</li>
</ul>

<p>NIO.2 provides an improved file system interface that offers solutions to the previous problems. Some of its features are listed here:</p>

<ul>
  <li>æ–¹æ³•æŠ›å‡ºå¼‚å¸¸</li>
  <li>æ”¯æŒsymbolic links</li>
  <li>å¯¹æ–‡ä»¶å±æ€§å¹¿æ³›å’Œæœ‰æ•ˆçš„æ”¯æŒ</li>
  <li>Directory streams</li>
  <li>custom file system providers æ”¯æŒalternative file systems</li>
  <li>æ”¯æŒ file copying and file moving</li>
  <li>æ”¯æŒwalking the file tree /visiting files  and watching directories</li>
</ul>

<p>improved file system interface ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªåŒ…å®ç°ï¼š</p>

<ul>
  <li>java.nio.file: ä¸ºè®¿é—®æ–‡ä»¶ç³»ç»Ÿå’Œæ–‡ä»¶æä¾›æ¥å£å’Œç±»ã€‚</li>
  <li>java.nio.file.attribute: ä¸ºè®¿é—®æ–‡ä»¶å±æ€§æä¾›æ¥å£å’Œç±»ã€‚</li>
  <li>java.nio.file.spi: ä¸ºåˆ›å»ºæ–‡ä»¶ç³»ç»Ÿå®ç°æä¾›ç±»</li>
</ul>

<p>These packages organize many types. FileSystem, FileSystems, and FileSystemProvider form the core of the improved file system interface.</p>

<h5 id="file-systems-and-file-system-providers">File Systems and File System Providers</h5>

<p>æ“ä½œç³»ç»Ÿå¯ä»¥æ‰¿è½½ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿ ã€‚ä¾‹å¦‚ï¼ŒUnix/ Linux ç»“åˆæ‰€æœ‰å®‰è£…çš„ç£ç›˜åˆ°ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿã€‚Windowså°†ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ç³»ç»Ÿä¸æ¯ä¸ªæ´»åŠ¨ç£ç›˜é©±åŠ¨å™¨ç›¸å…³è”;  for example, FAT16 for drive A: and NTFS for drive C: ã€‚</p>

<p>java.nio.file.FileSystem ç±»interfaces between Java code and a file system ã€‚å¦å¤–ï¼ŒFileSystemæ˜¯ä¸€ä¸ªå·¥å‚ï¼Œå¯ä»¥å¾—åˆ°å¾ˆå¤šç±»å‹çš„file system-related objects(æ¯”å¦‚file stores and paths ï¼‰å’Œservicesï¼ˆsuch as watch services ï¼‰ã€‚</p>

<p>FileSystem ä¸èƒ½å®ä¾‹åŒ–å› ä¸ºæ˜¯æŠ½è±¡çš„ã€‚ä»£æ›¿çš„æ˜¯ï¼Œjava.nio.file.FileSystems utilç±»é€šè¿‡å·¥å‚æ–¹æ³•è·å¾—FileSystemsã€‚ä¾‹å¦‚ï¼ŒFileSystem getDefault() æ–¹æ³•è¿”å›é»˜è®¤çš„ FileSystem å¯¹è±¡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileSystem</span> <span class="n">fsDefault</span> <span class="o">=</span> <span class="nc">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
</code></pre></div></div>

<p>FileSystemsä¹Ÿå£°æ˜äº†FileSystem getFileSystem(URI uri) æ–¹æ³•å¾—åˆ°è·¯å¾„å…³è”çš„FileSystem ã€‚ä¹Ÿå£°æ˜äº†3ä¸ªnewFileSystem() æ–¹æ³•åˆ›å»ºæ–°FileSystemsã€‚</p>

<p>java.nio.file.spi.FileSystemProvider ç±»è¢«FileSystemsçš„å·¥å‚æ–¹æ³•ä½¿ç”¨æ¥è·å¾—æˆ–åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿã€‚ä¸€ä¸ªå…·ä½“çš„FileSystemProviderå­ç±»å®ç°äº†å¾ˆå¤šæ–¹æ³•ç”¨äº copying, moving, and deleting filesï¼›obtaining a path ï¼›reading attributes and the targets of symbolic links ï¼›creating directories, links, and symbolic links ï¼›ç­‰ç­‰ã€‚</p>

<p>Figure 12-1 shows how FileSystem, FileSystems, and FileSystemProvider are related.</p>

<p><img src="/assets/img/1534477108216.png" alt="1534477108216" /></p>

<p>A Java implementation provides concrete FileSystemProvider subclasses that describe different kinds of file system providers. If youâ€™re curious about the file system providers supported by your Java implementation, run the application whose source code appears in Listing 12-1.</p>

<p><strong><em>Listing 12-1. Identifying Installed File System Providers</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileSystemDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">FileSystemProvider</span><span class="o">&gt;</span> <span class="n">fileSystemProviders</span> <span class="o">=</span> <span class="nc">FileSystemProvider</span><span class="o">.</span><span class="na">installedProviders</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">FileSystemProvider</span> <span class="n">provider</span> <span class="o">:</span> <span class="n">fileSystemProviders</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">provider</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Listing 12-1 invokes FileSystemProviderâ€™s List installedProviders() class method to obtain a list of the installed file system providers. It then iterates over this list, implicitly invoking each providerâ€™s toString() method and outputting the resulting string.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>un.nio.fs.WindowsFileSystem@5a07e868
sun.nio.fs.WindowsFileSystemProvider@279f2327
com.sun.nio.zipfs.ZipFileSystemProvider@2ff4acd0
</code></pre></div></div>

<p>This output tells me two things: FileSystems that interface to the file systems that are native to my Windows 7 operating system are obtained from the WindowsFileSystemProvider subclass. Also, I can obtain FileSystems that are based on ZIP files.</p>

<p>With few exceptions, NIO.2â€™s various types ultimately delegate to the foundational FileSystem, FileSystems, and FileSystemProvider types.</p>

<h4 id="locating-files-with-paths">Locating Files with Paths</h4>

<p>A file system stores files (definitely regular files and directories, and possibly symbolic links and hard links).  Files are typically stored in hierarchies and are located by specifying paths, which are compact maps that navigate these hierarchies via separated name element sequences.</p>

<p>java.nio.file.Path æ¥å£ä»£è¡¨ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ã€‚</p>

<p><strong>Note</strong> Path declares FileSystem getFileSystem() to return a reference to the FileSystem that created the file described by the Path object .</p>

<p>Path å¯ä»¥è¡¨ç¤ºrootï¼Œrootå’Œnameåºåˆ—ï¼Œæˆ–è€…ä¸€ä¸ªæˆ–å¤šä¸ªnameå…ƒç´ ã€‚ä½¿ç”¨empty path è®¿é—®æ–‡ä»¶ç­‰åŒäºè®¿é—®file systemâ€™s default directoryã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šFileå£°æ˜äº†File toFile() è¿”å›ä»£è¡¨è·¯å¾„çš„File ã€‚å½“pathå¯¹è±¡æ²¡å’Œé»˜è®¤providerå…³è”æŠ›å‡ºUnsupportedOperationException ã€‚å£°æ˜ Path toPath() è¿”å›ä»£è¡¨File objectâ€™s abstract pathçš„Pathå¯¹è±¡ã€‚è¿™äº›æ–¹æ³•è®©ä½ åœ¨æºç é‡Œæ··åˆFileå’ŒPathï¼Œæ‚¨å¯ä»¥æ…¢æ…¢åœ°å°†é—ç•™çš„åŸºäºFileçš„ä»£ç è½¬æ¢ä¸ºä½¿ç”¨æ”¹è¿›çš„æ–‡ä»¶ç³»ç»Ÿæ¥å£çš„ä»£ç ã€‚</p>

<h5 id="getting-a-path-and-accessing-its-name-elements">Getting a Path and Accessing Its Name Elements</h5>

<p>FileSystem æä¾›Path getPath(String first, Stringâ€¦ more) è¿”å›Pathå¯¹è±¡ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ path string çš„å¼€å¤´éƒ¨åˆ†ã€‚å¯å˜å‚æ•°æ˜¯åé¢è¿æ¥èµ·æ¥å½¢æˆå®Œæ•´è·¯å¾„ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šå½“æ„å»ºPathï¼Œnameå…ƒç´ é€šå¸¸æ˜¯ç”¨åˆ†éš”ç¬¦è¿æ¥çš„ï¼ˆFileSystemâ€™s String getSeparator() è¿”å›ï¼‰ã€‚The resulting path string represents a systemdependent file pathã€‚</p>

<p>Consider the following example:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">fsDefault</span><span class="o">.</span><span class="na">getPath</span><span class="o">(</span><span class="s">"x"</span><span class="o">,</span> <span class="s">"y"</span><span class="o">);</span>
</code></pre></div></div>

<p>This example constructs a Path with y subordinate to x. You could also construct this Path as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Path path = fsDefault.getPath("x\\y");
</code></pre></div></div>

<p>Unlike in the former example, Iâ€™ve included the backslash () name-separator character (escaped to satisfy the Java compiler) that Windows understands.</p>

<p>è·¯å¾„å¿…é¡»ç¬¦åˆè¯­æ³•ã€‚ä¸åˆæ³•InvalidPathException</p>

<p>NIO.2 æä¾›æ›´ä¾¿åˆ©çš„å·¥å…·ç±»java.nio.file.Paths ï¼Œè¿”å›Path objects çš„æ–¹æ³•ï¼š</p>

<ul>
  <li>Path get(String first, Stringâ€¦ more)</li>
  <li>Path get(URI uri)</li>
</ul>

<p>The first method is equivalent to calling getPath() on the default file system and returning the result:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return FileSystems.getDefault().getPath(first, more);
</code></pre></div></div>

<p>The second method is a bit more involved. It iterates over the installed file system providers to locate the provider that is identified by the given URIâ€™s scheme component. When this provider is found for the file scheme, this method executes the following code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return FileSystems.getDefault().provider().getPath(uri);
</code></pre></div></div>

<p>After obtaining the default file system, FileSystemâ€™s FileSystemProvider provider() method is called to return the file system provider that created the FileSystem object. Then, FileSystemProviderâ€™s Path getPath(URI uri) method is called to convert the URI argument to a Path object.</p>

<p>For any other scheme, the installed providers list is searched for the first provider with a matching scheme. getPath(uri) is called on the provider.</p>

<p>get(String, Stringâ€¦) throws InvalidPathException when a path cannot be constructed because of bad syntax. get(URI) throws java.nio.file. FileSystemNotFoundException when no FileSystem matches the scheme and java.lang.IllegalArgumentException for a bad URI.</p>

<p>Path declares several methods for accessing its name elements:</p>

<ul>
  <li>Path getFileName(): è¿”å›Filenameçš„Pathå¯¹è±¡ã€‚</li>
  <li>Path getName(int index): è¿”å›indexth name element The index starts at 0, which represents the element closest to the root. The element farthest from the root is identified by one less than the name count.</li>
  <li>int getNameCount(): Return the number of name elements in the path.</li>
  <li>Path getParent(): Return the parent path or null when there is no parent.</li>
  <li>Path getRoot(): Return the root name element in this path as a Path object or null when there is no root.</li>
  <li>Path subpath(int beginIndex, int endIndex): Return a relative path that is a subsequence of the name elements in this path. The first name element (closest to the root) is located at beginIndex and the last name element (farthest from the root) is located at one less than endIndex.</li>
</ul>

<h5 id="relative-and-absolute-paths">Relative and Absolute Paths</h5>

<p>å‰é¢çš„è·¯å¾„ç¤ºä¾‹æ¼”ç¤ºäº†ç›¸å¯¹è·¯å¾„ã€‚ ä½ å¯ä»¥è°ƒç”¨Pathâ€™s boolean isAbsolute() æ¥è¯å®ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›falseè¡¨ç¤ºè·¯å¾„ä¸æ˜¯ç»å¯¹çš„ã€‚ åˆ›å»ºä¸€æ¡ç»å¯¹è·¯å¾„ï¼Œæ‚¨éœ€è¦å°†æ ¹ä½œä¸ºç¬¬ä¸€ä¸ªåç§°å…ƒç´ ã€‚</p>

<p>è°ƒç”¨FileSystemâ€™s Iterable getRootDirectories() è·å¾—file systemâ€™s root(s) ï¼Œå®ƒè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè€Œä¸æ˜¯è·¯å¾„å®ä¾‹æè¿°çš„ROOTã€‚ Listing 12-3 presents the source code to an application that demonstrates this method and absolute path creation.</p>

<p><strong><em>Listing 12-3. Demonstrating Root Directory Iteration and Absolute Path Creation</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.file.FileSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.FileSystems</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-17 18:13
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RelativePath</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">FileSystem</span> <span class="n">aDefault</span> <span class="o">=</span> <span class="nc">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">aDefault</span><span class="o">.</span><span class="na">getPath</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="s">"b"</span><span class="o">,</span> <span class="s">"c"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path</span> <span class="o">+</span> <span class="s">" , "</span> <span class="o">+</span> <span class="n">path</span><span class="o">.</span><span class="na">isAbsolute</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>

        <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;</span> <span class="n">rootDirectories</span> <span class="o">=</span> <span class="n">aDefault</span><span class="o">.</span><span class="na">getRootDirectories</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">Path</span> <span class="n">root</span> <span class="o">:</span> <span class="n">rootDirectories</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">aDefault</span><span class="o">.</span><span class="na">getPath</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="s">"a"</span><span class="o">,</span> <span class="s">"b"</span><span class="o">,</span> <span class="s">"c"</span><span class="o">);</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path</span> <span class="o">+</span> <span class="s">" , "</span> <span class="o">+</span> <span class="n">path</span><span class="o">.</span><span class="na">isAbsolute</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>

        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a\b\c , false
null
C:\a\b\c , true
C:\
D:\a\b\c , true
D:\
E:\a\b\c , true
E:\
F:\a\b\c , true
F:\
</code></pre></div></div>

<p>If you have a relative path, you can convert it to an absolute path by calling Pathâ€™s Path toAbsolutePath() method, as demonstrated in Listing 12-4.</p>

<p><strong><em>Listing 12-4. Converting a Relative Path to an Absolute Path</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-17 18:19
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AbsolutePathDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="s">"b"</span><span class="o">,</span> <span class="s">"c"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Path: %s%n"</span><span class="o">,</span> <span class="n">path</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Absolute: %b%n"</span><span class="o">,</span> <span class="n">path</span><span class="o">.</span><span class="na">isAbsolute</span><span class="o">());</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">toAbsolutePath</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Path: %s%n"</span><span class="o">,</span> <span class="n">path</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Absolute: %b%n"</span><span class="o">,</span> <span class="n">path</span><span class="o">.</span><span class="na">isAbsolute</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Compile Listing 12-4 (javac PathDemo.java) and run the resulting application (java PathDemo). I observe the following output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Path: a\b\c
Absolute: false
Path: C:\prj\books\io\ch12\code\PathDemo\v3\a\b\c
Absolute: true
</code></pre></div></div>

<p>æ ¹æ®toAbsolutePath()â€™s JDK æ–‡æ¡£ï¼Œå¦‚æœpathå·²ç»æ˜¯ç»å¯¹è·¯å¾„ï¼Œè¿”å›pathã€‚å¦åˆ™ï¼Œæ–¹æ³•ç”¨å–å†³äºå®ç°çš„æ–¹å¼å¤„ç†pathï¼Œtypically by resolving the path against a file system default directory. Depending on the implementation, this method may throw an I/O error when the file system isnâ€™t accessible.</p>

<h5 id="normalization-relativization-and-resolution">Normalization, Relativization, and Resolution</h5>

<p>Pathå£°æ˜å‡ ä¸ªæ–¹æ³• æ¥ç§»é™¤pathå†—ä½™ï¼Œ to create a relative path between two paths, and to resolve (join) two paths:</p>

<ul>
  <li>Path normalize()</li>
  <li>Path relativize(Path other)</li>
  <li>Path resolve(Path other)</li>
  <li>Path resolve(String other)</li>
</ul>

<p>normalize()ç§»é™¤å†—ä½™ï¼Œæ¯”å¦‚<code class="language-plaintext highlighter-rouge">reports/./2015/jan </code>ã€‚-&gt;<code class="language-plaintext highlighter-rouge"> reports/2015/jan. </code></p>

<p>relativize() åœ¨ä¸¤ä¸ªpathä¹‹é—´åˆ›å»ºç›¸å¯¹è·¯å¾„ã€‚æ¯”å¦‚ï¼Œç»™å®š<code class="language-plaintext highlighter-rouge">reports/2015/jan </code>ï¼Œå¯¹äºreports/2016/mar çš„ç›¸å¯¹è·¯å¾„æ˜¯ ../../2016/mar ã€‚</p>

<p>resolve() å’Œrelativize()æ˜¯åè¿‡æ¥çš„ã€‚åŠ å…¥ä¸€ä¸ªå±€éƒ¨è·¯å¾„åˆ°å¦ä¸€ä¸ªpathã€‚ä¾‹å¦‚ï¼Œresolve apr å¯¹reports/2015 ç»“æœæ˜¯reports/2015/apr ã€‚</p>

<p>å¦å¤–ï¼Œå£°æ˜äº†ä¸‹é¢æ–¹æ³•å¯¹å½“å‰pathçš„çˆ¶path resolve a path string ã€‚</p>

<ul>
  <li>Path resolveSibling(Path other)</li>
  <li>Path resolveSibling(String other)</li>
</ul>

<p><strong><em>Listing 12-5. Normalizing, Relativizing, and Resolving Paths</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.file.FileSystems</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-28 14:31
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NormalizationDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path1</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"reports"</span><span class="o">,</span> <span class="s">"."</span><span class="o">,</span> <span class="s">"2015"</span><span class="o">,</span> <span class="s">"jan"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path1</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path1</span><span class="o">.</span><span class="na">normalize</span><span class="o">());</span>

        <span class="n">path1</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"reports"</span><span class="o">,</span> <span class="s">"2015"</span><span class="o">,</span> <span class="s">".."</span><span class="o">,</span> <span class="s">"jan"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path1</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path1</span><span class="o">.</span><span class="na">normalize</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>

        <span class="n">path1</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"reports"</span><span class="o">,</span> <span class="s">"2015"</span><span class="o">,</span> <span class="s">"jan"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path1</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path1</span><span class="o">.</span><span class="na">relativize</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"reports"</span><span class="o">,</span> <span class="s">"2016"</span><span class="o">,</span> <span class="s">"mar"</span><span class="o">)));</span>

        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="nc">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">getRootDirectories</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
        <span class="nc">Path</span> <span class="n">root</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">root</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Root: %s%n"</span><span class="o">,</span> <span class="n">root</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="s">"reports"</span><span class="o">,</span> <span class="s">"2016"</span><span class="o">,</span> <span class="s">"mar"</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Path: %s%n"</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path1</span><span class="o">.</span><span class="na">relativize</span><span class="o">(</span><span class="n">path</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalArgumentException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"report"</span><span class="o">,</span> <span class="s">"2015"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path1</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path1</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">"apr"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
        <span class="nc">Path</span> <span class="n">path2</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"reports"</span><span class="o">,</span> <span class="s">"2015"</span><span class="o">,</span> <span class="s">"jan"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path2</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path2</span><span class="o">.</span><span class="na">getParent</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path2</span><span class="o">.</span><span class="na">resolveSibling</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mar"</span><span class="o">)));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path2</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mar"</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reports\.\2015\jan
reports\2015\jan
reports\jan
reports\2015\jan
..\..\2016\mar
Root: C:\
Path: C:\reports\2016\mar
java.lang.IllegalArgumentException: 'other' is different type of Path
 at sun.nio.fs.WindowsPath.relativize(WindowsPath.java:388)
 at sun.nio.fs.WindowsPath.relativize(WindowsPath.java:44)
 at PathDemo.main(PathDemo.java:29)
reports\2015
reports\2015\apr
reports\2015\jan
reports\2015
reports\2015\mar
reports\2015\jan\mar
</code></pre></div></div>

<p>å…¶ä¸­ä¸€ä¸ªPathå«æœ‰rootä¸èƒ½relativize()ã€‚</p>

<h5 id="additional-capabilities">Additional Capabilities</h5>

<p>Pathæä¾›äº†æ¯”è¾ƒpathsï¼Œå†³å®šç¡®å®špathä»¥å¦ä¸€ä¸ªpathå¼€å¤´æˆ–è€…ç»“å°¾ï¼Œè½¬æ¢pathä¸ºjava.net.URI (Uniform Resource Identifier) object ã€‚ç­‰ç­‰ã€‚</p>

<p><strong><em>Listing 12-6. Demonstrating Additional Path Methods</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-28 15:29
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PathExtraDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path1</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="s">"b"</span><span class="o">,</span> <span class="s">"c"</span><span class="o">);</span>
        <span class="nc">Path</span> <span class="n">path2</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="s">"b"</span><span class="o">,</span> <span class="s">"c"</span><span class="o">,</span> <span class="s">"d"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path1: %s%n"</span><span class="o">,</span> <span class="n">path1</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path2: %s%n"</span><span class="o">,</span> <span class="n">path2</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path1.equals(path2): %b%n"</span><span class="o">,</span> <span class="n">path1</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">path2</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path1.equals(path2.subpath(0, 3)): %b%n"</span><span class="o">,</span>
                <span class="n">path1</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">path2</span><span class="o">.</span><span class="na">subpath</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">3</span><span class="o">)));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path1.compareTo(path2): %d%n"</span><span class="o">,</span>
                <span class="n">path1</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">path2</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path1.startsWith(\"x\"): %b%n"</span><span class="o">,</span>
                <span class="n">path1</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"x"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path1.startsWith(Paths.get(\"a\"): %b%n"</span><span class="o">,</span>
                <span class="n">path1</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"a"</span><span class="o">)));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path2.endsWith(\"d\"): %b%n"</span><span class="o">,</span>
                <span class="n">path2</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"d"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path2.endsWith(Paths.get(\"c\", \"d\"): "</span> <span class="o">+</span>
                        <span class="s">"%b%n"</span><span class="o">,</span>
                <span class="n">path2</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"c"</span><span class="o">,</span> <span class="s">"d"</span><span class="o">)));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path2.toUri(): %s%n"</span><span class="o">,</span> <span class="n">path2</span><span class="o">.</span><span class="na">toUri</span><span class="o">());</span>
        <span class="nc">Path</span> <span class="n">path3</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"."</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path3: %s%n"</span><span class="o">,</span> <span class="n">path3</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"path3.toRealPath(): %s%n"</span><span class="o">,</span> <span class="n">path3</span><span class="o">.</span><span class="na">toRealPath</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>path1: a\b\c
path2: a\b\c\d
path1.equals(path2): false
path1.equals(path2.subpath(0, 3)): true
path1.compareTo(path2): -2
path1.startsWith("x"): false
path1.startsWith(Paths.get("a"): true
path2.endsWith("d"): false
path2.endsWith(Paths.get("c", "d"): true
path2.toUri(): file:///C:/prj/books/io/ch12/code/PathDemo/v5/a/b/c/d
path3: .
path3.toRealPath(): C:\prj\books\io\ch12\code\PathDemo\v5
</code></pre></div></div>

<h4 id="performing-file-system-tasks-with-files">Performing File System Tasks with Files</h4>

<p>å¤§å¤šæ•°æƒ…å†µï¼Œç”¨FileSystem, FileSystems, and FileSystemProvider å°±èƒ½æ‰§è¡Œå¾ˆå¤šæ–‡ä»¶ç³»ç»Ÿä»»åŠ¡ï¼Œæ¯”å¦‚å¤åˆ¶ç§»åŠ¨æ–‡ä»¶ã€‚ç„¶è€Œï¼Œæœ‰ä¸€ä¸ªæ›´ç®€å•çš„æ–¹å¼æ‰§è¡Œè¿™äº›ä»»åŠ¡ï¼šjava.nio.file.Files ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šFilesä¸æä¾›path-matching and directory-watchingæ”¯æŒã€‚ç„¶è€Œï¼Œåªæœ‰Filesæ”¯æŒwalking the file tree and visiting its filesã€‚</p>

<h5 id="accessing-file-stores">Accessing File Stores</h5>

<p>FileSystemä¾èµ–java.nio.file.FileStore ç±»æä¾› file stores çš„ä¿¡æ¯ï¼Œå®ƒä»¬æ˜¯ storage pools, devices, partitions, volumes, concrete file systems, or other implementation-specific means of file storage ã€‚ä¸€ä¸ª file storeåŒ…å«nameï¼Œtypeï¼Œspace amounts (in bytes), and other informationã€‚</p>

<p>Files å£°æ˜FileStore getFileStore(Path path) è¿”å›FileStore ï¼Œä»£è¡¨å­˜å‚¨pathçš„file store ã€‚æ‹¿åˆ°FileStore ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>long getTotalSpace(): Return the size, in bytes, of the file store.</li>
  <li>long getUnallocatedSpace(): Return the number of unallocated bytes in the file store. è¿™æ˜¯ä¸€ä¸ªhint ï¼Œä¸æ˜¯guaranteeã€‚</li>
  <li>long getUsableSpace(): Return the number of bytes available to this JVM on the file store.  hint ã€‚</li>
  <li>boolean isReadOnly():  Return true when this file store is read-only.</li>
  <li>String name():  Return the name of this file store. The returned string may differ from the string returned by the toString() method.</li>
  <li>String type():  Return the type of this file store. The format of the returned string is highly implementationspecific. It may indicate, for example, the format used or whether the file store is local or remote.</li>
</ul>

<p><strong><em>Listing 12-7. Accessing a File Store and Outputting File Store Details</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.FileStore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-28 17:45
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileStoreDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">FileStore</span> <span class="n">fs</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">getFileStore</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"."</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Total space: %d%n"</span><span class="o">,</span> <span class="n">fs</span><span class="o">.</span><span class="na">getTotalSpace</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Unallocated space: %d%n"</span><span class="o">,</span>
                <span class="n">fs</span><span class="o">.</span><span class="na">getUnallocatedSpace</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Usable space: %d%n"</span><span class="o">,</span>
                <span class="n">fs</span><span class="o">.</span><span class="na">getUsableSpace</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Read only: %b%n"</span><span class="o">,</span> <span class="n">fs</span><span class="o">.</span><span class="na">isReadOnly</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Name: %s%n"</span><span class="o">,</span> <span class="n">fs</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Type: %s%n%n"</span><span class="o">,</span> <span class="n">fs</span><span class="o">.</span><span class="na">type</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Total space: 144970526720
Unallocated space: 137414221824
Usable space: 137414221824
Read only: false
Name: æ–‡æ¡£
Type: NTFS

</code></pre></div></div>

<p>ä½¿ç”¨ FileSystemâ€™s Iterable getFileStores() å¾—åˆ°æ‰€æœ‰file storeã€‚</p>

<p><strong><em>Listing 12-8. Iterating Over the Default File Systemâ€™s File Stores</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.file.FileStore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.FileSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.FileSystems</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-28 17:51
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileStoresDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">FileSystem</span> <span class="n">fsDefault</span> <span class="o">=</span> <span class="nc">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">FileStore</span> <span class="n">fileStore</span> <span class="o">:</span> <span class="n">fsDefault</span><span class="o">.</span><span class="na">getFileStores</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Filestore: %s%n"</span><span class="o">,</span> <span class="n">fileStore</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Filestore: (C:)
Filestore: è½¯ä»¶ (D:)
Filestore: æ–‡æ¡£ (E:)
Filestore: work (F:)
</code></pre></div></div>

<h5 id="managing-attributes">Managing Attributes</h5>

<p>Fileå…³è”å¾ˆå¤šå±æ€§ï¼Œæ¯”å¦‚size, last modification time, hidden, permissions, and owner ã€‚ NIO.2 é€šè¿‡ java.nio.file.attribute åŒ…çš„typeså’Œ Files ç±»çš„å±æ€§æ–¹æ³•æ”¯æŒå±æ€§ã€‚</p>

<p>Attributes are grouped into views,  æ¯ä¸ªviewå¯¹åº”ä¸€ä¸ªç‰¹å®šæ–‡ä»¶ç³»ç»Ÿå®ç°ã€‚ä¸€äº›viewsæä¾›readAttributes() è®©ä½ è¯»å¤§é‡å±æ€§ã€‚è°ƒç”¨Filesâ€™s getAttribute() and setAttribute() è·å–è®¾ç½®å±æ€§ã€‚</p>

<p>Views ç”±æ¥è‡ªAttributeView çš„æ¥å£æè¿°ï¼Œ name() æ–¹æ³•è¿”å›view nameã€‚è¯¥æ¥å£è¢«å­ç±»å‹FileAttributeViewç»§æ‰¿ï¼Œå®ƒæ˜¯å’Œfileså…³è”çš„å±æ€§çš„viewã€‚FileAttributeView æ²¡æœ‰æ–¹æ³•ã€‚</p>

<p>FileAttributeView è¢«ä»¥ä¸‹ç±»ç»§æ‰¿ï¼š</p>

<ul>
  <li>BasicFileAttributeView:  æä¾›å¯¹å¤§å¤šæ•°æ–‡ä»¶ç³»ç»Ÿé€šç”¨çš„æ–‡ä»¶åŸºç¡€å±æ€§é›†çš„viewã€‚</li>
  <li>FileOwnerAttributeView: æä¾›æ”¯æŒ reading or updating a file owner ã€‚</li>
  <li>UserDefinedFileAttributeView: æä¾›ç”¨æˆ·å®šä¹‰çš„å±æ€§çš„viewï¼ˆä¹Ÿå«æ‹“å±•å±æ€§ï¼‰</li>
</ul>

<p>BasicFileAttributeView è¢«ä»¥ä¸‹æ¥å£ç»§æ‰¿ï¼š</p>

<ul>
  <li>DosFileAttributeView: Provides a view of the legacy MS-DOS/PC-DOS file attributes</li>
  <li>PosixFileAttributeView:  Provides a view of the file attributes commonly associated with files on file systems used by operating systems that implement the Portable Operating System Interface (POSIX) family of standards.</li>
</ul>

<p>FileOwnerAttributeView è¢«ä»¥ä¸‹æ¥å£ç»§æ‰¿ï¼š</p>

<ul>
  <li>AclFileAttributeView: Provides support for reading or updating a fileâ€™s ACL or file owner attributes.</li>
  <li>PosixFileAttributeView</li>
</ul>

<p>PosixFileAttributeViewæœ‰2ä¸ªç›´æ¥çš„çˆ¶æ¥å£ï¼›å®ƒæ˜¯ä¸ªä¸“é—¨çš„basic file attribute view å’Œowner attribute view ã€‚Figure 12-2 clarifies this relationship along with other relationships among the view hierarchyâ€™s interfaces.</p>

<p><img src="/assets/img/1535531754507.png" alt="1535531754507" /></p>

<h6 id="determining-view-support">Determining View Support</h6>

<p>å¼€å§‹ç”¨viwå‰ï¼Œç¡®ä¿æ˜¯å¦æ”¯æŒã€‚è°ƒç”¨ FileSystemâ€™s Set supportedFileAttributeViews() æ–¹æ³•ã€‚è¿”å›FileSystem æ”¯æŒçš„view set stringsã€‚</p>

<p>Listing 12-9 presents the source code to an application that outputs the names of views supported by the default FileSystem.</p>

<p><strong><em>Listing 12-9. Outputting the Names of Default File System-Supported File Attribute Views</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.file.FileSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.FileSystems</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-29 16:47
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AttributeViewDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">FileSystem</span> <span class="n">fsDefault</span> <span class="o">=</span> <span class="nc">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="n">fsDefault</span><span class="o">.</span><span class="na">supportedFileAttributeViews</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">set</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[owner, dos, acl, basic, user]
</code></pre></div></div>

<p><strong>æ³¨æ„</strong>ï¼šæ‰€æœ‰FileSystems æ”¯æŒ basic file attribute view ã€‚</p>

<p>ä½ ä¹Ÿå¯ä»¥ç”¨Filesâ€™s  V getFileAttributeView(Path path, Class type, LinkOptionâ€¦ options) æ¥åšã€‚<strong><em>Listing 12-10 presents an application that uses this method in a utility method context to determine view support.</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.AclFileAttributeView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.BasicFileAttributeView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.FileAttributeView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.PosixFileAttributeView</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-29 16:47
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AttributeViewDemo1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Supports basic: %b%n"</span><span class="o">,</span>
                <span class="n">isSupported</span><span class="o">(</span><span class="nc">BasicFileAttributeView</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Supports posix: %b%n"</span><span class="o">,</span>
                <span class="n">isSupported</span><span class="o">(</span><span class="nc">PosixFileAttributeView</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Supports acl: %b%n"</span><span class="o">,</span>
                <span class="n">isSupported</span><span class="o">(</span><span class="nc">AclFileAttributeView</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isSupported</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">FileAttributeView</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Files</span><span class="o">.</span><span class="na">getFileAttributeView</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"."</span><span class="o">),</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Supports basic: true
Supports posix: false
Supports acl: true

</code></pre></div></div>

<p>FileStoreâ€™s supportsFileAttributeView() :</p>

<ul>
  <li>boolean supportsFileAttributeView(Class type)</li>
  <li>boolean supportsFileAttributeView(String name)</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"supports basic file attribute view: %b%n"</span><span class="o">,</span>
 <span class="n">fileStore</span><span class="o">.</span><span class="na">supportsFileAttributeView</span><span class="o">(</span><span class="nc">BasicFileAttributeView</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"supports basic file attribute view: %b%n"</span><span class="o">,</span>
 <span class="n">fileStore</span><span class="o">.</span><span class="na">supportsFileAttributeView</span><span class="o">(</span><span class="s">"basic"</span><span class="o">));</span>
</code></pre></div></div>

<h6 id="exploring-the-basic-view">Exploring the Basic View</h6>

<p>BasicFileAttributeViewæ¥å£æ”¯æŒå‡ ä¸ªåŸºæœ¬å±æ€§ã€‚ The following list identifies each attribute in terms of its string name and type:</p>

<ul>
  <li>creationTime (FileTime)</li>
  <li>fileKey (Object)</li>
  <li>isDirectory (Boolean)</li>
  <li>isOther (Boolean)</li>
  <li>isRegularFile (Boolean)</li>
  <li>isSymbolicLink (Boolean)</li>
  <li>lastAccessTime (FileTime)</li>
  <li>lastModifiedTime (FileTime)</li>
  <li>size (Long)</li>
</ul>

<p>creationTime, lastAccessTime, and lastModifiedTime ä¸ºjava.nio.file.attribute.FileTime ç±»å‹ï¼Œä¸€ä¸ªä¸å¯å˜ç±»ä»£è¡¨äº†fileâ€™s timestamp ã€‚fileKey æ˜¯Object å…¶ä½™ä¸ºBoolean Longã€‚</p>

<p>BasicFileAttributeView declares the following methods:</p>

<ul>
  <li>BasicFileAttributes readAttributes(): Read the basic file attributes as a bulk operation.</li>
  <li>void setTimes(FileTime lastModifiedTime, FileTime lastAccessTime, FileTime creationTime): Update any or all of the fileâ€™s lastModifiedTime, lastAccessTime, and creationTime attributes.</li>
</ul>

<p>These methods throw IOException when an I/O error occurs.</p>

<p>readAttributes()  è¿”å›java.nio.file.attribute.BasicFileAttributeså¯¹è±¡æä¾›type-safe æ–¹æ³•è¯»å–å±æ€§å€¼ï¼š</p>

<ul>
  <li>FileTime creationTime()</li>
  <li>Object fileKey()</li>
  <li>boolean isDirectory()</li>
  <li>boolean isOther()</li>
  <li>boolean isRegularFile()</li>
  <li>boolean isSymbolicLink()</li>
  <li>FileTime lastAccessTime()</li>
  <li>FileTime lastModifiedTime()</li>
  <li>long size()</li>
</ul>

<p><strong>æ³¨æ„</strong>ï¼šåœ¨ä¸€äº›file systems ï¼Œä½¿ç”¨æ ‡è¯†ç¬¦æˆ–ç»„åˆçš„æ ‡è¯†ç¬¦æ¥å”¯ä¸€åœ°æ ‡è¯†ä¸€ä¸ªæ–‡ä»¶æ˜¯å¯èƒ½çš„ã€‚è¿™æ ·çš„æ ‡è¯†ç¬¦å« file keys ã€‚File keys å¯¹ä¸€äº›æ“ä½œå¾ˆé‡è¦ï¼Œæ¯”å¦‚åœ¨æ”¯æŒ symbolic links å’Œæ”¯æŒfileåœ¨å¤šä¸ªæ–‡ä»¶å¤¹ä½œä¸ºentryçš„ æ–‡ä»¶ç³»ç»Ÿfile tree walks ã€‚ä¾‹å¦‚ï¼Œåœ¨Unix-based file systems ï¼Œdevice ID and information node (inode) è¢«æ™®éä½¿ç”¨ã€‚</p>

<p><strong>Reading Basic File Attribute Values in Bulk</strong></p>

<p>Listing 12-11 presents the source code to an application that shows how to read a fileâ€™s basic file attributes in bulk.</p>

<p><strong><em>Listing 12-11. Reading Basic File Attributes in Bulk</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.BasicFileAttributes</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-30 10:35
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BFAVDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\BFAVDemo.java"</span><span class="o">);</span>
        <span class="nc">BasicFileAttributes</span> <span class="n">bfa</span><span class="o">;</span>
        <span class="n">bfa</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">readAttributes</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Creation time: %s%n"</span><span class="o">,</span> <span class="n">bfa</span><span class="o">.</span><span class="na">creationTime</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"File key: %s%n"</span><span class="o">,</span> <span class="n">bfa</span><span class="o">.</span><span class="na">fileKey</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is directory: %b%n"</span><span class="o">,</span> <span class="n">bfa</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is other: %b%n"</span><span class="o">,</span> <span class="n">bfa</span><span class="o">.</span><span class="na">isOther</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is regular file: %b%n"</span><span class="o">,</span> <span class="n">bfa</span><span class="o">.</span><span class="na">isRegularFile</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is symbolic link: %b%n"</span><span class="o">,</span> <span class="n">bfa</span><span class="o">.</span><span class="na">isSymbolicLink</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Last access time: %s%n"</span><span class="o">,</span> <span class="n">bfa</span><span class="o">.</span><span class="na">lastAccessTime</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Last modified time: %s%n"</span><span class="o">,</span> <span class="n">bfa</span><span class="o">.</span><span class="na">lastModifiedTime</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Size: %d%n"</span><span class="o">,</span> <span class="n">bfa</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>é€šè¿‡Filesâ€™s  A readAttributes(Path path, Class type, LinkOptionâ€¦ options) æ–¹æ³•è·å–å±æ€§ã€‚</p>

<p><strong>Getting and Setting Single Basic File Attribute Values</strong></p>

<p>Fileså£°æ˜ getAttribute() and setAttribute() æ–¹æ³•æ¥è·å–è®¾ç½®å•ä¸ªå±æ€§:</p>

<ul>
  <li>Object getAttribute(Path path, String attribute, LinkOptionâ€¦ options)</li>
  <li>Path setAttribute(Path path, String attribute, Object value, LinkOptionâ€¦ options)</li>
</ul>

<p>LinkOptionâ€¦ options å¯¹äºæŒ‡å®šsymbolic link file  LinkOption.NOFOLLOW_LINKS ã€‚å¦‚æœä½ æƒ³è¦æœ€ç»ˆç›®æ ‡çš„å±æ€§å¿½ç•¥è¿™ä¸ªå‚æ•°ã€‚</p>

<p>å±æ€§éµå¾ªä¸‹é¢è¯­æ³•ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">[view-name:]attribute-name</code></p>

<p>view-nameé»˜è®¤æ˜¯basicï¼Œattribute-name æ˜¯å±æ€§åã€‚</p>

<p>Listing 12-12 presents the source code to an application that shows how to get and set single basic file attribute values.</p>

<p><strong><em>Listing 12-12. Getting and Setting Single Basic File Attribute Values</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.FileTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.Instant</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-30 10:49
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BFAVDemo1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\BFAVDemo1.java"</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Creation time: %s%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"creationTime"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"File key: %s%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"fileKey"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is directory: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"isDirectory"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is other: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"isOther"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is regular file: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"isRegularFile"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is symbolic link: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"isSymbolicLink"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Last access time: %s%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"lastAccessTime"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Last modified time: %s%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"lastModifiedTime"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Size: %d%n"</span><span class="o">,</span> <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"size"</span><span class="o">));</span>

        <span class="nc">Files</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"lastModifiedTime"</span><span class="o">,</span>
                <span class="nc">FileTime</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">)));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Last modified time: %s%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"lastModifiedTime"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Creation time: 2018-08-30T02:49:48.108115Z
File key: null
Is directory: false
Is other: false
Is regular file: true
Is symbolic link: false
Last access time: 2018-08-30T02:52:07.971115Z
Last modified time: 2018-08-30T02:53:09.08Z
Size: 1709
Last modified time: 2018-08-30T06:54:49.655Z
</code></pre></div></div>

<p><strong>Tip</strong> Use BasicFileAttributeViewâ€™s setTimes() method to set the creation time, last access time, and last modified time in one method call.</p>

<p>Files declares several convenience methods for accessing specific basic file attributes:</p>

<ul>
  <li>FileTime getLastModifiedTime(Path path, LinkOptionâ€¦ options)</li>
  <li>boolean isRegularFile(Path path, LinkOptionâ€¦ options)</li>
  <li>boolean isSymbolicLink(Path path)</li>
  <li>Path setLastModifiedTime(Path path, FileTime time)</li>
  <li>long size(Path path)</li>
</ul>

<h6 id="exploring-the-dos-view">Exploring the DOS View</h6>

<p>DosFileAttributeView æ¥å£ç»§æ‰¿BasicFileAttributeView å’Œæ”¯æŒä»¥ä¸‹4ä¸ªMS-DOS/PC-DOS file attributes ï¼š</p>

<ul>
  <li>archive (Boolean)</li>
  <li>hidden (Boolean)</li>
  <li>readonly (Boolean)</li>
  <li>system (Boolean)</li>
</ul>

<p>DosFileAttributeView å£°æ˜ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>DosFileAttributes readAttributes():  è¯»DOS file attributes ã€‚bulk operation</li>
  <li>void setArchive(boolean value): Update the value of the archive attribute.</li>
  <li>void setHidden(boolean value): Update the value of the hidden attribute.</li>
  <li>void setReadOnly(boolean value): Update the value of the readonly attribute.</li>
  <li>void setSystem(boolean value): Update the value of the system attribute.</li>
</ul>

<p>readAttributes() è¿”å›java.nio.file.attribute.DosFileAttributes å¯¹è±¡æä¾›type-safe methods è¯»å–å±æ€§å€¼ï¼š</p>

<ul>
  <li>boolean isArchive()</li>
  <li>boolean isHidden()</li>
  <li>boolean isReadOnly()</li>
  <li>boolean isSystem()</li>
</ul>

<p><strong>Reading DOS File Attribute Values in Bulk</strong></p>

<p>Listing 12-13 presents the source code to an application that shows how to read a fileâ€™s DOS file attributes in bulk.</p>

<p><strong><em>Listing 12-13. Reading DOS File Attributes in Bulk</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.DosFileAttributes</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-30 17:19
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DFAVDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\DFAVDemo.java"</span><span class="o">);</span>
        <span class="nc">DosFileAttributes</span> <span class="n">dfa</span><span class="o">;</span>
        <span class="n">dfa</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">readAttributes</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="nc">DosFileAttributes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is archive: %b%n"</span><span class="o">,</span> <span class="n">dfa</span><span class="o">.</span><span class="na">isArchive</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is hidden: %b%n"</span><span class="o">,</span> <span class="n">dfa</span><span class="o">.</span><span class="na">isHidden</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is readonly: %b%n"</span><span class="o">,</span> <span class="n">dfa</span><span class="o">.</span><span class="na">isReadOnly</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is system: %b%n"</span><span class="o">,</span> <span class="n">dfa</span><span class="o">.</span><span class="na">isSystem</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Is archive: true
Is hidden: false
Is readonly: false
Is system: false
</code></pre></div></div>

<p><strong>Getting and Setting Single DOS File Attribute Values</strong></p>

<p>Listing 12-14 presents the source code to an application that shows how to get and set single DOS file attribute values.</p>

<p><strong><em>Listing 12-14. Getting and Setting Single DOS File Attribute Values</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-30 17:19
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DFAVDemo1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\DFAVDemo1.java"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is archive: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"dos:archive"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is hidden: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"dos:hidden"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is readonly: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"dos:readonly"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is system: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"dos:system"</span><span class="o">));</span>

        <span class="nc">Files</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"dos:system"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is system: %s%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"dos:system"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Is archive: true
Is hidden: false
Is readonly: false
Is system: false
Is system: true
</code></pre></div></div>

<h6 id="exploring-the-posix-view">Exploring the POSIX View</h6>

<p>PosixFileAttributeView æ¥å£ç»§æ‰¿BasicFileAttributeView æ”¯æŒPOSIX group owner and nine access permissions attributes:</p>

<ul>
  <li>group (GroupPrincipal)</li>
  <li>permissions (Set<code class="language-plaintext highlighter-rouge">&lt;PosixFilePermission&gt;</code>)</li>
</ul>

<p>PosixFileAttributeView å£°æ˜ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>PosixFileAttributes readAttributes(): Read the POSIX file attributes as a bulk operation.</li>
  <li>void setGroup(GroupPrincipal group): Update the file group-owner.</li>
  <li>void setPermissions(Set perms): Update the file permissions.</li>
</ul>

<p>java.nio.file.attribute.PosixFilePermission ä¸ºæšä¸¾ï¼ŒåŒ…å«GROUP_EXECUTE, GROUP_READ, GROUP_WRITE, OTHERS_EXECUTE, OTHERS_READ, OTHERS_WRITE, OWNER_EXECUTE, OWNER_READ, and OWNER_WRITE å¸¸é‡ã€‚</p>

<p>readAttributes() è¿”å›java.nio.file.attribute.PosixFileAttributes å¯¹è±¡æä¾›type-safe methods for reading attribute values:</p>

<ul>
  <li>GroupPrincipal group()</li>
  <li>UserPrincipal owner()</li>
  <li>Set permissions()</li>
</ul>

<p>ç©ºæ¥å£java.nio.file.attribute.UserPrincipal ä»£è¡¨an identity for determining access rights to objects in a file system and extends java.security.Principal. The empty java.nio.file.attribute. GroupPrincipal interface represents a group identity and extends UserPrincipal.</p>

<p><strong>Reading POSIX File Attribute Values in Bulk</strong></p>

<p>Listing 12-15 presents the source code to an application that shows how to read a fileâ€™s POSIX file attributes in bulk.</p>

<p><strong><em>Listing 12-15. Reading POSIX File Attributes in Bulk</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.PosixFileAttributes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.PosixFilePermission</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-31 14:03
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PFAVDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\PFAVDemo.java"</span><span class="o">);</span>
        <span class="nc">PosixFileAttributes</span> <span class="n">pfa</span><span class="o">;</span>
        <span class="n">pfa</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">readAttributes</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="nc">PosixFileAttributes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Group: %s%n"</span><span class="o">,</span> <span class="n">pfa</span><span class="o">.</span><span class="na">group</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">PosixFilePermission</span> <span class="n">perm</span> <span class="o">:</span> <span class="n">pfa</span><span class="o">.</span><span class="na">permissions</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Permission: %s%n"</span><span class="o">,</span> <span class="n">perm</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>Getting and Setting Single POSIX File Attribute Values</strong></p>

<p>Listing 12-16 presents the source code to an application that shows how to get and set single POSIX file attribute values.</p>

<p><em>Listing 12-16. Getting and Setting Single POSIX File Attribute Values</em></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.GroupPrincipal</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.PosixFilePermission</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-31 14:03
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PFAVDemo1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\PFAVDemo1.java"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Group: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"posix:group"</span><span class="o">));</span>
        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">PosixFilePermission</span><span class="o">&gt;</span> <span class="n">perms</span> <span class="o">=</span>
                <span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">PosixFilePermission</span><span class="o">&gt;)</span>
                        <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"posix: permissions"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">PosixFilePermission</span> <span class="nl">perm:</span> <span class="n">perms</span><span class="o">)</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Permission: %s%n"</span><span class="o">,</span> <span class="n">perm</span><span class="o">);</span>


        <span class="nc">GroupPrincipal</span> <span class="n">gp</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">getFileSystem</span><span class="o">().</span>
                <span class="n">getUserPrincipalLookupService</span><span class="o">().</span>
                <span class="n">lookupPrincipalByGroupName</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"posix:group"</span><span class="o">,</span> <span class="n">gp</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Group: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"posix:group"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>To change the group attribute, you need to obtain a new GroupPrincipal object that corresponds to the specified group name command-line argument. This task is accomplished by following these steps:</p>

<ul>
  <li>Calling Pathâ€™s FileSystem getFileSystem() method to return the FileSystem that created the Path object.</li>
  <li>Calling FileSystemâ€™s UserPrincipalLookupService getUserPrincipalLookupService() method to return the java.nio.file.attribute.UserPrincipalLookupService object for obtaining UserPrincipals and GroupPrincipals.</li>
  <li>Calling UserPrincipalLookupServiceâ€™s GroupPrincipal lookupPrincipalByGroupName(String group) method to return the desired GroupPrincipal object.</li>
</ul>

<p>Filesç±»å£°æ˜äº†ä¾¿æ·æ–¹æ³•æ¥getting and setting the POSIX permissions attribute:</p>

<ul>
  <li>Set getPosixFilePermissions (Path path, LinkOptionâ€¦ options)</li>
  <li>Path setPosixFilePermissions(Path path, Set perms)</li>
</ul>

<p>ä¾‹å¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">PosixFilePermission</span><span class="o">&gt;</span> <span class="n">perms</span> <span class="o">=</span>
 <span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">PosixFilePermission</span><span class="o">&gt;)</span>
 <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"posix: permissions"</span><span class="o">);</span>
 
 <span class="c1">//ä»£æ›¿</span>
 <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">PosixFilePermission</span><span class="o">&gt;</span> <span class="n">perms</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">getPosixFilePermissions</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</code></pre></div></div>

<h6 id="exploring-the-file-owner-view">Exploring the File Owner View</h6>

<p>å¾ˆå¤šæ–‡ä»¶ç³»ç»Ÿæ”¯æŒfile ownership çš„æ¦‚å¿µã€‚NIO.2é€šè¿‡FileOwnerAttributeView æ¥å£æ”¯æŒï¼Œæ”¯æŒä»¥ä¸‹å±æ€§ï¼š</p>

<ul>
  <li>owner (UserPrincipal)</li>
</ul>

<p>FileOwnerAttributeView å£°æ˜ä»¥ä¸‹æ–¹æ³•è®¿é—®å±æ€§ï¼š</p>

<ul>
  <li>UserPrincipal getOwner(): Read the file owner.</li>
  <li>void setOwner(UserPrincipal owner): Update the file owner</li>
</ul>

<p>Filesçš„ä¾¿æ·æ–¹æ³•ï¼š</p>

<ul>
  <li>UserPrincipal getOwner(Path path, LinkOptionâ€¦ options)</li>
  <li>Path setOwner(Path path, UserPrincipal owner)</li>
</ul>

<p><strong>Note</strong> You can also access the file owner attribute via Files.getAttribute() or Files.setAttribute(). You will need to specify owner:owner for the view prefix and attribute name</p>

<p>Listing 12-17 presents the source code to an application that demonstrates getOwner() and setOwner().</p>

<p><strong><em>Listing 12-17. Getting and Setting File Ownership</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.UserPrincipal</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-31 15:04
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FOAVDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\FOAVDemo.java"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Owner: %s%n"</span><span class="o">,</span> <span class="nc">Files</span><span class="o">.</span><span class="na">getOwner</span><span class="o">(</span><span class="n">path</span><span class="o">));</span>
        <span class="nc">UserPrincipal</span> <span class="n">up</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">getFileSystem</span><span class="o">().</span>
                <span class="n">getUserPrincipalLookupService</span><span class="o">().</span>
                <span class="n">lookupPrincipalByName</span><span class="o">(</span><span class="s">"Judy"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">up</span><span class="o">);</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">setOwner</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">up</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Owner: %s%n"</span><span class="o">,</span> <span class="nc">Files</span><span class="o">.</span><span class="na">getOwner</span><span class="o">(</span><span class="n">path</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Owner: BUILTIN\Administrators (Alias)
Judy-PC\Judy (User)
Owner: Judy-PC\Judy (User)
</code></pre></div></div>

<p><strong>Note</strong> POSIXFileAttributeView extends FileOwnerAttributeView, inheriting the owner attribute. Files on a POSIX file system have a file owner in addition to a group owner and access permissions.</p>

<h6 id="exploring-the-acl-view">Exploring the ACL View</h6>

<p>AclFileAttributeView ç»§æ‰¿FileOwnerAttributeView æ”¯æŒä»¥ä¸‹å±æ€§ï¼š</p>

<ul>
  <li>acl (List)</li>
</ul>

<p>AclFileAttributeView å£°æ˜ä»¥ä¸‹æ–¹æ³•è®¿é—®å±æ€§ï¼š</p>

<ul>
  <li>List getAcl(): Read the ACL into a java.util.List of java.nio.file.attribute.AclEntrys.</li>
  <li>void setAcl(List acl): Update (replace) the ACL.</li>
</ul>

<p>AclEntry ç±»describes an entry in an ACL. It has four components:</p>

<ul>
  <li>type ï¼Œç¡®å®šæ¡ç›®æ˜¯å¦æˆäºˆæˆ–æ‹’ç»è®¿é—® ã€‚è°ƒç”¨AclEntryType type() è·å¾—ã€‚java.nio.file.attribute.AclEntryType æšä¸¾ç±»å®šä¹‰äº†ALARM (generate an alarm, in a system-dependent way, for the access specified in the permissions component of the ACL entry), ALLOW (explicitly grant access to a regular file or directory), AUDIT (log, in a systemdependent way, the access specified in the permissions component of the ACL entry), and DENY (explicitly deny access to a regular file or directory entry)  4ä¸ªå¸¸é‡ã€‚</li>
  <li>principal, æœ‰æ—¶å« who ç»„ä»¶ï¼Œæ˜¯ä¸€ä¸ªå¯¹åº”çš„UserPrincipal  è°ƒç”¨UserPrincipal principal() æ–¹æ³•è·å¾—ã€‚</li>
  <li>permissions is a set of permissions.  è°ƒç”¨Set permissions() è·å¾—ã€‚ java.nio.file.attribute.AclEntryPermission æšä¸¾ç±»å®šä¹‰APPEND_DATA (permission to append data to a file), DELETE (permission to delete the file), DELETE_CHILD (permission to delete a file in a directory), EXECUTE (permission to execute a regular file), READ_ACL (permission to read the ACL attribute), READ_ATTRIBUTES (the ability to read nonACL file attributes), READ_DATA (permission to read the fileâ€™s data), READ_NAMED_ATTRS (permission to read the fileâ€™s named attributes), SYNCHRONIZE (permission to access the file locally at the server with synchronous reads and writes), WRITE_ ACL (permission to write the ACL attribute), WRITE_ ATTRIBUTES (the ability to write nonACL file attributes), WRITE_DATA (permission to modify the fileâ€™s data), WRITE_NAMED_ATTRS (permission to write the fileâ€™s named attributes), and WRITE_OWNER (permission to change the owner) å¸¸é‡ã€‚</li>
  <li>flags is a set of flags that indicate how entries are inherited and propagated. è°ƒç”¨Set<code class="language-plaintext highlighter-rouge">&lt;AclEntryFlag&gt;</code>flags() è·å¾—ã€‚java.nio. file.attribute.AclEntryFlag æšä¸¾ç±»å®šä¹‰ DIRECTORY_ INHERIT (can be placed on a directory and indicates that the ACL entry should be added to each new directory created), FILE_INHERIT (can be placed on a directory and indicates that the ACL entry should be added to each new nondirectory file created), INHERIT_ONLY (can be placed on a directory but does not apply to the directory, only to newly-created files/directories as specified by the FILE_INHERIT and DIRECTORY_INHERIT flags), and NO_PROPAGATE_INHERIT (can be placed on a directory to indicate that the ACL entry should not be placed on the newly-created directory, which is inheritable by subdirectories of the created directory)</li>
</ul>

<p>Listing 12-18 presents the source code to an application that demonstrates reading the acl and inherited owner attributes.</p>

<p><strong><em>Listing 12-18. Reading and Outputting a Fileâ€™s Owner and ACL Information</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.AclEntry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-31 16:46
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ACLAVDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\ManageAttribute\\ACLAVDemo.java"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Owner: %s%n%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"acl:owner"</span><span class="o">));</span>
        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AclEntry</span><span class="o">&gt;</span> <span class="n">aclentries</span> <span class="o">=</span>
                <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">AclEntry</span><span class="o">&gt;)</span> <span class="nc">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"acl:acl"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">AclEntry</span> <span class="nl">aclentry:</span> <span class="n">aclentries</span><span class="o">)</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%s%n%n"</span><span class="o">,</span> <span class="n">aclentry</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h6 id="exploring-the-user-defined-view">Exploring the User-Defined View</h6>

<p>ä½¿ç”¨UserDefinedFileAttributeView æ¥å£ï¼š</p>

<ul>
  <li>void delete(String name): Delete a user-defined attribute.</li>
  <li>List list(): Return a list of user-defined attribute names.</li>
  <li>int read(String name, ByteBuffer dst): Read the value of a user-defined attribute into a buffer.</li>
  <li>int size(String name): Return the size of the value of a user-defined attribute.</li>
  <li>int write(String name, ByteBuffer src): Write the value of a user-defined attribute from a buffer</li>
</ul>

<p>ä½¿ç”¨ FileStoreâ€™s supportsFileAttributeView() æŸ¥çœ‹æ˜¯å¦æ”¯æŒï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileStore</span> <span class="n">fs</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">getFileStore</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">fs</span><span class="o">.</span><span class="na">supportsFileAttributeView</span><span class="o">(</span><span class="nc">UserDefinedFileAttributeView</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"User-defined attributes are supported."</span><span class="o">);</span>
<span class="k">else</span>
 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"User-defined attributes are not supported."</span><span class="o">);</span>
</code></pre></div></div>

<p>Listing 12-19 presents the source code to an application that demonstrates a user-defined file.description attribute for associating a description with a file.</p>

<p><strong><em>Listing 12-19. Associating a Description with a File</em></strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">IOException</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">nio</span><span class="p">.</span><span class="nx">ByteBuffer</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">nio</span><span class="p">.</span><span class="nx">charset</span><span class="p">.</span><span class="nx">Charset</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">nio</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">Files</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">nio</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">Path</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">nio</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">Paths</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">nio</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">attribute</span><span class="p">.</span><span class="nx">UserDefinedFileAttributeView</span><span class="p">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-31 17:10
 */</span>
<span class="kr">public</span> <span class="kd">class</span> <span class="nx">UDAVDemo</span> <span class="p">{</span>
    <span class="kr">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="nx">main</span><span class="p">(</span><span class="nb">String</span><span class="p">[]</span> <span class="nx">args</span><span class="p">)</span> <span class="nx">throws</span> <span class="nx">IOException</span> <span class="p">{</span>
        <span class="nx">Path</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">Paths</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">E:</span><span class="se">\\</span><span class="s2">SpringSourceCode</span><span class="se">\\</span><span class="s2">src</span><span class="se">\\</span><span class="s2">main</span><span class="se">\\</span><span class="s2">java</span><span class="se">\\</span><span class="s2">com</span><span class="se">\\</span><span class="s2">jasu</span><span class="se">\\</span><span class="s2">nio</span><span class="se">\\</span><span class="s2">_12_NIO2</span><span class="se">\\</span><span class="s2">_02_Files</span><span class="se">\\</span><span class="s2">ManageAttribute</span><span class="se">\\</span><span class="s2">UDAVDemo.java</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">UserDefinedFileAttributeView</span> <span class="nx">udfav</span> <span class="o">=</span>
                <span class="nx">Files</span><span class="p">.</span><span class="nx">getFileAttributeView</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span>
                        <span class="nx">UserDefinedFileAttributeView</span><span class="p">.</span><span class="kd">class</span><span class="p">);</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="dl">'</span><span class="s1">W</span><span class="dl">'</span><span class="p">:</span>
            <span class="k">case</span> <span class="dl">'</span><span class="s1">w</span><span class="dl">'</span><span class="p">:</span> <span class="nx">udfav</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">"</span><span class="s2">file.description</span><span class="dl">"</span><span class="p">,</span>
                    <span class="nx">Charset</span><span class="p">.</span><span class="nx">defaultCharset</span><span class="p">().</span><span class="nx">encode</span><span class="p">(</span><span class="dl">"</span><span class="s2">sample</span><span class="dl">"</span><span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="dl">'</span><span class="s1">L</span><span class="dl">'</span><span class="p">:</span>
            <span class="k">case</span> <span class="dl">'</span><span class="s1">l</span><span class="dl">'</span><span class="p">:</span> <span class="k">for</span> <span class="p">(</span><span class="nb">String</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">udfav</span><span class="p">.</span><span class="nx">list</span><span class="p">())</span>
                <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">println</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="dl">'</span><span class="s1">R</span><span class="dl">'</span><span class="p">:</span>
            <span class="k">case</span> <span class="dl">'</span><span class="s1">r</span><span class="dl">'</span><span class="p">:</span> <span class="nx">int</span> <span class="nx">size</span> <span class="o">=</span> <span class="nx">udfav</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="dl">"</span><span class="s2">file.description</span><span class="dl">"</span><span class="p">);</span>
                <span class="nx">ByteBuffer</span> <span class="nx">buf</span> <span class="o">=</span> <span class="nx">ByteBuffer</span><span class="p">.</span><span class="nx">allocateDirect</span><span class="p">(</span><span class="nx">size</span><span class="p">);</span>
                <span class="nx">udfav</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="dl">"</span><span class="s2">file.description</span><span class="dl">"</span><span class="p">,</span> <span class="nx">buf</span><span class="p">);</span>
                <span class="nx">buf</span><span class="p">.</span><span class="nx">flip</span><span class="p">();</span>
                <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">println</span><span class="p">(</span><span class="nx">Charset</span><span class="p">.</span><span class="nx">defaultCharset</span><span class="p">().</span><span class="nx">decode</span><span class="p">(</span><span class="nx">buf</span><span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="dl">'</span><span class="s1">D</span><span class="dl">'</span><span class="p">:</span>
            <span class="k">case</span> <span class="dl">'</span><span class="s1">d</span><span class="dl">'</span><span class="p">:</span> <span class="nx">udfav</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">"</span><span class="s2">file.description</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Owner: BUILTIN\Administrators (Alias)

BUILTIN\Administrators:READ_DATA/WRITE_DATA/APPEND_DATA/READ_NAMED_ATTRS/WRITE_NAMED_ATTRS/EXECUTE/DELETE_CHILD/READ_ATTRIBUTES/WRITE_ATTRIBUTES/DELETE/READ_ACL/WRITE_ACL/WRITE_OWNER/SYNCHRONIZE:ALLOW

NT AUTHORITY\SYSTEM:READ_DATA/WRITE_DATA/APPEND_DATA/READ_NAMED_ATTRS/WRITE_NAMED_ATTRS/EXECUTE/DELETE_CHILD/READ_ATTRIBUTES/WRITE_ATTRIBUTES/DELETE/READ_ACL/WRITE_ACL/WRITE_OWNER/SYNCHRONIZE:ALLOW

NT AUTHORITY\Authenticated Users:READ_DATA/WRITE_DATA/APPEND_DATA/READ_NAMED_ATTRS/WRITE_NAMED_ATTRS/EXECUTE/READ_ATTRIBUTES/WRITE_ATTRIBUTES/DELETE/READ_ACL/SYNCHRONIZE:ALLOW

BUILTIN\Users:READ_DATA/READ_NAMED_ATTRS/EXECUTE/READ_ATTRIBUTES/READ_ACL/SYNCHRONIZE:ALLOW
</code></pre></div></div>

<h6 id="exploring-the-file-store-view">Exploring the File Store View</h6>

<p>AttributeView ä¹Ÿè¢«java.nio.file.attribute. FileStoreAttributeViewç»§æ‰¿ï¼Œæ˜¯ä¸€ä¸ªç©ºçš„æ¥å£ã€‚file store æœ‰totalSpace, unallocatedSpace, and usableSpace å±æ€§ã€‚è°ƒç”¨FileStoreâ€™s getAttribute() è·å–å±æ€§ã€‚</p>

<p>getAttribute() æ–¹æ³•ä¹Ÿå¯ä»¥å¸¦æŒ‡å®šå±æ€§çš„stringå‚æ•°view-name:attribute-name ã€‚å¯¹äºWindowsFileStore å­ç±»ï¼Œå¯¹äºtotalSpaceã€ unallocatedSpace å’ŒusableSpace ä¸éœ€è¦å¸¦view nameï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"total space: %d%n"</span><span class="o">,</span>
 <span class="n">fileStore</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"totalSpace"</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"unallocated space: %d%n"</span><span class="o">,</span>
 <span class="n">fileStore</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"unallocatedSpace"</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"usable space: %d%n"</span><span class="o">,</span>
 <span class="n">fileStore</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"usableSpace"</span><span class="o">));</span>
</code></pre></div></div>

<p><strong>Note</strong> Instead of accessing totalSpace, unallocatedSpace, and usableSpace via getAttribute(), itâ€™s better to use FileStoreâ€™s type-safe getTotalSpace(), getUnallocatedSpace(), and getUsableSpace() methods, which I demonstrated earlier in this chapter.</p>

<p>In contrast, you need to specify volume as the view-name when accessing the Windows-specific vsn, isRemovable, and isCdrom attributes:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>System.out.printf("volume serial number: %b%n",
 fileStore.getAttribute("volume:vsn"));
System.out.printf("is removable: %b%n",
 fileStore.getAttribute("volume:isRemovable"));
System.out.printf("is CD-ROM: %b%n",
 fileStore.getAttribute("volume:isCdrom"));
</code></pre></div></div>

<h5 id="managing-files-and-directories">Managing Files and Directories</h5>

<p>Paths è®©ä½ å®šä½æ–‡ä»¶ã€‚..</p>

<h6 id="checking-paths">Checking Paths</h6>

<p>Files å£°æ˜2ä¸ªæ–¹æ³•è¡¨è¾¾æ–‡ä»¶å­˜ä¸å­˜åœ¨ï¼š</p>

<ul>
  <li>boolean exists(Path path, LinkOptionâ€¦ options):  æ£€æŸ¥pathä»£è¡¨çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚ By default, symbolic links are followed, but if you pass LinkOption.NOFOLLOW_LINKS to options, symbolic links are not followed.</li>
  <li>boolean notExists(Path path, LinkOptionâ€¦ options):</li>
</ul>

<p><strong>æ³¨æ„</strong>ï¼š!exists(path) æ˜¯ä¸ç­‰äºnotExists(path)çš„ã€‚å› ä¸º !exists() ä¸æ˜¯åŸå­æ€§çš„ï¼ˆ(executed as a single operation ï¼‰ï¼ŒnotExists() æ˜¯åŸå­æ€§çš„ã€‚å½“exists() å’ŒnotExists() è¿”å›falseï¼Œæ–‡ä»¶çš„å­˜åœ¨ä¸èƒ½è¢«è¯å®ã€‚</p>

<p>Files ç±»ä¹Ÿå£°æ˜äº†å‡ ä¸ªiså¼€å¤´çš„æ–¹æ³•æ£€æŸ¥é¢å¤–æ¡ä»¶ï¼š</p>

<ul>
  <li>boolean isDirectory(Path path, LinkOptionâ€¦ options): æ£€æŸ¥path ä»£è¡¨æ–‡ä»¶å¤¹ã€‚ Specify LinkOption.NOFOLLOW_LINKS when you donâ€™t want this method to follow symbolic links</li>
  <li>boolean isExecutable(Path path):  æ£€æŸ¥æ˜¯å¦å¯æ‰§è¡Œã€‚</li>
  <li>boolean isHidden(Path path): æ£€æŸ¥æ˜¯ä¸æ˜¯éšè—æ–‡ä»¶ã€‚å‡†ç¡®çš„hiddenå®šä¹‰æ˜¯ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ã€‚Unix æ˜¯å¥å·å¼€å¤´ï¼ŒWindosæ˜¯ä¸æ˜¯æ–‡ä»¶å¤¹å’Œ DOS hidden attribute ã€‚</li>
  <li>boolean isReadable(Path path):  æ£€æŸ¥æ˜¯å¦å¯è¯»ï¼Œ</li>
  <li>boolean isRegularFile(Path path, LinkOptionâ€¦ options): æ£€æŸ¥æ˜¯å¦æ˜¯å¸¸è§„æ–‡ä»¶ã€‚</li>
  <li>boolean isSameFile(Path path1, Path path2): æ£€æŸ¥æ˜¯ä¸æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ã€‚å¦‚æœæ˜¯ä¸¤ä¸ª file system providers ï¼Œè¿”å›falseã€‚</li>
  <li>boolean isWritable(Path path): æ£€æŸ¥æ˜¯å¦å¯å†™ã€‚</li>
</ul>

<p>isExecutable(), isReadable(), and isWritable() æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ŒJVMæœ‰è¯»å†™æ‰§è¡Œæƒé™ã€‚æ ¹æ®å®ç°ï¼Œæ–¹æ³•å¯èƒ½éœ€è¦è¯»å– file permissions, ACLs, or other file attributes to check the effective access to the fileã€‚å› æ­¤ï¼Œå¯¹äºå…¶ä»–æ“ä½œç³»ç»Ÿæ–¹æ³•å¯èƒ½ä¸æ˜¯åŸå­æ€§çš„ã€‚</p>

<p>exists(), notExists(), isExecutable(), isReadable(), and isWritable() çš„è¿”å›å€¼æ˜¯ç«‹å³è¿‡æ—¶çš„ã€‚è¿™ä¸ªrace condition è¢«å«åštime-of-check-to-time-of-use (TOCTTOU) ã€‚Check out https:// en.wikipedia.org/wiki/Time_of_check_to_time_of_use for more information.</p>

<p>Listing 12-20 presents the source code to an application that demonstrates these path-checking methods.</p>

<p><strong><em>Listing 12-20. Checking Paths for Various Conditions</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-31 17:52
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FilesAndDirectoriesDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">Path</span> <span class="n">path1</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\FilesAndDirectoriesDemo.java"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Path1: %s%n"</span><span class="o">,</span> <span class="n">path1</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Exists: %b%n"</span><span class="o">,</span> <span class="nc">Files</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">path1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Not exists: %b%n"</span><span class="o">,</span> <span class="nc">Files</span><span class="o">.</span><span class="na">notExists</span><span class="o">(</span><span class="n">path1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is directory: %b%n"</span><span class="o">,</span> <span class="nc">Files</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">(</span><span class="n">path1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is executable: %b%n"</span><span class="o">,</span> <span class="nc">Files</span><span class="o">.</span><span class="na">isExecutable</span><span class="o">(</span><span class="n">path1</span><span class="o">));</span>

        <span class="k">try</span>
        <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Hidden: %b%n"</span><span class="o">,</span> <span class="nc">Files</span><span class="o">.</span><span class="na">isHidden</span><span class="o">(</span><span class="n">path1</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is readable: %b%n"</span><span class="o">,</span> <span class="nc">Files</span><span class="o">.</span><span class="na">isReadable</span><span class="o">(</span><span class="n">path1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is regular file: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">isRegularFile</span><span class="o">(</span><span class="n">path1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Is writable: %b%n"</span><span class="o">,</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">isWritable</span><span class="o">(</span><span class="n">path1</span><span class="o">));</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Is Same"</span> <span class="o">+</span> <span class="nc">Files</span><span class="o">.</span><span class="na">isSameFile</span><span class="o">(</span><span class="n">path1</span><span class="o">,</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\FileStoreDemo.java"</span><span class="o">)));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Path1: E:\SpringSourceCode\src\main\java\com\jasu\nio\_12_NIO2\_02_Files\FilesAndDirectoriesDemo.java
Exists: true
Not exists: false
Is directory: false
Is executable: true
Hidden: false
Is readable: true
Is regular file: true
Is writable: true
Is Samefalse
</code></pre></div></div>

<h6 id="creating-files">Creating Files</h6>

<p>é€šè¿‡Filesçš„Path createFile(Path path, FileAttributeâ€¦ attrs) åˆ›å»ºæ–‡ä»¶ã€‚éœ€è¦æŒ‡å®špath å’Œå±æ€§ã€‚</p>

<p>attrs å‚æ•°æŒ‡å®šäº†å±æ€§å¯¹è±¡åˆ—è¡¨ã€‚å±æ€§å®ç°äº†java.nio.file.attribute.FileAttribute æ¥å£ã€‚</p>

<p>createFile() æˆåŠŸè¿”å›æ–‡ä»¶çš„Pathã€‚å¯æŠ›å‡ºUnsupportedOperationException  java.nio.file. FileAlreadyExistsException ã€‚IOException ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šFileAlreadyExistsException æ˜¯ä¸€ä¸ªoptional specific exception ã€‚åº•å±‚æ“ä½œç³»ç»Ÿæ£€æµ‹ç‰¹å®šerrorå¯¼è‡´è¿™ä¸ªå¼‚å¸¸ã€‚å¦‚æœerroræ²¡è¢«æ£€æµ‹ï¼ŒæŠ›å‡ºIOException ã€‚</p>

<p>Listing 12-21 presents the source code to an application that demonstrates createFile() without file attributes.</p>

<p><strong><em>Listing 12-21. Creating an Empty File</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-08-31 17:52
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FilesAndDirectoriesDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="n">createFiles</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createFiles</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">createFile</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"C:/a.jpg"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h6 id="creating-and-deleting-temporary-files">Creating and Deleting Temporary Files</h6>

<p>åº”ç”¨ç»å¸¸éœ€è¦åˆ›å»ºå’Œä½¿ç”¨ä¸´æ—¶å¸¸è§„æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œå†…å­˜å¯†é›†å‹è§†é¢‘ç¼–è¾‘åº”ç”¨ã€‚ä»¥åŠå¤–éƒ¨æ’åºçš„åº”ç”¨ã€‚</p>

<p>ä½ å¯ä»¥ç”¨2ç§æ–¹æ³•åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼š</p>

<ul>
  <li>Path createTempFile(Path dir, String prefix, String suffix, FileAttributeâ€¦ attrs)</li>
  <li>Path createTempFile(String prefix, String suffix, FileAttributeâ€¦ attrs)</li>
</ul>

<p>ç¬¬ä¸€ä¸ªæ–¹æ³•åˆ›å»ºåœ¨dir æ–‡ä»¶å¤¹ï¼Œç¬¬äºŒä¸ªåˆ›å»ºåœ¨é»˜è®¤çš„ä¸´æ—¶æ–‡ä»¶å¤¹ï¼ˆ java.io.tmpdir ï¼‰ã€‚å½“suffix æ˜¯nullï¼Œä¸º.tmpã€‚</p>

<p>æˆåŠŸè¿”å›Pathã€‚</p>

<p>Listing 12-22 presents the source code to an application that demonstrates the first createTempFile() method (without file attributes).</p>

<p><strong><em>Listing 12-22. Creating an Empty Temporary File</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FilesAndDirectoriesDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"java.io.tmpdir"</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createTempFiles</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test6818290517221982513.tmp
</code></pre></div></div>

<p>Demoè¿è¡Œå®Œä¸´æ—¶æ–‡ä»¶ä¸æ¶ˆå¤±ï¼Œä¸ç”¨æœ€å¥½åˆ é™¤ï¼Œ3ç§æ–¹å¼ï¼š</p>

<ul>
  <li>Add a shutdown hook ï¼ˆä¸€ç§è¿è¡Œæ—¶æœºåˆ¶ï¼ŒJVMå…³é—­å‰æ¸…æ¥šèµ„æºæˆ–ä¿å­˜æ•°æ®ï¼‰ï¼Œé€šè¿‡java.lang.Runtime çš„addShutdownHook(Thread hook) æ–¹æ³•ã€‚</li>
  <li>è½¬å˜è¿”å›çš„Pathä¸ºFileï¼Œè°ƒç”¨deleteOnExit()</li>
  <li>ä½¿ç”¨Filesç±»çš„newOutputStream() æ–¹æ³•å’Œ NIO.2â€™s DELETE_ON_CLOSE  å¸¸æ•°ã€‚</li>
</ul>

<p>ç¤ºä¾‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="kt">void</span> <span class="nf">createTempFiles</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">path</span><span class="o">.</span><span class="na">toFile</span><span class="o">().</span><span class="na">deleteOnExit</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div>

<h6 id="reading-files">Reading Files</h6>

<p>Filesç±»æ”¯æŒè¯»å–å¸¸è§„æ–‡ä»¶å†…å®¹ï¼Œå£°æ˜ä¸‹é¢çš„æ–¹æ³•è¯»å–æ‰€æœ‰å­—èŠ‚æˆ–æ–‡æœ¬åˆ°å†…å­˜ï¼š</p>

<ul>
  <li>byte[] readAllBytes(Path path)</li>
  <li>List readAllLines(Path path)</li>
  <li>List readAllLines(Path path, Charset cs)</li>
</ul>

<p>readAllBytes(Path path) è¯»å–æ–‡ä»¶å†…å®¹è¿”å›å­—èŠ‚æ•°ç»„ã€‚ç¡®ä¿è¯»å–å®Œæ¯•åå…³é—­æ–‡ä»¶ã€‚OutOfMemoryError ï¼ˆè¶…è¿‡2Gï¼‰ã€‚ç”¨äºç®€å•çš„åœºæ™¯ï¼Œä¸ç”¨äºè¯»å–å¤§æ–‡ä»¶ã€‚</p>

<p>readAllLines(Path path) ï¼Œç­‰åŒäºreadAllLines(path, java.nio.charset.StandardCharsets.UTF_8);. ã€‚</p>

<p>readAllLines(Path path, Charset cs) æŒ‡å®šç¼–ç ã€‚ç”¨äºç®€å•çš„æ“ä½œï¼Œä¸ç”¨äºè¯»å¤§æ–‡ä»¶ã€‚</p>

<p>Listing 12-24 describes an application that uses readAllLines(Path path) to read all lines from a text file. These lines are subsequently output.</p>

<p><strong><em>Listing 12-24. Dumping a Text File to the Standard Output Stream</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-03 15:39
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReadingFilesDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">stringList</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">readAllLines</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\ReadingFilesDemo.java"</span><span class="o">));</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">stringList</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>If you try to dump a binary file, you will probably discover a java.nio.charset.MalformedInputException message instead.</p>

<p>å‰é¢çš„æ–¹æ³•ä»…é™äºå°†è¾ƒå°çš„æ–‡ä»¶è¯»å…¥å†…å­˜ã€‚ å¯¹äºå¤§æ–‡ä»¶ï¼ŒFilesæä¾›ä¸‹é¢çš„æ–¹æ³•ï¼š</p>

<ul>
  <li>BufferedReader newBufferedReader(Path path)</li>
  <li>BufferedReader newBufferedReader(Path path, Charset cs)</li>
  <li>InputStream newInputStream(Path path, OpenOptionâ€¦ options)</li>
</ul>

<p>newBufferedReader(Path path) ç­‰åŒäº Files.new BufferedReader(path, StandardCharsets.UTF_8) ã€‚</p>

<p>newBufferedReader(Path path, Charset cs) è¿”å›java.io.BufferedReader (with the default buffer size) ï¼ŒæŒ‡å®šç¼–ç ã€‚</p>

<p>newInputStream(Path path, OpenOptionâ€¦ options) è¿”å›java.io.InputStream ï¼Œstream ä¸ä¼šè¢«bufferedï¼Œä¸ç”¨æ”¯æŒmark()æˆ–è€…reset()ã€‚stream å¯¹å¤šçº¿ç¨‹çš„è®¿é—®æ˜¯å®‰å…¨çš„ã€‚ä»å¤´å¼€å§‹è¯»ã€‚</p>

<p>å¯ä»¥ä¼ å…¥java.nio.file.OpenOptionsçš„å¯å˜å‚æ•°åˆ—è¡¨ã€‚è¿™äº›optionsé…ç½®äº†å¦‚ä½•åˆ›å»ºå’Œæ‰“å¼€æ–‡ä»¶ã€‚java.nio.file. StandardOpenOption æšä¸¾ç±»å®ç°äº†è¿™ä¸ªæ¥å£å¹¶æä¾›ä¸‹é¢çš„å¸¸é‡ï¼š</p>

<ul>
  <li>APPEND: å¦‚æœæ–‡ä»¶ä¸ºäº†å†™æ‰“å¼€ï¼Œå†™å­—èŠ‚åˆ°æ–‡ä»¶æœ«å°¾è€Œä¸æ˜¯å¼€å¤´</li>
  <li>CREATE æ–‡ä»¶ä¸å­˜åœ¨å°±åˆ›å»ºæ–‡ä»¶</li>
  <li>CREATE_NEW: åˆ›å»ºæ–°æ–‡ä»¶ï¼Œæ–‡ä»¶å­˜åœ¨æ—¶å¤±è´¥</li>
  <li>DELETE_ON_CLOSE: å½“fileå…³é—­æ—¶ï¼Œæœ€å¤§åŠªåŠ›åˆ é™¤æ–‡ä»¶ã€‚</li>
  <li>DSYNC: è¦æ±‚æ¯æ¬¡å¯¹æ–‡ä»¶å†…å®¹çš„æ›´æ–°åŒæ­¥åˆ°åº•å±‚å‚¨å­˜è®¾å¤‡</li>
  <li>READ: Open the file for read access.</li>
  <li>SPARSE: Open a sparse file (https://en.wikipedia.org/ wiki/Sparse_file).  å½“ä½¿ç”¨CREATE_NEWï¼ŒSPARSEæä¾›äº†ä¸€ä¸ªæš—ç¤ºï¼Œæ–°å»ºçš„æ–‡ä»¶æ˜¯sparseã€‚æ“ä½œç³»ç»Ÿä¸æ”¯æŒä¼šå¿½ç•¥ã€‚</li>
  <li>SYNC: è¦æ±‚æ–‡ä»¶å†…å®¹æˆ–è€…metadataçš„æ›´æ–°åŒæ­¥åˆ°åº•å±‚å‚¨å­˜è®¾å¤‡ã€‚</li>
  <li>TRUNCATE_EXISTING: Truncate å­˜åœ¨çš„ç”¨WRITEè®¿é—®æ‰“å¼€çš„æ–‡ä»¶çš„é•¿åº¦åˆ°0ã€‚</li>
  <li>WRITE: Open the file for write access.</li>
</ul>

<p>ä¸æ˜¯å…¨éƒ½é€‚ç”¨ newInputStream() ï¼Œä¸€äº›é€‚ç”¨ newOutputStream() ã€‚</p>

<p>Listing 12-25 describes an application that demonstrates newBufferedReader(Path path).</p>

<p><strong><em>Listing 12-25. Dumping a Text File to the Standard Output Stream, Revisited</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-03 16:34
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewBufferedReaderDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">newBufferedReader</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\SpringSourceCode\\src\\main\\java\\com\\jasu\\nio\\_12_NIO2\\_02_Files\\NewBufferedReaderDemo.java"</span><span class="o">));</span>
        <span class="nc">String</span> <span class="n">line</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h6 id="writing-files">Writing Files</h6>

<p>Filesæä¾›äº†å†™å­—èŠ‚æˆ–æ–‡æœ¬çš„æ–¹æ³•ï¼š</p>

<ul>
  <li>Path write(Path path, byte[] bytes, OpenOptionâ€¦ options)</li>
  <li>Path write(Path path, Iterable lines, Charset cs, OpenOptionâ€¦ options)</li>
  <li>Path write(Path path, Iterable lines, OpenOptionâ€¦ options)</li>
</ul>

<p>write(Path path, byte[] bytes, OpenOptionâ€¦ options)  å†™å­—èŠ‚åˆ°pathã€‚å¦‚æœæ²¡ä¼ å…¥å°±æ˜¯ CREATE, TRUNCATE_EXISTING, and WRITE ã€‚</p>

<p>write(Path path, Iterable lines, Charset cs, OpenOptionâ€¦ options) å†™linesåˆ°pathã€‚ç³»ç»ŸæŒ‡å®šçš„æ¢è¡Œç¬¦line.separator ã€‚æŒ‡å®šäº†ç¼–ç ã€‚æ²¡ä¼ optionä¸º CREATE, TRUNCATE_EXISTING, and WRITE  ã€‚</p>

<p>write(Path path, Iterable lines, OpenOptionâ€¦ options) behaves as if you specified Files.write(path, lines, StandardCharsets.UTF_8, options);.</p>

<p>Listing 12-26 describes an application that reads a web page and saves its HTML text to a file named page.html.</p>

<p><strong><em>Listing 12-26. Saving Web Page HTML to a Text File</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-03 16:50
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewBufferedWriterDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="s">"https://www.baidu.com"</span><span class="o">);</span>
        <span class="nc">InputStreamReader</span> <span class="n">inputStreamReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">openStream</span><span class="o">());</span>
        <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="n">inputStreamReader</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">lines</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">String</span> <span class="n">line</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">lines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"C:/page.html"</span><span class="o">),</span> <span class="n">lines</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å‰é¢çš„æ–¹æ³•é™åˆ¶äºå†™å°æ•°é‡çš„å†…å®¹åˆ°æ–‡ä»¶ã€‚å¯¹äºå¤§é‡å†…å®¹ï¼ŒFilesæä¾›ä¸‹é¢çš„æ–¹æ³•ï¼š</p>

<ul>
  <li>BufferedWriter newBufferedWriter(Path path, Charset cs, OpenOptionâ€¦ options)</li>
  <li>BufferedWriter newBufferedWriter(Path path, OpenOptionâ€¦ options)</li>
  <li>OutputStream newOutputStream(Path path, OpenOptionâ€¦ options)</li>
</ul>

<p>newBufferedWriter(Path path, Charset cs, OpenOptionâ€¦ options)  æ‰“å¼€æˆ–åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œè¿”å›java.io.BufferedWriter (with the default buffer size) ã€‚æŒ‡å®šäº†ç¼–ç ã€‚é»˜è®¤optionä¸º CREATE, TRUNCATE_EXISTING, and WRITE ã€‚</p>

<p>newBufferedWriter(Path path, OpenOptionâ€¦ options) behaves as if you specified Files.newBufferedWriter(path, StandardCharsets.UTF_8, options);</p>

<p>newOutputStream(Path path, OpenOptionâ€¦ options) è¿”å›java.io.OutputStream ã€‚stream ä¸è¢«bufferedï¼Œå†™æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚é»˜è®¤optionä¸º CREATE, TRUNCATE_EXISTING, and WRITE ã€‚</p>

<p>Listing 12-27 describes an application that demonstrates newBufferedWriter(Path path, OpenOptionâ€¦ options).</p>

<p><strong><em>Listing 12-27. Saving Web Page HTML to a Text File, Revisited</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-03 16:50
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewBufferedWriterDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="s">"https://www.baidu.com"</span><span class="o">);</span>
        <span class="nc">InputStreamReader</span> <span class="n">inputStreamReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">openStream</span><span class="o">());</span>
        <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="n">inputStreamReader</span><span class="o">);</span>
        <span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">newBufferedWriter</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"C:/page.html"</span><span class="o">));</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">lines</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">String</span> <span class="n">line</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">line</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">line</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h6 id="randomly-accessing-files">Randomly Accessing Files</h6>

<p>ç¬¬ä¸‰ç« ä»‹ç»äº†java.io.RandomAccessFile ã€‚NIO.2 æä¾›äº†ç­‰ä»·çš„java.nio.channels.SeekableByteChannel æ¥å£ã€‚</p>

<p>SeekableByteChannel ç»§æ‰¿java.nio.channels.ByteChannel æ¥å£ï¼Œæè¿°ä¸€ä¸ªbyte channel ç»´æŠ¤ä¸€ä¸ªå½“å‰positionï¼Œå…è®¸positionè¢«æ”¹å˜ã€‚Table 12-1 presents its methods.</p>

<p><strong><em>Table 12-1. The Methods That Define a Seekable Byte Channel</em></strong></p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>long position()</td>
      <td>è¿”å›è¯¥channelçš„positionï¼Œ ä»seekable entityçš„èµ·å§‹ä½ç½®åˆ°å½“å‰ä½ç½®çš„éè´Ÿå­—èŠ‚è®¡æ•°ã€‚</td>
    </tr>
    <tr>
      <td>SeekableByteChannel position(long newPosition)</td>
      <td>è®¾ç½®channelçš„positionåˆ°newPositionã€‚è®¾ç½®positionè¶…å‡ºå½“å‰sizeæ˜¯åˆæ³•çš„ï¼Œä¸ä¼šæ”¹å˜å®ä½“çš„sizeã€‚</td>
    </tr>
    <tr>
      <td>int read(ByteBuffer dst)</td>
      <td>Read a sequence of bytes from this channel into the given buffer.</td>
    </tr>
    <tr>
      <td>long size()</td>
      <td>Return the current size (in bytes) of the entity to which this channel is connected.</td>
    </tr>
    <tr>
      <td>SeekableByteChannel truncate(long size)</td>
      <td>Truncate the entity to which this channel is connected to size.</td>
    </tr>
    <tr>
      <td>int write(ByteBuffer src)</td>
      <td>Write a sequence of bytes to this channel from the given buffer</td>
    </tr>
  </tbody>
</table>

<p>JDK 7 é‡æ„java.nio.channels.FileChannel å®ç°äº†SeekableByteChannel ã€‚SeekableByteChannel æ–‡æ¡£å»ºè®®æ–¹æ³•è¿”å›çš„ç±»å‹å®ç°äº†SeekableByteChannel ï¼Œç„¶åchainåœ¨ä¸€èµ·ã€‚</p>

<p>Filesç±»è®©ä½ æ¥æ”¶SeekableByteChannel ï¼š</p>

<ul>
  <li>SeekableByteChannel newByteChannel(Path path, OpenOptionâ€¦ options)</li>
  <li>SeekableByteChannel newByteChannel(Path path, Set options, FileAttributeâ€¦ attrs)</li>
</ul>

<p>Iâ€™ve created an application that demonstrates SeekableByteChannel in a FileChannel context and also in a more generic context. Listing 12-28 presents the applicationâ€™s source code.</p>

<p><strong><em>Listing 12-28. Demonstrating SeekableByteChannel</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SeekableByteChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.EnumSet</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">file</span><span class="o">.</span><span class="na">StandardOpenOption</span><span class="o">.*;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-04 11:15
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeekableByteChannelDemo</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">REC_LEN</span> <span class="o">=</span> <span class="mi">50</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"emp"</span><span class="o">);</span>
        <span class="nc">FileChannel</span> <span class="n">fc</span><span class="o">;</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="nc">FileChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="no">CREATE</span><span class="o">,</span> <span class="no">WRITE</span><span class="o">,</span> <span class="no">SYNC</span><span class="o">).</span><span class="na">position</span><span class="o">(</span><span class="no">REC_LEN</span> <span class="o">*</span> <span class="mi">2</span><span class="o">);</span>
        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="s">"John Smith"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
        <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="nc">SeekableByteChannel</span> <span class="n">sbc</span><span class="o">;</span>
        <span class="n">sbc</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">newByteChannel</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="nc">EnumSet</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="no">READ</span><span class="o">)).</span><span class="na">position</span><span class="o">(</span><span class="no">REC_LEN</span> <span class="o">*</span> <span class="mi">2</span><span class="o">);</span>
        <span class="n">sbc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
        <span class="n">sbc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">array</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å…ˆåˆ›å»ºpathï¼Œç„¶ååœ¨æ–‡ä»¶ä¸Šopenä¸€ä¸ªchannelã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šNIO.2æ·»åŠ äº†FileChannel open(Path path, OpenOptionâ€¦
options) and FileChannel open(Path path, Set options, FileAttributeâ€¦ attrs)æ–¹æ³•åˆ°FileChannelç±»ï¼Œä½ ä¸éœ€è¦ä¾èµ–ä¼ ç»Ÿi/oæ–¹å¼å¾—åˆ°file channelã€‚</p>

<p>open()æ–¹æ³•å¸¦æœ‰CREATE, WRITE, SYNC optionsã€‚</p>

<p>æˆåŠŸè·å¾— seekable file channelåï¼Œmain() åœ¨channelè°ƒç”¨position()è®¾ç½®è¯»å–positionï¼Œ2å€çš„recodeï¼ˆå‡è®¾empæ˜¯a flat file databaseï¼Œè¢«åˆ†éš”ä¸ºrecordsï¼Œæ¯ä¸ªrecord é•¿åº¦ä¸ºREC_LENï¼‰ã€‚</p>

<p>è°ƒç”¨java.nio.ByteBufferâ€™s ByteBuffer wrap(byte[] array) æ–¹æ³•åŒ…è£…å­—èŠ‚æ•°ç»„ï¼Œbufferç„¶åå†™å…¥åˆ°channelï¼Œç„¶åå…³é—­ã€‚empæ–‡ä»¶åº”è¯¥åœ¨100çš„ä½ç½®å¼€å§‹æœ‰å­—èŠ‚åºåˆ—ã€‚</p>

<p>ç„¶ånewByteChannel() and SeekableByteChannelã€‚ä¸æŠŠFileChannelç¡¬ç¼–ç åœ¨æºç ï¼Œä½¿ç”¨SeekableByteChannelæ›´æœ‰åˆ©ã€‚</p>

<p>å…³é—­seekable byte channelåï¼Œè°ƒç”¨ByteBufferâ€™s byte[] array()è¿”å›å­—èŠ‚æ•°ç»„ã€‚æ”¾å…¥new Stringã€‚</p>

<h6 id="creating-directories">Creating Directories</h6>

<p>è°ƒç”¨ Filesç±»çš„Path createDirectory(Path dir, FileAttributeâ€¦ attrs)æ–¹æ³•ã€‚å½“åˆ›å»ºæ–‡ä»¶å¤¹ï¼ŒæŒ‡å®špathå’Œå±æ€§çš„å¯å˜å‚æ•°åˆ—è¡¨ã€‚</p>

<p>createDirectory()æˆåŠŸè¿”å›pathã€‚</p>

<p>Listing 12-29 presents the source code to an application that demonstrates
createDirectory() without file attributes.</p>

<p><strong><em>Listing 12-29. Creating an Empty Directory</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-04 17:05
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreateDirectoriesDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="nc">Files</span><span class="o">.</span><span class="na">createDirectory</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"C:/test"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä½¿ç”¨ Path createDirectories(Path dir, FileAttributeâ€¦attrs)åˆ›å»ºå±‚çº§æ–‡ä»¶å¤¹ã€‚ä¸ä¼šæŠ›FileAlreadyExistsExceptionã€‚</p>

<p>FileAttributeæ˜¯PosixFilePermissions classâ€™s File Attribute&gt; asFileAttribute(Set perms)çš„è¿”å›ç±»å‹ã€‚ä½ å¯ä»¥åœ¨POSIX file systemä¸Šè¿™ä¹ˆåšï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">PosixFilePermission</span><span class="o">&gt;</span> <span class="n">perms</span> <span class="o">=</span>
 <span class="nc">PosixFilePermissions</span><span class="o">.</span><span class="na">fromString</span><span class="o">(</span><span class="s">"rw-------"</span><span class="o">);</span>
<span class="nc">FileAttribute</span><span class="o">&lt;</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">PosixFilePermission</span><span class="o">&gt;&gt;</span> <span class="n">fa</span> <span class="o">=</span>
 <span class="nc">PosixFilePermissions</span><span class="o">.</span><span class="na">asFileAttribute</span><span class="o">(</span><span class="n">perms</span><span class="o">);</span>
<span class="nc">Files</span><span class="o">.</span><span class="na">createDirectory</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"images"</span><span class="o">),</span> <span class="n">fa</span><span class="o">);</span>

</code></pre></div></div>

<h6 id="creating-and-deleting-temporary-directories">Creating and Deleting Temporary Directories</h6>

<p>åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹ï¼š</p>

<ul>
  <li>Path createTempDirectory(Path dir, String prefix, FileAttributeâ€¦ attrs)</li>
  <li>Path createTempDirectory(String prefix,FileAttributeâ€¦ attrs)</li>
</ul>

<p>ç¬¬äºŒä¸ªåˆ›å»ºåœ¨ç³»ç»Ÿå±æ€§java.io.tmpdiræ–‡ä»¶å¤¹ï¼ŒæˆåŠŸè¿”å›pathã€‚</p>

<p>Listing 12-30 presents the source code to an application that demonstrates
the first createTempDirectory() method (without file attributes).</p>

<p><strong><em>Listing 12-30. Creating an Empty Temporary Directory</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Files</span><span class="o">.</span><span class="na">createTempDirectory</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"C:/test"</span><span class="o">),</span> <span class="s">"test"</span><span class="o">);</span>
</code></pre></div></div>

<p>ç¨‹åºæ‰§è¡Œç»“æŸï¼Œä¸´æ—¶æ–‡ä»¶å¤¹è¿˜åœ¨ï¼Œ2ç§æ–¹æ³•åˆ é™¤ï¼š</p>

<ul>
  <li>Add a shutdown hook via the Runtime classâ€™s void addShutdownHook(Thread hook) method.</li>
  <li>Convert the returned Path object to a File object (via Pathâ€™s toFile() method) and invoke Fileâ€™s void deleteOnExit() method on the File object.</li>
</ul>

<p>Listing 12-31 expands on Listing 12-30 by using a shutdown hook to
remove a temporary directory before the JVM shuts down.</p>

<p><strong><em>Listing 12-31. Using a Shutdown Hook to Remove a Temporary Directory on JVM Exit</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">createTempDirectory</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"C:/test"</span><span class="o">),</span> <span class="s">"test"</span><span class="o">);</span>

        <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">addShutdownHook</span><span class="o">(</span><span class="k">new</span> <span class="nc">Thread</span><span class="o">(()-&gt;{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}));</span>
    <span class="o">}</span>
</code></pre></div></div>

<h6 id="listing-directory-content">Listing Directory Content</h6>

<p>NIO.2æä¾›äº†<code class="language-plaintext highlighter-rouge">java.nio.file.DirectoryStream&lt;T&gt;</code>æ¥å£æ¥å¾—åˆ°æ–‡ä»¶å¤¹æ¡ç›®ã€‚DirectoryStreamç»§æ‰¿java.lang.Iterableã€‚</p>

<p>DirectoryStreamä¹Ÿç»§æ‰¿java.io.Closeableï¼Œå®ƒç»§æ‰¿java.lang.AutoCloseableã€‚å› æ­¤å¯ä»¥ç”¨ try-with-resourcesè‡ªåŠ¨å…³é—­directory streamã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šå½“ä¸ä½¿ç”¨try-with-resourcesï¼Œè¿­ä»£åè°ƒç”¨directory streamçš„close()æ–¹æ³•é‡Šæ”¾æ‰“å¼€æ–‡ä»¶å¤¹æŒæœ‰çš„èµ„æºã€‚streamå½“ç¨‹åºç»“æŸè‡ªåŠ¨å…³é—­ã€‚</p>

<p>DirectoryStreamç»§æ‰¿äº† Iterableâ€™s Iterator iterator()æ–¹æ³•ã€‚å£°æ˜äº†å†…ç½®çš„<code class="language-plaintext highlighter-rouge">Filter&lt;T&gt;</code>æ¥å£ã€‚</p>

<p>è°ƒç”¨Filesç±»çš„ä¸‹é¢æ–¹æ³•è·å–DirectoryStreamï¼š</p>

<ul>
  <li>DirectoryStream newDirectoryStream(Path dir)</li>
  <li>DirectoryStream newDirectoryStream(Path dir, DirectoryStream.Filter filter)</li>
  <li>DirectoryStream newDirectoryStream(Path dir, String glob)</li>
</ul>

<p>Listing 12-32 presents an application that obtains and outputs all entries in
the specified directory.</p>

<p><strong><em>Listing 12-32. Obtaining and Outputting All Entries in a Directory</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"C:/windows"</span><span class="o">);</span>
        <span class="nc">DirectoryStream</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;</span> <span class="n">paths</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">newDirectoryStream</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">"exe"</span><span class="o">));</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Path</span> <span class="n">path1</span> <span class="o">:</span> <span class="n">paths</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path1</span><span class="o">);</span>
        <span class="o">}</span>
</code></pre></div></div>

<p>æ²¡æœ‰ç”¨try-with-resourceï¼Œå› ä¸ºæ‰§è¡Œå®Œå°±ç»“æŸäº†ã€‚ä¼ å…¥äº†ä¸€ä¸ªfilterï¼ˆlambdaï¼‰ã€‚</p>

<p>newDirectoryStream(Path dir, String glob)ï¼Œä½¿ç”¨ globbing patternã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="o">(</span><span class="nc">DirectoryStream</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;</span> <span class="n">ps</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">newDirectoryStream</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"*.exe"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Path</span> <span class="n">p</span> <span class="o">:</span> <span class="n">ps</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
</code></pre></div></div>

<h6 id="copying-files">Copying Files</h6>

<p>Fileç±»çš„ä¸€ä¸ªç—›ç‚¹å°±æ˜¯æ²¡æœ‰copy()æ–¹æ³•ã€‚Filesæä¾›äº†ï¼š</p>

<ul>
  <li>
    <p>long copy(InputStream in, Path target, CopyOptionâ€¦ options): Copy from a classic I/O input stream to a path.</p>
  </li>
  <li>long copy(Path source, OutputStream out): Copy from a path to a classic I/O output stream.</li>
  <li>Path copy(Path source, Path target, CopyOptionâ€¦ options): Copy from one path to another.</li>
</ul>

<p>ç¬¬ä¸€ä¸ªæ–¹æ³•å¤åˆ¶æ‰€æœ‰å­—èŠ‚åˆ°pathã€‚On return, the input stream will be at end-of-stream.</p>

<p>å¯èƒ½ä¼šä¼ å…¥ java.nio.file.CopyOptionå¯å˜å‚æ•°ã€‚java.nio.file.StandardCopyOptionæšä¸¾ç±»å®ç°äº†æ¥å£æä¾›ä¸‹é¢çš„å¸¸é‡ã€‚</p>

<ul>
  <li>ATOMIC_MOVE:ä½œä¸ºä¸€ä¸ªåŸå­æ–‡ä»¶ç³»ç»Ÿæ“ä½œæ‰§è¡Œmoveã€‚copyæ–¹æ³•ä¸ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼Œåœ¨å¤åˆ¶ä¸Šä¸‹æ–‡æ²¡æ„ä¹‰ã€‚</li>
  <li>COPY_ATTRIBUTES: å¤åˆ¶å±æ€§ä¸å†…å®¹</li>
  <li>REPLACE_EXISTING: æ›¿æ¢å­˜åœ¨çš„ç›®æ ‡</li>
</ul>

<p>LinkOptionä¹Ÿå®ç°äº†CopyOptionï¼Œå®ƒæä¾›äº†NOFOLLOW_LINKSå¸¸é‡ï¼ˆdonâ€™t follow symbolic linksï¼‰ã€‚</p>

<p>é»˜è®¤ï¼Œå½“ç›®æ ‡å­˜åœ¨æˆ–æ˜¯symbolic linkï¼Œå¤åˆ¶æ“ä½œå¤±è´¥ã€‚å¦‚æœæŒ‡å®š REPLACE_EXISTINGï¼Œç›®æ ‡ä¹Ÿå­˜åœ¨äº†ï¼Œç›®æ ‡ä¼šè¢«æ›¿æ¢ï¼ˆé™¤éæ˜¯éç©ºæ–‡ä»¶å¤¹ï¼‰ã€‚å¦‚æœtargetå­˜åœ¨ä¸”æ˜¯symbolic linkï¼Œç¬¦å·è¿æ¥è¢«æ›¿æ¢ã€‚</p>

<p>è¿”å›è¯»/å†™çš„å­—èŠ‚æ•°ã€‚</p>

<p><strong><em>Caution</em></strong>ï¼š å¦‚æœè¯»å†™å‘ç”Ÿi/oé”™è¯¯ï¼Œå¯¼è‡´è¾“å…¥æµä¸åœ¨end-of-streamï¼Œå¯èƒ½å¤„äºä¸ä¸€è‡´çŠ¶æ€ã€‚å¼ºçƒˆå»ºè®®å‘ç”ŸI/Oé”™è¯¯é©¬ä¸Šå…³é—­è¾“å…¥æµã€‚</p>

<p>Listing 12-35 refactors Listing 12-27â€™s SavePage application to use
copy(InputStream in, Path target, CopyOptionâ€¦ options) to copy a
web page to a file</p>

<p><strong><em>Listing 12-35. Saving Web Page HTML via copy(InputStream, Path, CopyOptionâ€¦)</em></strong></p>

<p>ç¬¬äºŒä¸ªæ–¹æ³•ä»pathå¤åˆ¶å­—èŠ‚åˆ°è¾“å‡ºæµã€‚å¦‚æœç»™å®šè¾“å‡ºæµæ˜¯ flushableçš„ï¼Œè¿™ä¸ªæ–¹æ³•ç»“æŸæ—¶è¦è°ƒç”¨flush()ï¼Œå¯ä»¥flushåˆ°ä»»ä½•bufferedè¾“å‡ºã€‚æ–¹æ³•è¿”å›è¯»æˆ–å†™çš„å­—èŠ‚æ•°ã€‚</p>

<p><strong><em>Caution</em></strong>ï¼š è¯»ã€å†™çš„æ—¶å€™å‘ç”ŸI/Oé”™è¯¯ï¼Œå¼ºçƒˆå»ºè®®åœ¨I/Oé”™è¯¯åå…³è¾“å‡ºæµã€‚</p>

<p>Listing 12-36 presents the source code to an application that copies all
bytes from a source path to a file output stream.</p>

<p><strong><em>Listing 12-36. Copying from a Source Path to a File Output Stream</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"page.html"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="s">"copy.bak"</span><span class="o">));</span>
</code></pre></div></div>

<p>ç¬¬ä¸‰ä¸ªæ–¹æ³•ä»pathåˆ°pathï¼Œé»˜è®¤targetå­˜åœ¨æˆ–è€…æ˜¯ä¸€ä¸ªç¬¦å·è¿æ¥æ“ä½œä¼šå¤±è´¥ã€‚ç„¶è€Œï¼Œå½“sourceå’Œtargetä¸€æ ·ï¼Œä¸æ‰§è¡Œå¤åˆ¶ã€‚</p>

<p>ä¸€äº›é¢å¤–æ³¨æ„çš„åœ°æ–¹ï¼š</p>

<ul>
  <li>å±æ€§ä¸ä¸€å®šéœ€è¦è¾…åŠ©åˆ°ç›®æ ‡</li>
  <li>å½“æ”¯æŒç¬¦å·è¿æ¥ï¼Œsourceæ˜¯ä¸€ä¸ªç¬¦å·è¿æ¥ï¼Œè¿æ¥çš„æœ€ç»ˆç›®æ ‡è¢«å¤åˆ¶ã€‚</li>
</ul>

<p>ä½ å¯èƒ½éœ€è¦æŒ‡å®šä¸‹é¢çš„å¤åˆ¶å±æ€§ï¼š -</p>

<ul>
  <li>COPY_ATTRIBUTES:</li>
  <li>NOFOLLOW_LINKS: ä¸è·Ÿè¸ªç¬¦å·è¿æ¥ã€‚å½“sourceæ˜¯ç¬¦å·è¿æ¥ï¼Œé“¾æ¥æœ¬äº‹è¢«å¤åˆ¶ï¼Œè€Œä¸æ˜¯è¿æ¥æŒ‡å‘çš„ç›®æ ‡ã€‚COPY_ATTRIBUTESåœ¨å¤åˆ¶ç¬¦å·è¿æ¥æ—¶å¿½ç•¥ã€‚</li>
  <li>REPLACE_EXISTING: targetå­˜åœ¨æ—¶ï¼Œè¦†ç›–target</li>
</ul>

<p>æ–¹æ³•è¿”å›pathã€‚</p>

<p>Listing 12-37 presents the source code to an application that copies all
bytes from a source path to a target path.</p>

<p><strong><em>Listing 12-37. Copying from a Source Path to a Target Path</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"page.html"</span><span class="o">),</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"copy.bak"</span><span class="o">),</span> <span class="nc">StandardCopyOption</span><span class="o">.</span><span class="na">REPLACE_EXISTING</span><span class="o">);</span>
</code></pre></div></div>

<h6 id="moving-files">Moving Files</h6>

<p>æ–‡ä»¶ç§»åŠ¨ä¹Ÿæ˜¯Fileç±»çš„ç—›ç‚¹ï¼ŒFilesæä¾›äº† Path move(Path source, Path target, CopyOptionâ€¦ options)ã€‚</p>

<p>å½“targetå­˜åœ¨ç§»åŠ¨å¤±è´¥ï¼Œé™¤ésourceå’ŒtargetåŒåï¼Œè¿™ç§æƒ…å†µä¸‹æ–¹æ³•æ— æ•ˆã€‚å¦‚æœsourceæ˜¯ç¬¦å·é“¾æ¥ï¼Œç§»åŠ¨çš„ç¬¦å·è€Œä¸æ˜¯targetã€‚</p>

<p>æ”¯æŒä¸‹é¢çš„ç§»åŠ¨optionï¼š</p>

<ul>
  <li>ATOMIC_MOVE:è¿™ä¸ªmoveä½œä¸ºä¸€ä¸ªåŸå­æ–‡ä»¶ç³»ç»Ÿæ“ä½œæ‰§è¡Œï¼Œæ‰€æœ‰å…¶ä»–optionéƒ½è¢«å¿½ç•¥ã€‚å½“targetå­˜åœ¨ï¼Œè¦ä¹ˆè¢«æ›¿æ¢è¦ä¹ˆæŠ›å¼‚å¸¸ã€‚</li>
  <li>REPLACE_EXISTING: targetå­˜åœ¨è¢«æ›¿æ¢ï¼ˆéç©ºæ–‡ä»¶å¤¹ä¸æ›¿æ¢ï¼‰ã€‚å¦‚æœæ˜¯ç¬¦å·é“¾æ¥å°±æ˜¯ç§»åŠ¨çš„ç¬¦å·é“¾æ¥ï¼Œä¸æ˜¯é“¾æ¥çš„targetã€‚</li>
</ul>

<p>moveä¼šå¤åˆ¶ lastModifiedTimeå±æ€§åˆ°targetã€‚å¤åˆ¶æ—¶é—´æˆ³å¯èƒ½å¯¼è‡´ç²¾åº¦æŸå¤±ã€‚move()çš„å®ç°ä¹Ÿå¯èƒ½å°è¯•å¤åˆ¶å…¶ä»–å±æ€§ã€‚å½“å®ƒä»¬ä¸èƒ½è¢«å¤åˆ¶æ—¶ï¼Œä¸éœ€è¦å¤±è´¥ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šmoveå¯ä»¥ç”¨äºç§»åŠ¨ç©ºæ–‡ä»¶å¤¹ã€‚å½“ç§»åŠ¨éç©ºæ–‡ä»¶å¤¹ï¼Œå½“ç›®å½•ä¸éœ€è¦ç§»åŠ¨æ–‡ä»¶å¤¹çš„æ¡ç›®æ—¶ï¼Œå°±ä¼šç§»åŠ¨æ–‡ä»¶å¤¹ã€‚å½“éœ€è¦ç§»åŠ¨æ¡ç›®ï¼Œæ–¹æ³•å¤±è´¥ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Files</span><span class="o">.</span><span class="na">move</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"page.html"</span><span class="o">),</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"p.html"</span><span class="o">));</span>
</code></pre></div></div>

<h6 id="deleting-files">Deleting Files</h6>

<p>Filesåˆ é™¤çš„2ä¸ªæ–¹æ³•ï¼š</p>

<ul>
  <li>void delete(Path path)</li>
  <li>boolean deleteIfExists(Path path)</li>
</ul>

<p>delete(Path path)ï¼Œå¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œå¿…é¡»æ˜¯ç©ºçš„ã€‚å¦‚æœæ˜¯ç¬¦å·é“¾æ¥ï¼Œåˆ é™¤çš„ç¬¦å·é“¾æ¥ï¼Œä¸æ˜¯targetã€‚</p>

<p>deleteIfExists(Path path)ï¼Œå¦‚æœæ˜¯ç¬¦å·é“¾æ¥ï¼Œåˆ é™¤é“¾æ¥ã€‚å½“è¢«åˆ é™¤è¿”å›trueï¼›å¦åˆ™falseã€‚</p>

<p>Listing 12-39 presents the source code to an application that demonstrates
deleteIfExists().</p>

<p><strong><em>Listing 12-39. Deleting a File When It Exists</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Files</span><span class="o">.</span><span class="na">deleteIfExists</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"page.html"</span><span class="o">));</span>
</code></pre></div></div>

<h5 id="managing-symbolic-and-hard-links">Managing Symbolic and Hard Links</h5>

<p>æ–‡ä»¶ç³»ç»Ÿå‚¨å­˜æ–‡ä»¶ï¼Œæ–‡ä»¶å¤¹ï¼Œå’Œlinksï¼Œé“¾æ¥æ˜¯æŒ‡å‘å…¶ä»–çœŸå®æ–‡ä»¶ï¼Œæ–‡ä»¶å¤¹ï¼Œæˆ–è€…å…¶ä»–é“¾æ¥çš„æ–‡ä»¶ã€‚linksåˆ†ä¸ºç¬¦å·ï¼ˆè½¯ï¼‰é“¾æ¥å’Œç¡¬é“¾æ¥ã€‚Filesæœ‰å‡ ä¸ªæ–¹æ³•ç®¡ç†ç¬¦å·é“¾æ¥ï¼Œä¹Ÿæä¾›äº†ä¸€ä¸ªåˆ›å»ºç¡¬é“¾æ¥çš„æ–¹æ³•ã€‚</p>

<h6 id="managing-symbolic-links">Managing Symbolic Links</h6>

<p>ç¬¦å·é“¾æ¥æ˜¯å¼•ç”¨å…¶ä»–æ–‡ä»¶çš„ç‰¹æ®Šæ–‡ä»¶ã€‚ Figure 12-3 illustrates a symbolic link</p>

<p><img src="/assets/img/1536140624140.png" alt="1536140624140" /></p>

<p>è®¸å¤šæ–‡ä»¶ç³»ç»Ÿå¹¿æ³›ä½¿ç”¨ç¬¦å·é“¾æ¥ã€‚ç„¶åï¼Œç¬¦å·é“¾æ¥å¯èƒ½äº§ç”Ÿä¸€ä¸ªå¾ªç¯å¼•ç”¨ã€‚å½“é€’å½’åœ°éå†æ–‡ä»¶æ ‘æ—¶ï¼Œå¾ªç¯å¼•ç”¨å¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œè¿™æ˜¯å°†åœ¨æœ¬ç« åé¢è®¨è®ºã€‚ç„¶è€Œï¼ŒNIO.2â€™s file tree-walkingè€ƒè™‘åˆ°äº†è¿™ç‚¹ã€‚</p>

<p>Filesç±»æä¾›Path createSymbolicLink(Path link, Path target, FileAttributeâ€¦ attrs)æ–¹æ³•å¯¹targetåˆ›å»ºç¬¦å·è¿æ¥ã€‚</p>

<p>Listing 12-40 presents the source code to an application that demonstrates
symbolic link creation.</p>

<p><strong><em>Listing 12-40. Creating a Symbolic Link</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Files</span><span class="o">.</span><span class="na">createSymbolicLink</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D:/clicker"</span><span class="o">),</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D:/clicker.link"</span><span class="o">));</span>
<span class="nc">Files</span><span class="o">.</span><span class="na">isSymbolicLink</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D:/clicker.link"</span><span class="o">));</span>
</code></pre></div></div>

<p>isSymbolicLinkæ˜¯å¦æ˜¯ç¬¦å·é“¾æ¥ã€‚</p>

<p>readSymbolicLink(Path link)è¯»å–ç¬¦å·è¿æ¥çš„targetã€‚æˆåŠŸè¿”å›targetçš„Pathã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Files</span><span class="o">.</span><span class="na">readSymbolicLink</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D:/clicker.link"</span><span class="o">));</span>
</code></pre></div></div>

<h6 id="managing-hard-links">Managing Hard Links</h6>

<p>ç¡¬é“¾æ¥æ˜¯ä¸€ä¸ªç›®å½•æ¡ç›®ï¼Œå®ƒå°†åå­—ä¸æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶å…³è”èµ·æ¥ã€‚å®ƒåŸºæœ¬ä¸Šå’ŒåŸå§‹æ–‡ä»¶æ˜¯ä¸€æ ·çš„ã€‚æ‰€æœ‰å±æ€§éƒ½æ˜¯ç›¸åŒçš„ï¼šå®ƒä»¬å…·æœ‰ç›¸åŒçš„æ–‡ä»¶æƒé™ã€æ—¶é—´æˆ³ç­‰ã€‚å›¾12-4åŒºåˆ†äº†è½¯é“¾æ¥å’Œç¡¬é“¾æ¥ã€‚</p>

<p><img src="/assets/img/1536136101095.png" alt="1536136101095" /></p>

<p>ä¸Šé¢æ˜¯ç”¨æˆ·æ„ŸçŸ¥ï¼Œä¸‹é¢æ˜¯å®é™…æƒ…å†µã€‚</p>

<p>å¯¹äºä¸€ä¸ªè½¯é“¾æ¥ï¼Œæ–‡ä»¶æŒ‡å‘ä¸€ä¸ªinodeï¼Œè€Œè½¯é“¾æ¥æŒ‡å‘å¦ä¸€ä¸ªinodeã€‚è½¯é“¾æ¥inodeå¼•ç”¨æ–‡ä»¶inodeï¼Œå®ƒæŒ‡å‘æ–‡ä»¶å­˜å‚¨ä¸­çš„æ•°æ®ã€‚äºä¸€ä¸ªç¡¬é“¾æ¥ï¼Œæ–‡ä»¶å’Œç¡¬é“¾æ¥éƒ½æŒ‡å‘æ–‡ä»¶inodeï¼ŒæŒ‡å‘æ–‡ä»¶å­˜å‚¨ä¸­çš„æ•°æ®ã€‚</p>

<p>ç¡¬é“¾æ¥æ¯”è½¯é“¾æ¥æ›´æœ‰é™åˆ¶ï¼š</p>

<ul>
  <li>é“¾æ¥çš„ç›®æ ‡å¿…é¡»å­˜åœ¨ã€‚</li>
  <li>ç›®å½•ä¸­é€šå¸¸ä¸å…è®¸ç¡¬é“¾æ¥ã€‚</li>
  <li>ç¡¬é“¾æ¥ä¸å…è®¸è·¨åˆ†åŒºæˆ–å·ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒä»¬ä¸èƒ½è·¨æ–‡ä»¶ç³»ç»Ÿå­˜åœ¨ã€‚</li>
  <li>ä¸€ä¸ªç¡¬é“¾æ¥çœ‹èµ·æ¥å’Œè¡Œä¸ºå°±åƒä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶ï¼Œæ‰€ä»¥å¾ˆéš¾æ‰¾åˆ°ã€‚</li>
</ul>

<p>Filesç±»æä¾›Path createLink(Path link, Path existing)æ–¹æ³•åˆ›å»ºç¡¬é“¾æ¥ã€‚</p>

<p>Listing 12-43 presents the source code to an application that demonstrates
hard link creation.</p>

<p><strong><em>Listing 12-43. Creating a Hard Link</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Files</span><span class="o">.</span><span class="na">createLink</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]),</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]));</span>
</code></pre></div></div>

<h5 id="walking-the-file-tree">Walking the File Tree</h5>

<p>Filesç±»çš„copy(), move(), and delete()ä¸èƒ½å¤„ç†å¤šä¸ªå¯¹è±¡ã€‚å½“ç»“åˆ NIO.2â€™s File Tree-Walking APIï¼Œå¯ä»¥å¤„ç†å±‚çº§æ–‡ä»¶ã€‚</p>

<h6 id="exploring-the-file-tree-walking-api">Exploring the File Tree-Walking API</h6>

<p>File Tree-Walking APIèƒ½è®©ä½ walk a file treeå’Œè®¿é—®å®ƒçš„æ‰€æœ‰æ–‡ä»¶ (regular files, directories, and links)ã€‚é™¤äº†æä¾›æ‰§è¡Œwalkçš„ç§æœ‰å®ç°ï¼Œä¹Ÿç»™åº”ç”¨æä¾›äº†publicæ¥å£ã€‚</p>

<p>publicæ¥å£çš„ä¸­å¿ƒæ˜¯<code class="language-plaintext highlighter-rouge">java.nio.file.FileVisitor&lt;T&gt;</code>ï¼Œè¢«æè¿°ä¸ºä¸€ä¸ª<em>visitor</em>ã€‚åœ¨walkæ—¶ï¼ŒFile Tree-Walkingçš„å®ç°è°ƒç”¨æ¥å£çš„æ–¹æ³•é€šçŸ¥visitoré‡åˆ°äº†æ–‡ä»¶å’Œæä¾›å…¶ä»–é€šçŸ¥ï¼š</p>

<ul>
  <li>FileVisitResult postVisitDirectory(T dir, IOException ioe)</li>
  <li>FileVisitResult preVisitDirectory(T dir, BasicFileAttributes attrs)</li>
  <li>FileVisitResult visitFile(T file, BasicFileAttributes attrs)</li>
  <li>FileVisitResult visitFileFailed(T file, IOException ioe)</li>
</ul>

<p>æ¯ä¸ªæ–¹æ³•å¸¦æœ‰åº”ç”¨ä»£ç å¯ä»¥æŸ¥è¯¢çš„å‚æ•°è¢«è°ƒç”¨ã€‚å½“æ–¹æ³•å®Œæˆï¼Œè¿”å›å£°æ˜åœ¨java.nio.file.FileVisitResultæšä¸¾ç±»å‹ä¹‹ä¸€ï¼š</p>

<ul>
  <li>CONTINUE: ç»§ç»­walkã€‚å½“ä»preVisitDirectory()è¿”å›ï¼Œè¡¨æ˜æ–‡ä»¶å¤¹çš„ç›®å½•ä¹Ÿè¦è¢«è®¿é—®ã€‚</li>
  <li>SKIP_SIBLINGS:ç»§ç»­ï¼Œä¸è®¿é—®æ–‡ä»¶çš„å…„å¼Ÿå§å¦¹ã€‚å¦‚æœä»preVisitDirectory()è¿”å›ï¼Œæ–‡ä»¶å¤¹çš„ç›®å½•ä¹Ÿè¢«è·³è¿‡ï¼Œ postVisitDirectory() ä¸è¢«è°ƒç”¨ã€‚</li>
  <li>SKIP_SUBTREE:ä¸è®¿é—®æ–‡ä»¶å¤¹çš„ç›®å½•ï¼Œç»§ç»­ã€‚åªä» preVisitDirectory()è¿”å›æ‰æœ‰ç”¨ã€‚å¦åˆ™å’Œ CONTINUEä¸€æ ·ã€‚</li>
  <li>TERMINATE:ç»ˆç»“walkã€‚</li>
</ul>

<p>FileVisitResult postVisitDirectory(T dir, IOException ioe)ç”¨äºç›®å½•dirè°ƒç”¨ï¼Œåœ¨æ–‡ä»¶å¤¹çš„ç›®å½•å’Œæ‰€æœ‰å­èŠ‚ç‚¹è¢«è®¿é—®åã€‚å½“ç›®å½•è¿­ä»£æå‰å®Œæˆï¼Œä¹Ÿä¼šè¢«è°ƒç”¨ï¼ˆé€šè¿‡ visitFile()è¿”å› SKIP_SIBLINGSæˆ–éå†ç›®å½•çš„I/Oé”™è¯¯ï¼‰ã€‚å½“æ–‡ä»¶å¤¹è¿­ä»£æ— é”™è¯¯å®Œæˆï¼Œioeä¸ºnullï¼›å¦åˆ™æ˜¯å¼‚å¸¸ã€‚</p>

<p>FileVisitResult preVisitDirectory(T dir, BasicFileAttributes attrs)ç”¨äºæ–‡ä»¶å¤¹dirè°ƒç”¨ï¼Œåœ¨æ–‡ä»¶å¤¹çš„ç›®å½•è¢«è®¿é—®ä¹‹å‰ã€‚å¦‚æœè¿”å›CONTINUEï¼Œæ–‡ä»¶å¤¹çš„ç›®å½•è¢«è®¿é—®ã€‚å¦‚æœè¿”å› SKIP_SUBTREE or SKIP_SIBLINGSï¼Œæ–‡ä»¶å¤¹é‡Œçš„ç›®å½•æˆ–è€…å­èŠ‚ç‚¹ä¸ä¼šè®¿é—®ã€‚å¯¹äºSKIP_SIBLINGSï¼ŒpostVisitDirectory()ä¸è¢«è°ƒç”¨ã€‚ä¼ ç»™attrsçš„å€¼è¡¨æ˜äº†æ–‡ä»¶å¤¹çš„åŸºç¡€å±æ€§ã€‚</p>

<p>FileVisitResult visitFile(T file, BasicFileAttributes attrs)ç”¨äºæ–‡ä»¶å¤¹é‡Œé¢çš„éæ–‡ä»¶å¤¹æ–‡ä»¶è°ƒç”¨ã€‚attrsä»£è¡¨æ–‡ä»¶åŸºç¡€å±æ€§ã€‚</p>

<p>FileVisitResult visitFileFailed(T file, IOException ioe)ç”¨äºä¸èƒ½è¢«è®¿é—®æ–‡ä»¶çš„è°ƒç”¨ï¼Œå› ä¸ºå±æ€§ä¸èƒ½è¢«è¯»å–ï¼Œæ˜¯æ–‡ä»¶å¤¹ä¸èƒ½æ‰“å¼€ï¼Œæˆ–è€…å…¶ä»–çš„åŸå› ã€‚ioeä»£è¡¨é˜»æ­¢è®¿é—®fileçš„å¼‚å¸¸ã€‚</p>

<p>Each method throws IOException when an I/O error occurs.</p>

<p><code class="language-plaintext highlighter-rouge">java.nio.file.SimpleFileVisitor&lt;T&gt;</code>ç±»å®ç°äº†æ‰€æœ‰4ä¸ªæ–¹æ³•ï¼Œæä¾›è®¿é—®æ‰€æœ‰æ–‡ä»¶å’Œé‡æ–°æŠ›å‡ºi/oé”™è¯¯çš„é»˜è®¤è¡Œä¸ºã€‚é™¤äº†visitFileFailed()æ¯ä¸ªæ–¹æ³•è¿”å› CONTINUEï¼›visitFileFailed()é‡æ–°æŠ›å‡ºå¯¼è‡´æ— æ³•è®¿é—®çš„å¼‚å¸¸ã€‚</p>

<p>SimpleFileVisitorå£°æ˜äº†protectedæ„é€ å™¨ï¼Œä¸èƒ½ç›´æ¥å®ä¾‹åŒ–ã€‚å¿…é¡»ç»§æ‰¿SimpleFileVisitorï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">DoNothingVisitor</span> <span class="kd">extends</span> <span class="nc">SimpleFileVisitor</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å®ç°visitorç±»åï¼Œä¼ é€’è¿™ä¸ªç±»çš„å®ä¾‹å’Œä¸€ä¸ªPathå¯¹è±¡åˆ°ä¸‹é¢çš„æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Path</span> <span class="nf">walkFileTree</span><span class="o">(</span><span class="nc">Path</span> <span class="n">start</span><span class="o">,</span> <span class="nc">FileVisitor</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Path</span><span class="o">&gt;</span> <span class="n">visitor</span><span class="o">)</span>

</code></pre></div></div>

<p>æ–¹æ³•å¯åŠ¨ä¸€ä¸ªæ•´ä¸ªrootä¸ºstartçš„file treeçš„depth-firstçš„walkã€‚éœ€è¦æ—¶è°ƒç”¨visitorçš„æ–¹æ³•ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªæŠ›å¼‚å¸¸ï¼ŒwalkFileTree()ä¹ŸæŠ›å¼‚å¸¸ã€‚ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†ä»å½“å‰ç›®å½•å¼€å§‹çš„walkï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Files</span><span class="o">.</span><span class="na">walkFileTree</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"."</span><span class="o">),</span> <span class="k">new</span> <span class="nc">DoNothingVisitor</span><span class="o">());</span>
</code></pre></div></div>

<p>Donâ€™t expect to see any output. Instead, you will need to codify the visitor
methods to generate output. This task is demonstrated in Listing 12-44.</p>

<p><strong><em>Listing 12-44. Visiting a File Tree and Reporting Last Modified Times and Sizes</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.BasicFileAttributes</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-11 17:29
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileWalkDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">walkFileTree</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D:/bin"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">DoNothingFileVisitor</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DoNothingFileVisitor</span> <span class="kd">extends</span> <span class="nc">SimpleFileVisitor</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="cm">/**
         * Initializes a new instance of this class.
         */</span>
        <span class="kd">protected</span> <span class="nf">DoNothingFileVisitor</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Invoked for a directory before entries in the directory are visited.
         *
         * &lt;p&gt; Unless overridden, this method returns {@link FileVisitResult#CONTINUE
         * CONTINUE}.
         *
         * @param dir
         * @param attrs
         */</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">preVisitDirectory</span><span class="o">(</span><span class="nc">Path</span> <span class="n">dir</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"preVisitDirectory: %s%n"</span><span class="o">,</span> <span class="n">dir</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">" lastModifiedTime: %s%n"</span><span class="o">,</span>
                    <span class="n">attrs</span><span class="o">.</span><span class="na">lastModifiedTime</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">" size: %d%n%n"</span><span class="o">,</span> <span class="n">attrs</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">preVisitDirectory</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Invoked for a file in a directory.
         *
         * &lt;p&gt; Unless overridden, this method returns {@link FileVisitResult#CONTINUE
         * CONTINUE}.
         *
         * @param file
         * @param attrs
         */</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">visitFile</span><span class="o">(</span><span class="nc">Path</span> <span class="n">file</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"visitFile: %s%n%n"</span><span class="o">,</span> <span class="n">file</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">" lastModifiedTime: %s%n"</span><span class="o">,</span>
                    <span class="n">attrs</span><span class="o">.</span><span class="na">lastModifiedTime</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">" size: %d%n%n"</span><span class="o">,</span> <span class="n">attrs</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">visitFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Invoked for a file that could not be visited.
         *
         * &lt;p&gt; Unless overridden, this method re-throws the I/O exception that prevented
         * the file from being visited.
         *
         * @param file
         * @param exc
         */</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">visitFileFailed</span><span class="o">(</span><span class="nc">Path</span> <span class="n">file</span><span class="o">,</span> <span class="nc">IOException</span> <span class="n">exc</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"visitFileFailed: %s %s%n%n"</span><span class="o">,</span> <span class="n">file</span><span class="o">,</span> <span class="n">exc</span><span class="o">);</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">visitFileFailed</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">exc</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Invoked for a directory after entries in the directory, and all of their
         * descendants, have been visited.
         *
         * &lt;p&gt; Unless overridden, this method returns {@link FileVisitResult#CONTINUE
         * CONTINUE} if the directory iteration completes without an I/O exception;
         * otherwise this method re-throws the I/O exception that caused the iteration
         * of the directory to terminate prematurely.
         *
         * @param dir
         * @param exc
         */</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">postVisitDirectory</span><span class="o">(</span><span class="nc">Path</span> <span class="n">dir</span><span class="o">,</span> <span class="nc">IOException</span> <span class="n">exc</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"postVisitDirectory: %s %s%n%n"</span><span class="o">,</span> <span class="n">dir</span><span class="o">,</span> <span class="n">exc</span><span class="o">);</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">postVisitDirectory</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="n">exc</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>walkFileTree(Path start, FileVisitor visitor)æ–¹æ³•æ˜¯ä¸‹é¢æ–¹æ³•çš„å¿«æ·æ–¹å¼ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Path</span> <span class="nf">walkFileTree</span><span class="o">(</span><span class="nc">Path</span> <span class="n">start</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">FileVisitOption</span><span class="o">&gt;</span> <span class="n">options</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxDepth</span><span class="o">,</span>
 <span class="nc">FileVisitor</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Path</span><span class="o">&gt;</span> <span class="n">visitor</span><span class="o">)</span>
</code></pre></div></div>

<p>ä¸ä»…éœ€è¦pathå’Œvisitorï¼Œä¹Ÿè¦optionså’Œintã€‚FileVisitOptionæ˜¯å£°æ˜æ–‡ä»¶è®¿é—®é€‰é¡¹å¸¸æ•°çš„æšä¸¾ã€‚å½“å‰ä»…æ”¯æŒçš„é€‰é¡¹æ˜¯FOLLOW_LINKSï¼ˆfollow symbolic linksï¼‰ã€‚intä»£è¡¨çš„æ˜¯walkçš„æœ€å¤§æ–‡ä»¶å¤¹å±‚çº§ã€‚Integer.MAX_VALUEè¡¨æ˜walkåˆ°åº•ã€‚</p>

<p>å¦‚æœoptionså‚æ•°æœ‰ FOLLOW_LINKS option,æ–¹æ³•è·Ÿè¸ªè®¿é—®çš„æ–‡ä»¶å¤¹ï¼Œå› æ­¤å¯ä»¥æ£€æµ‹cycleã€‚cycleå‡ºç°åœ¨æ–‡ä»¶å¤¹çš„å…¥å£æ˜¯æ–‡ä»¶å¤¹çš„ç¥–å…ˆã€‚Cycleæ£€æµ‹æ˜¯é€šè¿‡è®°å½•æ–‡ä»¶å¤¹çš„keysæ‰§è¡Œçš„ï¼Œæˆ–è€…å½“keysä¸å¯ç”¨æ—¶ï¼Œè°ƒç”¨ isSameFile()æ¥æµ‹è¯•æ˜¯å¦æ˜¯ç¥–å…ˆæ–‡ä»¶ã€‚å½“æ£€æµ‹åˆ°cycleï¼Œè¢«è®¤ä¸ºæ˜¯ I/O errorï¼Œ visitFileFailed()è¢«è°ƒç”¨ï¼Œå¸¦æœ‰java.nio.file.FileSystemLoopExceptionå‚æ•°ã€‚</p>

<p>The former walkFileTree() method invokes this walkFileTree() method as follows (it doesnâ€™t follow symbolic links and visits all levels of the file tree):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">walkFileTree</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="nc">EnumSet</span><span class="o">.</span><span class="na">noneOf</span><span class="o">(</span><span class="nc">FileVisitOption</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
 <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">visitor</span><span class="o">)</span>
</code></pre></div></div>

<h6 id="copying-a-file-tree">Copying a File Tree</h6>

<p>The File Tree-Walking API can be used to copy a file tree. Listing 12-45 presents the source code to an application that accomplishes this task.</p>

<p><strong><em>Listing 12-45. Copying a File Tree</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.BasicFileAttributes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.EnumSet</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-11 18:00
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CopyFileTreeDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">source</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D:/Bin"</span><span class="o">);</span>
        <span class="nc">Path</span> <span class="n">target</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D:/BinCp"</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(!</span><span class="nc">Files</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">source</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%s source path doesn't exist%n"</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="nc">Files</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">(</span><span class="n">source</span><span class="o">))</span> <span class="c1">// Is source a nondirectory?</span>
        <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Files</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">target</span><span class="o">))</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Files</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">(</span><span class="n">target</span><span class="o">))</span> <span class="c1">// Is target a directory?</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">getFileName</span><span class="o">());</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="nc">StandardCopyOption</span><span class="o">.</span><span class="na">REPLACE_EXISTING</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"I/O error: %s%n"</span><span class="o">,</span> <span class="n">ioe</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Files</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">target</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Files</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">(</span><span class="n">target</span><span class="o">))</span> <span class="c1">// Is target an existing  file?</span>
        <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%s is not a directory%n"</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">EnumSet</span><span class="o">&lt;</span><span class="nc">FileVisitOption</span><span class="o">&gt;</span> <span class="n">options</span>
                <span class="o">=</span> <span class="nc">EnumSet</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">FileVisitOption</span><span class="o">.</span><span class="na">FOLLOW_LINKS</span><span class="o">);</span>
        <span class="nc">CopyVisitor</span> <span class="n">copier</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyVisitor</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">walkFileTree</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">copier</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CopyVisitor</span> <span class="kd">extends</span> <span class="nc">SimpleFileVisitor</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Path</span> <span class="n">fromPath</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">Path</span> <span class="n">toPath</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nc">StandardCopyOption</span> <span class="n">copyOption</span> <span class="o">=</span> <span class="nc">StandardCopyOption</span><span class="o">.</span><span class="na">REPLACE_EXISTING</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">CopyVisitor</span><span class="o">(</span><span class="nc">Path</span> <span class="n">fromPath</span><span class="o">,</span> <span class="nc">Path</span> <span class="n">toPath</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">fromPath</span> <span class="o">=</span> <span class="n">fromPath</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">toPath</span> <span class="o">=</span> <span class="n">toPath</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">preVisitDirectory</span><span class="o">(</span><span class="nc">Path</span> <span class="n">dir</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"dir = "</span> <span class="o">+</span> <span class="n">dir</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"fromPath = "</span> <span class="o">+</span> <span class="n">fromPath</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"toPath = "</span> <span class="o">+</span> <span class="n">toPath</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"fromPath.relativize(dir) = "</span> <span class="o">+</span>
                    <span class="n">fromPath</span><span class="o">.</span><span class="na">relativize</span><span class="o">(</span><span class="n">dir</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"toPath.resolve(fromPath.relativize(dir)) = "</span> <span class="o">+</span>
                    <span class="n">toPath</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">fromPath</span><span class="o">.</span><span class="na">relativize</span><span class="o">(</span><span class="n">dir</span><span class="o">)));</span>
            <span class="nc">Path</span> <span class="n">targetPath</span> <span class="o">=</span> <span class="n">toPath</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">fromPath</span><span class="o">.</span><span class="na">relativize</span><span class="o">(</span><span class="n">dir</span><span class="o">));</span>
            <span class="k">if</span> <span class="o">(!</span><span class="nc">Files</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">targetPath</span><span class="o">))</span>
                <span class="nc">Files</span><span class="o">.</span><span class="na">createDirectory</span><span class="o">(</span><span class="n">targetPath</span><span class="o">);</span>
            <span class="k">return</span> <span class="nc">FileVisitResult</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">visitFile</span><span class="o">(</span><span class="nc">Path</span> <span class="n">file</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"file = "</span> <span class="o">+</span> <span class="n">file</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"fromPath = "</span> <span class="o">+</span> <span class="n">fromPath</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"toPath = "</span> <span class="o">+</span> <span class="n">toPath</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"fromPath.relativize(file) = "</span> <span class="o">+</span>
                    <span class="n">fromPath</span><span class="o">.</span><span class="na">relativize</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"toPath.resolve(fromPath.relativize(file)) = "</span> <span class="o">+</span>
                    <span class="n">toPath</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">fromPath</span><span class="o">.</span><span class="na">relativize</span><span class="o">(</span><span class="n">file</span><span class="o">)));</span>
            <span class="nc">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">toPath</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">fromPath</span><span class="o">.</span><span class="na">relativize</span><span class="o">(</span><span class="n">file</span><span class="o">)),</span>
                    <span class="n">copyOption</span><span class="o">);</span>
            <span class="k">return</span> <span class="nc">FileVisitResult</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">visitFileFailed</span><span class="o">(</span><span class="nc">Path</span> <span class="n">file</span><span class="o">,</span> <span class="nc">IOException</span> <span class="n">exc</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">exc</span><span class="o">);</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">visitFileFailed</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">exc</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h6 id="deleting-a-file-tree">Deleting a File Tree</h6>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.BasicFileAttributes</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-12 17:14
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeletingFileTreeDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">walkFileTree</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D:/BinCp"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">DeleteVisitor</span><span class="o">());</span>

    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DeleteVisitor</span> <span class="kd">extends</span> <span class="nc">SimpleFileVisitor</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">visitFile</span><span class="o">(</span><span class="nc">Path</span> <span class="n">file</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">Files</span><span class="o">.</span><span class="na">deleteIfExists</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">visitFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">postVisitDirectory</span><span class="o">(</span><span class="nc">Path</span> <span class="n">dir</span><span class="o">,</span> <span class="nc">IOException</span> <span class="n">exc</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">Files</span><span class="o">.</span><span class="na">deleteIfExists</span><span class="o">(</span><span class="n">dir</span><span class="o">);</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">postVisitDirectory</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="n">exc</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p><strong>Note</strong> Delete is designed to delete symbolic links and not their targets.</p>

<h6 id="moving-a-file-tree">Moving a File Tree</h6>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.attribute.BasicFileAttributes</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-12 17:25
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovingFileTreeDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">walkFileTree</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"F:\\store"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">MoveVisitor</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"F:\\store"</span><span class="o">),</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"F:\\storage"</span><span class="o">)));</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MoveVisitor</span> <span class="kd">extends</span> <span class="nc">SimpleFileVisitor</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Path</span> <span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">MoveVisitor</span><span class="o">(</span><span class="nc">Path</span> <span class="n">from</span><span class="o">,</span> <span class="nc">Path</span> <span class="n">to</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">from</span> <span class="o">=</span> <span class="n">from</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">to</span> <span class="o">=</span> <span class="n">to</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">preVisitDirectory</span><span class="o">(</span><span class="nc">Path</span> <span class="n">dir</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="n">to</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">relativize</span><span class="o">(</span><span class="n">dir</span><span class="o">)));</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">preVisitDirectory</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">visitFile</span><span class="o">(</span><span class="nc">Path</span> <span class="n">file</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">Files</span><span class="o">.</span><span class="na">move</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">to</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">relativize</span><span class="o">(</span><span class="n">file</span><span class="o">)));</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">visitFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">postVisitDirectory</span><span class="o">(</span><span class="nc">Path</span> <span class="n">dir</span><span class="o">,</span> <span class="nc">IOException</span> <span class="n">exc</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">dir</span><span class="o">);</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">postVisitDirectory</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="n">exc</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="working-with-additional-capabilities">Working with Additional Capabilities</h5>

<p>Filesç±»æ–¹æ³•å¤§æ¦‚å…¨äº†ï¼Œè¿˜å‰©ä¸€ç»„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•æ˜¯ç”¨äºJava 8â€™s Streams API and lambda expressionsçš„ã€‚</p>

<ul>
  <li>Stream find(Path start, int maxDepth,BiPredicate matcher,FileVisitOptionâ€¦ options)</li>
  <li>Stream lines(Path path)</li>
  <li>Stream lines(Path path, Charset cs)</li>
  <li>Stream list(Path dir)</li>
  <li>Stream walk(Path start, FileVisitOptionâ€¦options)</li>
  <li>Stream walk(Path start, int maxDepth, FileVisitOptionâ€¦ options)</li>
</ul>

<p>findæ–¹æ³•ã€‚ Listing 12-48 presents the source code to an application that demonstrates find() and BiPredicateã€‚</p>

<p><strong><em>Listing 12-48. Streaming and Outputting the Paths of All Files That Match a File Extension</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Stream</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;</span> <span class="n">pathStream</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"F:/storage"</span><span class="o">),</span> <span class="mi">100</span><span class="o">,</span> <span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">basicFileAttributes</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="s">"logo.jpg"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">()));</span>
        <span class="n">pathStream</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Files</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"C:/"</span><span class="o">)).</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Stream</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">lines</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">lines</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"E:\\bocai/pom.xml"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">lines</span><span class="o">.</span><span class="na">count</span><span class="o">());</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Files</span><span class="o">.</span><span class="na">walk</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D:/Bin"</span><span class="o">),</span> <span class="mi">2</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</code></pre></div></div>

<h4 id="using-path-matchers-and-watch-services">Using Path Matchers and Watch Services</h4>

<p>Fileæ²¡æœ‰æä¾› handle path-matching and watch servicesçš„æ–¹æ³•ï¼Œä½ å¿…é¡»ç”¨ FileSystemæ¥å®Œæˆã€‚</p>

<h5 id="matching-paths">Matching Paths</h5>

<p>æˆ‘ä»¬é€šå¸¸ç”¨pattern matchingæ¥è¿‡æ»¤ï¼Œæ¯”å¦‚ls -l *.html (Unix/Linux) or dir *.htmlã€‚</p>

<p>NIO.2æä¾›java.nio.file.PathMatcheræ¥æ”¯æŒï¼Œä¸€ä¸ªæ–¹æ³•boolean matches(Path path)</p>

<p>FileSystemâ€™s PathMatcher getPathMatcher(String syntaxAndPattern)æ–¹æ³•è¿”å›PathMatcherå¯¹è±¡ï¼Œç”¨patternåŒ¹é…pathï¼Œå½¢å¼æ˜¯syntaxAndPatternï¼Œ <code class="language-plaintext highlighter-rouge">syntax:pattern</code>ã€‚</p>

<p>æ”¯æŒä¸¤ç§patternè¯­è¨€ï¼Œregex and globã€‚ä¾‹å¦‚:<code class="language-plaintext highlighter-rouge">([^\s]+(\.(?i)(png|jpg))$)</code>åŒ¹é…æ‰€æœ‰.png and .jpgæ–‡ä»¶ã€‚</p>

<p>ä¹Ÿå¯ä»¥ç”¨globï¼Œæ¯”regexå±€é™ï¼Œç±»ä¼¼æ­£åˆ™ä½†æ˜¯æ›´ç®€å•ã€‚ä¾‹å¦‚ï¼š<code class="language-plaintext highlighter-rouge">*.java</code>  <code class="language-plaintext highlighter-rouge">*.*</code>  <code class="language-plaintext highlighter-rouge">*.{java,class}</code>  <code class="language-plaintext highlighter-rouge">foo.?</code>  <code class="language-plaintext highlighter-rouge">/home/*/*</code>  <code class="language-plaintext highlighter-rouge">/home/**</code>   <code class="language-plaintext highlighter-rouge">C:\\*</code></p>

<h5 id="watching-directories">Watching Directories</h5>

<p>æ”¹è¿›çš„æ–‡ä»¶ç³»ç»Ÿæ¥å£åŒ…æ‹¬ä¸€ä¸ªç”¨äºç›‘è§†å·²æ³¨å†Œç›®å½•çš„Watch Service API ï¼Œç”¨äºç›‘å¬æ›´æ”¹å’Œäº‹ä»¶ã€‚æ¯”å¦‚ç›‘å¬æ–‡ä»¶å¤¹å†…å®¹æ”¹å˜æ¥æ›´æ–°ç›®å½•ã€‚</p>

<p>Watch Service API åœ¨java.nio.fileåŒ…ç”±ä»¥ä¸‹ç±»å‹ç»„æˆï¼š</p>

<ul>
  <li>Watchable:</li>
  <li>WatchEvent:</li>
  <li>WatchEvent.Kind:</li>
  <li>WatchEvent.Modifier:</li>
  <li>WatchKey:</li>
  <li>WatchService:</li>
  <li>StandardWatchEventKinds:</li>
  <li>ClosedWatchServiceException:</li>
</ul>

<p>â€¦</p>

<p>â€¦</p>

<p><strong><em>Listing 12-51. Watching a Directory for Creations, Deletions, and Modifications</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">file</span><span class="o">.</span><span class="na">StandardWatchEventKinds</span><span class="o">.*;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-13 17:23
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WatchServiceApiDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="nc">FileSystem</span> <span class="n">fileSystem</span> <span class="o">=</span> <span class="nc">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>

            <span class="nc">WatchService</span> <span class="n">watchService</span> <span class="o">=</span> <span class="n">fileSystem</span><span class="o">.</span><span class="na">newWatchService</span><span class="o">();</span>
            <span class="nc">Path</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">fileSystem</span><span class="o">.</span><span class="na">getPath</span><span class="o">(</span><span class="s">"D:/bin"</span><span class="o">);</span>
            <span class="n">dir</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">watchService</span><span class="o">,</span> <span class="no">ENTRY_CREATE</span><span class="o">,</span> <span class="no">ENTRY_DELETE</span><span class="o">,</span> <span class="no">ENTRY_MODIFY</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="nc">WatchKey</span> <span class="n">key</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">watchService</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">WatchEvent</span> <span class="n">event</span> <span class="o">:</span> <span class="n">key</span><span class="o">.</span><span class="na">pollEvents</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">WatchEvent</span><span class="o">.</span><span class="na">Kind</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">kind</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">kind</span> <span class="o">==</span> <span class="no">OVERFLOW</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"overflow"</span><span class="o">);</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="nc">WatchEvent</span> <span class="n">watchEvent</span> <span class="o">=</span> <span class="n">event</span><span class="o">;</span>
                    <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Path</span><span class="o">)</span> <span class="n">watchEvent</span><span class="o">.</span><span class="na">context</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%s: %s%n"</span><span class="o">,</span> <span class="n">watchEvent</span><span class="o">.</span><span class="na">kind</span><span class="o">(),</span> <span class="n">path</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="kt">boolean</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">valid</span><span class="o">)</span>
                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="exercise-5">Exercise</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The following exercises are designed to test your understanding of Chapter 12â€™s content:
1. Define file system and file.
2. The File-based file system interface is problematic. For example,
Fileâ€™s delete() method returns false when it cannot delete a file.
Why is this behavior a problem?
3. Identify the packages that implement the improved file system
interface.
4. Identify the types that form the core of the improved file system
interface.
5. How do you obtain a reference to the default file system?
6. How would you create a new file system?
7. Define path.
8. True or false: The Path interface represents a hierarchical path to a
file that must exist.
9. Describe the element layout of a Path object.
10. What methods do Path and File provide for converting from Path to
File and from File to Path?
11. Identify the FileSystem method that returns a Path object.
12. What happens when you attempt to create a Path object using syntax
that doesnâ€™t conform to the syntax that is parsed by the file system
provider that created the FileSystem responsible for creating the
Path object?
13. Which methods does the Paths class provide for more conveniently
returning Path objects?
14. Identify Pathâ€™s methods for returning its name elements.
15. True or false: Pathâ€™s boolean isRelative() method returns
false to signify an absolute path.
16. How do you obtain a file systemâ€™s root(s)?
17. How do you convert a relative path to an absolute path?
18. Identify Pathâ€™s method for removing path redundancies, creating a
relative path between two paths, and resolving (joining) two paths.
19. How do you resolve a path string against the current pathâ€™s parent path?
20. How do you convert the current Path instance to a URI object?
21. What does the Path toRealPath(LinkOption... options)
method accomplish?
22. True or false: The Files class provides static methods for
performing path-matching and directory-watching tasks.
23. Define file store.
24. What method does the Files class provide for obtaining a file store?
25. What information can you obtain about a file store?
26. How can you access all available file stores for a given file system?
27. What support does NIO.2 offer for working with attributes?
28. How are attributes organized?
29. Describe the attribute type hierarchy.
30. How can you identify all supported attribute views for a given file
system?
31. What are basic attributes? Identify the view for managing basic
attributes and name the basic attributes.
32. True or false: You can read basic attributes in bulk by calling
BasicFileAttributeViewâ€™s BasicFileAttributes
readAttributes() method.
33. Define file key.
34. When you call the Files classâ€™s getAttribute() or
setAttribute() method to get or set a basic or other kind of
attribute value, what syntax must you follow for identifying the
attribute?
35. What do the UserPrincipal and GroupPrincipal interfaces
represent?
36. When would FileOwnerAttributeViewâ€™s setOwner() method
throw FileSystemException on a Windows operating system?
37. The AclEntry class describes an entry in an ACL. Identify its
components.
38. True or false: You can define your own file attributes.
39. Identity the attributes supported by FileStoreAttributeView.
40. True or false: !exists(path) is equivalent to notExists(path).
41. What is the isDirectory() methodâ€™s default policy on
symbolic links?
42. Why should you be careful when using the return values from
exists(), notExists(),isExecutable(), isReadable(), and
isWritable()?
43. What does the createFile() method do when called to create a file
that already exists?
44. Define optional specific exception.
45. How would you set POSIX file permissions when creating a file?
46. In which directory does Path createTempFile(String prefix,
String suffix, FileAttribute&lt;?&gt;... attrs) create a
temporary file?
47. Identify three ways to delete a temporary file before an application exits.
48. Identify NIO.2â€™s three methods for reading all bytes or lines of text from
a regular file into memory.
49. The methods in the previous exercise are great for reading the
contents of small regular files into memory. What methods would you
use to read very large files (whose contents probably donâ€™t fit into
memory)?
50. The newInputStream() method supports a varargs list of open
options. Identify and describe the open options supported by the
StandardOpenOption enum. (Not all of these options apply to
newInputStream().)
51. Identify NIO.2â€™s three methods for writing all bytes or lines of text from
memory to a regular file.
52. The methods in the previous exercise are great for writing the contents
of memory to small regular files. What methods would you use to write
very large amounts of content (which probably doesnâ€™t fit into memory)
to regular files?
53. True or false: When no options are specified, newOutputStream()
works as if the CREATE, TRUNCATE_EXISTING, and WRITE options
are present.
54. What is the purpose of the SeekableByteChannel interface?
55. The FileChannel class implements SeekableByteChannel. Why
does it specify FileChannel position(long newPosition)
and FileChannel truncate(long size) instead of specifying
SeekableByteChannel position(long newPosition) and
SeekableByteChannel truncate(long size)?
56. How do you obtain a SeekableByteChannel object?
57. What did NIO.2 add to the FileChannel class so that you would no
longer have to rely on a classic I/O type (such as RandomAccessFile)
to obtain a file channel?
58. What method does the Files class provide for creating a directory?
59. True or false: The Files classâ€™s directory-creation method
automatically creates nonexistent ancestor directories of the directory
being created.
60. Identify the Files classâ€™s methods for creating temporary directories.
61. What does NIO.2 provide for obtaining a list of a directoryâ€™s entries?
62. How do you filter a list of directory entries so that only desired entries
are returned?
63. What methods does Files provide to copy a file to another file?
64. Two of the copy() methods support a varargs list of copy options.
Identify and describe the copy options supported by the
StandardCopyOption enum.
65. What other copy option can be passed to these copy() methods?
66. What method does Files provide to move a file to another file?
67. What copy options are supported by this file-movement method?
68. Identify the Files methods for deleting files.
69. Define symbolic link and circular reference.
70. Identify the Files method for creating a symbolic link to a target.
71. How do you determine if an arbitrary path represents a symbolic link?
72. How do you read the target of a symbolic link?
73. Define hard link.
74. In what ways are hard links more restrictive than soft links?
75. Identify the Files method for creating a hard link for an existing file.
76. Describe the File Tree-Walking API.
77. Identify the types that comprise the public portion of the File
Tree-Walking API.
78. True or false: SKIP_SUBTREE is only meaningful when returned from
the preVisitDirectory() method; otherwise, this result type is the
same as CONTINUE.
79. What methods does the Files class provide for walking the file tree?
80. What does the Stream&lt;Path&gt; find(Path start, int
maxDepth, BiPredicate&lt;Path,BasicFileAttributes&gt;
matcher, FileVisitOption... options) method accomplish?
81. How does NIO.2 support path-matching?
82. What is the purpose of the Watch Service API?
83. Identify and describe the types that comprise the Watch Service API.
84. Exercise 22 in Chapter 2 asked you to create a Touch application.
Rewrite this application to use NIO.2 types.

</code></pre></div></div>

<h4 id="summary-11">Summary</h4>

<p>NIO.2 improves the file system interface that was previously limited to the
File class. The improved file system interface features methods throwing
exceptions, support for symbolic links, broad and efficient support for file
attributes, directory streams, support for alternative file systems via custom
file system providers, support for file copying and file moving, support for
walking the file tree/visiting files and watching directories, and more.
The improved file system interface is implemented mainly by the various types
in the java.nio.file, java.nio.file.attribute, and java.nio.file.spi
packages. FileSystem, FileSystems, and FileSystemProvider form the core
of the improved file system interface.</p>

<h3 id="chapter-13-asynchronous-io">Chapter 13 Asynchronous I/O</h3>

<p>NIOæä¾›äº†multiplexed I/O(éé˜»å¡I/Oå’Œreadiness selectionçš„ç»„åˆï¼Œå‰7ç« è®¨è®ºå8ç« è®¨è®º)è®©é«˜å¯ä¼¸ç¼©æœåŠ¡å™¨çš„åˆ›å»ºæ›´å®¹æ˜“ã€‚å®¢æˆ·ç«¯ä»£ç ç”¨ä¸€ä¸ªselectoræ³¨å†Œä¸€ä¸ªsocket channel,å½“channelå‡†å¤‡å¼€å§‹I/Oæ—¶ï¼Œä¼šé€šçŸ¥å®ƒã€‚</p>

<p>NIO.2æä¾›äº† asynchronous I/Oï¼Œè®©å®¢æˆ·ç«¯å¯åŠ¨ä¸€ä¸ªI/Oæ“ä½œç„¶åå½“æ“ä½œå®Œæˆæ—¶é€šçŸ¥å®¢æˆ·ç«¯ã€‚ç±»ä¼¼äºmultiplexed I/Oï¼Œasynchronous I/Oä¹Ÿé€šå¸¸ç”¨äºä¿ƒè¿›é«˜å¯ä¼¸ç¼©æœåŠ¡å™¨çš„åˆ›å»ºã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šMultiplexed I/Oé€šå¸¸ç”¨äºæä¾›é«˜åº¦å¯ä¼¸ç¼©å’Œé«˜æ€§èƒ½çš„è½®è¯¢æ¥å£çš„æ“ä½œç³»ç»Ÿå¦‚Linux and Solarisã€‚Asynchronous I/Oé€šå¸¸ç”¨äºæä¾›é«˜åº¦å¯ä¼¸ç¼©å’Œé«˜æ€§èƒ½çš„å¼‚æ­¥I/Oè®¾å¤‡â€”â€”æ¯”å¦‚newer Windows operating systemsã€‚</p>

<p>æœ¬ç« é¦–å…ˆä»‹ç»äº†å¼‚æ­¥è¾“å…¥è¾“å‡ºçš„æ¦‚è¿°ã€‚ç„¶åæ¢ç´¢asynchronous file channels, socket channels, and channel groupsã€‚</p>

<h4 id="asynchronous-io-overview">Asynchronous I/O Overview</h4>

<p>java.nio.channels.AsynchronousChannelæ¥å£æè¿°äº†asynchronous channelï¼Œæ˜¯ä¸€ä¸ªæ”¯æŒå¼‚æ­¥I/Oæ“ä½œçš„ï¼ˆè¯»å†™ç­‰ç­‰ï¼‰channelã€‚è°ƒç”¨ä¸€ä¸ªè¿”å›futureæˆ–è€…éœ€è¦completion handlerå‚æ•°çš„æ–¹æ³•æ¥å¯åŠ¨I/Oæ“ä½œï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Future&lt;V&gt; operation(...)</code>:  Væ˜¯æ“ä½œç»“æœã€‚Futureæ–¹æ³•å¯ä»¥è¢«è°ƒç”¨å»æ£€æŸ¥i/oæ˜¯å¦å®Œæˆï¼Œç­‰å¾…å®Œæˆå’Œæ¥æ”¶ç»“æœã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">void operation(... A attachment, CompletionHandler handler):</code>è°ƒç”¨operationï¼Œå¸¦æœ‰å‚æ•°attachmentï¼ˆä¸€ä¸ªè¿æ¥åˆ°i/oæ“ä½œçš„å¯¹è±¡å½“æ¶ˆè´¹ç»“æœæ—¶æä¾›contextï¼‰å’Œå‚æ•°handleræ˜¯<code class="language-plaintext highlighter-rouge">java.nio.channels.CompletionHandler&lt;V, A&gt;</code>æ¥å£çš„å®ä¾‹ã€‚Aæ˜¯attachmentï¼ŒVæ˜¯i/oæ“ä½œçš„ç»“æœã€‚attachmentå¯¹ç”¨æ— çŠ¶æ€CompletionHandlerå¯¹è±¡æ¶ˆè€—å¤§é‡i/oæ“ä½œçš„ç»“æœçš„æƒ…å†µå¾ˆé‡è¦ã€‚å½“i/oæ“ä½œå®Œæˆæˆ–å¤±è´¥ï¼Œhandlerè¢«è°ƒç”¨æ¥æ¶ˆè´¹æ“ä½œçš„ç»“æœã€‚</li>
</ul>

<p>CompletionHandlerå£°æ˜ä¸‹é¢çš„æ–¹æ³•æ¶ˆè´¹æ“ä½œæˆåŠŸå®Œæˆçš„resultï¼Œå¹¶ä¸”å¾—çŸ¥æ“ä½œå¤±è´¥åŸå› å’Œé‡‡å–é€‚å½“åŠ¨ä½œï¼š</p>

<ul>
  <li>void completed(V result, A attachment): å½“æ“ä½œæˆåŠŸå®Œæˆè¢«è°ƒç”¨ã€‚æ“ä½œçš„ç»“æœæ˜¯resultã€‚attachmentæ˜¯æ“ä½œå¯åŠ¨æ—¶è¿æ¥åˆ°æ“ä½œçš„å¯¹è±¡ã€‚</li>
  <li>void failed(Throwable t, A attachment): å½“æ“ä½œå¤±è´¥è¢«è°ƒç”¨ã€‚tæ˜¯æ“ä½œå¤±è´¥åŸå› ã€‚attachmentæ˜¯..</li>
</ul>

<p>è¢«è°ƒç”¨åï¼Œæ–¹æ³•ç«‹å³è¿”å›ã€‚ç„¶åä½ è°ƒç”¨Futureæ–¹æ³•æˆ–è€…åœ¨CompletionHandlerå®ç°é‡Œæä¾›äº†è§£æ›´å¤ši/oæ“ä½œçŠ¶æ€æˆ–æ‰§è¡Œæ“ä½œç»“æœçš„ä»£ç ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                               CANCELLATION
</code></pre></div></div>

<p>Futureå£°æ˜äº†boolean cancel(boolean mayInterruptIfRunning)æ–¹æ³•æ¥å–æ¶ˆæ‰§è¡Œã€‚è¿™ä¸ªæ–¹æ³•å¯¼è‡´æ‰€æœ‰ç­‰å¾…i/oæ“ä½œç»“æœçš„çº¿ç¨‹æŠ›å‡º<code class="language-plaintext highlighter-rouge">java.util.concurrent.CancellationException</code>ã€‚åº•å±‚I / Oæ“ä½œæ˜¯å¦è¢«å–æ¶ˆæ˜¯é«˜åº¦ç‰¹å®šäºå®ç°çš„ï¼Œå› æ­¤æ²¡è¯¦ç»†è¯´æ˜ã€‚å¦‚æœå–æ¶ˆè®©è¿æ¥çš„channelæˆ–è€…å®ä½“å¤„äºä¸ä¸€è‡´çŠ¶æ€ï¼Œchannelè¢«æ”¾å…¥ä¸€ä¸ªç‰¹å®šäºå®ç°çš„error stateï¼Œé˜»æ­¢å†æ¬¡å°è¯•å‘èµ·ä¸è¢«å–æ¶ˆæ“ä½œç±»ä¼¼çš„i/oæ“ä½œã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œè¢«å–æ¶ˆäº†ï¼Œä½†æ˜¯å®ç°ä¸èƒ½ä¿è¯å­—èŠ‚æ²¡æœ‰ä»é€šé“è¯»å–ï¼Œå®ƒå°†åœ¨é€šé“æ”¾å…¥é”™è¯¯error stateã€‚å†æ¬¡å°è¯•ä¼šå¯¼è‡´æœªæŒ‡å®šçš„è¿è¡Œæ—¶å¼‚å¸¸è¢«æŠ›å‡ºã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œè¢«å–æ¶ˆäº†ï¼Œä½†æ˜¯å®ç°ä¸èƒ½ä¿è¯å­—èŠ‚æ²¡æœ‰è¢«å†™å…¥é€šé“ï¼Œé‚£ä¹ˆå¯åŠ¨ä¸€ä¸ªæ“ä½œçš„åç»­å°è¯•å°†ä¼šä»¥ä¸€ä¸ªæœªæŒ‡æ˜çš„è¿è¡Œæ—¶å¼‚å¸¸å¤±è´¥ã€‚</p>

<p>å¦‚æœ cancel()çš„å‚æ•°mayInterruptIfRunningæ˜¯trueï¼Œi/oæ“ä½œå¯èƒ½é€šè¿‡å…³é—­channelè¢«æ‰“æ–­ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ç­‰å¾…i/oæ“ä½œçš„çº¿ç¨‹å¯¼è‡´æŠ›å‡º CancellationExceptionï¼Œè¿™ä¸ªchannelä¸Šçš„å…¶ä»–i/oæ“ä½œæŠ›å‡º java.nio.channels.AsynchronousCloseExceptionå®Œæˆã€‚</p>

<p>å½“ cancel()è¢«è°ƒç”¨äºå–æ¶ˆè¯»å†™ï¼Œæ¨èæ“ä½œç”¨çš„æ‰€æœ‰buffersè¢«discardedï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿åœ¨é€šé“ä¿æŒæ‰“å¼€çŠ¶æ€æ—¶ä¸ä¼šè®¿é—®bufferã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>______________________________________________________________________________
</code></pre></div></div>

<p>AsynchronousChannelç»§æ‰¿java.nio.channels.Channelæ¥å£ï¼Œç»§æ‰¿äº†isOpen() and close()ã€‚ close()æ–¹æ³•è¦éµå¾ªä¸‹é¢çš„é™„åŠ è§„å®šï¼šè¿™ä¸ªé€šé“ä¸Šçš„ä»»ä½•æœªå®Œæˆçš„å¼‚æ­¥æ“ä½œéƒ½å°†æŠ›å‡ºAsynchronousCloseException objectså®Œæˆã€‚channelå…³é—­åï¼Œå¯åŠ¨i/oå¼‚æ­¥çš„å°è¯•ä¼šç«‹åˆ»å¯¼è‡´java.nio.channels.ClosedChannelExceptionã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šAsynchronous channelså¯¹å¤šçº¿ç¨‹æ˜¯å®‰å…¨çš„ã€‚ä¸€äº›channelå®ç°å¯èƒ½æ”¯æŒå¹¶å‘è¯»å†™ï¼Œä½†åœ¨ä»»ä½•ç»™å®šçš„æ—¶é—´ï¼Œå¯èƒ½ä¸å…è®¸è¶…è¿‡ä¸€ä¸ªçº¿ç¨‹è¯»å’Œä¸€ä¸ªçº¿ç¨‹å†™ã€‚</p>

<p>java.nio.channels.AsynchronousByteChannelç»§æ‰¿AsynchronousChannelã€‚æœ‰4ä¸ªæ–¹æ³•ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Future&lt;Integer&gt; read(ByteBuffer dst): </code>ä»è¿™ä¸ªé€šé“è¯»å–ä¸€ä¸ªå­—èŠ‚åºåˆ—åˆ°byte bufferã€‚è¿”å›Futureå½“å¯ç”¨æ—¶è®¿é—®å­—èŠ‚ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge"> &lt;A&gt; void read(ByteBuffer dst, A attachment, CompletionHandler&lt;Integer,? super A&gt; handler): </code></li>
  <li><code class="language-plaintext highlighter-rouge">Future&lt;Integer&gt; write(ByteBuffer src)</code>:ä»byte bufferå†™å­—èŠ‚åºåˆ—åˆ°channelã€‚è¿”å›Futureã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;A&gt; void write(ByteBuffer src, A attachment, CompletionHandler&lt;Integer,? super A&gt; handler):</code></li>
</ul>

<p>read()æŠ›å‡ºjava.nio.channels.ReadPendingExceptionï¼Œå½“å‰ä¸€ä¸ªè¯»æœªå®Œæˆä¸”ä¸å…è®¸è¶…è¿‡ä¸€ä¸ªçº¿ç¨‹è¯»ã€‚writeæŠ›å‡º java.nio.channels.WritePendingExceptionã€‚</p>

<p><strong>è­¦å‘Š</strong>ï¼šjava.nio.ByteBufferä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å½“è¯»æˆ–å†™å¯åŠ¨ï¼Œæ³¨æ„å¿…é¡»ä¿è¯æ“ä½œç»“æŸå‰bufferä¸è¢«è®¿é—®ã€‚</p>

<h4 id="asynchronous-file-channels">Asynchronous File Channels</h4>

<p>æŠ½è±¡java.nio.channels.AsynchronousFileChannelç±»æè¿°äº†ä¸€ä¸ª asynchronous channelç”¨äºè¯»å†™æ“ä½œæ–‡ä»¶ã€‚è°ƒç”¨ä¸‹é¢æ–¹æ³•åˆ›å»ºAsynchronousFileChannelâ€™s open()ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AsynchronousFileChannel</span> <span class="n">ch</span><span class="o">;</span>
<span class="n">ch</span> <span class="o">=</span> <span class="nc">AsynchronousFileChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"somefile"</span><span class="o">));</span>
</code></pre></div></div>

<p>è¯¥æ–‡ä»¶åŒ…å«ä¸€ä¸ªå¯å˜é•¿åº¦çš„å­—èŠ‚åºåˆ—ï¼Œå¯ä»¥è¯»å–å’Œå†™å…¥ï¼Œå¹¶ä¸”å¯ä»¥æŸ¥è¯¢å…¶å½“å‰å¤§å°ã€‚å½“å­—èŠ‚è¶…å‡ºå½“å‰å¤§å°æ—¶ï¼Œæ–‡ä»¶çš„å¤§å°ä¼šå¢åŠ ;å½“æ–‡ä»¶è¢«æˆªæ–­æ—¶ï¼Œå¤§å°ä¼šå‡å°‘ã€‚</p>

<p>è°ƒç”¨AsynchronousFileChannelâ€™s read() and write()æ–¹æ³•æ¥è¯»å†™æ–‡ä»¶ã€‚</p>

<p><strong>è­¦å‘Š</strong>ï¼šAsynchronousFileChannelå®ç°AsynchronousChannelè€Œä¸æ˜¯AsynchronousByteChannelï¼Œå› ä¸ºè¿™ä¸ªç±»çš„è¯»å†™æ–¹æ³•å¸¦æœ‰positionï¼ŒAsynchronousByteChannelè¯»å†™æ–¹æ³•æ²¡æœ‰positionæ¦‚å¿µã€‚</p>

<p>asynchronous file channelåœ¨æ–‡ä»¶ä¸­æ²¡æœ‰current positionã€‚ä»£æ›¿çš„æ˜¯ï¼Œfile positionä½œä¸ºå‚æ•°ä¼ é€’ç»™å¯åŠ¨å¼‚æ­¥æ“ä½œçš„æ¯ä¸ªreadå’Œwriteæ–¹æ³•ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼šread() and write()å¿…é¡»æä¾›ç»å¯¹positionï¼ˆç›¸å¯¹ä¸0ï¼‰ã€‚æ²¡æœ‰ä¸€ä¸ªç‚¹è®©è¯»å†™å»ç›¸å¯¹è¿™ä¸ªç‚¹å› ä¸ºè¯»å†™æ“ä½œå¯ä»¥åœ¨ä¹‹å‰çš„æ“ä½œå®Œæˆä¹‹å‰å¯åŠ¨ï¼Œä¸èƒ½ä¿è¯é¡ºåºã€‚ç›¸åŒåŸå› ï¼ŒAsynchronousFileChannelç±»ä¹Ÿæ²¡è®¾ç½®å’ŒæŸ¥è¯¢å½“å‰positionçš„æ–¹æ³•ã€‚</p>

<p>é™¤äº†æ”¯æŒè¯»å†™å¤–ï¼ŒAsynchronousFileChannelå®šä¹‰äº†ä¸‹é¢çš„æ“ä½œï¼š</p>

<ul>
  <li>force(boolean metaData)ã€‚æ–‡ä»¶æ›´æ–°å¼ºåˆ¶å‘é€åˆ°åº•å±‚å‚¨å­˜è®¾å¤‡ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±ã€‚</li>
  <li>æ–‡ä»¶çš„ä¸€ä¸ªåŒºåŸŸè¢«é”ä½ã€‚è°ƒç”¨lock() and tryLock()å®Œæˆã€‚ä¸¤ä¸ªæ–¹æ³•è¿”å›Futureï¼ŒCompletionHandlerä½œä¸ºå‚æ•°ã€‚</li>
</ul>

<p>Iâ€™ve created an AFCDemo application that uses AsynchronousFileChannel to
open a file and read up to the first 1024 bytes in a Future context. Listing 13-1
presents the source code.</p>

<p><strong><em>Listing 13-1. Reading Bytes from a File and Polling the Returned Future for Completion</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.AsynchronousFileChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Future</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-14 18:09
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AsyncFileChannelDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ExecutionException</span> <span class="o">{</span>

        <span class="nc">AsynchronousFileChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="nc">AsynchronousFileChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"page.html"</span><span class="o">));</span>

        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
        <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">result</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"waiting done"</span><span class="o">);</span>
            <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finished = "</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">isDone</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Bytes read = "</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>NOTE:</strong> AsynchronousFileChannel open(Path file, OpenOptionâ€¦ options)å°è¯•æ‰“å¼€æˆ–åˆ›å»ºæ–‡ä»¶ç”¨äºè¯»/å†™ï¼Œè¿”å›asynchronous file channelæ¥è®¿é—®æ–‡ä»¶ã€‚å¯èƒ½ä¼ å…¥java.nio.file.OpenOptionæ¥å£æè¿°çš„å‚æ•°ï¼Œæ˜¯java.nio.file.StandardOpenOptionå®ç°çš„ã€‚æ²¡æœ‰æŒ‡å®šå‚æ•°ï¼Œ open()å°è¯•æ‰“å¼€å­˜åœ¨çš„æ–‡ä»¶æ¥readã€‚</p>

<p>å‡è®¾ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶å·²ç»è¢«æˆåŠŸæ‰“å¼€ï¼Œåˆ†é…äº†ä¸€ä¸ªbyte bufferï¼Œè¯»æ“ä½œåœ¨position 0å¯åŠ¨ã€‚è¿”å›çš„Futureå¯¹è±¡çš„isDone()æ–¹æ³•åå¤è¢«è°ƒç”¨ã€‚ç›´åˆ°æ“ä½œå®Œæˆã€‚</p>

<p>Iâ€™ve also created a second AFCDemo application that uses AsynchronousFileChannel to open a file and read up to the first 1024 bytes in a CompletionHandler context. Listing 13-2 presents the source code.</p>

<p><strong><em>Listing 13-2. Reading Bytes from a File and Displaying the Results in a Completion Handler</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.AsynchronousFileChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.CompletionHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-14 18:09
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AsyncFileChannelDemo1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">AsynchronousFileChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="nc">AsynchronousFileChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"page.html"</span><span class="o">));</span>
        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">ct</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="nc">CompletionHandler</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Void</span><span class="o">&gt;()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">completed</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">result</span><span class="o">,</span> <span class="nc">Void</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Byte read: "</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="n">ct</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">exc</span><span class="o">,</span> <span class="nc">Void</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"failed: "</span> <span class="o">+</span> <span class="n">exc</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                <span class="n">ct</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"waiting for completion"</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ct</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="asynchronous-socket-channels">Asynchronous Socket Channels</h4>

<p>æŠ½è±¡ç±»java.nio.channels.AsynchronousServerSocketChannelæè¿°äº†asynchronous channel for stream-oriented listening socketsã€‚stream-oriented connecting socketsçš„å¯¹åº”channelç”±æŠ½è±¡ç±»java.nio.channels.AsynchronousSocketChannelæè¿°ã€‚</p>

<p><strong>Note</strong>ï¼šAsynchronousServerSocketChannelå®ç°AsynchronousChannelè€Œä¸æ˜¯AsynchronousByteChannelï¼Œå› ä¸ºæ²¡å£°æ˜read()/write()ã€‚AsynchronousSocketChannelå®ç°äº†AsynchronousByteChannelã€‚</p>

<h5 id="asynchronousserversocketchannel">AsynchronousServerSocketChannel</h5>

<p>è°ƒç”¨AsynchronousServerSocketChannel open()è·å–ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AsynchronousServerSocketChannel</span> <span class="n">ch</span><span class="o">;</span>
<span class="n">ch</span> <span class="o">=</span> <span class="nc">AsynchronousServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</code></pre></div></div>

<p>æ ¹æ®AsynchronousServerSocketChannelçš„æ–‡æ¡£ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›ç»‘å®šåˆ°é»˜è®¤groupçš„asynchronous server socket channelã€‚å¯é€‰çš„ AsynchronousServerSocketChannel open(AsynchronousChannelGroup group) æ–¹æ³•è¿”å›ç»‘å®šåˆ°æŒ‡å®šgroupçš„channelã€‚éšåè®¨è®ºasynchronous channel groupsã€‚</p>

<p>è°ƒç”¨<code class="language-plaintext highlighter-rouge"> AsynchronousServerSocketChannel setOption(SocketOption name,
T value)</code>æ–¹æ³•é…ç½®asynchronous server socket channelã€‚ç›®å‰åªæœ‰ SO_RCVBUF and SO_REUSEADDRã€‚</p>

<p>ä¸€ä¸ªæ–°å»ºçš„å¯èƒ½é…ç½®è¿‡çš„asynchronous server socket channelæ˜¯æ‰“å¼€äº†ä½†è¿˜æ²¡ç»‘å®šåˆ°æœ¬åœ°åœ°å€ã€‚å¯ä»¥è¢«ç»‘å®šåˆ°æœ¬åœ°åœ°å€æ¥é…ç½®ç›‘å¬è¿æ¥ï¼Œé€šè¿‡è°ƒç”¨ bind() ã€‚ä¸€æ—¦ç»‘å®šï¼Œä»»æ„accept()æ–¹æ³•è¿”å›Futureã€‚æ²¡æœ‰ç»‘å®šå»acceptæŠ›å‡ºjava.nio.channels.NotYetBoundExceptionã€‚</p>

<p><strong><em>Note</em></strong>ï¼šAsynchronous server socket channelså¤šçº¿ç¨‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè™½ç„¶åœ¨ä»»æ„æ—¶åˆ»æœ€å¤šåªæœ‰ä¸€ä¸ªacceptæ“ä½œå¯ä»¥åœç•™ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨å‰ä¸€ä¸ªacceptæ“ä½œç»“æŸå‰å¯åŠ¨acceptæ“ä½œï¼ŒæŠ›å‡ºjava.nio.channels.AcceptPendingExceptionã€‚</p>

<p>To demonstrate AsynchronousServerSocketChannel, Iâ€™ve created a Server application consisting of Server, Attachment, ConnectionHandler, and ReadWriteHandler classes. Listing 13-3 presents Serverâ€™s source code.</p>

<p><strong><em>Listing 13-3. Launching a Server That Handles Connections and Reads/Writes Asynchronously</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.AsynchronousServerSocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-17 16:23
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">9090</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">HOST</span> <span class="o">=</span> <span class="s">"localhost"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">AsynchronousServerSocketChannel</span> <span class="n">channelServer</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">channelServer</span> <span class="o">=</span> <span class="nc">AsynchronousServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="n">channelServer</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="no">HOST</span><span class="o">,</span> <span class="no">PORT</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Server listening at %s%n"</span><span class="o">,</span>
                    <span class="n">channelServer</span><span class="o">.</span><span class="na">getLocalAddress</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Unable to open or bind server socket channel"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">Attachment</span> <span class="n">attachment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Attachment</span><span class="o">();</span>
        <span class="n">attachment</span><span class="o">.</span><span class="na">channelServer</span> <span class="o">=</span> <span class="n">channelServer</span><span class="o">;</span>
        <span class="n">channelServer</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">attachment</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ConnectionHandler</span><span class="o">());</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server terminating"</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.net.SocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.AsynchronousServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.AsynchronousSocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-17 16:29
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Attachment</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">AsynchronousServerSocketChannel</span> <span class="n">channelServer</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">AsynchronousSocketChannel</span> <span class="n">channelClient</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="n">isReadMode</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">ByteBuffer</span> <span class="n">buffer</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">SocketAddress</span> <span class="n">clientAddr</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.SocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.AsynchronousSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.CompletionHandler</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-17 16:31
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionHandler</span> <span class="kd">implements</span> <span class="nc">CompletionHandler</span><span class="o">&lt;</span><span class="nc">AsynchronousSocketChannel</span><span class="o">,</span> <span class="nc">Attachment</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">completed</span><span class="o">(</span><span class="nc">AsynchronousSocketChannel</span> <span class="n">channelClient</span><span class="o">,</span> <span class="nc">Attachment</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SocketAddress</span> <span class="n">clientAddr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">clientAddr</span> <span class="o">=</span> <span class="n">channelClient</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Accepted connection from %s%n"</span><span class="o">,</span> <span class="n">clientAddr</span><span class="o">);</span>
            <span class="n">attachment</span><span class="o">.</span><span class="na">channelServer</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">attachment</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>

            <span class="nc">Attachment</span> <span class="n">newAtt</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Attachment</span><span class="o">();</span>
            <span class="n">newAtt</span><span class="o">.</span><span class="na">channelServer</span> <span class="o">=</span> <span class="n">attachment</span><span class="o">.</span><span class="na">channelServer</span><span class="o">;</span>
            <span class="n">newAtt</span><span class="o">.</span><span class="na">channelClient</span> <span class="o">=</span> <span class="n">channelClient</span><span class="o">;</span>
            <span class="n">newAtt</span><span class="o">.</span><span class="na">isReadMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">newAtt</span><span class="o">.</span><span class="na">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">2048</span><span class="o">);</span>
            <span class="n">newAtt</span><span class="o">.</span><span class="na">clientAddr</span> <span class="o">=</span> <span class="n">clientAddr</span><span class="o">;</span>
            <span class="nc">ReadWriteHandler</span> <span class="n">rwh</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReadWriteHandler</span><span class="o">();</span>
            <span class="n">channelClient</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">newAtt</span><span class="o">.</span><span class="na">buffer</span><span class="o">,</span> <span class="n">newAtt</span><span class="o">,</span> <span class="n">rwh</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">exc</span><span class="o">,</span> <span class="nc">Attachment</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Failed to accept connection"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.CompletionHandler</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-17 16:38
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReadWriteHandler</span> <span class="kd">implements</span> <span class="nc">CompletionHandler</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Attachment</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">completed</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">result</span><span class="o">,</span> <span class="nc">Attachment</span> <span class="n">att</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">att</span><span class="o">.</span><span class="na">channelClient</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Stopped listening to client %s%n"</span><span class="o">,</span>
                        <span class="n">att</span><span class="o">.</span><span class="na">clientAddr</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ioe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">att</span><span class="o">.</span><span class="na">isReadMode</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">att</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">att</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">();</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">limit</span><span class="o">];</span>
            <span class="n">att</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Client at %s sends message: %s%n"</span><span class="o">,</span>
                    <span class="n">att</span><span class="o">.</span><span class="na">clientAddr</span><span class="o">,</span>
                    <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">));</span>
            <span class="n">att</span><span class="o">.</span><span class="na">isReadMode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">att</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">rewind</span><span class="o">();</span>
            <span class="n">att</span><span class="o">.</span><span class="na">channelClient</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">att</span><span class="o">.</span><span class="na">buffer</span><span class="o">,</span> <span class="n">att</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">att</span><span class="o">.</span><span class="na">isReadMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">att</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="n">att</span><span class="o">.</span><span class="na">channelClient</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">att</span><span class="o">.</span><span class="na">buffer</span><span class="o">,</span> <span class="n">att</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">exc</span><span class="o">,</span> <span class="nc">Attachment</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Connection with client broken"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="asynchronoussocketchannel">AsynchronousSocketChannel</h5>

<p>è°ƒç”¨ AsynchronousSocketChannel open()è·å–ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AsynchronousSocketChannel</span> <span class="n">ch</span> <span class="o">=</span> <span class="nc">AsynchronousSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</code></pre></div></div>

<p>æ ¹æ®AsynchronousSocketChannelçš„æ–‡æ¡£ï¼Œè¿”å›ç»‘å®šåˆ°é»˜è®¤groupçš„asynchronous socket channelã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªé‡è½½æ–¹æ³•æŒ‡å®šçº¿ç¨‹ç»„ã€‚</p>

<p>å¯ä»¥ä½¿ç”¨setOption(SocketOption name, T value)æ–¹æ³•é…ç½®ï¼Œæ”¯æŒSO_RCVBUF, SO_SNDBUF, SO_KEEPALIVE, SO_REUSEADDR, and TCP_NODELAYã€‚</p>

<p>æ–°å»ºå’Œé…ç½®çš„channelè¿˜æœªè¿æ¥ï¼Œè¦è¿æ¥åˆ° asynchronous server socket channelçš„socketã€‚ä¸å¯èƒ½ä¸ºä¸€ä¸ªä»»æ„å­˜åœ¨çš„socketåˆ›å»ºasynchronous socket channelã€‚</p>

<p>é€šè¿‡connect()è¿æ¥ã€‚ä¸€æ—¦è¿æ¥ï¼Œå°±ä¼šä¿æŒè¿æ¥çŠ¶æ€ç›´åˆ°è¢«å…³é—­ã€‚æ˜¯ä¸æ˜¯è¿æ¥äº†å¯ä»¥è°ƒç”¨SocketAddress getRemoteAddress()æ–¹æ³•æ¥çŸ¥é“ï¼Œæ²¡è¿æ¥æ˜¯nullã€‚æ²¡è¿æ¥å°±å°è¯•è°ƒç”¨i/oæ“ä½œå¯¼è‡´NotYetConnectedException.</p>

<p><strong>Noteï¼š</strong>Asynchronous socket channelsæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æœ€å¤šåŒæ—¶å­˜åœ¨ä¸€ä¸ªè¯»å’Œä¸€ä¸ªå†™æ“ä½œã€‚</p>

<p>To demonstrate AsynchronousSocketChannel, Iâ€™ve created a Client application consisting of the Client, Attachment, and ReadWriteHandler classes. Listing 13-7 presents Clientâ€™s source code.</p>

<p><strong><em>Listing 13-7. Launching a Client That Handles Reads/Writes Asynchronously</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.AsynchronousSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-17 17:58
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">Charset</span> <span class="no">CSUTF8</span> <span class="o">=</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">9090</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">HOST</span> <span class="o">=</span> <span class="s">"localhost"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">AsynchronousSocketChannel</span> <span class="n">channel</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="nc">AsynchronousSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Unable to open client socket channel"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="no">HOST</span><span class="o">,</span> <span class="no">PORT</span><span class="o">)).</span><span class="na">get</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Client at %s connected%n"</span><span class="o">,</span>
                    <span class="n">channel</span><span class="o">.</span><span class="na">getLocalAddress</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="o">|</span> <span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server not responding"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Unable to obtain client socket channel's "</span> <span class="o">+</span>
                    <span class="s">"local address"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>


        <span class="nc">Attachment</span> <span class="n">attachment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Attachment</span><span class="o">();</span>
        <span class="n">attachment</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="o">;</span>
        <span class="n">attachment</span><span class="o">.</span><span class="na">isReadMode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">2048</span><span class="o">);</span>
        <span class="n">attachment</span><span class="o">.</span><span class="na">mainThd</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>

        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="s">"Hello"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
        <span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
        <span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">,</span> <span class="n">attachment</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ReadWriteHandler</span><span class="o">());</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">attachment</span><span class="o">.</span><span class="na">mainThd</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Client terminating"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.AsynchronousSocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-17 18:02
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Attachment</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">AsynchronousSocketChannel</span> <span class="n">channel</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="n">isReadMode</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">ByteBuffer</span> <span class="n">buffer</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">Thread</span> <span class="n">mainThd</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.CompletionHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-17 18:06
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReadWriteHandler</span> <span class="kd">implements</span> <span class="nc">CompletionHandler</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Attachment</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">BufferedReader</span> <span class="n">conReader</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nf">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">));</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">completed</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">result</span><span class="o">,</span> <span class="nc">Attachment</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">attachment</span><span class="o">.</span><span class="na">isReadMode</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">();</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">limit</span><span class="o">];</span>
            <span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Server responded: %s%n"</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Enter message (\"end\" to quit): "</span><span class="o">);</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">conReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"end"</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">attachment</span><span class="o">.</span><span class="na">mainThd</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Unable to read from console"</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">attachment</span><span class="o">.</span><span class="na">isReadMode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
            <span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
            <span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="n">attachment</span><span class="o">.</span><span class="na">channel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">,</span> <span class="n">attachment</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">attachment</span><span class="o">.</span><span class="na">isReadMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="n">attachment</span><span class="o">.</span><span class="na">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">attachment</span><span class="o">.</span><span class="na">buffer</span><span class="o">,</span> <span class="n">attachment</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">exc</span><span class="o">,</span> <span class="nc">Attachment</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server not responding"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="asynchronous-channel-groups">Asynchronous Channel Groups</h4>

<p>æŠ½è±¡java.nio.channels.AsynchronousChannelGroupç±»æè¿°äº†ä¸€ç»„ç›®çš„ä¸ºèµ„æºå…±äº«çš„asynchronous channelsã€‚ä¸€ä¸ªgroupå’Œä¸€ä¸ªthread poolå…³è”ï¼Œtasksè¢«æäº¤åˆ°çº¿ç¨‹æ± ï¼Œæ¥å¤„ç† I/Oäº‹ä»¶å’Œdispatch to completion handlersæ¥æ¶ˆè´¹åœ¨groupâ€™s channelsæ‰§è¡Œå¼‚æ­¥æ“ä½œçš„ç»“æœã€‚</p>

<p><strong>Note</strong> ï¼šç›¸å…³çš„ thread poolç”±groupæ‹¥æœ‰ï¼›groupçš„ç»ˆæ­¢ä¼šå¯¼è‡´å…³è”çš„çº¿ç¨‹æ± shut downã€‚</p>

<p>AsynchronousServerSocketChannels and AsynchronousSocketChannels é™„å±äºgroupã€‚å½“ä½ ä½¿ç”¨æ— å‚æ–¹æ³•åˆ›å»ºè¿™ä¸¤ç§channelï¼Œæ˜¯ç»‘å®šåˆ°é»˜è®¤groupçš„ï¼Œæ˜¯system-wide channel groupè‡ªåŠ¨ç”±JVMæ„é€ å’Œç»´æŠ¤ã€‚default groupæœ‰ä¸€ä¸ªå…³è”çš„çº¿ç¨‹æ± ï¼Œéœ€è¦æ—¶åˆ›å»ºçº¿ç¨‹ã€‚ä½ å¯ä»¥ç”¨ä»¥ä¸‹ç³»ç»Ÿå±æ€§åœ¨JVMå¯åŠ¨æ—¶é…ç½®é»˜è®¤ç»„ï¼š</p>

<ul>
  <li>
    <p>java.nio.channels.DefaultThreadPool.threadFactory:æ˜¯java.util.concurrent.ThreadFactoryçš„å…·ä½“ç±»çš„å…¨é™å®šåã€‚æ­¤ç±»ä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½å®ä¾‹åŒ–ã€‚factoryçš„ newThread(Runnable r) æ–¹æ³•ä¸ºé»˜è®¤groupçš„çº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹ã€‚å¦‚æœåŠ è½½å®ä¾‹åŒ–å±æ€§çš„è¿‡ç¨‹å¤±è´¥ï¼Œåœ¨æ„å»ºé»˜è®¤ç»„çš„æ—¶å€™æŠ›å‡ºæœªæŒ‡å®šerrorã€‚ï¼ˆå¦‚æœé»˜è®¤ç»„çš„ ThreadFactory æ²¡é…ç½®ï¼Œé»˜è®¤ç»„çš„pooled threadsæ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚ï¼‰</p>
  </li>
  <li>
    <p>java.nio.channels.DefaultThreadPool.initialSize:æŒ‡å®šdefault groupâ€™s thread poolçš„åˆå§‹sizeã€‚</p>
  </li>
</ul>

<p>ä½ å¯èƒ½æ›´æƒ³å®šä¹‰è‡ªå·±çš„channel groupï¼Œè¿™ä¼šè®©ä½ æ›´å¤šæœåŠ¡I/O operationsçº¿ç¨‹çš„æ§åˆ¶æƒã€‚å¦å¤–ï¼Œæä¾›äº†shut downçº¿ç¨‹å’Œç­‰å¾…ç»ˆæ­¢çš„æœºåˆ¶ã€‚ä½ å¯ä»¥è°ƒç”¨ä¸‹é¢æ–¹æ³•åˆ›å»ºè‡ªå·±çš„asynchronous channel groupï¼š</p>

<ul>
  <li>AsynchronousChannelGroup withCachedThreadPool(ExecutorService executor, int initialSize): ä½¿ç”¨æŒ‡å®šthread poolåˆ›å»º</li>
  <li>AsynchronousChannelGroup withFixedThreadPool(int nThreads, ThreadFactory threadFactory):ä½¿ç”¨ä¸€ä¸ª fixed thread poolåˆ›å»ºã€‚</li>
  <li>AsynchronousChannelGroup withThreadPool (ExecutorService executor):ä½¿ç”¨æŒ‡å®šthread poolåˆ›å»ºã€‚</li>
</ul>

<p>The following example creates a new channel group that has a fixed pool of 20 threads. Each thread is constructed with the default thread factory from the java.util.concurrent.Executors class:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AsynchronousChannelGroup</span> <span class="n">group</span><span class="o">;</span>
<span class="n">group</span> <span class="o">=</span> <span class="nc">AsynchronousChannelGroup</span><span class="o">.</span><span class="na">withFixedThreadPool</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">());</span>
</code></pre></div></div>

<p>åˆ›å»ºåï¼Œä½ éœ€è¦æŠŠasynchronous server socket channel and an asynchronous socket channelç»‘å®šåˆ°groupä¸Šï¼š</p>

<ul>
  <li>AsynchronousServerSocketChannel open(AsynchronousChannelGroup group)</li>
  <li>AsynchronousSocketChannel open(AsynchronousChannelGroup group)</li>
</ul>

<p>The following example creates an asynchronous server socket channel and an asynchronous socket channel that are bound to the previously-created group:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AsynchronousServerSocketChannel</span> <span class="n">chServer</span><span class="o">;</span>
<span class="n">chServer</span> <span class="o">=</span> <span class="nc">AsynchronousServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
<span class="nc">AsynchronousSocketChannel</span> <span class="n">chClient</span> <span class="o">=</span> <span class="nc">AsynchronousSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>Note</strong> ï¼šå½“å†™completion handlerï¼Œé¿å…æ“ä½œé˜»å¡çº¿ç¨‹å¾ˆé‡è¦ã€‚å½“æ‰€æœ‰çº¿ç¨‹è¢«é˜»å¡æ—¶ï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºå¯èƒ½ä¼šé˜»å¡ã€‚å¯¹äºcustom or cached thread poolï¼Œqueueå¯èƒ½å˜å¾—éå¸¸å¤§æ— é™å¢é•¿å¯¼è‡´oomã€‚</p>

<p>ç»‘å®šåˆ°groupä¾¿äºå…³é—­å’Œç»ˆæ­¢ã€‚void shutdown()æ–¹æ³•å¯åŠ¨ä¸€ä¸ªgroupçš„é¡ºåºå…³é—­ã€‚isShutdown() æ–¹æ³•æŸ¥çœ‹æ˜¯å¦å…³é—­ã€‚å…³é—­çš„groupä¸èƒ½åˆ›å»ºchannelã€‚</p>

<p>ä¸€æ—¦shut downï¼Œgroupç»ˆæ­¢ä¼šåœ¨ä¸‹é¢æ“ä½œå®Œæˆåç»ˆæ­¢â€”â€”æ‰€æœ‰ç»‘å®šåˆ°groupçš„asynchronous channelså…³é—­ï¼Œæ‰€æœ‰æ´»è·ƒçš„executing completion handlerså®Œç»“ï¼Œgroupä½¿ç”¨çš„èµ„æºé‡Šæ”¾ã€‚ä¸ä¼šå°è¯•åœæ­¢æˆ–ä¸­æ–­æ­£åœ¨æ‰§è¡Œcompletion handlersçš„çº¿ç¨‹ã€‚isTerminated()æ£€æŸ¥æ˜¯å¦ç»ˆæ­¢ã€‚ boolean awaitTermination(long
timeout, TimeUnit unit)ç”¨äºåœ¨å…³é—­å‰é˜»å¡ã€‚</p>

<p>shutdownNow()å¼ºåˆ¶å…³é—­groupã€‚ é™¤äº†é¡ºåºshut downï¼Œä¼šè°ƒç”¨groupé‡Œopen channelsçš„close()æ–¹æ³•ã€‚</p>

<p>The following example demonstrates the aforementioned methods:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Initiate an I/O operation that isn't satisfied.</span>
<span class="n">channel</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">completionHandler</span><span class="o">);</span>
<span class="c1">// After the operation has begun, the channel group is used to control</span>
<span class="c1">// the shutdown.</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">group</span><span class="o">.</span><span class="na">isShutdown</span><span class="o">())</span>
<span class="o">{</span>
 <span class="c1">// After the group is shut down, no more channels can be bound to it.</span>
 <span class="n">group</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">group</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span>
<span class="o">{</span>
 <span class="c1">// Forcibly shut down the group. The channel is closed and the</span>
 <span class="c1">// accept operation aborts.</span>
 <span class="n">group</span><span class="o">.</span><span class="na">shutdownNow</span><span class="o">();</span>
<span class="o">}</span>
<span class="c1">// The group should be able to terminate; wait for 10 seconds maximum.</span>
<span class="n">group</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</code></pre></div></div>

<h5 id="what-about-asynchronousfilechannel">What About AsynchronousFileChannel?</h5>

<p>AsynchronousFileChannelsä¸é™„å±äºgroupã€‚ç„¶è€Œï¼Œå’Œä¸€ä¸ªçº¿ç¨‹æ± å…³è”æ¥æäº¤taskï¼Œæ‰§è¡Œi/o eventå’Œdispatch to completion handlersæ¶ˆè´¹channelæ“ä½œçš„ç»“æœã€‚åœ¨channelå¯åŠ¨ç”¨äºæ‰§è¡Œi/oæ“ä½œçš„completion handlerä¿è¯ä¼šè¢«çº¿ç¨‹æ± çš„ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ï¼Œè¿™å°±ç¡®ä¿äº† completion handleræ˜¯ç”±ä¸€ä¸ªå¸¦æœ‰é¢„æœŸæ ‡è¯†çš„çº¿ç¨‹è¿è¡Œçš„ã€‚å¦‚æœi/oæ“ä½œç«‹å³å®Œæˆäº†ï¼Œå¯åŠ¨çº¿ç¨‹æœ¬äº‹æ˜¯çº¿ç¨‹æ± çš„çº¿ç¨‹ï¼Œcompletion handlerç›´æ¥è¢«å¯åŠ¨çº¿ç¨‹è°ƒç”¨ã€‚</p>

<p>å½“asynchronous file channelæ²¡æŒ‡å®šçº¿ç¨‹æ± ï¼Œä½¿ç”¨åŸºäºç³»ç»Ÿçš„é»˜è®¤çº¿ç¨‹æ± ï¼Œå¯èƒ½å’Œå…¶ä»–çš„channelså…±äº«ã€‚é»˜è®¤çº¿ç¨‹æ± ç”± AsynchronousChannelGroupå®šä¹‰çš„ç³»ç»Ÿå±æ€§é…ç½®</p>

<p>AsynchronousFileChannelâ€™s AsynchronousFileChannel open(Path file, OpenOptionâ€¦ options)åˆ›å»ºçš„ asynchronous file channel å’Œé»˜è®¤çº¿ç¨‹æ± å…³è”ã€‚è°ƒç”¨<code class="language-plaintext highlighter-rouge"> AsynchronousFileChannel open(Path file, Set options, ExecutorService executor, FileAttribute... attrs)</code>æŒ‡å®šçº¿ç¨‹æ± ã€‚</p>

<h5 id="exercises-5">EXERCISES</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The following exercises are designed to test your understanding of Chapter 13â€™s content:
1. Define asynchronous channel.
2. Identify the two ways to initiate an I/O operation with an asynchronous
channel.
3. True or false: After a channel is closed, further attempts to initiate
asynchronous I/O operations complete immediately with cause
AsynchronousCloseException.
4. Identify the methods declared by the AsynchronousByteChannel
interface.
5. True or false: The ByteBuffer object is safe for use by multiple
concurrent threads.
6. Identify the class for reading, writing, and manipulating a file
asynchronously.
7. True or false: An asynchronous file channel doesnâ€™t have a current
position within a file.
8. If you pass no options to AsynchronousFileChannelâ€™s
AsynchronousFileChannel open(Path file, OpenOption...
options) method, what is this methodâ€™s default behavior?
9. How do you obtain an AsynchronousServerSocketChannel object
or an AsynchronousSocketChannel object?
10. Identify AsynchronousServerSocketChannel's documented
socket options.
11. After obtaining an AsynchronousServerSocketChannel object,
what must you do before you can call either of its accept() methods?
12. After obtaining an AsynchronousSocketChannel object, what must
you do before you can perform reads and writes?
13. How do you determine if an asynchronous socket channel is connected
to an asynchronous server socket channel?
14. True or false: Asynchronous socket channels are safe for use by
multiple concurrent threads.
15. What is the purpose of the AsynchronousChannelGroup class?
16. What does a group use for task submission?
17. Identify the system properties for configuring the default group.
18. Describe AsynchronousChannelGroupâ€™s shutDownNow() method.
19. True or false: AsynchronousFileChannels belong to groups.
20. Write a Copy application that uses AsynchronousFileChannel to
copy a source file to a destination file asynchronously
</code></pre></div></div>

<h4 id="summary-12">Summary</h4>

<p>Asynchronous I/Oè®©å®¢æˆ·ç«¯ä»£ç å¯åŠ¨I/Oæ“ä½œï¼Œéšåæ“ä½œå®Œæˆæ—¶é€šçŸ¥å®¢æˆ·ç«¯ã€‚The AsynchronousChannel interface describes an asynchronous channel that supports asynchronous
I/O operations (reads, writes, and so on). An I/O operation is initiated by calling a method that returns a Future or requires a CompletionHandler argument.</p>

<p>CompletionHandler declares a completed() method to consume the result
of an operation when it completes successfully. It also declares a failed()
method to report operation failure (in terms of an exception) and allow an
application to take appropriate action.</p>

<p>The AsynchronousByteChannel interface extends AsynchronousChannel and
declares a pair of read() methods and a pair of write() methods. Each pair
consists of a method that returns a Future and a method that requires a
CompletionHandler argument.</p>

<p>The abstract AsynchronousFileChannel class describes an asynchronous
channel for reading, writing, and manipulating a file. The abstract
AsynchronousServerSocketChannel class describes an asynchronous
channel for stream-oriented listening sockets. Its counterpart channel for
stream-oriented connecting sockets is described by the abstract
AsynchronousSocketChannel class</p>

<p>The abstract AsynchronousChannelGroup class describes a grouping of
asynchronous channels for the purpose of resource sharing. A group has
an associated thread pool to which tasks are submitted, to handle I/O
events and to dispatch to completion handlers that consume the results of
asynchronous operations performed on the groupâ€™s channels</p>

<p>AsynchronousServerSocketChannels and AsynchronousSocketChannels
created via their noargument open() methods are bound to the default group.
They can be bound to groups created from AsynchronousChannelGroupâ€™s class
methods by passing these group objects to their open(AsynchronousChannelGroup)
methods.</p>

<h3 id="chapter-14-completion-of-socket-channel-functionality">Chapter 14 Completion of Socket Channel Functionality</h3>

<p>JDK 7æœ€ç»ˆè¡¥å…¨äº†NIO.2çš„ socket channelåŠŸèƒ½ã€‚ç»‘å®šåˆ°channelçš„socketï¼Œget/set socketçš„optionï¼Œä½ å¿…é¡»è°ƒç”¨socket()æ–¹æ³•è·å– peer socketã€‚</p>

<h4 id="binding-and-option-configuration">Binding and Option Configuration</h4>

<p>socket channel and socket APIsçš„è¿åç›´è§‰çš„ç»„åˆå­˜åœ¨æ˜¯å› ä¸ºJDK1.4çš„æ—¶é—´ä¸è¶³ã€‚JDKå¼•å…¥java.nio.channels.NetworkChannelæ¥å£è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>

<p>NetworkChannelä»£è¡¨ä»£è¡¨ä¸€ä¸ªåˆ°network socketd channel.æ¥å£è¢«DatagramChannel, ServerSocketChannel, SocketChannel, java.nio.channels.AsynchronousServerSocketChannel,java.nio.channels.AsynchronousSocketChannel å®ç°ã€‚</p>

<p>Table 14-1 presents NetworkChannelâ€™s methods.</p>

<p><strong><em>Table 14-1. The Methods that Define a Network Channel</em></strong></p>

<p>| Method                                                    | Description                                                  |
| â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” |
| NetworkChannel bind(SocketAddress local)                  | ç»‘å®šç›´åˆ°å…³é—­                                                 |
| SocketAddress getLocalAddress()                           | Return the socket address to which this channelâ€™ s socket is bound. |
| <code class="language-plaintext highlighter-rouge">T getOption&lt;br/&gt;(SocketOption name)</code>                     |                                                              |
| <code class="language-plaintext highlighter-rouge">NetworkChannel&lt;br/&gt;setOption
(SocketOption name,
T value)</code> |                                                              |
| <code class="language-plaintext highlighter-rouge">Set&gt;&lt;br/&gt;supportedOptions()</code>                             |                                                              |</p>

<p>optionæ˜¯JDKæ·»åŠ çš„java.net.StandardSocketOptionsï¼Œæœ‰æ¯”å¦‚ï¼šSO_RCVBUF (size of socket receive buffer) and TCP_NODELAY (disable the Nagle algorithm)ã€‚</p>

<p>å¯ä»¥ä½¿ç”¨å“ªäº›optionæ˜¯æ ¹æ®è¯¥ç±»çš„å…·ä½“å®ç°çš„ã€‚</p>

<p>JDK7ä¹Ÿæ›´æ–°äº† DatagramChannel, ServerSocketChannel, and SocketChannelçš„å‡ ä¸ªæ–¹æ³•:</p>

<ul>
  <li>DatagramChannelåŠ äº† SocketAddress getRemoteAddress()</li>
  <li>ServerSocketChannelåŠ äº†ServerSocketChannel bind(SocketAddress local, int backlog)</li>
  <li>SocketChannelåŠ äº† SocketChannel shutdownInput() and SocketChannel shutdownOutput()ã€‚ä¹Ÿæœ‰SocketAddress getRemoteAddress()</li>
</ul>

<p>Listing 7-7â€™s ChannelServer application had to invoke socket() when binding the channelâ€™s socket to a local address, obtaining the local address, and obtaining the remote address. Listing 14-1 simplifies this code by making it NetworkChannel-compliant and using getRemoteAddress().</p>

<p><strong><em>Listing 14-1. Demonstrating the Improved ServerSocketChannel</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.ServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-25 14:48
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Starting server.."</span><span class="o">);</span>
        <span class="nc">ServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">9999</span><span class="o">));</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Local address: "</span> <span class="o">+</span> <span class="n">ssc</span><span class="o">.</span><span class="na">getLocalAddress</span><span class="o">();</span>
        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"."</span><span class="o">);</span>
            <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">ssc</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sc</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Received connection from "</span> <span class="o">+</span>
                        <span class="n">sc</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">());</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">rewind</span><span class="o">();</span>
                <span class="n">sc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">else</span>
                <span class="k">try</span>
                <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">ie</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// shouldn't happen</span>
                <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.SocketOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.StandardSocketOptions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-25 15:06
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SocketOption</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">socketOptions</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">supportedOptions</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">SocketOption</span><span class="o">&lt;?&gt;</span> <span class="n">socketOption</span> <span class="o">:</span> <span class="n">socketOptions</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">socketOption</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sc</span><span class="o">.</span><span class="na">getOption</span><span class="o">(</span><span class="nc">StandardSocketOptions</span><span class="o">.</span><span class="na">SO_RCVBUF</span><span class="o">));</span>
        <span class="n">sc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="nc">InetSocketAddress</span> <span class="n">addr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">9999</span><span class="o">);</span>
        <span class="n">sc</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">addr</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">sc</span><span class="o">.</span><span class="na">finishConnect</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"waiting to finish connection"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">sc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="channel-based-multicasting">Channel-Based Multicasting</h4>

<p>JDK 7 å¼•å…¥channel-based IP multicastingæ”¯æŒï¼Œä¼ è¾“IPçš„æ•°æ®æŠ¥æ–‡åˆ°groupã€‚æ•°æ®æ¥è‡ªä¸€ä¸ªæºã€‚</p>

<p>D IP addressç±»ä»£è¡¨groupï¼Œæ˜¯ä¸€ä¸ª multicast group IPv4 addressä»224.0.0.1åˆ° 239.255.255.255ã€‚æ–°çš„receiver (client)é€šè¿‡è¿æ¥group ipåŠ å…¥åˆ°ç»„ã€‚</p>

<p>JDK 7 å¼•å…¥ java.nio.channels.MulticastChannelæ¥å£æ”¯æŒmulticastingã€‚ç»§æ‰¿NetworkChannelï¼Œè¢«DatagramChannelå®ç°ã€‚å£°æ˜äº†join()æ–¹æ³•å’Œ close()æ–¹æ³•ã€‚</p>

<p>receiverè°ƒç”¨ MembershipKey join(InetAddress group, NetworkInterface ni)åŠ å…¥groupã€‚</p>

<p><strong>Note</strong>ï¼šnetwork interfaceç”±ç±»java.net. NetworkInterfaceå®ä¾‹æè¿°ï¼Œè°ƒç”¨ NetworkInterface
getByInetAddress(InetAddress addr)è·å–ã€‚</p>

<p>è°ƒç”¨ MembershipKey join(InetAddress group, NetworkInterface ni, InetAddress source)ä»sourceæ¥æ”¶ã€‚</p>

<p><strong>Note:</strong>ç¬¬ä¸€ä¸ªjoinæ˜¯ç±»ä¼¼æœ‰çº¿ç”µè§†ï¼Œè®¢é˜…packages of channelsã€‚ç¬¬äºŒä¸ªæ˜¯è®¢é˜…ä½ æ„Ÿå…´è¶£çš„ã€‚</p>

<p>MembershipKeyå£°æ˜å‡ ä¸ªæ–¹æ³•ï¼š</p>

<ul>
  <li>MembershipKey block(InetAddress source):å±è”½source</li>
  <li>MulticastChannel channel():</li>
  <li>void drop():</li>
  <li>InetAddress group():</li>
  <li>boolean isValid():</li>
  <li>NetworkInterface networkInterface():</li>
  <li>InetAddress sourceAddress():</li>
  <li>MembershipKey unblock(InetAddress source):</li>
</ul>

<p>To create a multicast server or multicast client, there are three important items to keep in mind:</p>

<ul>
  <li>æŒ‡å®š protocol family</li>
  <li>è°ƒç”¨DatagramChannelâ€™s DatagramChannel open(ProtocolFamily family)åˆ›å»º datagram channelã€‚</li>
  <li>channelâ€™s socketåº”è¯¥ç»‘å®šåˆ° wildcard addressã€‚</li>
  <li>â€¦</li>
</ul>

<p>Iâ€™ve created multicast server and client applications that demonstrate channel-based multicasting. Listing 14-3 presents the server.</p>

<p><strong><em>Listing 14-3. Demonstrating a Channel-Based Multicast Server</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DatagramServer</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">9999</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">NetworkInterface</span> <span class="n">ni</span><span class="o">;</span>
        <span class="n">ni</span> <span class="o">=</span> <span class="nc">NetworkInterface</span><span class="o">.</span><span class="na">getByInetAddress</span><span class="o">(</span><span class="nc">InetAddress</span><span class="o">.</span><span class="na">getLocalHost</span><span class="o">());</span>
        <span class="nc">DatagramChannel</span> <span class="n">dc</span><span class="o">;</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="nc">DatagramChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="nc">StandardProtocolFamily</span><span class="o">.</span><span class="na">INET</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setOption</span><span class="o">(</span><span class="nc">StandardSocketOptions</span><span class="o">.</span><span class="na">SO_REUSEADDR</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
                <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="no">PORT</span><span class="o">)).</span><span class="na">setOption</span><span class="o">(</span><span class="nc">StandardSocketOptions</span><span class="o">.</span><span class="na">IP_MULTICAST_IF</span><span class="o">,</span> <span class="n">ni</span><span class="o">);</span>

        <span class="nc">InetAddress</span> <span class="n">group</span> <span class="o">=</span> <span class="nc">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="s">"239.255.0.1"</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="nc">ByteBuffer</span> <span class="n">bb</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">((</span><span class="s">"line "</span> <span class="o">+</span> <span class="n">i</span><span class="o">).</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="n">dc</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">bb</span><span class="o">,</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="no">PORT</span><span class="o">));</span>
            <span class="n">i</span><span class="o">++;</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.DatagramChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.MembershipKey</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-26 10:23
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DatagramClient</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">9999</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">NetworkInterface</span> <span class="n">ni</span><span class="o">;</span>
        <span class="n">ni</span> <span class="o">=</span> <span class="nc">NetworkInterface</span><span class="o">.</span><span class="na">getByInetAddress</span><span class="o">(</span><span class="nc">InetAddress</span><span class="o">.</span><span class="na">getLocalHost</span><span class="o">());</span>
        <span class="nc">DatagramChannel</span> <span class="n">dc</span><span class="o">;</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="nc">DatagramChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="nc">StandardProtocolFamily</span><span class="o">.</span><span class="na">INET</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setOption</span><span class="o">(</span><span class="nc">StandardSocketOptions</span><span class="o">.</span><span class="na">SO_REUSEADDR</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="no">PORT</span><span class="o">))</span>
                <span class="o">.</span><span class="na">setOption</span><span class="o">(</span><span class="nc">StandardSocketOptions</span><span class="o">.</span><span class="na">IP_MULTICAST_IF</span><span class="o">,</span> <span class="n">ni</span><span class="o">);</span>
        <span class="nc">InetAddress</span> <span class="n">group</span> <span class="o">=</span> <span class="nc">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="s">"239.255.0.1"</span><span class="o">);</span>
        <span class="nc">MembershipKey</span> <span class="n">membershipKey</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">ni</span><span class="o">);</span>

        <span class="nc">ByteBuffer</span> <span class="n">response</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dc</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
            <span class="n">response</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="appendix-b--sockets-and-network-interfaces">Appendix B  Sockets and Network Interfaces</h2>

<p>7ç« èŠ‚å¼•å…¥peer socketæ¦‚å¿µï¼Œæ˜¯ä¸€ä¸ªå…³è”ä¸€ä¸ªchannelçš„socketã€‚14ç« å¼•å…¥network interfaceçš„æ¦‚å¿µã€‚é™„å½•ä»‹ç»sockets, network interfaces, and å’Œè¿™äº›åŠŸèƒ½äº¤äº’çš„APIsï¼Œ</p>

<p><strong>Note</strong>:ç½‘ç»œæ˜¯ä¸€ç»„ç›¸äº’è¿æ¥çš„èŠ‚ç‚¹(è¯¸å¦‚å¹³æ¿ç”µè„‘ä¹‹ç±»çš„è®¡ç®—è®¾å¤‡ï¼Œä»¥åŠæ‰«æä»ªæˆ–æ¿€å…‰æ‰“å°æœºç­‰å¤–å›´è®¾å¤‡)ï¼Œå¯åœ¨ç½‘ç»œç”¨æˆ·ä¹‹é—´å…±äº«ã€‚ç½‘ç»œåœ¨èŠ‚ç‚¹ä¹‹é—´ä½¿ç”¨ TCP/IPäº¤æµã€‚Transmission Control Protocol (TCP)ï¼Œæ˜¯ä¸€ç§é¢å‘è¿æ¥çš„åè®®; User Datagram Protocol (UDP)ï¼Œæ˜¯æ— è¿æ¥åè®®ï¼›Internet Protocol (IP)ï¼Œæ˜¯åŸºç¡€åè®®ï¼ŒTCPå’ŒUDPé€šè¿‡ä»–æ‰§è¡Œä»»åŠ¡ã€‚</p>

<p>java.net packageæä¾›äº†è¿›ç¨‹é—´TCP/IPçš„ç±»å‹æ”¯æŒã€‚</p>

<h3 id="sockets">Sockets</h3>

<p>ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´socketsæ–¹å¼äº¤æµï¼Œsocketsæ˜¯ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´communications linkçš„endpointsã€‚æ¯ä¸ªendpoint IPä»£è¡¨hostï¼Œportä»£è¡¨hostçš„ç«¯å£å·</p>

<p><code class="language-plaintext highlighter-rouge">**P ADDRESSES AND PORT NUMBERSã€‚**Â·</code>`</p>

<p>IPåœ°å€æ˜¯ä¸€ä¸ª32ä½æˆ–128ä½çš„æ— ç¬¦å·æ•´æ•°ï¼ŒæƒŸä¸€åœ°æ ‡è¯†ä¸€ä¸ªç½‘ç»œä¸»æœºæˆ–å…¶ä»–ç½‘ç»œèŠ‚ç‚¹ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªè·¯ç”±å™¨ï¼‰ã€‚</p>

<p>é€šå¸¸ä½¿ç”¨32bit IPï¼Œä¸€ä¸ª32ä½çš„IPåœ°å€é€šå¸¸è¢«ç§°ä¸º Internet Protocol Version 4 (IPv4)åœ°å€ã€‚</p>

<p>ä¹Ÿé€šå¸¸ç”¨128-bit IP addressï¼Œ8ä¸ª16-bit integerã€‚æ¯ä¸ªç»„ä»¶éƒ½æ˜¯ä¸€ä¸ªåå…­è¿›åˆ¶æ•´æ•°ï¼Œä»0åˆ°FFFFï¼Œé€šè¿‡å†’å·ä¸ä¸‹ä¸€ä¸ªç»„ä»¶åˆ†ç¦»ã€‚such as 1080:0:0:0:8:800:200C:417Aã€‚A 128-bit IP address is often referred to as an Internet Protocol Version 6 (IPv6) address ã€‚ä¸€ä¸ªç«¯å£å·æ˜¯ä¸€ä¸ª16ä½çš„æ•´æ•°ï¼Œå®ƒå”¯ä¸€åœ°æ ‡è¯†ä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒæ˜¯æ¶ˆæ¯çš„æœ€ç»ˆæ¥æºæˆ–æ¥æ”¶è€…ã€‚å°äº1024çš„ç«¯å£å·æ˜¯ä¸ºæ ‡å‡†æµç¨‹ä¿ç•™çš„ã€‚ä¾‹å¦‚ï¼Œç«¯å£25ä¼ ç»Ÿä¸Šæ ‡è¯†äº†ç®€å•çš„é‚®ä»¶å‘é€ç”µå­é‚®ä»¶çš„ä¼ è¾“åè®®ï¼ˆSMTPï¼‰è¿‡ç¨‹ï¼Œå°½ç®¡ç«¯å£å·587å·²ç»åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ·˜æ±°äº†è¿™ä¸ªæ—§çš„ç«¯å£å·ã€‚</p>

<p>ä¸€ä¸ªè¿›ç¨‹å†™messageï¼ˆå­—èŠ‚åºåˆ—ï¼‰åˆ°socketã€‚åº•å±‚å¹³å°çš„ç½‘ç»œç®¡ç†è½¯ä»¶éƒ¨åˆ†å°†æ¶ˆæ¯åˆ†è§£æˆä¸€ç³»åˆ—æ•°æ®åŒ…ï¼ˆå¯å¯»å€çš„æ¶ˆæ¯å—ï¼Œé€šå¸¸ç§°ä¸ºIPæ•°æ®æŠ¥ï¼‰ï¼ŒæŠŠå®ƒä»¬è½¬å‘åˆ°å¦ä¸€ä¸ªè¿›ç¨‹çš„socketï¼Œå°†å®ƒä»¬é‡æ–°ç»„åˆä¸ºåŸå§‹ä¿¡æ¯è¿›è¡Œå¤„ç†ã€‚</p>

<p><img src="E:\studydyup\notes\src\pic\2384732848.png" alt="1537933904419" /></p>

<p>åœ¨å›¾B-1çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå‡è®¾è¿›ç¨‹Aæƒ³è¦å‘é€ä¸€æ¡æ¶ˆæ¯ç»™è¿›ç¨‹Bã€‚Aå‘æ¶ˆæ¯åˆ°å®ƒçš„socketï¼Œé™„æœ‰Bçš„ç›®æ ‡socketåœ°å€ã€‚ä¸»æœºAçš„network management softwareï¼ˆé€šå¸¸è¢«ç§°ä¸ºåè®®æ ˆï¼‰è·å¾—messageï¼Œå°†å…¶ç®€åŒ–ä¸ºä¸€ç³»åˆ—ä¿¡æ¯åŒ…ï¼Œæ¯ä¸ªåŒ…åŒ…å«ç›®æ ‡ä¸»æœºçš„IPåœ°å€å’Œç«¯å£å·ã€‚ç„¶å network management softwareé€šè¿‡Aä¸»æœºçš„ Network Interface Cardï¼ˆNICï¼‰åˆ°ä¸»æœºBã€‚</p>

<p><strong>Noteï¼š</strong>ç½‘å¡ï¼ˆNICï¼‰çš„å„ç§ç½‘ç»œæ¥å£æ˜¯è®¡ç®—æœºå’Œç½‘ç»œä¹‹é—´çš„è¿æ¥ã€‚</p>

<p>Bä¸»æœºçš„åè®®æ ˆé€šè¿‡NICæ¥æ”¶åŒ…å¹¶é‡ç»„ä¸ºåŸå§‹messageï¼ˆæ•°æ®åŒ…å¯èƒ½æ— åºï¼‰ï¼Œç„¶åé€šè¿‡socketå¯¹è¿›ç¨‹Bå¯ç”¨ã€‚å½“è¿›ç¨‹Bä¸è¿›ç¨‹aé€šä¿¡æ—¶ï¼Œè¿™ä¸ªåœºæ™¯ä¼šå‘ç”Ÿé€†è½¬ã€‚</p>

<p>ç½‘ç»œç®¡ç†è½¯ä»¶ä½¿ç”¨TCPåœ¨ä¸¤ä¸ªä¸»æœºä¹‹é—´åˆ›å»ºä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„å¯¹è¯ï¼Œå…¶ä¸­æ¶ˆæ¯è¢«æ¥å›å‘é€ã€‚åœ¨æ­¤å¯¹è¯å‘ç”Ÿä¹‹å‰ï¼Œè¿™äº›ä¸»æœºä¹‹é—´å»ºç«‹äº†è¿æ¥ã€‚åœ¨å»ºç«‹è¿æ¥ä¹‹åï¼ŒTCPè¿›å…¥ä¸€ä¸ªæ¨¡å¼ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸­ï¼Œå®ƒå‘é€æ¶ˆæ¯æ•°æ®åŒ…å¹¶ç­‰å¾…å®ƒä»¬æ­£ç¡®åˆ°è¾¾çš„åº”ç­”ï¼ˆæˆ–è€…ç”±äºæŸä¸ªç½‘ç»œé—®é¢˜è€Œæ²¡æœ‰åˆ°è¾¾ï¼Œè¶…æ—¶è¿‡æœŸï¼‰ã€‚è¿™ç§æ¨¡å¼é‡å¤å¹¶ä¿è¯äº†å¯é çš„è¿æ¥ã€‚æœ‰å…³æ­¤æ¨¡å¼çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·è®¿é—®http://en.wikipedia.org/wiki/tcpreceivewindowflowcontrolã€‚</p>

<p>å› ä¸ºå»ºç«‹ä¸€ä¸ªè¿æ¥éœ€è¦æ—¶é—´ï¼Œå‘é€æ•°æ®åŒ…ä¹Ÿéœ€è¦æ—¶é—´ï¼ˆå› ä¸ºæœ‰å¿…è¦æ¥æ”¶åº”ç­”ç¡®è®¤å’Œè¶…æ—¶ï¼‰ï¼ŒTCPæ˜¯ç¼“æ…¢çš„ã€‚å¦ä¸€æ–¹é¢ï¼ŒUDPä¸éœ€è¦è¿æ¥å’ŒåŒ…ç¡®è®¤ï¼Œå®ƒçš„é€Ÿåº¦è¦å¿«å¾—å¤šã€‚ç¼ºç‚¹æ˜¯UDPä¸å¯é ï¼Œå› ä¸ºæ²¡æœ‰ç¡®è®¤ï¼ˆè™½ç„¶UDPä½¿ç”¨æ ¡éªŒå’Œæ¥éªŒè¯æ•°æ®æ˜¯å¦æ­£ç¡®ï¼Œä½†å¹¶ä¸èƒ½ä¿è¯åŒ…çš„äº¤ä»˜ã€æ’åºæˆ–å¯¹é‡å¤æ•°æ®åŒ…çš„ä¿æŠ¤ï¼‰ã€‚æ­¤å¤–ï¼ŒUDPä»…é™äºå•åŒ…ä¼šè¯ã€‚</p>

<p>java.netåŒ…æä¾›Socket, ServerSocketå’Œå…¶ä»–Socketåç¼€çš„ç±»ç”¨äºæ‰§è¡Œæ‰§è¡ŒåŸºäºtcpçš„æˆ–åŸºäºudpçš„é€šä¿¡ã€‚åœ¨ç ”ç©¶è¿™äº›ç±»ä¹‹å‰ï¼Œæ‚¨éœ€è¦äº†è§£socket addresseså’Œsocket optionsã€‚</p>

<h3 id="socket-addresses">Socket Addresses</h3>

<p>ä¸€ä¸ªSocketåç¼€ç±»çš„å®ä¾‹å’Œä¸€ä¸ªsocket addresså…³è”ï¼Œç”±IPå’Œç«¯å£ç»„æˆã€‚è¿™äº›ç±»é€šå¸¸ä¾èµ–InetAddressç±»ä»£è¡¨socket addressçš„IPv4 or IPv6 address portionï¼›ç«¯å£å·æ˜¯å•ç‹¬è¡¨ç¤ºçš„ã€‚</p>

<p><strong>Note</strong>ï¼š InetAddressä¾èµ–Inet4Addresså­ç±»ä»£è¡¨IPv4 addresså’ŒInet6Addressä»£è¡¨IPv6 addressã€‚</p>

<p>InetAddresså£°æ˜äº†å‡ ä¸ªæ–¹æ³•è·å–InetAddresså®ä¾‹ã€‚è¿™äº›æ–¹æ³•åŒ…æ‹¬ï¼š</p>

<ul>
  <li>InetAddress[] getAllByName(String host) è¿”å›InetAddressesçš„æ•°ç»„ï¼Œå‚¨å­˜äº†å…³è”HOSTçš„IP addressesã€‚æ‚¨å¯ä»¥å°†ä¸€ä¸ªåŸŸåï¼ˆå¦‚â€œtutortutor.caâ€ï¼‰æˆ–IPåœ°å€ï¼ˆå¦‚â€œ70.33.247.10â€ï¼‰ä¼ é€’ç»™è¿™ä¸ªå‚æ•°ã€‚ (To learn about domain names, check out Wikipediaâ€™s â€œDomain nameâ€ entry [http://en.wikipedia.org/wiki/Domain_name].) ä¼ nullè·å–çš„InetAddresså®ä¾‹å‚¨å­˜äº† loopback interfaceçš„IP addressï¼ˆä¸€ä¸ªåŸºäºè½¯ä»¶çš„ç½‘ç»œæ¥å£ï¼Œè¾“å‡ºçš„æ•°æ®ä½œä¸ºè¾“å…¥çš„æ•°æ®è¿”å›ï¼‰ã€‚å½“æ— æ³•æ‰¾åˆ°æŒ‡å®šä¸»æœºçš„IPåœ°å€æ—¶ï¼Œæˆ–è€…ä¸ºå…¨å±€IPv6åœ°å€æŒ‡å®šèŒƒå›´æ ‡è¯†ç¬¦æ—¶æŠ›å‡ºUnknownHostExceptionã€‚</li>
  <li>InetAddress getByAddress(byte[] addr) è¿”å›ç»™å®š raw IP addressçš„InetAddresså¯¹è±¡ã€‚æ•°ç»„éµå¾ªç½‘ç»œå­—èŠ‚é¡ºåºï¼ˆæœ€é‡è¦çš„å­—èŠ‚æ˜¯ç¬¬ä¸€ä½çš„ï¼‰ã€‚ IPv4å¿…é¡»4å­—èŠ‚ï¼ŒIPv6å¿…é¡»16å­—èŠ‚ã€‚</li>
  <li>InetAddress getByAddress(String hostName, byte[] ipAddress)</li>
  <li>InetAddress getByName(String host) è¿”å›ä¸€ä¸ªInetAddresså®ä¾‹åŸºäºhostï¼Œhostå¯èƒ½æ˜¯ä¸ªmachine nameï¼ˆsuch as â€œtutortutor.caâ€ï¼‰æˆ–è€…å®ƒçš„IPåœ°å€çš„æ–‡æœ¬è¡¨ç¤ºã€‚</li>
  <li>InetAddress getLocalHost() è¿”å› local hostã€‚ 127.0.0.1 (IPv4) or ::1 (IPv6)</li>
</ul>

<p>è·å¾—InetAddresså¯¹è±¡åï¼Œè°ƒç”¨getAddress()è¿”å›raw IPï¼Œä»¥åŠboolean isLoopbackAddress()ï¼Œä»£è¡¨æ˜¯ä¸æ˜¯ loopback addressã€‚</p>

<p>Java 1.4 å¼•å…¥æŠ½è±¡ç±»SocketAddressï¼Œä»£è¡¨with no protocol attachmentçš„socket addressï¼ˆè¿™ä¸ªç±»çš„åˆ›å»ºè€…å¯èƒ½å·²ç»é¢„æ–™åˆ°Javaæœ€ç»ˆä¼šæ”¯æŒä½çº§åˆ«çš„é€šä¿¡åè®®è€Œä¸æ˜¯å¹¿å—æ¬¢è¿çš„äº’è”ç½‘åè®®ï¼‰ã€‚</p>

<p>SocketAddressè¢«å­ç±»InetSocketAddressç»§æ‰¿ï¼ŒæŠŠsocket addressè¡¨ç¤ºä¸º IP address and a port numberã€‚å®ƒè¿˜å¯ä»¥è¡¨ç¤ºä¸»æœºåå’Œç«¯å£å·ï¼Œå¹¶å°è¯•è§£æä¸»æœºåã€‚</p>

<p>è°ƒç”¨InetSocketAddress(InetAddress addr, int port)è·å–InetSocketAddresså®ä¾‹ã€‚ç„¶åè°ƒç”¨ InetAddress getAddress() and int getPort() ç­‰æ–¹æ³•ã€‚</p>

<h3 id="socket-options">Socket Options</h3>

<p>Socketåç¼€ç±»çš„å®ä¾‹å…±äº«å¥—æ¥å­—é€‰é¡¹çš„æ¦‚å¿µï¼Œæ˜¯é…ç½®å¥—æ¥å­—è¡Œä¸ºçš„å‚æ•°ã€‚Socket optionsæ˜¯å£°æ˜åœ¨SocketOptionsæ¥å£çš„å¸¸æ•°ï¼š</p>

<ul>
  <li>
    <p>IP_MULTICAST_IF:ç”¨äºç¡®å®šç»„æ’­ï¼ˆmulticastï¼‰çš„ç½‘ç»œæ¥å£ã€‚é€‰é¡¹å€¼ç±»å‹ä¸º<code class="language-plaintext highlighter-rouge">InetAddress</code></p>
  </li>
  <li>
    <p>IP_MULTICAST_IF2:åŒ#IP_MULTICAST_IFï¼Œä½†æ˜¯å¯ä»¥è®¾IPV4æˆ–IPV6åœ°å€ã€‚</p>
  </li>
  <li>
    <p>IP_MULTICAST_LOOP:è¿™ä¸ªé€‰é¡¹ç”¨äºç»„æ’­ã€‚å…¶ä¸­â€œlocal loopbackâ€çš„æ„æ€æ˜¯ç»„æ’­åŒ…ä¼šåŒæ—¶å‘é€ç»™è‡ªå·±ï¼ˆå³å‘é€æ–¹å¯ä»¥æ”¶åˆ°è‡ªå·±å‘å‡ºå»çš„æ•°æ®ï¼‰ã€‚</p>
  </li>
  <li>
    <p>IP_TOS:ç”¨äºè®¾ç½®IPåŒ…TOSéƒ¨åˆ†çš„å€¼ã€‚UDPå¯ä»¥åœ¨bindä¹‹åä»»æ„æ›´æ”¹è®¾ç½®ï¼ŒTCPåœ¨bindå‰è®¾ç½®ã€‚</p>
  </li>
  <li>
    <p>SO_BINDADDR:</p>

    <ul>
      <li>åªèƒ½é€šè¿‡<code class="language-plaintext highlighter-rouge">getOption</code>è¯»å–ï¼Œä¸èƒ½é€šè¿‡<code class="language-plaintext highlighter-rouge">setOption</code>è®¾ç½®ã€‚å› ä¸ºåœ°å€ç»‘å®šå‘ç”Ÿåœ¨Socketåˆå§‹åŒ–çš„æ—¶å€™ï¼Œåé¢å°±ä¸èƒ½æ›´æ”¹äº†ã€‚</li>
      <li>é»˜è®¤å€¼ä¸º<code class="language-plaintext highlighter-rouge">INADDR_ANY</code>ã€‚å¦‚æœç”¨äºServerSocketï¼Œå³åœ¨â€œmulti-homed hostï¼ˆåŒä¸€ä¸»æœºä¸Šæœ‰å¤šä¸ªç½‘ç»œåœ°å€ï¼‰â€çš„æƒ…å†µä¸‹ï¼Œsocketæ¥æ”¶æ‰€æœ‰ç½‘ç»œæ¥å£å‘è¿‡æ¥çš„æ•°æ®ã€‚è®¾ç½®äº†æŒ‡å®šçš„Addressï¼Œé‚£ä¹ˆå°±æ¥æ”¶æŒ‡å®šæ¥å£çš„æ•°æ®ï¼›å¦‚æœç”¨äºSocketï¼Œè®¾ç½®äº†æŒ‡å®šçš„Addressè¡¨ç¤ºå‘è¯¥åœ°å€å‘é€æ•°æ®ã€‚</li>
      <li>è¯¥é€‰é¡¹å€¼çš„ç±»å‹ä¸º<code class="language-plaintext highlighter-rouge">InetAddress</code></li>
    </ul>
  </li>
  <li>
    <p>SO_BROADCAST:å†³å®šäº†socketæ˜¯å¦å¯ä»¥å‘å¹¿æ’­ã€‚ä»…ç”¨äºæ”¯æŒå¹¿æ’­çš„ç½‘ç»œã€‚</p>
  </li>
  <li>
    <p>SO_KEEPALIVE:å¯ç”¨æ—¶ï¼Œå½“tcpè¿æ¥ä¸­æ²¡æœ‰æ•°æ®æµåŠ¨è¶…è¿‡2å°æ—¶æ—¶ï¼Œç³»ç»Ÿä¸»åŠ¨å‘é€ä¸€ä¸ªkeepaliveæ¢å¯»åŒ…ï¼ˆprobeï¼‰ç»™å¯¹æ–¹ï¼Œå¯¹æ–¹å¿…é¡»å“åº”è¿™ä¸ªåŒ…ã€‚æ”¶åˆ°ackçš„æ—¶å€™è¡¨ç¤ºè¿æ¥æ­£å¸¸ã€‚æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶è§†ä¸ºè¿æ¥å…³é—­ï¼š1ã€å¯¹æ–¹è¿”å›äº†RSTï¼›2ã€å¯¹æ–¹æ²¡æœ‰ä»»ä½•è¿”å›ã€‚</p>
  </li>
  <li>
    <p>SO_LINGER:è®¾ç½®äº†ä¸€ä¸ªå¤§äº0çš„å€¼ç»™<code class="language-plaintext highlighter-rouge">SO_LINGER</code>ï¼Œè¡¨ç¤ºå½“å…³é—­è¿™ä¸ªTCP socketæ—¶ï¼Œå¦‚æœå‘é€é˜Ÿåˆ—é‡Œè¿˜æœ‰æ•°æ®ï¼Œé‚£ä¹ˆ<strong>å µå¡</strong>ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆ linger intervalï¼‰ã€‚å¦‚æœè¶…æ—¶äº†ï¼Œé‚£ä¹ˆå¼ºåˆ¶å…³é—­è¿æ¥ã€‚è®¾ç½®ç­‰äº0 çš„å€¼è¡¨ç¤ºç›´æ¥å¼ºåˆ¶å…³é—­è¿æ¥ã€‚è¶…æ—¶ä¸Šé™ä¸º65535ã€‚</p>
  </li>
  <li>
    <p>SO_OOBINLINE:è¯¥é€‰é¡¹é»˜è®¤disableï¼Œå½“enableæ—¶ï¼Œè¡¨ç¤ºurgent dataç›´æ¥åœ¨æ¥æ”¶æ–¹read()æ“ä½œä¸­è¿”å›ï¼ˆå’Œæ™®é€šæ•°æ®æ··åœ¨ä¸€èµ·ï¼‰ï¼Œ å¦åˆ™æ¥æ”¶æ–¹ç›´æ¥å¿½ç•¥è¯¥æ•°æ®ã€‚</p>
  </li>
  <li>
    <p>SO_RCVBUF: è®¾ç½®<code class="language-plaintext highlighter-rouge">SO_RCVBUF</code>è¡¨ç¤ºå‘å†…æ ¸å»ºè®®socketæ¥æ”¶ç¼“å†²åŒºçš„å¤§å°ã€‚è·å–<code class="language-plaintext highlighter-rouge">SO_RCVBUF</code>ä¸€å®šè¿”å›å®é™…æ¥æ”¶ç¼“å†²åŒºçš„å¤§å°ã€‚å•ä½å­—èŠ‚ã€‚</p>
  </li>
  <li>
    <p>SO_REUSEADDR:ä»…ç”¨äº<code class="language-plaintext highlighter-rouge">DatagramSocket</code>ï¼ˆUDPï¼‰ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªç«¯å£é‡Šæ”¾åä¼šç­‰å¾…ä¸¤åˆ†é’Ÿä¹‹åæ‰èƒ½å†è¢«ä½¿ç”¨ï¼ŒSO_REUSEADDRæ˜¯è®©ç«¯å£é‡Šæ”¾åç«‹å³å°±å¯ä»¥è¢«å†æ¬¡ä½¿ç”¨ã€‚</p>
  </li>
  <li>
    <p>SO_SNDBUF:è®¾ç½®<code class="language-plaintext highlighter-rouge">SO_SNDBUF</code>è¡¨ç¤ºå‘å†…æ ¸å»ºè®®socketå‘é€ç¼“å†²åŒºçš„å¤§å°ã€‚è·å–<code class="language-plaintext highlighter-rouge">SO_SNDBUF</code>ä¸€å®šè¿”å›å®é™…å‘é€ç¼“å†²åŒºçš„å¤§å°ã€‚å•ä½å­—èŠ‚ã€‚</p>
  </li>
  <li>
    <p>SO_TIMEOUT:<code class="language-plaintext highlighter-rouge">SO_TIMEOUT</code>é€‰é¡¹ç”¨äºå¯¹read()æ“ä½œè®¾ç½®timeoutï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚å½“timeoutå‘ç”Ÿæ—¶ï¼Œä¼šæŠ›å‡ºInterruptedIOExceptionã€‚è®¾ç½®ä¸å¤§äº0çš„å€¼ä¼šä»¤read()æ“ä½œæ°¸è¿œå µå¡ã€‚</p>
  </li>
  <li>
    <p>TCP_NODELAY:çº³æ ¼ç®—æ³•ï¼ˆNagleâ€™s algorithmï¼‰çš„å·¥ä½œæ–¹å¼æ˜¯åˆå¹¶(coalescing)ä¸€å®šæ•°é‡çš„è¾“å‡ºèµ„æ–™åä¸€æ¬¡é€å‡ºã€‚ å½“æŸapplicationä¸æ–­åœ°å‘é€å°å•ä½çš„æ•°æ®æ—¶ï¼Œtcpä¼šç¼“å­˜ä¸€å®šé‡çš„æ•°æ®å†è¿›è¡Œå‘é€ã€‚å…·ä½“ç®—æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if there is new data to send
  if the window size &gt;= MSS and available data is &gt;= MSS
    send complete MSS segment now
  else
    if there is unconfirmed data still in the pipe
      enqueue data in the buffer until an acknowledge is received
    else
      send data immediately
    end if
  end if
end if
</code></pre></div>    </div>

    <p>æ³¨ï¼šæŒ‰ç…§ç®—æ³•ï¼Œæ˜¯å°šæœªæ”¶åˆ°å‰ä¸€æ¬¡ackæˆ–æœªè¾¾åˆ°æŒ‡å®šç´¯ç§¯å¤§å°å‰ç¼“å­˜æ¥ä¸‹æ¥çš„æ•°æ®ã€‚<strong>TCPä¸“ç”¨</strong> ç»¼ä¸Šï¼Œ<code class="language-plaintext highlighter-rouge">TCP_NODELAY</code>å¦‚æœä¸ºtrueï¼Œé‚£ä¹ˆæ•°æ®å°±ä¸è¿›è¡Œç¼“å­˜ï¼ˆç­‰å¾…ä¸Šä¸€ä¸ªackæˆ–è¾¾åˆ°æŒ‡å®šç´¯ç§¯å¤§å°ï¼‰ã€‚</p>
  </li>
</ul>

<p>SocketOptionså£°æ˜äº†get setæ–¹æ³•ã€‚ï¼š</p>

<ul>
  <li>void setOption(int optID, Object value)</li>
  <li>Object getOption(int optID)</li>
</ul>

<p>ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œä½¿ç”¨Socketåç¼€ç±»çš„çº¿ç¨‹å®‰å…¨æ–¹æ³•ã€‚</p>

<h3 id="socket-and-serversocket">Socket and ServerSocket</h3>

<p>Socket and ServerSocket classesæ”¯æŒå®¢æˆ·ç«¯è¿›ç¨‹ä¹‹é—´ï¼ˆæ¯”å¦‚åœ¨å¹³æ¿ç”µè„‘ä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºï¼‰å’ŒæœåŠ¡ç«¯è¿›ç¨‹ä¹‹é—´çš„åŸºäºtcpçš„é€šä¿¡ã€‚å› ä¸ºSocketå’Œjava.io.InputStream and java.io.OutputStreamç±»å…³è”ï¼ŒåŸºäºSocketç±»çš„socketsé€šå¸¸è¢«ç§°ä¸ºstream socketsã€‚</p>

<p>Socketæ”¯æŒå®¢æˆ·ç«¯socketsçš„åˆ›å»ºã€‚ä¸‹é¢æœ‰å…¶ä¸­2ä¸ªæ„é€ å™¨ï¼š</p>

<ul>
  <li>Socket(InetAddress dstAddress, int dstPort) åˆ›å»ºstream socketï¼Œè¿æ¥åˆ°æŒ‡å®šIPçš„ç«¯å£ã€‚ç«¯å£0 through 65535ã€‚</li>
  <li>Socket(String dstName, int dstPort)</li>
</ul>

<p>Socketå®ä¾‹åˆ›å»ºåï¼Œåœ¨remote host socket addressçš„è¿æ¥å»ºç«‹å‰ï¼Œå®ƒè¢«ç»‘å®šåˆ°ä»»æ„çš„local host socket addressã€‚<em>Binding</em>ä½¿ client socket addresså¯¹ server socketå¯ç”¨ï¼Œç„¶åserverè¿›ç¨‹å¯ä»¥é€šè¿‡server socketå’Œå®¢æˆ·ç«¯è¿›ç¨‹äº¤æµã€‚</p>

<p>Socketæä¾›é¢å¤–æ„é€ å™¨ï¼Œæ¯”å¦‚Socket()æœªç»‘å®šï¼ŒSocket(Proxy proxy)æœªè¿æ¥ã€‚è¦ä½¿ç”¨è¿™äº›ï¼Œå¿…é¡»ç»‘å®šåˆ°æœ¬åœ° socket addressesï¼Œè°ƒç”¨void bind(SocketAddress localAddr)ï¼Œç„¶åå¿…é¡»è¿æ¥ï¼Œè°ƒç”¨ connect()æ–¹æ³•ã€‚</p>

<p><strong>Note</strong>ï¼šproxyæ˜¯ä¸€ä¸ªhostï¼Œä¸ºäº†å®‰å…¨ç›®çš„ï¼Œå¤„äºå†…éƒ¨ç½‘å’ŒInternetä¹‹é—´ã€‚ Proxy settingsé€šè¿‡Proxyç±»çš„å®ä¾‹æ¥è¡¨ç¤ºï¼Œå¸®åŠ©å¥—æ¥å­—é€šè¿‡ä»£ç†è¿›è¡Œé€šä¿¡ã€‚</p>

<p>å¦ä¸€ä¸ªæ„é€ å™¨Socket(InetAddress dstAddress, int dstPort, InetAddress localAddr, int localPort)ï¼ŒæŒ‡å®šlocal host socket addressï¼Œç„¶åè¿æ¥æŒ‡å®šIPç«¯å£ã€‚</p>

<p>åˆ›å»ºå®ä¾‹åï¼Œå¯èƒ½åœ¨å®ä¾‹ä¸Šè°ƒç”¨ bind() and connect()ï¼Œè°ƒç”¨Socketâ€™s InputStream getInputStream() and OutputStream getOutputStream()ç”¨äºè¯»å†™ã€‚ä¸éœ€è¦I/Oçš„æ—¶å€™è°ƒç”¨Socketâ€™s void close()å…³é—­socketã€‚</p>

<p>ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•åœ¨æœ¬åœ°ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªç»‘å®šåˆ°9999çš„socketï¼Œç„¶åè®¿é—®å®ƒçš„è¾“å…¥å’Œè¾“å‡ºæµâ€”â€”ä¸ºäº†ç®€æ´èµ·è§ï¼Œå¿½ç•¥äº†å¼‚å¸¸ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">9999</span><span class="o">);</span>
<span class="nc">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
<span class="nc">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
<span class="c1">// Do some work with the socket.</span>
<span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div>

<p>ServerSocketæ”¯æŒæœåŠ¡ç«¯socketsçš„åˆ›å»ºï¼Œ4ä¸ªæ„é€ å™¨ï¼š</p>

<ul>
  <li>ServerSocket() åˆ›å»ºæœªç»‘å®šçš„server socketã€‚ä½ å¯ä»¥æŠŠå®ƒç»‘å®šåˆ°æŒ‡å®šsocket addressã€‚Bindingä½¿server socket addresså¯¹å®¢æˆ·ç«¯socketå¯ç”¨ã€‚</li>
  <li>ServerSocket(int port)åˆ›å»ºserver socketç»‘å®šåˆ°æŒ‡å®šç«¯å£å’Œä¸ä¸»æœºçš„ä¸€ä¸ªnicç›¸å…³è”çš„IPåœ°å€ã€‚ä¼ 0ä¼šé€‰æ‹©ä»»æ„çš„ç«¯å£ã€‚getLocalPort()è·å–ã€‚æ¥è‡ªå®¢æˆ·ç«¯çš„ä¼ å…¥çš„è¿æ¥è¯·æ±‚çš„æœ€å¤§é˜Ÿåˆ—é•¿åº¦ä¸º50ã€‚queueæ»¡äº†ï¼Œè¿æ¥è¢«æ‹’ç»ã€‚</li>
  <li>ServerSocket(int port, int backlog) è®¾ç½®ä¼ å…¥è¿æ¥çš„maximum queue length</li>
  <li>ServerSocket(int port, int backlog, InetAddress localAddress) æŒ‡å®š IP addressã€‚å¤šç½‘å¡æ—¶æœ‰ç”¨ã€‚</li>
</ul>

<p>server socketåˆ›å»ºåï¼Œserveråº”ç”¨å¼€å§‹å¾ªç¯ï¼Œå…ˆè°ƒç”¨Socket accept()ç›‘å¬è¿æ¥è¯·æ±‚ã€‚ç„¶åé€šä¿¡ï¼Œæœ€åå…³é—­ã€‚</p>

<p><strong>Note</strong>ï¼š ServerSocketå£°æ˜ close()æ¥å…³é—­server socket ã€‚åº”ç”¨ç»ˆæ­¢ä¼šè‡ªåŠ¨å…³é—­æœªå…³é—­çš„socketã€‚</p>

<p>ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å¥—æ¥å­—ï¼Œå®ƒè¢«ç»‘å®šåˆ°å½“å‰ä¸»æœºä¸Šçš„9999ç«¯å£ï¼Œç›‘å¬ä¼ å…¥çš„è¿æ¥è¯·æ±‚ï¼Œè¿”å›å®ƒä»¬çš„å¥—æ¥å­—ï¼Œåœ¨è¿™äº›å¥—æ¥å­—ä¸Šæ‰§è¡Œå·¥ä½œï¼Œå¹¶å…³é—­socket;ä¸ºäº†ç®€æ´èµ·è§ï¼Œå¿½ç•¥äº†å¼‚å¸¸ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ServerSocket</span> <span class="n">ss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="mi">9999</span><span class="o">);</span>
<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="o">{</span>
 <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
 <span class="c1">// obtain socket input/output streams and communicate with socket</span>
 <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span>

</code></pre></div></div>

<p>accept()æ–¹æ³•è°ƒç”¨åœ¨è¿æ¥å¯ç”¨ä¹‹å‰é˜»å¡ï¼Œç„¶åè¿”å› Socket objectå’Œå®¢æˆ·ç«¯é€šä¿¡ã€‚</p>

<p>è¿™ä¸ªä¾‹å­å‡è®¾å¥—æ¥å­—é€šä¿¡å‘ç”Ÿåœ¨æœåŠ¡å™¨åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹ä¸Šï¼Œå½“å¤„ç†éœ€è¦æ—¶é—´æ¥æ‰§è¡Œæ—¶ï¼Œå› ä¸ºæœåŠ¡å™¨å“åº”æ—¶é—´å¯¹ä¼ å…¥çš„è¿æ¥è¯·æ±‚å‡å°‘æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚</p>

<p>ä¸ºäº†æé«˜å“åº”æ—¶é—´ï¼Œé€šå¸¸éœ€è¦ä¸workerçº¿ç¨‹ä¸Šçš„socketè¿›è¡Œé€šä¿¡ã€‚å¦‚ä¸‹é¢çš„ä¾‹å­æ‰€ç¤ºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ServerSocket</span> <span class="n">ss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="mi">9999</span><span class="o">);</span>
<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="o">{</span>
 <span class="kd">final</span> <span class="nc">Socket</span> <span class="n">s</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
 <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span>
 <span class="o">{</span>
 <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span>
 <span class="o">{</span>
 <span class="c1">// obtain socket input/output streams and</span>
 <span class="c1">// communicate with socket</span>
 <span class="k">try</span> <span class="o">{</span> <span class="n">s</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{}</span>
 <span class="o">}</span>
 <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ¯æ¬¡è¿æ¥è¯·æ±‚åˆ°æ¥ï¼Œaccept()è¿”å›Socketå®ä¾‹ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹ä¸Šè®¿é—®socketå’Œä½¿ç”¨socketé€šä¿¡ã€‚</p>

<p>Iâ€™ve created EchoClient and EchoServer applications that demonstrate Socket and ServerSocket. Listing B-1 presents EchoClientâ€™s source code.</p>

<p><strong><em>Listing B-1. Echoing Data to and Receiving It Back from a Server</em></strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import java.io.*;
import java.net.Inet4Address;
import java.net.Socket;

/**
 * @author @Jasu
 * @date 2018-09-26 17:28
 */
public class EchoClient {
    public static void main(String[] args) {
        try {
            Socket socket = new Socket(Inet4Address.getLocalHost(), 34343);
            OutputStream os = socket.getOutputStream();
            OutputStreamWriter writer = new OutputStreamWriter(os);
            PrintWriter pw = new PrintWriter(writer);
            pw.println("66666");
            pw.flush();
            InputStream is = socket.getInputStream();
            InputStreamReader isr = new InputStreamReader(is);
            BufferedReader br = new BufferedReader(isr);
            System.out.println(br.readLine());
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre></div></div>

<p><strong>Note</strong>ï¼šé•¿æ—¶é—´è¿è¡Œçš„åº”ç”¨è¦æ˜¾ç¤ºclose socketã€‚</p>

<p>server</p>

<p><strong><em>Listing B-2. Receiving Data from and Echoing It Back to a Client</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Inet4Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-26 17:37
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Starting echo server..."</span><span class="o">);</span>


        <span class="nc">ServerSocket</span> <span class="n">ss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="mi">34343</span><span class="o">,</span> <span class="mi">50</span><span class="o">,</span> <span class="nc">Inet4Address</span><span class="o">.</span><span class="na">getLocalHost</span><span class="o">());</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Socket</span> <span class="n">s</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
                <span class="nc">InputStreamReader</span> <span class="n">isr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>
                <span class="nc">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="n">isr</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
                <span class="nc">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
                <span class="nc">OutputStreamWriter</span> <span class="n">osw</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">os</span><span class="o">);</span>
                <span class="nc">PrintWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">osw</span><span class="o">);</span>
                <span class="n">writer</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
                <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">s</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span><span class="c1">//should not happen in this context</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="datagramsocket-and-multicastsocket">DatagramSocket and MulticastSocket</h3>

<p>DatagramSocket and MulticastSocketç±»è®©ä½ æ‰§è¡ŒUDPé€šä¿¡ã€‚</p>

<p>DatagramPacketæ„é€ ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">100</span><span class="o">];</span>
<span class="nc">DatagramPacket</span> <span class="n">dgp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatagramPacket</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</code></pre></div></div>

<p>DatagramSocketæè¿°äº†ç”¨äºå®¢æˆ·ç«¯æˆ–è€…æœåŠ¡ç«¯UDPè¿æ¥çš„socketã€‚</p>

<p>Listing B-3 demonstrates DatagramPacket and DatagramSocket in a server
context.</p>

<p><strong><em>Listing B-3. Receiving Datagram Packets from and Echoing Them Back to ClientsListing B-3. Receiving Datagram Packets from and Echoing Them Back to Clients</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.DatagramPacket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.DatagramSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.SocketException</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-27 10:46
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DGServer</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SocketException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server is starting"</span><span class="o">);</span>
        <span class="nc">DatagramSocket</span> <span class="n">dgs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatagramSocket</span><span class="o">(</span><span class="no">PORT</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Send buffer size = "</span> <span class="o">+</span>
                    <span class="n">dgs</span><span class="o">.</span><span class="na">getSendBufferSize</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Receive buffer size = "</span> <span class="o">+</span>
                    <span class="n">dgs</span><span class="o">.</span><span class="na">getReceiveBufferSize</span><span class="o">());</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">50</span><span class="o">];</span>
            <span class="nc">DatagramPacket</span> <span class="n">dgp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatagramPacket</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">dgs</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">dgp</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">data</span><span class="o">));</span>
                <span class="n">dgs</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">dgp</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>è™½ç„¶å¯ä»¥è°ƒç”¨void setReceiveBufferSize(int size) and void setSendBufferSize(int size)æŒ‘æ•´buffer sizeã€‚æ¥æé«˜æ€§èƒ½ã€‚ä½†å¯¹äºUDPæœ‰ä¸€ä¸ªå®é™…çš„é™åˆ¶ã€‚å¯ä»¥è¢«å‘é€æ¥æ”¶çš„UDPåŒ…æœ€å¤§ä¸º65,507å­—èŠ‚ï¼Œåœ¨IPV4ï¼Œå®ƒæ¥è‡ªäºä»65,535ä¸­å‡å»8å­—èŠ‚çš„UDPå¤´å’Œ20å­—èŠ‚çš„IPå¤´å€¼</p>
</blockquote>

<p>Listing B-4 demonstrates DatagramPacket and DatagramSocket in a client
context.
<strong><em>Listing B-4. Sending a Datagram Packet to and Receiving It Back from a Server</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.DatagramPacket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.DatagramSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.SocketException</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-27 11:06
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DGClient</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">10001</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">ADDR</span> <span class="o">=</span> <span class="s">"localhost"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SocketException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"client is starting"</span><span class="o">);</span>
        <span class="nc">DatagramSocket</span> <span class="n">dgs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatagramSocket</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span><span class="o">;</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="s">"Send me a datagram"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>

            <span class="nc">InetAddress</span> <span class="n">ia</span> <span class="o">=</span> <span class="nc">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="no">ADDR</span><span class="o">);</span>
            <span class="nc">DatagramPacket</span> <span class="n">dgp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatagramPacket</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="nc">InetAddress</span><span class="o">.</span><span class="na">getLocalHost</span><span class="o">(),</span> <span class="no">PORT</span><span class="o">);</span>
            <span class="n">dgs</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">dgp</span><span class="o">);</span>

            <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer2</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">100</span><span class="o">];</span>
            <span class="n">dgp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatagramPacket</span><span class="o">(</span><span class="n">buffer2</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="nc">InetAddress</span><span class="o">.</span><span class="na">getLocalHost</span><span class="o">(),</span> <span class="no">PORT</span><span class="o">);</span>
            <span class="n">dgs</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">dgp</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">buffer2</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>MulticastSocketç±»æè¿°äº†åŸºäºUDPçš„å¤šæ’­ä¼šè¯ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>							WHAT IS MULTICASTING?
å‰é¢çš„ä¾‹å­å·²ç»æ¼”ç¤ºäº†å•æ’­ï¼Œå½“æœåŠ¡å™¨å‘å•ä¸ªå®¢æˆ·ç«¯å‘é€ä¸€æ¡æ¶ˆæ¯æ—¶å‘ç”Ÿã€‚ç„¶è€Œï¼Œä¹Ÿæœ‰å¯èƒ½å‘å¤šä¸ªå®¢æˆ·å¹¿æ’­ç›¸åŒçš„ä¿¡æ¯ã€‚


IPv4 addresses 224.0.0.1 to 239.255.255.255 (inclusive) are reserved for use as multicast
group addresses.
</code></pre></div></div>

<p>Listing B-5 presents a multicasting server.
<strong><em>Listing B-5. Multicasting Datagram Packets</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.DatagramPacket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.MulticastSocket</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-27 13:49
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MCServer</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">MulticastSocket</span> <span class="n">multicastSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MulticastSocket</span><span class="o">();</span>
            <span class="nc">InetAddress</span> <span class="n">group</span> <span class="o">=</span> <span class="nc">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="s">"231.0.0.1"</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">dummy</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
            <span class="nc">DatagramPacket</span> <span class="n">dp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatagramPacket</span><span class="o">(</span><span class="n">dummy</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">group</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">(</span><span class="s">"line "</span> <span class="o">+</span> <span class="n">i</span><span class="o">).</span><span class="na">getBytes</span><span class="o">();</span>
                <span class="n">dp</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                <span class="n">dp</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                <span class="n">multicastSocket</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">dp</span><span class="o">);</span>
                <span class="n">i</span><span class="o">++;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.DatagramPacket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.MulticastSocket</span><span class="o">;</span>

<span class="cm">/**
 * @author @Jasu
 * @date 2018-09-27 13:54
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MCClient</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">MulticastSocket</span> <span class="n">mcs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MulticastSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
            <span class="nc">InetAddress</span> <span class="n">group</span> <span class="o">=</span> <span class="nc">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="s">"231.0.0.1"</span><span class="o">);</span>
            <span class="n">mcs</span><span class="o">.</span><span class="na">joinGroup</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">256</span><span class="o">];</span>
                <span class="nc">DatagramPacket</span> <span class="n">dgp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatagramPacket</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                <span class="n">mcs</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">dgp</span><span class="o">);</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer2</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">dgp</span><span class="o">.</span><span class="na">getLength</span><span class="o">()];</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">dgp</span><span class="o">.</span><span class="na">getData</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">buffer2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">dgp</span><span class="o">.</span><span class="na">getLength</span><span class="o">());</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">buffer2</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="n">mcs</span><span class="o">.</span><span class="na">leaveGroup</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="network-interfaces">Network Interfaces</h3>

<p>ç•¥</p>
:ET