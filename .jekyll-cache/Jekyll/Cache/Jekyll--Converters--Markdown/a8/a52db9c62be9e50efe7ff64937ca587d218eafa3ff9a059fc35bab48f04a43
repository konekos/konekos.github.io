I"H´<p>æœ¬æ–‡ä»‹ç» Dubbo çš„åŠ è½½æœºåˆ¶ï¼Œå¹¶ä¸ JDK åŠ è½½æœºåˆ¶å¯¹æ¯”ã€‚åŠ @SPIã€@Adaptiveã€@Activite æ³¨è§£ã€‚ä»¥åŠæ ¸å¿ƒç±» ExtensionLoader æµç¨‹ä¸åŸç†ã€‚ä»¥åŠä½¿ç”¨çš„ç±»åŠ¨æ€ç¼–è¯‘å®ç°åŸç†ã€‚</p>

<p>æœ¬æ–‡æŠ„è‡ªã€Šæ·±å…¥ç†è§£ Apache Dubbo å’Œå®æˆ˜ã€‹ã€‚ä½†ç›¸å…³ä»£ç éƒ¨åˆ†ä¼šæ›´è¯¦ç»†ï¼Œè¯»è€…ä¹Ÿå¯ä»¥è‡ªè¡Œ fork æºç é˜…è¯»ã€‚æœ¬æ–‡ Dubbo æºç ç‰ˆæœ¬ä¸º 2.7.5ï¼Œä¸ªåˆ«åœ°æ–¹ä¼šå’ŒåŸç‰ˆä¹¦ä¸­æè¿°æœ‰å‡ºå…¥ã€‚</p>

<h1 id="ä¸€åŠ è½½æœºåˆ¶æ¦‚è¿°">ä¸€ã€åŠ è½½æœºåˆ¶æ¦‚è¿°</h1>

<p>Dubbo è‰¯å¥½çš„æ‰©å±•æ€§æ˜¯åŸºäº Dubbo SPI åŠ è½½æœºåˆ¶ä»¥åŠä½¿ç”¨åˆé€‚çš„è®¾è®¡æ¨¡å¼ï¼Œå®ç°äº†æ¡†æ¶çš„æ¥å£ä¸å®ç°å®Œå…¨çš„è§£è€¦ã€‚</p>

<p>Dubbo é»˜è®¤æä¾›äº†å¾ˆå¤šå¯ä»¥ç›´æ¥ä½¿ç”¨çš„æ‰©å±•ç‚¹ã€‚Dubbo å‡ ä¹æ‰€æœ‰åŠŸèƒ½ç»„ä»¶éƒ½æ˜¯åŸºäº SPI å®ç°çš„ï¼Œåç»­æ–‡ç« ä¼šè¯¦ç»†ä»‹ç»ã€‚</p>

<p>Dubbo SPI æ²¡æœ‰ç›´æ¥ä½¿ç”¨ Java SPIï¼Œè€Œæ˜¯åšäº†ä¸€å®šæ”¹è¿›ï¼Œå¹¶ä¸”å…¼å®¹ Java SPIã€‚æœåŠ¡å¯åŠ¨æ—¶ï¼ŒDubbo å°±ä¼šæŸ¥æ‰¾è¿™äº›æ‰©å±•ç‚¹çš„å…·ä½“å®ç°ã€‚Dubbo å¯åœåŸç†ä¼šåœ¨åç»­æ–‡ç« è®²è§£ã€‚</p>

<h2 id="11-java-spi">1.1 Java SPI</h2>

<p>Java SPIï¼Œå³ Service Provider Interfaceï¼Œèµ·åˆç”¨äºç»™å‚å•†åšæ’ä»¶å¼€å‘ã€‚</p>

<p>Java SPI æ˜¯ç­–ç•¥æ¨¡å¼ï¼Œä¸€ç§æ¥å£å¤šç§å®ç°ã€‚Java åªåˆ¶å®šæ¥å£ï¼ˆè§„èŒƒï¼‰ï¼Œå…·ä½“å®ç°ä¸åœ¨ç¨‹åºä¸­ç›´æ¥ç¡®å®šï¼Œè€Œå–å†³äºæ˜¯ç”±ç¨‹åºä¹‹å¤–çš„é…ç½®ï¼Œç”¨æ¥å®ç°å…·ä½“çš„è£…é…ã€‚ä¾‹å¦‚ï¼š</p>

<ol>
  <li>å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œå¦‚ com.test.spi.PrintService</li>
  <li>ç¼–å†™ä¸€ä¸ªæ¥å£çš„å®ç°ç±»</li>
  <li>åœ¨ META-INF/services/ç›®å½•ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªä»¥æ¥å£å…¨è·¯å¾„åçš„æ–‡ä»¶ com.test.spi.PrintService</li>
  <li>æ–‡ä»¶å†…å®¹ä¸ºå…¶å®ç°ç±»çš„å…¨è·¯å¾„åï¼Œå¦‚æœ‰å¤šä¸ªä½¿ç”¨åˆ†éš”ç¬¦åˆ†éš”</li>
  <li>ä»£ç ä¸­ä½¿ç”¨ java.util.ServiceLoader åŠ è½½å…·ä½“å®ç°ç±»ã€‚</li>
</ol>

<p>è¿™æ ·ä¾¿å®ç°äº†é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶æ¥å£çš„å…·ä½“å®ç°ç±»ã€‚</p>

<p>ä»£ç ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PrintService</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IPrintService</span> <span class="kd">implements</span> <span class="nc">PrintService</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// åœ¨ META-INF/services/ ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ºæ¥å£çš„å…¨è·¯å¾„åï¼Œå¦‚ com.test.spi.PrintService</span>
<span class="c1">// æ–‡ä»¶çš„å†…å®¹ä¸ºå®ç°ç±»çš„å…¨è·¯å¾„å</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JDKSPIDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ServiceLoader</span><span class="o">&lt;</span><span class="nc">PrintService</span><span class="o">&gt;</span> <span class="n">serviceLoader</span> <span class="o">=</span> <span class="nc">ServiceLoader</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">PrintService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">PrintService</span> <span class="n">printService</span> <span class="o">:</span> <span class="n">serviceLoader</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">printService</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"I print"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å› ä¸ºæˆ‘ä»¬åªé…ç½®äº†ä¸€ä¸ªå®ç°ç±»ï¼Œæ‰€ä»¥ä¼šæ‰“å°ä¸€æ¬¡ â€œI printâ€</p>

<h2 id="12-æ‰©å±•ç‚¹åŠ è½½æœºåˆ¶çš„æ”¹è¿›">1.2 æ‰©å±•ç‚¹åŠ è½½æœºåˆ¶çš„æ”¹è¿›</h2>

<p>Dubbo SPI åšäº†ä¸€å®šçš„æ”¹è¿›å’Œä¼˜åŒ–ï¼Œå®˜æ–¹æ–‡æ¡£å†…å®¹ï¼š</p>

<blockquote>
  <ol>
    <li>
      <p>JDK æ ‡å‡† SPI ä¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰å®ç°ï¼Œå¦‚æœæœ‰äº›å®ç°åŠ è½½å¾ˆè€—æ—¶è€Œä¸”ä¹Ÿæ²¡ç”¨ä¸Šï¼Œåˆ™æµªè´¹èµ„æºã€‚</p>
    </li>
    <li>å¦‚æœæ‰©å±•ç‚¹åŠ è½½å¤±è´¥ï¼Œè¿æ‰©å±•ç‚¹çš„åç§°éƒ½æ‹¿ä¸åˆ°äº†ã€‚æ¯”å¦‚ï¼šJDKæ ‡å‡†çš„ScriptEngineï¼Œé€šè¿‡getName();è·å–è„šæœ¬ç±»å‹çš„åç§°ï¼Œ ä½†å¦‚æœRubyScriptEngineå› ä¸ºæ‰€ä¾èµ–çš„jruby.jarä¸å­˜åœ¨ï¼Œå¯¼è‡´RubyScriptEngineç±»åŠ è½½å¤±è´¥ï¼Œè¿™ä¸ªå¤±è´¥åŸå› è¢«åƒæ‰ äº†ï¼Œå’Œrubyå¯¹åº”ä¸èµ·æ¥ï¼Œå½“ç”¨æˆ·æ‰§è¡Œrubyè„šæœ¬æ—¶ï¼Œä¼šæŠ¥ä¸æ”¯æŒrubyï¼Œè€Œä¸æ˜¯çœŸæ­£å¤±è´¥çš„åŸå› ã€‚</li>
    <li>å¢åŠ äº†å¯¹æ‰©å±•ç‚¹IoCå’ŒAOPçš„æ”¯æŒï¼Œä¸€ä¸ªæ‰©å±•ç‚¹å¯ä»¥ç›´æ¥setteræ³¨å…¥å…¶å®ƒæ‰©å±•ç‚¹ã€‚Java SPI çš„ ServiceLoader ä¼šæŠŠæ¥å£çš„æ‰€æœ‰å®ç°ç±»å…¨éƒ¨åˆå§‹åŒ–ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚Dubbo çš„ SPI åªæ˜¯è®°è½½äº†é…ç½®æ–‡ä»¶é‡Œçš„ç±»ï¼Œå¹¶ä¸”åˆ†æˆä¸åŒç±»å‹ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸”ä¸ä¼šç«‹åˆ»åˆå§‹åŒ–ï¼Œæ€§èƒ½ä¸Šæœ‰æ›´å¥½çš„è¡¨ç°ã€‚</li>
  </ol>
</blockquote>

<p>å°†ä¸Šé¢çš„ä¾‹å­æ”¹ä¸º Dubbo SPI</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ¥å£åŠ ä¸Š @SPI æ³¨è§£ï¼Œå®ç°ç±»ä¸å˜</span>
<span class="nd">@SPI</span><span class="o">(</span><span class="s">"impl"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PrintService</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// åœ¨ META-INF.dubbo.internal ä¸‹åˆ›å»ºåŒåæ–‡ä»¶ æ–‡ä»¶å†…å®¹ä¸º </span>
<span class="c1">// æ–‡ä»¶å†…å®¹ä¸º impl=com.test.spi.IPrintService  impl SPI æ³¨è§£ä¸Šçš„å€¼ï¼Œä»£è¡¨é»˜è®¤çš„å®ç°</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DubboSPIDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">PrintService</span> <span class="n">printService</span> <span class="o">=</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="nc">PrintService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getDefaultExtension</span><span class="o">();</span>
        <span class="n">printService</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"I print."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Java SPI åŠ è½½å¤±è´¥ï¼Œå¯èƒ½ä¼šå› ä¸ºå„ç§åŸå› å¯¼è‡´å¼‚å¸¸ä¿¡æ¯è¢«â€œåæ‰â€ï¼Œå¯¼è‡´è¿½è¸ªé—®é¢˜å›°éš¾ã€‚Dubbo SPI åŠ è½½å¤±è´¥æ—¶ï¼Œä¼šå…ˆæŠ›å‡ºçœŸå®å¼‚å¸¸å¹¶æ‰“å°æ—¥å¿—ã€‚</p>

<p>Dubbo SPI è‡ªå·±å®ç°äº† IoC å’Œ Aop æœºåˆ¶ã€‚ä¸€ä¸ªæ‰©å±•ç‚¹å¯ä»¥é€šè¿‡ setter ç›´æ¥æ³¨å…¥å…¶ä»–æ‰©å±•çš„æ–¹æ³•ï¼ŒT injectExtension(T instance) æ–¹æ³•å®ç°äº†è¿™ä¸ªåŠŸèƒ½ã€‚</p>

<p>å¦å¤–ï¼ŒDubbo æ”¯æŒåŒ…è£…æ‰©å±•ç±»ï¼Œæ¨èæŠŠé€šç”¨çš„æŠ½è±¡é€»è¾‘æ”¾åˆ°åŒ…è£…ç±»ä¸­ï¼Œç”¨äºå®ç°æ‰©å±•ç‚¹çš„ AOP ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼Œç±» ProtocolFilterWrapper åŒ…è£…ç±»æ‰©å±•äº† Protocolï¼Œ  é€šç”¨çš„é€»è¾‘åˆ¤æ–­å…¨éƒ¨æ”¾åœ¨äº† export æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨ Protocal çš„ export æ–¹æ³•ã€‚å’Œ Spring åŠ¨æ€ä»£ç†çš„æ€æƒ³æ˜¯ä¸€æ ·çš„ï¼Œåœ¨è¢«ä»£ç†ç±»çš„å‰åæ’å…¥è‡ªå·±çš„é€»è¾‘å¢å¼ºï¼Œæœ€ç»ˆè°ƒç”¨è¢«ä»£ç†ç±»ã€‚(å¯ä»¥è‡ªè¡Œç»“åˆä»£ç æŸ¥çœ‹)ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProtocolFilterWrapper</span> <span class="kd">implements</span> <span class="nc">Protocol</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Protocol</span> <span class="n">protocol</span><span class="o">;</span>
    <span class="o">...</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Exporter</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">export</span><span class="o">(</span><span class="nc">Invoker</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">invoker</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RpcException</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">UrlUtils</span><span class="o">.</span><span class="na">isRegistry</span><span class="o">(</span><span class="n">invoker</span><span class="o">.</span><span class="na">getUrl</span><span class="o">()))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">protocol</span><span class="o">.</span><span class="na">export</span><span class="o">(</span><span class="n">invoker</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">protocol</span><span class="o">.</span><span class="na">export</span><span class="o">(</span><span class="n">buildInvokerChain</span><span class="o">(</span><span class="n">invoker</span><span class="o">,</span> <span class="no">SERVICE_FILTER_KEY</span><span class="o">,</span> 		<span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PROVIDER</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="13-æ‰©å±•ç‚¹è§„èŒƒé…ç½®">1.3 æ‰©å±•ç‚¹è§„èŒƒé…ç½®</h2>

<table>
  <thead>
    <tr>
      <th>è§„èŒƒå</th>
      <th>è§„èŒƒè¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>SPI é…ç½®æ–‡ä»¶è·¯å¾„</td>
      <td>META-INF/services/ ï¼ˆå…¼å®¹JDKï¼‰ã€META-INF/dubbo/ã€META-INF/dubbo/internal</td>
    </tr>
    <tr>
      <td>SPI é…ç½®æ–‡ä»¶åç§°</td>
      <td>ç±»å…¨è·¯å¾„å</td>
    </tr>
    <tr>
      <td>æ–‡ä»¶å†…å®¹æ ¼å¼</td>
      <td>key=value æ–¹å¼ï¼Œå¤šä¸ªç”¨æ¢è¡Œç¬¦åˆ†éš”ï¼Œkey ä¼šç”¨ä½œ @SPI æ³¨è§£ä¸Šçš„ value</td>
    </tr>
  </tbody>
</table>

<h2 id="14-æ‰©å±•ç‚¹çš„åˆ†ç±»å’Œç¼“å­˜">1.4 æ‰©å±•ç‚¹çš„åˆ†ç±»å’Œç¼“å­˜</h2>

<p>Dubbo SPI å¯ä»¥åˆ†ä¸º Class ç¼“å­˜ã€å®ä¾‹ç¼“å­˜ã€‚è¿™ä¸¤ç§ç¼“å­˜åˆèƒ½æ ¹æ®æ‰©å±•ç±»çš„ç§ç±»åˆ†ä¸ºæ™®é€šæ‰©å±•ç±»ã€åŒ…è£…æ‰©å±•ç±»ï¼ˆWrapper ç±»ï¼‰ã€è‡ªé€‚åº”æ‰©å±•ç±»ï¼ˆAdaptiveï¼‰ç­‰ã€‚</p>

<ul>
  <li>Class ç¼“å­˜ï¼šDubbo SPI è·å–æ‰©å±•ç±»æ—¶ï¼Œå…ˆä¼šä»ç¼“å­˜ä¸­è¯»å–ã€‚å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œåˆ™åŠ è½½é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®é…ç½®æŠŠ Class ç¼“å­˜åˆ°å†…å­˜ï¼Œä¸ä¼šç›´æ¥å…¨éƒ¨åˆå§‹åŒ–ã€‚</li>
  <li>å®ä¾‹ç¼“å­˜ï¼šåŸºäºæ€§èƒ½è€ƒè™‘ï¼ŒDubbo æ¡†æ¶ä¸ä»…ç¼“å­˜ Classï¼Œä¹Ÿä¼šç¼“å­˜ Class å®ä¾‹åŒ–åçš„å¯¹è±¡ã€‚æ¯æ¬¡è·å–çš„æ—¶å€™ï¼Œçº¿ç¨‹ç¼“å­˜è·å–ï¼Œç¼“å­˜è¯»ä¸åˆ°ï¼Œé‡æ–°åŠ è½½å¹¶å†™å…¥ç¼“å­˜ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Dubbo SPI æ¯” Java SPI æ€§èƒ½å¥½çš„åŸå› ï¼ŒDubbo æ˜¯æŒ‰éœ€å®ä¾‹åŒ–ä¸”åšäº†ç¼“å­˜ã€‚</li>
</ul>

<p>è¢«ç¼“å­˜çš„ Class å’Œå¯¹è±¡å®ä¾‹å¯ä»¥æ ¹æ®ä¸åŒç‰¹æ€§åˆ†ä¸ºä¸åŒç±»åˆ«ï¼š</p>

<ol>
  <li>æ™®é€šæ‰©å±•ç±»ã€‚æœ€åŸºç¡€çš„ï¼ŒSPI é…ç½®æ–‡ä»¶ä¸­çš„ã€‚</li>
  <li>åŒ…è£…æ‰©å±•ç±»ã€‚è¿™ç§ Wrapper ç±»æ²¡æœ‰å…·ä½“çš„å®ç°ï¼Œåªæ˜¯åšäº†é€šç”¨é€»è¾‘çš„æŠ½è±¡ï¼Œéœ€è¦åœ¨æ„é€ æ–¹æ³•ä¸­ä¼ å…¥ä¸€ä¸ªå…·ä½“çš„æ‰©å±•æ¥å£çš„å®ç°ã€‚å±äº Dubbo çš„è‡ªåŠ¨åŒ…è£…ç‰¹æ€§ã€‚</li>
  <li>è‡ªé€‚åº”æ‰©å±•ç±»ã€‚ä¸€ä¸ªæ‰©å±•æ¥å£ä¼šæœ‰å¤šä¸ªå®ç°ç±»ï¼Œå…·ä½“ç”¨å“ªä¸ªå¯ä»¥ä¸å†™æ­»åœ¨ä»£ç æˆ–è€…é…ç½®é‡Œï¼Œå¯ä»¥é€šè¿‡ä¼ å…¥ URL   ä¸­çš„æŸäº›å‚æ•°åŠ¨æ€æ¥ç¡®å®šã€‚å±äºæ‰©å±•ç‚¹çš„è‡ªé€‚åº”ç‰¹æ€§ï¼Œ@Adaptive æ³¨è§£ã€‚</li>
  <li>å…¶ä»–ç¼“å­˜ï¼Œå¦‚æ‰©å±•ç±»åŠ è½½å™¨ç¼“å­˜ã€æ‰©å±•åç¼“å­˜ç­‰ã€‚</li>
</ol>

<p>æ‰©å±•ç±»ç¼“å­˜è¡¨ï¼šè§ä¸‹æ–‡ ExtensionLoader æºç ã€‚</p>

<h2 id="15-æ‰©å±•ç‚¹ç‰¹æ€§">1.5 æ‰©å±•ç‚¹ç‰¹æ€§</h2>

<p>ä»å®˜æ–¹æ–‡æ¡£å¾—çŸ¥ï¼Œæ‰©å±•ç±»ä¸€å…±åŒ…å«å››ç§ç‰¹æ€§ï¼šè‡ªåŠ¨åŒ…è£…ã€è‡ªåŠ¨åŠ è½½ã€è‡ªé€‚åº”å’Œè‡ªåŠ¨æ¿€æ´»ã€‚</p>

<h3 id="151-è‡ªåŠ¨åŒ…è£…"><strong>1.5.1 è‡ªåŠ¨åŒ…è£…</strong></h3>

<p>è‡ªåŠ¨åŒ…è£…æ˜¯ 1.4 ä¸­æåˆ°çš„ä¸€ç§è¢«ç¼“å­˜çš„æ‰©å±•ç±»ï¼ŒExtensionLoader åœ¨åŠ è½½æ‰©å±•æ—¶ï¼Œå¦‚æœå‘ç°è¿™ä¸ªæ‰©å±•ç±»åŒ…å«å…¶ä»–å…¶ä»–æ‰©å±•ç‚¹ä½œä¸ºæ„é€ å‚æ•°çš„å‚æ•°ï¼Œåˆ™è¿™ä¸ªæ‰©å±•ç±»å°±ä¼šè¢«è®¤ä¸ºæ˜¯ Wrapper ç±»ï¼Œå¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProtocolFilterWrapper</span> <span class="kd">implements</span> <span class="nc">Protocol</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Protocol</span> <span class="n">protocol</span><span class="o">;</span>
	
    <span class="c1">// å®ç°äº† Protocolï¼Œæ„é€ å‡½æ•°ä¸­åˆä¼ å…¥äº†ä¸€ä¸ª Protocol ç±»å‹çš„å‚æ•°ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨æ³¨å…¥</span>
    <span class="kd">public</span> <span class="nf">ProtocolFilterWrapper</span><span class="o">(</span><span class="nc">Protocol</span> <span class="n">protocol</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"protocol == null"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">;</span>
    <span class="o">}</span>
	<span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ProtocolFilterWrapper è™½ç„¶å®ç°äº† Protocol æ¥å£ï¼Œä½†æ„é€ å‡½æ•°åˆæ³¨å…¥äº†ä¸€ä¸ª Protocol ç±»å‹çš„å‚æ•°ã€‚è¿™æ · ProtocolFilterWrapper ä¼šè¢«è®¤å®šä¸º Wrapper ç±»ã€‚æ˜¯ä¸€ç§è£…é¥°å™¨æ¨¡å¼ï¼ŒæŠŠé€šç”¨çš„æŠ½è±¡é€»è¾‘è¿›è¡Œå°è£…æˆ–å¯¹å­ç±»è¿›è¡Œå¢å¼ºï¼Œè®©å­ç±»å¯ä»¥æ›´åŠ ä¸“æ³¨å…·ä½“çš„å®ç°ã€‚</p>

<h3 id="152-è‡ªåŠ¨åŠ è½½">1.5.2 è‡ªåŠ¨åŠ è½½</h3>

<p>é™¤äº†åœ¨æ„é€ å‡½æ•°ä¸­ä¼ å…¥å…¶ä»–æ‰©å±•å®ä¾‹ï¼Œæˆ‘ä»¬è¿˜ç»å¸¸ä½¿ç”¨ setter æ–¹æ³•è®¾ç½®å±æ€§å€¼ã€‚å¦‚æœæŸä¸ªæ‰©å±•ç±»æ˜¯å¦å¤–ä¸€ä¸ªæ‰©å±•ç‚¹çš„æˆå‘˜å±æ€§ï¼Œå¹¶æ‹¥æœ‰ setter æ–¹æ³•ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨æ³¨å…¥å¯¹åº”çš„æ‰©å±•ç‚¹å®ä¾‹ã€‚ExtensionLoader åœ¨æ‰§è¡Œæ‰©å±•ç‚¹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨é€šè¿‡ setter æ–¹æ³•æ³¨å…¥å¯¹åº”çš„å®ç°ç±»ã€‚è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ‰©å±•ç±»å±æ€§æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæœ‰å¤šç§å®ç°ï¼Œé‚£ä¹ˆå…·ä½“æ³¨å…¥å“ªä¸ªå‘¢ï¼Ÿè¿™æ¶‰åŠç¬¬ä¸‰ä¸ªç‰¹æ€§â€”â€”è‡ªé€‚åº”ã€‚</p>

<h3 id="153-è‡ªé€‚åº”">1.5.3 è‡ªé€‚åº”</h3>

<p>Dubbo SPI ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ @Adaptive æ³¨è§£ï¼Œå¯ä»¥åŠ¨æ€åœ°é€šè¿‡ URL ä¸­çš„å‚æ•°æ¥ç¡®å®šè¦ä½¿ç”¨å“ªä¸ªå…·ä½“çš„å®ç°ç±»ã€‚ä»è€Œè§£å†³è‡ªåŠ¨åŠ è½½ä¸­çš„å®ä¾‹æ³¨å…¥é—®é¢˜ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SPI</span><span class="o">(</span><span class="s">"netty"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Transporter</span> <span class="o">{</span>

    <span class="nd">@Adaptive</span><span class="o">({</span><span class="nc">Constants</span><span class="o">.</span><span class="na">SERVER_KEY</span><span class="o">,</span> <span class="nc">Constants</span><span class="o">.</span><span class="na">TRANSPORTER_KEY</span><span class="o">})</span>
    <span class="nc">RemotingServer</span> <span class="nf">bind</span><span class="o">(</span><span class="no">URL</span> <span class="n">url</span><span class="o">,</span> <span class="nc">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemotingException</span><span class="o">;</span>

    <span class="nd">@Adaptive</span><span class="o">({</span><span class="nc">Constants</span><span class="o">.</span><span class="na">CLIENT_KEY</span><span class="o">,</span> <span class="nc">Constants</span><span class="o">.</span><span class="na">TRANSPORTER_KEY</span><span class="o">})</span>
    <span class="nc">Client</span> <span class="nf">connect</span><span class="o">(</span><span class="no">URL</span> <span class="n">url</span><span class="o">,</span> <span class="nc">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemotingException</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div></div>

<p>@Adaptive çš„ä¸¤ä¸ªå‚æ•°ï¼Œå€¼åˆ†åˆ«æ˜¯ server å’Œ transporterã€‚å¤–éƒ¨è°ƒç”¨ bind æ—¶ï¼Œä¼šåŠ¨æ€åœ°ä» URL ä¸­æå– server ä½œä¸º key çš„ value å€¼ï¼Œå¦‚æœèƒ½åŒ¹é…ä¸Šé™Œè·¯å“¥æ‰©å±•å®ç°ç±»æ—¶åˆ™ç›´æ¥ä½¿ç”¨å¯¹åº”å®ç°ç±»ï¼›å¦‚æœåŒ¹é…ä¸ä¸Šï¼Œç»§ç»­é€šè¿‡ç¬¬äºŒä¸ªå‚æ•° transporter æå– valueã€‚å¦‚æœéƒ½æ²¡åŒ¹é…åˆ°ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ@Adaptive å¦‚æœä¼ å…¥å¤šä¸ªå‚æ•°ï¼Œåˆ™ä¾æ¬¡è¿›è¡Œå®ç°ç±»åŒ¹é…ï¼Œåˆ°æœ€åæ²¡æœ‰åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>

<p>è¿™ç§åŠ¨æ€å¯»æ‰¾å®ç°ç±»çš„æ–¹å¼æ¯”è¾ƒçµæ´»ï¼Œä½†åªèƒ½æ¿€æ´»ä¸€ä¸ªå…·ä½“çš„å®ç°ç±»ï¼Œå¦‚æœéœ€è¦å¤šä¸ªå®ç°ç±»è¢«åŒæ—¶æ¿€æ´»ï¼Œå¦‚ Filter å¯ä»¥åŒæ—¶æœ‰å¤šä¸ªè¿‡æ»¤å™¨ï¼›æˆ–è€…æ ¹æ®ä¸åŒçš„æ¡ä»¶ï¼ŒåŒæ—¶æ¿€æ´»å¤šä¸ªå®ç°ç±»ï¼Œè¿™å°±éœ€è¦ç¬¬å››ä¸ªç‰¹æ€§â€”â€”è‡ªåŠ¨æ¿€æ´»ã€‚</p>

<h3 id="154-è‡ªåŠ¨æ¿€æ´»">1.5.4 è‡ªåŠ¨æ¿€æ´»</h3>

<p>ä½¿ç”¨ @Activate æ³¨è§£ï¼Œå¯ä»¥æ ‡è®°å¯¹åº”çš„æ‰©å±•ç‚¹é»˜è®¤è¢«æ¿€æ´»å¯ç”¨ã€‚è¯¥æ³¨è§£è¿˜å¯ä»¥ä¼ å…¥ä¸åŒçš„å‚æ•°ï¼Œè®¾ç½®æ‰©å±•ç‚¹åœ¨ä¸åŒçš„æ¡ä»¶ä¸‹è¢«è‡ªåŠ¨æ¿€æ´»ã€‚ä¸»è¦çš„ä½¿ç”¨åœºæ™¯æ˜¯æŸä¸ªæ‰©å±•ç‚¹çš„å¤šä¸ªå®ç°ç±»éœ€è¦åŒæ—¶å¯ç”¨ï¼ˆæ¯”å¦‚ Filter æ‰©å±•ç‚¹ï¼‰ã€‚</p>

<h1 id="äºŒæ‰©å±•ç‚¹æ³¨è§£">äºŒã€æ‰©å±•ç‚¹æ³¨è§£</h1>

<h2 id="21-æ‰©å±•ç‚¹æ³¨è§£spi">2.1 æ‰©å±•ç‚¹æ³¨è§£ï¼š@SPI</h2>

<p>å¯ç”¨åœ¨ç±»ã€æ¥å£å’Œæšä¸¾ç±»ä¸Šï¼ŒDubbo æ¡†æ¶ä¸­éƒ½æ˜¯åœ¨æ¥å£ä¸Šç”¨ã€‚ä½œç”¨æ˜¯æ ‡è®°è¿™ä¸ªæ¥å£æ˜¯ä¸€ä¸ª Dubbo SPI æ¥å£ï¼Œæ˜¯ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œå¯ä»¥æœ‰å¤šä¸ªä¸åŒçš„å†…ç½®æˆ–ç”¨æˆ·å®šä¹‰çš„å®ç°ã€‚è¿è¡Œæ—¶éœ€è¦é€šè¿‡é…ç½®æ‰¾åˆ°å…·ä½“çš„å®ç°ç±»ã€‚</p>

<p>æºç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Documented</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="no">SPI</span> <span class="o">{</span>

    <span class="cm">/**
     * default extension name
     */</span>
    <span class="nc">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div></div>

<p>SPI æ³¨è§£çš„ value å±æ€§å¯ä»¥è®¾ç½®é»˜è®¤å®ç°ç±»ã€‚ä¾‹å¦‚ï¼ŒTransporter ä½¿ç”¨ netty ä½œä¸ºé»˜è®¤å®ç°ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SPI</span><span class="o">(</span><span class="s">"netty"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Transporter</span> <span class="o">{</span>
<span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Dubbo ä¸­æœ‰å¾ˆå¤šåœ°æ–¹é€šè¿‡ <code class="language-plaintext highlighter-rouge">getExtension(Class&lt;T&gt; type, String name)</code>æ¥è·å–æ‰©å±•ç‚¹æ¥å£çš„å…·ä½“å®ç°ï¼Œæ­¤æ—¶ä¼šå¯¹ä¼ å…¥çš„ Class åšæ ¡éªŒï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯æ¥å£ï¼Œä»¥åŠæ˜¯å¦æœ‰ @SPI æ³¨è§£ï¼Œä¸¤è€…ç¼ºä¸€ä¸å¯ã€‚</p>

<h2 id="22-æ‰©å±•ç‚¹è‡ªé€‚åº”æ³¨è§£adaptive">2.2 æ‰©å±•ç‚¹è‡ªé€‚åº”æ³¨è§£ï¼š@Adaptive</h2>

<p>@Adaptive å¯ä»¥æ ‡è®°åœ¨ç±»ã€æ¥å£ã€æšä¸¾ç±»å’Œæ–¹æ³•ä¸Šï¼Œæ•´ä¸ª Dubbo æ¡†æ¶ä¸­ï¼Œåªæœ‰å‡ ä¸ªåœ°æ–¹åœ¨ç±»çº§åˆ«ä¸Šï¼Œå¦‚ AdaptiveExtensionFactory å’Œ AdaptiveCompilerï¼Œå…¶ä½™éƒ½åœ¨æ–¹æ³•ä¸Šã€‚å¦‚æœæ ‡è®°åœ¨æ–¹æ³•ä¸Šï¼Œå³æ–¹æ³•çº§åˆ«çš„æ³¨è§£ï¼Œåˆ™å¯ä»¥é€šè¿‡å‚æ•°åŠ¨æ€è·å¾—å®ç°ç±»ã€‚æ–¹æ³•çº§åˆ«çš„æ³¨è§£åœ¨ç¬¬ä¸€æ¬¡ getExtension æ—¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå’Œç¼–è¯‘ä¸€ä¸ªåŠ¨æ€çš„ Adaptive ç±»ï¼Œä»è€Œè¾¾åˆ°åŠ¨æ€å®ç°ç±»çš„æ•ˆæœã€‚</p>

<p>ä¾‹å¦‚ï¼ŒTransporter æ¥å£ bind å’Œ connect æ–¹æ³•éƒ½æœ‰ @Adaptive æ³¨è§£ï¼ˆsee 1.5.3ï¼‰ã€‚Dubbo åœ¨åˆå§‹åŒ–æ‰©å±•ç‚¹æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ª Transporter$Adaptiveç±»ï¼Œé‡Œé¢ä¼šå®ç°è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œæ–¹æ³•ä¸­ä¼šæœ‰ä¸€äº›æŠ½è±¡çš„é€šç”¨é€»è¾‘ï¼Œé€šè¿‡ @Adaptive ä¸­ä¼ å…¥çš„å‚æ•°ï¼Œæ‰¾åˆ°å¹¶è°ƒç”¨çœŸæ­£çš„å®ç°ç±»ã€‚ç†Ÿæ‚‰è£…é¥°å™¨æ¨¡å¼çš„è¯»è€…ä¼šå¾ˆå®¹æ˜“ç†è§£è¿™éƒ¨åˆ†çš„é€»è¾‘ã€‚åŸç†åœ¨ç¬¬å››éƒ¨åˆ†è®²è§£ã€‚</p>

<p>ä¸‹é¢æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ Transporter$Adaptive#bind å®ç°ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">remoting</span><span class="o">.</span><span class="na">Server</span> <span class="nf">bind</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">remoting</span><span class="o">.</span><span class="na">ChannelHandler</span> <span class="n">arg1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">remoting</span><span class="o">.</span><span class="na">RemotingException</span> <span class="o">{</span>
	<span class="o">...</span>
	<span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">;</span>
	<span class="c1">// é€šè¿‡ @Adaptive æ³¨è§£ä¸­çš„ä¸¤ä¸ª key å»å¯»æ‰¾å®ç°ç±»çš„åç§°</span>
	<span class="nc">String</span> <span class="n">extName</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"server"</span><span class="o">,</span><span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"transporter"</span><span class="o">,</span><span class="s">"netty"</span><span class="o">));</span>
	<span class="o">...</span>
	<span class="k">try</span> <span class="o">{</span>
	<span class="c1">// æ ¹æ® url ä¸­çš„å‚æ•°ï¼Œå°è¯•è·å–çœŸæ­£çš„æ‰©å±•ç‚¹å®ç°ç±»</span>
		<span class="n">extension</span> <span class="o">=</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">remoting</span><span class="o">.</span><span class="na">Transporter</span><span class="o">)</span><span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">remoting</span><span class="o">.</span><span class="na">Transporter</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getExtension</span><span class="o">(</span><span class="n">extName</span><span class="o">);</span>
	<span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
		<span class="c1">// è·å–å¤±è´¥ä½¿ç”¨é»˜è®¤çš„ netty å®ç°</span>
		<span class="o">...</span>
		<span class="n">extension</span> <span class="o">=</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">remoting</span><span class="o">.</span><span class="na">Transporter</span><span class="o">)</span><span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">remoting</span><span class="o">.</span><span class="na">Transporter</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getExtension</span><span class="o">(</span><span class="n">netty</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="c1">// æœ€ç»ˆè°ƒç”¨å…·ä½“æ‰©å±•ç‚¹å®ç°ç±»çš„ bind æ–¹æ³•</span>
	<span class="k">return</span> <span class="n">extension</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span><span class="n">arg1</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç”Ÿæˆçš„æºç ä¸­å¯ä»¥çœ‹å‡ºï¼Œè‡ªåŠ¨ç”Ÿæˆçš„ä»£ç å®ç°äº†å¾ˆå¤šé€šç”¨åŠŸèƒ½ï¼Œæœ€ç»ˆè°ƒç”¨çœŸæ­£çš„æ¥å£å®ç°ã€‚</p>

<p>è¯¥æ³¨è§£æ”¾åœ¨å®ç°ç±»ä¸Šï¼Œåˆ™æ•´ä¸ªå®ç°ç±»ä¼šç›´æ¥ä½œä¸ºé»˜è®¤å®ç°ã€‚ä¸åœ¨è‡ªåŠ¨ç”Ÿæˆä¸Šé¢çš„ä»£ç ã€‚åœ¨æ‰©å±•ç‚¹æ¥å£çš„å¤šä¸ªå®ç°é‡Œï¼Œåªèƒ½æœ‰ä¸€ä¸ªå®ç°å¯ä»¥åŠ  @Adaptive æ³¨è§£ã€‚å¦‚æœå¤šä¸ªå®ç°ç±»éƒ½æœ‰è¯¥æ³¨è§£ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼šMore than 1 adaptive class foundã€‚</p>

<p>@Adaptive æ³¨è§£æºç å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Documented</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Adaptive</span> <span class="o">{</span>
   	<span class="c1">// å¯ä»¥è®¾ç½®å¤šä¸ª keyï¼ŒæŒ‰é¡ºåºåŒ¹é…ã€‚</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

<span class="o">}</span>
</code></pre></div></div>

<p>æ³¨è§£å¯ä»¥ä¼ å…¥ value æ•°ç»„ï¼Œä¼šä¾åºè¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…ä¸åˆ°ï¼Œåˆ™ä½¿ç”¨ @SPI çš„é»˜è®¤å€¼å†å»åŒ¹é…ï¼Œå¦‚æœæ²¡æœ‰é…ç½®ä¼šæŠ›å‡º IllegalStateExceptionã€‚</p>

<p>å¦å¤–ï¼Œå¦‚æœåŒ…è£…ç±»ï¼ˆWrapperï¼‰æ²¡æœ‰ç”¨ @Adaptive æŒ‡å®š keyå€¼ï¼Œä¹Ÿæ²¡æœ‰å¡«å†™é»˜è®¤å€¼ï¼Œåˆ™ Dubbo ä¼šè‡ªåŠ¨æŠŠæ¥å£åç§°æ ¹æ®é©¼å³°å¤§å°åˆ†å¼€ï¼Œå¹¶ç”¨ â€œ.â€ è¿æ¥èµ·æ¥ï¼Œä»¥æ­¤ä½œä¸ºé»˜è®¤å®ç°ç±»çš„åç§°ï¼Œå¦‚ org.apache.dubbo.xxx.YyyInvokerWrapper ä¼šè¢«è½¬åŒ–æˆ yyy.invoker.wrapperã€‚</p>

<p>æœ€åï¼Œä¸ºä»€ä¹ˆæœ‰äº›å®ç°ç±»ä¸Šä¼šæ ‡æ³¨ @Adaptive æ³¨è§£å‘¢ï¼Ÿä¸»è¦æ˜¯ä¸ºäº†ç›´æ¥å›ºå®šå¯¹åº”çš„å®ç°è€Œä¸éœ€è¦åŠ¨æ€ç”Ÿæˆä»£ç å®ç°ã€‚ä»£ç ä¸­ï¼Œä¼šç¼“å­˜ä¸¤ä¸ªä¸ @Adaptive æœ‰å…³çš„å¯¹è±¡ï¼Œä¸€ä¸ªç¼“å­˜åœ¨ cachedAdaptiveClassï¼Œå¦ä¸€ä¸ªç¼“å­˜åœ¨ cachedAdaptiveInstanceã€‚æ‰©å±•ç‚¹åˆå§‹åŒ–æ—¶ï¼Œå¦‚æœå‘ç°ç±»ä¸Šæœ‰ @Adaptive ï¼Œåˆ™ç›´æ¥èµ‹å€¼ç»™ cachedAdaptiveClassï¼Œåç»­å®ä¾‹åŒ–ç±»çš„æ—¶å€™ï¼Œå°±ä¸ä¼šå†åŠ¨æ€ç”Ÿæˆä»£ç äº†ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ç±»ç”Ÿæˆå¯¹è±¡å¹¶ç¼“å­˜åˆ°cachedAdaptiveInstanceã€‚å¦‚æœæ³¨è§£åœ¨æ¥å£çš„æ–¹æ³•ä¸Šï¼Œåˆ™ä¼šæ ¹æ®å‚æ•°ï¼ŒåŠ¨æ€è·å¾—æ‰©å±•ç‚¹çš„å®ç°ï¼Œç”Ÿæˆ Adaptive ç±»ï¼Œå†ç¼“å­˜åˆ° cachedAdaptiveInstanceã€‚</p>

<h2 id="23-æ‰©å±•ç‚¹è‡ªåŠ¨æ¿€æ´»æ³¨è§£activate">2.3 æ‰©å±•ç‚¹è‡ªåŠ¨æ¿€æ´»æ³¨è§£ï¼š@Activate</h2>

<p>@Activate å¯ä»¥æ ‡è®°åœ¨ç±»ã€æ¥å£ã€æšä¸¾ç±»å’Œæ–¹æ³•ä¸Šã€‚ä¸»è¦ä½¿ç”¨åœ¨æœ‰å¤šä¸ªæ‰©å±•ç‚¹å®ç°ã€éœ€è¦æ ¹æ®ä¸åŒæ¡ä»¶è¢«æ¿€æ´»çš„é•¿æ±Ÿä¸­ï¼Œå¦‚ Filter éœ€è¦å¤šä¸ªåŒæ—¶æ¿€æ´»ï¼Œå› ä¸ºæ¯ä¸ª Filter å®ç°çš„ä¸åŒçš„åŠŸèƒ½ã€‚@Activate å¯ä»¥ä¼ å…¥çš„å‚æ•°å¾ˆå¤šï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Documented</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Activate</span> <span class="o">{</span>
    
    <span class="c1">// URL ä¸­çš„åˆ†ç»„å¦‚æœåŒ¹é…åˆ™æ¿€æ´»ï¼Œåˆ™å¯ä»¥è®¾ç½®å¤šä¸ª </span>
    <span class="nc">String</span><span class="o">[]</span> <span class="nf">group</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

  	<span class="c1">// æŸ¥æ‰¾ URL å¦‚æœå«æœ‰è¯¥ keyï¼Œåˆ™æ¿€æ´»</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
	
	<span class="c1">// å¡«å†™æ‰©å±•ç‚¹åˆ—è¡¨ï¼Œè¡¨ç¤ºå“ªäº›æ‰©å±•ç‚¹è¦åœ¨æœ¬æ‰©å±•ç‚¹å‰</span>
    <span class="nd">@Deprecated</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="nf">before</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="c1">// åŒä¸Šï¼Œåœ¨å</span>
    <span class="nd">@Deprecated</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="nf">after</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="c1">// æ’åºå€¼</span>
    <span class="kt">int</span> <span class="nf">order</span><span class="o">()</span> <span class="k">default</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="ä¸‰extensionloader-çš„å·¥ä½œåŸç†">ä¸‰ã€ExtensionLoader çš„å·¥ä½œåŸç†</h1>

<p>ExtensionLoader æ˜¯æ•´ä¸ªæ‰©å±•æœºåˆ¶çš„ä¸»è¦é€»è¾‘ç±»ï¼Œå®ç°äº†é…ç½®çš„åŠ è½½ã€æ‰©å±•ç±»çš„ç¼“å­˜ã€è‡ªé€‚åº”å¯¹è±¡ç”Ÿæˆç­‰æ‰€æœ‰å·¥ä½œã€‚æœ¬èŠ‚å°†ç»“åˆæºç è®²è§£æ•´ä¸ª ExtensionLoader çš„å·¥ä½œæµç¨‹ã€‚</p>

<p>é¦–å…ˆçœ‹ ExtensionLoader çš„ä½¿ç”¨ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="nc">Transporter</span><span class="o">&gt;</span> <span class="n">extensionLoader</span> <span class="o">=</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="nc">Transporter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">extensionLoader</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="s">"true"</span><span class="o">));</span>
</code></pre></div></div>

<p>ExtensionLoader ç§æœ‰äº†æ„é€ å™¨ï¼Œåªæœ‰ä¸€ä¸ªé™æ€æ–¹æ³•ä¾›å¤–éƒ¨è®¿é—®ï¼Œé€šè¿‡ getExtensionLoader è·å– ExtensionLoader å®ä¾‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getExtensionLoader</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    	<span class="c1">// åˆ¤ç©º</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Extension type == null"</span><span class="o">);</span>
        <span class="o">}</span>
    	<span class="c1">// å¿…é¡»æ˜¯æ¥å£</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">type</span><span class="o">.</span><span class="na">isInterface</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Extension type ("</span> <span class="o">+</span> <span class="n">type</span> <span class="o">+</span> <span class="s">") is not an interface!"</span><span class="o">);</span>
        <span class="o">}</span>
    	<span class="c1">// å¿…é¡»è¦æœ‰ SPI  æ³¨è§£</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">withExtensionAnnotation</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Extension type ("</span> <span class="o">+</span> <span class="n">type</span> <span class="o">+</span>
                    <span class="s">") is not an extension, because it is NOT annotated with @"</span> <span class="o">+</span> <span class="no">SPI</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"!"</span><span class="o">);</span>
        <span class="o">}</span>
		<span class="c1">// å…ˆä»ç¼“å­˜æ‹¿</span>
        <span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">loader</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;)</span> <span class="no">EXTENSION_LOADERS</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
    	<span class="c1">// ç¼“å­˜æ²¡æœ‰åˆ™ä½¿ç”¨ç§æœ‰çš„æ„é€ å™¨åˆ›å»ºå¯¹è±¡å¹¶ä»ç¼“å­˜ä¸­è·å–è¿”å›ã€‚</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">loader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">EXTENSION_LOADERS</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;(</span><span class="n">type</span><span class="o">));</span>
            <span class="n">loader</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;)</span> <span class="no">EXTENSION_LOADERS</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">loader</span><span class="o">;</span>
    <span class="o">}</span>

	<span class="c1">// æ„é€ å‡½æ•° æ­¤æ—¶æ³¨å…¥äº†è‡ªé€‚åº”çš„ ExtensionFactory</span>
	<span class="kd">private</span> <span class="nf">ExtensionLoader</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
        <span class="n">objectFactory</span> <span class="o">=</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">ExtensionFactory</span><span class="o">.</span><span class="na">class</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="nc">ExtensionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getAdaptiveExtension</span><span class="o">());</span>
    <span class="o">}</span>

</code></pre></div></div>

<h2 id="31-å·¥ä½œæµç¨‹">3.1 å·¥ä½œæµç¨‹</h2>

<p>ExtensionLoader çš„é€»è¾‘å…¥å£å¯ä»¥åˆ†ä¸º getExtensionã€getAdaptiveExtensionã€getActivateExtension ä¸‰ä¸ªã€‚</p>

<p>getActivateExtension å¯¹ getExtension ä¾èµ–é‡ï¼ŒgetAdaptiveExtension ç›¸å¯¹ç‹¬ç«‹ã€‚</p>

<p>getActivateExtension åªæ˜¯æ ¹æ®ä¸åŒæ¡ä»¶åŒæ—¶æ¿€æ´»å¤šä¸ªæ™®é€šæ‰©å±•ç±»ã€‚å› æ­¤è¯¥æ–¹æ³•åªä¼šåšä¸€äº›é€šç”¨é€»è¾‘åˆ¤æ–­ï¼Œæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ getExtension è·å¾—å…·ä½“æ‰©å±•ç‚¹å®ç°ç±»ã€‚</p>

<p>ä»£ç å®ç°ï¼Œé¦–å…ˆçœ‹ Fields</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="c1">// æ‰©å±•ç±»ä¸å¯¹åº”çš„æ‰©å±•ç±»åŠ è½½å™¨ç¼“å­˜</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ConcurrentMap</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">ExtensionLoader</span><span class="o">&lt;?&gt;&gt;</span> <span class="no">EXTENSION_LOADERS</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
	<span class="c1">// æ‰©å±•ç±»ä¸ç±»åˆå§‹åŒ–åçš„å®ä¾‹</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ConcurrentMap</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="no">EXTENSION_INSTANCES</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
	
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">;</span>
	
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ExtensionFactory</span> <span class="n">objectFactory</span><span class="o">;</span>
	<span class="c1">// æ‰©å±•ç±»ä¸æ‰©å±•åç¼“å­˜</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ConcurrentMap</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">cachedNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
	<span class="c1">// æ™®é€šæ‰©å±•ç±»ç¼“å­˜ï¼Œä¸åŒ…æ‹¬è‡ªé€‚åº”æ‰©å±•ç±»å’Œ Wrapper ç±»</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Holder</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;&gt;&gt;</span> <span class="n">cachedClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Holder</span><span class="o">&lt;&gt;();</span>
	<span class="c1">// æ‰©å±•åä¸ @Activate çš„ç¼“å­˜</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">cachedActivates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
	<span class="c1">// æ‰©å±•åä¸æ‰©å±•å¯¹è±¡ç¼“å­˜</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ConcurrentMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Holder</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">cachedInstances</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
	<span class="c1">// å®ä¾‹åŒ–åçš„ Adaptive æ‰©å±•å¯¹è±¡ï¼Œåªèƒ½åŒæ—¶å­˜åœ¨ä¸€ä¸ª</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Holder</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">cachedAdaptiveInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Holder</span><span class="o">&lt;&gt;();</span>
	<span class="c1">// å®ä¾‹åŒ–åçš„ Adaptive æ‰©å±•ç±»</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cachedAdaptiveClass</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">cachedDefaultName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">Throwable</span> <span class="n">createAdaptiveInstanceError</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">cachedWrapperClasses</span><span class="o">;</span>
</code></pre></div></div>

<h2 id="32-getextension-çš„å®ç°åŸç†">3.2 getExtension çš„å®ç°åŸç†</h2>

<p>getExtension(String name) å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„æ™®é€šæ‰©å±•ç±»çš„åŠ è½½è¿‡ç¨‹ã€‚æ¯ä¸€æ­¥éƒ½ä¼šå…ˆè¯»ç¼“å­˜</p>

<p>æµç¨‹ï¼š</p>

<ol>
  <li>æ¡†æ¶è¯»å– SPI å¯¹åº”è·¯å¾„ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®é…ç½®åŠ è½½æ‰€æœ‰æ‰©å±•ç±»å¹¶ç¼“å­˜ï¼ˆä¸åˆå§‹åŒ–ï¼‰ã€‚</li>
  <li>æ ¹æ®ä¼ å…¥çš„åç§°åˆå§‹åŒ–å¯¹åº”çš„æ‰©å±•ç±»ã€‚</li>
  <li>å°è¯•æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„åŒ…è£…ç±»</li>
  <li>è¿”å›å¯¹åº”çš„æ‰©å±•ç±»å®ä¾‹</li>
</ol>

<p>ä»£ç å®ç°ï¼Œè¿™é‡Œå°±ä¸è´´äº†ã€‚è¯·è‡ªè¡ŒæŸ¥çœ‹</p>

<p><a href="https://github.com/konekos/dubbo/blob/my-2.7.5/dubbo-common/src/main/java/org/apache/dubbo/common/extension/ExtensionLoader.java">ExtensionLoader.java</a></p>

<p>è¿™é‡Œæœ‰ä¸€æ­¥ä¾èµ–æ³¨å…¥ï¼Œä¸º injectExtension æ–¹æ³•ï¼Œç±»ä¼¼ Spring IoC çš„æœºåˆ¶ï¼Œå®ç°åŸç†ä¸ºï¼šåå°„è·å–æ‰€æœ‰æ‹¥æœ‰ setter</p>

<p>çš„å‚æ•°ç±»å‹ï¼Œç„¶åé€šè¿‡ ExtensionFactory æŸ¥æ‰¾ç±»å‹ç›¸åŒçš„æ‰©å±•ç±»å®ä¾‹ï¼Œå¦‚æœæ‰¾åˆ°åˆ™method è°ƒç”¨ invoke ï¼Œå®Œæˆ setter æ³¨å…¥ã€‚å¦å¤–ï¼ŒWrapper ç±»çš„æ„é€ å‚æ•°æ³¨å…¥ï¼Œä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªæ–¹æ³•å®ç°çš„ã€‚</p>

<h2 id="33-getadaptiveextension-çš„å®ç°åŸç†">3.3 getAdaptiveExtension çš„å®ç°åŸç†</h2>

<p>é¦–å…ˆçœ‹æºç ä¸­çš„æµ‹è¯•ç”¨ä¾‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_getAdaptiveExtension_defaultAdaptiveKey</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="o">{</span>
            <span class="nc">SimpleExt</span> <span class="n">ext</span> <span class="o">=</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="nc">SimpleExt</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getAdaptiveExtension</span><span class="o">();</span>

            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;();</span>
            <span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="s">"p1"</span><span class="o">,</span> <span class="s">"1.2.3.4"</span><span class="o">,</span> <span class="mi">1010</span><span class="o">,</span> <span class="s">"path1"</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>

            <span class="nc">String</span> <span class="n">echo</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="na">echo</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="s">"haha"</span><span class="o">);</span>
            <span class="n">assertEquals</span><span class="o">(</span><span class="s">"Ext1Impl1-echo"</span><span class="o">,</span> <span class="n">echo</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="o">{</span>
            <span class="nc">SimpleExt</span> <span class="n">ext</span> <span class="o">=</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="nc">SimpleExt</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getAdaptiveExtension</span><span class="o">();</span>

            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;();</span>
            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"simple.ext"</span><span class="o">,</span> <span class="s">"impl2"</span><span class="o">);</span>
            <span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="s">"p1"</span><span class="o">,</span> <span class="s">"1.2.3.4"</span><span class="o">,</span> <span class="mi">1010</span><span class="o">,</span> <span class="s">"path1"</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>

            <span class="nc">String</span> <span class="n">echo</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="na">echo</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="s">"haha"</span><span class="o">);</span>
            <span class="n">assertEquals</span><span class="o">(</span><span class="s">"Ext1Impl2-echo"</span><span class="o">,</span> <span class="n">echo</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="nd">@SPI</span><span class="o">(</span><span class="s">"impl1"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SimpleExt</span> <span class="o">{</span>
    <span class="c1">// @Adaptive example, do not specify a explicit key.</span>
    <span class="nd">@Adaptive</span>
    <span class="nc">String</span> <span class="nf">echo</span><span class="o">(</span><span class="no">URL</span> <span class="n">url</span><span class="o">,</span> <span class="nc">String</span> <span class="n">s</span><span class="o">);</span>

    <span class="nd">@Adaptive</span><span class="o">({</span><span class="s">"key1"</span><span class="o">,</span> <span class="s">"key2"</span><span class="o">})</span>
    <span class="nc">String</span> <span class="nf">yell</span><span class="o">(</span><span class="no">URL</span> <span class="n">url</span><span class="o">,</span> <span class="nc">String</span> <span class="n">s</span><span class="o">);</span>

    <span class="c1">// no @Adaptive</span>
    <span class="nc">String</span> <span class="nf">bang</span><span class="o">(</span><span class="no">URL</span> <span class="n">url</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>SPI ä¸Šé»˜è®¤å®ç°ä¸º impl1ã€‚</p>

<p>ç”Ÿæˆçš„è‡ªé€‚åº”ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.apache.dubbo.common.extension.ext1</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.dubbo.common.extension.ExtensionLoader</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleExt</span><span class="n">$Adaptive</span> <span class="kd">implements</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">echo</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">arg1</span><span class="o">)</span>  <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">arg0</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="s">"url == null"</span><span class="o">);</span>
        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">extName</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"simple.ext"</span><span class="o">,</span> <span class="s">"impl1"</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">extName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span><span class="s">"Failed to get extension (org.apache.dubbo.common.extension.ext1.SimpleExt) name from url ("</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">") use keys([simple.ext])"</span><span class="o">);</span>
        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span> <span class="n">extension</span> <span class="o">=</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span><span class="o">)</span><span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getExtension</span><span class="o">(</span><span class="n">extName</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">extension</span><span class="o">.</span><span class="na">echo</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span> <span class="n">arg1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">yell</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">arg1</span><span class="o">)</span>  <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">arg0</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="s">"url == null"</span><span class="o">);</span>
        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">extName</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"key1"</span><span class="o">,</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"key2"</span><span class="o">,</span> <span class="s">"impl1"</span><span class="o">));</span>
        <span class="k">if</span><span class="o">(</span><span class="n">extName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span><span class="s">"Failed to get extension (org.apache.dubbo.common.extension.ext1.SimpleExt) name from url ("</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">") use keys([key1, key2])"</span><span class="o">);</span>
        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span> <span class="n">extension</span> <span class="o">=</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span><span class="o">)</span><span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getExtension</span><span class="o">(</span><span class="n">extName</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">extension</span><span class="o">.</span><span class="na">yell</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span> <span class="n">arg1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">bang</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">arg0</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg1</span><span class="o">)</span>  <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">(</span><span class="s">"The method public abstract java.lang.String org.apache.dubbo.common.extension.ext1.SimpleExt.bang(org.apache.dubbo.common.URL,int) of interface org.apache.dubbo.common.extension.ext1.SimpleExt is not adaptive method!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.apache.dubbo.common.extension.ext1</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.dubbo.common.extension.ExtensionLoader</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleExt</span><span class="n">$Adaptive</span> <span class="kd">implements</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">bang</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">arg0</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg1</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">(</span><span class="s">"The method public abstract java.lang.String org.apache.dubbo.common.extension.ext1.SimpleExt.bang(org.apache.dubbo.common.URL,int) of interface org.apache.dubbo.common.extension.ext1.SimpleExt is not adaptive method!"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">echo</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">arg1</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">arg0</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="s">"url == null"</span><span class="o">);</span>
        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">extName</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"simple.ext"</span><span class="o">,</span> <span class="s">"impl1"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">extName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Failed to get extension (org.apache.dubbo.common.extension.ext1.SimpleExt) name from url ("</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">") use keys([simple.ext])"</span><span class="o">);</span>
        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span> <span class="n">extension</span> <span class="o">=</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span><span class="o">)</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getExtension</span><span class="o">(</span><span class="n">extName</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">extension</span><span class="o">.</span><span class="na">echo</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span> <span class="n">arg1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">yell</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">arg1</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">arg0</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="s">"url == null"</span><span class="o">);</span>
        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">extName</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"key1"</span><span class="o">,</span> <span class="n">url</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"key2"</span><span class="o">,</span> <span class="s">"impl1"</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">extName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Failed to get extension (org.apache.dubbo.common.extension.ext1.SimpleExt) name from url ("</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">") use keys([key1, key2])"</span><span class="o">);</span>
        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span> <span class="n">extension</span> <span class="o">=</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span><span class="o">)</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">ext1</span><span class="o">.</span><span class="na">SimpleExt</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getExtension</span><span class="o">(</span><span class="n">extName</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">extension</span><span class="o">.</span><span class="na">yell</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span> <span class="n">arg1</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è‡ªé€‚åº”æ‰©å±•ç‚¹æ˜¯é€šè¿‡è‡ªåŠ¨ç”Ÿæˆå®ç°ç±»å­—ç¬¦ä¸²ï¼Œç„¶ååŠ¨æ€ç¼–è¯‘å¹¶ç”Ÿæˆå¯¹è±¡å®ç°çš„ã€‚</p>

<p>ä»£ç ç”Ÿæˆè¿‡ç¨‹å¯å‚è€ƒï¼š</p>

<p><a href="https://github.com/konekos/dubbo/blob/my-2.7.5/dubbo-common/src/main/java/org/apache/dubbo/common/extension/AdaptiveClassCodeGenerator.java">AdaptiveClassCodeGenerator.java</a></p>

<p>Dubbo çš„ç¼–è¯‘å™¨ä¹Ÿæ˜¯ä¸€ä¸ª Adaptive æ¥å£ï¼Œä½† @Adaptive æ˜¯åŠ åœ¨ç±» AdaptiveCompiler ä¸Šçš„ã€‚æ‰€æœ‰è¿™ä¸ªç±»å°±æ˜¯é»˜è®¤å®ç°ï¼Œä¸ç”¨åšä»£ç ç”Ÿæˆå’Œç¼–è¯‘ã€‚</p>

<p>å¦‚æœä¸€ä¸ªæ¥å£ä¸Šçš„ @SPI æ³¨è§£äº†é»˜è®¤å®ç°ï¼Œä¸”æ–¹æ³•ä¸Šçš„ @Adaptive ä¹Ÿæ ‡æ˜äº†é»˜è®¤å®ç°ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨å“ªä¸ªæ ‡æ³¨å‘¢ï¼Ÿä»ç¬¬äºŒä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹åŠ¨æ€ç”Ÿæˆçš„ç±»å¯ä»¥çœ‹åˆ°ï¼ŒString extName = url.getParameter(â€œkey1â€, url.getParameter(â€œkey2â€, â€œimpl1â€))ï¼Œæ˜¯å…ˆæ ¹æ®key1æ‰¾ï¼Œå†æ‰¾key2ï¼Œæ²¡æœ‰çš„è¯ä½¿ç”¨é»˜è®¤çš„å®ç°ã€‚</p>

<h2 id="34-getactivateextension-å®ç°åŸç†">3.4 getActivateExtension å®ç°åŸç†</h2>

<p>å•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="no">URL</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="s">"test://localhost/test"</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ActivateExt1</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">getExtensionLoader</span><span class="o">(</span><span class="nc">ActivateExt1</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getActivateExtension</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{},</span> <span class="s">"default_group"</span><span class="o">);</span>
        <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertSame</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getClass</span><span class="o">(),</span> <span class="nc">ActivateExt1Impl1</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="nd">@Activate</span><span class="o">(</span><span class="n">group</span> <span class="o">=</span> <span class="o">{</span><span class="s">"default_group"</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActivateExt1Impl1</span> <span class="kd">implements</span> <span class="nc">ActivateExt1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">echo</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">getActivateExtension(URL url, String[] values, String group)</code> å¯ä»¥è·å–æ‰€æœ‰è‡ªåŠ¨æ¿€æ´»æ‰©å±•ç‚¹ã€‚å®ç°é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getActivateExtension</span><span class="o">(</span><span class="no">URL</span> <span class="n">url</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">values</span><span class="o">,</span> <span class="nc">String</span> <span class="n">group</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">exts</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">names</span> <span class="o">=</span> <span class="n">values</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">values</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">names</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="no">REMOVE_VALUE_PREFIX</span> <span class="o">+</span> <span class="no">DEFAULT_KEY</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// åŠ è½½æ‰€æœ‰æ‰©å±•ç‚¹ï¼ˆå…ˆç¼“å­˜è·å–ï¼‰</span>
            <span class="n">getExtensionClasses</span><span class="o">();</span>
            <span class="c1">// éå† cachedActivates ç¼“å­˜</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">cachedActivates</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
                <span class="nc">Object</span> <span class="n">activate</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>

                <span class="nc">String</span><span class="o">[]</span> <span class="n">activateGroup</span><span class="o">,</span> <span class="n">activateValue</span><span class="o">;</span>
                <span class="c1">// å¿…é¡»è¦æœ‰ Activate æ³¨è§£</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">activate</span> <span class="k">instanceof</span> <span class="nc">Activate</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">activateGroup</span> <span class="o">=</span> <span class="o">((</span><span class="nc">Activate</span><span class="o">)</span> <span class="n">activate</span><span class="o">).</span><span class="na">group</span><span class="o">();</span>
                    <span class="n">activateValue</span> <span class="o">=</span> <span class="o">((</span><span class="nc">Activate</span><span class="o">)</span> <span class="n">activate</span><span class="o">).</span><span class="na">value</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">activate</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">Activate</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">activateGroup</span> <span class="o">=</span> <span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">Activate</span><span class="o">)</span> <span class="n">activate</span><span class="o">).</span><span class="na">group</span><span class="o">();</span>
                    <span class="n">activateValue</span> <span class="o">=</span> <span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">extension</span><span class="o">.</span><span class="na">Activate</span><span class="o">)</span> <span class="n">activate</span><span class="o">).</span><span class="na">value</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="c1">// åŒ¹é… name å’Œ groupï¼Œé€šè¿‡getExtension è·å–å®ä¾‹åæ·»åŠ åˆ° exts</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">isMatchGroup</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">activateGroup</span><span class="o">)</span>
                        <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">names</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
                        <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">names</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="no">REMOVE_VALUE_PREFIX</span> <span class="o">+</span> <span class="n">name</span><span class="o">)</span>
                        <span class="o">&amp;&amp;</span> <span class="n">isActive</span><span class="o">(</span><span class="n">activateValue</span><span class="o">,</span> <span class="n">url</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">exts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">getExtension</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// æ’åº</span>
            <span class="n">exts</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="nc">ActivateComparator</span><span class="o">.</span><span class="na">COMPARATOR</span><span class="o">);</span>
        <span class="o">}</span>
    	<span class="c1">// URL å¦‚æœä¼ å…¥ -defaultï¼Œæ‰€æœ‰é»˜è®¤çš„ @Activate éƒ½ä¸è¢«æ¿€æ´»ï¼Œåªæœ‰ URL æŒ‡å®šçš„è¢«æ¿€æ´»</span>
    	<span class="c1">// å¦‚æœä¼ å…¥äº† -å¼€å¤´çš„æ‰©å±•ç‚¹åï¼Œåˆ™è¯¥æ‰©å±•ç‚¹ä¹Ÿä¸ä¼šæ¿€æ´»</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">usrs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">names</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">name</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">REMOVE_VALUE_PREFIX</span><span class="o">)</span>
                    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">names</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="no">REMOVE_VALUE_PREFIX</span> <span class="o">+</span> <span class="n">name</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="no">DEFAULT_KEY</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">usrs</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">exts</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">usrs</span><span class="o">);</span>
                        <span class="n">usrs</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">usrs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">getExtension</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">usrs</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">exts</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">usrs</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">exts</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>è¯¥æ–¹æ³•ä¹Ÿæ˜¯ä»¥ getExtension ä¸ºåŸºç¡€çš„ã€‚</p>

<h2 id="35-extensionfactory-å®ç°åŸç†">3.5 ExtensionFactory å®ç°åŸç†</h2>

<p>ExtensionFactory ç”¨äºåœ¨ ExtensionLoader æ³¨å…¥ä¾èµ–æ—¶è·å–å®ä¾‹æ˜¯ä¸€ä¸ªå·¥å‚ç±»ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SPI</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExtensionFactory</span> <span class="o">{</span>

    <span class="cm">/**
     * Get extension.
     *
     * @param type object type.
     * @param name object name.
     * @return object instance.
     */</span>
    <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">getExtension</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">);</span>

<span class="o">}</span>
</code></pre></div></div>

<p>å·¥å‚ç±»ä¹Ÿæ˜¯ä¸€ä¸ª SPI ç±»ï¼Œå…¶å®ç°æœ‰ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Adaptive</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdaptiveExtensionFactory</span> <span class="kd">implements</span> <span class="nc">ExtensionFactory</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ExtensionFactory</span><span class="o">&gt;</span> <span class="n">factories</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AdaptiveExtensionFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// åŠ è½½æ‰€æœ‰æ‰©å±•ç‚¹</span>
        <span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="nc">ExtensionFactory</span><span class="o">&gt;</span> <span class="n">loader</span> <span class="o">=</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="nc">ExtensionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ExtensionFactory</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ExtensionFactory</span><span class="o">&gt;();</span>
        <span class="c1">// æ·»åŠ æ‰€æœ‰ ExtensionFactory çš„æ‰©å±•ç±»å®ä¾‹</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">name</span> <span class="o">:</span> <span class="n">loader</span><span class="o">.</span><span class="na">getSupportedExtensions</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">loader</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">factories</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">getExtension</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">ExtensionFactory</span> <span class="n">factory</span> <span class="o">:</span> <span class="n">factories</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">T</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">extension</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">extension</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpiExtensionFactory</span> <span class="kd">implements</span> <span class="nc">ExtensionFactory</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">getExtension</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">type</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="no">SPI</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">loader</span> <span class="o">=</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">loader</span><span class="o">.</span><span class="na">getSupportedExtensions</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">loader</span><span class="o">.</span><span class="na">getAdaptiveExtension</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringExtensionFactory</span> <span class="kd">implements</span> <span class="nc">ExtensionFactory</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">SpringExtensionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ApplicationContext</span><span class="o">&gt;</span> <span class="no">CONTEXTS</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashSet</span><span class="o">&lt;</span><span class="nc">ApplicationContext</span><span class="o">&gt;();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addApplicationContext</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">CONTEXTS</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="k">instanceof</span> <span class="nc">ConfigurableApplicationContext</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">((</span><span class="nc">ConfigurableApplicationContext</span><span class="o">)</span> <span class="n">context</span><span class="o">).</span><span class="na">registerShutdownHook</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">removeApplicationContext</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">CONTEXTS</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ApplicationContext</span><span class="o">&gt;</span> <span class="nf">getContexts</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">CONTEXTS</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// currently for test purpose</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">clearContexts</span><span class="o">()</span> <span class="o">{</span>
        <span class="no">CONTEXTS</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">getExtension</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å¸¦æœ‰ SPI æ³¨è§£çš„æ¥å£ï¼Œè¦ä½¿ç”¨ SpiExtensionFactory è·å–æ‰©å±•ç±»å®ä¾‹</span>
        <span class="c1">//SPI should be get from SpiExtensionFactory</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">type</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="no">SPI</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// æ ¹æ®å®ä¾‹ name å’Œ ç±»å‹ï¼Œä» Spring å®¹å™¨è·å–å®ä¾‹</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">:</span> <span class="no">CONTEXTS</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">T</span> <span class="n">bean</span> <span class="o">=</span> <span class="nc">BeanFactoryUtils</span><span class="o">.</span><span class="na">getOptionalBean</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"No spring extension (bean) named:"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">", try to find an extension (bean) of type "</span> <span class="o">+</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>AdaptiveExtensionFactory ä¸Šæœ‰ @Adaptive æ³¨è§£ã€‚å› æ­¤ï¼Œå®ƒæ˜¯ä¸€å¼€å§‹çš„é»˜è®¤å®ç°ã€‚é™¤äº†è¯¥å®ç°ä¹‹å¤–ï¼Œè¿˜æœ‰ SpiExtensionFactory å’Œ SpringExtensionFactoryã€‚æ„æ€æ˜¯é™¤äº†å¯ä»¥ä» Dubbo SPI ç®¡ç†çš„å®¹å™¨è·å–æ‰©å±•ç±»å®ä¾‹ï¼Œè¿˜å¯ä»¥ä» Spring å®¹å™¨è·å–ã€‚</p>

<p>AdaptiveExtensionFactory æ˜¯é»˜è®¤å®ç°ï¼Œåœ¨æ„é€ å™¨ä¸­æ·»åŠ äº†æ‰€æœ‰çš„ ExtensionFactory å®ä¾‹ï¼Œåœ¨ä½¿ç”¨ ExtensionFactory æ—¶ï¼Œè¿˜æ˜¯ä½¿ç”¨çš„ AdaptiveExtensionFactory çš„ getExtension æ–¹æ³•ï¼Œéå†æ‰€æœ‰å®ç°ä¾æ¬¡åŠ è½½ï¼Œæ˜¯æœ‰åºçš„ï¼Œä¸ºå…ˆ SPI å† Springï¼Œç»“åˆå…¶ä»– ExtensionFactory å®ç°çœ‹ï¼Œå¸¦æœ‰ @SPI çš„æ¥å£æ˜¯åªä½¿ç”¨ SpiExtensionFactory åŠ è½½çš„ï¼Œå¦‚æœä¸æ˜¯ï¼Œå…ˆ SPI å† Springã€‚</p>

<h1 id="å››æ‰©å±•ç‚¹åŠ¨æ€ç¼–è¯‘çš„å®ç°">å››ã€æ‰©å±•ç‚¹åŠ¨æ€ç¼–è¯‘çš„å®ç°</h1>

<p>Dubbo SPI çš„è‡ªé€‚åº”ç‰¹æ€§è®©æ•´ä¸ªæ¡†æ¶éå¸¸çµæ´»ï¼ŒåŠ¨æ€ç¼–è¯‘æ˜¯è‡ªé€‚åº”ç‰¹æ€§çš„åŸºç¡€ï¼ŒDubbo ç”Ÿæˆè‡ªé€‚åº”ç±»æ˜¯æ‹¼æ¥ç±»çš„å­—ç¬¦ä¸²ï¼Œæ˜¯éœ€è¦è¿›è¡Œç¼–è¯‘æ‰èƒ½å˜æˆ Class çš„ã€‚è™½ç„¶åå°„å¯ä»¥åŠ¨æ€ä»£ç†ä¸€ä¸ªç±»ï¼Œä½†åœ¨æ€§èƒ½ä¸Šå’Œç›´æ¥ç¼–è¯‘å¥½çš„ Class ä¼šæœ‰ä¸€å®šå·®è·ã€‚Dubbo SPI é€šè¿‡åŠ¨æ€ç”Ÿæˆä»£ç ï¼Œé…åˆåŠ¨æ€ç¼–è¯‘å™¨ï¼Œçµæ´»åˆ›å»ºè‡ªé€‚åº”ç±»ã€‚æœ¬èŠ‚ä»‹ç» Dubbo SPI åŠ¨æ€ç¼–è¯‘å™¨çš„ç§ç±»ä»¥åŠå¯¹åº”å®ç°åŸç†ã€‚</p>

<h2 id="41-æ€»ä½“ç»“æ„">4.1 æ€»ä½“ç»“æ„</h2>

<p>Dubbo ç¼–è¯‘å™¨æ¥å£ä¸º Compilerï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Compiler. (SPI, Singleton, ThreadSafe)
 */</span>
<span class="nd">@SPI</span><span class="o">(</span><span class="s">"javassist"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Compiler</span> <span class="o">{</span>

    <span class="cm">/**
     * Compile java source code.
     *
     * @param code        Java source code
     * @param classLoader classloader
     * @return Compiled class
     */</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">compile</span><span class="o">(</span><span class="nc">String</span> <span class="n">code</span><span class="o">,</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">);</span>

<span class="o">}</span>
</code></pre></div></div>

<p>å¯ä»¥å‘ç°æ˜¯ @SPI æ³¨è§£ï¼Œå¯æ‰©å±•çš„ï¼Œé»˜è®¤ç¼–è¯‘å™¨æ˜¯ javassistï¼Œå•ä¾‹ä¸”çº¿ç¨‹å®‰å…¨ã€‚</p>

<blockquote>
  <p>ç”¨æˆ·è‹¥æƒ³æ”¹å˜é»˜è®¤ç¼–è¯‘å™¨ï¼Œå¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">&lt;dubbo:application compiler="jdk"/&gt;</code>é…ç½®ã€‚</p>
</blockquote>

<p>å…¶å®ç°ç±»æœ‰ AdaptiveCompilerã€JavassistCompilerã€JdkCompilerã€‚</p>

<p>AdaptiveCompiler å’Œ AdaptiveExtensionFactory åŒç†ï¼Œç±»ä¸Šæ ‡æ³¨äº† @Adaptive æ³¨è§£ï¼Œå›ºå®šä¸ºé»˜è®¤å®ç°ï¼Œç”¨äºç®¡ç†å…¶ä»–çš„ Compiler å®ç°ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Adaptive</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdaptiveCompiler</span> <span class="kd">implements</span> <span class="nc">Compiler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">String</span> <span class="no">DEFAULT_COMPILER</span><span class="o">;</span>
	<span class="c1">// set æ–¹æ³•åœ¨ ApplicationConfig ä¸­è¢«è°ƒç”¨ï¼Œdubbo å¯åŠ¨æ—¶è§£æé…ç½®ä¸­çš„æ ‡ç­¾è®¾ç½®é»˜è®¤å€¼ã€‚</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setDefaultCompiler</span><span class="o">(</span><span class="nc">String</span> <span class="n">compiler</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">DEFAULT_COMPILER</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">compile</span><span class="o">(</span><span class="nc">String</span> <span class="n">code</span><span class="o">,</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Compiler</span> <span class="n">compiler</span><span class="o">;</span>
        <span class="c1">// è·å– loader</span>
        <span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="nc">Compiler</span><span class="o">&gt;</span> <span class="n">loader</span> <span class="o">=</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="nc">Compiler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="no">DEFAULT_COMPILER</span><span class="o">;</span> <span class="c1">// copy reference</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">compiler</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// ExtensionLoader åŠ è½½çš„é»˜è®¤å®ç°ä¸º @SPI ä¸Šæ³¨è§£çš„ï¼Œå³ Javassist</span>
            <span class="n">compiler</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">getDefaultExtension</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h2 id="42-javassist-åŠ¨æ€ä»£ç ç¼–è¯‘">4.2 Javassist åŠ¨æ€ä»£ç ç¼–è¯‘</h2>

<p>Java ä¸­åŠ¨æ€ç”Ÿæˆ Class çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¯ä»¥ç›´æ¥åŸºäºå­—èŠ‚ç æ–¹å¼ç”Ÿæˆï¼Œå¸¸è§çš„æœ‰ CGLIBã€ASMã€Javassist ç­‰ã€‚è‡ªé€‚åº”æ‰©å±•ç‚¹ä½¿ç”¨äº†ç”Ÿæˆå­—ç¬¦ä¸²ä»£ç å†ç¼–è¯‘æˆ Class çš„æ–¹å¼ã€‚</p>

<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åˆå§‹åŒ–ç±»æ± </span>
        <span class="nc">ClassPool</span> <span class="n">classPool</span> <span class="o">=</span> <span class="nc">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="c1">// åˆ›å»ºç±»</span>
        <span class="nc">CtClass</span> <span class="n">ctClass</span> <span class="o">=</span> <span class="n">classPool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="s">"Hello World"</span><span class="o">);</span>
        <span class="c1">// åˆ›å»ºæ–¹æ³•</span>
        <span class="nc">CtMethod</span> <span class="n">ctMethod</span> <span class="o">=</span> <span class="nc">CtNewMethod</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="s">"public static void test() {System.out.println(\"Hello World\");}"</span><span class="o">,</span> <span class="n">ctClass</span><span class="o">);</span>
        <span class="c1">// æ·»åŠ æ–¹æ³•</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">ctMethod</span><span class="o">);</span>
        <span class="c1">// ç”Ÿæˆç±»</span>
        <span class="nc">Class</span> <span class="n">aClass</span> <span class="o">=</span> <span class="n">ctClass</span><span class="o">.</span><span class="na">toClass</span><span class="o">();</span>
        <span class="c1">// åå°„è°ƒç”¨å®ä¾‹çš„ test æ–¹æ³•</span>
        <span class="nc">Object</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">aClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="nc">Method</span> <span class="n">m</span> <span class="o">=</span> <span class="n">aClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">m</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">instance</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</code></pre></div></div>

<p>Dubboï¼ŒJavassistCompiler é€šè¿‡ä¸æ–­æ­£åˆ™åŒ¹é…ä¸åŒéƒ¨ä½çš„ä»£ç ï¼Œæœ€ç»ˆç”Ÿæˆç±»ã€‚</p>

<h2 id="43-jdk-åŠ¨æ€ä»£ç ç¼–è¯‘">4.3 JDK åŠ¨æ€ä»£ç ç¼–è¯‘</h2>

<p>ä¸º Dubbo ç¼–è¯‘å™¨å¦ä¸€ç§å®ç°ï¼Œæ˜¯ JDK åŸç”Ÿç¼–è¯‘å™¨ï¼ŒåŒ…ä½äº javax.tools ä¸‹ã€‚</p>

<p>è¯¦ç•¥ã€‚</p>

<h1 id="å°ç»“">å°ç»“</h1>

<p>æœ¬ç« ä»‹ç»äº† Dubbo SPI ä¸ Java SPI åŒºåˆ«ï¼ŒDubbo SPI çš„ç‰¹æ€§ã€é…ç½®è§„èŒƒå’Œå†…éƒ¨ç¼“å­˜ç­‰ã€‚å…¶æ¬¡ä»‹ç»äº†æœ€é‡è¦çš„3ä¸ªæ³¨è§£ @SPIã€@Adaptiveã€@Activate çš„ä½œç”¨åŠåŸç†ã€‚ç„¶ååˆ†æäº† ExtensionLoader çš„æºç ï¼Œä»¥åŠ ExtensionFactory åŸç†ã€‚æœ€åè®²è§£äº†è‡ªé€‚åº”åŠ¨æ€ç¼–è¯‘çš„å®ç°åŸç†ã€‚</p>

:ET