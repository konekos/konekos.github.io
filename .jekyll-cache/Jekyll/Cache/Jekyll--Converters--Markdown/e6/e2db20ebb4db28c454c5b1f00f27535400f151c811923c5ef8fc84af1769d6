I"Fu<p>é¡¹ç›®ä½¿ç”¨ Tomcat8ï¼ŒæŸæœåŠ¡ç»å¸¸ä¼šé‡å¯åæ‰€æœ‰æ¥å£æŠ¥é”™ï¼ŒWARN æ—¥å¿—å¦‚ä¸‹ï¼šcom.caucho.hessian.io.SerializerFactory.getDeserializer Hessian/Burlap:â€™XxDTOâ€™ is an unknown class in null:java.lang.ClassNotFoundException: â€˜XxDTOâ€™ï¼ŒHttp æ¥å£ç»è¿‡ç»Ÿä¸€å¼‚å¸¸å¤„ç†åæ‰“å°çš„ message ä¸º java.lang.ClassCastException: java.util.HashMap cannot be cast to â€˜XxDTOâ€™ã€‚</p>

<h2 id="1-é—®é¢˜è§£å†³è¿‡ç¨‹">1. é—®é¢˜è§£å†³è¿‡ç¨‹</h2>

<p>æ‰¾åˆ° WARNING æ—¥å¿—ä½ç½®ï¼Œcom.caucho.hessian.io.SerializerFactoryï¼Œhessian ç‰ˆæœ¬ä¸º 4.0.38ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SerializerFactory</span> <span class="kd">extends</span> <span class="nc">AbstractSerializerFactory</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">Deserializer</span> <span class="nf">getDeserializer</span><span class="o">(</span><span class="nc">String</span> <span class="n">type</span><span class="o">){</span>
    	<span class="c1">//...</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Class</span> <span class="n">cl</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">_loader</span><span class="o">);</span>
        <span class="n">deserializer</span> <span class="o">=</span> <span class="n">getDeserializer</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warning</span><span class="o">(</span><span class="s">"Hessian/Burlap: '"</span> <span class="o">+</span> <span class="n">type</span> <span class="o">+</span> <span class="s">"' is an unknown class in "</span> <span class="o">+</span> <span class="n">_loader</span> <span class="o">+</span> <span class="s">":\n"</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
        <span class="n">_typeNotFoundDeserializerMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="no">PRESENT</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">FINER</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="n">_unrecognizedTypeCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AtomicLong</span><span class="o">(</span><span class="mi">1L</span><span class="o">));</span>
      <span class="o">}</span>
    	<span class="c1">//...</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>type æ˜¯ String ç±»å‹ï¼Œè¯¥ç±»çš„å…¨é™å®šåï¼Œé€šè¿‡ _loader åŠ è½½è¯¥ç±»ï¼Œç”±äºæŠ›å‡ºçš„å¼‚å¸¸ä¸º ClassNotFoundExceptionï¼Œåªä¼šæ˜¯å› ä¸º _loader ä¸ºç©ºå¯¼è‡´ã€‚</p>

<p>æ¥ä¸‹æ¥çœ‹ SerializerFactory ä¸­ç±»åŠ è½½å™¨ _loader çš„èµ‹å€¼ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯åœ¨å®ä¾‹åŒ–æ—¶ä¼ å…¥çš„ ContextClassLoaderã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SerializerFactory</span> <span class="kd">extends</span> <span class="nc">AbstractSerializerFactory</span> <span class="o">{</span>	
  	<span class="kd">public</span> <span class="nf">SerializerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">SerializerFactory</span><span class="o">(</span><span class="nc">ClassLoader</span> <span class="n">loader</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">_loader</span> <span class="o">=</span> <span class="n">loader</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ContextClassLoader å¯ä»¥æ‰‹åŠ¨ set èµ‹å€¼ï¼Œå¦‚æœä¸æ‰‹åŠ¨è°ƒç”¨ï¼Œå®ƒçš„å€¼ä¼šä»å“ªæ¥å‘¢ï¼Ÿ</p>

<p>å¯ä»¥ä» Thread åˆå§‹åŒ–ä»£ç å¾—çŸ¥ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Thread</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">ThreadGroup</span> <span class="n">g</span><span class="o">,</span> <span class="nc">Runnable</span> <span class="n">target</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span>
                          <span class="kt">long</span> <span class="n">stackSize</span><span class="o">,</span> <span class="nc">AccessControlContext</span> <span class="n">acc</span><span class="o">,</span>
                          <span class="kt">boolean</span> <span class="n">inheritThreadLocals</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//...</span>
            <span class="nc">Thread</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">currentThread</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">security</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">isCCLOverridden</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getClass</span><span class="o">()))</span>
                <span class="k">this</span><span class="o">.</span><span class="na">contextClassLoader</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">getContextClassLoader</span><span class="o">();</span>
            <span class="k">else</span>
                <span class="k">this</span><span class="o">.</span><span class="na">contextClassLoader</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">contextClassLoader</span><span class="o">;</span>
            <span class="c1">//...</span>
        <span class="o">}</span>
    <span class="o">}</span>

</code></pre></div></div>

<p>å¯ä»¥çœ‹å‡º ContextClassLoader æ˜¯ç»§æ‰¿çš„çˆ¶çº¿ç¨‹çš„ã€‚æ­£å¸¸æ¥è¯´ ContextClassLoader ä¸åº”è¯¥ä¸ºç©ºï¼Œæ¥ä¸‹æ¥å°±è¦é€šè¿‡ DEBUG æ¥æ‰¾åˆ°å®ä¾‹åŒ– SerializerFactory çš„çº¿ç¨‹ã€‚</p>

<p>è™½ç„¶é—®é¢˜ä¸æ˜¯ 100% é‡å¯å¤ç°ï¼Œä¸è¿‡è¿˜æ˜¯ DEBUG åˆ°å‡ºé—®é¢˜çš„æ—¶å€™å®ä¾‹åŒ–çº¿ç¨‹åä¸º ForkJoinPool.commonPool-worker-xxxï¼Œæ˜¯ ForkJoinPool ä¸­çš„ ForkJoinçº¿ç¨‹ã€‚</p>

<p>è¿™æ—¶å¦‚æœå¯¹ Java8 è¾ƒä¸ºç†Ÿæ‚‰ï¼Œå°±åº”è¯¥çŸ¥é“é»˜è®¤ä½¿ç”¨ ForkJoinPool çš„æœ‰ parallelStream ä»¥åŠ CompletableFutureï¼Œåˆ™å¯ä»¥ç»“åˆ SerializerFactory çš„å®ä¾‹åŒ–æ—¶æœºä¸æœç´¢è¿™ä¸¤ä¸ªç¬¦å·åœ¨ä¸šåŠ¡ä»£ç çš„ä½¿ç”¨ä»è€Œæ‰¾åˆ°å¯¼è‡´å‡ºç°é—®é¢˜çš„ä¸šåŠ¡ä»£ç çš„ä½ç½®ã€‚</p>

<p>ç”±äºé¡¹ç›®ä¸­çš„ redis ä½¿ç”¨ hessian åšäº†ä¸€å±‚åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„å°è£…ï¼Œæ‰€ä»¥è°ƒç”¨ RedisService çš„ get æ“ä½œæ—¶ï¼Œä¼šè¿›è¡Œ SerializerFactory çš„å®ä¾‹åŒ–ã€‚ä¸”ç”±äºè¯¥æœåŠ¡çš„æ‰€æœ‰æ¥å£è¦è¿‡ç™»å½•æ‹¦æˆªå™¨ï¼Œè¯¥æ‹¦æˆªå™¨ä¸­ä¼šæœ‰ reids get æ“ä½œï¼Œè€Œæ‰€æœ‰æ¥å£ä¸å¯ç”¨å°±æ˜¯å› ä¸ºåœ¨æ‹¦æˆªå™¨ä¸­æŠ›å‡ºäº†java.lang.ClassCastException: java.util.HashMap cannot be cast to â€˜XxDTOâ€™ çš„å¼‚å¸¸ã€‚å› æ­¤ SerializerFactory åœ¨ Spring å®¹å™¨å¯åŠ¨å®Œæ¯•ä¹‹å‰å°±å·²ç»å®ä¾‹åŒ–äº†ï¼Œé€šè¿‡æ’æŸ¥æœ€ç»ˆå‘ç°å¯¼è‡´é—®é¢˜çš„ä»£ç ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">SomeService</span> <span class="o">{</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">RedisService</span> <span class="n">redisService</span><span class="o">;</span>

  <span class="nd">@PostConstruct</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
    <span class="kt">boolean</span> <span class="n">b</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getB</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">b</span><span class="o">){</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getList</span><span class="o">();</span>
      <span class="n">list</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span><span class="o">-&gt;{</span>
        <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="c1">//...</span>
      <span class="o">});</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>é¡¹ç›®ä¸­ redis çš„ hessian å°è£…é‡Œï¼ŒSerializerFactory æ˜¯ä½œä¸ºå•ä¾‹ä½¿ç”¨çš„ã€‚å¯ä»¥çœ‹åˆ°é€šè¿‡ @PostConstruct æ³¨è§£ï¼Œåœ¨å¹¶è¡Œæµé‡Œè¿›è¡Œäº† redis set æ“ä½œï¼Œset æ“ä½œéœ€è¦è·å–åºåˆ—åŒ–å™¨ï¼Œå¯¼è‡´äº† SerializerFactory é¢„å…ˆå®ä¾‹åŒ–ä¸”è·å–çš„ ContextClassLoader ä¸ºç©ºã€‚ ä¹‹ååœ¨æ‹¦æˆªå™¨ä¸­ RedisService è°ƒç”¨get æ–¹æ³•ï¼Œé€šè¿‡ SerializerFactory è·å–ååºåˆ—åŒ–å™¨æ—¶ï¼Œç”±äº ClassLoader ä¸ºç©ºï¼Œåˆ™é»˜è®¤ä½¿ç”¨äº† Map ç±»å‹çš„ååºåˆ—åŒ–å™¨ï¼ˆæœ‰å…´è¶£å¯ä»¥çœ‹ä¸‹ hessian æºç ï¼‰ï¼Œè€Œ Redis ä¸­å­˜çš„ååºåˆ—åŒ–åçš„å¯¹è±¡å¹¶ä¸æ˜¯ Map ç±»å‹ï¼Œæ‰€ä»¥æŠ›å‡ºè½¬æ¢å¼‚å¸¸ã€‚è€Œä¸”æœ‰ if åˆ¤æ–­æ¡ä»¶ï¼Œå¯¼è‡´ä¸èƒ½æ¯æ¬¡é‡å¯éƒ½èƒ½å¤ç°ã€‚</p>

<p>æœ€ç»ˆå–æ¶ˆä½¿ç”¨å¹¶è¡Œæµï¼Œé—®é¢˜è§£å†³ã€‚</p>

<h2 id="2-é—®é¢˜æ€è€ƒ">2. é—®é¢˜æ€è€ƒ</h2>

<p>ä¸ºä»€ä¹ˆ ForkJoinPool ä¸­çš„çº¿ç¨‹è·å– ContextClassLoader ä¸ºç©ºï¼Ÿé¦–å…ˆçœ‹ä¸€ä¸‹ ForkJoinPool çš„æºç ã€‚</p>

<p>æ™®é€šçº¿ç¨‹æ± ï¼ˆThreadPoolExecutorï¼‰çš„çº¿ç¨‹éƒ½æ˜¯ç”± ThreadFactory åˆ›å»ºçš„ï¼ŒForkJoinPool ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸ºå…¶å†…éƒ¨ç±» DefaultForkJoinWorkerThreadFactoryã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DefaultForkJoinWorkerThreadFactory</span>
  <span class="kd">implements</span> <span class="nc">ForkJoinWorkerThreadFactory</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ForkJoinWorkerThread</span> <span class="nf">newThread</span><span class="o">(</span><span class="nc">ForkJoinPool</span> <span class="n">pool</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ForkJoinWorkerThread</span><span class="o">(</span><span class="n">pool</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>åˆ›å»ºçš„çº¿ç¨‹ä¸º ForkJoinWorkerThreadï¼Œè°ƒç”¨äº† Thread çš„æ„é€ å™¨ï¼Œæ‰§è¡Œäº† initï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ç»§æ‰¿çš„çˆ¶çº¿ç¨‹çš„ï¼ˆnew å‡ºè¿™ä¸ªç±»å®ä¾‹çš„çº¿ç¨‹ï¼‰çš„ç±»åŠ è½½å™¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForkJoinWorkerThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
		<span class="kd">protected</span> <span class="nf">ForkJoinWorkerThread</span><span class="o">(</span><span class="nc">ForkJoinPool</span> <span class="n">pool</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Use a placeholder until a useful name can be set in registerWorker</span>
        <span class="kd">super</span><span class="o">(</span><span class="s">"aForkJoinWorkerThread"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">workQueue</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">registerWorker</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
  
</code></pre></div></div>

<p>é‚£ä¸ºä»€ä¹ˆä¸ºç©ºå‘¢ï¼Ÿ</p>

<h2 id="3-é—®é¢˜æ ¹æº">3. é—®é¢˜æ ¹æº</h2>

<p>æœ€åè¿˜æ˜¯é€šè¿‡æœç´¢å¾—çŸ¥åŸæ¥æ˜¯ Tomcat æ›¿æ¢äº† ForkJoinPool çš„ DefaultForkJoinWorkerThreadFactory å¯¼è‡´ï¼Œç›®çš„æ˜¯ä¸ºäº†è§£å†³å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ForkJoinPool</span><span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ForkJoinPool</span> <span class="nf">makeCommonPool</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">parallelism</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="nc">ForkJoinWorkerThreadFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="nc">UncaughtExceptionHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>  <span class="c1">// ignore exceptions in accessing/parsing properties</span>
        <span class="nc">String</span> <span class="n">pp</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span>
            <span class="o">(</span><span class="s">"java.util.concurrent.ForkJoinPool.common.parallelism"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">fp</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span>
            <span class="o">(</span><span class="s">"java.util.concurrent.ForkJoinPool.common.threadFactory"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">hp</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span>
            <span class="o">(</span><span class="s">"java.util.concurrent.ForkJoinPool.common.exceptionHandler"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">parallelism</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">pp</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ForkJoinWorkerThreadFactory</span><span class="o">)</span><span class="nc">ClassLoader</span><span class="o">.</span>
                       <span class="nf">getSystemClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="n">fp</span><span class="o">).</span><span class="na">newInstance</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="o">((</span><span class="nc">UncaughtExceptionHandler</span><span class="o">)</span><span class="nc">ClassLoader</span><span class="o">.</span>
                       <span class="nf">getSystemClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="n">hp</span><span class="o">).</span><span class="na">newInstance</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">factory</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">defaultForkJoinWorkerThreadFactory</span><span class="o">;</span>
        <span class="k">else</span> <span class="c1">// use security-managed default</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InnocuousForkJoinWorkerThreadFactory</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">parallelism</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="c1">// default 1 less than #cores</span>
        <span class="o">(</span><span class="n">parallelism</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
        <span class="n">parallelism</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">parallelism</span> <span class="o">&gt;</span> <span class="no">MAX_CAP</span><span class="o">)</span>
        <span class="n">parallelism</span> <span class="o">=</span> <span class="no">MAX_CAP</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ForkJoinPool</span><span class="o">(</span><span class="n">parallelism</span><span class="o">,</span> <span class="n">factory</span><span class="o">,</span> <span class="n">handler</span><span class="o">,</span> <span class="no">LIFO_QUEUE</span><span class="o">,</span>
                            <span class="s">"ForkJoinPool.commonPool-worker-"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>Tomcat é€šè¿‡ä¿®æ”¹ç³»ç»Ÿå±æ€§ <code class="language-plaintext highlighter-rouge">java.util.concurrent.ForkJoinPool.common.threadFactory</code> æ›¿æ¢äº†çº¿ç¨‹å·¥å‚ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SafeForkJoinWorkerThreadFactory</span> <span class="kd">implements</span> <span class="nc">ForkJoinWorkerThreadFactory</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ForkJoinWorkerThread</span> <span class="nf">newThread</span><span class="o">(</span><span class="nc">ForkJoinPool</span> <span class="n">pool</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">SafeForkJoinWorkerThread</span><span class="o">(</span><span class="n">pool</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SafeForkJoinWorkerThread</span> <span class="kd">extends</span> <span class="nc">ForkJoinWorkerThread</span> <span class="o">{</span>

        <span class="kd">protected</span> <span class="nf">SafeForkJoinWorkerThread</span><span class="o">(</span><span class="nc">ForkJoinPool</span> <span class="n">pool</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">pool</span><span class="o">);</span>
            <span class="n">setContextClassLoader</span><span class="o">(</span><span class="nc">ForkJoinPool</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¯¥ç±»å°†åˆ›å»ºå‡ºçš„ SafeForkJoinWorkerThread çº¿ç¨‹çš„ ContextClassLoader è®¾ä¸º ForkJoinPool ç±»çš„ ClassLoaderï¼Œè€Œ ForkJoinPool æ˜¯ java.util.concurrent åŒ…é‡Œçš„ç±»ï¼Œåœ¨ rt.jar é‡Œï¼Œæ ¹æ®åŒäº²å§”æ‰˜æœºåˆ¶ï¼Œè¯¥ç±»ç”± BootStrapClassLoader åŠ è½½çš„ï¼Œè€Œæ­¤ç±»åŠ è½½å™¨æ˜¯çº¯ C++ å®ç°ï¼Œæ²¡æœ‰å…·ä½“çš„ Java Classï¼Œæ‰€ä»¥è·å–çš„ ClassLoader å®ä¾‹ ä¸º nullã€‚</p>

<h2 id="4-ç±»åŠ è½½ç›¸å…³">4. ç±»åŠ è½½ç›¸å…³</h2>

<p>åœ¨ Thread ä¸­ï¼ŒContextClassLoader æ˜¯å…¶æˆå‘˜å˜é‡ã€‚ForkJoin çº¿ç¨‹æ± ä¸­åˆ›å»ºçš„çº¿ç¨‹ï¼Œä¸æ™®é€šçº¿ç¨‹æ± ç±»ä¼¼ï¼Œä¹Ÿä¼šæœ‰æŒç»­å­˜åœ¨çš„æ ¸å¿ƒçº¿ç¨‹ä¸ä¼šé”€æ¯ã€‚è¿™æ ·ForkJoinPool ä¸­çš„çº¿ç¨‹å°±æŒæœ‰ä»çˆ¶çº¿ç¨‹ç»§æ‰¿çš„ ClassLoader çš„å¼ºå¼•ç”¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* The context ClassLoader for this thread */</span>
<span class="kd">private</span> <span class="nc">ClassLoader</span> <span class="n">contextClassLoader</span><span class="o">;</span>
</code></pre></div></div>

<p>è€Œ ForkJoinPool æœ¬èº«ç”± static å®ä¾‹åŒ–ï¼Œåœ¨æ•´ä¸ª JVM å­˜æ´»å‘¨æœŸä¸ä¼šè¢«é”€æ¯ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="kd">final</span> <span class="nc">ForkJoinPool</span> <span class="n">common</span><span class="o">;</span>
</code></pre></div></div>

<p>å…ˆå¤ä¹ ä¸€ä¸‹ç±»åŠ è½½ç›¸å…³çŸ¥è¯†ï¼š</p>

<p>ClassLoader å†…ä¼šå­˜æ”¾æ‰€åŠ è½½ç±»çš„å¼•ç”¨ï¼ŒClass ä¹Ÿä¼šå¼•ç”¨å…¶ ClassLoaderï¼Œé€šè¿‡è°ƒç”¨ getClassLoader() è·å–ã€‚Class ä¸ ClassLoader æ˜¯åŒå‘å…³è”å…³ç³»ã€‚</p>

<p>Java è‡ªå¸¦çš„ç±»åŠ è½½å™¨æœ‰ Bootstrapï¼ŒExtï¼Œä¸ App ClassLoader ä¸‰ç§ï¼Œè¿™3ä¸ª ClassLoader è¢« JVM å†…éƒ¨å¼ºå¼•ç”¨ï¼Œä¸ä¼šè¢«å›æ”¶ï¼Œå› æ­¤è¿™ä¸‰ç§ç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ Class åœ¨ JVM å­˜æ´»æ—¶ä¸ä¼šè¢«å›æ”¶ã€‚</p>

<p>è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»æ˜¯å¯ä»¥è¢«å¸è½½çš„ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œå½“ SampleObj çš„ç±»åŠ è½½å™¨ä¸ SampleObj æ‰€æœ‰çš„å®ä¾‹å¯¹è±¡ä¸å†è¢«å¼•ç”¨ï¼Œé‚£ä¹ˆå…¶ Class ä¹Ÿå°†ä¸åœ¨è¢« root å¼•ç”¨ï¼Œä»è€Œè§¦å‘å¸è½½ç±»çš„å¸è½½ã€‚</p>

<p>ï¼Œ<img src="/assets/img/classloader.png" alt="classloader" /></p>

<p>Tomcat çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸º ParallelWebappClassLoaderï¼Œå…¶ç”Ÿå‘½å‘¨æœŸç­‰åŒ Tomcat çš„ç”Ÿå‘½å‘¨æœŸã€‚å½“ ForkJoinPool ä¸­çš„çº¿ç¨‹æŒæœ‰å¯¹ ParallelWebappClassLoader çš„å¼•ç”¨æ—¶ï¼Œä¼šå¯¼è‡´ ParallelWebappClassLoader ä¸å…¶åŠ è½½çš„ç±»æ— æ³•è¢«å›æ”¶ã€‚</p>

<p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿ ParallelWebappClassLoader çš„ ClassLoader çš„å¸è½½å‘¢ï¼Œå¯èƒ½æ˜¯ Tomcat é‡Œçš„ webapp é‡å¯çš„æ—¶å€™ ï¼Ÿï¼Ÿï¼Ÿæš‚æ—¶å…ˆä¸è€ƒè™‘é‚£ä¹ˆå¤šï¼Œå¦‚æœä»¥åç¢°åˆ° Tomcat ä¸‹ metaspace åŒºç±»æº¢å‡ºçš„é—®é¢˜ï¼Œä¹Ÿè®¸å¯ä»¥æä¾›ä¸€ç§æ€è·¯ã€‚</p>

<h2 id="5-springboot-ä¸‹çš„æµ‹è¯•">5. SpringBoot ä¸‹çš„æµ‹è¯•</h2>

<p>ç»åœ¨ SpringBoot 2.3.2ï¼ˆtomcat-embed-core 9.0.37ï¼‰æµ‹è¯•ï¼Œä»£ç å¦‚ä¸‹ï¼Œåœ¨å¹¶è¡Œæµä¸‹è·å–çš„  ContextClassLoader å¹¶ä¸æ˜¯ nullï¼Œè€Œæ˜¯ TomcatEmbeddedWebappClassLoaderã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/test"</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">ExecutionException</span><span class="o">,</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLoader</span><span class="o">.</span><span class="na">getSystemClassLoader</span><span class="o">());</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}).</span><span class="na">get</span><span class="o">();</span>
        <span class="k">return</span> <span class="s">"ok"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Result:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Thread</span><span class="o">[</span><span class="nc">ForkJoinPool</span><span class="o">.</span><span class="na">commonPool</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">4</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span>
<span class="nc">TomcatEmbeddedWebappClassLoader</span>
  <span class="nl">context:</span> <span class="no">ROOT</span>
  <span class="nl">delegate:</span> <span class="kc">true</span>
<span class="o">----------&gt;</span> <span class="nc">Parent</span> <span class="nl">Classloader:</span>
<span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Launcher</span><span class="n">$AppClassLoader</span><span class="err">@</span><span class="mi">18</span><span class="n">b4aac2</span>

<span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Launcher</span><span class="n">$AppClassLoader</span><span class="err">@</span><span class="mi">18</span><span class="n">b4aac2</span>
</code></pre></div></div>

<p>ä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰å†ä½¿ç”¨ SafeForkJoinWorkerThreadFactoryï¼Œè€Œæ˜¯ç›´æ¥ä»çˆ¶çº¿ç¨‹ç»§æ‰¿çš„ã€‚</p>

<p>åˆç”¨æœ€æ—©çš„ SpringBoot 1.0.0 ç‰ˆæœ¬è¯•äº†ä¸‹ï¼Œå‘ç°è·å–çš„ ContextClassLoader ä¹Ÿæ˜¯ Tomcat 7 çš„ WebappClassLoaderã€‚</p>

<p>ä¸ºä»€ä¹ˆ SpringBoot ä¸‹æ²¡æœ‰å†ä½¿ç”¨ SafeForkJoinWorkerThreadFactory å‘¢ï¼Œä¸ªäººçŒœæµ‹å’Œ JVM çš„ç”Ÿå‘½å‘¨æœŸæœ‰å…³ã€‚ä»¥ Tomcat çš„æ–¹å¼å¯åŠ¨ web åº”ç”¨æ—¶ï¼Œä¼šæœ‰Tomcat æœ¬èº«ä¸åœæ­¢ï¼Œåªé‡å¯å…¶ä¸­çš„ web åº”ç”¨çš„æ“ä½œï¼Œè€Œ ForkJoinPool çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¾é™„äº JVM çš„ï¼Œè¿™æ ·ä¼šå¯¼è‡´ç±»æ— æ³•å¸è½½çš„é—®é¢˜ã€‚è€Œ SpringBoot çš„é‡å¯æ˜¯æ•´ä¸ª JVM çš„é‡å¯ï¼Œä¸ä¼šæœ‰ç±»ä¼¼é—®é¢˜ã€‚</p>

<p>âš ï¸ï¼šä»¥ä¸Šåªæ˜¯ä¸ªäººçŒœæƒ³å¯èƒ½ä¸å¯¹ğŸ¶ã€‚</p>

<h2 id="6-æ€»ç»“">6. æ€»ç»“</h2>

<p>æœ¬æ¬¡é‡åˆ°çš„é—®é¢˜è¿˜æ˜¯æœ‰ä¸å°‘æ”¶è·çš„ï¼Œç‰¹åˆ«æ˜¯é—®é¢˜ä¸èƒ½ 100% å¤ç°ï¼Œå¯¹ DEBUG é€ æˆä¸å°çš„éº»çƒ¦ï¼Œå‰æœŸåªèƒ½é çŒœã€‚æœ€ç»ˆç»ˆäº DEBUG åˆ°ä¸€æ¬¡çº¿ç¨‹åï¼Œçœ‹åˆ°æ˜¯ ForkJoin çº¿ç¨‹å°±è±ç„¶å¼€æœ—äº†ã€‚</p>

<p>éšåæ‰¾åˆ°é—®é¢˜å‘ç”Ÿçš„æ ¹æºï¼Œå¹¶å¯¹ç±»åŠ è½½æœºåˆ¶ ä»¥åŠ ContextClassLoader æœ‰äº†è¿›ä¸€å±‚çš„ç†è§£ã€‚æœ€ååœ¨ SpringBoot ä¸‹æµ‹è¯•ç›¸åŒçš„é—®é¢˜ï¼Œå¹¶ç»™å‡ºäº†çŒœæƒ³ã€‚</p>

<p>æœ€åè¿˜æ˜¯è¦å¤šå­¦ä¹ å•Šï¼ŒåŸºç¡€è¦ç‰¢ğŸ¶ã€‚</p>

:ET